69,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],$N=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"log",void 0),(0,ot.Z)(this,"peerRouting",void 0),(0,ot.Z)(this,"routingTable",void 0),(0,ot.Z)(this,"refreshInterval",void 0),(0,ot.Z)(this,"refreshQueryTimeout",void 0),(0,ot.Z)(this,"commonPrefixLengthRefreshedAt",void 0),(0,ot.Z)(this,"refreshTimeoutId",void 0);var n=t.peerRouting,r=t.routingTable,i=t.refreshInterval,o=t.refreshQueryTimeout,a=t.lan;this.log=(0,ru.kg)("libp2p:kad-dht:".concat(a?"lan":"wan",":routing-table:refresh")),this.peerRouting=n,this.routingTable=r,this.refreshInterval=null!==i&&void 0!==i?i:pP,this.refreshQueryTimeout=null!==o&&void 0!==o?o:dP,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}return(0,W.Z)(e,[{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.log("refreshing routing table every ".concat(this.refreshInterval,"ms")),this.refreshTable(!0);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null!=this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId);case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"refreshTable",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.log("refreshing routing table");var n=this._maxCommonPrefix(),r=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log("max common prefix length ".concat(n)),this.log("tracked CPLs [ ".concat(r.map((function(e){return e.toISOString()})).join(", ")," ]")),Promise.all(r.map(function(){var i=(0,u.Z)((0,s.Z)().mark((function i(o,a){var u,c;return(0,s.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,e._refreshCommonPrefixLength(a,o,t);case 3:if(0!==e._numPeersForCpl(n)){i.next=18;break}u=Math.min(2*(a+1),r.length-1),c=a+1;case 6:if(!(c<u+1)){i.next=18;break}return i.prev=7,i.next=10,e._refreshCommonPrefixLength(c,o,t);case 10:i.next=15;break;case 12:i.prev=12,i.t0=i.catch(7),e.log.error(i.t0);case 15:c++,i.next=6;break;case 18:i.next=23;break;case 20:i.prev=20,i.t1=i.catch(0),e.log.error(i.t1);case 23:case"end":return i.stop()}}),i,null,[[0,20],[7,12]])})));return function(e,t){return i.apply(this,arguments)}}())).catch((function(t){e.log.error(t)})).then((function(){e.refreshTimeoutId=setTimeout(e.refreshTable,e.refreshInterval),null!=e.refreshTimeoutId.unref&&e.refreshTimeoutId.unref()})).catch((function(t){e.log.error(t)}))}},{key:"_refreshCommonPrefixLength",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r||!(n.getTime()>Date.now()-this.refreshInterval)){e.next=3;break}return this.log("not running refresh for cpl %s as time since last refresh not above interval",t),e.abrupt("return");case 3:return e.next=5,this._generateRandomPeerId(t);case 5:return i=e.sent,this.log("starting refreshing cpl %s with key %p (routing table size was %s)",t,i,this.routingTable.size),e.next=9,NN(this.peerRouting.getClosestPeers(i.toBytes(),{signal:AbortSignal.timeout(this.refreshQueryTimeout)}));case 9:o=e.sent,this.log("found ".concat(o," peers that were close to imaginary peer %p"),i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",t,i,this.routingTable.size);case 12:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_getTrackedCommonPrefixLengthsForRefresh",value:function(e){e>15&&(e=15);for(var t=[],n=0;n<=e;n++){var r;t[n]=null!==(r=this.commonPrefixLengthRefreshedAt[n])&&void 0!==r?r:new Date}return t}},{key:"_generateRandomPeerId",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=this.routingTable.kb){e.next=2;break}throw new Error("Routing table not started");case 2:return n=ja(2),r=(n[1]<<8)+n[0],e.next=6,this._makePeerId(this.routingTable.kb.localNodeId,r,t);case 6:return i=e.sent,e.abrupt("return",(0,Ps.cv)(i));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_makePeerId",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r>15)){e.next=2;break}throw new Error("Cannot generate peer ID for common prefix length greater than ".concat(15));case 2:return i=new DataView(t.buffer,t.byteOffset,t.byteLength),o=i.getUint16(0,!1),u=XN[(o^32768>>r)&(a=65535<<16-(r+1))|n&~a],c=new ArrayBuffer(34),(l=new DataView(c,0,c.byteLength)).setUint8(0,h.sha256.code),l.setUint8(1,32),l.setUint32(2,u,!1),e.abrupt("return",new Uint8Array(l.buffer,l.byteOffset,l.byteLength));case 14:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_maxCommonPrefix",value:function(){var e,t=0,n=(0,Ae.Z)(this._prefixLengths());try{for(n.s();!(e=n.n()).done;){var r=e.value;r>t&&(t=r)}}catch(i){n.e(i)}finally{n.f()}return t}},{key:"_numPeersForCpl",value:function(e){var t,n=0,r=(0,Ae.Z)(this._prefixLengths());try{for(r.s();!(t=r.n()).done;){t.value===e&&n++}}catch(i){r.e(i)}finally{r.f()}return n}},{key:"_prefixLengths",value:(0,s.Z)().mark((function e(){var t,n,r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=this.routingTable.kb){e.next=2;break}return e.abrupt("return");case 2:t=(0,Ae.Z)(this.routingTable.kb.toIterable()),e.prev=3,t.s();case 5:if((n=t.n()).done){e.next=33;break}r=n.value.id,i=vN(this.routingTable.kb.localNodeId,r),o=0,a=(0,Ae.Z)(i),e.prev=10,a.s();case 12:if((u=a.n()).done){e.next=21;break}if(0!==u.value){e.next=18;break}o++,e.next=19;break;case 18:return e.abrupt("break",21);case 19:e.next=12;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(10),a.e(e.t0);case 26:return e.prev=26,a.f(),e.finish(26);case 29:return e.next=31,o;case 31:e.next=5;break;case 33:e.next=38;break;case 35:e.prev=35,e.t1=e.catch(3),t.e(e.t1);case 38:return e.prev=38,t.f(),e.finish(38);case 41:case"end":return e.stop()}}),e,this,[[3,35,38,41],[10,23,26,29]])}))}]),e}(),JN=(0,ru.kg)("libp2p:kad-dht:rpc:handlers:add-provider"),eB=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"providers",void 0);var n=t.providers;this.providers=n}return(0,W.Z)(e,[{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(JN("start"),null!=n.key&&0!==n.key.length){e.next=3;break}throw new ar.s("Missing key","ERR_MISSING_KEY");case 3:e.prev=3,r=c.CID.decode(n.key),e.next=10;break;case 7:throw e.prev=7,e.t0=e.catch(3),new ar.s("Invalid CID","ERR_INVALID_CID");case 10:return null!=n.providerPeers&&0!==n.providerPeers.length||JN.error("no providers found in message"),e.next=13,Promise.all(n.providerPeers.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.id.equals(t)){e.next=3;break}return JN("invalid provider peer %p from %p",n.id,t),e.abrupt("return");case 3:if(!(n.multiaddrs.length<1)){e.next=6;break}return JN("no valid addresses for provider %p. Ignore",t),e.abrupt("return");case 6:return JN("received provider %p for %s (addrs %s)",t,r,n.multiaddrs.map((function(e){return e.toString()}))),e.next=9,i.providers.addProvider(r,n.id);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 13:return e.abrupt("return",void 0);case 14:case"end":return e.stop()}}),e,null,[[3,7]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),tB=(0,ru.kg)("libp2p:kad-dht:rpc:handlers:find-node"),nB=function(){function e(t,n){(0,K.Z)(this,e),(0,ot.Z)(this,"peerRouting",void 0),(0,ot.Z)(this,"lan",void 0),(0,ot.Z)(this,"components",void 0);var r=n.peerRouting,i=n.lan;this.components=t,this.peerRouting=r,this.lan=Boolean(i)}return(0,W.Z)(e,[{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(tB("incoming request from %p for peers closer to %b",t,n.key),r=[],!IP(this.components.peerId.toBytes(),n.key)){e.next=6;break}r=[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map((function(e){return e.decapsulateCode(qP("p2p").code)})),protocols:[]}],e.next=9;break;case 6:return e.next=8,this.peerRouting.getCloserPeersOffline(n.key,t);case 8:r=e.sent;case 9:return r=r.map(this.lan?qL:WL).filter((function(e){return e.multiaddrs.length})),i=new DL(n.type,new Uint8Array(0),n.clusterLevel),r.length>0?i.closerPeers=r:tB("could not find any peers closer to %b than %p",n.key,t),e.abrupt("return",i);case 13:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),rB=(0,ru.kg)("libp2p:kad-dht:rpc:handlers:get-providers"),iB=function(){function e(t,n){(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"peerRouting",void 0),(0,ot.Z)(this,"providers",void 0),(0,ot.Z)(this,"lan",void 0);var r=n.peerRouting,i=n.providers,o=n.lan;this.components=t,this.peerRouting=r,this.providers=i,this.lan=Boolean(o)}return(0,W.Z)(e,[{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,r=c.CID.decode(n.key),e.next=7;break;case 4:throw e.prev=4,e.t0=e.catch(0),new ar.s("Invalid CID","ERR_INVALID_CID");case 7:return rB("%p asking for providers for %s",t,r),e.next=10,Promise.all([this.providers.getProviders(r),this.peerRouting.getCloserPeersOffline(n.key,t)]);case 10:return i=e.sent,o=(0,k.Z)(i,2),a=o[0],u=o[1],e.next=16,this._getPeers(a);case 16:return l=e.sent,e.next=19,this._getPeers(u.map((function(e){return e.id})));case 19:return f=e.sent,h=new DL(n.type,n.key,n.clusterLevel),l.length>0&&(h.providerPeers=l),f.length>0&&(h.closerPeers=f),rB("got %s providers %s closerPeers",l.length,f.length),e.abrupt("return",h);case 25:case"end":return e.stop()}}),e,this,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_getAddresses",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",[]);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getPeers",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],r=this.lan?qL:WL,i=(0,Ae.Z)(t),e.prev=3,i.s();case 5:if((o=i.n()).done){e.next=21;break}return a=o.value,e.prev=7,e.next=10,this.components.peerStore.get(a);case 10:u=e.sent,(c=r({id:a,multiaddrs:u.addresses.map((function(e){return e.multiaddr})),protocols:u.protocols})).multiaddrs.length>0&&n.push(c),e.next=19;break;case 15:if(e.prev=15,e.t0=e.catch(7),"ERR_NOT_FOUND"===e.t0.code){e.next=19;break}throw e.t0;case 19:e.next=5;break;case 21:e.next=26;break;case 23:e.prev=23,e.t1=e.catch(3),i.e(e.t1);case 26:return e.prev=26,i.f(),e.finish(26);case 29:return e.abrupt("return",n);case 30:case"end":return e.stop()}}),e,this,[[3,23,26,29],[7,15]])})));return function(t){return e.apply(this,arguments)}}()}]),e}(),oB=(0,ru.kg)("libp2p:kad-dht:rpc:handlers:get-value"),aB=function(){function e(t,n){(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"peerRouting",void 0);var r=n.peerRouting;this.components=t,this.peerRouting=r}return(0,W.Z)(e,[{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.key,oB("%p asked for key %b",t,r),null!=r&&0!==r.length){e.next=4;break}throw new ar.s("Invalid key","ERR_INVALID_KEY");case 4:if(i=new DL(TL.GET_VALUE,r,n.clusterLevel),!tN(r)){e.next=25;break}return oB("is public key"),o=nN(r),e.prev=8,e.next=11,this.components.peerStore.get(o);case 11:if(null!=(u=e.sent).id.publicKey){e.next=14;break}throw new ar.s("No public key found in key book","ERR_NOT_FOUND");case 14:a=u.id.publicKey,e.next=21;break;case 17:if(e.prev=17,e.t0=e.catch(8),"ERR_NOT_FOUND"===e.t0.code){e.next=21;break}throw e.t0;case 21:if(null==a){e.next=25;break}return oB("returning found public key"),i.record=new gP(r,a,new Date),e.abrupt("return",i);case 25:return e.next=27,Promise.all([this._checkLocalDatastore(r),this.peerRouting.getCloserPeersOffline(n.key,t)]);case 27:return c=e.sent,l=(0,k.Z)(c,2),f=l[0],h=l[1],null!=f&&(oB("had record for %b in local datastore",r),i.record=f),h.length>0&&(oB("had %s closer peers in routing table",h.length),i.closerPeers=h),e.abrupt("return",i);case 34:case"end":return e.stop()}}),e,this,[[8,17]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_checkLocalDatastore",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return oB("checkLocalDatastore looking for %b",t),n=JL(t),e.prev=2,e.next=5,this.components.datastore.get(n);case 5:r=e.sent,e.next=13;break;case 8:if(e.prev=8,e.t0=e.catch(2),"ERR_NOT_FOUND"!==e.t0.code){e.next=12;break}return e.abrupt("return",void 0);case 12:throw e.t0;case 13:if(null!=(i=gP.deserialize(r))){e.next=16;break}throw new ar.s("Invalid record","ERR_INVALID_RECORD");case 16:if(!(null==i.timeReceived||Date.now()-i.timeReceived.getTime()>1296e5)){e.next=20;break}return e.next=19,this.components.datastore.delete(n);case 19:return e.abrupt("return",void 0);case 20:return e.abrupt("return",i);case 21:case"end":return e.stop()}}),e,this,[[2,8]])})));return function(t){return e.apply(this,arguments)}}()}]),e}(),sB=(0,ru.kg)("libp2p:kad-dht:rpc:handlers:ping"),uB=function(){function e(){(0,K.Z)(this,e)}return(0,W.Z)(e,[{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return sB("ping from %p",t),e.abrupt("return",n);case 2:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),cB=function(){function e(t,n){(0,K.Z)(this,e),(0,ot.Z)(this,"log",void 0),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"validators",void 0);var r=n.validators;this.components=t,this.log=(0,ru.kg)("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=r}return(0,W.Z)(e,[{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.key,this.log("%p asked us to store value for key %b",t,r),null!=(i=n.record)){e.next=7;break}throw o="Empty record from: ".concat(t.toString()),this.log.error(o),new ar.s(o,"ERR_EMPTY_RECORD");case 7:return e.prev=7,e.next=10,rP(this.validators,i);case 10:return i.timeReceived=new Date,a=JL(i.key),e.next=14,this.components.datastore.put(a,i.serialize().subarray());case 14:this.log("put record for %b into datastore under key %k",r,a),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(7),this.log("did not put record for key %b into datastore %o",r,e.t0);case 20:return e.abrupt("return",n);case 21:case"end":return e.stop()}}),e,this,[[7,17]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),lB=function(){function e(t,n){var r;(0,K.Z)(this,e),(0,ot.Z)(this,"handlers",void 0),(0,ot.Z)(this,"routingTable",void 0),(0,ot.Z)(this,"log",void 0);var i=n.providers,o=n.peerRouting,a=n.validators,s=n.lan;this.log=(0,ru.kg)("libp2p:kad-dht:rpc"),this.routingTable=n.routingTable,this.handlers=(r={},(0,ot.Z)(r,TL.GET_VALUE,new aB(t,{peerRouting:o})),(0,ot.Z)(r,TL.PUT_VALUE,new cB(t,{validators:a})),(0,ot.Z)(r,TL.FIND_NODE,new nB(t,{peerRouting:o,lan:s})),(0,ot.Z)(r,TL.ADD_PROVIDER,new eB({providers:i})),(0,ot.Z)(r,TL.GET_PROVIDERS,new iB(t,{peerRouting:o,providers:i,lan:s})),(0,ot.Z)(r,TL.PING,new uB),r)}return(0,W.Z)(e,[{key:"handleMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.routingTable.add(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),this.log.error("Failed to update the kbucket store",e.t0);case 8:if(null!=(r=this.handlers[n.type])){e.next=12;break}return this.log.error("no handler found for message type: ".concat(n.type)),e.abrupt("return");case 12:return e.abrupt("return",r.handle(t,n));case 13:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"onIncomingStream",value:function(e){var t=this;Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function n(){var r,i,o,a;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=e.stream,i=e.connection,o=i.remotePeer,n.prev=2,n.next=5,t.routingTable.add(o);case 5:n.next=10;break;case 7:n.prev=7,n.t0=n.catch(2),t.log.error(n.t0);case 10:return a=t,n.next=13,_P(r,(function(e){return hN(e)}),function(){var e=(0,g.Z)((0,s.Z)().mark((function e(t){var n,r,i,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!1,r=!1,e.prev=2,u=(0,y.Z)(t);case 4:return e.next=6,(0,m.Z)(u.next());case 6:if(!(n=!(c=e.sent).done)){e.next=19;break}return l=c.value,f=DL.deserialize(l),a.log("incoming %s from %p",f.type,o),e.next=12,(0,m.Z)(a.handleMessage(o,f));case 12:if(null==(h=e.sent)){e.next=16;break}return e.next=16,h.serialize();case 16:n=!1,e.next=4;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(2),r=!0,i=e.t0;case 25:if(e.prev=25,e.prev=26,!n||null==u.return){e.next=30;break}return e.next=30,(0,m.Z)(u.return());case 30:if(e.prev=30,!r){e.next=33;break}throw i;case 33:return e.finish(30);case 34:return e.finish(25);case 35:case"end":return e.stop()}}),e,null,[[2,21,25,35],[26,,30,34]])})));return function(t){return e.apply(this,arguments)}}(),(function(e){return cN(e)}),r);case 13:case"end":return n.stop()}}),n,null,[[2,7]])})))).catch((function(e){t.log.error(e)}))}}]),e}(),fB=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;(0,K.Z)(this,n),i=t.call(this),(0,ot.Z)((0,nr.Z)(i),"log",void 0),(0,ot.Z)((0,nr.Z)(i),"components",void 0),(0,ot.Z)((0,nr.Z)(i),"protocol",void 0),(0,ot.Z)((0,nr.Z)(i),"running",void 0),(0,ot.Z)((0,nr.Z)(i),"registrarId",void 0);var o=r.protocol,a=r.lan;return i.components=e,i.log=(0,ru.kg)("libp2p:kad-dht:topology-listener:".concat(a?"lan":"wan")),i.running=!1,i.protocol=o,i}return(0,W.Z)(n,[{key:"isStarted",value:function(){return this.running}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.running){e.next=2;break}return e.abrupt("return");case 2:return this.running=!0,t=Bb({onConnect:function(e){n.log("observed peer %p with protocol %s",e,n.protocol),n.dispatchEvent(new Dh("peer",{detail:e}))}}),e.next=6,this.components.registrar.register(this.protocol,t);case 6:this.registrarId=e.sent;case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.running=!1,null!=this.registrarId&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),n}(Ch),hB=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;(0,K.Z)(this,n),i=t.call(this),(0,ot.Z)((0,nr.Z)(i),"protocol",void 0),(0,ot.Z)((0,nr.Z)(i),"routingTable",void 0),(0,ot.Z)((0,nr.Z)(i),"providers",void 0),(0,ot.Z)((0,nr.Z)(i),"network",void 0),(0,ot.Z)((0,nr.Z)(i),"peerRouting",void 0),(0,ot.Z)((0,nr.Z)(i),"components",void 0),(0,ot.Z)((0,nr.Z)(i),"log",void 0),(0,ot.Z)((0,nr.Z)(i),"running",void 0),(0,ot.Z)((0,nr.Z)(i),"kBucketSize",void 0),(0,ot.Z)((0,nr.Z)(i),"clientMode",void 0),(0,ot.Z)((0,nr.Z)(i),"lan",void 0),(0,ot.Z)((0,nr.Z)(i),"validators",void 0),(0,ot.Z)((0,nr.Z)(i),"selectors",void 0),(0,ot.Z)((0,nr.Z)(i),"queryManager",void 0),(0,ot.Z)((0,nr.Z)(i),"contentFetching",void 0),(0,ot.Z)((0,nr.Z)(i),"contentRouting",void 0),(0,ot.Z)((0,nr.Z)(i),"routingTableRefresh",void 0),(0,ot.Z)((0,nr.Z)(i),"rpc",void 0),(0,ot.Z)((0,nr.Z)(i),"topologyListener",void 0),(0,ot.Z)((0,nr.Z)(i),"querySelf",void 0),(0,ot.Z)((0,nr.Z)(i),"maxInboundStreams",void 0),(0,ot.Z)((0,nr.Z)(i),"maxOutboundStreams",void 0);var o=r.kBucketSize,a=r.clientMode,c=r.validators,l=r.selectors,f=r.querySelfInterval,h=r.lan,p=r.protocolPrefix,d=r.pingTimeout,v=r.pingConcurrency,y=r.maxInboundStreams,g=r.maxOutboundStreams,m=r.providers;i.running=!1,i.components=e,i.lan=Boolean(h),i.log=(0,ru.kg)("libp2p:kad-dht:".concat(!0===h?"lan":"wan")),i.protocol="".concat(null!==p&&void 0!==p?p:"/ipfs").concat(!0===h?"/lan":"").concat("/kad/1.0.0"),i.kBucketSize=null!==o&&void 0!==o?o:20,i.clientMode=null===a||void 0===a||a,i.maxInboundStreams=null!==y&&void 0!==y?y:32,i.maxOutboundStreams=null!==g&&void 0!==g?g:64,i.routingTable=new QN(e,{kBucketSize:o,lan:i.lan,pingTimeout:d,pingConcurrency:v,protocol:i.protocol}),i.providers=new kN(e,null!==m&&void 0!==m?m:{}),i.validators=(0,Nt.Z)((0,Nt.Z)({},sP),c),i.selectors=(0,Nt.Z)((0,Nt.Z)({},tP),l),i.network=new pN(e,{protocol:i.protocol,lan:i.lan});var b=Ut();return!0===r.allowQueryWithZeroPeers&&b.resolve(),i.queryManager=new LN(e,{disjointPaths:Math.ceil(i.kBucketSize/2),lan:h,initialQuerySelfHasRun:b,routingTable:i.routingTable}),i.peerRouting=new gN(e,{routingTable:i.routingTable,network:i.network,validators:i.validators,queryManager:i.queryManager,lan:i.lan}),i.contentFetching=new iN(e,{validators:i.validators,selectors:i.selectors,peerRouting:i.peerRouting,queryManager:i.queryManager,network:i.network,lan:i.lan}),i.contentRouting=new oN(e,{network:i.network,peerRouting:i.peerRouting,queryManager:i.queryManager,routingTable:i.routingTable,providers:i.providers,lan:i.lan}),i.routingTableRefresh=new $N({peerRouting:i.peerRouting,routingTable:i.routingTable,lan:i.lan}),i.rpc=new lB(e,{routingTable:i.routingTable,providers:i.providers,peerRouting:i.peerRouting,validators:i.validators,lan:i.lan}),i.topologyListener=new fB(e,{protocol:i.protocol,lan:i.lan}),i.querySelf=new GN(e,{peerRouting:i.peerRouting,interval:f,initialInterval:r.initialQuerySelfInterval,lan:i.lan,initialQuerySelfHasRun:b,routingTable:i.routingTable}),i.network.addEventListener("peer",(function(e){var t=e.detail;i.onPeerConnect(t).catch((function(e){i.log.error("could not add %p to routing table",t.id,e)})),i.dispatchEvent(new Dh("peer",{detail:t}))})),i.topologyListener.addEventListener("peer",(function(e){var t=e.detail;Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.components.peerStore.get(t);case 2:return n=e.sent,r={id:t,multiaddrs:n.addresses.map((function(e){return e.multiaddr})),protocols:n.protocols},e.next=6,i.onPeerConnect(r);case 6:case"end":return e.stop()}}),e)})))).catch((function(e){i.log.error("could not add %p to routing table",t,e)}))})),i}return(0,W.Z)(n,[{key:"onPeerConnect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("peer %p connected with protocols",t.id,t.protocols),0!==(t=this.lan?qL(t):WL(t)).multiaddrs.length){e.next=5;break}return this.log("ignoring %p as they do not have any %s addresses in %s",t.id,this.lan?"private":"public",t.multiaddrs.map((function(e){return e.toString()}))),e.abrupt("return");case 5:return e.prev=5,e.next=8,this.routingTable.add(t.id);case 8:e.next=13;break;case 10:e.prev=10,e.t0=e.catch(5),this.log.error("could not add %p to routing table",t.id,e.t0);case 13:case"end":return e.stop()}}),e,this,[[5,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"isStarted",value:function(){return this.running}},{key:"getMode",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.clientMode?"client":"server");case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"setMode",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.components.registrar.unhandle(this.protocol);case 2:if("client"!==t){e.next=7;break}this.log("enabling client mode"),this.clientMode=!0,e.next=11;break;case 7:return this.log("enabling server mode"),this.clientMode=!1,e.next=11,this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams});case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.running=!0,e.next=3,this.setMode(this.clientMode?"client":"server");case 3:return e.next=5,Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start()]);case 5:return this.querySelf.start(),e.next=8,this.routingTableRefresh.start();case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.running=!1,this.querySelf.stop(),e.next=4,Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop()]);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"put",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return(0,g.Z)((0,s.Z)().mark((function i(){return(0,s.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.delegateYield((0,at.Z)((0,y.Z)(n.contentFetching.put(e,t,r)),m.Z),"t0",1);case 1:case"end":return i.stop()}}),i)})))()}},{key:"get",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,at.Z)((0,y.Z)(t.contentFetching.get(e,n)),m.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"provide",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,at.Z)((0,y.Z)(t.contentRouting.provide(e,t.components.addressManager.getAddresses(),n)),m.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"findProviders",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,at.Z)((0,y.Z)(t.contentRouting.findProviders(e,n)),m.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"findPeer",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,at.Z)((0,y.Z)(t.peerRouting.findPeer(e,n)),m.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"getClosestPeers",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,at.Z)((0,y.Z)(t.peerRouting.getClosestPeers(e,n)),m.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"refreshRoutingTable",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.routingTableRefresh.refreshTable(!0);case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),n}(Ch),pB=(0,ru.kg)("libp2p:kad-dht"),dB=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"dht",void 0),this.dht=t}return(0,W.Z)(e,[{key:"provide",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:{},e.next=3,zR(this.dht.provide(t,n));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"findProviders",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(t.dht.findProviders(e,n));case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=13;break}if("PROVIDER"!==(l=c.value).name){r.next=10;break}return r.delegateYield((0,at.Z)((0,y.Z)(l.providers),m.Z),"t0",10);case 10:i=!1,r.next=4;break;case 13:r.next=19;break;case 15:r.prev=15,r.t1=r.catch(2),o=!0,a=r.t1;case 19:if(r.prev=19,r.prev=20,!i||null==u.return){r.next=24;break}return r.next=24,(0,m.Z)(u.return());case 24:if(r.prev=24,!o){r.next=27;break}throw a;case 27:return r.finish(24);case 28:return r.finish(19);case 29:case"end":return r.stop()}}),r,null,[[2,15,19,29],[20,,24,28]])})))()}},{key:"put",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zR(this.dht.put(t,n,r));case 2:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,i=!1,e.prev=2,a=(0,y.Z)(this.dht.get(t,n));case 4:return e.next=6,a.next();case 6:if(!(r=!(u=e.sent).done)){e.next=13;break}if("VALUE"!==(c=u.value).name){e.next=10;break}return e.abrupt("return",c.value);case 10:r=!1,e.next=4;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(2),i=!0,o=e.t0;case 19:if(e.prev=19,e.prev=20,!r||null==a.return){e.next=24;break}return e.next=24,a.return();case 24:if(e.prev=24,!i){e.next=27;break}throw o;case 27:return e.finish(24);case 28:return e.finish(19);case 29:throw new ar.s("Not found","ERR_NOT_FOUND");case 30:case"end":return e.stop()}}),e,this,[[2,15,19,29],[20,,24,28]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),vB=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"dht",void 0),this.dht=t}return(0,W.Z)(e,[{key:"findPeer",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=l.length>1&&void 0!==l[1]?l[1]:{},r=!1,i=!1,e.prev=3,a=(0,y.Z)(this.dht.findPeer(t,n));case 5:return e.next=7,a.next();case 7:if(!(r=!(u=e.sent).done)){e.next=14;break}if("FINAL_PEER"!==(c=u.value).name){e.next=11;break}return e.abrupt("return",c.peer);case 11:r=!1,e.next=5;break;case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(3),i=!0,o=e.t0;case 20:if(e.prev=20,e.prev=21,!r||null==a.return){e.next=25;break}return e.next=25,a.return();case 25:if(e.prev=25,!i){e.next=28;break}throw o;case 28:return e.finish(25);case 29:return e.finish(20);case 30:throw new ar.s("Not found","ERR_NOT_FOUND");case 31:case"end":return e.stop()}}),e,this,[[3,16,20,30],[21,,25,29]])})));return function(t){return e.apply(this,arguments)}}()},{key:"getClosestPeers",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(t.dht.getClosestPeers(e,n));case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=14;break}if("FINAL_PEER"!==(l=c.value).name){r.next=11;break}return r.next=11,l.peer;case 11:i=!1,r.next=4;break;case 14:r.next=20;break;case 16:r.prev=16,r.t0=r.catch(2),o=!0,a=r.t0;case 20:if(r.prev=20,r.prev=21,!i||null==u.return){r.next=25;break}return r.next=25,(0,m.Z)(u.return());case 25:if(r.prev=25,!o){r.next=28;break}throw a;case 28:return r.finish(25);case 29:return r.finish(20);case 30:case"end":return r.stop()}}),r,null,[[2,16,20,30],[21,,25,29]])})))()}}]),e}();qN=Symbol.toStringTag;var yB,gB,mB,bB=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,K.Z)(this,n),r=t.call(this),(0,ot.Z)((0,nr.Z)(r),"wan",void 0),(0,ot.Z)((0,nr.Z)(r),"lan",void 0),(0,ot.Z)((0,nr.Z)(r),"components",void 0),(0,ot.Z)((0,nr.Z)(r),"contentRouting",void 0),(0,ot.Z)((0,nr.Z)(r),"peerRouting",void 0),(0,ot.Z)((0,nr.Z)(r),qN,"@libp2p/dual-kad-dht"),r.components=e,r.wan=new hB(e,(0,Nt.Z)((0,Nt.Z)({protocolPrefix:"/ipfs"},i),{},{lan:!1})),r.lan=new hB(e,(0,Nt.Z)((0,Nt.Z)({protocolPrefix:"/ipfs"},i),{},{clientMode:!1,lan:!0})),r.contentRouting=new dB((0,nr.Z)(r)),r.peerRouting=new vB((0,nr.Z)(r)),r.wan.addEventListener("peer",(function(e){r.dispatchEvent(new Dh("peer",{detail:e.detail}))})),r.lan.addEventListener("peer",(function(e){r.dispatchEvent(new Dh("peer",{detail:e.detail}))})),null==i.clientMode&&e.events.addEventListener("self:peer:update",(function(e){pB("received update of self-peer info");var t=e.detail.peer.addresses.some((function(e){var t=e.multiaddr,n=function(e){var t,n=e.stringTuples(),r=(0,Ae.Z)(n);try{for(r.s();!(t=r.n()).done;)if(290===t.value[0])return!1}catch(a){r.e(a)}finally{r.f()}if(54===n[0][0]||55===n[0][0]||56===n[0][0])return pB("%m is public %s",e,!0),!0;if(4===n[0][0]||41===n[0][0]){var i=bA("".concat(n[0][1])),o=null==i||!i;return pB("%m is public %s",e,o),o}return!1}(t);return pB("%m is public %s",t,n),n}));r.getMode().then(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t||"client"!==n){e.next=5;break}return e.next=3,r.setMode("server");case 3:e.next=8;break;case 5:if("server"!==n||t){e.next=8;break}return e.next=8,r.setMode("client");case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){pB.error("error setting dht server mode",e)}))})),r}return(0,W.Z)(n,[{key:pk,get:function(){return this.contentRouting}},{key:vk,get:function(){return this.peerRouting}},{key:dk,get:function(){return this}},{key:"isStarted",value:function(){return this.wan.isStarted()&&this.lan.isStarted()}},{key:"getMode",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.wan.getMode());case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"setMode",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wan.setMode(t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this.lan.start(),this.wan.start()]);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this.lan.stop(),this.wan.stop()]);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"put",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return(0,g.Z)((0,s.Z)().mark((function i(){var o,a,u,c,l,f;return(0,s.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:o=!1,a=!1,i.prev=2,c=(0,y.Z)(WR(n.lan.put(e,t,r),n.wan.put(e,t,r)));case 4:return i.next=6,(0,m.Z)(c.next());case 6:if(!(o=!(l=i.sent).done)){i.next=13;break}return f=l.value,i.next=10,f;case 10:o=!1,i.next=4;break;case 13:i.next=19;break;case 15:i.prev=15,i.t0=i.catch(2),a=!0,u=i.t0;case 19:if(i.prev=19,i.prev=20,!o||null==c.return){i.next=24;break}return i.next=24,(0,m.Z)(c.return());case 24:if(i.prev=24,!a){i.next=27;break}throw u;case 27:return i.finish(24);case 28:return i.finish(19);case 29:case"end":return i.stop()}}),i,null,[[2,15,19,29],[20,,24,28]])})))()}},{key:"get",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,a=!1,u=!1,r.prev=4,l=(0,y.Z)(WR(t.lan.get(e,n),t.wan.get(e,n)));case 6:return r.next=8,(0,m.Z)(l.next());case 8:if(!(a=!(f=r.sent).done)){r.next=18;break}return h=f.value,r.next=12,h;case 12:"DIAL_PEER"===h.name&&(i=!0),"VALUE"===h.name&&(i=!0,null!=h.value&&(o=!0)),"SEND_QUERY"===h.name&&(i=!0);case 15:a=!1,r.next=6;break;case 18:r.next=24;break;case 20:r.prev=20,r.t0=r.catch(4),u=!0,c=r.t0;case 24:if(r.prev=24,r.prev=25,!a||null==l.return){r.next=29;break}return r.next=29,(0,m.Z)(l.return());case 29:if(r.prev=29,!u){r.next=32;break}throw c;case 32:return r.finish(29);case 33:return r.finish(24);case 34:if(i){r.next=36;break}throw new ar.s("No peers found in routing table!","ERR_NO_PEERS_IN_ROUTING_TABLE");case 36:if(o){r.next=39;break}return r.next=39,BL({from:t.components.peerId,error:new ar.s("Not found","ERR_NOT_FOUND")},n);case 39:case"end":return r.stop()}}),r,null,[[4,20,24,34],[25,,29,33]])})))()}},{key:"provide",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l,f,h,p,d;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return i=0,o=0,a=[],u=[t.lan],r.next=6,(0,m.Z)(t.wan.getMode());case 6:if(r.t0=r.sent,"server"!==r.t0){r.next=9;break}u.push(t.wan);case 9:c=!1,l=!1,r.prev=11,h=(0,y.Z)(WR.apply(void 0,(0,ye.Z)(u.map((function(t){return t.provide(e,n)})))));case 13:return r.next=15,(0,m.Z)(h.next());case 15:if(!(c=!(p=r.sent).done)){r.next=25;break}return d=p.value,r.next=19,d;case 19:"SEND_QUERY"===d.name&&i++,"QUERY_ERROR"===d.name&&a.push(d.error),"PEER_RESPONSE"===d.name&&"ADD_PROVIDER"===d.messageName&&(pB("sent provider record for %s to %p",e,d.from),o++);case 22:c=!1,r.next=13;break;case 25:r.next=31;break;case 27:r.prev=27,r.t1=r.catch(11),l=!0,f=r.t1;case 31:if(r.prev=31,r.prev=32,!c||null==h.return){r.next=36;break}return r.next=36,(0,m.Z)(h.return());case 36:if(r.prev=36,!l){r.next=39;break}throw f;case 39:return r.finish(36);case 40:return r.finish(31);case 41:if(0!==o){r.next=45;break}if(!(a.length>0)){r.next=44;break}throw new ar.s("Failed to provide to ".concat(a.length," of ").concat(i," peers"),"ERR_PROVIDES_FAILED",{errors:a});case 44:throw new ar.s("Failed to provide - no peers found","ERR_PROVIDES_FAILED");case 45:case"end":return r.stop()}}),r,null,[[11,27,31,41],[32,,36,40]])})))()}},{key:"findProviders",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,at.Z)((0,y.Z)(WR(t.lan.findProviders(e,n),t.wan.findProviders(e,n))),m.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"findPeer",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,a=!1,r.prev=3,c=(0,y.Z)(WR(t.lan.findPeer(e,n),t.wan.findPeer(e,n)));case 5:return r.next=7,(0,m.Z)(c.next());case 7:if(!(o=!(l=r.sent).done)){r.next=15;break}return f=l.value,r.next=11,f;case 11:"SEND_QUERY"!==f.name&&"FINAL_PEER"!==f.name||(i=!0);case 12:o=!1,r.next=5;break;case 15:r.next=21;break;case 17:r.prev=17,r.t0=r.catch(3),a=!0,u=r.t0;case 21:if(r.prev=21,r.prev=22,!o||null==c.return){r.next=26;break}return r.next=26,(0,m.Z)(c.return());case 26:if(r.prev=26,!a){r.next=29;break}throw u;case 29:return r.finish(26);case 30:return r.finish(21);case 31:if(i){r.next=33;break}throw new ar.s("Peer lookup failed","ERR_LOOKUP_FAILED");case 33:case"end":return r.stop()}}),r,null,[[3,17,21,31],[22,,26,30]])})))()}},{key:"getClosestPeers",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,at.Z)((0,y.Z)(WR(t.lan.getClosestPeers(e,n),t.wan.getClosestPeers(e,n))),m.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"refreshRoutingTable",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()]);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),n}(Ch);function wB(e){return function(t){return new bB(t,e)}}!function(e){e[e.SEND_QUERY=0]="SEND_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADD_PEER=6]="ADD_PEER",e[e.DIAL_PEER=7]="DIAL_PEER"}(yB||(yB={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(gB||(gB={})),function(e){var t,n;!function(e){e.EOL="EOL"}(e.ValidityType||(e.ValidityType={})),function(e){e[e.EOL=0]="EOL"}(t||(t={})),function(e){e.codec=function(){return co(t)}}(e.ValidityType||(e.ValidityType={})),e.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.value&&(n.uint32(10),n.bytes(t.value)),null!=t.signature&&(n.uint32(18),n.bytes(t.signature)),null!=t.validityType&&(n.uint32(24),e.ValidityType.codec().encode(t.validityType,n)),null!=t.validity&&(n.uint32(34),n.bytes(t.validity)),null!=t.sequence&&(n.uint32(40),n.uint64(t.sequence)),null!=t.ttl&&(n.uint32(48),n.uint64(t.ttl)),null!=t.pubKey&&(n.uint32(58),n.bytes(t.pubKey)),null!=t.signatureV2&&(n.uint32(66),n.bytes(t.signatureV2)),null!=t.data&&(n.uint32(74),n.bytes(t.data)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.value=t.bytes();break;case 2:r.signature=t.bytes();break;case 3:r.validityType=e.ValidityType.codec().decode(t);break;case 4:r.validity=t.bytes();break;case 5:r.sequence=t.uint64();break;case 6:r.ttl=t.uint64();break;case 7:r.pubKey=t.bytes();break;case 8:r.signatureV2=t.bytes();break;case 9:r.data=t.bytes();break;default:t.skipType(7&o)}}return r}))),n},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(mB||(mB={}));var kB="ERR_UNRECOGNIZED_VALIDITY",EB="ERR_SIGNATURE_VERIFICATION",xB="ERR_UNDEFINED_PARAMETER",_B=(0,ru.kg)("ipns:utils"),SB=Dm("/ipns/");function AB(e){var t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),n=String(e).trim().match(t);if(null==n)throw new Error("Invalid format");var r=parseInt(n[1],10),i=parseInt(n[2],10)-1,o=parseInt(n[3],10),a=parseInt(n[4],10),s=parseInt(n[5],10),u=parseInt(n[6],10),c=parseInt(n[7].slice(0,-6),10);return new Date(Date.UTC(r,i,o,a,s,u,c))}var ZB,TB=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=n&&null!=t){e.next=4;break}throw r=new Error("one or more of the provided parameters are not defined"),_B.error(r),Mt()(r,xB);case 4:if(null==n.pubKey){e.next=20;break}e.prev=5,i=Zs(n.pubKey),e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(5),_B.error(e.t0),e.t0;case 13:return e.next=15,(0,Ps.y5)(n.pubKey);case 15:if(e.sent.equals(t)){e.next=18;break}throw Mt()(new Error("Embedded public key did not match PeerID"),"ERR_INVALID_EMBEDDED_KEY");case 18:e.next=21;break;case 20:null!=t.publicKey&&(i=Zs(t.publicKey));case 21:if(null==i){e.next=23;break}return e.abrupt("return",i);case 23:throw Mt()(new Error("no public key is available"),xB);case 24:case"end":return e.stop()}}),e,null,[[5,9]])})));return function(t,n){return e.apply(this,arguments)}}(),CB=function(e){var t,n,r,i,o,a,s=mB.decode(e);return null!=s.sequence&&(s.sequence=BigInt(s.sequence)),null!=s.ttl&&(s.ttl=BigInt(s.ttl)),{value:null!==(t=s.value)&&void 0!==t?t:new Uint8Array(0),signature:null!==(n=s.signature)&&void 0!==n?n:new Uint8Array(0),validityType:null!==(r=s.validityType)&&void 0!==r?r:mB.ValidityType.EOL,validity:null!==(i=s.validity)&&void 0!==i?i:new Uint8Array(0),sequence:null!==(o=s.sequence)&&void 0!==o?o:0n,pubKey:s.pubKey,ttl:null!==(a=s.ttl)&&void 0!==a?a:void 0,signatureV2:s.signatureV2,data:s.data}},IB=function(e){return(0,Ps.cv)(e.slice(SB.length))},DB=function(e,t){var n=t.map((function(e,t){return{entry:mB.decode(e),index:t}}));return n.sort((function(e,t){var n,r,i,o;if(null!=e.entry.signatureV2&&null==t.entry.signatureV2)return-1;if(null==e.entry.signatureV2&&null!=t.entry.signatureV2)return 1;var a=null!==(n=e.entry.sequence)&&void 0!==n?n:0n,s=null!==(r=t.entry.sequence)&&void 0!==r?r:0n;if(a>s)return-1;if(a<s)return 1;var u=null!==(i=e.entry.validity)&&void 0!==i?i:new Uint8Array(0),c=null!==(o=t.entry.validity)&&void 0!==o?o:new Uint8Array(0),l=AB(Om(u)),f=AB(Om(c));return l.getTime()>f.getTime()?-1:l.getTime()<f.getTime()?1:0})),n[0].index},OB=(0,ru.kg)("ipns:validator"),RB=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.value,i=n.validityType,o=n.validity,null==n.signatureV2||null==n.data){e.next=7;break}u=n.signatureV2,s=n.data,a=aS([Dm("ipns-signature:"),s]),PB(n),e.next=8;break;case 7:throw Mt()(new Error("missing data or signatureV2"),EB);case 8:return e.prev=8,e.next=11,t.verify(a,u);case 11:c=e.sent,e.next=17;break;case 14:e.prev=14,e.t0=e.catch(8),c=!1;case 17:if(c){e.next=20;break}throw OB.error("record signature verification failed"),Mt()(new Error("record signature verification failed"),EB);case 20:if(null==o||i!==mB.ValidityType.EOL){e.next=34;break}e.prev=21,l=AB(Om(o)),e.next=29;break;case 25:throw e.prev=25,e.t1=e.catch(21),OB.error("unrecognized validity format (not an rfc3339 format)"),Mt()(new Error("unrecognized validity format (not an rfc3339 format)"),"ERR_UNRECOGNIZED_FORMAT");case 29:if(!(l.getTime()<Date.now())){e.next=32;break}throw OB.error("record has expired"),Mt()(new Error("record has expired"),"ERR_IPNS_EXPIRED_RECORD");case 32:e.next=37;break;case 34:if(null==i){e.next=37;break}throw OB.error("unrecognized validity type"),Mt()(new Error("unrecognized validity type"),kB);case 37:OB("ipns entry for %b is valid",r);case 38:case"end":return e.stop()}var s}),e,null,[[8,14],[21,25]])})));return function(t,n){return e.apply(this,arguments)}}(),PB=function(e){if(null==e.data)throw Mt()(new Error("Record data is missing"),"ERR_INVALID_RECORD_DATA");var t=function(e){var t=se.decode(e);if(0!==t.ValidityType)throw Mt()(new Error("Unknown validity type"),kB);return t.ValidityType=mB.ValidityType.EOL,Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t}(e.data);if(!lb(t.Value,e.value))throw Mt()(new Error('Field "value" did not match between protobuf and CBOR'),EB);if(!lb(t.Validity,e.validity))throw Mt()(new Error('Field "validity" did not match between protobuf and CBOR'),EB);if(t.ValidityType!==e.validityType)throw Mt()(new Error('Field "validityType" did not match between protobuf and CBOR'),EB);if(t.Sequence!==e.sequence)throw Mt()(new Error('Field "sequence" did not match between protobuf and CBOR'),EB);if(t.TTL!==e.ttl)throw Mt()(new Error('Field "ttl" did not match between protobuf and CBOR'),EB)},LB=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=IB(t),i=CB(n),e.next=4,TB(r,i);case 4:return o=e.sent,e.next=7,RB(o,i);case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}();!function(e){var t,n,r;!function(e){e.DIAL="DIAL",e.DIAL_RESPONSE="DIAL_RESPONSE"}(e.MessageType||(e.MessageType={})),function(e){e[e.DIAL=0]="DIAL",e[e.DIAL_RESPONSE=1]="DIAL_RESPONSE"}(t||(t={})),function(e){e.codec=function(){return co(t)}}(e.MessageType||(e.MessageType={})),function(e){e.OK="OK",e.E_DIAL_ERROR="E_DIAL_ERROR",e.E_DIAL_REFUSED="E_DIAL_REFUSED",e.E_BAD_REQUEST="E_BAD_REQUEST",e.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(e.ResponseStatus||(e.ResponseStatus={})),function(e){e[e.OK=0]="OK",e[e.E_DIAL_ERROR=100]="E_DIAL_ERROR",e[e.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",e[e.E_BAD_REQUEST=200]="E_BAD_REQUEST",e[e.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"}(n||(n={})),function(e){e.codec=function(){return co(n)}}(e.ResponseStatus||(e.ResponseStatus={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs){var r,i=(0,Ae.Z)(e.addrs);try{for(i.s();!(r=i.n()).done;){var o=r.value;t.uint32(18),t.bytes(o)}}catch(a){i.e(a)}finally{i.f()}}!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={addrs:[]},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.id=e.bytes();break;case 2:n.addrs.push(e.bytes());break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(e.PeerInfo||(e.PeerInfo={})),function(t){var n;t.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.peer&&(n.uint32(10),e.PeerInfo.codec().encode(t.peer,n)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();if(o>>>3===1)r.peer=e.PeerInfo.codec().decode(t,t.uint32());else t.skipType(7&o)}return r}))),n},t.encode=function(e){return so(e,t.codec())},t.decode=function(e){return ao(e,t.codec())}}(e.Dial||(e.Dial={})),function(t){var n;t.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.status&&(n.uint32(8),e.ResponseStatus.codec().encode(t.status,n)),null!=t.statusText&&(n.uint32(18),n.string(t.statusText)),null!=t.addr&&(n.uint32(26),n.bytes(t.addr)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.status=e.ResponseStatus.codec().decode(t);break;case 2:r.statusText=t.string();break;case 3:r.addr=t.bytes();break;default:t.skipType(7&o)}}return r}))),n},t.encode=function(e){return so(e,t.codec())},t.decode=function(e){return ao(e,t.codec())}}(e.DialResponse||(e.DialResponse={})),e.codec=function(){return null==r&&(r=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.MessageType.codec().encode(t.type,n)),null!=t.dial&&(n.uint32(18),e.Dial.codec().encode(t.dial,n)),null!=t.dialResponse&&(n.uint32(26),e.DialResponse.codec().encode(t.dialResponse,n)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.type=e.MessageType.codec().decode(t);break;case 2:r.dial=e.Dial.codec().decode(t,t.uint32());break;case 3:r.dialResponse=e.DialResponse.codec().decode(t,t.uint32());break;default:t.skipType(7&o)}}return r}))),r},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(ZB||(ZB={}));var NB=(0,ru.kg)("libp2p:autonat"),BB=function(){function e(t,n){var r,i,o,a,s,u;(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"startupDelay",void 0),(0,ot.Z)(this,"refreshInterval",void 0),(0,ot.Z)(this,"protocol",void 0),(0,ot.Z)(this,"timeout",void 0),(0,ot.Z)(this,"maxInboundStreams",void 0),(0,ot.Z)(this,"maxOutboundStreams",void 0),(0,ot.Z)(this,"verifyAddressTimeout",void 0),(0,ot.Z)(this,"started",void 0),this.components=t,this.started=!1,this.protocol="/".concat(null!==(r=n.protocolPrefix)&&void 0!==r?r:"libp2p","/").concat("autonat","/").concat("1.0.0"),this.timeout=null!==(i=n.timeout)&&void 0!==i?i:3e4,this.maxInboundStreams=null!==(o=n.maxInboundStreams)&&void 0!==o?o:1,this.maxOutboundStreams=null!==(a=n.maxOutboundStreams)&&void 0!==a?a:1,this.startupDelay=null!==(s=n.startupDelay)&&void 0!==s?s:5e3,this.refreshInterval=null!==(u=n.refreshInterval)&&void 0!==u?u:6e4,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.started){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.components.registrar.handle(this.protocol,(function(e){t.handleIncomingAutonatStream(e).catch((function(e){NB.error("error handling incoming autonat stream",e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams});case 4:this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0;case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.components.registrar.unhandle(this.protocol);case 2:clearTimeout(this.verifyAddressTimeout),this.started=!1;case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"handleIncomingAutonatStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=nb([AbortSignal.timeout(this.timeout)]);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,n)}catch(a){}return r=this.components.addressManager.getAddresses().map((function(e){return e.toOptions().host})),e.prev=3,i=yu(t.stream,n),o=this,e.next=8,Qm(i,(function(e){return Hb(e)}),function(){var e=(0,g.Z)((0,s.Z)().mark((function e(i){var a,u,c,l,f,h,p,d,v,g,b,w,k,E,x;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.Z)(SZ(i));case 2:if(null!=(a=e.sent)){e.next=8;break}return NB("no message received"),e.next=7,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}});case 7:return e.abrupt("return");case 8:e.prev=8,u=ZB.decode(a),e.next=18;break;case 12:return e.prev=12,e.t0=e.catch(8),NB.error("could not decode message",e.t0),e.next=17,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}});case 17:return e.abrupt("return");case 18:if(null!=(c=u.dial)){e.next=24;break}return NB.error("dial was missing from message"),e.next=23,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}});case 23:return e.abrupt("return");case 24:if(null!=(f=c.peer)&&null!=f.id){e.next=30;break}return NB.error("PeerId missing from message"),e.next=29,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}});case 29:return e.abrupt("return");case 30:e.prev=30,l=(0,Ps.cv)(f.id),e.next=40;break;case 34:return e.prev=34,e.t1=e.catch(30),NB.error("invalid PeerId",e.t1),e.next=39,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}});case 39:return e.abrupt("return");case 40:if(NB("incoming request from %p",l),t.connection.remotePeer.equals(l)){e.next=46;break}return NB("target peer %p did not equal sending peer %p",l,t.connection.remotePeer),e.next=45,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}});case 45:return e.abrupt("return");case 46:if(h=f.addrs.map((function(e){return WS(e)})).filter((function(e){var n=e.toOptions().host===t.connection.remoteAddr.toOptions().host;return NB.trace("request to dial %s was sent from %s is same host %s",e,t.connection.remoteAddr,n),n})).filter((function(e){var t,n=e.toOptions().host,r=!(null!==(t=bA(n))&&void 0!==t&&t);return NB.trace("host %s was public %s",n,r),r})).filter((function(e){var t=e.toOptions().host,n=!r.includes(t);return NB.trace("host %s was not our host %s",t,n),n})).filter((function(e){var t=Boolean(o.components.transportManager.transportForMultiaddr(e));return NB.trace("transport for %s is supported %s",e,t),t})).map((function(e){return null==e.getPeerId()&&(e=e.encapsulate("/p2p/".concat(l.toString()))),e})),0!==h.length){e.next=52;break}return NB("no valid multiaddrs for %p in message",l),e.next=51,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}});case 51:return e.abrupt("return");case 52:NB("dial multiaddrs %s for peer %p",h.map((function(e){return e.toString()})).join(", "),l),p="",d=h[0],v=!1,g=!1,e.prev=57,w=(0,y.Z)(h);case 59:return e.next=61,(0,m.Z)(w.next());case 61:if(!(v=!(k=e.sent).done)){e.next=90;break}return E=k.value,x=void 0,d=E,e.prev=65,e.next=68,(0,m.Z)(o.components.connectionManager.openConnection(E,{signal:n}));case 68:if((x=e.sent).remoteAddr.equals(E)){e.next=72;break}throw NB.error("tried to dial %s but dialed %s",E,x.remoteAddr),new Error("Unexpected remote address");case 72:return NB("Success %p",l),e.next=75,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.OK,addr:x.remoteAddr.decapsulateCode(vS("p2p").code).bytes}});case 75:return e.abrupt("return");case 78:e.prev=78,e.t2=e.catch(65),NB("could not dial %p",l,e.t2),p=e.t2.message;case 82:if(e.prev=82,null==x){e.next=86;break}return e.next=86,(0,m.Z)(x.close());case 86:return e.finish(82);case 87:v=!1,e.next=59;break;case 90:e.next=96;break;case 92:e.prev=92,e.t3=e.catch(57),g=!0,b=e.t3;case 96:if(e.prev=96,e.prev=97,!v||null==w.return){e.next=101;break}return e.next=101,(0,m.Z)(w.return());case 101:if(e.prev=101,!g){e.next=104;break}throw b;case 104:return e.finish(101);case 105:return e.finish(96);case 106:return e.next=108,ZB.encode({type:ZB.MessageType.DIAL_RESPONSE,dialResponse:{status:ZB.ResponseStatus.E_DIAL_ERROR,statusText:p,addr:d.bytes}});case 108:case"end":return e.stop()}}),e,null,[[8,12],[30,34],[57,92,96,106],[65,78,82,87],[97,,101,105]])})));return function(t){return e.apply(this,arguments)}}(),(function(e){return jb(e)}),t.stream);case 8:e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),NB.error("error handling incoming autonat stream",e.t0);case 13:return e.prev=13,n.clear(),e.finish(13);case 16:case"end":return e.stop()}}),e,this,[[3,10,13,16]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_verifyExternalAddresses",value:function(){this.verifyExternalAddresses().catch((function(e){NB.error("error verifying external address",e)}))}},{key:"verifyExternalAddresses",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,c,l,f,h,p,d,v,g,m,b,w,k=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(clearTimeout(this.verifyAddressTimeout),this.isStarted()){e.next=3;break}return e.abrupt("return");case 3:if(t=this.components.addressManager,0!==(n=t.getObservedAddrs().filter((function(e){var t,n=e.toOptions();return!(null!==(t=bA(n.host))&&void 0!==t&&t)}))).length){e.next=9;break}return NB("no public addresses found, not requesting verification"),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval),e.abrupt("return");case 9:r=AbortSignal.timeout(this.timeout);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,r)}catch(E){}return i=this,e.prev=12,NB("verify multiaddrs %s",n.map((function(e){return e.toString()})).join(", ")),o=ZB.encode({type:ZB.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:n.map((function(e){return e.bytes}))}}}),e.next=17,rE();case 17:a=e.sent,c=a.toBytes(),l={},f=[],h=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,a,c,l,h,p,d,v,y;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,NB("asking %p to verify multiaddr",t.id),e.next=4,i.components.connectionManager.openConnection(t.id,{signal:r});case 4:return n=e.sent,e.next=7,n.newStream(k.protocol,{signal:r});case 7:return a=e.sent,c=yu(a,r),e.next=11,Qm([o],(function(e){return jb(e)}),c,(function(e){return Hb(e)}),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",SZ(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:if(null!=(l=e.sent)){e.next=15;break}return NB("no response received from %p",n.remotePeer),e.abrupt("return",void 0);case 15:if((h=ZB.decode(l)).type===ZB.MessageType.DIAL_RESPONSE&&null!=h.dialResponse){e.next=19;break}return NB("invalid autonat response from %p",n.remotePeer),e.abrupt("return",void 0);case 19:if(h.dialResponse.status!==ZB.ResponseStatus.OK){e.next=37;break}if(4!==(p=n.remoteAddr.toOptions()).family){e.next=26;break}v=p.host.split("."),d=v[0],e.next=33;break;case 26:if(6!==p.family){e.next=31;break}y=p.host.split(":"),d=y[0],e.next=33;break;case 31:return NB('remote address "%s" was not IP4 or IP6?',p.host),e.abrupt("return",void 0);case 33:if(!f.includes(d)){e.next=36;break}return NB("already have response from network segment %d - %s",d,p.host),e.abrupt("return",void 0);case 36:f.push(d);case 37:return e.abrupt("return",h.dialResponse);case 40:e.prev=40,e.t0=e.catch(0),NB.error("error asking remote to verify multiaddr",e.t0);case 43:case"end":return e.stop()}}),e,null,[[0,40]])})));return function(t){return e.apply(this,arguments)}}(),p=!1,d=!1,e.prev=24,g=(0,s.Z)().mark((function e(){var r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=b.value,e.prev=1,null!=r){e.next=4;break}return e.abrupt("return","continue");case 4:if(i=null==r.addr?n[0]:WS(r.addr),NB("autonat response for %s is %s",i,r.status),r.status!==ZB.ResponseStatus.E_BAD_REQUEST){e.next=8;break}return e.abrupt("return","continue");case 8:if(r.status!==ZB.ResponseStatus.E_DIAL_REFUSED){e.next=10;break}return e.abrupt("return","continue");case 10:if(!(null==r.addr&&n.length>1)){e.next=12;break}return e.abrupt("return","continue");case 12:if(n.some((function(e){return e.equals(i)}))){e.next=15;break}return NB("peer reported %s as %s but it was not in our observed address list",i,r.status),e.abrupt("return","continue");case 15:if(o=i.toString(),null==l[o]&&(l[o]={success:0,failure:0}),r.status===ZB.ResponseStatus.OK?l[o].success++:r.status===ZB.ResponseStatus.E_DIAL_ERROR&&l[o].failure++,4!==l[o].success){e.next=22;break}return NB("%s is externally dialable",i),t.confirmObservedAddr(i),e.abrupt("return",{v:void 0});case 22:if(4!==l[o].failure){e.next=26;break}return NB("%s is not externally dialable",i),t.removeObservedAddr(i),e.abrupt("return",{v:void 0});case 26:e.next=31;break;case 28:e.prev=28,e.t0=e.catch(1),NB.error("could not verify external address",e.t0);case 31:case"end":return e.stop()}}),e,null,[[1,28]])})),m=(0,y.Z)(EP(Vm(this.components.peerRouting.getClosestPeers(c,{signal:r}),(function(e){return(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",h(e));case 1:case"end":return t.stop()}}),t)})))})),{concurrency:4}));case 27:return e.next=29,m.next();case 29:if(!(p=!(b=e.sent).done)){e.next=39;break}return e.delegateYield(g(),"t0",31);case 31:if("continue"!==(w=e.t0)){e.next=34;break}return e.abrupt("continue",36);case 34:if("object"!==typeof w){e.next=36;break}return e.abrupt("return",w.v);case 36:p=!1,e.next=27;break;case 39:e.next=45;break;case 41:e.prev=41,e.t1=e.catch(24),d=!0,v=e.t1;case 45:if(e.prev=45,e.prev=46,!p||null==m.return){e.next=50;break}return e.next=50,m.return();case 50:if(e.prev=50,!d){e.next=53;break}throw v;case 53:return e.finish(50);case 54:return e.finish(45);case 55:return e.prev=55,this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval),e.finish(55);case 58:case"end":return e.stop()}}),e,this,[[12,,55,58],[24,41,45,55],[46,,50,54]])})));return function(){return e.apply(this,arguments)}}()}]),e}();function MB(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t){return new BB(t,e)}}BigInt(1<<17);var FB,jB,UB,zB,HB,VB,GB,KB,WB="/libp2p/circuit/relay/0.2.0/hop",qB="/libp2p/circuit/relay/0.2.0/stop";!function(e){var t,n;!function(e){e.RESERVE="RESERVE",e.CONNECT="CONNECT",e.STATUS="STATUS"}(e.Type||(e.Type={})),function(e){e[e.RESERVE=0]="RESERVE",e[e.CONNECT=1]="CONNECT",e[e.STATUS=2]="STATUS"}(t||(t={})),function(e){e.codec=function(){return co(t)}}(e.Type||(e.Type={})),e.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),UB.codec().encode(t.peer,n)),null!=t.reservation&&(n.uint32(26),zB.codec().encode(t.reservation,n)),null!=t.limit&&(n.uint32(34),HB.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(40),VB.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.peer=UB.codec().decode(t,t.uint32());break;case 3:r.reservation=zB.codec().decode(t,t.uint32());break;case 4:r.limit=HB.codec().decode(t,t.uint32());break;case 5:r.status=VB.codec().decode(t);break;default:t.skipType(7&o)}}return r}))),n},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(FB||(FB={})),function(e){var t,n;!function(e){e.CONNECT="CONNECT",e.STATUS="STATUS"}(e.Type||(e.Type={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.STATUS=1]="STATUS"}(t||(t={})),function(e){e.codec=function(){return co(t)}}(e.Type||(e.Type={})),e.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),UB.codec().encode(t.peer,n)),null!=t.limit&&(n.uint32(26),HB.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(32),VB.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.peer=UB.codec().decode(t,t.uint32());break;case 3:r.limit=HB.codec().decode(t,t.uint32());break;case 4:r.status=VB.codec().decode(t);break;default:t.skipType(7&o)}}return r}))),n},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(jB||(jB={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs){var r,i=(0,Ae.Z)(e.addrs);try{for(i.s();!(r=i.n()).done;){var o=r.value;t.uint32(18),t.bytes(o)}}catch(a){i.e(a)}finally{i.f()}}!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={id:new Uint8Array(0),addrs:[]},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.id=e.bytes();break;case 2:n.addrs.push(e.bytes());break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(UB||(UB={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.expire&&0n!==e.expire&&(t.uint32(8),t.uint64(e.expire)),null!=e.addrs){var r,i=(0,Ae.Z)(e.addrs);try{for(i.s();!(r=i.n()).done;){var o=r.value;t.uint32(18),t.bytes(o)}}catch(a){i.e(a)}finally{i.f()}}null!=e.voucher&&(t.uint32(26),t.bytes(e.voucher)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={expire:0n,addrs:[]},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.expire=e.uint64();break;case 2:n.addrs.push(e.bytes());break;case 3:n.voucher=e.bytes();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(zB||(zB={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.duration&&(t.uint32(8),t.uint32(e.duration)),null!=e.data&&(t.uint32(16),t.uint64(e.data)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.duration=e.uint32();break;case 2:n.data=e.uint64();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(HB||(HB={})),function(e){e.UNUSED="UNUSED",e.OK="OK",e.RESERVATION_REFUSED="RESERVATION_REFUSED",e.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONNECTION_FAILED="CONNECTION_FAILED",e.NO_RESERVATION="NO_RESERVATION",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE",e.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"}(VB||(VB={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.OK=100]="OK",e[e.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",e[e.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",e[e.PERMISSION_DENIED=202]="PERMISSION_DENIED",e[e.CONNECTION_FAILED=203]="CONNECTION_FAILED",e[e.NO_RESERVATION=204]="NO_RESERVATION",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",e[e.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"}(GB||(GB={})),function(e){e.codec=function(){return co(GB)}}(VB||(VB={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.relay&&e.relay.byteLength>0&&(t.uint32(10),t.bytes(e.relay)),null!=e.peer&&e.peer.byteLength>0&&(t.uint32(18),t.bytes(e.peer)),null!=e.expiration&&0n!==e.expiration&&(t.uint32(24),t.uint64(e.expiration)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={relay:new Uint8Array(0),peer:new Uint8Array(0),expiration:0n},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.relay=e.bytes();break;case 2:n.peer=e.bytes();break;case 3:n.expiration=e.uint64();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(KB||(KB={}));(0,ru.kg)("libp2p:circuit-relay:utils");function YB(e){return QB.apply(this,arguments)}function QB(){return QB=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(new TextEncoder).encode(t),e.next=3,h.sha256.digest(n);case 3:return r=e.sent,e.abrupt("return",c.CID.createV0(r));case 5:case"end":return e.stop()}}),e)}))),QB.apply(this,arguments)}function XB(e){var t=e*BigInt(1e3),n=(new Date).getTime();return Number(t-BigInt(n))}n(99158),new Set(["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed"]);(0,ru.kg)("libp2p:circuit-relay:advert-service"),(0,ru.kg)("libp2p:circuit-relay:server");var $B=(0,ru.kg)("libp2p:stream:converter");function JB(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.stream,r=e.remoteAddr,i=n.sink,o=n.source,a=(0,g.Z)((0,s.Z)().mark((function e(){var t,n,r,i,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!1,n=!1,e.prev=2,i=(0,y.Z)(o);case 4:return e.next=6,(0,m.Z)(i.next());case 6:if(!(t=!(a=e.sent).done)){e.next=17;break}if(!((u=a.value)instanceof Uint8Array)){e.next=13;break}return e.next=11,u;case 11:e.next=14;break;case 13:return e.delegateYield((0,at.Z)((0,y.Z)(u),m.Z),"t0",14);case 14:t=!1,e.next=4;break;case 17:e.next=23;break;case 19:e.prev=19,e.t1=e.catch(2),n=!0,r=e.t1;case 23:if(e.prev=23,e.prev=24,!t||null==i.return){e.next=28;break}return e.next=28,(0,m.Z)(i.return());case 28:if(e.prev=28,!n){e.next=31;break}throw r;case 31:return e.finish(28);case 32:return e.finish(23);case 33:case"end":return e.stop()}}),e,null,[[2,19,23,33],[24,,28,32]])})))(),c={sink:function(e){return(0,u.Z)((0,s.Z)().mark((function n(){return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return null!=t.signal&&(e=du(e,t.signal)),n.prev=1,n.next=4,i(e);case 4:return n.next=6,l();case 6:n.next=11;break;case 8:n.prev=8,n.t0=n.catch(1),"aborted"!==n.t0.type&&$B(n.t0);case 11:case"end":return n.stop()}}),n,null,[[1,8]])})))()},source:null!=t.signal?du(a,t.signal):a,remoteAddr:r,timeline:{open:Date.now(),close:void 0},close:function(){return(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i((0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Uint8Array(0);case 2:case"end":return e.stop()}}),e)})))());case 2:return e.next=4,l();case 4:case"end":return e.stop()}}),e)})))()}};function l(){return f.apply(this,arguments)}function f(){return(f=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null==c.timeline.close&&(c.timeline.close=Date.now()),e.next=3,Promise.resolve();case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}return c}var eM=(0,ru.kg)("libp2p:circuit-relay:discover-relays"),tM=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),r=t.call(this),(0,ot.Z)((0,nr.Z)(r),"peerId",void 0),(0,ot.Z)((0,nr.Z)(r),"peerStore",void 0),(0,ot.Z)((0,nr.Z)(r),"contentRouting",void 0),(0,ot.Z)((0,nr.Z)(r),"registrar",void 0),(0,ot.Z)((0,nr.Z)(r),"started",void 0),(0,ot.Z)((0,nr.Z)(r),"topologyId",void 0),r.started=!1,r.peerId=e.peerId,r.peerStore=e.peerStore,r.contentRouting=e.contentRouting,r.registrar=e.registrar,r}return(0,W.Z)(n,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.registrar.register(WB,Bb({onConnect:function(e){t.safeDispatchEvent("relay:discover",{detail:e})}}));case 2:this.topologyId=e.sent,this.discover().catch((function(e){eM.error("error listening on relays",e)})),this.started=!0;case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.started=!1}},{key:"discover",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,c,l,f,h,p,d;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return eM("searching peer store for relays"),e.next=3,this.peerStore.all();case 3:t=e.sent.filter((function(e){return e.protocols.includes(WB)})).sort((function(){return Math.random()-.5})),n=(0,Ae.Z)(t);try{for(n.s();!(r=n.n()).done;)i=r.value,eM("found relay peer %p in content peer store",i.id),this.safeDispatchEvent("relay:discover",{detail:i.id})}catch(s){n.e(s)}finally{n.f()}return eM("found %d relay peers in peer store",t.length),e.prev=7,eM("searching content routing for relays"),e.next=11,YB("/libp2p/relay");case 11:o=e.sent,a=0,u=!1,c=!1,e.prev=15,f=(0,y.Z)(this.contentRouting.findProviders(o));case 17:return e.next=19,f.next();case 19:if(!(u=!(h=e.sent).done)){e.next=31;break}if(!((p=h.value).multiaddrs.length>0)||p.id.equals(this.peerId)){e.next=28;break}return d=p.id,a++,e.next=26,this.peerStore.merge(d,{multiaddrs:p.multiaddrs});case 26:eM("found relay peer %p in content routing",d),this.safeDispatchEvent("relay:discover",{detail:d});case 28:u=!1,e.next=17;break;case 31:e.next=37;break;case 33:e.prev=33,e.t0=e.catch(15),c=!0,l=e.t0;case 37:if(e.prev=37,e.prev=38,!u||null==f.return){e.next=42;break}return e.next=42,f.return();case 42:if(e.prev=42,!c){e.next=45;break}throw l;case 45:return e.finish(42);case 46:return e.finish(37);case 47:eM("found %d relay peers in content routing",a),e.next=53;break;case 50:e.prev=50,e.t1=e.catch(7),eM.error("failed when finding relays on the network",e.t1);case 53:case"end":return e.stop()}}),e,this,[[7,50],[15,33,37,47],[38,,42,46]])})));return function(){return e.apply(this,arguments)}}()}]),n}(Ch),nM=(0,ru.kg)("libp2p:circuit-relay:transport:listener"),rM=new WeakSet,iM=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),r=t.call(this),pw((0,nr.Z)(r),rM),(0,ot.Z)((0,nr.Z)(r),"connectionManager",void 0),(0,ot.Z)((0,nr.Z)(r),"relayStore",void 0),(0,ot.Z)((0,nr.Z)(r),"listeningAddrs",void 0),r.connectionManager=e.connectionManager,r.relayStore=e.relayStore,r.listeningAddrs=new Qk,r.relayStore.addEventListener("relay:removed",(function(e){dw((0,nr.Z)(r),rM,oM).call((0,nr.Z)(r),e.detail)})),r}return(0,W.Z)(n,[{key:"listen",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(nM("listen on %s",t),null!=(n=t.getPeerId())&&(o=(0,Ps.jE)(n),(a=null!==(i=this.connectionManager.getConnectionsMap().get(o))&&void 0!==i?i:[]).length>0&&(r=a[0])),null!=r){e.next=9;break}return u=t.toString().split("/p2p-circuit").find((function(e){return""!==e})),c=WS(u),e.next=8,this.connectionManager.openConnection(c);case 8:r=e.sent;case 9:if(this.relayStore.hasReservation(r.remotePeer)){e.next=13;break}return e.next=12,this.relayStore.addRelay(r.remotePeer,"configured");case 12:return e.abrupt("return");case 13:if(null!=(l=this.relayStore.getReservation(r.remotePeer))){e.next=16;break}throw new ar.s("Did not have reservation after making reservation","ERR_NO_RESERVATION");case 16:if(!this.listeningAddrs.has(r.remotePeer)){e.next=19;break}return nM("already listening on relay %p",r.remotePeer),e.abrupt("return");case 19:this.listeningAddrs.set(r.remotePeer,l.addrs.map((function(e){return WS(e).encapsulate("/p2p-circuit")}))),this.safeDispatchEvent("listening",{});case 21:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getAddrs",value:function(){return(0,ye.Z)(this.listeningAddrs.values()).flat()}},{key:"close",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}]),n}(Ch);function oM(e){var t=this.listeningAddrs.has(e);this.listeningAddrs.delete(e),t&&this.safeDispatchEvent("close",{})}var aM,sM=(0,ru.kg)("libp2p:circuit-relay:transport:reservation-store"),uM=new WeakSet,cM=new WeakSet,lM=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i,o,a;return(0,K.Z)(this,n),a=t.call(this),pw((0,nr.Z)(a),cM),pw((0,nr.Z)(a),uM),(0,ot.Z)((0,nr.Z)(a),"peerId",void 0),(0,ot.Z)((0,nr.Z)(a),"connectionManager",void 0),(0,ot.Z)((0,nr.Z)(a),"transportManager",void 0),(0,ot.Z)((0,nr.Z)(a),"peerStore",void 0),(0,ot.Z)((0,nr.Z)(a),"events",void 0),(0,ot.Z)((0,nr.Z)(a),"reserveQueue",void 0),(0,ot.Z)((0,nr.Z)(a),"reservations",void 0),(0,ot.Z)((0,nr.Z)(a),"maxDiscoveredRelays",void 0),(0,ot.Z)((0,nr.Z)(a),"started",void 0),a.peerId=e.peerId,a.connectionManager=e.connectionManager,a.transportManager=e.transportManager,a.peerStore=e.peerStore,a.events=e.events,a.reservations=new Qk,a.maxDiscoveredRelays=null!==(i=null===r||void 0===r?void 0:r.discoverRelays)&&void 0!==i?i:0,a.started=!1,a.reserveQueue=new uc.Z({concurrency:null!==(o=null===r||void 0===r?void 0:r.reservationConcurrency)&&void 0!==o?o:1}),a.events.addEventListener("peer:disconnect",(function(e){dw((0,nr.Z)(a),cM,pM).call((0,nr.Z)(a),e.detail)})),a}return(0,W.Z)(n,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.started=!0;case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.reservations.forEach((function(e){var t=e.timeout;clearTimeout(t)})),this.reservations.clear(),this.started=!0;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"addRelay",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.peerId.equals(t)){e.next=3;break}return sM("not trying to use self as relay"),e.abrupt("return");case 3:return sM("add relay %p",t),e.next=6,this.reserveQueue.add((0,u.Z)((0,s.Z)().mark((function e(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,null==(i=r.reservations.get(t))){e.next=8;break}if(!(XB(i.reservation.expire)>6e5)){e.next=6;break}return sM("already have reservation on relay peer %p and it expires in more than 10 minutes",t),e.abrupt("return");case 6:clearTimeout(i.timeout),r.reservations.delete(t);case 8:if(!("discovered"===n&&(0,ye.Z)(r.reservations.values()).reduce((function(e,t){return"discovered"===t.type&&e++,e}),0)>=r.maxDiscoveredRelays)){e.next=11;break}return sM("already have enough discovered relays"),e.abrupt("return");case 11:return e.next=13,r.connectionManager.openConnection(t);case 13:if(!(o=e.sent).remoteAddr.protoNames().includes("p2p-circuit")){e.next=17;break}return sM("not creating reservation over relayed connection"),e.abrupt("return");case 17:return e.next=19,dw(r,uM,fM).call(r,o);case 19:return a=e.sent,sM("created reservation on relay peer %p",t),u=XB(a.expire),c=Math.min(Math.max(u-3e5,3e4),Math.pow(2,31)-1),l=setTimeout((function(){r.addRelay(t,n).catch((function(e){sM.error("could not refresh reservation to relay %p",t,e)}))}),c),r.reservations.set(t,{timeout:l,reservation:a,type:n}),e.next=27,r.peerStore.merge(t,{tags:(0,ot.Z)({},"circuit-relay-relay",{value:1,ttl:u})});case 27:return e.next=29,r.transportManager.listen([WS("/p2p/".concat(t.toString(),"/p2p-circuit"))]);case 29:e.next=35;break;case 31:e.prev=31,e.t0=e.catch(0),sM.error("could not reserve slot on %p",t,e.t0),r.reservations.delete(t);case 35:case"end":return e.stop()}}),e,null,[[0,31]])}))));case 6:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"hasReservation",value:function(e){return this.reservations.has(e)}},{key:"getReservation",value:function(e){var t;return null===(t=this.reservations.get(e))||void 0===t?void 0:t.reservation}}]),n}(Ch);function fM(e){return hM.apply(this,arguments)}function hM(){return(hM=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return sM("requesting reservation from %s",t.remotePeer),e.next=3,t.newStream(WB);case 3:return r=e.sent,i=nn(r),(o=i.pb(FB)).write({type:FB.Type.RESERVE}),e.prev=7,e.next=10,o.read();case 10:a=e.sent,e.next=17;break;case 13:throw e.prev=13,e.t0=e.catch(7),sM.error("error parsing reserve message response from %p because",t.remotePeer,e.t0),e.t0;case 17:return e.prev=17,r.close(),e.finish(17);case 20:if(a.status!==VB.OK||null==a.reservation){e.next=22;break}return e.abrupt("return",a.reservation);case 22:throw u="reservation failed with status ".concat(null!==(n=a.status)&&void 0!==n?n:"undefined"),sM.error(u),new Error(u);case 25:case"end":return e.stop()}}),e,null,[[7,13,17,20]])})))).apply(this,arguments)}function pM(e){var t=this.reservations.get(e);null!=t&&(sM("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(sM("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}var dM=(0,ru.kg)("libp2p:circuit-relay:transport"),vM=function(e){if(null==e.peer)return!1;try{e.peer.addrs.forEach(WS)}catch(t){return!1}return!0};aM=Symbol.toStringTag;var yM=function(){function e(t,n){var r=this;(0,K.Z)(this,e),(0,ot.Z)(this,"discovery",void 0),(0,ot.Z)(this,"registrar",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"connectionManager",void 0),(0,ot.Z)(this,"peerId",void 0),(0,ot.Z)(this,"upgrader",void 0),(0,ot.Z)(this,"addressManager",void 0),(0,ot.Z)(this,"connectionGater",void 0),(0,ot.Z)(this,"reservationStore",void 0),(0,ot.Z)(this,"started",void 0),(0,ot.Z)(this,ul,!0),(0,ot.Z)(this,aM,"libp2p/circuit-relay-v2"),this.registrar=t.registrar,this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.peerId=t.peerId,this.upgrader=t.upgrader,this.addressManager=t.addressManager,this.connectionGater=t.connectionGater,null!=n.discoverRelays&&n.discoverRelays>0&&(this.discovery=new tM(t),this.discovery.addEventListener("relay:discover",(function(e){r.reservationStore.addRelay(e.detail,"discovered").catch((function(t){dM.error("could not add discovered relay %p",e.detail,t)}))}))),this.reservationStore=new lM(t,n),this.reservationStore.addEventListener("relay:not-enough-relays",(function(){var e;null===(e=r.discovery)||void 0===e||e.discover().catch((function(e){dM.error("could not discover relays",e)}))})),this.started=!1}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.reservationStore.start();case 2:return e.next=4,null===(t=this.discovery)||void 0===t?void 0:t.start();case 4:return e.next=6,this.registrar.handle(qB,(function(e){n.onStop(e).catch((function(e){dM.error(e)}))}));case 6:this.started=!0;case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null===(t=this.discovery)||void 0===t||t.stop(),e.next=3,this.reservationStore.stop();case 3:return e.next=5,this.registrar.unhandle(qB);case 5:this.started=!1;case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p,d,v,y,g=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=g.length>1&&void 0!==g[1]?g[1]:{},1===t.protoCodes().filter((function(e){return 290===e})).length){e.next=5;break}throw r="Invalid circuit relay address",dM.error(r,t),new ar.s(r,PA.ERR_RELAYED_DIAL);case 5:if(i=t.toString().split("/p2p-circuit"),o=WS(i[0]),a=WS(i[i.length-1]),u=o.getPeerId(),c=a.getPeerId(),null!=u&&null!=c){e.next=14;break}throw l="Circuit relay dial to ".concat(t.toString()," failed as address did not have peer ids"),dM.error(l),new ar.s(l,PA.ERR_RELAYED_DIAL);case 14:if(f=(0,Ps.jE)(u),h=(0,Ps.jE)(c),p=!1,d=this.connectionManager.getConnections(f),null!=(v=d[0])){e.next=26;break}return e.next=22,this.peerStore.merge(f,{multiaddrs:[o]});case 22:return e.next=24,this.connectionManager.openConnection(f,n);case 24:v=e.sent,p=!0;case 26:return e.prev=26,e.next=29,v.newStream([WB]);case 29:return y=e.sent,e.next=32,this.connectV2({stream:y,connection:v,destinationPeer:h,destinationAddr:a,relayAddr:o,ma:t,disconnectOnFailure:p});case 32:return e.abrupt("return",e.sent);case 35:if(e.prev=35,e.t0=e.catch(26),dM.error("Circuit relay dial to destination ".concat(h.toString()," via relay ").concat(f.toString()," failed"),e.t0),null!=y&&y.abort(e.t0),e.t1=p,!e.t1){e.next=43;break}return e.next=43,v.close();case 43:throw e.t0;case 44:case"end":return e.stop()}}),e,this,[[26,35]])})));return function(t){return e.apply(this,arguments)}}()},{key:"connectV2",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p,d,v;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.stream,r=t.connection,i=t.destinationPeer,o=t.destinationAddr,a=t.relayAddr,u=t.ma,c=t.disconnectOnFailure,e.prev=1,l=nn(n),(f=l.pb(FB)).write({type:FB.Type.CONNECT,peer:{id:i.toBytes(),addrs:[WS(o).bytes]}}),e.next=7,f.read();case 7:if((h=e.sent).status===VB.OK){e.next=10;break}throw new ar.s("failed to connect via relay with status ".concat(null!==(p=null===h||void 0===h||null===(d=h.status)||void 0===d?void 0:d.toString())&&void 0!==p?p:"undefined"),PA.ERR_HOP_REQUEST_FAILED);case 10:return v=JB({stream:l.unwrap(),remoteAddr:u,localAddr:a.encapsulate("/p2p-circuit/p2p/".concat(this.peerId.toString()))}),dM("new outbound connection %s",v.remoteAddr),e.next=14,this.upgrader.upgradeOutbound(v);case 14:return e.abrupt("return",e.sent);case 17:if(e.prev=17,e.t0=e.catch(1),dM.error("Circuit relay dial to destination ".concat(i.toString()," via relay ").concat(r.remotePeer.toString()," failed"),e.t0),e.t1=c,!e.t1){e.next=24;break}return e.next=24,r.close();case 24:throw e.t0;case 25:case"end":return e.stop()}}),e,this,[[1,17]])})));return function(t){return e.apply(this,arguments)}}()},{key:"createListener",value:function(e){return function(e){return new iM(e)}({connectionManager:this.connectionManager,relayStore:this.reservationStore})}},{key:"filter",value:function(e){return(e=Array.isArray(e)?e:[e]).filter((function(e){return Jp.matches(e)}))}},{key:"onStop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.connection,o=t.stream,a=nn(o),e.next=4,a.readPB(jB);case 4:if(u=e.sent,dM("received circuit v2 stop protocol request from %s",i.remotePeer),void 0!==(null===u||void 0===u?void 0:u.type)){e.next=8;break}return e.abrupt("return");case 8:if(c=a.pb(jB),dM("new circuit relay v2 stop stream from %s",i.remotePeer),u.type===jB.Type.CONNECT){e.next=14;break}return dM.error("invalid stop connect request via peer %s",i.remotePeer),c.write({type:jB.Type.STATUS,status:VB.UNEXPECTED_MESSAGE}),e.abrupt("return");case 14:if(vM(u)){e.next=18;break}return dM.error("invalid stop connect request via peer %s",i.remotePeer),c.write({type:jB.Type.STATUS,status:VB.MALFORMED_MESSAGE}),e.abrupt("return");case 18:return l=(0,Ps.cv)(u.peer.id),e.next=21,null===(n=(r=this.connectionGater).denyInboundRelayedConnection)||void 0===n?void 0:n.call(r,i.remotePeer,l);case 21:if(e.t0=e.sent,!0!==e.t0){e.next=25;break}return c.write({type:jB.Type.STATUS,status:VB.PERMISSION_DENIED}),e.abrupt("return");case 25:return c.write({type:jB.Type.STATUS,status:VB.OK}),f=i.remoteAddr.encapsulate("/p2p-circuit/p2p/".concat(l.toString())),h=this.addressManager.getAddresses()[0],p=JB({stream:a.unwrap(),remoteAddr:f,localAddr:h}),dM("new inbound connection %s",p.remoteAddr),e.next=32,this.upgrader.upgradeInbound(p);case 32:dM("%s connection %s upgraded","inbound",p.remoteAddr);case 33:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();function gM(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t){return new yM(t,e)}}var mM,bM="js-libp2p/".concat("0.45.5");!function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs){var r,i=(0,Ae.Z)(e.listenAddrs);try{for(i.s();!(r=i.n()).done;){var o=r.value;t.uint32(18),t.bytes(o)}}catch(c){i.e(c)}finally{i.f()}}if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols){var a,s=(0,Ae.Z)(e.protocols);try{for(s.s();!(a=s.n()).done;){var u=a.value;t.uint32(26),t.string(u)}}catch(c){s.e(c)}finally{s.f()}}null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={listenAddrs:[],protocols:[]},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 5:n.protocolVersion=e.string();break;case 6:n.agentVersion=e.string();break;case 1:n.publicKey=e.bytes();break;case 2:n.listenAddrs.push(e.bytes());break;case 4:n.observedAddr=e.bytes();break;case 3:n.protocols.push(e.string());break;case 8:n.signedPeerRecord=e.bytes();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(mM||(mM={}));var wM=(0,ru.kg)("libp2p:identify"),kM={protocolPrefix:"ipfs",agentVersion:bM,timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1,maxObservedAddresses:10,maxIdentifyMessageSize:8192},EM=new WeakSet,xM=function(){function e(t,n){var r,i,o,a,s,u,c,l,f,h,p,d=this;(0,K.Z)(this,e),pw(this,EM),(0,ot.Z)(this,"identifyProtocolStr",void 0),(0,ot.Z)(this,"identifyPushProtocolStr",void 0),(0,ot.Z)(this,"host",void 0),(0,ot.Z)(this,"started",void 0),(0,ot.Z)(this,"timeout",void 0),(0,ot.Z)(this,"peerId",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"registrar",void 0),(0,ot.Z)(this,"connectionManager",void 0),(0,ot.Z)(this,"addressManager",void 0),(0,ot.Z)(this,"maxInboundStreams",void 0),(0,ot.Z)(this,"maxOutboundStreams",void 0),(0,ot.Z)(this,"maxPushIncomingStreams",void 0),(0,ot.Z)(this,"maxPushOutgoingStreams",void 0),(0,ot.Z)(this,"maxIdentifyMessageSize",void 0),(0,ot.Z)(this,"maxObservedAddresses",void 0),(0,ot.Z)(this,"events",void 0),this.started=!1,this.peerId=t.peerId,this.peerStore=t.peerStore,this.registrar=t.registrar,this.addressManager=t.addressManager,this.connectionManager=t.connectionManager,this.events=t.events,this.identifyProtocolStr="/".concat(null!==(r=n.protocolPrefix)&&void 0!==r?r:kM.protocolPrefix,"/").concat("id","/").concat("1.0.0"),this.identifyPushProtocolStr="/".concat(null!==(i=n.protocolPrefix)&&void 0!==i?i:kM.protocolPrefix,"/").concat("id/push","/").concat("1.0.0"),this.timeout=null!==(o=n.timeout)&&void 0!==o?o:kM.timeout,this.maxInboundStreams=null!==(a=n.maxInboundStreams)&&void 0!==a?a:kM.maxInboundStreams,this.maxOutboundStreams=null!==(s=n.maxOutboundStreams)&&void 0!==s?s:kM.maxOutboundStreams,this.maxPushIncomingStreams=null!==(u=n.maxPushIncomingStreams)&&void 0!==u?u:kM.maxPushIncomingStreams,this.maxPushOutgoingStreams=null!==(c=n.maxPushOutgoingStreams)&&void 0!==c?c:kM.maxPushOutgoingStreams,this.maxIdentifyMessageSize=null!==(l=n.maxIdentifyMessageSize)&&void 0!==l?l:kM.maxIdentifyMessageSize,this.maxObservedAddresses=null!==(f=n.maxObservedAddresses)&&void 0!==f?f:kM.maxObservedAddresses,this.host={protocolVersion:"".concat(null!==(h=n.protocolPrefix)&&void 0!==h?h:kM.protocolPrefix,"/").concat("0.1.0"),agentVersion:null!==(p=n.agentVersion)&&void 0!==p?p:kM.agentVersion},t.events.addEventListener("connection:open",(function(e){var t=e.detail;d.identify(t).catch((function(e){wM.error("error during identify trigged by connection:open",e)}))})),t.events.addEventListener("self:peer:update",(function(e){d.push().catch((function(e){wM.error(e)}))})),this.host.agentVersion===bM&&($v||Qv?this.host.agentVersion+=" UserAgent=".concat(globalThis.process.version):(Yv||Jv||Xv||ey)&&(this.host.agentVersion+=" UserAgent=".concat(globalThis.navigator.userAgent)))}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.started){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.peerStore.merge(this.peerId,{metadata:{AgentVersion:Dm(this.host.agentVersion),ProtocolVersion:Dm(this.host.protocolVersion)}});case 4:return e.next=6,this.registrar.handle(this.identifyProtocolStr,(function(e){t._handleIdentify(e).catch((function(e){wM.error(e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams});case 6:return e.next=8,this.registrar.handle(this.identifyPushProtocolStr,(function(e){t._handlePush(e).catch((function(e){wM.error(e)}))}),{maxInboundStreams:this.maxPushIncomingStreams,maxOutboundStreams:this.maxPushOutgoingStreams});case 8:this.started=!0;case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.registrar.unhandle(this.identifyProtocolStr);case 2:return e.next=4,this.registrar.unhandle(this.identifyPushProtocolStr);case 4:this.started=!1;case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"pushToConnections",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c,l,f,h,p,d=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.addressManager.getAddresses().map((function(e){return e.decapsulateCode(vS("p2p").code)})),o=new lx({peerId:this.peerId,multiaddrs:i}),e.next=4,mE.seal(o,this.peerId);case 4:return a=e.sent,c=this.registrar.getProtocols(),e.next=8,this.peerStore.get(this.peerId);case 8:return l=e.sent,f=Om(null!==(n=l.metadata.get("AgentVersion"))&&void 0!==n?n:Dm(this.host.agentVersion)),h=Om(null!==(r=l.metadata.get("ProtocolVersion"))&&void 0!==r?r:Dm(this.host.protocolVersion)),p=t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=AbortSignal.timeout(d.timeout);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,r)}catch(s){}return e.prev=2,e.next=5,t.newStream([d.identifyPushProtocolStr],{signal:r});case 5:return n=e.sent,o=yu(n,r),e.next=9,o.sink(Qm([mM.encode({listenAddrs:i.map((function(e){return e.bytes})),signedPeerRecord:a.marshal(),protocols:c,agentVersion:f,protocolVersion:h})],(function(e){return jb(e)})));case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(2),wM.error("could not push identify update to peer",e.t0);case 14:return e.prev=14,null!=n&&n.close(),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[2,11,14,17]])})));return function(t){return e.apply(this,arguments)}}()),e.next=14,Promise.all(p);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"push",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isStarted()){e.next=2;break}return e.abrupt("return");case 2:return t=[],e.next=5,Promise.all(this.connectionManager.getConnections().map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.peerStore.get(r.remotePeer);case 3:if(e.sent.protocols.includes(n.identifyPushProtocolStr)){e.next=6;break}return e.abrupt("return");case 6:t.push(r),e.next=13;break;case 9:if(e.prev=9,e.t0=e.catch(0),e.t0.code===PA.ERR_NOT_FOUND){e.next=13;break}throw e.t0;case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()));case 5:return e.next=7,this.pushToConnections(t);case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_identify",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c=this,l=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=l.length>1&&void 0!==l[1]?l[1]:{},i=nb([AbortSignal.timeout(this.timeout),null===n||void 0===n?void 0:n.signal]);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,i)}catch(f){}return e.prev=3,e.next=6,t.newStream([this.identifyProtocolStr],{signal:i});case 6:return r=e.sent,o=yu(r,i),e.next=10,Qm([],o,(function(e){var t;return Hb(e,{maxDataLength:null!==(t=c.maxIdentifyMessageSize)&&void 0!==t?t:8192})}),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",SZ(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 10:if(null!=(a=e.sent)){e.next=13;break}throw new ar.s("No data could be retrieved",PA.ERR_CONNECTION_ENDED);case 13:return e.prev=13,e.abrupt("return",mM.decode(a));case 17:throw e.prev=17,e.t0=e.catch(13),new ar.s(String(e.t0),PA.ERR_INVALID_MESSAGE);case 20:return e.prev=20,null!=r&&r.close(),i.clear(),e.finish(20);case 24:case"end":return e.stop()}}),e,this,[[3,,20,24],[13,17]])})));return function(t){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=p.length>1&&void 0!==p[1]?p[1]:{},e.next=3,this._identify(t,r);case 3:if(i=e.sent,o=i.publicKey,a=i.protocols,u=i.observedAddr,null!=o){e.next=7;break}throw new ar.s("public key was missing from identify message",PA.ERR_MISSING_PUBLIC_KEY);case 7:return e.next=9,(0,Ps.y5)(o);case 9:if(c=e.sent,t.remotePeer.equals(c)){e.next=12;break}throw new ar.s("identified peer does not match the expected peer",PA.ERR_INVALID_PEER);case 12:if(!this.peerId.equals(c)){e.next=14;break}throw new ar.s("identified peer is our own peer id?",PA.ERR_INVALID_PEER);case 14:return l=AM(u),wM("identify completed for peer %p and protocols %o",c,a),wM("our observed address is %s",l),null!=l&&this.addressManager.getObservedAddrs().length<(null!==(n=this.maxObservedAddresses)&&void 0!==n?n:1/0)&&(wM("storing our observed address %s",null===l||void 0===l?void 0:l.toString()),this.addressManager.addObservedAddr(l)),e.next=20,dw(this,EM,_M).call(this,t.remotePeer,i);case 20:f=e.sent,h={peerId:c,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map((function(e){return WS(e)})),observedAddr:null==i.observedAddr?void 0:WS(i.observedAddr),protocols:i.protocols,signedPeerRecord:f},this.events.safeDispatchEvent("peer:identify",{detail:h});case 23:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleIdentify",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p,d,v;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.connection,r=t.stream,i=AbortSignal.timeout(this.timeout);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,i)}catch(s){}return e.prev=3,a=null!==(o=this.peerId.publicKey)&&void 0!==o?o:new Uint8Array(0),e.next=7,this.peerStore.get(this.peerId);case 7:if(u=e.sent,c=this.addressManager.getAddresses().map((function(e){return e.decapsulateCode(vS("p2p").code)})),l=u.peerRecordEnvelope,!(c.length>0&&null==l)){e.next=16;break}return f=new lx({peerId:this.peerId,multiaddrs:c}),e.next=14,mE.seal(f,this.peerId);case 14:h=e.sent,l=h.marshal().subarray();case 16:return p=mM.encode({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:a,listenAddrs:c.map((function(e){return e.bytes})),signedPeerRecord:l,observedAddr:n.remoteAddr.bytes,protocols:u.protocols}),d=yu(r,i),v=Qm([p],(function(e){return jb(e)})),e.next=21,d.sink(v);case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(3),wM.error("could not respond to identify request",e.t0);case 26:return e.prev=26,r.close(),e.finish(26);case 29:case"end":return e.stop()}}),e,this,[[3,23,26,29]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_handlePush",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.connection,r=t.stream,e.prev=1,!this.peerId.equals(n.remotePeer)){e.next=4;break}throw new Error("received push from ourselves?");case 4:return o=yu(r,AbortSignal.timeout(this.timeout)),a=nn(o,{maxDataLength:null!==(i=this.maxIdentifyMessageSize)&&void 0!==i?i:8192}),e.next=8,a.readPB(mM);case 8:return u=e.sent,e.next=11,dw(this,EM,_M).call(this,n.remotePeer,u);case 11:e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(1),wM.error("received invalid message",e.t0),e.abrupt("return");case 17:return e.prev=17,r.close(),e.finish(17);case 20:wM("handled push from %p",n.remotePeer);case 21:case"end":return e.stop()}}),e,this,[[1,13,17,20]])})));return function(t){return e.apply(this,arguments)}}()}]),e}();function _M(e,t){return SM.apply(this,arguments)}function SM(){return SM=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(wM("received identify from %p",t),null!=n){e.next=3;break}throw new Error("Message was null or undefined");case 3:if(r={addresses:n.listenAddrs.map((function(e){return{isCertified:!1,multiaddr:WS(e)}})),protocols:n.protocols,metadata:new Map,peerRecordEnvelope:n.signedPeerRecord},null==n.signedPeerRecord){e.next=38;break}return wM("received signedPeerRecord in push from %p",t),o=n.signedPeerRecord,e.next=9,mE.openAndCertify(o,lx.DOMAIN);case 9:if(a=e.sent,(u=lx.createFromProtobuf(a.payload)).peerId.equals(a.peerId)){e.next=13;break}throw new Error("signing key does not match PeerId in the PeerRecord");case 13:if(t.equals(u.peerId)){e.next=15;break}throw new Error("signing key does not match remote PeerId");case 15:return e.prev=15,e.next=18,this.peerStore.get(u.peerId);case 18:c=e.sent,e.next=25;break;case 21:if(e.prev=21,e.t0=e.catch(15),"ERR_NOT_FOUND"===e.t0.code){e.next=25;break}throw e.t0;case 25:if(null==c){e.next=33;break}if(r.metadata=c.metadata,null==c.peerRecordEnvelope){e.next=33;break}return e.next=30,mE.createFromProtobuf(c.peerRecordEnvelope);case 30:l=e.sent,(f=lx.createFromProtobuf(l.payload)).seqNumber>=u.seqNumber&&(wM("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,u.seqNumber),u=f,o=c.peerRecordEnvelope);case 33:r.peerRecordEnvelope=o,r.addresses=u.multiaddrs.map((function(e){return{isCertified:!0,multiaddr:e}})),i={seq:u.seqNumber,addresses:u.multiaddrs},e.next=39;break;case 38:wM("%p did not send a signed peer record",t);case 39:return null!=n.agentVersion&&r.metadata.set("AgentVersion",Dm(n.agentVersion)),null!=n.protocolVersion&&r.metadata.set("ProtocolVersion",Dm(n.protocolVersion)),e.next=43,this.peerStore.patch(t,r);case 43:return e.abrupt("return",i);case 44:case"end":return e.stop()}}),e,this,[[15,21]])}))),SM.apply(this,arguments)}function AM(e){if(null!=e&&e.length>0)try{return WS(e)}catch(t){}}function ZM(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t){return new xM(t,e)}}var TM={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function CM(){return{addresses:{listen:["/webrtc"]},transports:[Tv(),Zv(),Qg(),hy(),gM({discoverRelays:1})],connectionEncryption:[MD()],streamMuxers:[rc(),al()],peerDiscovery:[(e=TM,function(t){return new NO(t,e)})],contentRouters:[UR("https://cid.contact")],services:{identify:ZM(),autoNAT:MB(),pubsub:JI(),dht:wB({clientMode:!0,validators:{ipns:LB},selectors:{ipns:DB}})}};var e}function IM(e,t){return DM.apply(this,arguments)}function DM(){return(DM=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=CM(),n=null!==(r=n)&&void 0!==r?r:{},e.abrupt("return",VT((0,Nt.Z)((0,Nt.Z)((0,Nt.Z)({datastore:t},i),n),{},{start:!1})));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var OM="1.3.1",RM="helia",PM=(0,ru.kg)("helia");function LM(){return NM.apply(this,arguments)}function NM(){return NM=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,c=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=null!==(t=(r=c.length>0&&void 0!==c[0]?c[0]:{}).datastore)&&void 0!==t?t:new Hm,o=null!==(n=r.blockstore)&&void 0!==n?n:new sm,!BM(r.libp2p)){e.next=7;break}a=r.libp2p,e.next=10;break;case 7:return e.next=9,IM(i,r.libp2p);case 9:a=e.sent;case 10:if(u=new hk((0,Nt.Z)((0,Nt.Z)({},r),{},{datastore:i,blockstore:o,libp2p:a})),!1===r.start){e.next=14;break}return e.next=14,u.start();case 14:if(!u.libp2p.isStarted()){e.next=19;break}return e.next=17,MM(u);case 17:e.next=20;break;case 19:u.libp2p.addEventListener("start",(function(){MM(u).catch((function(e){PM.error("could not add Helia to agent version",e)}))}));case 20:return e.abrupt("return",u);case 21:case"end":return e.stop()}}),e)}))),NM.apply(this,arguments)}function BM(e){if(null==e)return!1;return["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every((function(t){return"function"===typeof e[t]}))}function MM(e){return FM.apply(this,arguments)}function FM(){return FM=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.libp2p.peerStore.get(t.libp2p.peerId);case 2:if(n=e.sent,null!=(r=n.metadata.get("AgentVersion"))){e.next=6;break}return e.abrupt("return");case 6:if(null!=(i=(new TextDecoder).decode(r)).match(/js-libp2p\/\d+\.\d+\.\d+\sUserAgent=/)){e.next=9;break}return e.abrupt("return");case 9:return i=i.includes(RM)?"".concat(RM,"/").concat(OM," ").concat(i.split(" ").slice(1).join(" ")):"".concat(RM,"/").concat(OM," ").concat(i),e.next=12,t.libp2p.peerStore.merge(t.libp2p.peerId,{metadata:{AgentVersion:(new TextEncoder).encode(i)}});case 12:case"end":return e.stop()}}),e)}))),FM.apply(this,arguments)}var jM=xl.C,UM=xl.aY,zM=function e(t){var n=0;if(t=t.toString().trim(),jM(t)){var r=new Uint8Array(n+4);return t.split(/\./g).forEach((function(e){r[n++]=255&parseInt(e,10)})),r}if(UM(t)){var i,o=t.split(":",8);for(i=0;i<o.length;i++){var a=void 0;jM(o[i])&&(a=e(o[i]),o[i]=eu(a.slice(0,2),"base16")),null!=a&&++i<8&&o.splice(i,0,eu(a.slice(2,4),"base16"))}if(""===o[0])for(;o.length<8;)o.unshift("0");else if(""===o[o.length-1])for(;o.length<8;)o.push("0");else if(o.length<8){for(i=0;i<o.length&&""!==o[i];i++);var s=[i,1];for(i=9-o.length;i>0;i--)s.push("0");o.splice.apply(o,s)}var u=new Uint8Array(n+16);for(i=0;i<o.length;i++){var c=parseInt(o[i],16);u[n++]=c>>8&255,u[n++]=255&c}return u}throw new Error("invalid ip address")},HM=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;n=~~n,r=null!==(t=r)&&void 0!==t?t:e.length-n;var i=new DataView(e.buffer);if(4===r){for(var o=[],a=0;a<r;a++)o.push(e[n+a]);return o.join(".")}if(16===r){for(var s=[],u=0;u<r;u+=2)s.push(i.getUint16(n+u).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},VM=-1,GM={},KM={};function WM(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}function qM(e){if("number"===typeof e){if(null!=KM[e])return KM[e];throw new Error("no protocol with code: ".concat(e))}if("string"===typeof e){if(null!=GM[e])return GM[e];throw new Error("no protocol with name: ".concat(e))}throw new Error("invalid protocol id type: ".concat(typeof e))}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,VM,"ip6zone"],[43,8,"ipcidr"],[53,VM,"dns",!0],[54,VM,"dns4",!0],[55,VM,"dns6",!0],[56,VM,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,VM,"unix",!1,!0],[421,VM,"ipfs"],[421,VM,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,VM,"garlic64"],[448,0,"tls"],[449,VM,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,VM,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,VM,"memory"]].forEach((function(e){var t=WM.apply(void 0,(0,ye.Z)(e));KM[t.code]=t,GM[t.name]=t}));qM("ip4"),qM("ip6"),qM("ipcidr");function YM(e,t){switch(qM(e).code){case 4:case 41:return function(e){var t=HM(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!xl.h6(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return rF(t);case 6:case 273:case 33:case 132:return tF(t).toString();case 421:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return eu(n,"base58btc")}(t);case 444:case 445:return iF(t);case 466:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+eu(n,"base64url")}(t);default:return eu(t,"base16")}}function QM(e,t){switch(qM(e).code){case 4:case 41:return JM(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return nF(t);case 6:case 273:case 33:case 132:return eF(parseInt(t,10));case 421:return function(e){var t;t="Q"===e[0]||"1"===e[0]?b.decode(gr.base58btc.decode("z".concat(e))).bytes:c.CID.parse(e).multihash.bytes;var n=Uint8Array.from(A().encode(t.length));return Gn([n,t],n.length+t.length)}(t);case 444:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(16!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion address."));var n=kl.base32.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=eF(r);return Gn([n,i],n.length+i.length)}(t);case 445:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(56!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion3 address."));var n=kl.base32.decode("b".concat(t[0])),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=eF(r);return Gn([n,i],n.length+i.length)}(t);case 466:return function(e){var t=$M.decode(e),n=Uint8Array.from(A().encode(t.length));return Gn([n,t],n.length+t.length)}(t);default:return Us(t,"base16")}}var XM=Object.values(cr.gh).map((function(e){return e.decoder})),$M=function(){var e=XM[0].or(XM[1]);return XM.slice(2).forEach((function(t){return e=e.or(t)})),e}();function JM(e){if(!xl.h6(e))throw new Error("invalid ip address");return zM(e)}function eF(e){var t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function tF(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function nF(e){var t=Us(e),n=Uint8Array.from(A().encode(t.length));return Gn([n,t],n.length+t.length)}function rF(e){var t=A().decode(e);if((e=e.slice(A().decode.bytes)).length!==t)throw new Error("inconsistent lengths");return eu(e)}function iF(e){var t=e.slice(0,e.length-2),n=e.slice(e.length-2),r=eu(t,"base32"),i=tF(n);return"".concat(r,":").concat(i)}function oF(e){return e.map((function(e){var t=vF(e);return null!=e[1]?[t.code,YM(t.code,e[1])]:[t.code]}))}function aF(e){return fF(Gn(e.map((function(e){var t=vF(e),n=Uint8Array.from(A().encode(t.code));return e.length>1&&null!=e[1]&&(n=Gn([n,e[1]])),n}))))}function sF(e,t){return e.size>0?e.size/8:0===e.size?0:A().decode(t)+(null!==(n=A().decode.bytes)&&void 0!==n?n:0);var n}function uF(e){for(var t=[],n=0;n<e.length;){var r,i=A().decode(e,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0,a=sF(qM(i),e.slice(n+o));if(0!==a){var s=e.slice(n+o,n+o+a);if((n+=a+o)>e.length)throw dF("Invalid address Uint8Array: "+eu(e,"base16"));t.push([i,s])}else t.push([i]),n+=o}return t}function cF(e){return function(e){var t=[];return e.map((function(e){var n=vF(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),pF(t.join("/"))}(oF(uF(e)))}function lF(e){var t=function(e){var t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(var r=0;r<n.length;r++){var i=n[r],o=qM(i);if(0!==o.size){if(++r>=n.length)throw dF("invalid address: "+e);if(!0===o.path){t.push([i,pF(n.slice(r).join("/"))]);break}t.push([i,n[r]])}else t.push([i])}return t}(e=pF(e));return aF(t.map((function(e){Array.isArray(e)||(e=[e]);var t=vF(e);return e.length>1?[t.code,QM(t.code,e[1])]:[t.code]})))}function fF(e){var t=hF(e);if(null!=t)throw t;return Uint8Array.from(e)}function hF(e){try{uF(e)}catch(t){return t}}function pF(e){return"/"+e.trim().split("/").filter((function(e){return e})).join("/")}function dF(e){return new Error("Error parsing address: "+e)}function vF(e){return qM(e[0])}var yF=Symbol.for("nodejs.util.inspect.custom"),gF=[qM("dns").code,qM("dns4").code,qM("dns6").code,qM("dnsaddr").code],mF=new Map,bF=Symbol.for("@multiformats/js-multiaddr/multiaddr");function wF(e){return Boolean(null===e||void 0===e?void 0:e[bF])}var kF=new WeakMap,EF=new WeakMap,xF=new WeakMap,_F=new WeakMap,SF=function(){function e(t){if((0,K.Z)(this,e),(0,ot.Z)(this,"bytes",void 0),(0,cl.Z)(this,kF,{writable:!0,value:void 0}),(0,cl.Z)(this,EF,{writable:!0,value:void 0}),(0,cl.Z)(this,xF,{writable:!0,value:void 0}),(0,cl.Z)(this,_F,{writable:!0,value:void 0}),(0,ot.Z)(this,bF,!0),null==t&&(t=""),t instanceof Uint8Array)this.bytes=fF(t);else if("string"===typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error('multiaddr "'.concat(t,'" must start with a "/"'));this.bytes=lF(t)}else{if(!wF(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=fF(t.bytes)}}return(0,W.Z)(e,[{key:"toString",value:function(){return null==(0,fl.Z)(this,kF)&&(0,ll.Z)(this,kF,cF(this.bytes)),(0,fl.Z)(this,kF)}},{key:"toJSON",value:function(){return this.toString()}},{key:"toOptions",value:function(){var e,t,n,r,i,o="",a=qM("tcp"),s=qM("udp"),u=qM("ip4"),c=qM("ip6"),l=qM("dns6"),f=qM("ip6zone"),h=(0,Ae.Z)(this.stringTuples());try{for(h.s();!(i=h.n()).done;){var p=(0,k.Z)(i.value,2),d=p[0],v=p[1];d===f.code&&(o="%".concat(null!==v&&void 0!==v?v:"")),gF.includes(d)&&(t=a.name,r=443,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===l.code?6:4),d!==a.code&&d!==s.code||(t=qM(d).name,r=parseInt(null!==v&&void 0!==v?v:"")),d!==u.code&&d!==c.code||(t=qM(d).name,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===c.code?6:4)}}catch(y){h.e(y)}finally{h.f()}if(null==e||null==t||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:r}}},{key:"protos",value:function(){return this.protoCodes().map((function(e){return Object.assign({},qM(e))}))}},{key:"protoCodes",value:function(){for(var e=[],t=this.bytes,n=0;n<t.length;){var r,i=A().decode(t,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0;n+=sF(qM(i),t.slice(n+o))+o,e.push(i)}return e}},{key:"protoNames",value:function(){return this.protos().map((function(e){return e.name}))}},{key:"tuples",value:function(){return null==(0,fl.Z)(this,EF)&&(0,ll.Z)(this,EF,uF(this.bytes)),(0,fl.Z)(this,EF)}},{key:"stringTuples",value:function(){return null==(0,fl.Z)(this,xF)&&(0,ll.Z)(this,xF,oF(this.tuples())),(0,fl.Z)(this,xF)}},{key:"encapsulate",value:function(t){return t=new e(t),new e(this.toString()+t.toString())}},{key:"decapsulate",value:function(t){var n=t.toString(),r=this.toString(),i=r.lastIndexOf(n);if(i<0)throw new Error("Address ".concat(this.toString()," does not contain subaddress: ").concat(t.toString()));return new e(r.slice(0,i))}},{key:"decapsulateCode",value:function(t){for(var n=this.tuples(),r=n.length-1;r>=0;r--)if(n[r][0]===t)return new e(aF(n.slice(0,r)));return this}},{key:"getPeerId",value:function(){try{var e=this.stringTuples().filter((function(e){return e[0]===GM.ipfs.code})),t=e.pop();if(null!=(null===t||void 0===t?void 0:t[1])){var n=t[1];return"Q"===n[0]||"1"===n[0]?eu(gr.base58btc.decode("z".concat(n)),"base58btc"):eu(c.CID.parse(n).multihash.bytes,"base58btc")}return null}catch(r){return null}}},{key:"getPath",value:function(){if(void 0===(0,fl.Z)(this,_F))try{(0,ll.Z)(this,_F,this.stringTuples().filter((function(e){return!0===qM(e[0]).path}))[0][1]),null==(0,fl.Z)(this,_F)&&(0,ll.Z)(this,_F,null)}catch(e){(0,ll.Z)(this,_F,null)}return(0,fl.Z)(this,_F)}},{key:"equals",value:function(e){return tu(this.bytes,e.bytes)}},{key:"resolve",value:function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=(r=this.protos().find((function(e){return e.resolvable})))){t.next=3;break}return t.abrupt("return",[this]);case 3:if(null!=(i=mF.get(r.name))){t.next=6;break}throw new ar.s("no available resolver for ".concat(r.name),"ERR_NO_AVAILABLE_RESOLVER");case 6:return t.next=8,i(this,n);case 8:return o=t.sent,t.abrupt("return",o.map((function(t){return new e(t)})));case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"nodeAddress",value:function(){var e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error('multiaddr must have a valid format - no protocol with name: "'.concat(e.transport,'". Must have a valid transport protocol: "{tcp, udp}"'));return{family:e.family,address:e.host,port:e.port}}},{key:"isThinWaistAddress",value:function(e){var t=(null!==e&&void 0!==e?e:this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}},{key:yF,value:function(){return"Multiaddr(".concat(cF(this.bytes),")")}}]),e}();function AF(e){return new SF(e)}var ZF=(0,ru.kg)("libp2p:address-manager"),TF=function(e){return e};function CF(e,t){var n=e.getPeerId();null!=n&&((0,Ps.jE)(n).equals(t)&&(e=e.decapsulate(AF("/p2p/".concat(t.toString())))));return e}var IF=function(){function e(t){var n,r=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"listen",void 0),(0,ot.Z)(this,"announce",void 0),(0,ot.Z)(this,"observed",void 0),(0,ot.Z)(this,"announceFilter",void 0);var o=i.listen,a=void 0===o?[]:o,s=i.announce,u=void 0===s?[]:s;this.components=t,this.listen=a.map((function(e){return e.toString()})),this.announce=new Set(u.map((function(e){return e.toString()}))),this.observed=new Map,this.announceFilter=null!==(n=i.announceFilter)&&void 0!==n?n:TF,this._updatePeerStoreAddresses=function(e,t){var n;return function(){clearTimeout(n),n=setTimeout((function(){n=void 0,e()}),t)}}(this._updatePeerStoreAddresses.bind(this),1e3),t.events.addEventListener("transport:listening",(function(){r._updatePeerStoreAddresses()})),t.events.addEventListener("transport:close",(function(){r._updatePeerStoreAddresses()}))}return(0,W.Z)(e,[{key:"_updatePeerStoreAddresses",value:function(){var e=this,t=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat((0,ye.Z)(this.observed.entries()).filter((function(e){var t=(0,k.Z)(e,2);t[0];return t[1].confident})).map((function(e){return AF((0,k.Z)(e,1)[0])}))).map((function(t){return t.getPeerId()===e.components.peerId.toString()?t.decapsulate("/p2p/".concat(e.components.peerId.toString())):t}));this.components.peerStore.patch(this.components.peerId,{multiaddrs:t}).catch((function(e){ZF.error("error updating addresses",e)}))}},{key:"getListenAddrs",value:function(){return Array.from(this.listen).map((function(e){return AF(e)}))}},{key:"getAnnounceAddrs",value:function(){return Array.from(this.announce).map((function(e){return AF(e)}))}},{key:"getObservedAddrs",value:function(){return Array.from(this.observed).map((function(e){return AF((0,k.Z)(e,1)[0])}))}},{key:"addObservedAddr",value:function(e){var t=(e=CF(e,this.components.peerId)).toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}},{key:"confirmObservedAddr",value:function(e){var t,n=(e=CF(e,this.components.peerId)).toString(),r=(null!==(t=this.observed.get(n))&&void 0!==t?t:{confident:!1}).confident;this.observed.set(n,{confident:!0}),r||this._updatePeerStoreAddresses()}},{key:"removeObservedAddr",value:function(e){var t=(e=CF(e,this.components.peerId)).toString();this.observed.delete(t)}},{key:"getAddresses",value:function(){var e=this,t=this.getAnnounceAddrs().map((function(e){return e.toString()}));0===t.length&&(t=this.components.transportManager.getAddrs().map((function(e){return e.toString()}))),t=t.concat(Array.from(this.observed).filter((function(e){var t=(0,k.Z)(e,2);t[0];return t[1].confident})).map((function(e){return(0,k.Z)(e,1)[0]})));var n=new Set(t);return this.announceFilter(Array.from(n).map((function(e){return AF(e)}))).map((function(t){var n;return!0===(null===(n=t.protos().pop())||void 0===n?void 0:n.path)||t.getPeerId()===e.components.peerId.toString()?t:t.encapsulate("/p2p/".concat(e.components.peerId.toString()))}))}}]),e}(),DF=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"components",{}),(0,ot.Z)(this,"_started",!1),this.components={};for(var n=0,r=Object.entries(t);n<r.length;n++){var i=(0,k.Z)(r[n],2),o=i[0],a=i[1];this.components[o]=a}}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this._started}},{key:"_invokeStartableMethod",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(Object.values(this.components).filter((function(e){return $S(e)})).map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(r=n[t])||void 0===r?void 0:r.call(n);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"beforeStart",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("beforeStart");case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("start");case 2:this._started=!0;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"afterStart",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("afterStart");case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"beforeStop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("beforeStop");case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("stop");case 2:this._started=!1;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"afterStop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("afterStop");case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),OF=["metrics","connectionProtector"],RF=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function PF(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,Nt.Z)({denyDialPeer:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyDialMultiaddr:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(4!==(n=t.stringTuples())[0][0]&&41!==n[0][0]){e.next=3;break}return e.abrupt("return",Boolean(bA("".concat(n[0][1]))));case 3:return e.abrupt("return",!1);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),denyInboundConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyOutboundConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyInboundEncryptedConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyOutboundEncryptedConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyInboundUpgradedConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyOutboundUpgradedConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),filterMultiaddrForPeer:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!0);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},e)}var LF,NF,BF=BA,MF=qM("dnsaddr").code;function FF(e){return jF.apply(this,arguments)}function jF(){return jF=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=h.length>1&&void 0!==h[1]?h[1]:{},i=new BF,null!=r.signal&&r.signal.addEventListener("abort",(function(){i.cancel()})),o=t.getPeerId(),a=null!==(n=t.stringTuples().find((function(e){return(0,k.Z)(e,1)[0]===MF})))&&void 0!==n?n:[],u=(0,k.Z)(a,2),null!=(c=u[1])){e.next=7;break}throw new Error("No hostname found in multiaddr");case 7:return e.next=9,i.resolveTxt("_dnsaddr.".concat(c));case 9:return l=e.sent,f=l.flat().map((function(e){return e.split("=")[1]})).filter(Boolean),null!=o&&(f=f.filter((function(e){return e.includes(o)}))),e.abrupt("return",f);case 13:case"end":return e.stop()}}),e)}))),jF.apply(this,arguments)}!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.DHT_DISABLED="DHT is not available",e.PUBSUB_DISABLED="PubSub is not available",e.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",e.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(LF||(LF={})),function(e){e.DHT_DISABLED="ERR_DHT_DISABLED",e.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",e.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",e.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",e.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",e.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",e.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",e.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",e.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",e.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",e.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",e.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",e.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",e.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",e.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",e.ERR_DIALED_SELF="ERR_DIALED_SELF",e.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",e.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",e.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",e.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",e.ERR_INVALID_KEY="ERR_INVALID_KEY",e.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_PEER="ERR_INVALID_PEER",e.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",e.ERR_NOT_FOUND="ERR_NOT_FOUND",e.ERR_TIMEOUT="ERR_TIMEOUT",e.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",e.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",e.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",e.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",e.ERR_FIND_SELF="ERR_FIND_SELF",e.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",e.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",e.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",e.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",e.ERR_INVALID_CMS="ERR_INVALID_CMS",e.ERR_MISSING_KEYS="ERR_MISSING_KEYS",e.ERR_NO_KEY="ERR_NO_KEY",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",e.ERR_INVALID_RECORD="ERR_INVALID_RECORD",e.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",e.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",e.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"}(NF||(NF={}));var UF={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:function(e){return e}},connectionManager:{resolvers:{dnsaddr:FF},addressSorter:EA},transportManager:{faultTolerance:sl.FATAL_ALL}};function zF(e){var t,n,r=(0,mk.Z)(UF,e);if(null==r.transports||r.transports.length<1)throw new ar.s(LF.ERR_TRANSPORTS_REQUIRED,NF.ERR_TRANSPORTS_REQUIRED);if(null===r.connectionProtector&&null!=(null===(t=globalThis.process)||void 0===t||null===(n=t.env)||void 0===n?void 0:n.LIBP2P_FORCE_PNET))throw new ar.s(LF.ERR_PROTECTOR_REQUIRED,NF.ERR_PROTECTOR_REQUIRED);return r}var HF=(0,ru.kg)("libp2p:get-peer");function VF(e){if((0,P_.I)(e))return{peerId:e,multiaddrs:[]};var t;if(Array.isArray(e)||(e=[e]),e.length>0){var n=e[0].getPeerId();t=null==n?void 0:(0,Ps.jE)(n),e.forEach((function(e){if(!wF(e))throw HF.error("multiaddr %s was invalid",e),new ar.s("Invalid Multiaddr",NF.ERR_INVALID_MULTIADDR);var n=e.getPeerId();if(null==n){if(null!=t)throw new ar.s("Multiaddrs must all have the same peer id or have no peer id",NF.ERR_INVALID_PARAMETERS)}else{var r=(0,Ps.jE)(n);if(null==t||!t.equals(r))throw new ar.s("Multiaddrs must all have the same peer id or have no peer id",NF.ERR_INVALID_PARAMETERS)}}))}return{peerId:t,multiaddrs:e}}var GF=(0,ru.kg)("libp2p:connection-manager:auto-dial"),KF=50,WF=25,qF=0,YF=5e3,QF=function(){function e(t,n){var r,i,o,a,s=this;(0,K.Z)(this,e),(0,ot.Z)(this,"connectionManager",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"queue",void 0),(0,ot.Z)(this,"minConnections",void 0),(0,ot.Z)(this,"autoDialPriority",void 0),(0,ot.Z)(this,"autoDialIntervalMs",void 0),(0,ot.Z)(this,"autoDialInterval",void 0),(0,ot.Z)(this,"started",void 0),this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.minConnections=null!==(r=n.minConnections)&&void 0!==r?r:KF,this.autoDialPriority=null!==(i=n.autoDialPriority)&&void 0!==i?i:qF,this.autoDialIntervalMs=null!==(o=n.autoDialInterval)&&void 0!==o?o:YF,this.started=!1,this.queue=new uc.Z({concurrency:null!==(a=n.autoDialConcurrency)&&void 0!==a?a:WF}),this.queue.addListener("error",(function(e){GF.error("error during auto-dial",e)})),t.events.addEventListener("connection:close",(function(){s.autoDial().catch((function(e){GF.error(e)}))}))}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=this;this.autoDialInterval=setInterval((function(){e.autoDial().catch((function(e){GF.error("error while autodialing",e)}))}),this.autoDialIntervalMs),this.started=!0}},{key:"afterStart",value:function(){this.autoDial().catch((function(e){GF.error("error while autodialing",e)}))}},{key:"stop",value:function(){this.queue.clear(),clearInterval(this.autoDialInterval),this.started=!1}},{key:"autoDial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,c,l,f,h,p,d,v,y,g=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started){e.next=2;break}return e.abrupt("return");case 2:if(t=this.connectionManager.getConnectionsMap(),n=t.size,r=new Xk(this.connectionManager.getDialQueue().map((function(e){return e.peerId})).filter(Boolean)),!(n>=this.minConnections)){e.next=8;break}return GF.trace("have enough connections %d/%d",n,this.minConnections),e.abrupt("return");case 8:return GF("not enough connections %d/%d - will dial peers to increase the number of connections",n,this.minConnections),e.next=11,this.peerStore.all();case 11:i=e.sent,o=i.filter((function(e){return 0!==e.addresses.length&&(!t.has(e.id)&&!r.has(e.id))})),a=o.sort((function(){return Math.random()>.5?1:-1})),c=new Qk,l=(0,Ae.Z)(a),e.prev=16,l.s();case 18:if((f=l.n()).done){e.next=25;break}if(h=f.value,!c.has(h.id)){e.next=22;break}return e.abrupt("continue",23);case 22:c.set(h.id,(0,ye.Z)(h.tags.values()).reduce((function(e,t){return e+t.value}),0));case 23:e.next=18;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(16),l.e(e.t0);case 30:return e.prev=30,l.f(),e.finish(30);case 33:p=a.sort((function(e,t){var n,r,i=null!==(n=c.get(e.id))&&void 0!==n?n:0,o=null!==(r=c.get(t.id))&&void 0!==r?r:0;return i>o?-1:i<o?1:0})),GF("selected %d/%d peers to dial",p.length,i.length),d=(0,Ae.Z)(p),e.prev=36,y=(0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=v.value,g.queue.add((0,u.Z)((0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((n=g.connectionManager.getConnectionsMap().size)>=g.minConnections)){e.next=5;break}return GF("got enough connections now %d/%d",n,g.minConnections),g.queue.clear(),e.abrupt("return");case 5:return GF("connecting to a peerStore stored peer %p",t.id),e.next=8,g.connectionManager.openConnection(t.id,{priority:g.autoDialPriority});case 8:case"end":return e.stop()}}),e)})))).catch((function(e){GF.error("could not connect to peerStore stored peer",e)}));case 2:case"end":return e.stop()}}),e)})),d.s();case 39:if((v=d.n()).done){e.next=43;break}return e.delegateYield(y(),"t1",41);case 41:e.next=39;break;case 43:e.next=48;break;case 45:e.prev=45,e.t2=e.catch(36),d.e(e.t2);case 48:return e.prev=48,d.f(),e.finish(48);case 51:case"end":return e.stop()}}),e,this,[[16,27,30,33],[36,45,48,51]])})));return function(){return e.apply(this,arguments)}}()}]),e}(),XF=(0,ru.kg)("libp2p:connection-manager:connection-pruner"),$F={maxConnections:300,allow:[]},JF=function(){function e(t){var n,r,i=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"maxConnections",void 0),(0,ot.Z)(this,"connectionManager",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"allow",void 0),(0,ot.Z)(this,"events",void 0),this.maxConnections=null!==(n=o.maxConnections)&&void 0!==n?n:$F.maxConnections,this.allow=null!==(r=o.allow)&&void 0!==r?r:$F.allow,this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,t.events.addEventListener("connection:open",(function(){i.maybePruneConnections().catch((function(e){XF.error(e)}))}))}return(0,W.Z)(e,[{key:"maybePruneConnections",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,c,l,f,h,p,d,v,y,g=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.connectionManager.getConnections(),n=t.length,r=Math.max(n-this.maxConnections,0),XF("checking max connections limit %d/%d",n,this.maxConnections),!(n<=this.maxConnections)){e.next=6;break}return e.abrupt("return");case 6:XF("max connections limit exceeded %d/%d, pruning %d connection(s)",n,this.maxConnections,r),i=new Qk,o=(0,Ae.Z)(t),e.prev=9,o.s();case 11:if((a=o.n()).done){e.next=29;break}if(c=a.value,l=c.remotePeer,!i.has(l)){e.next=16;break}return e.abrupt("continue",27);case 16:return i.set(l,0),e.prev=17,e.next=20,this.peerStore.get(l);case 20:f=e.sent,i.set(l,(0,ye.Z)(f.tags.values()).reduce((function(e,t){return e+t.value}),0)),e.next=27;break;case 24:e.prev=24,e.t0=e.catch(17),"ERR_NOT_FOUND"!==e.t0.code&&XF.error("error loading peer tags",e.t0);case 27:e.next=11;break;case 29:e.next=34;break;case 31:e.prev=31,e.t1=e.catch(9),o.e(e.t1);case 34:return e.prev=34,o.f(),e.finish(34);case 37:h=t.sort((function(e,t){var n,r,o=null!==(n=i.get(e.remotePeer))&&void 0!==n?n:0,a=null!==(r=i.get(t.remotePeer))&&void 0!==r?r:0;if(o>a)return 1;if(o<a)return-1;var s=e.stat.timeline.open,u=t.stat.timeline.open;return s<u?1:s>u?-1:0})),p=[],d=(0,Ae.Z)(h),e.prev=40,y=(0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=v.value,XF("too many connections open - closing a connection to %p",t.remotePeer),g.allow.some((function(e){return t.remoteAddr.toString().startsWith(e.toString())}))||p.push(t),p.length!==r){e.next=6;break}return e.abrupt("return","break");case 6:case"end":return e.stop()}}),e)})),d.s();case 43:if((v=d.n()).done){e.next=50;break}return e.delegateYield(y(),"t2",45);case 45:if("break"!==e.t2){e.next=48;break}return e.abrupt("break",50);case 48:e.next=43;break;case 50:e.next=55;break;case 52:e.prev=52,e.t3=e.catch(40),d.e(e.t3);case 55:return e.prev=55,d.f(),e.finish(55);case 58:return e.next=60,Promise.all(p.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.close();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),XF.error(e.t0);case 8:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()));case 60:this.events.safeDispatchEvent("connection:prune",{detail:p});case 61:case"end":return e.stop()}}),e,this,[[9,31,34,37],[17,24],[40,52,55,58]])})));return function(){return e.apply(this,arguments)}}()}]),e}();function ej(e){var t=new globalThis.AbortController;function n(){t.abort();var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;null!=(null===o||void 0===o?void 0:o.removeEventListener)&&o.removeEventListener("abort",n)}}catch(a){i.e(a)}finally{i.f()}}var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;if(!0===(null===o||void 0===o?void 0:o.aborted)){n();break}null!=(null===o||void 0===o?void 0:o.addEventListener)&&o.addEventListener("abort",n)}}catch(s){i.e(s)}finally{i.f()}var a=t.signal;return a.clear=function(){var t,r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;null!=(null===i||void 0===i?void 0:i.removeEventListener)&&i.removeEventListener("abort",n)}}catch(s){r.e(s)}finally{r.f()}},a}var tj=(0,ru.kg)("libp2p:connection-manager:utils");function nj(e,t){return rj.apply(this,arguments)}function rj(){return rj=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.protoNames().includes("dnsaddr")){e.next=3;break}return e.abrupt("return",[t]);case 3:return e.next=5,ij(t,n);case 5:return r=e.sent,e.next=8,Promise.all(r.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",nj(t,n));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:return i=e.sent,o=i.flat(),a=o.reduce((function(e,t){return null==e.find((function(e){return e.equals(t)}))&&e.push(t),e}),[]),tj("resolved %s to",t,a.map((function(e){return e.toString()}))),e.abrupt("return",a);case 13:case"end":return e.stop()}}),e)}))),rj.apply(this,arguments)}function ij(e,t){return oj.apply(this,arguments)}function oj(){return(oj=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=AF(t.toString()),e.next=4,t.resolve(n);case 4:return r=e.sent,e.abrupt("return",r);case 8:return e.prev=8,e.t0=e.catch(0),tj.error("multiaddr ".concat(t.toString()," could not be resolved"),e.t0),e.abrupt("return",[]);case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))).apply(this,arguments)}function aj(){for(var e=[],t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var i=0,o=n;i<o.length;i++){var a=o[i];if(null!=a){try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,a)}catch(u){}e.push(a)}}var s=ej(e);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,s)}catch(c){}return s}var sj=(0,ru.kg)("libp2p:connection-manager:dial-queue"),uj={addressSorter:EA,maxParallelDials:100,maxPeerAddrsToDial:25,maxParallelDialsPerPeer:10,dialTimeout:3e4,resolvers:{dnsaddr:FF}},cj=function(){function e(t){var n,r,i,o,a,s,u,c=this,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"pendingDials",void 0),(0,ot.Z)(this,"queue",void 0),(0,ot.Z)(this,"peerId",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"connectionGater",void 0),(0,ot.Z)(this,"transportManager",void 0),(0,ot.Z)(this,"addressSorter",void 0),(0,ot.Z)(this,"maxPeerAddrsToDial",void 0),(0,ot.Z)(this,"maxParallelDialsPerPeer",void 0),(0,ot.Z)(this,"dialTimeout",void 0),(0,ot.Z)(this,"inProgressDialCount",void 0),(0,ot.Z)(this,"pendingDialCount",void 0),(0,ot.Z)(this,"shutDownController",void 0),this.addressSorter=null!==(n=l.addressSorter)&&void 0!==n?n:uj.addressSorter,this.maxPeerAddrsToDial=null!==(r=l.maxPeerAddrsToDial)&&void 0!==r?r:uj.maxPeerAddrsToDial,this.maxParallelDialsPerPeer=null!==(i=l.maxParallelDialsPerPeer)&&void 0!==i?i:uj.maxParallelDialsPerPeer,this.dialTimeout=null!==(o=l.dialTimeout)&&void 0!==o?o:uj.dialTimeout,this.peerId=t.peerId,this.peerStore=t.peerStore,this.connectionGater=t.connectionGater,this.transportManager=t.transportManager,this.shutDownController=new AbortController;try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,this.shutDownController.signal)}catch(g){}this.pendingDialCount=null===(a=t.metrics)||void 0===a?void 0:a.registerMetric("libp2p_dialler_pending_dials"),this.inProgressDialCount=null===(s=t.metrics)||void 0===s?void 0:s.registerMetric("libp2p_dialler_in_progress_dials"),this.pendingDials=[];for(var f=0,h=Object.entries(null!==(p=l.resolvers)&&void 0!==p?p:{});f<h.length;f++){var p,d=(0,k.Z)(h[f],2),v=d[0],y=d[1];mF.set(v,y)}this.queue=new uc.Z({concurrency:null!==(u=l.maxParallelDials)&&void 0!==u?u:uj.maxParallelDials}),this.queue.on("add",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)})),this.queue.on("active",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)})),this.queue.on("completed",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)})),this.queue.on("error",(function(e){var t,n;sj.error("error in dial queue",e),null===(t=c.pendingDialCount)||void 0===t||t.update(c.queue.size),null===(n=c.inProgressDialCount)||void 0===n||n.update(c.queue.pending)})),this.queue.on("empty",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)})),this.queue.on("idle",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)}))}return(0,W.Z)(e,[{key:"stop",value:function(){this.shutDownController.abort()}},{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h=this,p=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=p.length>1&&void 0!==p[1]?p[1]:{},r=VF(t),i=r.peerId,o=r.multiaddrs,a=o.map((function(e){return{multiaddr:e,isCertified:!1}})),u=this.createDialAbortControllers(n.signal),e.prev=4,e.next=7,this.calculateMultiaddrs(i,a,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:u}));case 7:c=e.sent,e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(4),u.clear(),e.t0;case 14:if(l=this.pendingDials.find((function(e){return!(null==e.peerId||null==i||!e.peerId.equals(i))||c.map((function(e){return e.multiaddr.toString()})).join()===e.multiaddrs.map((function(e){return e.toString()})).join()})),null==l){e.next=19;break}return sj("joining existing dial target for %p",i),u.clear(),e.abrupt("return",l.promise);case 19:return sj("creating dial target for",c.map((function(e){return e.multiaddr.toString()}))),(f={id:"".concat(parseInt(String(1e9*Math.random()),10).toString()).concat(Date.now()),status:"queued",peerId:i,multiaddrs:c.map((function(e){return e.multiaddr}))}).promise=this.performDial(f,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:u})).finally((function(){h.pendingDials=h.pendingDials.filter((function(e){return e.id!==f.id})),u.clear()})).catch((function(e){if(sj.error("dial failed to %s",f.multiaddrs.map((function(e){return e.toString()})).join(", "),e),u.aborted)throw new ar.s(e.message,NF.ERR_TIMEOUT);throw e})),this.pendingDials.push(f),e.abrupt("return",f.promise);case 24:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"createDialAbortControllers",value:function(e){var t=ej([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,t)}catch(n){}return t}},{key:"calculateMultiaddrs",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c,l,f,h,p,d,v,y,g,m,b,w,k,E,x,_=this,S=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=S.length>1&&void 0!==S[1]?S[1]:[],r=S.length>2&&void 0!==S[2]?S[2]:{},null==t){e.next=24;break}if(!this.peerId.equals(t)){e.next=5;break}throw new ar.s("Tried to dial self",NF.ERR_DIALED_SELF);case 5:return e.next=7,null===(i=(o=this.connectionGater).denyDialPeer)||void 0===i?void 0:i.call(o,t);case 7:if(e.t0=e.sent,!0!==e.t0){e.next=10;break}throw new ar.s("The dial request is blocked by gater.allowDialPeer",NF.ERR_PEER_DIAL_INTERCEPTED);case 10:if(0!==n.length){e.next=24;break}return sj("loading multiaddrs for %p",t),e.prev=12,e.next=15,this.peerStore.get(t);case 15:a=e.sent,n.push.apply(n,(0,ye.Z)(a.addresses)),sj("loaded multiaddrs for %p",t,n.map((function(e){return e.multiaddr.toString()}))),e.next=24;break;case 20:if(e.prev=20,e.t1=e.catch(12),e.t1.code===NF.ERR_NOT_FOUND){e.next=24;break}throw e.t1;case 24:return e.next=26,Promise.all(n.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,nj(t.multiaddr,r);case 2:if(1!==(n=e.sent).length||!n[0].equals(t.multiaddr)){e.next=5;break}return e.abrupt("return",t);case 5:return e.abrupt("return",n.map((function(e){return{multiaddr:e,isCertified:!1}})));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 26:c=e.sent.flat(),l=c.filter((function(e){return Boolean(_.transportManager.transportForMultiaddr(e.multiaddr))})),f=new Map,h=(0,Ae.Z)(l),e.prev=30,h.s();case 32:if((p=h.n()).done){e.next=42;break}if(d=p.value,v=d.multiaddr.toString(),null==(y=f.get(v))){e.next=39;break}return y.isCertified=y.isCertified||d.isCertified||!1,e.abrupt("continue",40);case 39:f.set(v,d);case 40:e.next=32;break;case 42:e.next=47;break;case 44:e.prev=44,e.t2=e.catch(30),h.e(e.t2);case 47:return e.prev=47,h.f(),e.finish(47);case 50:if((0===(g=(0,ye.Z)(f.values())).length||g.length>this.maxPeerAddrsToDial)&&(sj("addresses for %p before filtering",null!==t&&void 0!==t?t:"unknown peer",c.map((function(e){return e.multiaddr.toString()}))),sj("addresses for %p after filtering",null!==t&&void 0!==t?t:"unknown peer",g.map((function(e){return e.multiaddr.toString()})))),0!==g.length){e.next=54;break}throw new ar.s("The dial request has no valid addresses",NF.ERR_NO_VALID_ADDRESSES);case 54:if(!(g.length>this.maxPeerAddrsToDial)){e.next=56;break}throw new ar.s("dial with more addresses than allowed",NF.ERR_TOO_MANY_ADDRESSES);case 56:null!=t&&(m="/p2p/".concat(t.toString()),g=g.map((function(e){var n=e.multiaddr.getPeerId(),r=e.multiaddr.protos().pop();return!0===(null===r||void 0===r?void 0:r.path)?e:n!==t.toString()?{multiaddr:e.multiaddr.encapsulate(m),isCertified:e.isCertified}:e}))),b=[],w=(0,Ae.Z)(g),e.prev=59,w.s();case 61:if((k=w.n()).done){e.next=73;break}if(E=k.value,e.t3=null!=this.connectionGater.denyDialMultiaddr,!e.t3){e.next=68;break}return e.next=67,this.connectionGater.denyDialMultiaddr(E.multiaddr);case 67:e.t3=e.sent;case 68:if(!e.t3){e.next=70;break}return e.abrupt("continue",71);case 70:b.push(E);case 71:e.next=61;break;case 73:e.next=78;break;case 75:e.prev=75,e.t4=e.catch(59),w.e(e.t4);case 78:return e.prev=78,w.f(),e.finish(78);case 81:if(0!==(x=b.sort(this.addressSorter)).length){e.next=84;break}throw new ar.s("The connection gater denied all addresses in the dial request",NF.ERR_NO_VALID_ADDRESSES);case 84:return e.abrupt("return",x);case 85:case"end":return e.stop()}}),e,this,[[12,20],[30,44,47,50],[59,75,78,81]])})));return function(t){return e.apply(this,arguments)}}()},{key:"performDial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a=this,c=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>1&&void 0!==c[1]?c[1]:{},r=t.multiaddrs.map((function(){return new AbortController})),e.prev=2,(i=new uc.Z({concurrency:this.maxParallelDialsPerPeer})).on("error",(function(e){sj.error("error dialling",e)})),e.next=7,Promise.any(t.multiaddrs.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(o,c){var l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(l=r[c])){e.next=3;break}throw new ar.s("dialAction did not come with an AbortController",NF.ERR_INVALID_PARAMETERS);case 3:return(f=aj(l.signal,n.signal)).addEventListener("abort",(function(){sj("dial to %s aborted",o)})),h=Ut(),e.next=8,i.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!f.aborted){e.next=4;break}return sj("dial to %s was aborted before reaching the head of the peer dial queue",o),h.reject(new ar._),e.abrupt("return");case 4:return e.next=6,a.queue.add((0,u.Z)((0,s.Z)().mark((function e(){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!f.aborted){e.next=5;break}return sj("dial to %s was aborted before reaching the head of the dial queue",o),h.reject(new ar._),e.abrupt("return");case 5:return t.status="active",e.next=8,a.transportManager.dial(o,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:f}));case 8:if(i=e.sent,!l.signal.aborted){e.next=14;break}return sj("multiple dials succeeded, closing superfluous connection"),i.close().catch((function(e){sj.error("error closing superfluous connection",e)})),h.reject(new ar._),e.abrupt("return");case 14:r[c]=void 0,r.forEach((function(e){void 0!==e&&e.abort()})),sj("dial to %s succeeded",o),h.resolve(i),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(0),sj.error("error during dial of %s",o,e.t0),h.reject(e.t0);case 24:case"end":return e.stop()}}),e,null,[[0,20]])}))),(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:f})).catch((function(e){h.reject(e)}));case 6:case"end":return e.stop()}}),e)}))),{signal:f}).catch((function(e){h.reject(e)})).finally((function(){f.clear()}));case 8:return e.abrupt("return",h.promise);case 9:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()));case 7:if(null!=(o=e.sent)){e.next=10;break}throw new ar.s("successful dial led to empty object returned from peer dial queue",NF.ERR_TRANSPORT_DIAL_FAILED);case 10:return t.status="success",e.abrupt("return",o);case 14:if(e.prev=14,e.t0=e.catch(2),t.status="error",1!==t.multiaddrs.length||"AggregateError"!==e.t0.name){e.next=19;break}throw e.t0.errors[0];case 19:throw e.t0;case 20:case"end":return e.stop()}}),e,this,[[2,14]])})));return function(t){return e.apply(this,arguments)}}()}]),e}();var lj=(0,ru.kg)("libp2p:connection-manager"),fj=50,hj=300,pj=5,dj=10,vj=25,yj=0,gj=function(){function e(t){var n,r,i,o,a,s,u,c,l,f,h,p,d,v=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"started",void 0),(0,ot.Z)(this,"connections",void 0),(0,ot.Z)(this,"allow",void 0),(0,ot.Z)(this,"deny",void 0),(0,ot.Z)(this,"maxIncomingPendingConnections",void 0),(0,ot.Z)(this,"incomingPendingConnections",void 0),(0,ot.Z)(this,"maxConnections",void 0),(0,ot.Z)(this,"dialQueue",void 0),(0,ot.Z)(this,"autoDial",void 0),(0,ot.Z)(this,"connectionPruner",void 0),(0,ot.Z)(this,"inboundConnectionRateLimiter",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"metrics",void 0),(0,ot.Z)(this,"events",void 0),this.maxConnections=null!==(n=v.maxConnections)&&void 0!==n?n:hj;var y=null!==(r=v.minConnections)&&void 0!==r?r:fj;if(this.maxConnections<y)throw new ar.s("Connection Manager maxConnections must be greater than minConnections",NF.ERR_INVALID_PARAMETERS);this.connections=new Qk,this.started=!1,this.peerStore=t.peerStore,this.metrics=t.metrics,this.events=t.events,this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(null!==(i=v.allow)&&void 0!==i?i:[]).map((function(e){return AF(e)})),this.deny=(null!==(o=v.deny)&&void 0!==o?o:[]).map((function(e){return AF(e)})),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=null!==(a=v.maxIncomingPendingConnections)&&void 0!==a?a:dj,this.inboundConnectionRateLimiter=new xc.RateLimiterMemory({points:null!==(s=v.inboundConnectionThreshold)&&void 0!==s?s:pj,duration:1}),this.autoDial=new QF({connectionManager:this,peerStore:t.peerStore,events:t.events},{minConnections:y,autoDialConcurrency:null!==(u=v.autoDialConcurrency)&&void 0!==u?u:vj,autoDialPriority:null!==(c=v.autoDialPriority)&&void 0!==c?c:yj}),this.connectionPruner=new JF({connectionManager:this,peerStore:t.peerStore,events:t.events},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new cj({peerId:t.peerId,metrics:t.metrics,peerStore:t.peerStore,transportManager:t.transportManager,connectionGater:t.connectionGater},{addressSorter:null!==(l=v.addressSorter)&&void 0!==l?l:EA,maxParallelDials:null!==(f=v.maxParallelDials)&&void 0!==f?f:100,maxPeerAddrsToDial:null!==(h=v.maxPeerAddrsToDial)&&void 0!==h?h:25,dialTimeout:null!==(p=v.dialTimeout)&&void 0!==p?p:3e4,resolvers:null!==(d=v.resolvers)&&void 0!==d?d:{dnsaddr:FF}})}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===(t=this.metrics)||void 0===t||t.registerMetricGroup("libp2p_connection_manager_connections",{calculate:function(){var e,t={inbound:0,outbound:0},n=(0,Ae.Z)(i.connections.values());try{for(n.s();!(e=n.n()).done;){var r,o=e.value,a=(0,Ae.Z)(o);try{for(a.s();!(r=a.n()).done;){"inbound"===r.value.stat.direction?t.inbound++:t.outbound++}}catch(s){a.e(s)}finally{a.f()}}}catch(s){n.e(s)}finally{n.f()}return t}}),null===(n=this.metrics)||void 0===n||n.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:function(){var e,t={},n=(0,Ae.Z)(i.connections.values());try{for(n.s();!(e=n.n()).done;){var r,o=e.value,a=(0,Ae.Z)(o);try{for(a.s();!(r=a.n()).done;){var s,u=r.value,c=(0,Ae.Z)(u.streams);try{for(c.s();!(s=c.n()).done;){var l,f,h=s.value,p="".concat(h.stat.direction," ").concat(null!==(l=h.stat.protocol)&&void 0!==l?l:"unnegotiated");t[p]=(null!==(f=t[p])&&void 0!==f?f:0)+1}}catch(d){c.e(d)}finally{c.f()}}}catch(d){a.e(d)}finally{a.f()}}}catch(d){n.e(d)}finally{n.f()}return t}}),null===(r=this.metrics)||void 0===r||r.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:function(){var e,t={},n=(0,Ae.Z)(i.connections.values());try{for(n.s();!(e=n.n()).done;){var r,o=e.value,a=(0,Ae.Z)(o);try{for(a.s();!(r=a.n()).done;){var s,u=r.value,c={},l=(0,Ae.Z)(u.streams);try{for(l.s();!(s=l.n()).done;){var f,h,p=s.value,d="".concat(p.stat.direction," ").concat(null!==(f=p.stat.protocol)&&void 0!==f?f:"unnegotiated");c[d]=(null!==(h=c[d])&&void 0!==h?h:0)+1}}catch(C){l.e(C)}finally{l.f()}for(var v=0,y=Object.entries(c);v<y.length;v++){var g,m=(0,k.Z)(y[v],2),b=m[0],w=m[1];t[b]=null!==(g=t[b])&&void 0!==g?g:[],t[b].push(w)}}}catch(C){a.e(C)}finally{a.f()}}}catch(C){n.e(C)}finally{n.f()}for(var E={},x=0,_=Object.entries(t);x<_.length;x++){var S=(0,k.Z)(_[x],2),A=S[0],Z=S[1];Z=Z.sort((function(e,t){return e-t}));var T=Math.floor(.9*Z.length);E[A]=Z[T]}return E}}),this.autoDial.start(),this.started=!0,lj("started");case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"afterStart",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){var n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],e.t0=Ae.Z,e.next=4,t.peerStore.all();case 4:e.t1=e.sent,r=(0,e.t0)(e.t1);try{for(r.s();!(i=r.n()).done;)(o=i.value).tags.has(VA)&&n.push(o.id)}catch(a){r.e(a)}finally{r.f()}return e.next=9,Promise.all(n.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.openConnection(n).catch((function(e){lj.error(e)}));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 9:case"end":return e.stop()}}),e)})))).catch((function(e){lj.error(e)})),this.autoDial.afterStart();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.dialQueue.stop(),this.autoDial.stop(),t=[],n=(0,Ae.Z)(this.connections.values()),e.prev=4,n.s();case 6:if((r=n.n()).done){e.next=26;break}i=r.value,o=(0,Ae.Z)(i),e.prev=9,c=(0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=a.value,t.push((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.close();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),lj.error(e.t0);case 8:case"end":return e.stop()}}),e,null,[[0,5]])})))());case 2:case"end":return e.stop()}}),e)})),o.s();case 12:if((a=o.n()).done){e.next=16;break}return e.delegateYield(c(),"t0",14);case 14:e.next=12;break;case 16:e.next=21;break;case 18:e.prev=18,e.t1=e.catch(9),o.e(e.t1);case 21:return e.prev=21,o.f(),e.finish(21);case 24:e.next=6;break;case 26:e.next=31;break;case 28:e.prev=28,e.t2=e.catch(4),n.e(e.t2);case 31:return e.prev=31,n.f(),e.finish(31);case 34:return lj("closing %d connections",t.length),e.next=37,Promise.all(t);case 37:this.connections.clear(),lj("stopped");case 39:case"end":return e.stop()}}),e,this,[[4,28,31,34],[9,18,21,24]])})));return function(){return e.apply(this,arguments)}}()},{key:"onConnect",value:function(e){this._onConnect(e).catch((function(e){lj.error(e)}))}},{key:"_onConnect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.detail,this.started){e.next=5;break}return e.next=4,n.close();case 4:return e.abrupt("return");case 5:if(r=n.remotePeer,i=this.connections.get(r),o=!1,null!=i?i.push(n):(o=!0,this.connections.set(r,[n])),null==r.publicKey||"RSA"!==r.type){e.next=12;break}return e.next=12,this.peerStore.patch(r,{publicKey:r.publicKey});case 12:o&&this.events.safeDispatchEvent("peer:connect",{detail:n.remotePeer});case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"onDisconnect",value:function(e){var t=e.detail;if(this.started){var n=t.remotePeer,r=this.connections.get(n);null!=r&&r.length>1?(r=r.filter((function(e){return e.id!==t.id})),this.connections.set(n,r)):null!=r&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}}},{key:"getConnections",value:function(e){var t;if(null!=e)return null!==(t=this.connections.get(e))&&void 0!==t?t:[];var n,r=[],i=(0,Ae.Z)(this.connections.values());try{for(i.s();!(n=i.n()).done;){var o=n.value;r=r.concat(o)}}catch(a){i.e(a)}finally{i.f()}return r}},{key:"getConnectionsMap",value:function(){return this.connections}},{key:"openConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=p.length>1&&void 0!==p[1]?p[1]:{},this.isStarted()){e.next=3;break}throw new ar.s("Not started",NF.ERR_NODE_NOT_STARTED);case 3:if(i=VF(t),null==(o=i.peerId)){e.next=10;break}if(lj("dial %p",o),!((a=this.getConnections(o)).length>0)){e.next=10;break}return lj("had an existing connection to %p",o),e.abrupt("return",a[0]);case 10:return e.next=12,this.dialQueue.dial(t,(0,Nt.Z)((0,Nt.Z)({},r),{},{priority:null!==(n=r.priority)&&void 0!==n?n:50}));case 12:u=e.sent,null==(c=this.connections.get(u.remotePeer))&&(c=[],this.connections.set(u.remotePeer,c)),l=!1,f=(0,Ae.Z)(c);try{for(f.s();!(h=f.n()).done;)h.value.id===u.id&&(l=!0)}catch(s){f.e(s)}finally{f.f()}return l||c.push(u),e.abrupt("return",u);case 20:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"closeConnections",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=null!==(n=this.connections.get(t))&&void 0!==n?n:[],e.next=3,Promise.all(r.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.close();case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"acceptIncomingConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.deny.some((function(e){return t.remoteAddr.toString().startsWith(e.toString())}))){e.next=4;break}return lj("connection from %s refused - connection remote address was in deny list",t.remoteAddr),e.abrupt("return",!1);case 4:if(!this.allow.some((function(e){return t.remoteAddr.toString().startsWith(e.toString())}))){e.next=8;break}return this.incomingPendingConnections++,e.abrupt("return",!0);case 8:if(this.incomingPendingConnections!==this.maxIncomingPendingConnections){e.next=11;break}return lj("connection from %s refused - incomingPendingConnections exceeded by peer %s",t.remoteAddr),e.abrupt("return",!1);case 11:if(!t.remoteAddr.isThinWaistAddress()){e.next=22;break}return n=t.remoteAddr.nodeAddress().address,e.prev=13,e.next=16,this.inboundConnectionRateLimiter.consume(n,1);case 16:e.next=22;break;case 18:return e.prev=18,e.t0=e.catch(13),lj("connection from %s refused - inboundConnectionThreshold exceeded by host %s",n,t.remoteAddr),e.abrupt("return",!1);case 22:if(!(this.getConnections().length<this.maxConnections)){e.next=25;break}return this.incomingPendingConnections++,e.abrupt("return",!0);case 25:return lj("connection from %s refused - maxConnections exceeded",t.remoteAddr),e.abrupt("return",!1);case 27:case"end":return e.stop()}}),e,this,[[13,18]])})));return function(t){return e.apply(this,arguments)}}()},{key:"afterUpgradeInbound",value:function(){this.incomingPendingConnections--}},{key:"getDialQueue",value:function(){return this.dialQueue.pendingDials}}]),e}();function mj(e,t){return bj.apply(this,arguments)}function bj(){return bj=(0,g.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(Em(t,function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.merge(t.id,{multiaddrs:t.multiaddrs});case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())),m.Z),"t0",1);case 1:case"end":return e.stop()}}),e)}))),bj.apply(this,arguments)}function wj(e){var t=new Set;return ym(e,(function(e){return!t.has(e.id.toString())&&(t.add(e.id.toString()),!0)}))}function kj(e){return Ej.apply(this,arguments)}function Ej(){return Ej=(0,g.Z)((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return(0,s.Z)().mark((function n(){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=0,i=!1,o=!1,n.prev=3,u=(0,y.Z)(e);case 5:return n.next=7,(0,m.Z)(u.next());case 7:if(!(i=!(c=n.sent).done)){n.next=15;break}return l=c.value,r++,n.next=12,l;case 12:i=!1,n.next=5;break;case 15:n.next=21;break;case 17:n.prev=17,n.t0=n.catch(3),o=!0,a=n.t0;case 21:if(n.prev=21,n.prev=22,!i||null==u.return){n.next=26;break}return n.next=26,(0,m.Z)(u.return());case 26:if(n.prev=26,!o){n.next=29;break}throw a;case 29:return n.finish(26);case 30:return n.finish(21);case 31:if(!(r<t)){n.next=33;break}throw new ar.s("more peers required, seen: ".concat(r,"  min: ").concat(t),"NOT_FOUND");case 33:case"end":return n.stop()}}),n,null,[[3,17,21,31],[22,,26,30]])}))()})),Ej.apply(this,arguments)}var xj=function(){function e(t,n){var r;(0,K.Z)(this,e),(0,ot.Z)(this,"routers",void 0),(0,ot.Z)(this,"started",void 0),(0,ot.Z)(this,"components",void 0),this.routers=null!==(r=n.routers)&&void 0!==r?r:[],this.started=!1,this.components=t}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.started=!0;case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.started=!1;case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"findProviders",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(0!==t.routers.length){r.next=2;break}throw new ar.s("No content routers available",NF.ERR_NO_ROUTERS_AVAILABLE);case 2:return r.delegateYield((0,at.Z)((0,y.Z)(cn(un.apply(void 0,(0,ye.Z)(t.routers.map((function(t){return t.findProviders(e,n)})))),(function(e){return mj(e,t.components.peerStore)}),(function(e){return wj(e)}),(function(e){return kj(e)}))),m.Z),"t0",3);case 3:case"end":return r.stop()}}),r)})))()}},{key:"provide",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:{},0!==this.routers.length){e.next=3;break}throw new ar.s("No content routers available",NF.ERR_NO_ROUTERS_AVAILABLE);case 3:return e.next=5,Promise.all(this.routers.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.provide(t,n);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isStarted()){e.next=2;break}throw new ar.s(LF.NOT_STARTED_YET,NF.DHT_NOT_STARTED);case 2:return e.next=4,Promise.all(this.routers.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(i){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.put(t,n,r);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isStarted()){e.next=2;break}throw new ar.s(LF.NOT_STARTED_YET,NF.DHT_NOT_STARTED);case 2:return e.abrupt("return",Promise.any(this.routers.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.get(t,n));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())));case 3:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}();var _j,Sj=function(e){if(null!=e[Symbol.asyncIterator])return(0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,o.next();case 6:if(!(n=!(a=t.sent).done)){t.next=12;break}return u=a.value,t.abrupt("return",u);case 9:n=!1,t.next=4;break;case 12:t.next=18;break;case 14:t.prev=14,t.t0=t.catch(2),r=!0,i=t.t0;case 18:if(t.prev=18,t.prev=19,!n||null==o.return){t.next=23;break}return t.next=23,o.return();case 23:if(t.prev=23,!r){t.next=26;break}throw i;case 26:return t.finish(23);case 27:return t.finish(18);case 28:return t.abrupt("return",void 0);case 29:case"end":return t.stop()}}),t,null,[[2,14,18,28],[19,,23,27]])})))();var t,n=(0,Ae.Z)(e);try{for(n.s();!(t=n.n()).done;){return t.value}}catch(r){n.e(r)}finally{n.f()}},Aj=(0,ru.kg)("libp2p:peer-routing"),Zj=function(){function e(t,n){var r;(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"routers",void 0),this.components=t,this.routers=null!==(r=n.routers)&&void 0!==r?r:[]}return(0,W.Z)(e,[{key:"findPeer",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==this.routers.length){e.next=2;break}throw new ar.s("No peer routers available",NF.ERR_NO_ROUTERS_AVAILABLE);case 2:if(t.toString()!==this.components.peerId.toString()){e.next=4;break}throw new ar.s("Should not try to find self",NF.ERR_FIND_SELF);case 4:return e.next=6,cn(un.apply(void 0,(0,ye.Z)(this.routers.map((function(e){return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,(0,m.Z)(e.findPeer(t,n));case 3:return r.next=5,r.sent;case 5:r.next=10;break;case 7:r.prev=7,r.t0=r.catch(0),Aj.error(r.t0);case 10:case"end":return r.stop()}}),r,null,[[0,7]])})))()})))),(function(e){return ym(e,Boolean)}),(function(e){return mj(e,i.components.peerStore)}),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Sj(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:if(null==(r=e.sent)){e.next=9;break}return e.abrupt("return",r);case 9:throw new ar.s(LF.NOT_FOUND,NF.ERR_NOT_FOUND);case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getClosestPeers",value:function(e,t){var n=this;return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(0!==n.routers.length){r.next=2;break}throw new ar.s("No peer routers available",NF.ERR_NO_ROUTERS_AVAILABLE);case 2:return r.delegateYield((0,at.Z)((0,y.Z)(cn(un.apply(void 0,(0,ye.Z)(n.routers.map((function(n){return n.getClosestPeers(e,t)})))),(function(e){return mj(e,n.components.peerStore)}),(function(e){return wj(e)}),(function(e){return kj(e)}))),m.Z),"t0",3);case 3:case"end":return r.stop()}}),r)})))()}}]),e}(),Tj=(0,ru.kg)("libp2p:registrar"),Cj=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"topologies",void 0),(0,ot.Z)(this,"handlers",void 0),(0,ot.Z)(this,"components",void 0),this.topologies=new Map,this.handlers=new Map,this.components=t,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onConnect=this._onConnect.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:connect",this._onConnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate)}return(0,W.Z)(e,[{key:"getProtocols",value:function(){return Array.from(new Set((0,ye.Z)(this.handlers.keys()))).sort()}},{key:"getHandler",value:function(e){var t=this.handlers.get(e);if(null==t)throw new ar.s("No handler registered for protocol ".concat(e),NF.ERR_NO_HANDLER_FOR_PROTOCOL);return t}},{key:"getTopologies",value:function(e){var t=this.topologies.get(e);return null==t?[]:(0,ye.Z)(t.values())}},{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.handlers.has(t)){e.next=2;break}throw new ar.s("Handler already registered for protocol ".concat(t),NF.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);case 2:return i=mk.Z.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},r),this.handlers.set(t,{handler:n,options:i}),e.next=6,this.components.peerStore.merge(this.components.peerId,{protocols:[t]});case 6:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"unhandle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=Array.isArray(t)?t:[t]).forEach((function(e){r.handlers.delete(e)})),e.next=4,this.components.peerStore.patch(this.components.peerId,{protocols:n});case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Pb(n)){e.next=3;break}throw Tj.error("topology must be an instance of interfaces/topology"),new ar.s("topology must be an instance of interfaces/topology",NF.ERR_INVALID_PARAMETERS);case 3:return r="".concat((1e9*Math.random()).toString(36)).concat(Date.now()),null==(i=this.topologies.get(t))&&(i=new Map,this.topologies.set(t,i)),i.set(r,n),e.next=9,n.setRegistrar(this);case 9:return e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"unregister",value:function(e){var t,n=(0,Ae.Z)(this.topologies.entries());try{for(n.s();!(t=n.n()).done;){var r=(0,k.Z)(t.value,2),i=r[0],o=r[1];o.has(e)&&(o.delete(e),0===o.size&&this.topologies.delete(i))}}catch(a){n.e(a)}finally{n.f()}}},{key:"_onDisconnect",value:function(e){var t=this,n=e.detail;this.components.peerStore.get(n).then((function(e){var r,i=(0,Ae.Z)(e.protocols);try{for(i.s();!(r=i.n()).done;){var o=r.value,a=t.topologies.get(o);if(null!=a){var s,u=(0,Ae.Z)(a.values());try{for(u.s();!(s=u.n()).done;){s.value.onDisconnect(n)}}catch(c){u.e(c)}finally{u.f()}}}}catch(c){i.e(c)}finally{i.f()}})).catch((function(e){e.code!==NF.ERR_NOT_FOUND&&Tj.error("could not inform topologies of disconnecting peer %p",n,e)}))}},{key:"_onConnect",value:function(e){var t=this,n=e.detail;this.components.peerStore.get(n).then((function(e){var r=t.components.connectionManager.getConnections(e.id)[0];if(null!=r){var i,o=(0,Ae.Z)(e.protocols);try{for(o.s();!(i=o.n()).done;){var a=i.value,s=t.topologies.get(a);if(null!=s){var u,c=(0,Ae.Z)(s.values());try{for(c.s();!(u=c.n()).done;){u.value.onConnect(n,r)}}catch(l){c.e(l)}finally{c.f()}}}}catch(l){o.e(l)}finally{o.f()}}else Tj("peer %p connected but the connection manager did not have a connection",e)})).catch((function(e){e.code!==NF.ERR_NOT_FOUND&&Tj.error("could not inform topologies of connecting peer %p",n,e)}))}},{key:"_onPeerUpdate",value:function(e){var t,n,r=e.detail,i=r.peer,o=r.previous,a=(null!==(t=null===o||void 0===o?void 0:o.protocols)&&void 0!==t?t:[]).filter((function(e){return!i.protocols.includes(e)})),s=i.protocols.filter((function(e){var t;return!(null!==(t=null===o||void 0===o?void 0:o.protocols)&&void 0!==t?t:[]).includes(e)})),u=(0,Ae.Z)(a);try{for(u.s();!(n=u.n()).done;){var c=n.value,l=this.topologies.get(c);if(null!=l){var f,h=(0,Ae.Z)(l.values());try{for(h.s();!(f=h.n()).done;){f.value.onDisconnect(i.id)}}catch(k){h.e(k)}finally{h.f()}}}}catch(k){u.e(k)}finally{u.f()}var p,d=(0,Ae.Z)(s);try{for(d.s();!(p=d.n()).done;){var v=p.value,y=this.topologies.get(v);if(null!=y){var g,m=(0,Ae.Z)(y.values());try{for(m.s();!(g=m.n()).done;){var b=g.value,w=this.components.connectionManager.getConnections(i.id)[0];null!=w&&b.onConnect(i.id,w)}}catch(k){m.e(k)}finally{m.f()}}}}catch(k){d.e(k)}finally{d.f()}}}]),e}(),Ij=(0,ru.kg)("libp2p:transports"),Dj=function(){function e(t){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"transports",void 0),(0,ot.Z)(this,"listeners",void 0),(0,ot.Z)(this,"faultTolerance",void 0),(0,ot.Z)(this,"started",void 0),this.components=t,this.started=!1,this.transports=new Map,this.listeners=ab({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=null!==(n=r.faultTolerance)&&void 0!==n?n:sl.FATAL_ALL}return(0,W.Z)(e,[{key:"add",value:function(e){var t=e[Symbol.toStringTag];if(null==t)throw new ar.s("Transport must have a valid tag",NF.ERR_INVALID_KEY);if(this.transports.has(t))throw new ar.s("There is already a transport with the tag ".concat(t),NF.ERR_DUPLICATE_TRANSPORT);Ij("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}},{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){this.started=!0}},{key:"afterStart",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.components.addressManager.getListenAddrs(),e.next=3,this.listen(t);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=(0,Ae.Z)(this.listeners),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=16;break}i=(0,k.Z)(r.value,2),o=i[0],a=i[1],Ij("closing listeners for %s",o);case 7:if(!(a.length>0)){e.next=14;break}if(null!=(u=a.pop())){e.next=11;break}return e.abrupt("continue",7);case 11:t.push(u.close()),e.next=7;break;case 14:e.next=4;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(2),n.e(e.t0);case 21:return e.prev=21,n.f(),e.finish(21);case 24:return e.next=26,Promise.all(t);case 26:Ij("all listeners closed"),c=(0,Ae.Z)(this.listeners.keys());try{for(c.s();!(l=c.n()).done;)f=l.value,this.listeners.set(f,[])}catch(s){c.e(s)}finally{c.f()}this.started=!1;case 30:case"end":return e.stop()}}),e,this,[[2,18,21,24]])})));return function(){return e.apply(this,arguments)}}()},{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(r=this.transportForMultiaddr(t))){e.next=3;break}throw new ar.s("No transport available for address ".concat(String(t)),NF.ERR_TRANSPORT_UNAVAILABLE);case 3:return e.prev=3,e.next=6,r.dial(t,(0,Nt.Z)((0,Nt.Z)({},n),{},{upgrader:this.components.upgrader}));case 6:return e.abrupt("return",e.sent);case 9:throw e.prev=9,e.t0=e.catch(3),null==e.t0.code&&(e.t0.code=NF.ERR_TRANSPORT_DIAL_FAILED),e.t0;case 13:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getAddrs",value:function(){var e,t=[],n=(0,Ae.Z)(this.listeners.values());try{for(n.s();!(e=n.n()).done;){var r,i=e.value,o=(0,Ae.Z)(i);try{for(o.s();!(r=o.n()).done;){var a=r.value;t=[].concat((0,ye.Z)(t),(0,ye.Z)(a.getAddrs()))}}catch(s){o.e(s)}finally{o.f()}}}catch(s){n.e(s)}finally{n.f()}return t}},{key:"getTransports",value:function(){return Array.of.apply(Array,(0,ye.Z)(this.transports.values()))}},{key:"getListeners",value:function(){return Array.of.apply(Array,(0,ye.Z)(this.listeners.values())).flat()}},{key:"transportForMultiaddr",value:function(e){var t,n=(0,Ae.Z)(this.transports.values());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.filter([e]).length>0)return r}}catch(i){n.e(i)}finally{n.f()}}},{key:"listen",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p,d,v,y=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t&&0!==t.length){e.next=3;break}return Ij("no addresses were provided for listening, this node is dial only"),e.abrupt("return");case 3:n=[],r=(0,Ae.Z)(this.transports.entries()),e.prev=5,r.s();case 7:if((i=r.n()).done){e.next=38;break}o=(0,k.Z)(i.value,2),a=o[0],u=o[1],c=u.filter(t),l=[],f=(0,Ae.Z)(c),e.prev=12,p=(0,s.Z)().mark((function e(){var t,n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=h.value,Ij("creating listener for %s on %s",a,n),r=u.createListener({upgrader:y.components.upgrader}),null==(i=null!==(t=y.listeners.get(a))&&void 0!==t?t:[])&&(i=[],y.listeners.set(a,i)),i.push(r),r.addEventListener("listening",(function(){y.components.events.safeDispatchEvent("transport:listening",{detail:r})})),r.addEventListener("close",(function(){var e=i.findIndex((function(e){return e===r}));i.splice(e,1),y.components.events.safeDispatchEvent("transport:close",{detail:r})})),l.push(r.listen(n));case 9:case"end":return e.stop()}}),e)})),f.s();case 15:if((h=f.n()).done){e.next=19;break}return e.delegateYield(p(),"t0",17);case 17:e.next=15;break;case 19:e.next=24;break;case 21:e.prev=21,e.t1=e.catch(12),f.e(e.t1);case 24:return e.prev=24,f.f(),e.finish(24);case 27:if(0!==l.length){e.next=30;break}return n.push(a),e.abrupt("continue",36);case 30:return e.next=32,Promise.allSettled(l);case 32:if(d=e.sent,null!=d.find((function(e){return"fulfilled"===e.status}))||this.faultTolerance===sl.NO_FATAL){e.next=36;break}throw new ar.s("Transport (".concat(a,") could not listen on any available address"),NF.ERR_NO_VALID_ADDRESSES);case 36:e.next=7;break;case 38:e.next=43;break;case 40:e.prev=40,e.t2=e.catch(5),r.e(e.t2);case 43:return e.prev=43,r.f(),e.finish(43);case 46:if(n.length!==this.transports.size){e.next=51;break}if(v="no valid addresses were provided for transports [".concat(n.join(", "),"]"),this.faultTolerance!==sl.FATAL_ALL){e.next=50;break}throw new ar.s(v,NF.ERR_NO_VALID_ADDRESSES);case 50:Ij("libp2p in dial mode only: ".concat(v));case 51:case"end":return e.stop()}}),e,this,[[5,40,43,46],[12,21,24,27]])})));return function(t){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Ij("removing %s",t),r=(0,Ae.Z)(null!==(n=this.listeners.get(t))&&void 0!==n?n:[]),e.prev=2,r.s();case 4:if((i=r.n()).done){e.next=10;break}return o=i.value,e.next=8,o.close();case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),r.e(e.t0);case 15:return e.prev=15,r.f(),e.finish(15);case 18:this.transports.delete(t),this.listeners.delete(t);case 20:case"end":return e.stop()}}),e,this,[[2,12,15,18]])})));return function(t){return e.apply(this,arguments)}}()},{key:"removeAll",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=(0,Ae.Z)(this.transports.keys());try{for(n.s();!(r=n.n()).done;)i=r.value,t.push(this.remove(i))}catch(o){n.e(o)}finally{n.f()}return e.next=5,Promise.all(t);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),Oj=(0,ru.kg)("libp2p:connection");_j=Symbol.toStringTag;var Rj=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"id",void 0),(0,ot.Z)(this,"remoteAddr",void 0),(0,ot.Z)(this,"remotePeer",void 0),(0,ot.Z)(this,"stat",void 0),(0,ot.Z)(this,"tags",void 0),(0,ot.Z)(this,"_newStream",void 0),(0,ot.Z)(this,"_close",void 0),(0,ot.Z)(this,"_getStreams",void 0),(0,ot.Z)(this,"_closing",void 0),(0,ot.Z)(this,_j,"Connection"),(0,ot.Z)(this,ST,!0);var n=t.remoteAddr,r=t.remotePeer,i=t.newStream,o=t.close,a=t.getStreams,s=t.stat;this.id="".concat(parseInt(String(1e9*Math.random())).toString(36)).concat(Date.now()),this.remoteAddr=n,this.remotePeer=r,this.stat=(0,Nt.Z)((0,Nt.Z)({},s),{},{status:ZT}),this._newStream=i,this._close=o,this._getStreams=a,this.tags=[],this._closing=!1}return(0,W.Z)(e,[{key:"streams",get:function(){return this._getStreams()}},{key:"newStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.stat.status!==TT){e.next=2;break}throw new ar.s("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");case 2:if(this.stat.status!==CT){e.next=4;break}throw new ar.s("the connection is closed","ERR_CONNECTION_CLOSED");case 4:return Array.isArray(t)||(t=[t]),e.next=7,this._newStream(t,n);case 7:return(r=e.sent).stat.direction="outbound",e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"addStream",value:function(e){e.stat.direction="inbound"}},{key:"removeStream",value:function(e){}},{key:"close",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.stat.status!==CT&&!this._closing){e.next=2;break}return e.abrupt("return");case 2:this.stat.status=TT;try{this.streams.forEach((function(e){e.close()}))}catch(t){Oj.error(t)}return this._closing=!0,e.next=7,this._close();case 7:this._closing=!1,this.stat.timeline.close=Date.now(),this.stat.status=CT;case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}();var Pj=(0,ru.kg)("libp2p:upgrader");function Lj(e,t){try{return t.getHandler(e).options.maxInboundStreams}catch(n){if(n.code!==NF.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return 32}function Nj(e,t){try{return t.getHandler(e).options.maxOutboundStreams}catch(n){if(n.code!==NF.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return 64}function Bj(e,t,n){var r=0;return n.streams.forEach((function(n){n.stat.direction===t&&n.stat.protocol===e&&r++})),r}var Mj=function(){function e(t,n){var r,i=this;(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"connectionEncryption",void 0),(0,ot.Z)(this,"muxers",void 0),(0,ot.Z)(this,"inboundUpgradeTimeout",void 0),(0,ot.Z)(this,"events",void 0),this.components=t,this.connectionEncryption=new Map,n.connectionEncryption.forEach((function(e){i.connectionEncryption.set(e.protocol,e)})),this.muxers=new Map,n.muxers.forEach((function(e){i.muxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=null!==(r=n.inboundUpgradeTimeout)&&void 0!==r?r:3e4,this.events=t.events}return(0,W.Z)(e,[{key:"shouldBlockConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===(i=this.components.connectionGater[r])){e.next=6;break}return e.next=4,i(t,n);case 4:if(!e.sent){e.next=6;break}throw new ar.s("The multiaddr connection is blocked by gater.".concat(r),NF.ERR_CONNECTION_INTERCEPTED);case 6:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"upgradeInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v,y,g,m,b,w;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.components.connectionManager.acceptIncomingConnection(t);case 2:if(e.sent){e.next=5;break}throw new ar.s("connection denied",NF.ERR_CONNECTION_DENIED);case 5:c=ej([AbortSignal.timeout(this.inboundUpgradeTimeout)]);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,c)}catch(s){}return e.prev=7,p=yu(t,c),t.source=p.source,t.sink=p.sink,e.next=13,null===(l=(f=this.components.connectionGater).denyInboundConnection)||void 0===l?void 0:l.call(f,t);case 13:if(e.t0=e.sent,!0!==e.t0){e.next=16;break}throw new ar.s("The multiaddr connection is blocked by gater.acceptConnection",NF.ERR_CONNECTION_INTERCEPTED);case 16:if(null===(h=this.components.metrics)||void 0===h||h.trackMultiaddrConnection(t),Pj("starting the inbound connection upgrade"),d=t,!0===(null===n||void 0===n?void 0:n.skipProtection)){e.next=26;break}if(null==(v=this.components.connectionProtector)){e.next=26;break}return Pj("protecting the inbound connection"),e.next=25,v.protect(t);case 25:d=e.sent;case 26:if(e.prev=26,r=d,!0===(null===n||void 0===n?void 0:n.skipEncryption)){e.next=40;break}return e.next=31,this._encryptInbound(d);case 31:return y=e.sent,r=y.conn,i=y.remotePeer,u=y.protocol,g=(0,Nt.Z)((0,Nt.Z)({},d),r),e.next=38,this.shouldBlockConnection(i,g,"denyInboundEncryptedConnection");case 38:e.next=46;break;case 40:if(null!=(m=t.remoteAddr.getPeerId())){e.next=43;break}throw new ar.s("inbound connection that skipped encryption must have a peer id",NF.ERR_INVALID_MULTIADDR);case 43:b=(0,Ps.jE)(m),u="native",i=b;case 46:if(o=r,null==(null===n||void 0===n?void 0:n.muxerFactory)){e.next=51;break}a=n.muxerFactory,e.next=57;break;case 51:if(!(this.muxers.size>0)){e.next=57;break}return e.next=54,this._multiplexInbound((0,Nt.Z)((0,Nt.Z)({},d),r),this.muxers);case 54:w=e.sent,a=w.muxerFactory,o=w.stream;case 57:e.next=63;break;case 59:throw e.prev=59,e.t1=e.catch(26),Pj.error("Failed to upgrade inbound connection",e.t1),e.t1;case 63:return e.next=65,this.shouldBlockConnection(i,t,"denyInboundUpgradedConnection");case 65:return Pj("Successfully upgraded inbound connection"),e.abrupt("return",this._createConnection({cryptoProtocol:u,direction:"inbound",maConn:t,upgradedConn:o,muxerFactory:a,remotePeer:i}));case 67:return e.prev=67,this.components.connectionManager.afterUpgradeInbound(),c.clear(),e.finish(67);case 71:case"end":return e.stop()}}),e,this,[[7,,67,71],[26,59]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"upgradeOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v,y;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(i=t.remoteAddr.getPeerId())){e.next=5;break}return o=(0,Ps.jE)(i),e.next=5,this.shouldBlockConnection(o,t,"denyOutboundConnection");case 5:if(null===(r=this.components.metrics)||void 0===r||r.trackMultiaddrConnection(t),Pj("Starting the outbound connection upgrade"),h=t,!0===(null===n||void 0===n?void 0:n.skipProtection)){e.next=14;break}if(null==(p=this.components.connectionProtector)){e.next=14;break}return e.next=13,p.protect(t);case 13:h=e.sent;case 14:if(e.prev=14,a=h,!0===(null===n||void 0===n?void 0:n.skipEncryption)){e.next=28;break}return e.next=19,this._encryptOutbound(h,o);case 19:return d=e.sent,a=d.conn,u=d.remotePeer,l=d.protocol,v=(0,Nt.Z)((0,Nt.Z)({},h),a),e.next=26,this.shouldBlockConnection(u,v,"denyOutboundEncryptedConnection");case 26:e.next=32;break;case 28:if(null!=o){e.next=30;break}throw new ar.s("Encryption was skipped but no peer id was passed",NF.ERR_INVALID_PEER);case 30:l="native",u=o;case 32:if(c=a,null==(null===n||void 0===n?void 0:n.muxerFactory)){e.next=37;break}f=n.muxerFactory,e.next=43;break;case 37:if(!(this.muxers.size>0)){e.next=43;break}return e.next=40,this._multiplexOutbound((0,Nt.Z)((0,Nt.Z)({},h),a),this.muxers);case 40:y=e.sent,f=y.muxerFactory,c=y.stream;case 43:e.next=51;break;case 45:return e.prev=45,e.t0=e.catch(14),Pj.error("Failed to upgrade outbound connection",e.t0),e.next=50,t.close(e.t0);case 50:throw e.t0;case 51:return e.next=53,this.shouldBlockConnection(u,t,"denyOutboundUpgradedConnection");case 53:return Pj("Successfully upgraded outbound connection"),e.abrupt("return",this._createConnection({cryptoProtocol:l,direction:"outbound",maConn:t,upgradedConn:c,muxerFactory:f,remotePeer:u}));case 55:case"end":return e.stop()}}),e,this,[[14,45]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_createConnection",value:function(e){var t,n,r,i,o,a=this,c=e.cryptoProtocol,l=e.direction,f=e.maConn,h=e.upgradedConn,p=e.remotePeer,d=e.muxerFactory;null!=d&&(r=d.createStreamMuxer({direction:l,onIncomingStream:function(e){null!=o&&Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,u,c,f,h;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=a.components.registrar.getProtocols(),t.next=3,xT(e,r);case 3:if(i=t.sent,u=i.stream,c=i.protocol,Pj("%s: incoming stream opened on %s",l,c),null!=o){t.next=9;break}return t.abrupt("return");case 9:if(f=Lj(c,a.components.registrar),Bj(c,"inbound",o)!==f){t.next=15;break}throw h=new ar.s('Too many inbound protocol streams for protocol "'.concat(c,'" - limit ').concat(f),NF.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS),e.abort(h),h;case 15:return e.source=u.source,e.sink=u.sink,e.stat.protocol=c,t.next=20,a.components.peerStore.merge(p,{protocols:[c]});case 20:o.addStream(e),null===(n=a.components.metrics)||void 0===n||n.trackProtocolStream(e,o),a._onStream({connection:o,stream:e,protocol:c});case 23:case"end":return t.stop()}}),t)})))).catch((function(t){Pj.error(t),null==e.stat.timeline.close&&e.close()}))},onStreamEnd:function(e){var t;null===(t=o)||void 0===t||t.removeStream(e.id)}}),i=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,i,u,c,f,h,d,v,y=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=y.length>1&&void 0!==y[1]?y[1]:{},null!=r){e.next=3;break}throw new ar.s("Stream is not multiplexed",NF.ERR_MUXER_UNAVAILABLE);case 3:return Pj("%s: starting new stream on %s",l,t),e.next=6,r.newStream();case 6:if(i=e.sent,e.prev=7,null==n.signal){Pj("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",t),n.signal=AbortSignal.timeout(3e4);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,n.signal)}catch(s){}}return e.next=11,bT(i,t,n);case 11:if(c=e.sent,f=c.stream,h=c.protocol,d=Nj(h,a.components.registrar),Bj(h,"outbound",o)!==d){e.next=20;break}throw v=new ar.s('Too many outbound protocol streams for protocol "'.concat(h,'" - limit ').concat(d),NF.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS),i.abort(v),v;case 20:return e.next=22,a.components.peerStore.merge(p,{protocols:[h]});case 22:return i.source=f.source,i.sink=f.sink,i.stat.protocol=h,null===(u=a.components.metrics)||void 0===u||u.trackProtocolStream(i,o),e.abrupt("return",i);case 29:if(e.prev=29,e.t0=e.catch(7),Pj.error("could not create new stream",e.t0),null==i.stat.timeline.close&&i.close(),null==e.t0.code){e.next=35;break}throw e.t0;case 35:throw new ar.s(String(e.t0),NF.ERR_UNSUPPORTED_PROTOCOL);case 36:case"end":return e.stop()}}),e,null,[[7,29]])})));return function(t){return e.apply(this,arguments)}}(),Promise.all([r.sink(h.source),h.sink(r.source)]).catch((function(e){Pj.error(e)})));var v=f.timeline;f.timeline=new Proxy(v,{set:function(){return null!=o&&"close"===(arguments.length<=1?void 0:arguments[1])&&null!=(arguments.length<=2?void 0:arguments[2])&&null==v.close&&(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"OPEN"!==o.stat.status){e.next=4;break}return e.next=4,o.close();case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),Pj.error(e.t0);case 9:return e.prev=9,a.events.safeDispatchEvent("connection:close",{detail:o}),e.finish(9);case 12:case"end":return e.stop()}}),e,null,[[0,6,9,12]])})))().catch((function(e){Pj.error(e)})),Reflect.set.apply(Reflect,arguments)}}),f.timeline.upgraded=Date.now();var y,g=function(){throw new ar.s("connection is not multiplexed",NF.ERR_CONNECTION_NOT_MULTIPLEXED)};return y={remoteAddr:f.remoteAddr,remotePeer:p,stat:{status:"OPEN",direction:l,timeline:f.timeline,multiplexer:null===(t=r)||void 0===t?void 0:t.protocol,encryption:c},newStream:null!==(n=i)&&void 0!==n?n:g,getStreams:function(){return null!=r?r.streams:g()},close:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f.close();case 2:null!=r&&r.close();case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},o=new Rj(y),this.events.safeDispatchEvent("connection:open",{detail:o}),o}},{key:"_onStream",value:function(e){var t=e.connection,n=e.stream,r=e.protocol;(0,this.components.registrar.getHandler(r).handler)({connection:t,stream:n})}},{key:"_encryptInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Array.from(this.connectionEncryption.keys()),Pj("handling inbound crypto protocol selection",n),e.prev=2,e.next=5,xT(t,n,{writeBytes:!0});case 5:if(r=e.sent,i=r.stream,o=r.protocol,null!=(a=this.connectionEncryption.get(o))){e.next=11;break}throw new Error("no crypto module found for ".concat(o));case 11:return Pj("encrypting inbound connection..."),e.t0=Nt.Z,e.t1=Nt.Z,e.t2={},e.next=17,a.secureInbound(this.components.peerId,i);case 17:return e.t3=e.sent,e.t4=(0,e.t1)(e.t2,e.t3),e.t5={},e.t6={protocol:o},e.abrupt("return",(0,e.t0)(e.t4,e.t5,e.t6));case 24:throw e.prev=24,e.t7=e.catch(2),new ar.s(String(e.t7),NF.ERR_ENCRYPTION_FAILED);case 27:case"end":return e.stop()}}),e,this,[[2,24]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_encryptOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Array.from(this.connectionEncryption.keys()),Pj("selecting outbound crypto protocol",r),e.prev=2,e.next=5,bT(t,r,{writeBytes:!0});case 5:if(i=e.sent,o=i.stream,a=i.protocol,null!=(u=this.connectionEncryption.get(a))){e.next=11;break}throw new Error("no crypto module found for ".concat(a));case 11:return Pj("encrypting outbound connection to %p",n),e.t0=Nt.Z,e.t1=Nt.Z,e.t2={},e.next=17,u.secureOutbound(this.components.peerId,o,n);case 17:return e.t3=e.sent,e.t4=(0,e.t1)(e.t2,e.t3),e.t5={},e.t6={protocol:a},e.abrupt("return",(0,e.t0)(e.t4,e.t5,e.t6));case 24:throw e.prev=24,e.t7=e.catch(2),new ar.s(String(e.t7),NF.ERR_ENCRYPTION_FAILED);case 27:case"end":return e.stop()}}),e,this,[[2,24]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_multiplexOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Array.from(n.keys()),Pj("outbound selecting muxer %s",r),e.prev=2,e.next=5,bT(t,r,{writeBytes:!0});case 5:return i=e.sent,o=i.stream,a=i.protocol,Pj("%s selected as muxer protocol",a),u=n.get(a),e.abrupt("return",{stream:o,muxerFactory:u});case 13:throw e.prev=13,e.t0=e.catch(2),Pj.error("error multiplexing outbound stream",e.t0),new ar.s(String(e.t0),NF.ERR_MUXER_UNAVAILABLE);case 17:case"end":return e.stop()}}),e,null,[[2,13]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_multiplexInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Array.from(n.keys()),Pj("inbound handling muxers %s",r),e.prev=2,e.next=5,xT(t,r,{writeBytes:!0});case 5:return i=e.sent,o=i.stream,a=i.protocol,u=n.get(a),e.abrupt("return",{stream:o,muxerFactory:u});case 12:throw e.prev=12,e.t0=e.catch(2),Pj.error("error multiplexing inbound stream",e.t0),new ar.s(String(e.t0),NF.ERR_MUXER_UNAVAILABLE);case 16:case"end":return e.stop()}}),e,null,[[2,12]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),Fj=(0,ru.kg)("libp2p"),jj=new WeakMap,Uj=new WeakSet,zj=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r,i,o,a,s,u,c;(0,K.Z)(this,n),c=t.call(this),pw((0,nr.Z)(c),Uj),(0,ot.Z)((0,nr.Z)(c),"peerId",void 0),(0,ot.Z)((0,nr.Z)(c),"peerStore",void 0),(0,ot.Z)((0,nr.Z)(c),"contentRouting",void 0),(0,ot.Z)((0,nr.Z)(c),"peerRouting",void 0),(0,ot.Z)((0,nr.Z)(c),"keychain",void 0),(0,ot.Z)((0,nr.Z)(c),"metrics",void 0),(0,ot.Z)((0,nr.Z)(c),"services",void 0),(0,ot.Z)((0,nr.Z)(c),"components",void 0),(0,cl.Z)((0,nr.Z)(c),jj,{writable:!0,value:void 0});var l=new Ch,f=l.dispatchEvent.bind(l);l.dispatchEvent=function(e){var t=f(e),n=c.dispatchEvent(new Dh(e.type,{detail:e.detail}));return t||n};try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,l)}catch(w){}(0,ll.Z)((0,nr.Z)(c),jj,!1),c.peerId=e.peerId,c.services={};var h=c.components=function(){var e=new DF(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return new Proxy(e,{get:function(t,n,r){if("string"===typeof n&&!RF.includes(n)){var i=e.components[n];if(null==i&&!OF.includes(n))throw new ar.s("".concat(n," not set"),"ERR_SERVICE_MISSING");return i}return Reflect.get(t,n,r)},set:function(t,n,r){return"string"===typeof n?e.components[n]=r:Reflect.set(t,n,r),!0}})}({peerId:e.peerId,events:l,datastore:null!==(r=e.datastore)&&void 0!==r?r:new km,connectionGater:PF(e.connectionGater)});c.peerStore=c.configureComponent("peerStore",new iS(h,(0,Nt.Z)({addressFilter:c.components.connectionGater.filterMultiaddrForPeer},e.peerStore))),null!=e.metrics&&(c.metrics=c.configureComponent("metrics",e.metrics(c.components))),h.events.addEventListener("peer:update",(function(e){null==e.detail.previous&&c.safeDispatchEvent("peer:discovery",{detail:e.detail.peer})})),null!=e.connectionProtector&&c.configureComponent("connectionProtector",e.connectionProtector(h)),c.components.upgrader=new Mj(c.components,{connectionEncryption:(null!==(i=e.connectionEncryption)&&void 0!==i?i:[]).map((function(e,t){return c.configureComponent("connection-encryption-".concat(t),e(c.components))})),muxers:(null!==(o=e.streamMuxers)&&void 0!==o?o:[]).map((function(e,t){return c.configureComponent("stream-muxers-".concat(t),e(c.components))})),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),c.configureComponent("transportManager",new Dj(c.components,e.transportManager)),c.configureComponent("connectionManager",new gj(c.components,e.connectionManager)),c.configureComponent("registrar",new Cj(c.components)),c.configureComponent("addressManager",new IF(c.components,e.addresses));var p=qk.generateOptions();c.keychain=c.configureComponent("keyChain",new qk(c.components,(0,Nt.Z)((0,Nt.Z)({},p),e.keychain)));var d=(null!==(a=e.peerRouters)&&void 0!==a?a:[]).map((function(e,t){return c.configureComponent("peer-router-".concat(t),e(c.components))}));c.peerRouting=c.components.peerRouting=c.configureComponent("peerRouting",new Zj(c.components,{routers:d}));var v=(null!==(s=e.contentRouters)&&void 0!==s?s:[]).map((function(e,t){return c.configureComponent("content-router-".concat(t),e(c.components))}));if(c.contentRouting=c.components.contentRouting=c.configureComponent("contentRouting",new xj(c.components,{routers:v})),(null!==(u=e.peerDiscovery)&&void 0!==u?u:[]).forEach((function(e,t){c.configureComponent("peer-discovery-".concat(t),e(c.components)).addEventListener("peer",(function(e){dw((0,nr.Z)(c),Uj,Hj).call((0,nr.Z)(c),e)}))})),e.transports.forEach((function(e,t){c.components.transportManager.add(c.configureComponent("transport-".concat(t),e(c.components)))})),null!=e.services)for(var y=0,g=Object.keys(e.services);y<g.length;y++){var m=g[y],b=(0,e.services[m])(c.components);null!=b?(c.services[m]=b,c.configureComponent(m,b),null!=b[pk]&&(Fj("registering service %s for content routing",m),v.push(b[pk])),null!=b[vk]&&(Fj("registering service %s for peer routing",m),d.push(b[vk])),null!=b[dk]&&(Fj("registering service %s for peer discovery",m),b[dk].addEventListener("peer",(function(e){dw((0,nr.Z)(c),Uj,Hj).call((0,nr.Z)(c),e)})))):Fj.error("service factory %s returned null or undefined instance",m)}return c}return(0,W.Z)(n,[{key:"configureComponent",value:function(e,t){return null==t&&Fj.error("component %s was null or undefined",e),this.components[e]=t,t}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,fl.Z)(this,jj)){e.next=2;break}return e.abrupt("return");case 2:return(0,ll.Z)(this,jj,!0),Fj("libp2p is starting"),e.next=6,this.keychain.listKeys();case 6:if(null!=e.sent.find((function(e){return"self"===e.name}))){e.next=11;break}return Fj("importing self key into keychain"),e.next=11,this.keychain.importPeer("self",this.components.peerId);case 11:return e.prev=11,e.next=14,null===(t=(n=this.components).beforeStart)||void 0===t?void 0:t.call(n);case 14:return e.next=16,this.components.start();case 16:return e.next=18,null===(r=(i=this.components).afterStart)||void 0===r?void 0:r.call(i);case 18:this.safeDispatchEvent("start",{detail:this}),Fj("libp2p has started"),e.next=28;break;case 22:return e.prev=22,e.t0=e.catch(11),Fj.error("An error occurred starting libp2p",e.t0),e.next=27,this.stop();case 27:throw e.t0;case 28:case"end":return e.stop()}}),e,this,[[11,22]])})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,fl.Z)(this,jj)){e.next=2;break}return e.abrupt("return");case 2:return Fj("libp2p is stopping"),(0,ll.Z)(this,jj,!1),e.next=6,null===(t=(n=this.components).beforeStop)||void 0===t?void 0:t.call(n);case 6:return e.next=8,this.components.stop();case 8:return e.next=10,null===(r=(i=this.components).afterStop)||void 0===r?void 0:r.call(i);case 10:this.safeDispatchEvent("stop",{detail:this}),Fj("libp2p has stopped");case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"isStarted",value:function(){return(0,fl.Z)(this,jj)}},{key:"getConnections",value:function(e){return this.components.connectionManager.getConnections(e)}},{key:"getDialQueue",value:function(){return this.components.connectionManager.getDialQueue()}},{key:"getPeers",value:function(){var e,t=new Xk,n=(0,Ae.Z)(this.components.connectionManager.getConnections());try{for(n.s();!(e=n.n()).done;){var r=e.value;t.add(r.remotePeer)}}catch(i){n.e(i)}finally{n.f()}return Array.from(t)}},{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",this.components.connectionManager.openConnection(t,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"dialProtocol",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>2&&void 0!==o[2]?o[2]:{},null!=n){e.next=3;break}throw new ar.s("no protocols were provided to open a stream",NF.ERR_INVALID_PROTOCOLS_FOR_STREAM);case 3:if(0!==(n=Array.isArray(n)?n:[n]).length){e.next=6;break}throw new ar.s("no protocols were provided to open a stream",NF.ERR_INVALID_PROTOCOLS_FOR_STREAM);case 6:return e.next=8,this.dial(t,r);case 8:return i=e.sent,e.abrupt("return",i.newStream(n,r));case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getMultiaddrs",value:function(){return this.components.addressManager.getAddresses()}},{key:"getProtocols",value:function(){return this.components.registrar.getProtocols()}},{key:"hangUp",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return wF(t)&&(t=(0,Ps.jE)(null!==(n=t.getPeerId())&&void 0!==n?n:"")),e.next=3,this.components.connectionManager.closeConnections(t);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getPublicKey",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.length>1&&void 0!==a[1]?a[1]:{},Fj("getPublicKey %p",t),null==t.publicKey){e.next=4;break}return e.abrupt("return",t.publicKey);case 4:return e.next=6,this.peerStore.get(t);case 6:if(null==(r=e.sent).id.publicKey){e.next=9;break}return e.abrupt("return",r.id.publicKey);case 9:return i=Gn([Us("/pk/"),t.multihash.digest]),e.next=12,this.contentRouting.get(i,n);case 12:return Zs(o=e.sent),e.next=16,this.peerStore.patch(t,{publicKey:o});case 16:return e.abrupt("return",o);case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Array.isArray(t)||(t=[t]),e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.components.registrar.handle(t,n,r);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"unhandle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Array.isArray(t)||(t=[t]),e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.components.registrar.unhandle(t);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.components.registrar.register(t,n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"unregister",value:function(e){this.components.registrar.unregister(e)}}]),n}(Ch);function Hj(e){var t=e.detail;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs,protocols:t.protocols}).catch((function(e){Fj.error(e)})):Fj.error(new Error(NF.ERR_DISCOVERED_SELF))}function Vj(e){return Gj.apply(this,arguments)}function Gj(){return(Gj=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.peerId){e.next=14;break}if(null==(n=t.datastore)){e.next=14;break}return e.prev=3,r=new qk({datastore:n},(0,mk.Z)(qk.generateOptions(),t.keychain)),e.next=7,r.exportPeerId("self");case 7:t.peerId=e.sent,e.next=14;break;case 10:if(e.prev=10,e.t0=e.catch(3),"ERR_NOT_FOUND"===e.t0.code){e.next=14;break}throw e.t0;case 14:if(null!=t.peerId){e.next=18;break}return e.next=17,rE();case 17:t.peerId=e.sent;case 18:return e.abrupt("return",new zj(zF(t)));case 19:case"end":return e.stop()}}),e,null,[[3,10]])})))).apply(this,arguments)}function Kj(e){return Wj.apply(this,arguments)}function Wj(){return(Wj=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Vj(t);case 2:if(n=e.sent,!1===t.start){e.next=6;break}return e.next=6,n.start();case 6:return e.abrupt("return",n);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var qj;!function(e){var t,n,r;!function(e){e.DIAL="DIAL",e.DIAL_RESPONSE="DIAL_RESPONSE"}(e.MessageType||(e.MessageType={})),function(e){e[e.DIAL=0]="DIAL",e[e.DIAL_RESPONSE=1]="DIAL_RESPONSE"}(t||(t={})),function(e){e.codec=function(){return co(t)}}(e.MessageType||(e.MessageType={})),function(e){e.OK="OK",e.E_DIAL_ERROR="E_DIAL_ERROR",e.E_DIAL_REFUSED="E_DIAL_REFUSED",e.E_BAD_REQUEST="E_BAD_REQUEST",e.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(e.ResponseStatus||(e.ResponseStatus={})),function(e){e[e.OK=0]="OK",e[e.E_DIAL_ERROR=100]="E_DIAL_ERROR",e[e.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",e[e.E_BAD_REQUEST=200]="E_BAD_REQUEST",e[e.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"}(n||(n={})),function(e){e.codec=function(){return co(n)}}(e.ResponseStatus||(e.ResponseStatus={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs){var r,i=(0,Ae.Z)(e.addrs);try{for(i.s();!(r=i.n()).done;){var o=r.value;t.uint32(18),t.bytes(o)}}catch(a){i.e(a)}finally{i.f()}}!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={addrs:[]},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.id=e.bytes();break;case 2:n.addrs.push(e.bytes());break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(e.PeerInfo||(e.PeerInfo={})),function(t){var n;t.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.peer&&(n.uint32(10),e.PeerInfo.codec().encode(t.peer,n)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();if(o>>>3===1)r.peer=e.PeerInfo.codec().decode(t,t.uint32());else t.skipType(7&o)}return r}))),n},t.encode=function(e){return so(e,t.codec())},t.decode=function(e){return ao(e,t.codec())}}(e.Dial||(e.Dial={})),function(t){var n;t.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.status&&(n.uint32(8),e.ResponseStatus.codec().encode(t.status,n)),null!=t.statusText&&(n.uint32(18),n.string(t.statusText)),null!=t.addr&&(n.uint32(26),n.bytes(t.addr)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.status=e.ResponseStatus.codec().decode(t);break;case 2:r.statusText=t.string();break;case 3:r.addr=t.bytes();break;default:t.skipType(7&o)}}return r}))),n},t.encode=function(e){return so(e,t.codec())},t.decode=function(e){return ao(e,t.codec())}}(e.DialResponse||(e.DialResponse={})),e.codec=function(){return null==r&&(r=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.MessageType.codec().encode(t.type,n)),null!=t.dial&&(n.uint32(18),e.Dial.codec().encode(t.dial,n)),null!=t.dialResponse&&(n.uint32(26),e.DialResponse.codec().encode(t.dialResponse,n)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.type=e.MessageType.codec().decode(t);break;case 2:r.dial=e.Dial.codec().decode(t,t.uint32());break;case 3:r.dialResponse=e.DialResponse.codec().decode(t,t.uint32());break;default:t.skipType(7&o)}}return r}))),r},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(qj||(qj={}));var Yj=(0,ru.kg)("libp2p:autonat"),Qj=function(){function e(t,n){var r,i,o,a,s,u;(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"startupDelay",void 0),(0,ot.Z)(this,"refreshInterval",void 0),(0,ot.Z)(this,"protocol",void 0),(0,ot.Z)(this,"timeout",void 0),(0,ot.Z)(this,"maxInboundStreams",void 0),(0,ot.Z)(this,"maxOutboundStreams",void 0),(0,ot.Z)(this,"verifyAddressTimeout",void 0),(0,ot.Z)(this,"started",void 0),this.components=t,this.started=!1,this.protocol="/".concat(null!==(r=n.protocolPrefix)&&void 0!==r?r:"libp2p","/").concat("autonat","/").concat("1.0.0"),this.timeout=null!==(i=n.timeout)&&void 0!==i?i:3e4,this.maxInboundStreams=null!==(o=n.maxInboundStreams)&&void 0!==o?o:1,this.maxOutboundStreams=null!==(a=n.maxOutboundStreams)&&void 0!==a?a:1,this.startupDelay=null!==(s=n.startupDelay)&&void 0!==s?s:5e3,this.refreshInterval=null!==(u=n.refreshInterval)&&void 0!==u?u:6e4,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.started){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.components.registrar.handle(this.protocol,(function(e){t.handleIncomingAutonatStream(e).catch((function(e){Yj.error("error handling incoming autonat stream",e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams});case 4:this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0;case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.components.registrar.unhandle(this.protocol);case 2:clearTimeout(this.verifyAddressTimeout),this.started=!1;case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"handleIncomingAutonatStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=ej([AbortSignal.timeout(this.timeout)]);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,n)}catch(a){}return r=this.components.addressManager.getAddresses().map((function(e){return e.toOptions().host})),e.prev=3,i=yu(t.stream,n),o=this,e.next=8,cn(i,(function(e){return jt(e)}),function(){var e=(0,g.Z)((0,s.Z)().mark((function e(i){var a,u,c,l,f,h,p,d,v,g,b,w,k,E,x;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.Z)(Sj(i));case 2:if(null!=(a=e.sent)){e.next=8;break}return Yj("no message received"),e.next=7,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}});case 7:return e.abrupt("return");case 8:e.prev=8,u=qj.decode(a),e.next=18;break;case 12:return e.prev=12,e.t0=e.catch(8),Yj.error("could not decode message",e.t0),e.next=17,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}});case 17:return e.abrupt("return");case 18:if(null!=(c=u.dial)){e.next=24;break}return Yj.error("dial was missing from message"),e.next=23,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}});case 23:return e.abrupt("return");case 24:if(null!=(f=c.peer)&&null!=f.id){e.next=30;break}return Yj.error("PeerId missing from message"),e.next=29,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}});case 29:return e.abrupt("return");case 30:e.prev=30,l=(0,Ps.cv)(f.id),e.next=40;break;case 34:return e.prev=34,e.t1=e.catch(30),Yj.error("invalid PeerId",e.t1),e.next=39,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}});case 39:return e.abrupt("return");case 40:if(Yj("incoming request from %p",l),t.connection.remotePeer.equals(l)){e.next=46;break}return Yj("target peer %p did not equal sending peer %p",l,t.connection.remotePeer),e.next=45,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}});case 45:return e.abrupt("return");case 46:if(h=f.addrs.map((function(e){return AF(e)})).filter((function(e){var n=e.toOptions().host===t.connection.remoteAddr.toOptions().host;return Yj.trace("request to dial %s was sent from %s is same host %s",e,t.connection.remoteAddr,n),n})).filter((function(e){var t,n=e.toOptions().host,r=!(null!==(t=bA(n))&&void 0!==t&&t);return Yj.trace("host %s was public %s",n,r),r})).filter((function(e){var t=e.toOptions().host,n=!r.includes(t);return Yj.trace("host %s was not our host %s",t,n),n})).filter((function(e){var t=Boolean(o.components.transportManager.transportForMultiaddr(e));return Yj.trace("transport for %s is supported %s",e,t),t})).map((function(e){return null==e.getPeerId()&&(e=e.encapsulate("/p2p/".concat(l.toString()))),e})),0!==h.length){e.next=52;break}return Yj("no valid multiaddrs for %p in message",l),e.next=51,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}});case 51:return e.abrupt("return");case 52:Yj("dial multiaddrs %s for peer %p",h.map((function(e){return e.toString()})).join(", "),l),p="",d=h[0],v=!1,g=!1,e.prev=57,w=(0,y.Z)(h);case 59:return e.next=61,(0,m.Z)(w.next());case 61:if(!(v=!(k=e.sent).done)){e.next=90;break}return E=k.value,x=void 0,d=E,e.prev=65,e.next=68,(0,m.Z)(o.components.connectionManager.openConnection(E,{signal:n}));case 68:if((x=e.sent).remoteAddr.equals(E)){e.next=72;break}throw Yj.error("tried to dial %s but dialed %s",E,x.remoteAddr),new Error("Unexpected remote address");case 72:return Yj("Success %p",l),e.next=75,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.OK,addr:x.remoteAddr.decapsulateCode(qM("p2p").code).bytes}});case 75:return e.abrupt("return");case 78:e.prev=78,e.t2=e.catch(65),Yj("could not dial %p",l,e.t2),p=e.t2.message;case 82:if(e.prev=82,null==x){e.next=86;break}return e.next=86,(0,m.Z)(x.close());case 86:return e.finish(82);case 87:v=!1,e.next=59;break;case 90:e.next=96;break;case 92:e.prev=92,e.t3=e.catch(57),g=!0,b=e.t3;case 96:if(e.prev=96,e.prev=97,!v||null==w.return){e.next=101;break}return e.next=101,(0,m.Z)(w.return());case 101:if(e.prev=101,!g){e.next=104;break}throw b;case 104:return e.finish(101);case 105:return e.finish(96);case 106:return e.next=108,qj.encode({type:qj.MessageType.DIAL_RESPONSE,dialResponse:{status:qj.ResponseStatus.E_DIAL_ERROR,statusText:p,addr:d.bytes}});case 108:case"end":return e.stop()}}),e,null,[[8,12],[30,34],[57,92,96,106],[65,78,82,87],[97,,101,105]])})));return function(t){return e.apply(this,arguments)}}(),(function(e){return Pt(e)}),t.stream);case 8:e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),Yj.error("error handling incoming autonat stream",e.t0);case 13:return e.prev=13,n.clear(),e.finish(13);case 16:case"end":return e.stop()}}),e,this,[[3,10,13,16]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_verifyExternalAddresses",value:function(){this.verifyExternalAddresses().catch((function(e){Yj.error("error verifying external address",e)}))}},{key:"verifyExternalAddresses",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,c,l,f,h,p,d,v,g,m,b,w,k=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(clearTimeout(this.verifyAddressTimeout),this.isStarted()){e.next=3;break}return e.abrupt("return");case 3:if(t=this.components.addressManager,0!==(n=t.getObservedAddrs().filter((function(e){var t,n=e.toOptions();return!(null!==(t=bA(n.host))&&void 0!==t&&t)}))).length){e.next=9;break}return Yj("no public addresses found, not requesting verification"),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval),e.abrupt("return");case 9:r=AbortSignal.timeout(this.timeout);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,r)}catch(E){}return i=this,e.prev=12,Yj("verify multiaddrs %s",n.map((function(e){return e.toString()})).join(", ")),o=qj.encode({type:qj.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:n.map((function(e){return e.bytes}))}}}),e.next=17,rE();case 17:a=e.sent,c=a.toBytes(),l={},f=[],h=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,a,c,l,h,p,d,v,y;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,Yj("asking %p to verify multiaddr",t.id),e.next=4,i.components.connectionManager.openConnection(t.id,{signal:r});case 4:return n=e.sent,e.next=7,n.newStream(k.protocol,{signal:r});case 7:return a=e.sent,c=yu(a,r),e.next=11,cn([o],(function(e){return Pt(e)}),c,(function(e){return jt(e)}),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Sj(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:if(null!=(l=e.sent)){e.next=15;break}return Yj("no response received from %p",n.remotePeer),e.abrupt("return",void 0);case 15:if((h=qj.decode(l)).type===qj.MessageType.DIAL_RESPONSE&&null!=h.dialResponse){e.next=19;break}return Yj("invalid autonat response from %p",n.remotePeer),e.abrupt("return",void 0);case 19:if(h.dialResponse.status!==qj.ResponseStatus.OK){e.next=37;break}if(4!==(p=n.remoteAddr.toOptions()).family){e.next=26;break}v=p.host.split("."),d=v[0],e.next=33;break;case 26:if(6!==p.family){e.next=31;break}y=p.host.split(":"),d=y[0],e.next=33;break;case 31:return Yj('remote address "%s" was not IP4 or IP6?',p.host),e.abrupt("return",void 0);case 33:if(!f.includes(d)){e.next=36;break}return Yj("already have response from network segment %d - %s",d,p.host),e.abrupt("return",void 0);case 36:f.push(d);case 37:return e.abrupt("return",h.dialResponse);case 40:e.prev=40,e.t0=e.catch(0),Yj.error("error asking remote to verify multiaddr",e.t0);case 43:case"end":return e.stop()}}),e,null,[[0,40]])})));return function(t){return e.apply(this,arguments)}}(),p=!1,d=!1,e.prev=24,g=(0,s.Z)().mark((function e(){var r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=b.value,e.prev=1,null!=r){e.next=4;break}return e.abrupt("return","continue");case 4:if(i=null==r.addr?n[0]:AF(r.addr),Yj("autonat response for %s is %s",i,r.status),r.status!==qj.ResponseStatus.E_BAD_REQUEST){e.next=8;break}return e.abrupt("return","continue");case 8:if(r.status!==qj.ResponseStatus.E_DIAL_REFUSED){e.next=10;break}return e.abrupt("return","continue");case 10:if(!(null==r.addr&&n.length>1)){e.next=12;break}return e.abrupt("return","continue");case 12:if(n.some((function(e){return e.equals(i)}))){e.next=15;break}return Yj("peer reported %s as %s but it was not in our observed address list",i,r.status),e.abrupt("return","continue");case 15:if(o=i.toString(),null==l[o]&&(l[o]={success:0,failure:0}),r.status===qj.ResponseStatus.OK?l[o].success++:r.status===qj.ResponseStatus.E_DIAL_ERROR&&l[o].failure++,4!==l[o].success){e.next=22;break}return Yj("%s is externally dialable",i),t.confirmObservedAddr(i),e.abrupt("return",{v:void 0});case 22:if(4!==l[o].failure){e.next=26;break}return Yj("%s is not externally dialable",i),t.removeObservedAddr(i),e.abrupt("return",{v:void 0});case 26:e.next=31;break;case 28:e.prev=28,e.t0=e.catch(1),Yj.error("could not verify external address",e.t0);case 31:case"end":return e.stop()}}),e,null,[[1,28]])})),m=(0,y.Z)(EP(Em(this.components.peerRouting.getClosestPeers(c,{signal:r}),(function(e){return(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",h(e));case 1:case"end":return t.stop()}}),t)})))})),{concurrency:4}));case 27:return e.next=29,m.next();case 29:if(!(p=!(b=e.sent).done)){e.next=39;break}return e.delegateYield(g(),"t0",31);case 31:if("continue"!==(w=e.t0)){e.next=34;break}return e.abrupt("continue",36);case 34:if("object"!==typeof w){e.next=36;break}return e.abrupt("return",w.v);case 36:p=!1,e.next=27;break;case 39:e.next=45;break;case 41:e.prev=41,e.t1=e.catch(24),d=!0,v=e.t1;case 45:if(e.prev=45,e.prev=46,!p||null==m.return){e.next=50;break}return e.next=50,m.return();case 50:if(e.prev=50,!d){e.next=53;break}throw v;case 53:return e.finish(50);case 54:return e.finish(45);case 55:return e.prev=55,this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval),e.finish(55);case 58:case"end":return e.stop()}}),e,this,[[12,,55,58],[24,41,45,55],[46,,50,54]])})));return function(){return e.apply(this,arguments)}}()}]),e}();function Xj(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t){return new Qj(t,e)}}BigInt(1<<17);var $j,Jj,eU,tU,nU,rU,iU,oU,aU="/libp2p/circuit/relay/0.2.0/hop",sU="/libp2p/circuit/relay/0.2.0/stop";!function(e){var t,n;!function(e){e.RESERVE="RESERVE",e.CONNECT="CONNECT",e.STATUS="STATUS"}(e.Type||(e.Type={})),function(e){e[e.RESERVE=0]="RESERVE",e[e.CONNECT=1]="CONNECT",e[e.STATUS=2]="STATUS"}(t||(t={})),function(e){e.codec=function(){return co(t)}}(e.Type||(e.Type={})),e.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),eU.codec().encode(t.peer,n)),null!=t.reservation&&(n.uint32(26),tU.codec().encode(t.reservation,n)),null!=t.limit&&(n.uint32(34),nU.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(40),rU.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.peer=eU.codec().decode(t,t.uint32());break;case 3:r.reservation=tU.codec().decode(t,t.uint32());break;case 4:r.limit=nU.codec().decode(t,t.uint32());break;case 5:r.status=rU.codec().decode(t);break;default:t.skipType(7&o)}}return r}))),n},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}($j||($j={})),function(e){var t,n;!function(e){e.CONNECT="CONNECT",e.STATUS="STATUS"}(e.Type||(e.Type={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.STATUS=1]="STATUS"}(t||(t={})),functi