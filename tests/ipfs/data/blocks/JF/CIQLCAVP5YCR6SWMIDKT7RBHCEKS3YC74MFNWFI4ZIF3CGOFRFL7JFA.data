"forEach release read lock"),n(),e.finish(34);case 38:case"end":return e.stop()}}),e,this,[[5,,34,38],[8,20,24,34],[25,,29,33]])})));return function(t){return e.apply(this,arguments)}}()},{key:"all",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nS.trace("all await read lock"),e.next=3,this.store.lock.readLock();case 3:t=e.sent,nS.trace("all got read lock"),e.prev=5,n=[],r=!1,i=!1,e.prev=9,a=(0,y.Z)(this.store.all());case 11:return e.next=13,a.next();case 13:if(!(r=!(u=e.sent).done)){e.next=19;break}c=u.value,n.push(c);case 16:r=!1,e.next=11;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(9),i=!0,o=e.t0;case 25:if(e.prev=25,e.prev=26,!r||null==a.return){e.next=30;break}return e.next=30,a.return();case 30:if(e.prev=30,!i){e.next=33;break}throw o;case 33:return e.finish(30);case 34:return e.finish(25);case 35:return e.abrupt("return",n);case 36:return e.prev=36,nS.trace("all release read lock"),t(),e.finish(36);case 40:case"end":return e.stop()}}),e,this,[[5,,36,40],[9,21,25,35],[26,,30,34]])})));return function(){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nS.trace("delete await write lock"),e.next=3,this.store.lock.writeLock();case 3:return n=e.sent,nS.trace("delete got write lock"),e.prev=5,e.next=8,this.store.delete(t);case 8:return e.prev=8,nS.trace("delete release write lock"),n(),e.finish(8);case 12:case"end":return e.stop()}}),e,this,[[5,,8,12]])})));return function(t){return e.apply(this,arguments)}}()},{key:"has",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nS.trace("has await read lock"),e.next=3,this.store.lock.readLock();case 3:return n=e.sent,nS.trace("has got read lock"),e.prev=5,e.next=8,this.store.has(t);case 8:return e.abrupt("return",e.sent);case 9:return e.prev=9,nS.trace("has release read lock"),n(),e.finish(9);case 13:case"end":return e.stop()}}),e,this,[[5,,9,13]])})));return function(t){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nS.trace("get await read lock"),e.next=3,this.store.lock.readLock();case 3:return n=e.sent,nS.trace("get got read lock"),e.prev=5,e.next=8,this.store.load(t);case 8:return e.abrupt("return",e.sent);case 9:return e.prev=9,nS.trace("get release read lock"),n(),e.finish(9);case 13:case"end":return e.stop()}}),e,this,[[5,,9,13]])})));return function(t){return e.apply(this,arguments)}}()},{key:"save",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nS.trace("save await write lock"),e.next=3,this.store.lock.writeLock();case 3:return r=e.sent,nS.trace("save got write lock"),e.prev=5,e.next=8,this.store.save(t,n);case 8:return i=e.sent,dw(this,rS,oS).call(this,t,i),e.abrupt("return",i.peer);case 11:return e.prev=11,nS.trace("save release write lock"),r(),e.finish(11);case 15:case"end":return e.stop()}}),e,this,[[5,,11,15]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"patch",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nS.trace("patch await write lock"),e.next=3,this.store.lock.writeLock();case 3:return r=e.sent,nS.trace("patch got write lock"),e.prev=5,e.next=8,this.store.patch(t,n);case 8:return i=e.sent,dw(this,rS,oS).call(this,t,i),e.abrupt("return",i.peer);case 11:return e.prev=11,nS.trace("patch release write lock"),r(),e.finish(11);case 15:case"end":return e.stop()}}),e,this,[[5,,11,15]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"merge",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nS.trace("merge await write lock"),e.next=3,this.store.lock.writeLock();case 3:return r=e.sent,nS.trace("merge got write lock"),e.prev=5,e.next=8,this.store.merge(t,n);case 8:return i=e.sent,dw(this,rS,oS).call(this,t,i),e.abrupt("return",i.peer);case 11:return e.prev=11,nS.trace("merge release write lock"),r(),e.finish(11);case 15:case"end":return e.stop()}}),e,this,[[5,,11,15]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"consumePeerRecord",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mE.openAndCertify(t,lx.DOMAIN);case 2:if(i=e.sent,!1!==(null===n||void 0===n?void 0:n.equals(i.peerId))){e.next=6;break}return nS("envelope peer id was not the expected peer id - expected: %p received: %p",n,i.peerId),e.abrupt("return",!1);case 6:return o=lx.createFromProtobuf(i.payload),e.prev=7,e.next=10,this.get(i.peerId);case 10:a=e.sent,e.next=17;break;case 13:if(e.prev=13,e.t0=e.catch(7),"ERR_NOT_FOUND"===e.t0.code){e.next=17;break}throw e.t0;case 17:if(null==(null===(r=a)||void 0===r?void 0:r.peerRecordEnvelope)){e.next=25;break}return e.next=20,mE.createFromProtobuf(a.peerRecordEnvelope);case 20:if(u=e.sent,!((c=lx.createFromProtobuf(u.payload)).seqNumber>=o.seqNumber)){e.next=25;break}return nS("sequence number was lower or equal to existing sequence number - stored: %d received: %d",c.seqNumber,o.seqNumber),e.abrupt("return",!1);case 25:return e.next=27,this.patch(o.peerId,{peerRecordEnvelope:t,addresses:o.multiaddrs.map((function(e){return{isCertified:!0,multiaddr:e}}))});case 27:return e.abrupt("return",!0);case 28:case"end":return e.stop()}}),e,this,[[7,13]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}();function oS(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}function aS(e,t){null==t&&(t=e.reduce((function(e,t){return e+t.length}),0));var n,r=Sm(t),i=0,o=(0,Ae.Z)(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;r.set(a,i),i+=a.length}}catch(s){o.e(s)}finally{o.f()}return _m(r)}var sS=xl.C,uS=xl.aY,cS=function e(t){var n=0;if(t=t.toString().trim(),sS(t)){var r=new Uint8Array(n+4);return t.split(/\./g).forEach((function(e){r[n++]=255&parseInt(e,10)})),r}if(uS(t)){var i,o=t.split(":",8);for(i=0;i<o.length;i++){var a=void 0;sS(o[i])&&(a=e(o[i]),o[i]=Om(a.slice(0,2),"base16")),null!=a&&++i<8&&o.splice(i,0,Om(a.slice(2,4),"base16"))}if(""===o[0])for(;o.length<8;)o.unshift("0");else if(""===o[o.length-1])for(;o.length<8;)o.push("0");else if(o.length<8){for(i=0;i<o.length&&""!==o[i];i++);var s=[i,1];for(i=9-o.length;i>0;i--)s.push("0");o.splice.apply(o,s)}var u=new Uint8Array(n+16);for(i=0;i<o.length;i++){var c=parseInt(o[i],16);u[n++]=c>>8&255,u[n++]=255&c}return u}throw new Error("invalid ip address")},lS=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;n=~~n,r=null!==(t=r)&&void 0!==t?t:e.length-n;var i=new DataView(e.buffer);if(4===r){for(var o=[],a=0;a<r;a++)o.push(e[n+a]);return o.join(".")}if(16===r){for(var s=[],u=0;u<r;u+=2)s.push(i.getUint16(n+u).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},fS=-1,hS={},pS={};function dS(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}function vS(e){if("number"===typeof e){if(null!=pS[e])return pS[e];throw new Error("no protocol with code: ".concat(e))}if("string"===typeof e){if(null!=hS[e])return hS[e];throw new Error("no protocol with name: ".concat(e))}throw new Error("invalid protocol id type: ".concat(typeof e))}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,fS,"ip6zone"],[43,8,"ipcidr"],[53,fS,"dns",!0],[54,fS,"dns4",!0],[55,fS,"dns6",!0],[56,fS,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,fS,"unix",!1,!0],[421,fS,"ipfs"],[421,fS,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,fS,"garlic64"],[448,0,"tls"],[449,fS,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,fS,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,fS,"memory"]].forEach((function(e){var t=dS.apply(void 0,(0,ye.Z)(e));pS[t.code]=t,hS[t.name]=t}));vS("ip4"),vS("ip6"),vS("ipcidr");function yS(e,t){switch(vS(e).code){case 4:case 41:return function(e){var t=lS(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!xl.h6(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return _S(t);case 6:case 273:case 33:case 132:return ES(t).toString();case 421:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return Om(n,"base58btc")}(t);case 444:case 445:return SS(t);case 466:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+Om(n,"base64url")}(t);default:return Om(t,"base16")}}function gS(e,t){switch(vS(e).code){case 4:case 41:return wS(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return xS(t);case 6:case 273:case 33:case 132:return kS(parseInt(t,10));case 421:return function(e){var t;t="Q"===e[0]||"1"===e[0]?b.decode(gr.base58btc.decode("z".concat(e))).bytes:c.CID.parse(e).multihash.bytes;var n=Uint8Array.from(A().encode(t.length));return aS([n,t],n.length+t.length)}(t);case 444:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(16!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion address."));var n=kl.base32.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=kS(r);return aS([n,i],n.length+i.length)}(t);case 445:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(56!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion3 address."));var n=kl.base32.decode("b".concat(t[0])),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=kS(r);return aS([n,i],n.length+i.length)}(t);case 466:return function(e){var t=bS.decode(e),n=Uint8Array.from(A().encode(t.length));return aS([n,t],n.length+t.length)}(t);default:return Dm(t,"base16")}}var mS=Object.values(cr.gh).map((function(e){return e.decoder})),bS=function(){var e=mS[0].or(mS[1]);return mS.slice(2).forEach((function(t){return e=e.or(t)})),e}();function wS(e){if(!xl.h6(e))throw new Error("invalid ip address");return cS(e)}function kS(e){var t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function ES(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function xS(e){var t=Dm(e),n=Uint8Array.from(A().encode(t.length));return aS([n,t],n.length+t.length)}function _S(e){var t=A().decode(e);if((e=e.slice(A().decode.bytes)).length!==t)throw new Error("inconsistent lengths");return Om(e)}function SS(e){var t=e.slice(0,e.length-2),n=e.slice(e.length-2),r=Om(t,"base32"),i=ES(n);return"".concat(r,":").concat(i)}function AS(e){return e.map((function(e){var t=NS(e);return null!=e[1]?[t.code,yS(t.code,e[1])]:[t.code]}))}function ZS(e){return OS(aS(e.map((function(e){var t=NS(e),n=Uint8Array.from(A().encode(t.code));return e.length>1&&null!=e[1]&&(n=aS([n,e[1]])),n}))))}function TS(e,t){return e.size>0?e.size/8:0===e.size?0:A().decode(t)+(null!==(n=A().decode.bytes)&&void 0!==n?n:0);var n}function CS(e){for(var t=[],n=0;n<e.length;){var r,i=A().decode(e,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0,a=TS(vS(i),e.slice(n+o));if(0!==a){var s=e.slice(n+o,n+o+a);if((n+=a+o)>e.length)throw LS("Invalid address Uint8Array: "+Om(e,"base16"));t.push([i,s])}else t.push([i]),n+=o}return t}function IS(e){return function(e){var t=[];return e.map((function(e){var n=NS(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),PS(t.join("/"))}(AS(CS(e)))}function DS(e){var t=function(e){var t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(var r=0;r<n.length;r++){var i=n[r],o=vS(i);if(0!==o.size){if(++r>=n.length)throw LS("invalid address: "+e);if(!0===o.path){t.push([i,PS(n.slice(r).join("/"))]);break}t.push([i,n[r]])}else t.push([i])}return t}(e=PS(e));return ZS(t.map((function(e){Array.isArray(e)||(e=[e]);var t=NS(e);return e.length>1?[t.code,gS(t.code,e[1])]:[t.code]})))}function OS(e){var t=RS(e);if(null!=t)throw t;return Uint8Array.from(e)}function RS(e){try{CS(e)}catch(t){return t}}function PS(e){return"/"+e.trim().split("/").filter((function(e){return e})).join("/")}function LS(e){return new Error("Error parsing address: "+e)}function NS(e){return vS(e[0])}var BS=Symbol.for("nodejs.util.inspect.custom"),MS=[vS("dns").code,vS("dns4").code,vS("dns6").code,vS("dnsaddr").code],FS=new Map,jS=Symbol.for("@multiformats/js-multiaddr/multiaddr");function US(e){return Boolean(null===e||void 0===e?void 0:e[jS])}var zS=new WeakMap,HS=new WeakMap,VS=new WeakMap,GS=new WeakMap,KS=function(){function e(t){if((0,K.Z)(this,e),(0,ot.Z)(this,"bytes",void 0),(0,cl.Z)(this,zS,{writable:!0,value:void 0}),(0,cl.Z)(this,HS,{writable:!0,value:void 0}),(0,cl.Z)(this,VS,{writable:!0,value:void 0}),(0,cl.Z)(this,GS,{writable:!0,value:void 0}),(0,ot.Z)(this,jS,!0),null==t&&(t=""),t instanceof Uint8Array)this.bytes=OS(t);else if("string"===typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error('multiaddr "'.concat(t,'" must start with a "/"'));this.bytes=DS(t)}else{if(!US(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=OS(t.bytes)}}return(0,W.Z)(e,[{key:"toString",value:function(){return null==(0,fl.Z)(this,zS)&&(0,ll.Z)(this,zS,IS(this.bytes)),(0,fl.Z)(this,zS)}},{key:"toJSON",value:function(){return this.toString()}},{key:"toOptions",value:function(){var e,t,n,r,i,o="",a=vS("tcp"),s=vS("udp"),u=vS("ip4"),c=vS("ip6"),l=vS("dns6"),f=vS("ip6zone"),h=(0,Ae.Z)(this.stringTuples());try{for(h.s();!(i=h.n()).done;){var p=(0,k.Z)(i.value,2),d=p[0],v=p[1];d===f.code&&(o="%".concat(null!==v&&void 0!==v?v:"")),MS.includes(d)&&(t=a.name,r=443,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===l.code?6:4),d!==a.code&&d!==s.code||(t=vS(d).name,r=parseInt(null!==v&&void 0!==v?v:"")),d!==u.code&&d!==c.code||(t=vS(d).name,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===c.code?6:4)}}catch(y){h.e(y)}finally{h.f()}if(null==e||null==t||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:r}}},{key:"protos",value:function(){return this.protoCodes().map((function(e){return Object.assign({},vS(e))}))}},{key:"protoCodes",value:function(){for(var e=[],t=this.bytes,n=0;n<t.length;){var r,i=A().decode(t,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0;n+=TS(vS(i),t.slice(n+o))+o,e.push(i)}return e}},{key:"protoNames",value:function(){return this.protos().map((function(e){return e.name}))}},{key:"tuples",value:function(){return null==(0,fl.Z)(this,HS)&&(0,ll.Z)(this,HS,CS(this.bytes)),(0,fl.Z)(this,HS)}},{key:"stringTuples",value:function(){return null==(0,fl.Z)(this,VS)&&(0,ll.Z)(this,VS,AS(this.tuples())),(0,fl.Z)(this,VS)}},{key:"encapsulate",value:function(t){return t=new e(t),new e(this.toString()+t.toString())}},{key:"decapsulate",value:function(t){var n=t.toString(),r=this.toString(),i=r.lastIndexOf(n);if(i<0)throw new Error("Address ".concat(this.toString()," does not contain subaddress: ").concat(t.toString()));return new e(r.slice(0,i))}},{key:"decapsulateCode",value:function(t){for(var n=this.tuples(),r=n.length-1;r>=0;r--)if(n[r][0]===t)return new e(ZS(n.slice(0,r)));return this}},{key:"getPeerId",value:function(){try{var e=this.stringTuples().filter((function(e){return e[0]===hS.ipfs.code})),t=e.pop();if(null!=(null===t||void 0===t?void 0:t[1])){var n=t[1];return"Q"===n[0]||"1"===n[0]?Om(gr.base58btc.decode("z".concat(n)),"base58btc"):Om(c.CID.parse(n).multihash.bytes,"base58btc")}return null}catch(r){return null}}},{key:"getPath",value:function(){if(void 0===(0,fl.Z)(this,GS))try{(0,ll.Z)(this,GS,this.stringTuples().filter((function(e){return!0===vS(e[0]).path}))[0][1]),null==(0,fl.Z)(this,GS)&&(0,ll.Z)(this,GS,null)}catch(e){(0,ll.Z)(this,GS,null)}return(0,fl.Z)(this,GS)}},{key:"equals",value:function(e){return lb(this.bytes,e.bytes)}},{key:"resolve",value:function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=(r=this.protos().find((function(e){return e.resolvable})))){t.next=3;break}return t.abrupt("return",[this]);case 3:if(null!=(i=FS.get(r.name))){t.next=6;break}throw new ar.s("no available resolver for ".concat(r.name),"ERR_NO_AVAILABLE_RESOLVER");case 6:return t.next=8,i(this,n);case 8:return o=t.sent,t.abrupt("return",o.map((function(t){return new e(t)})));case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"nodeAddress",value:function(){var e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error('multiaddr must have a valid format - no protocol with name: "'.concat(e.transport,'". Must have a valid transport protocol: "{tcp, udp}"'));return{family:e.family,address:e.host,port:e.port}}},{key:"isThinWaistAddress",value:function(e){var t=(null!==e&&void 0!==e?e:this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}},{key:BS,value:function(){return"Multiaddr(".concat(IS(this.bytes),")")}}]),e}();function WS(e){return new KS(e)}var qS=(0,ru.kg)("libp2p:address-manager"),YS=function(e){return e};function QS(e,t){var n=e.getPeerId();null!=n&&((0,Ps.jE)(n).equals(t)&&(e=e.decapsulate(WS("/p2p/".concat(t.toString())))));return e}var XS=function(){function e(t){var n,r=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"listen",void 0),(0,ot.Z)(this,"announce",void 0),(0,ot.Z)(this,"observed",void 0),(0,ot.Z)(this,"announceFilter",void 0);var o=i.listen,a=void 0===o?[]:o,s=i.announce,u=void 0===s?[]:s;this.components=t,this.listen=a.map((function(e){return e.toString()})),this.announce=new Set(u.map((function(e){return e.toString()}))),this.observed=new Map,this.announceFilter=null!==(n=i.announceFilter)&&void 0!==n?n:YS,this._updatePeerStoreAddresses=function(e,t){var n;return function(){clearTimeout(n),n=setTimeout((function(){n=void 0,e()}),t)}}(this._updatePeerStoreAddresses.bind(this),1e3),t.events.addEventListener("transport:listening",(function(){r._updatePeerStoreAddresses()})),t.events.addEventListener("transport:close",(function(){r._updatePeerStoreAddresses()}))}return(0,W.Z)(e,[{key:"_updatePeerStoreAddresses",value:function(){var e=this,t=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat((0,ye.Z)(this.observed.entries()).filter((function(e){var t=(0,k.Z)(e,2);t[0];return t[1].confident})).map((function(e){return WS((0,k.Z)(e,1)[0])}))).map((function(t){return t.getPeerId()===e.components.peerId.toString()?t.decapsulate("/p2p/".concat(e.components.peerId.toString())):t}));this.components.peerStore.patch(this.components.peerId,{multiaddrs:t}).catch((function(e){qS.error("error updating addresses",e)}))}},{key:"getListenAddrs",value:function(){return Array.from(this.listen).map((function(e){return WS(e)}))}},{key:"getAnnounceAddrs",value:function(){return Array.from(this.announce).map((function(e){return WS(e)}))}},{key:"getObservedAddrs",value:function(){return Array.from(this.observed).map((function(e){return WS((0,k.Z)(e,1)[0])}))}},{key:"addObservedAddr",value:function(e){var t=(e=QS(e,this.components.peerId)).toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}},{key:"confirmObservedAddr",value:function(e){var t,n=(e=QS(e,this.components.peerId)).toString(),r=(null!==(t=this.observed.get(n))&&void 0!==t?t:{confident:!1}).confident;this.observed.set(n,{confident:!0}),r||this._updatePeerStoreAddresses()}},{key:"removeObservedAddr",value:function(e){var t=(e=QS(e,this.components.peerId)).toString();this.observed.delete(t)}},{key:"getAddresses",value:function(){var e=this,t=this.getAnnounceAddrs().map((function(e){return e.toString()}));0===t.length&&(t=this.components.transportManager.getAddrs().map((function(e){return e.toString()}))),t=t.concat(Array.from(this.observed).filter((function(e){var t=(0,k.Z)(e,2);t[0];return t[1].confident})).map((function(e){return(0,k.Z)(e,1)[0]})));var n=new Set(t);return this.announceFilter(Array.from(n).map((function(e){return WS(e)}))).map((function(t){var n;return!0===(null===(n=t.protos().pop())||void 0===n?void 0:n.path)||t.getPeerId()===e.components.peerId.toString()?t:t.encapsulate("/p2p/".concat(e.components.peerId.toString()))}))}}]),e}();function $S(e){return null!=e&&"function"===typeof e.start&&"function"===typeof e.stop}var JS=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"components",{}),(0,ot.Z)(this,"_started",!1),this.components={};for(var n=0,r=Object.entries(t);n<r.length;n++){var i=(0,k.Z)(r[n],2),o=i[0],a=i[1];this.components[o]=a}}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this._started}},{key:"_invokeStartableMethod",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(Object.values(this.components).filter((function(e){return $S(e)})).map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(r=n[t])||void 0===r?void 0:r.call(n);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"beforeStart",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("beforeStart");case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("start");case 2:this._started=!0;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"afterStart",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("afterStart");case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"beforeStop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("beforeStop");case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("stop");case 2:this._started=!1;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"afterStop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._invokeStartableMethod("afterStop");case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),eA=["metrics","connectionProtector"],tA=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];var nA=n(27922),rA="[a-fA-F\\d:]",iA=function(e){return e&&e.includeBoundaries?"(?:(?<=\\s|^)(?=".concat(rA,")|(?<=").concat(rA,")(?=\\s|$))"):""},oA="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",aA="[a-fA-F\\d]{1,4}",sA="\n(?:\n(?:".concat(aA,":){7}(?:").concat(aA,"|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8\n(?:").concat(aA,":){6}(?:").concat(oA,"|:").concat(aA,"|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4\n(?:").concat(aA,":){5}(?::").concat(oA,"|(?::").concat(aA,"){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4\n(?:").concat(aA,":){4}(?:(?::").concat(aA,"){0,1}:").concat(oA,"|(?::").concat(aA,"){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4\n(?:").concat(aA,":){3}(?:(?::").concat(aA,"){0,2}:").concat(oA,"|(?::").concat(aA,"){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4\n(?:").concat(aA,":){2}(?:(?::").concat(aA,"){0,3}:").concat(oA,"|(?::").concat(aA,"){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4\n(?:").concat(aA,":){1}(?:(?::").concat(aA,"){0,4}:").concat(oA,"|(?::").concat(aA,"){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4\n(?::(?:(?::").concat(aA,"){0,5}:").concat(oA,"|(?::").concat(aA,"){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4\n)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1\n").replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),uA=new RegExp("(?:^".concat(oA,"$)|(?:^").concat(sA,"$)")),cA=new RegExp("^".concat(oA,"$")),lA=new RegExp("^".concat(sA,"$")),fA=function(e){return e&&e.exact?uA:new RegExp("(?:".concat(iA(e)).concat(oA).concat(iA(e),")|(?:").concat(iA(e)).concat(sA).concat(iA(e),")"),"g")};fA.v4=function(e){return e&&e.exact?cA:new RegExp("".concat(iA(e)).concat(oA).concat(iA(e)),"g")},fA.v6=function(e){return e&&e.exact?lA:new RegExp("".concat(iA(e)).concat(sA).concat(iA(e)),"g")};var hA=fA,pA=n(87201),dA=n.n(pA),vA=dA().isValid,yA=dA().parse,gA=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map((function(e){return new nA.Netmask(e)}));function mA(e){return/^::$/.test(e)||/^::1$/.test(e)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(e)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(e)||/^ff([0-9a-fA-F]{2,2}):/i.test(e)}var bA=function(e){if(vA(e)){var t=yA(e);if("ipv4"===t.kind())return function(e){var t,n=(0,Ae.Z)(gA);try{for(n.s();!(t=n.n()).done;)if(t.value.contains(e))return!0}catch(r){n.e(r)}finally{n.f()}return!1}(t.toNormalizedString());if("ipv6"===t.kind())return mA(e)}else if((0,xl.h6)(e)&&hA.v6().test(e))return mA(e)};function wA(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,Nt.Z)({denyDialPeer:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyDialMultiaddr:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(4!==(n=t.stringTuples())[0][0]&&41!==n[0][0]){e.next=3;break}return e.abrupt("return",Boolean(bA("".concat(n[0][1]))));case 3:return e.abrupt("return",!1);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),denyInboundConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyOutboundConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyInboundEncryptedConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyOutboundEncryptedConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyInboundUpgradedConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),denyOutboundUpgradedConnection:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),filterMultiaddrForPeer:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!0);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},e)}function kA(e){try{var t=e.nodeAddress().address;return Boolean(bA(t))}catch(n){return!0}}function EA(e,t){var n=kA(e.multiaddr),r=kA(t.multiaddr);return n&&!r?1:!n&&r||e.isCertified&&!t.isCertified?-1:!e.isCertified&&t.isCertified?1:0}var xA=n(18392),_A=n.n(xA),SA=n(449),AA=n.n(SA),ZA=globalThis.fetch,TA=globalThis.Headers;globalThis.Request,globalThis.Response;function CA(e,t,n){return"".concat(e,"?name=").concat(t,"&type=").concat(n)}function IA(e,t){return DA.apply(this,arguments)}function DA(){return(DA=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ZA(t,{headers:new TA({accept:"application/dns-json"}),signal:n});case 2:return r=e.sent,e.next=5,r.json();case 5:return i=e.sent,e.abrupt("return",i);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function OA(e,t){return"".concat(t,"_").concat(e)}var RA,PA,LA=Object.assign(_A()("dns-over-http-resolver"),{error:_A()("dns-over-http-resolver:error")}),NA=function(){function e(){var t,n,r,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this._cache=new(AA())({max:null!==(t=null===i||void 0===i?void 0:i.maxCache)&&void 0!==t?t:100}),this._TXTcache=new(AA())({max:null!==(n=null===i||void 0===i?void 0:i.maxCache)&&void 0!==n?n:100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=null!==(r=i.request)&&void 0!==r?r:IA,this._abortControllers=[]}return(0,W.Z)(e,[{key:"cancel",value:function(){this._abortControllers.forEach((function(e){return e.abort()}))}},{key:"getServers",value:function(){return this._servers}},{key:"_getShuffledServers",value:function(){for(var e=(0,ye.Z)(this._servers),t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*t),r=e[t];e[t]=e[n],e[n]=r}return e}},{key:"setServers",value:function(e){this._servers=e}},{key:"resolve",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=r.length>1&&void 0!==r[1]?r[1]:"A",e.t0=n,e.next="A"===e.t0?4:"AAAA"===e.t0?7:"TXT"===e.t0?10:13;break;case 4:return e.next=6,this.resolve4(t);case 6:case 9:case 12:return e.abrupt("return",e.sent);case 7:return e.next=9,this.resolve6(t);case 10:return e.next=12,this.resolveTxt(t);case 13:throw new Error("".concat(n," is not supported"));case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"resolve4",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n="A",null==(r=this._cache.get(OA(t,n)))){e.next=4;break}return e.abrupt("return",r);case 4:i=!1,o=(0,Ae.Z)(this._getShuffledServers()),e.prev=6,u=(0,s.Z)().mark((function e(){var r,o,u,c,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.value,o=new AbortController,l._abortControllers.push(o),e.prev=3,e.next=6,l._request(CA(r,t,n),o.signal);case 6:return u=e.sent,c=u.Answer.map((function(e){return e.data})),f=Math.min.apply(Math,(0,ye.Z)(u.Answer.map((function(e){return e.TTL})))),l._cache.set(OA(t,n),c,{ttl:f}),e.abrupt("return",{v:c});case 13:e.prev=13,e.t0=e.catch(3),o.signal.aborted&&(i=!0),LA.error("".concat(r," could not resolve ").concat(t," record ").concat(n));case 17:return e.prev=17,l._abortControllers=l._abortControllers.filter((function(e){return e!==o})),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[3,13,17,20]])})),o.s();case 9:if((a=o.n()).done){e.next=16;break}return e.delegateYield(u(),"t0",11);case 11:if("object"!==typeof(c=e.t0)){e.next=14;break}return e.abrupt("return",c.v);case 14:e.next=9;break;case 16:e.next=21;break;case 18:e.prev=18,e.t1=e.catch(6),o.e(e.t1);case 21:return e.prev=21,o.f(),e.finish(21);case 24:if(!i){e.next=26;break}throw Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"});case 26:throw new Error("Could not resolve ".concat(t," record ").concat(n));case 27:case"end":return e.stop()}}),e,this,[[6,18,21,24]])})));return function(t){return e.apply(this,arguments)}}()},{key:"resolve6",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n="AAAA",null==(r=this._cache.get(OA(t,n)))){e.next=4;break}return e.abrupt("return",r);case 4:i=!1,o=(0,Ae.Z)(this._getShuffledServers()),e.prev=6,u=(0,s.Z)().mark((function e(){var r,o,u,c,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.value,o=new AbortController,l._abortControllers.push(o),e.prev=3,e.next=6,l._request(CA(r,t,n),o.signal);case 6:return u=e.sent,c=u.Answer.map((function(e){return e.data})),f=Math.min.apply(Math,(0,ye.Z)(u.Answer.map((function(e){return e.TTL})))),l._cache.set(OA(t,n),c,{ttl:f}),e.abrupt("return",{v:c});case 13:e.prev=13,e.t0=e.catch(3),o.signal.aborted&&(i=!0),LA.error("".concat(r," could not resolve ").concat(t," record ").concat(n));case 17:return e.prev=17,l._abortControllers=l._abortControllers.filter((function(e){return e!==o})),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[3,13,17,20]])})),o.s();case 9:if((a=o.n()).done){e.next=16;break}return e.delegateYield(u(),"t0",11);case 11:if("object"!==typeof(c=e.t0)){e.next=14;break}return e.abrupt("return",c.v);case 14:e.next=9;break;case 16:e.next=21;break;case 18:e.prev=18,e.t1=e.catch(6),o.e(e.t1);case 21:return e.prev=21,o.f(),e.finish(21);case 24:if(!i){e.next=26;break}throw Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"});case 26:throw new Error("Could not resolve ".concat(t," record ").concat(n));case 27:case"end":return e.stop()}}),e,this,[[6,18,21,24]])})));return function(t){return e.apply(this,arguments)}}()},{key:"resolveTxt",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n="TXT",null==(r=this._TXTcache.get(OA(t,n)))){e.next=4;break}return e.abrupt("return",r);case 4:i=!1,o=(0,Ae.Z)(this._getShuffledServers()),e.prev=6,u=(0,s.Z)().mark((function e(){var r,o,u,c,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.value,o=new AbortController,l._abortControllers.push(o),e.prev=3,e.next=6,l._request(CA(r,t,n),o.signal);case 6:return u=e.sent,c=u.Answer.map((function(e){return[e.data.replace(/['"]+/g,"")]})),f=Math.min.apply(Math,(0,ye.Z)(u.Answer.map((function(e){return e.TTL})))),l._TXTcache.set(OA(t,n),c,{ttl:f}),e.abrupt("return",{v:c});case 13:e.prev=13,e.t0=e.catch(3),o.signal.aborted&&(i=!0),LA.error("".concat(r," could not resolve ").concat(t," record ").concat(n));case 17:return e.prev=17,l._abortControllers=l._abortControllers.filter((function(e){return e!==o})),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[3,13,17,20]])})),o.s();case 9:if((a=o.n()).done){e.next=16;break}return e.delegateYield(u(),"t0",11);case 11:if("object"!==typeof(c=e.t0)){e.next=14;break}return e.abrupt("return",c.v);case 14:e.next=9;break;case 16:e.next=21;break;case 18:e.prev=18,e.t1=e.catch(6),o.e(e.t1);case 21:return e.prev=21,o.f(),e.finish(21);case 24:if(!i){e.next=26;break}throw Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"});case 26:throw new Error("Could not resolve ".concat(t," record ").concat(n));case 27:case"end":return e.stop()}}),e,this,[[6,18,21,24]])})));return function(t){return e.apply(this,arguments)}}()},{key:"clearCache",value:function(){this._cache.clear(),this._TXTcache.clear()}}]),e}(),BA=NA,MA=BA,FA=vS("dnsaddr").code;function jA(e){return UA.apply(this,arguments)}function UA(){return UA=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=h.length>1&&void 0!==h[1]?h[1]:{},i=new MA,null!=r.signal&&r.signal.addEventListener("abort",(function(){i.cancel()})),o=t.getPeerId(),a=null!==(n=t.stringTuples().find((function(e){return(0,k.Z)(e,1)[0]===FA})))&&void 0!==n?n:[],u=(0,k.Z)(a,2),null!=(c=u[1])){e.next=7;break}throw new Error("No hostname found in multiaddr");case 7:return e.next=9,i.resolveTxt("_dnsaddr.".concat(c));case 9:return l=e.sent,f=l.flat().map((function(e){return e.split("=")[1]})).filter(Boolean),null!=o&&(f=f.filter((function(e){return e.includes(o)}))),e.abrupt("return",f);case 13:case"end":return e.stop()}}),e)}))),UA.apply(this,arguments)}!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.DHT_DISABLED="DHT is not available",e.PUBSUB_DISABLED="PubSub is not available",e.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",e.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(RA||(RA={})),function(e){e.DHT_DISABLED="ERR_DHT_DISABLED",e.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",e.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",e.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",e.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",e.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",e.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",e.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",e.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",e.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",e.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",e.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",e.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",e.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",e.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",e.ERR_DIALED_SELF="ERR_DIALED_SELF",e.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",e.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",e.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",e.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",e.ERR_INVALID_KEY="ERR_INVALID_KEY",e.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_PEER="ERR_INVALID_PEER",e.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",e.ERR_NOT_FOUND="ERR_NOT_FOUND",e.ERR_TIMEOUT="ERR_TIMEOUT",e.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",e.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",e.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",e.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",e.ERR_FIND_SELF="ERR_FIND_SELF",e.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",e.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",e.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",e.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",e.ERR_INVALID_CMS="ERR_INVALID_CMS",e.ERR_MISSING_KEYS="ERR_MISSING_KEYS",e.ERR_NO_KEY="ERR_NO_KEY",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",e.ERR_INVALID_RECORD="ERR_INVALID_RECORD",e.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",e.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",e.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"}(PA||(PA={}));var zA={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:function(e){return e}},connectionManager:{resolvers:{dnsaddr:jA},addressSorter:EA},transportManager:{faultTolerance:sl.FATAL_ALL}};function HA(e){var t,n,r=(0,mk.Z)(zA,e);if(null==r.transports||r.transports.length<1)throw new ar.s(RA.ERR_TRANSPORTS_REQUIRED,PA.ERR_TRANSPORTS_REQUIRED);if(null===r.connectionProtector&&null!=(null===(t=globalThis.process)||void 0===t||null===(n=t.env)||void 0===n?void 0:n.LIBP2P_FORCE_PNET))throw new ar.s(RA.ERR_PROTECTOR_REQUIRED,PA.ERR_PROTECTOR_REQUIRED);return r}var VA="keep-alive",GA=(0,ru.kg)("libp2p:get-peer");function KA(e){if((0,P_.I)(e))return{peerId:e,multiaddrs:[]};var t;if(Array.isArray(e)||(e=[e]),e.length>0){var n=e[0].getPeerId();t=null==n?void 0:(0,Ps.jE)(n),e.forEach((function(e){if(!US(e))throw GA.error("multiaddr %s was invalid",e),new ar.s("Invalid Multiaddr",PA.ERR_INVALID_MULTIADDR);var n=e.getPeerId();if(null==n){if(null!=t)throw new ar.s("Multiaddrs must all have the same peer id or have no peer id",PA.ERR_INVALID_PARAMETERS)}else{var r=(0,Ps.jE)(n);if(null==t||!t.equals(r))throw new ar.s("Multiaddrs must all have the same peer id or have no peer id",PA.ERR_INVALID_PARAMETERS)}}))}return{peerId:t,multiaddrs:e}}var WA=(0,ru.kg)("libp2p:connection-manager:auto-dial"),qA=50,YA=25,QA=0,XA=5e3,$A=function(){function e(t,n){var r,i,o,a,s=this;(0,K.Z)(this,e),(0,ot.Z)(this,"connectionManager",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"queue",void 0),(0,ot.Z)(this,"minConnections",void 0),(0,ot.Z)(this,"autoDialPriority",void 0),(0,ot.Z)(this,"autoDialIntervalMs",void 0),(0,ot.Z)(this,"autoDialInterval",void 0),(0,ot.Z)(this,"started",void 0),this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.minConnections=null!==(r=n.minConnections)&&void 0!==r?r:qA,this.autoDialPriority=null!==(i=n.autoDialPriority)&&void 0!==i?i:QA,this.autoDialIntervalMs=null!==(o=n.autoDialInterval)&&void 0!==o?o:XA,this.started=!1,this.queue=new uc.Z({concurrency:null!==(a=n.autoDialConcurrency)&&void 0!==a?a:YA}),this.queue.addListener("error",(function(e){WA.error("error during auto-dial",e)})),t.events.addEventListener("connection:close",(function(){s.autoDial().catch((function(e){WA.error(e)}))}))}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=this;this.autoDialInterval=setInterval((function(){e.autoDial().catch((function(e){WA.error("error while autodialing",e)}))}),this.autoDialIntervalMs),this.started=!0}},{key:"afterStart",value:function(){this.autoDial().catch((function(e){WA.error("error while autodialing",e)}))}},{key:"stop",value:function(){this.queue.clear(),clearInterval(this.autoDialInterval),this.started=!1}},{key:"autoDial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,c,l,f,h,p,d,v,y,g=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started){e.next=2;break}return e.abrupt("return");case 2:if(t=this.connectionManager.getConnectionsMap(),n=t.size,r=new Xk(this.connectionManager.getDialQueue().map((function(e){return e.peerId})).filter(Boolean)),!(n>=this.minConnections)){e.next=8;break}return WA.trace("have enough connections %d/%d",n,this.minConnections),e.abrupt("return");case 8:return WA("not enough connections %d/%d - will dial peers to increase the number of connections",n,this.minConnections),e.next=11,this.peerStore.all();case 11:i=e.sent,o=i.filter((function(e){return 0!==e.addresses.length&&(!t.has(e.id)&&!r.has(e.id))})),a=o.sort((function(){return Math.random()>.5?1:-1})),c=new Qk,l=(0,Ae.Z)(a),e.prev=16,l.s();case 18:if((f=l.n()).done){e.next=25;break}if(h=f.value,!c.has(h.id)){e.next=22;break}return e.abrupt("continue",23);case 22:c.set(h.id,(0,ye.Z)(h.tags.values()).reduce((function(e,t){return e+t.value}),0));case 23:e.next=18;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(16),l.e(e.t0);case 30:return e.prev=30,l.f(),e.finish(30);case 33:p=a.sort((function(e,t){var n,r,i=null!==(n=c.get(e.id))&&void 0!==n?n:0,o=null!==(r=c.get(t.id))&&void 0!==r?r:0;return i>o?-1:i<o?1:0})),WA("selected %d/%d peers to dial",p.length,i.length),d=(0,Ae.Z)(p),e.prev=36,y=(0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=v.value,g.queue.add((0,u.Z)((0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((n=g.connectionManager.getConnectionsMap().size)>=g.minConnections)){e.next=5;break}return WA("got enough connections now %d/%d",n,g.minConnections),g.queue.clear(),e.abrupt("return");case 5:return WA("connecting to a peerStore stored peer %p",t.id),e.next=8,g.connectionManager.openConnection(t.id,{priority:g.autoDialPriority});case 8:case"end":return e.stop()}}),e)})))).catch((function(e){WA.error("could not connect to peerStore stored peer",e)}));case 2:case"end":return e.stop()}}),e)})),d.s();case 39:if((v=d.n()).done){e.next=43;break}return e.delegateYield(y(),"t1",41);case 41:e.next=39;break;case 43:e.next=48;break;case 45:e.prev=45,e.t2=e.catch(36),d.e(e.t2);case 48:return e.prev=48,d.f(),e.finish(48);case 51:case"end":return e.stop()}}),e,this,[[16,27,30,33],[36,45,48,51]])})));return function(){return e.apply(this,arguments)}}()}]),e}(),JA=(0,ru.kg)("libp2p:connection-manager:connection-pruner"),eZ={maxConnections:300,allow:[]},tZ=function(){function e(t){var n,r,i=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"maxConnections",void 0),(0,ot.Z)(this,"connectionManager",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"allow",void 0),(0,ot.Z)(this,"events",void 0),this.maxConnections=null!==(n=o.maxConnections)&&void 0!==n?n:eZ.maxConnections,this.allow=null!==(r=o.allow)&&void 0!==r?r:eZ.allow,this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,t.events.addEventListener("connection:open",(function(){i.maybePruneConnections().catch((function(e){JA.error(e)}))}))}return(0,W.Z)(e,[{key:"maybePruneConnections",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,c,l,f,h,p,d,v,y,g=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.connectionManager.getConnections(),n=t.length,r=Math.max(n-this.maxConnections,0),JA("checking max connections limit %d/%d",n,this.maxConnections),!(n<=this.maxConnections)){e.next=6;break}return e.abrupt("return");case 6:JA("max connections limit exceeded %d/%d, pruning %d connection(s)",n,this.maxConnections,r),i=new Qk,o=(0,Ae.Z)(t),e.prev=9,o.s();case 11:if((a=o.n()).done){e.next=29;break}if(c=a.value,l=c.remotePeer,!i.has(l)){e.next=16;break}return e.abrupt("continue",27);case 16:return i.set(l,0),e.prev=17,e.next=20,this.peerStore.get(l);case 20:f=e.sent,i.set(l,(0,ye.Z)(f.tags.values()).reduce((function(e,t){return e+t.value}),0)),e.next=27;break;case 24:e.prev=24,e.t0=e.catch(17),"ERR_NOT_FOUND"!==e.t0.code&&JA.error("error loading peer tags",e.t0);case 27:e.next=11;break;case 29:e.next=34;break;case 31:e.prev=31,e.t1=e.catch(9),o.e(e.t1);case 34:return e.prev=34,o.f(),e.finish(34);case 37:h=t.sort((function(e,t){var n,r,o=null!==(n=i.get(e.remotePeer))&&void 0!==n?n:0,a=null!==(r=i.get(t.remotePeer))&&void 0!==r?r:0;if(o>a)return 1;if(o<a)return-1;var s=e.stat.timeline.open,u=t.stat.timeline.open;return s<u?1:s>u?-1:0})),p=[],d=(0,Ae.Z)(h),e.prev=40,y=(0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=v.value,JA("too many connections open - closing a connection to %p",t.remotePeer),g.allow.some((function(e){return t.remoteAddr.toString().startsWith(e.toString())}))||p.push(t),p.length!==r){e.next=6;break}return e.abrupt("return","break");case 6:case"end":return e.stop()}}),e)})),d.s();case 43:if((v=d.n()).done){e.next=50;break}return e.delegateYield(y(),"t2",45);case 45:if("break"!==e.t2){e.next=48;break}return e.abrupt("break",50);case 48:e.next=43;break;case 50:e.next=55;break;case 52:e.prev=52,e.t3=e.catch(40),d.e(e.t3);case 55:return e.prev=55,d.f(),e.finish(55);case 58:return e.next=60,Promise.all(p.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.close();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),JA.error(e.t0);case 8:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()));case 60:this.events.safeDispatchEvent("connection:prune",{detail:p});case 61:case"end":return e.stop()}}),e,this,[[9,31,34,37],[17,24],[40,52,55,58]])})));return function(){return e.apply(this,arguments)}}()}]),e}(),nZ=(0,ru.kg)("libp2p:connection-manager:utils");function rZ(e,t){return iZ.apply(this,arguments)}function iZ(){return iZ=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.protoNames().includes("dnsaddr")){e.next=3;break}return e.abrupt("return",[t]);case 3:return e.next=5,oZ(t,n);case 5:return r=e.sent,e.next=8,Promise.all(r.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",rZ(t,n));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:return i=e.sent,o=i.flat(),a=o.reduce((function(e,t){return null==e.find((function(e){return e.equals(t)}))&&e.push(t),e}),[]),nZ("resolved %s to",t,a.map((function(e){return e.toString()}))),e.abrupt("return",a);case 13:case"end":return e.stop()}}),e)}))),iZ.apply(this,arguments)}function oZ(e,t){return aZ.apply(this,arguments)}function aZ(){return(aZ=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=WS(t.toString()),e.next=4,t.resolve(n);case 4:return r=e.sent,e.abrupt("return",r);case 8:return e.prev=8,e.t0=e.catch(0),nZ.error("multiaddr ".concat(t.toString()," could not be resolved"),e.t0),e.abrupt("return",[]);case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))).apply(this,arguments)}function sZ(){for(var e=[],t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var i=0,o=n;i<o.length;i++){var a=o[i];if(null!=a){try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,a)}catch(u){}e.push(a)}}var s=nb(e);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,s)}catch(c){}return s}var uZ=(0,ru.kg)("libp2p:connection-manager:dial-queue"),cZ={addressSorter:EA,maxParallelDials:100,maxPeerAddrsToDial:25,maxParallelDialsPerPeer:10,dialTimeout:3e4,resolvers:{dnsaddr:jA}},lZ=function(){function e(t){var n,r,i,o,a,s,u,c=this,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"pendingDials",void 0),(0,ot.Z)(this,"queue",void 0),(0,ot.Z)(this,"peerId",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"connectionGater",void 0),(0,ot.Z)(this,"transportManager",void 0),(0,ot.Z)(this,"addressSorter",void 0),(0,ot.Z)(this,"maxPeerAddrsToDial",void 0),(0,ot.Z)(this,"maxParallelDialsPerPeer",void 0),(0,ot.Z)(this,"dialTimeout",void 0),(0,ot.Z)(this,"inProgressDialCount",void 0),(0,ot.Z)(this,"pendingDialCount",void 0),(0,ot.Z)(this,"shutDownController",void 0),this.addressSorter=null!==(n=l.addressSorter)&&void 0!==n?n:cZ.addressSorter,this.maxPeerAddrsToDial=null!==(r=l.maxPeerAddrsToDial)&&void 0!==r?r:cZ.maxPeerAddrsToDial,this.maxParallelDialsPerPeer=null!==(i=l.maxParallelDialsPerPeer)&&void 0!==i?i:cZ.maxParallelDialsPerPeer,this.dialTimeout=null!==(o=l.dialTimeout)&&void 0!==o?o:cZ.dialTimeout,this.peerId=t.peerId,this.peerStore=t.peerStore,this.connectionGater=t.connectionGater,this.transportManager=t.transportManager,this.shutDownController=new AbortController;try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,this.shutDownController.signal)}catch(g){}this.pendingDialCount=null===(a=t.metrics)||void 0===a?void 0:a.registerMetric("libp2p_dialler_pending_dials"),this.inProgressDialCount=null===(s=t.metrics)||void 0===s?void 0:s.registerMetric("libp2p_dialler_in_progress_dials"),this.pendingDials=[];for(var f=0,h=Object.entries(null!==(p=l.resolvers)&&void 0!==p?p:{});f<h.length;f++){var p,d=(0,k.Z)(h[f],2),v=d[0],y=d[1];FS.set(v,y)}this.queue=new uc.Z({concurrency:null!==(u=l.maxParallelDials)&&void 0!==u?u:cZ.maxParallelDials}),this.queue.on("add",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)})),this.queue.on("active",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)})),this.queue.on("completed",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)})),this.queue.on("error",(function(e){var t,n;uZ.error("error in dial queue",e),null===(t=c.pendingDialCount)||void 0===t||t.update(c.queue.size),null===(n=c.inProgressDialCount)||void 0===n||n.update(c.queue.pending)})),this.queue.on("empty",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)})),this.queue.on("idle",(function(){var e,t;null===(e=c.pendingDialCount)||void 0===e||e.update(c.queue.size),null===(t=c.inProgressDialCount)||void 0===t||t.update(c.queue.pending)}))}return(0,W.Z)(e,[{key:"stop",value:function(){this.shutDownController.abort()}},{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h=this,p=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=p.length>1&&void 0!==p[1]?p[1]:{},r=KA(t),i=r.peerId,o=r.multiaddrs,a=o.map((function(e){return{multiaddr:e,isCertified:!1}})),u=this.createDialAbortControllers(n.signal),e.prev=4,e.next=7,this.calculateMultiaddrs(i,a,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:u}));case 7:c=e.sent,e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(4),u.clear(),e.t0;case 14:if(l=this.pendingDials.find((function(e){return!(null==e.peerId||null==i||!e.peerId.equals(i))||c.map((function(e){return e.multiaddr.toString()})).join()===e.multiaddrs.map((function(e){return e.toString()})).join()})),null==l){e.next=19;break}return uZ("joining existing dial target for %p",i),u.clear(),e.abrupt("return",l.promise);case 19:return uZ("creating dial target for",c.map((function(e){return e.multiaddr.toString()}))),(f={id:"".concat(parseInt(String(1e9*Math.random()),10).toString()).concat(Date.now()),status:"queued",peerId:i,multiaddrs:c.map((function(e){return e.multiaddr}))}).promise=this.performDial(f,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:u})).finally((function(){h.pendingDials=h.pendingDials.filter((function(e){return e.id!==f.id})),u.clear()})).catch((function(e){if(uZ.error("dial failed to %s",f.multiaddrs.map((function(e){return e.toString()})).join(", "),e),u.aborted)throw new ar.s(e.message,PA.ERR_TIMEOUT);throw e})),this.pendingDials.push(f),e.abrupt("return",f.promise);case 24:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"createDialAbortControllers",value:function(e){var t=nb([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,t)}catch(n){}return t}},{key:"calculateMultiaddrs",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c,l,f,h,p,d,v,y,g,m,b,w,k,E,x,_=this,S=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=S.length>1&&void 0!==S[1]?S[1]:[],r=S.length>2&&void 0!==S[2]?S[2]:{},null==t){e.next=24;break}if(!this.peerId.equals(t)){e.next=5;break}throw new ar.s("Tried to dial self",PA.ERR_DIALED_SELF);case 5:return e.next=7,null===(i=(o=this.connectionGater).denyDialPeer)||void 0===i?void 0:i.call(o,t);case 7:if(e.t0=e.sent,!0!==e.t0){e.next=10;break}throw new ar.s("The dial request is blocked by gater.allowDialPeer",PA.ERR_PEER_DIAL_INTERCEPTED);case 10:if(0!==n.length){e.next=24;break}return uZ("loading multiaddrs for %p",t),e.prev=12,e.next=15,this.peerStore.get(t);case 15:a=e.sent,n.push.apply(n,(0,ye.Z)(a.addresses)),uZ("loaded multiaddrs for %p",t,n.map((function(e){return e.multiaddr.toString()}))),e.next=24;break;case 20:if(e.prev=20,e.t1=e.catch(12),e.t1.code===PA.ERR_NOT_FOUND){e.next=24;break}throw e.t1;case 24:return e.next=26,Promise.all(n.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,rZ(t.multiaddr,r);case 2:if(1!==(n=e.sent).length||!n[0].equals(t.multiaddr)){e.next=5;break}return e.abrupt("return",t);case 5:return e.abrupt("return",n.map((function(e){return{multiaddr:e,isCertified:!1}})));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 26:c=e.sent.flat(),l=c.filter((function(e){return Boolean(_.transportManager.transportForMultiaddr(e.multiaddr))})),f=new Map,h=(0,Ae.Z)(l),e.prev=30,h.s();case 32:if((p=h.n()).done){e.next=42;break}if(d=p.value,v=d.multiaddr.toString(),null==(y=f.get(v))){e.next=39;break}return y.isCertified=y.isCertified||d.isCertified||!1,e.abrupt("continue",40);case 39:f.set(v,d);case 40:e.next=32;break;case 42:e.next=47;break;case 44:e.prev=44,e.t2=e.catch(30),h.e(e.t2);case 47:return e.prev=47,h.f(),e.finish(47);case 50:if((0===(g=(0,ye.Z)(f.values())).length||g.length>this.maxPeerAddrsToDial)&&(uZ("addresses for %p before filtering",null!==t&&void 0!==t?t:"unknown peer",c.map((function(e){return e.multiaddr.toString()}))),uZ("addresses for %p after filtering",null!==t&&void 0!==t?t:"unknown peer",g.map((function(e){return e.multiaddr.toString()})))),0!==g.length){e.next=54;break}throw new ar.s("The dial request has no valid addresses",PA.ERR_NO_VALID_ADDRESSES);case 54:if(!(g.length>this.maxPeerAddrsToDial)){e.next=56;break}throw new ar.s("dial with more addresses than allowed",PA.ERR_TOO_MANY_ADDRESSES);case 56:null!=t&&(m="/p2p/".concat(t.toString()),g=g.map((function(e){var n=e.multiaddr.getPeerId(),r=e.multiaddr.protos().pop();return!0===(null===r||void 0===r?void 0:r.path)?e:n!==t.toString()?{multiaddr:e.multiaddr.encapsulate(m),isCertified:e.isCertified}:e}))),b=[],w=(0,Ae.Z)(g),e.prev=59,w.s();case 61:if((k=w.n()).done){e.next=73;break}if(E=k.value,e.t3=null!=this.connectionGater.denyDialMultiaddr,!e.t3){e.next=68;break}return e.next=67,this.connectionGater.denyDialMultiaddr(E.multiaddr);case 67:e.t3=e.sent;case 68:if(!e.t3){e.next=70;break}return e.abrupt("continue",71);case 70:b.push(E);case 71:e.next=61;break;case 73:e.next=78;break;case 75:e.prev=75,e.t4=e.catch(59),w.e(e.t4);case 78:return e.prev=78,w.f(),e.finish(78);case 81:if(0!==(x=b.sort(this.addressSorter)).length){e.next=84;break}throw new ar.s("The connection gater denied all addresses in the dial request",PA.ERR_NO_VALID_ADDRESSES);case 84:return e.abrupt("return",x);case 85:case"end":return e.stop()}}),e,this,[[12,20],[30,44,47,50],[59,75,78,81]])})));return function(t){return e.apply(this,arguments)}}()},{key:"performDial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a=this,c=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>1&&void 0!==c[1]?c[1]:{},r=t.multiaddrs.map((function(){return new AbortController})),e.prev=2,(i=new uc.Z({concurrency:this.maxParallelDialsPerPeer})).on("error",(function(e){uZ.error("error dialling",e)})),e.next=7,Promise.any(t.multiaddrs.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(o,c){var l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(l=r[c])){e.next=3;break}throw new ar.s("dialAction did not come with an AbortController",PA.ERR_INVALID_PARAMETERS);case 3:return(f=sZ(l.signal,n.signal)).addEventListener("abort",(function(){uZ("dial to %s aborted",o)})),h=Ut(),e.next=8,i.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!f.aborted){e.next=4;break}return uZ("dial to %s was aborted before reaching the head of the peer dial queue",o),h.reject(new ar._),e.abrupt("return");case 4:return e.next=6,a.queue.add((0,u.Z)((0,s.Z)().mark((function e(){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!f.aborted){e.next=5;break}return uZ("dial to %s was aborted before reaching the head of the dial queue",o),h.reject(new ar._),e.abrupt("return");case 5:return t.status="active",e.next=8,a.transportManager.dial(o,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:f}));case 8:if(i=e.sent,!l.signal.aborted){e.next=14;break}return uZ("multiple dials succeeded, closing superfluous connection"),i.close().catch((function(e){uZ.error("error closing superfluous connection",e)})),h.reject(new ar._),e.abrupt("return");case 14:r[c]=void 0,r.forEach((function(e){void 0!==e&&e.abort()})),uZ("dial to %s succeeded",o),h.resolve(i),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(0),uZ.error("error during dial of %s",o,e.t0),h.reject(e.t0);case 24:case"end":return e.stop()}}),e,null,[[0,20]])}))),(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:f})).catch((function(e){h.reject(e)}));case 6:case"end":return e.stop()}}),e)}))),{signal:f}).catch((function(e){h.reject(e)})).finally((function(){f.clear()}));case 8:return e.abrupt("return",h.promise);case 9:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()));case 7:if(null!=(o=e.sent)){e.next=10;break}throw new ar.s("successful dial led to empty object returned from peer dial queue",PA.ERR_TRANSPORT_DIAL_FAILED);case 10:return t.status="success",e.abrupt("return",o);case 14:if(e.prev=14,e.t0=e.catch(2),t.status="error",1!==t.multiaddrs.length||"AggregateError"!==e.t0.name){e.next=19;break}throw e.t0.errors[0];case 19:throw e.t0;case 20:case"end":return e.stop()}}),e,this,[[2,14]])})));return function(t){return e.apply(this,arguments)}}()}]),e}();var fZ=(0,ru.kg)("libp2p:connection-manager"),hZ=50,pZ=300,dZ=5,vZ=10,yZ=25,gZ=0,mZ=function(){function e(t){var n,r,i,o,a,s,u,c,l,f,h,p,d,v=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"started",void 0),(0,ot.Z)(this,"connections",void 0),(0,ot.Z)(this,"allow",void 0),(0,ot.Z)(this,"deny",void 0),(0,ot.Z)(this,"maxIncomingPendingConnections",void 0),(0,ot.Z)(this,"incomingPendingConnections",void 0),(0,ot.Z)(this,"maxConnections",void 0),(0,ot.Z)(this,"dialQueue",void 0),(0,ot.Z)(this,"autoDial",void 0),(0,ot.Z)(this,"connectionPruner",void 0),(0,ot.Z)(this,"inboundConnectionRateLimiter",void 0),(0,ot.Z)(this,"peerStore",void 0),(0,ot.Z)(this,"metrics",void 0),(0,ot.Z)(this,"events",void 0),this.maxConnections=null!==(n=v.maxConnections)&&void 0!==n?n:pZ;var y=null!==(r=v.minConnections)&&void 0!==r?r:hZ;if(this.maxConnections<y)throw new ar.s("Connection Manager maxConnections must be greater than minConnections",PA.ERR_INVALID_PARAMETERS);this.connections=new Qk,this.started=!1,this.peerStore=t.peerStore,this.metrics=t.metrics,this.events=t.events,this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(null!==(i=v.allow)&&void 0!==i?i:[]).map((function(e){return WS(e)})),this.deny=(null!==(o=v.deny)&&void 0!==o?o:[]).map((function(e){return WS(e)})),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=null!==(a=v.maxIncomingPendingConnections)&&void 0!==a?a:vZ,this.inboundConnectionRateLimiter=new xc.RateLimiterMemory({points:null!==(s=v.inboundConnectionThreshold)&&void 0!==s?s:dZ,duration:1}),this.autoDial=new $A({connectionManager:this,peerStore:t.peerStore,events:t.events},{minConnections:y,autoDialConcurrency:null!==(u=v.autoDialConcurrency)&&void 0!==u?u:yZ,autoDialPriority:null!==(c=v.autoDialPriority)&&void 0!==c?c:gZ}),this.connectionPruner=new tZ({connectionManager:this,peerStore:t.peerStore,events:t.events},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new lZ({peerId:t.peerId,metrics:t.metrics,peerStore:t.peerStore,transportManager:t.transportManager,connectionGater:t.connectionGater},{addressSorter:null!==(l=v.addressSorter)&&void 0!==l?l:EA,maxParallelDials:null!==(f=v.maxParallelDials)&&void 0!==f?f:100,maxPeerAddrsToDial:null!==(h=v.maxPeerAddrsToDial)&&void 0!==h?h:25,dialTimeout:null!==(p=v.dialTimeout)&&void 0!==p?p:3e4,resolvers:null!==(d=v.resolvers)&&void 0!==d?d:{dnsaddr:jA}})}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===(t=this.metrics)||void 0===t||t.registerMetricGroup("libp2p_connection_manager_connections",{calculate:function(){var e,t={inbound:0,outbound:0},n=(0,Ae.Z)(i.connections.values());try{for(n.s();!(e=n.n()).done;){var r,o=e.value,a=(0,Ae.Z)(o);try{for(a.s();!(r=a.n()).done;){"inbound"===r.value.stat.direction?t.inbound++:t.outbound++}}catch(s){a.e(s)}finally{a.f()}}}catch(s){n.e(s)}finally{n.f()}return t}}),null===(n=this.metrics)||void 0===n||n.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:function(){var e,t={},n=(0,Ae.Z)(i.connections.values());try{for(n.s();!(e=n.n()).done;){var r,o=e.value,a=(0,Ae.Z)(o);try{for(a.s();!(r=a.n()).done;){var s,u=r.value,c=(0,Ae.Z)(u.streams);try{for(c.s();!(s=c.n()).done;){var l,f,h=s.value,p="".concat(h.stat.direction," ").concat(null!==(l=h.stat.protocol)&&void 0!==l?l:"unnegotiated");t[p]=(null!==(f=t[p])&&void 0!==f?f:0)+1}}catch(d){c.e(d)}finally{c.f()}}}catch(d){a.e(d)}finally{a.f()}}}catch(d){n.e(d)}finally{n.f()}return t}}),null===(r=this.metrics)||void 0===r||r.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:function(){var e,t={},n=(0,Ae.Z)(i.connections.values());try{for(n.s();!(e=n.n()).done;){var r,o=e.value,a=(0,Ae.Z)(o);try{for(a.s();!(r=a.n()).done;){var s,u=r.value,c={},l=(0,Ae.Z)(u.streams);try{for(l.s();!(s=l.n()).done;){var f,h,p=s.value,d="".concat(p.stat.direction," ").concat(null!==(f=p.stat.protocol)&&void 0!==f?f:"unnegotiated");c[d]=(null!==(h=c[d])&&void 0!==h?h:0)+1}}catch(C){l.e(C)}finally{l.f()}for(var v=0,y=Object.entries(c);v<y.length;v++){var g,m=(0,k.Z)(y[v],2),b=m[0],w=m[1];t[b]=null!==(g=t[b])&&void 0!==g?g:[],t[b].push(w)}}}catch(C){a.e(C)}finally{a.f()}}}catch(C){n.e(C)}finally{n.f()}for(var E={},x=0,_=Object.entries(t);x<_.length;x++){var S=(0,k.Z)(_[x],2),A=S[0],Z=S[1];Z=Z.sort((function(e,t){return e-t}));var T=Math.floor(.9*Z.length);E[A]=Z[T]}return E}}),this.autoDial.start(),this.started=!0,fZ("started");case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"afterStart",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){var n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],e.t0=Ae.Z,e.next=4,t.peerStore.all();case 4:e.t1=e.sent,r=(0,e.t0)(e.t1);try{for(r.s();!(i=r.n()).done;)(o=i.value).tags.has(VA)&&n.push(o.id)}catch(a){r.e(a)}finally{r.f()}return e.next=9,Promise.all(n.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.openConnection(n).catch((function(e){fZ.error(e)}));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 9:case"end":return e.stop()}}),e)})))).catch((function(e){fZ.error(e)})),this.autoDial.afterStart();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.dialQueue.stop(),this.autoDial.stop(),t=[],n=(0,Ae.Z)(this.connections.values()),e.prev=4,n.s();case 6:if((r=n.n()).done){e.next=26;break}i=r.value,o=(0,Ae.Z)(i),e.prev=9,c=(0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=a.value,t.push((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.close();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),fZ.error(e.t0);case 8:case"end":return e.stop()}}),e,null,[[0,5]])})))());case 2:case"end":return e.stop()}}),e)})),o.s();case 12:if((a=o.n()).done){e.next=16;break}return e.delegateYield(c(),"t0",14);case 14:e.next=12;break;case 16:e.next=21;break;case 18:e.prev=18,e.t1=e.catch(9),o.e(e.t1);case 21:return e.prev=21,o.f(),e.finish(21);case 24:e.next=6;break;case 26:e.next=31;break;case 28:e.prev=28,e.t2=e.catch(4),n.e(e.t2);case 31:return e.prev=31,n.f(),e.finish(31);case 34:return fZ("closing %d connections",t.length),e.next=37,Promise.all(t);case 37:this.connections.clear(),fZ("stopped");case 39:case"end":return e.stop()}}),e,this,[[4,28,31,34],[9,18,21,24]])})));return function(){return e.apply(this,arguments)}}()},{key:"onConnect",value:function(e){this._onConnect(e).catch((function(e){fZ.error(e)}))}},{key:"_onConnect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.detail,this.started){e.next=5;break}return e.next=4,n.close();case 4:return e.abrupt("return");case 5:if(r=n.remotePeer,i=this.connections.get(r),o=!1,null!=i?i.push(n):(o=!0,this.connections.set(r,[n])),null==r.publicKey||"RSA"!==r.type){e.next=12;break}return e.next=12,this.peerStore.patch(r,{publicKey:r.publicKey});case 12:o&&this.events.safeDispatchEvent("peer:connect",{detail:n.remotePeer});case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"onDisconnect",value:function(e){var t=e.detail;if(this.started){var n=t.remotePeer,r=this.connections.get(n);null!=r&&r.length>1?(r=r.filter((function(e){return e.id!==t.id})),this.connections.set(n,r)):null!=r&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}}},{key:"getConnections",value:function(e){var t;if(null!=e)return null!==(t=this.connections.get(e))&&void 0!==t?t:[];var n,r=[],i=(0,Ae.Z)(this.connections.values());try{for(i.s();!(n=i.n()).done;){var o=n.value;r=r.concat(o)}}catch(a){i.e(a)}finally{i.f()}return r}},{key:"getConnectionsMap",value:function(){return this.connections}},{key:"openConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=p.length>1&&void 0!==p[1]?p[1]:{},this.isStarted()){e.next=3;break}throw new ar.s("Not started",PA.ERR_NODE_NOT_STARTED);case 3:if(i=KA(t),null==(o=i.peerId)){e.next=10;break}if(fZ("dial %p",o),!((a=this.getConnections(o)).length>0)){e.next=10;break}return fZ("had an existing connection to %p",o),e.abrupt("return",a[0]);case 10:return e.next=12,this.dialQueue.dial(t,(0,Nt.Z)((0,Nt.Z)({},r),{},{priority:null!==(n=r.priority)&&void 0!==n?n:50}));case 12:u=e.sent,null==(c=this.connections.get(u.remotePeer))&&(c=[],this.connections.set(u.remotePeer,c)),l=!1,f=(0,Ae.Z)(c);try{for(f.s();!(h=f.n()).done;)h.value.id===u.id&&(l=!0)}catch(s){f.e(s)}finally{f.f()}return l||c.push(u),e.abrupt("return",u);case 20:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"closeConnections",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=null!==(n=this.connections.get(t))&&void 0!==n?n:[],e.next=3,Promise.all(r.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.close();case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"acceptIncomingConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.deny.some((function(e){return t.remoteAddr.toString().startsWith(e.toString())}))){e.next=4;break}return fZ("connection from %s refused - connection remote address was in deny list",t.remoteAddr),e.abrupt("return",!1);case 4:if(!this.allow.some((function(e){return t.remoteAddr.toString().startsWith(e.toString())}))){e.next=8;break}return this.incomingPendingConnections++,e.abrupt("return",!0);case 8:if(this.incomingPendingConnections!==this.maxIncomingPendingConnections){e.next=11;break}return fZ("connection from %s refused - incomingPendingConnections exceeded by peer %s",t.remoteAddr),e.abrupt("return",!1);case 11:if(!t.remoteAddr.isThinWaistAddress()){e.next=22;break}return n=t.remoteAddr.nodeAddress().address,e.prev=13,e.next=16,this.inboundConnectionRateLimiter.consume(n,1);case 16:e.next=22;break;case 18:return e.prev=18,e.t0=e.catch(13),fZ("connection from %s refused - inboundConnectionThreshold exceeded by host %s",n,t.remoteAddr),e.abrupt("return",!1);case 22:if(!(this.getConnections().length<this.maxConnections)){e.next=25;break}return this.incomingPendingConnections++,e.abrupt("return",!0);case 25:return fZ("connection from %s refused - maxConnections exceeded",t.remoteAddr),e.abrupt("return",!1);case 27:case"end":return e.stop()}}),e,this,[[13,18]])})));return function(t){return e.apply(this,arguments)}}()},{key:"afterUpgradeInbound",value:function(){this.incomingPendingConnections--}},{key:"getDialQueue",value:function(){return this.dialQueue.pendingDials}}]),e}();function bZ(e,t){return wZ.apply(this,arguments)}function wZ(){return wZ=(0,g.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(Vm(t,function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.merge(t.id,{multiaddrs:t.multiaddrs});case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())),m.Z),"t0",1);case 1:case"end":return e.stop()}}),e)}))),wZ.apply(this,arguments)}function kZ(e){var t=new Set;return jm(e,(function(e){return!t.has(e.id.toString())&&(t.add(e.id.toString()),!0)}))}function EZ(e){return xZ.apply(this,arguments)}function xZ(){return xZ=(0,g.Z)((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return(0,s.Z)().mark((function n(){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=0,i=!1,o=!1,n.prev=3,u=(0,y.Z)(e);case 5:return n.next=7,(0,m.Z)(u.next());case 7:if(!(i=!(c=n.sent).done)){n.next=15;break}return l=c.value,r++,n.next=12,l;case 12:i=!1,n.next=5;break;case 15:n.next=21;break;case 17:n.prev=17,n.t0=n.catch(3),o=!0,a=n.t0;case 21:if(n.prev=21,n.prev=22,!i||null==u.return){n.next=26;break}return n.next=26,(0,m.Z)(u.return());case 26:if(n.prev=26,!o){n.next=29;break}throw a;case 29:return n.finish(26);case 30:return n.finish(21);case 31:if(!(r<t)){n.next=33;break}throw new ar.s("more peers required, seen: ".concat(r,"  min: ").concat(t),"NOT_FOUND");case 33:case"end":return n.stop()}}),n,null,[[3,17,21,31],[22,,26,30]])}))()})),xZ.apply(this,arguments)}var _Z=function(){function e(t,n){var r;(0,K.Z)(this,e),(0,ot.Z)(this,"routers",void 0),(0,ot.Z)(this,"started",void 0),(0,ot.Z)(this,"components",void 0),this.routers=null!==(r=n.routers)&&void 0!==r?r:[],this.started=!1,this.components=t}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.started=!0;case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.started=!1;case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"findProviders",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(0!==t.routers.length){r.next=2;break}throw new ar.s("No content routers available",PA.ERR_NO_ROUTERS_AVAILABLE);case 2:return r.delegateYield((0,at.Z)((0,y.Z)(Qm(Ym.apply(void 0,(0,ye.Z)(t.routers.map((function(t){return t.findProviders(e,n)})))),(function(e){return bZ(e,t.components.peerStore)}),(function(e){return kZ(e)}),(function(e){return EZ(e)}))),m.Z),"t0",3);case 3:case"end":return r.stop()}}),r)})))()}},{key:"provide",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:{},0!==this.routers.length){e.next=3;break}throw new ar.s("No content routers available",PA.ERR_NO_ROUTERS_AVAILABLE);case 3:return e.next=5,Promise.all(this.routers.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.provide(t,n);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isStarted()){e.next=2;break}throw new ar.s(RA.NOT_STARTED_YET,PA.DHT_NOT_STARTED);case 2:return e.next=4,Promise.all(this.routers.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(i){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.put(t,n,r);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isStarted()){e.next=2;break}throw new ar.s(RA.NOT_STARTED_YET,PA.DHT_NOT_STARTED);case 2:return e.abrupt("return",Promise.any(this.routers.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.get(t,n));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())));case 3:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}();var SZ=function(e){if(null!=e[Symbol.asyncIterator])return(0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,o.next();case 6:if(!(n=!(a=t.sent).done)){t.next=12;break}return u=a.value,t.abrupt("return",u);case 9:n=!1,t.next=4;break;case 12:t.next=18;break;case 14:t.prev=14,t.t0=t.catch(2),r=!0,i=t.t0;case 18:if(t.prev=18,t.prev=19,!n||null==o.return){t.next=23;break}return t.next=23,o.return();case 23:if(t.prev=23,!r){t.next=26;break}throw i;case 26:return t.finish(23);case 27:return t.finish(18);case 28:return t.abrupt("return",void 0);case 29:case"end":return t.stop()}}),t,null,[[2,14,18,28],[19,,23,27]])})))();var t,n=(0,Ae.Z)(e);try{for(n.s();!(t=n.n()).done;){return t.value}}catch(r){n.e(r)}finally{n.f()}},AZ=(0,ru.kg)("libp2p:peer-routing"),ZZ=function(){function e(t,n){var r;(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"routers",void 0),this.components=t,this.routers=null!==(r=n.routers)&&void 0!==r?r:[]}return(0,W.Z)(e,[{key:"findPeer",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==this.routers.length){e.next=2;break}throw new ar.s("No peer routers available",PA.ERR_NO_ROUTERS_AVAILABLE);case 2:if(t.toString()!==this.components.peerId.toString()){e.next=4;break}throw new ar.s("Should not try to find self",PA.ERR_FIND_SELF);case 4:return e.next=6,Qm(Ym.apply(void 0,(0,ye.Z)(this.routers.map((function(e){return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,(0,m.Z)(e.findPeer(t,n));case 3:return r.next=5,r.sent;case 5:r.next=10;break;case 7:r.prev=7,r.t0=r.catch(0),AZ.error(r.t0);case 10:case"end":return r.stop()}}),r,null,[[0,7]])})))()})))),(function(e){return jm(e,Boolean)}),(function(e){return bZ(e,i.components.peerStore)}),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",SZ(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:if(null==(r=e.sent)){e.next=9;break}return e.abrupt("return",r);case 9:throw new ar.s(RA.NOT_FOUND,PA.ERR_NOT_FOUND);case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getClosestPeers",value:function(e,t){var n=this;return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(0!==n.routers.length){r.next=2;break}throw new ar.s("No peer routers available",PA.ERR_NO_ROUTERS_AVAILABLE);case 2:return r.delegateYield((0,at.Z)((0,y.Z)(Qm(Ym.apply(void 0,(0,ye.Z)(n.routers.map((function(n){return n.getClosestPeers(e,t)})))),(function(e){return bZ(e,n.components.peerStore)}),(function(e){return kZ(e)}),(function(e){return EZ(e)}))),m.Z),"t0",3);case 3:case"end":return r.stop()}}),r)})))()}}]),e}(),TZ=(0,ru.kg)("libp2p:registrar"),CZ=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"topologies",void 0),(0,ot.Z)(this,"handlers",void 0),(0,ot.Z)(this,"components",void 0),this.topologies=new Map,this.handlers=new Map,this.components=t,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onConnect=this._onConnect.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:connect",this._onConnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate)}return(0,W.Z)(e,[{key:"getProtocols",value:function(){return Array.from(new Set((0,ye.Z)(this.handlers.keys()))).sort()}},{key:"getHandler",value:function(e){var t=this.handlers.get(e);if(null==t)throw new ar.s("No handler registered for protocol ".concat(e),PA.ERR_NO_HANDLER_FOR_PROTOCOL);return t}},{key:"getTopologies",value:function(e){var t=this.topologies.get(e);return null==t?[]:(0,ye.Z)(t.values())}},{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.handlers.has(t)){e.next=2;break}throw new ar.s("Handler already registered for protocol ".concat(t),PA.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);case 2:return i=mk.Z.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},r),this.handlers.set(t,{handler:n,options:i}),e.next=6,this.components.peerStore.merge(this.components.peerId,{protocols:[t]});case 6:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"unhandle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=Array.isArray(t)?t:[t]).forEach((function(e){r.handlers.delete(e)})),e.next=4,this.components.peerStore.patch(this.components.peerId,{protocols:n});case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Pb(n)){e.next=3;break}throw TZ.error("topology must be an instance of interfaces/topology"),new ar.s("topology must be an instance of interfaces/topology",PA.ERR_INVALID_PARAMETERS);case 3:return r="".concat((1e9*Math.random()).toString(36)).concat(Date.now()),null==(i=this.topologies.get(t))&&(i=new Map,this.topologies.set(t,i)),i.set(r,n),e.next=9,n.setRegistrar(this);case 9:return e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"unregister",value:function(e){var t,n=(0,Ae.Z)(this.topologies.entries());try{for(n.s();!(t=n.n()).done;){var r=(0,k.Z)(t.value,2),i=r[0],o=r[1];o.has(e)&&(o.delete(e),0===o.size&&this.topologies.delete(i))}}catch(a){n.e(a)}finally{n.f()}}},{key:"_onDisconnect",value:function(e){var t=this,n=e.detail;this.components.peerStore.get(n).then((function(e){var r,i=(0,Ae.Z)(e.protocols);try{for(i.s();!(r=i.n()).done;){var o=r.value,a=t.topologies.get(o);if(null!=a){var s,u=(0,Ae.Z)(a.values());try{for(u.s();!(s=u.n()).done;){s.value.onDisconnect(n)}}catch(c){u.e(c)}finally{u.f()}}}}catch(c){i.e(c)}finally{i.f()}})).catch((function(e){e.code!==PA.ERR_NOT_FOUND&&TZ.error("could not inform topologies of disconnecting peer %p",n,e)}))}},{key:"_onConnect",value:function(e){var t=this,n=e.detail;this.components.peerStore.get(n).then((function(e){var r=t.components.connectionManager.getConnections(e.id)[0];if(null!=r){var i,o=(0,Ae.Z)(e.protocols);try{for(o.s();!(i=o.n()).done;){var a=i.value,s=t.topologies.get(a);if(null!=s){var u,c=(0,Ae.Z)(s.values());try{for(c.s();!(u=c.n()).done;){u.value.onConnect(n,r)}}catch(l){c.e(l)}finally{c.f()}}}}catch(l){o.e(l)}finally{o.f()}}else TZ("peer %p connected but the connection manager did not have a connection",e)})).catch((function(e){e.code!==PA.ERR_NOT_FOUND&&TZ.error("could not inform topologies of connecting peer %p",n,e)}))}},{key:"_onPeerUpdate",value:function(e){var t,n,r=e.detail,i=r.peer,o=r.previous,a=(null!==(t=null===o||void 0===o?void 0:o.protocols)&&void 0!==t?t:[]).filter((function(e){return!i.protocols.includes(e)})),s=i.protocols.filter((function(e){var t;return!(null!==(t=null===o||void 0===o?void 0:o.protocols)&&void 0!==t?t:[]).includes(e)})),u=(0,Ae.Z)(a);try{for(u.s();!(n=u.n()).done;){var c=n.value,l=this.topologies.get(c);if(null!=l){var f,h=(0,Ae.Z)(l.values());try{for(h.s();!(f=h.n()).done;){f.value.onDisconnect(i.id)}}catch(k){h.e(k)}finally{h.f()}}}}catch(k){u.e(k)}finally{u.f()}var p,d=(0,Ae.Z)(s);try{for(d.s();!(p=d.n()).done;){var v=p.value,y=this.topologies.get(v);if(null!=y){var g,m=(0,Ae.Z)(y.values());try{for(m.s();!(g=m.n()).done;){var b=g.value,w=this.components.connectionManager.getConnections(i.id)[0];null!=w&&b.onConnect(i.id,w)}}catch(k){m.e(k)}finally{m.f()}}}}catch(k){d.e(k)}finally{d.f()}}}]),e}(),IZ=(0,ru.kg)("libp2p:transports"),DZ=function(){function e(t){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"transports",void 0),(0,ot.Z)(this,"listeners",void 0),(0,ot.Z)(this,"faultTolerance",void 0),(0,ot.Z)(this,"started",void 0),this.components=t,this.started=!1,this.transports=new Map,this.listeners=ab({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=null!==(n=r.faultTolerance)&&void 0!==n?n:sl.FATAL_ALL}return(0,W.Z)(e,[{key:"add",value:function(e){var t=e[Symbol.toStringTag];if(null==t)throw new ar.s("Transport must have a valid tag",PA.ERR_INVALID_KEY);if(this.transports.has(t))throw new ar.s("There is already a transport with the tag ".concat(t),PA.ERR_DUPLICATE_TRANSPORT);IZ("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}},{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){this.started=!0}},{key:"afterStart",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.components.addressManager.getListenAddrs(),e.next=3,this.listen(t);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=(0,Ae.Z)(this.listeners),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=16;break}i=(0,k.Z)(r.value,2),o=i[0],a=i[1],IZ("closing listeners for %s",o);case 7:if(!(a.length>0)){e.next=14;break}if(null!=(u=a.pop())){e.next=11;break}return e.abrupt("continue",7);case 11:t.push(u.close()),e.next=7;break;case 14:e.next=4;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(2),n.e(e.t0);case 21:return e.prev=21,n.f(),e.finish(21);case 24:return e.next=26,Promise.all(t);case 26:IZ("all listeners closed"),c=(0,Ae.Z)(this.listeners.keys());try{for(c.s();!(l=c.n()).done;)f=l.value,this.listeners.set(f,[])}catch(s){c.e(s)}finally{c.f()}this.started=!1;case 30:case"end":return e.stop()}}),e,this,[[2,18,21,24]])})));return function(){return e.apply(this,arguments)}}()},{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(r=this.transportForMultiaddr(t))){e.next=3;break}throw new ar.s("No transport available for address ".concat(String(t)),PA.ERR_TRANSPORT_UNAVAILABLE);case 3:return e.prev=3,e.next=6,r.dial(t,(0,Nt.Z)((0,Nt.Z)({},n),{},{upgrader:this.components.upgrader}));case 6:return e.abrupt("return",e.sent);case 9:throw e.prev=9,e.t0=e.catch(3),null==e.t0.code&&(e.t0.code=PA.ERR_TRANSPORT_DIAL_FAILED),e.t0;case 13:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getAddrs",value:function(){var e,t=[],n=(0,Ae.Z)(this.listeners.values());try{for(n.s();!(e=n.n()).done;){var r,i=e.value,o=(0,Ae.Z)(i);try{for(o.s();!(r=o.n()).done;){var a=r.value;t=[].concat((0,ye.Z)(t),(0,ye.Z)(a.getAddrs()))}}catch(s){o.e(s)}finally{o.f()}}}catch(s){n.e(s)}finally{n.f()}return t}},{key:"getTransports",value:function(){return Array.of.apply(Array,(0,ye.Z)(this.transports.values()))}},{key:"getListeners",value:function(){return Array.of.apply(Array,(0,ye.Z)(this.listeners.values())).flat()}},{key:"transportForMultiaddr",value:function(e){var t,n=(0,Ae.Z)(this.transports.values());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.filter([e]).length>0)return r}}catch(i){n.e(i)}finally{n.f()}}},{key:"listen",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p,d,v,y=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t&&0!==t.length){e.next=3;break}return IZ("no addresses were provided for listening, this node is dial only"),e.abrupt("return");case 3:n=[],r=(0,Ae.Z)(this.transports.entries()),e.prev=5,r.s();case 7:if((i=r.n()).done){e.next=38;break}o=(0,k.Z)(i.value,2),a=o[0],u=o[1],c=u.filter(t),l=[],f=(0,Ae.Z)(c),e.prev=12,p=(0,s.Z)().mark((function e(){var t,n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=h.value,IZ("creating listener for %s on %s",a,n),r=u.createListener({upgrader:y.components.upgrader}),null==(i=null!==(t=y.listeners.get(a))&&void 0!==t?t:[])&&(i=[],y.listeners.set(a,i)),i.push(r),r.addEventListener("listening",(function(){y.components.events.safeDispatchEvent("transport:listening",{detail:r})})),r.addEventListener("close",(function(){var e=i.findIndex((function(e){return e===r}));i.splice(e,1),y.components.events.safeDispatchEvent("transport:close",{detail:r})})),l.push(r.listen(n));case 9:case"end":return e.stop()}}),e)})),f.s();case 15:if((h=f.n()).done){e.next=19;break}return e.delegateYield(p(),"t0",17);case 17:e.next=15;break;case 19:e.next=24;break;case 21:e.prev=21,e.t1=e.catch(12),f.e(e.t1);case 24:return e.prev=24,f.f(),e.finish(24);case 27:if(0!==l.length){e.next=30;break}return n.push(a),e.abrupt("continue",36);case 30:return e.next=32,Promise.allSettled(l);case 32:if(d=e.sent,null!=d.find((function(e){return"fulfilled"===e.status}))||this.faultTolerance===sl.NO_FATAL){e.next=36;break}throw new ar.s("Transport (".concat(a,") could not listen on any available address"),PA.ERR_NO_VALID_ADDRESSES);case 36:e.next=7;break;case 38:e.next=43;break;case 40:e.prev=40,e.t2=e.catch(5),r.e(e.t2);case 43:return e.prev=43,r.f(),e.finish(43);case 46:if(n.length!==this.transports.size){e.next=51;break}if(v="no valid addresses were provided for transports [".concat(n.join(", "),"]"),this.faultTolerance!==sl.FATAL_ALL){e.next=50;break}throw new ar.s(v,PA.ERR_NO_VALID_ADDRESSES);case 50:IZ("libp2p in dial mode only: ".concat(v));case 51:case"end":return e.stop()}}),e,this,[[5,40,43,46],[12,21,24,27]])})));return function(t){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:IZ("removing %s",t),r=(0,Ae.Z)(null!==(n=this.listeners.get(t))&&void 0!==n?n:[]),e.prev=2,r.s();case 4:if((i=r.n()).done){e.next=10;break}return o=i.value,e.next=8,o.close();case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),r.e(e.t0);case 15:return e.prev=15,r.f(),e.finish(15);case 18:this.transports.delete(t),this.listeners.delete(t);case 20:case"end":return e.stop()}}),e,this,[[2,12,15,18]])})));return function(t){return e.apply(this,arguments)}}()},{key:"removeAll",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=(0,Ae.Z)(this.transports.keys());try{for(n.s();!(r=n.n()).done;)i=r.value,t.push(this.remove(i))}catch(o){n.e(o)}finally{n.f()}return e.next=5,Promise.all(t);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),OZ="/multistream/1.0.0",RZ=1024;function PZ(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function LZ(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?PZ(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function NZ(e){return null!=e[Symbol.asyncIterator]}var BZ=function e(t){var n=Ct.encodingLength(t),r=LZ(n);return Ct.encode(t,r),e.bytes=n,r};function MZ(e,t){var n,r,i=(0,s.Z)().mark(a),o=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:BZ;function a(e){var t;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!((t=o(e.byteLength))instanceof Uint8Array)){n.next=6;break}return n.next=4,t;case 4:n.next=7;break;case 6:return n.delegateYield(t,"t0",7);case 7:if(!(e instanceof Uint8Array)){n.next=12;break}return n.next=10,e;case 10:n.next=13;break;case 12:return n.delegateYield(e,"t1",13);case 13:case"end":return n.stop()}}),i)}return NZ(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=12;break}return c=u.value,t.delegateYield((0,at.Z)((0,y.Z)(a(c)),m.Z),"t0",9);case 9:n=!1,t.next=4;break;case 12:t.next=18;break;case 14:t.prev=14,t.t1=t.catch(2),r=!0,i=t.t1;case 18:if(t.prev=18,t.prev=19,!n||null==o.return){t.next=23;break}return t.next=23,(0,m.Z)(o.return());case 23:if(t.prev=23,!r){t.next=26;break}throw i;case 26:return t.finish(23);case 27:return t.finish(18);case 28:case"end":return t.stop()}}),t,null,[[2,14,18,28],[19,,23,27]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=8;break}return i=r.value,t.delegateYield(a(i),"t0",6);case 6:t.next=3;break;case 8:t.next=13;break;case 10:t.prev=10,t.t1=t.catch(1),n.e(t.t1);case 13:return t.prev=13,n.f(),t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[1,10,13,16]])}))()}BZ.bytes=0,MZ.single=function(e,t){var n,r,i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:BZ;return new vt(i(e.byteLength),e)};var FZ,jZ=8,UZ=4194304;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(FZ||(FZ={}));var zZ=function e(t){var n=Ct.decode(t);return e.bytes=Ct.encodingLength(n),n};function HZ(e,t){var n,r,i,o=(0,s.Z)().mark(p),a=new vt,u=FZ.LENGTH,c=-1,l=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:zZ,f=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:jZ,h=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:UZ;function p(){var e,n;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!(a.byteLength>0)){r.next=32;break}if(u!==FZ.LENGTH){r.next=21;break}if(r.prev=2,!((c=l(a))<0)){r.next=6;break}throw Mt()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");case 6:if(!(c>h)){r.next=8;break}throw Mt()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");case 8:e=l.bytes,a.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(c),u=FZ.DATA,r.next=21;break;case 14:if(r.prev=14,r.t0=r.catch(2),!(r.t0 instanceof RangeError)){r.next=20;break}if(!(a.byteLength>f)){r.next=19;break}throw Mt()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");case 19:return r.abrupt("break",32);case 20:throw r.t0;case 21:if(u!==FZ.DATA){r.next=30;break}if(!(a.byteLength<c)){r.next=24;break}return r.abrupt("break",32);case 24:return n=a.sublist(0,c),a.consume(c),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(n),r.next=29,n;case 29:u=FZ.LENGTH;case 30:r.next=0;break;case 32:case"end":return r.stop()}}),o,null,[[2,14]])}return NZ(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=13;break}return c=u.value,a.append(c),t.delegateYield((0,at.Z)((0,y.Z)(p()),m.Z),"t0",10);case 10:n=!1,t.next=4;break;case 13:t.next=19;break;case 15:t.prev=15,t.t1=t.catch(2),r=!0,i=t.t1;case 19:if(t.prev=19,t.prev=20,!n||null==o.return){t.next=24;break}return t.next=24,(0,m.Z)(o.return());case 24:if(t.prev=24,!r){t.next=27;break}throw i;case 27:return t.finish(24);case 28:return t.finish(19);case 29:if(!(a.byteLength>0)){t.next=31;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 31:case"end":return t.stop()}}),t,null,[[2,15,19,29],[20,,24,28]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=9;break}return i=r.value,a.append(i),t.delegateYield(p(),"t0",7);case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t1=t.catch(1),n.e(t.t1);case 14:return t.prev=14,n.f(),t.finish(14);case 17:if(!(a.byteLength>0)){t.next=19;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 19:case"end":return t.stop()}}),t,null,[[1,11,14,17]])}))()}zZ.bytes=0,HZ.fromReader=function(e,t){var n=1;return HZ((0,g.Z)((0,s.Z)().mark((function t(){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=1,t.next=4,(0,m.Z)(e.next(n));case 4:if(r=t.sent,i=r.done,o=r.value,!0!==i){t.next=9;break}return t.abrupt("return");case 9:if(null==o){t.next=12;break}return t.next=12,o;case 12:t.next=19;break;case 14:if(t.prev=14,t.t0=t.catch(1),"ERR_UNDER_READ"!==t.t0.code){t.next=18;break}return t.abrupt("return",{done:!0,value:null});case 18:throw t.t0;case 19:return t.prev=19,n=1,t.finish(19);case 22:t.next=0;break;case 24:case"end":return t.stop()}}),t,null,[[1,14,19,22]])})))(),(0,Nt.Z)((0,Nt.Z)({},null!==t&&void 0!==t?t:{}),{},{onLength:function(e){n=e}}))};var VZ=function(){function e(t){if((0,K.Z)(this,e),!(t>0)||0!==(t-1&t))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}return(0,W.Z)(e,[{key:"push",value:function(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}},{key:"shift",value:function(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}},{key:"isEmpty",value:function(){return void 0===this.buffer[this.btm]}}]),e}(),GZ=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.hwm=null!==(t=n.splitLimit)&&void 0!==t?t:16,this.head=new VZ(this.hwm),this.tail=this.head,this.size=0}return(0,W.Z)(e,[{key:"calculateSize",value:function(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}},{key:"push",value:function(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){var t=this.head;this.head=t.next=new VZ(2*this.head.buffer.length),this.head.push(e)}}},{key:"shift",value:function(){var e,t=this.tail.shift();if(void 0===t&&null!=this.tail.next){var n=this.tail.next;this.tail.next=null,this.tail=n,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}},{key:"isEmpty",value:function(){return this.head.isEmpty()}}]),e}();function KZ(){return WZ((function(e){var t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function WZ(e,t){var n,r,i,o,a,c,l=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,f=new GZ,h=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(f.isEmpty()){t.next=2;break}return t.abrupt("return",e(f));case 2:if(!c){t.next=4;break}return t.abrupt("return",{done:!0});case 4:return t.next=6,new Promise((function(t,n){a=function(r){a=null,f.push(r);try{t(e(f))}catch(i){n(i)}return o}}));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e){return null!=a?a(e):(f.push(e),o)},d=function(e){var n;if(c)return o;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:e})},v=function(e){return c?o:(c=!0,null!=e?function(e){return f=new GZ,null!=a?a({error:e}):(f.push({error:e}),o)}(e):p({done:!0}))};if(r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(r,"next",h),(0,ot.Z)(r,"return",(function(){return f=new GZ,v(),{done:!0}})),(0,ot.Z)(r,"throw",(function(e){return v(e),{done:!0}})),(0,ot.Z)(r,"push",d),(0,ot.Z)(r,"end",v),Xt("get",r,"readableLength",(function(){return f.size})),o=r,null==l)return o;var y=o;return i={},(0,ot.Z)(i,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(i,"next",(function(){return y.next()})),(0,ot.Z)(i,"throw",(function(e){return y.throw(e),null!=l&&(l(e),l=void 0),{done:!0}})),(0,ot.Z)(i,"return",(function(){return y.return(),null!=l&&(l(),l=void 0),{done:!0}})),(0,ot.Z)(i,"push",d),(0,ot.Z)(i,"end",(function(e){return y.end(e),null!=l&&(l(e),l=void 0),o})),Xt("get",i,"readableLength",(function(){return y.readableLength})),o=i}var qZ=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=[],i=0,o=t;i<o.length;i++){var a=o[i];null==a[Symbol.asyncIterator]&&r.push(a)}return r.length===t.length?(0,s.Z)().mark((function e(){var t,n,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(r),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=8;break}return i=n.value,e.delegateYield(i,"t0",6);case 6:e.next=3;break;case 8:e.next=13;break;case 10:e.prev=10,e.t1=e.catch(1),t.e(e.t1);case 13:return e.prev=13,t.f(),e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[1,10,13,16]])}))():(0,g.Z)((0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=KZ({objectMode:!0}),Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,i=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(r=!(u=e.sent).done)){e.next=12;break}c=u.value,n.push(c);case 9:r=!1,e.next=4;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(2),i=!0,o=e.t0;case 18:if(e.prev=18,e.prev=19,!r||null==a.return){e.next=23;break}return e.next=23,a.return();case 23:if(e.prev=23,!i){e.next=26;break}throw o;case 26:return e.finish(23);case 27:return e.finish(18);case 28:case"end":return e.stop()}}),e,null,[[2,14,18,28],[19,,23,27]])})));return function(t){return e.apply(this,arguments)}}()));case 3:n.end(),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),n.end(e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))),e.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",3);case 3:case"end":return e.stop()}}),e)})))()};function YZ(e){if(null==e)throw new Error("Empty pipeline");if(JZ(e)){var t=e;e=function(){return t.source}}else if($Z(e)||XZ(e)){var n=e;e=function(){return n}}for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];var a=[e].concat(i);if(a.length>1&&JZ(a[a.length-1])&&(a[a.length-1]=a[a.length-1].sink),a.length>2)for(var s=1;s<a.length-1;s++)JZ(a[s])&&(a[s]=eT(a[s]));return QZ.apply(void 0,(0,ye.Z)(a))}var QZ=function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},XZ=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator])},$Z=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.iterator])},JZ=function(e){return null!=e&&(null!=e.sink&&null!=e.source)},eT=function(e){return function(t){var n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){var r,i=KZ({objectMode:!0});n.then((function(){i.end()}),(function(e){i.end(e)}));var o=e.source;if(XZ(o))r=function(){var e=(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(o),m.Z),"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();else{if(!$Z(o))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(o,"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)}))}return qZ(i,r())}return e.source}};function tT(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var nT=tT("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),rT=tT("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=LZ((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),iT=(0,Nt.Z)({utf8:nT,"utf-8":nT,hex:cr.gh.base16,latin1:rT,ascii:rT,binary:rT},cr.gh);function oT(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=iT[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):PZ(globalThis.Buffer.from(e,"utf-8"))}var aT=function(e){if(null!=e[Symbol.asyncIterator])return(0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,o.next();case 6:if(!(n=!(a=t.sent).done)){t.next=12;break}return u=a.value,t.abrupt("return",u);case 9:n=!1,t.next=4;break;case 12:t.next=18;break;case 14:t.prev=14,t.t0=t.catch(2),r=!0,i=t.t0;case 18:if(t.prev=18,t.prev=19,!n||null==o.return){t.next=23;break}return t.next=23,o.return();case 23:if(t.prev=23,!r){t.next=26;break}throw i;case 26:return t.finish(23);case 27:return t.finish(18);case 28:return t.abrupt("return",void 0);case 29:case"end":return t.stop()}}),t,null,[[2,14,18,28],[19,,23,27]])})))();var t,n=(0,Ae.Z)(e);try{for(n.s();!(t=n.n()).done;){return t.value}}catch(r){n.e(r)}finally{n.f()}};function sT(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=iT[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}var uT=(0,ru.kg)("libp2p:mss"),cT=oT("\n");function lT(e){var t=new vt(e,cT);return MZ.single(t)}function fT(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=lT(t);!0===n.writeBytes?e.push(r.subarray()):e.push(r)}function hT(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=new vt,o=(0,Ae.Z)(t);try{for(o.s();!(n=o.n()).done;){var a=n.value;i.append(lT(a))}}catch(s){o.e(s)}finally{o.f()}!0===r.writeBytes?e.push(i.subarray()):e.push(i)}function pT(e,t){return dT.apply(this,arguments)}function dT(){return dT=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=1,r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return o})),(0,ot.Z)(r,"next",function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.next(i);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()),a=o=r,null!=(null===n||void 0===n?void 0:n.signal)&&(a=du(o,n.signal)),c=function(e){i=e},e.next=7,YZ(a,(function(e){return HZ(e,{onLength:c,maxDataLength:RZ})}),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,aT(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 7:if(null!=(l=e.sent)&&0!==l.length){e.next=10;break}throw new ar.s("no buffer returned","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");case 10:if(l.get(l.byteLength-1)===cT[0]){e.next=13;break}throw uT.error("Invalid mss message - missing newline - %s",l.subarray()),new ar.s("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");case 13:return e.abrupt("return",l.sublist(0,-1));case 14:case"end":return e.stop()}}),e)}))),dT.apply(this,arguments)}function vT(e,t){return yT.apply(this,arguments)}function yT(){return(yT=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,pT(t,n);case 2:return r=e.sent,e.abrupt("return",sT(r.subarray()));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function gT(e){var t,n=KZ(),r=function(e){var t=(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void(t.next=2);case 2:n=t.sent,r=new vt,i=!1,o=!1,t.prev=6,u=(0,y.Z)(e);case 8:return t.next=10,(0,m.Z)(u.next());case 10:if(!(i=!(c=t.sent).done)){t.next=38;break}if(l=c.value,null!=n){t.next=19;break}return r.append(l),t.next=16,r;case 16:return n=t.sent,r=new vt,t.abrupt("continue",35);case 19:r.append(l);case 20:if(!(r.length>=n)){t.next=35;break}return f=r.sublist(0,n),r.consume(n),t.next=25,f;case 25:if(null!=(n=t.sent)){t.next=33;break}if(!(r.length>0)){t.next=32;break}return t.next=30,r;case 30:n=t.sent,r=new vt;case 32:return t.abrupt("break",35);case 33:t.next=20;break;case 35:i=!1,t.next=8;break;case 38:t.next=44;break;case 40:t.prev=40,t.t0=t.catch(6),o=!0,a=t.t0;case 44:if(t.prev=44,t.prev=45,!i||null==u.return){t.next=49;break}return t.next=49,(0,m.Z)(u.return());case 49:if(t.prev=49,!o){t.next=52;break}throw a;case 52:return t.finish(49);case 53:return t.finish(44);case 54:if(null==n){t.next=56;break}throw Object.assign(new Error("stream ended before ".concat(n," bytes became available")),{code:"ERR_UNDER_READ",buffer:r});case 56:case"end":return t.stop()}}),t,null,[[6,40,44,54],[45,,49,53]])})))();return t.next(),t}(e.source),i=Ut(),o=e.sink((0,g.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",1);case 1:return e.next=3,(0,m.Z)(i.promise);case 3:return t=e.sent,e.delegateYield((0,at.Z)((0,y.Z)(t),m.Z),"t1",5);case 5:case"end":return e.stop()}}),e)})))());o.catch((function(e){t=e}));var a={sink:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==t){e.next=4;break}return e.next=3,Promise.reject(t);case 3:return e.abrupt("return");case 4:return i.resolve(n),e.next=7,o;case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),source:r};return{reader:r,writer:n,stream:a,rest:function(){return n.end()},write:n.push,read:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.next();case 2:if(null==(t=e.sent).value){e.next=5;break}return e.abrupt("return",t.value);case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}}var mT=(0,ru.kg)("libp2p:mss:select");function bT(e,t){return wT.apply(this,arguments)}function wT(){return wT=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v,y,g,m=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=m.length>2&&void 0!==m[2]?m[2]:{},n=Array.isArray(n)?(0,ye.Z)(n):[n],i=gT(t),o=i.reader,a=i.writer,u=i.rest,c=i.stream,null!=(l=n.shift())){e.next=6;break}throw new Error("At least one protocol must be specified");case 6:return mT.trace('select: write ["%s", "%s"]',OZ,l),f=oT(OZ),h=oT(l),hT(a,[f,h],r),e.next=12,vT(o,r);case 12:if(p=e.sent,mT.trace('select: read "%s"',p),p!==OZ){e.next=19;break}return e.next=17,vT(o,r);case 17:p=e.sent,mT.trace('select: read "%s"',p);case 19:if(p!==l){e.next=22;break}return u(),e.abrupt("return",{stream:c,protocol:l});case 22:d=(0,Ae.Z)(n),e.prev=23,d.s();case 25:if((v=d.n()).done){e.next=38;break}return y=v.value,mT.trace('select: write "%s"',y),fT(a,oT(y),r),e.next=31,vT(o,r);case 31:if(g=e.sent,mT.trace('select: read "%s" for "%s"',g,y),g!==y){e.next=36;break}return u(),e.abrupt("return",{stream:c,protocol:y});case 36:e.next=25;break;case 38:e.next=43;break;case 40:e.prev=40,e.t0=e.catch(23),d.e(e.t0);case 43:return e.prev=43,d.f(),e.finish(43);case 46:throw u(),new ar.s("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL");case 48:case"end":return e.stop()}}),e,null,[[23,40,43,46]])}))),wT.apply(this,arguments)}var kT=n(6481),ET=(0,ru.kg)("libp2p:mss:handle");function xT(e,t,n){return _T.apply(this,arguments)}function _T(){return _T=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Array.isArray(n)?n:[n],i=gT(t),o=i.writer,a=i.reader,u=i.rest,c=i.stream;case 2:return e.next=5,vT(a,r);case 5:if(l=e.sent,ET.trace('read "%s"',l),l!==OZ){e.next=11;break}return ET.trace('respond with "%s" for "%s"',OZ,l),fT(o,oT(OZ),r),e.abrupt("continue",2);case 11:if(!n.includes(l)){e.next=16;break}return fT(o,oT(l),r),ET.trace('respond with "%s" for "%s"',l,l),u(),e.abrupt("return",{stream:c,protocol:l});case 16:if("ls"!==l){e.next=20;break}return fT(o,(0,kT.Z)(vt,(0,ye.Z)(n.map((function(e){return lT(oT(e))})))),r),ET.trace('respond with "%s" for %s',n,l),e.abrupt("continue",2);case 20:fT(o,oT("na"),r),ET('respond with "na" for "%s"',l),e.next=2;break;case 24:case"end":return e.stop()}}),e)}))),_T.apply(this,arguments)}var ST=Symbol.for("@libp2p/connection");var AT,ZT="OPEN",TT="CLOSING",CT="CLOSED",IT=(0,ru.kg)("libp2p:connection");AT=Symbol.toStringTag;var DT=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"id",void 0),(0,ot.Z)(this,"remoteAddr",void 0),(0,ot.Z)(this,"remotePeer",void 0),(0,ot.Z)(this,"stat",void 0),(0,ot.Z)(this,"tags",void 0),(0,ot.Z)(this,"_newStream",void 0),(0,ot.Z)(this,"_close",void 0),(0,ot.Z)(this,"_getStreams",void 0),(0,ot.Z)(this,"_closing",void 0),(0,ot.Z)(this,AT,"Connection"),(0,ot.Z)(this,ST,!0);var n=t.remoteAddr,r=t.remotePeer,i=t.newStream,o=t.close,a=t.getStreams,s=t.stat;this.id="".concat(parseInt(String(1e9*Math.random())).toString(36)).concat(Date.now()),this.remoteAddr=n,this.remotePeer=r,this.stat=(0,Nt.Z)((0,Nt.Z)({},s),{},{status:ZT}),this._newStream=i,this._close=o,this._getStreams=a,this.tags=[],this._closing=!1}return(0,W.Z)(e,[{key:"streams",get:function(){return this._getStreams()}},{key:"newStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.stat.status!==TT){e.next=2;break}throw new ar.s("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");case 2:if(this.stat.status!==CT){e.next=4;break}throw new ar.s("the connection is closed","ERR_CONNECTION_CLOSED");case 4:return Array.isArray(t)||(t=[t]),e.next=7,this._newStream(t,n);case 7:return(r=e.sent).stat.direction="outbound",e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"addStream",value:function(e){e.stat.direction="inbound"}},{key:"removeStream",value:function(e){}},{key:"close",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.stat.status!==CT&&!this._closing){e.next=2;break}return e.abrupt("return");case 2:this.stat.status=TT;try{this.streams.forEach((function(e){e.close()}))}catch(t){IT.error(t)}return this._closing=!0,e.next=7,this._close();case 7:this._closing=!1,this.stat.timeline.close=Date.now(),this.stat.status=CT;case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}();var OT=(0,ru.kg)("libp2p:upgrader");function RT(e,t){try{return t.getHandler(e).options.maxInboundStreams}catch(n){if(n.code!==PA.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return 32}function PT(e,t){try{return t.getHandler(e).options.maxOutboundStreams}catch(n){if(n.code!==PA.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return 64}function LT(e,t,n){var r=0;return n.streams.forEach((function(n){n.stat.direction===t&&n.stat.protocol===e&&r++})),r}var NT=function(){function e(t,n){var r,i=this;(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"connectionEncryption",void 0),(0,ot.Z)(this,"muxers",void 0),(0,ot.Z)(this,"inboundUpgradeTimeout",void 0),(0,ot.Z)(this,"events",void 0),this.components=t,this.connectionEncryption=new Map,n.connectionEncryption.forEach((function(e){i.connectionEncryption.set(e.protocol,e)})),this.muxers=new Map,n.muxers.forEach((function(e){i.muxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=null!==(r=n.inboundUpgradeTimeout)&&void 0!==r?r:3e4,this.events=t.events}return(0,W.Z)(e,[{key:"shouldBlockConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===(i=this.components.connectionGater[r])){e.next=6;break}return e.next=4,i(t,n);case 4:if(!e.sent){e.next=6;break}throw new ar.s("The multiaddr connection is blocked by gater.".concat(r),PA.ERR_CONNECTION_INTERCEPTED);case 6:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"upgradeInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v,y,g,m,b,w;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.components.connectionManager.acceptIncomingConnection(t);case 2:if(e.sent){e.next=5;break}throw new ar.s("connection denied",PA.ERR_CONNECTION_DENIED);case 5:c=nb([AbortSignal.timeout(this.inboundUpgradeTimeout)]);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,c)}catch(s){}return e.prev=7,p=yu(t,c),t.source=p.source,t.sink=p.sink,e.next=13,null===(l=(f=this.components.connectionGater).denyInboundConnection)||void 0===l?void 0:l.call(f,t);case 13:if(e.t0=e.sent,!0!==e.t0){e.next=16;break}throw new ar.s("The multiaddr connection is blocked by gater.acceptConnection",PA.ERR_CONNECTION_INTERCEPTED);case 16:if(null===(h=this.components.metrics)||void 0===h||h.trackMultiaddrConnection(t),OT("starting the inbound connection upgrade"),d=t,!0===(null===n||void 0===n?void 0:n.skipProtection)){e.next=26;break}if(null==(v=this.components.connectionProtector)){e.next=26;break}return OT("protecting the inbound connection"),e.next=25,v.protect(t);case 25:d=e.sent;case 26:if(e.prev=26,r=d,!0===(null===n||void 0===n?void 0:n.skipEncryption)){e.next=40;break}return e.next=31,this._encryptInbound(d);case 31:return y=e.sent,r=y.conn,i=y.remotePeer,u=y.protocol,g=(0,Nt.Z)((0,Nt.Z)({},d),r),e.next=38,this.shouldBlockConnection(i,g,"denyInboundEncryptedConnection");case 38:e.next=46;break;case 40:if(null!=(m=t.remoteAddr.getPeerId())){e.next=43;break}throw new ar.s("inbound connection that skipped encryption must have a peer id",PA.ERR_INVALID_MULTIADDR);case 43:b=(0,Ps.jE)(m),u="native",i=b;case 46:if(o=r,null==(null===n||void 0===n?void 0:n.muxerFactory)){e.next=51;break}a=n.muxerFactory,e.next=57;break;case 51:if(!(this.muxers.size>0)){e.next=57;break}return e.next=54,this._multiplexInbound((0,Nt.Z)((0,Nt.Z)({},d),r),this.muxers);case 54:w=e.sent,a=w.muxerFactory,o=w.stream;case 57:e.next=63;break;case 59:throw e.prev=59,e.t1=e.catch(26),OT.error("Failed to upgrade inbound connection",e.t1),e.t1;case 63:return e.next=65,this.shouldBlockConnection(i,t,"denyInboundUpgradedConnection");case 65:return OT("Successfully upgraded inbound connection"),e.abrupt("return",this._createConnection({cryptoProtocol:u,direction:"inbound",maConn:t,upgradedConn:o,muxerFactory:a,remotePeer:i}));case 67:return e.prev=67,this.components.connectionManager.afterUpgradeInbound(),c.clear(),e.finish(67);case 71:case"end":return e.stop()}}),e,this,[[7,,67,71],[26,59]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"upgradeOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v,y;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(i=t.remoteAddr.getPeerId())){e.next=5;break}return o=(0,Ps.jE)(i),e.next=5,this.shouldBlockConnection(o,t,"denyOutboundConnection");case 5:if(null===(r=this.components.metrics)||void 0===r||r.trackMultiaddrConnection(t),OT("Starting the outbound connection upgrade"),h=t,!0===(null===n||void 0===n?void 0:n.skipProtection)){e.next=14;break}if(null==(p=this.components.connectionProtector)){e.next=14;break}return e.next=13,p.protect(t);case 13:h=e.sent;case 14:if(e.prev=14,a=h,!0===(null===n||void 0===n?void 0:n.skipEncryption)){e.next=28;break}return e.next=19,this._encryptOutbound(h,o);case 19:return d=e.sent,a=d.conn,u=d.remotePeer,l=d.protocol,v=(0,Nt.Z)((0,Nt.Z)({},h),a),e.next=26,this.shouldBlockConnection(u,v,"denyOutboundEncryptedConnection");case 26:e.next=32;break;case 28:if(null!=o){e.next=30;break}throw new ar.s("Encryption was skipped but no peer id was passed",PA.ERR_INVALID_PEER);case 30:l="native",u=o;case 32:if(c=a,null==(null===n||void 0===n?void 0:n.muxerFactory)){e.next=37;break}f=n.muxerFactory,e.next=43;break;case 37:if(!(this.muxers.size>0)){e.next=43;break}return e.next=40,this._multiplexOutbound((0,Nt.Z)((0,Nt.Z)({},h),a),this.muxers);case 40:y=e.sent,f=y.muxerFactory,c=y.stream;case 43:e.next=51;break;case 45:return e.prev=45,e.t0=e.catch(14),OT.error("Failed to upgrade outbound connection",e.t0),e.next=50,t.close(e.t0);case 50:throw e.t0;case 51:return e.next=53,this.shouldBlockConnection(u,t,"denyOutboundUpgradedConnection");case 53:return OT("Successfully upgraded outbound connection"),e.abrupt("return",this._createConnection({cryptoProtocol:l,direction:"outbound",maConn:t,upgradedConn:c,muxerFactory:f,remotePeer:u}));case 55:case"end":return e.stop()}}),e,this,[[14,45]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_createConnection",value:function(e){var t,n,r,i,o,a=this,c=e.cryptoProtocol,l=e.direction,f=e.maConn,h=e.upgradedConn,p=e.remotePeer,d=e.muxerFactory;null!=d&&(r=d.createStreamMuxer({direction:l,onIncomingStream:function(e){null!=o&&Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,u,c,f,h;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=a.components.registrar.getProtocols(),t.next=3,xT(e,r);case 3:if(i=t.sent,u=i.stream,c=i.protocol,OT("%s: incoming stream opened on %s",l,c),null!=o){t.next=9;break}return t.abrupt("return");case 9:if(f=RT(c,a.components.registrar),LT(c,"inbound",o)!==f){t.next=15;break}throw h=new ar.s('Too many inbound protocol streams for protocol "'.concat(c,'" - limit ').concat(f),PA.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS),e.abort(h),h;case 15:return e.source=u.source,e.sink=u.sink,e.stat.protocol=c,t.next=20,a.components.peerStore.merge(p,{protocols:[c]});case 20:o.addStream(e),null===(n=a.components.metrics)||void 0===n||n.trackProtocolStream(e,o),a._onStream({connection:o,stream:e,protocol:c});case 23:case"end":return t.stop()}}),t)})))).catch((function(t){OT.error(t),null==e.stat.timeline.close&&e.close()}))},onStreamEnd:function(e){var t;null===(t=o)||void 0===t||t.removeStream(e.id)}}),i=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,i,u,c,f,h,d,v,y=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=y.length>1&&void 0!==y[1]?y[1]:{},null!=r){e.next=3;break}throw new ar.s("Stream is not multiplexed",PA.ERR_MUXER_UNAVAILABLE);case 3:return OT("%s: starting new stream on %s",l,t),e.next=6,r.newStream();case 6:if(i=e.sent,e.prev=7,null==n.signal){OT("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",t),n.signal=AbortSignal.timeout(3e4);try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,n.signal)}catch(s){}}return e.next=11,bT(i,t,n);case 11:if(c=e.sent,f=c.stream,h=c.protocol,d=PT(h,a.components.registrar),LT(h,"outbound",o)!==d){e.next=20;break}throw v=new ar.s('Too many outbound protocol streams for protocol "'.concat(h,'" - limit ').concat(d),PA.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS),i.abort(v),v;case 20:return e.next=22,a.components.peerStore.merge(p,{protocols:[h]});case 22:return i.source=f.source,i.sink=f.sink,i.stat.protocol=h,null===(u=a.components.metrics)||void 0===u||u.trackProtocolStream(i,o),e.abrupt("return",i);case 29:if(e.prev=29,e.t0=e.catch(7),OT.error("could not create new stream",e.t0),null==i.stat.timeline.close&&i.close(),null==e.t0.code){e.next=35;break}throw e.t0;case 35:throw new ar.s(String(e.t0),PA.ERR_UNSUPPORTED_PROTOCOL);case 36:case"end":return e.stop()}}),e,null,[[7,29]])})));return function(t){return e.apply(this,arguments)}}(),Promise.all([r.sink(h.source),h.sink(r.source)]).catch((function(e){OT.error(e)})));var v=f.timeline;f.timeline=new Proxy(v,{set:function(){return null!=o&&"close"===(arguments.length<=1?void 0:arguments[1])&&null!=(arguments.length<=2?void 0:arguments[2])&&null==v.close&&(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"OPEN"!==o.stat.status){e.next=4;break}return e.next=4,o.close();case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),OT.error(e.t0);case 9:return e.prev=9,a.events.safeDispatchEvent("connection:close",{detail:o}),e.finish(9);case 12:case"end":return e.stop()}}),e,null,[[0,6,9,12]])})))().catch((function(e){OT.error(e)})),Reflect.set.apply(Reflect,arguments)}}),f.timeline.upgraded=Date.now();var y,g=function(){throw new ar.s("connection is not multiplexed",PA.ERR_CONNECTION_NOT_MULTIPLEXED)};return y={remoteAddr:f.remoteAddr,remotePeer:p,stat:{status:"OPEN",direction:l,timeline:f.timeline,multiplexer:null===(t=r)||void 0===t?void 0:t.protocol,encryption:c},newStream:null!==(n=i)&&void 0!==n?n:g,getStreams:function(){return null!=r?r.streams:g()},close:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f.close();case 2:null!=r&&r.close();case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},o=new DT(y),this.events.safeDispatchEvent("connection:open",{detail:o}),o}},{key:"_onStream",value:function(e){var t=e.connection,n=e.stream,r=e.protocol;(0,this.components.registrar.getHandler(r).handler)({connection:t,stream:n})}},{key:"_encryptInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Array.from(this.connectionEncryption.keys()),OT("handling inbound crypto protocol selection",n),e.prev=2,e.next=5,xT(t,n,{writeBytes:!0});case 5:if(r=e.sent,i=r.stream,o=r.protocol,null!=(a=this.connectionEncryption.get(o))){e.next=11;break}throw new Error("no crypto module found for ".concat(o));case 11:return OT("encrypting inbound connection..."),e.t0=Nt.Z,e.t1=Nt.Z,e.t2={},e.next=17,a.secureInbound(this.components.peerId,i);case 17:return e.t3=e.sent,e.t4=(0,e.t1)(e.t2,e.t3),e.t5={},e.t6={protocol:o},e.abrupt("return",(0,e.t0)(e.t4,e.t5,e.t6));case 24:throw e.prev=24,e.t7=e.catch(2),new ar.s(String(e.t7),PA.ERR_ENCRYPTION_FAILED);case 27:case"end":return e.stop()}}),e,this,[[2,24]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_encryptOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Array.from(this.connectionEncryption.keys()),OT("selecting outbound crypto protocol",r),e.prev=2,e.next=5,bT(t,r,{writeBytes:!0});case 5:if(i=e.sent,o=i.stream,a=i.protocol,null!=(u=this.connectionEncryption.get(a))){e.next=11;break}throw new Error("no crypto module found for ".concat(a));case 11:return OT("encrypting outbound connection to %p",n),e.t0=Nt.Z,e.t1=Nt.Z,e.t2={},e.next=17,u.secureOutbound(this.components.peerId,o,n);case 17:return e.t3=e.sent,e.t4=(0,e.t1)(e.t2,e.t3),e.t5={},e.t6={protocol:a},e.abrupt("return",(0,e.t0)(e.t4,e.t5,e.t6));case 24:throw e.prev=24,e.t7=e.catch(2),new ar.s(String(e.t7),PA.ERR_ENCRYPTION_FAILED);case 27:case"end":return e.stop()}}),e,this,[[2,24]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_multiplexOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Array.from(n.keys()),OT("outbound selecting muxer %s",r),e.prev=2,e.next=5,bT(t,r,{writeBytes:!0});case 5:return i=e.sent,o=i.stream,a=i.protocol,OT("%s selected as muxer protocol",a),u=n.get(a),e.abrupt("return",{stream:o,muxerFactory:u});case 13:throw e.prev=13,e.t0=e.catch(2),OT.error("error multiplexing outbound stream",e.t0),new ar.s(String(e.t0),PA.ERR_MUXER_UNAVAILABLE);case 17:case"end":return e.stop()}}),e,null,[[2,13]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_multiplexInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Array.from(n.keys()),OT("inbound handling muxers %s",r),e.prev=2,e.next=5,xT(t,r,{writeBytes:!0});case 5:return i=e.sent,o=i.stream,a=i.protocol,u=n.get(a),e.abrupt("return",{stream:o,muxerFactory:u});case 12:throw e.prev=12,e.t0=e.catch(2),OT.error("error multiplexing inbound stream",e.t0),new ar.s(String(e.t0),PA.ERR_MUXER_UNAVAILABLE);case 16:case"end":return e.stop()}}),e,null,[[2,12]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),BT=(0,ru.kg)("libp2p"),MT=new WeakMap,FT=new WeakSet,jT=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r,i,o,a,s,u,c;(0,K.Z)(this,n),c=t.call(this),pw((0,nr.Z)(c),FT),(0,ot.Z)((0,nr.Z)(c),"peerId",void 0),(0,ot.Z)((0,nr.Z)(c),"peerStore",void 0),(0,ot.Z)((0,nr.Z)(c),"contentRouting",void 0),(0,ot.Z)((0,nr.Z)(c),"peerRouting",void 0),(0,ot.Z)((0,nr.Z)(c),"keychain",void 0),(0,ot.Z)((0,nr.Z)(c),"metrics",void 0),(0,ot.Z)((0,nr.Z)(c),"services",void 0),(0,ot.Z)((0,nr.Z)(c),"components",void 0),(0,cl.Z)((0,nr.Z)(c),MT,{writable:!0,value:void 0});var l=new Ch,f=l.dispatchEvent.bind(l);l.dispatchEvent=function(e){var t=f(e),n=c.dispatchEvent(new Dh(e.type,{detail:e.detail}));return t||n};try{null===Xb.setMaxListeners||void 0===Xb.setMaxListeners||(0,Xb.setMaxListeners)(1/0,l)}catch(w){}(0,ll.Z)((0,nr.Z)(c),MT,!1),c.peerId=e.peerId,c.services={};var h=c.components=function(){var e=new JS(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return new Proxy(e,{get:function(t,n,r){if("string"===typeof n&&!tA.includes(n)){var i=e.components[n];if(null==i&&!eA.includes(n))throw new ar.s("".concat(n," not set"),"ERR_SERVICE_MISSING");return i}return Reflect.get(t,n,r)},set:function(t,n,r){return"string"===typeof n?e.components[n]=r:Reflect.set(t,n,r),!0}})}({peerId:e.peerId,events:l,datastore:null!==(r=e.datastore)&&void 0!==r?r:new Hm,connectionGater:wA(e.connectionGater)});c.peerStore=c.configureComponent("peerStore",new iS(h,(0,Nt.Z)({addressFilter:c.components.connectionGater.filterMultiaddrForPeer},e.peerStore))),null!=e.metrics&&(c.metrics=c.configureComponent("metrics",e.metrics(c.components))),h.events.addEventListener("peer:update",(function(e){null==e.detail.previous&&c.safeDispatchEvent("peer:discovery",{detail:e.detail.peer})})),null!=e.connectionProtector&&c.configureComponent("connectionProtector",e.connectionProtector(h)),c.components.upgrader=new NT(c.components,{connectionEncryption:(null!==(i=e.connectionEncryption)&&void 0!==i?i:[]).map((function(e,t){return c.configureComponent("connection-encryption-".concat(t),e(c.components))})),muxers:(null!==(o=e.streamMuxers)&&void 0!==o?o:[]).map((function(e,t){return c.configureComponent("stream-muxers-".concat(t),e(c.components))})),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),c.configureComponent("transportManager",new DZ(c.components,e.transportManager)),c.configureComponent("connectionManager",new mZ(c.components,e.connectionManager)),c.configureComponent("registrar",new CZ(c.components)),c.configureComponent("addressManager",new XS(c.components,e.addresses));var p=qk.generateOptions();c.keychain=c.configureComponent("keyChain",new qk(c.components,(0,Nt.Z)((0,Nt.Z)({},p),e.keychain)));var d=(null!==(a=e.peerRouters)&&void 0!==a?a:[]).map((function(e,t){return c.configureComponent("peer-router-".concat(t),e(c.components))}));c.peerRouting=c.components.peerRouting=c.configureComponent("peerRouting",new ZZ(c.components,{routers:d}));var v=(null!==(s=e.contentRouters)&&void 0!==s?s:[]).map((function(e,t){return c.configureComponent("content-router-".concat(t),e(c.components))}));if(c.contentRouting=c.components.contentRouting=c.configureComponent("contentRouting",new _Z(c.components,{routers:v})),(null!==(u=e.peerDiscovery)&&void 0!==u?u:[]).forEach((function(e,t){c.configureComponent("peer-discovery-".concat(t),e(c.components)).addEventListener("peer",(function(e){dw((0,nr.Z)(c),FT,UT).call((0,nr.Z)(c),e)}))})),e.transports.forEach((function(e,t){c.components.transportManager.add(c.configureComponent("transport-".concat(t),e(c.components)))})),null!=e.services)for(var y=0,g=Object.keys(e.services);y<g.length;y++){var m=g[y],b=(0,e.services[m])(c.components);null!=b?(c.services[m]=b,c.configureComponent(m,b),null!=b[pk]&&(BT("registering service %s for content routing",m),v.push(b[pk])),null!=b[vk]&&(BT("registering service %s for peer routing",m),d.push(b[vk])),null!=b[dk]&&(BT("registering service %s for peer discovery",m),b[dk].addEventListener("peer",(function(e){dw((0,nr.Z)(c),FT,UT).call((0,nr.Z)(c),e)})))):BT.error("service factory %s returned null or undefined instance",m)}return c}return(0,W.Z)(n,[{key:"configureComponent",value:function(e,t){return null==t&&BT.error("component %s was null or undefined",e),this.components[e]=t,t}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,fl.Z)(this,MT)){e.next=2;break}return e.abrupt("return");case 2:return(0,ll.Z)(this,MT,!0),BT("libp2p is starting"),e.next=6,this.keychain.listKeys();case 6:if(null!=e.sent.find((function(e){return"self"===e.name}))){e.next=11;break}return BT("importing self key into keychain"),e.next=11,this.keychain.importPeer("self",this.components.peerId);case 11:return e.prev=11,e.next=14,null===(t=(n=this.components).beforeStart)||void 0===t?void 0:t.call(n);case 14:return e.next=16,this.components.start();case 16:return e.next=18,null===(r=(i=this.components).afterStart)||void 0===r?void 0:r.call(i);case 18:this.safeDispatchEvent("start",{detail:this}),BT("libp2p has started"),e.next=28;break;case 22:return e.prev=22,e.t0=e.catch(11),BT.error("An error occurred starting libp2p",e.t0),e.next=27,this.stop();case 27:throw e.t0;case 28:case"end":return e.stop()}}),e,this,[[11,22]])})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,fl.Z)(this,MT)){e.next=2;break}return e.abrupt("return");case 2:return BT("libp2p is stopping"),(0,ll.Z)(this,MT,!1),e.next=6,null===(t=(n=this.components).beforeStop)||void 0===t?void 0:t.call(n);case 6:return e.next=8,this.components.stop();case 8:return e.next=10,null===(r=(i=this.components).afterStop)||void 0===r?void 0:r.call(i);case 10:this.safeDispatchEvent("stop",{detail:this}),BT("libp2p has stopped");case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"isStarted",value:function(){return(0,fl.Z)(this,MT)}},{key:"getConnections",value:function(e){return this.components.connectionManager.getConnections(e)}},{key:"getDialQueue",value:function(){return this.components.connectionManager.getDialQueue()}},{key:"getPeers",value:function(){var e,t=new Xk,n=(0,Ae.Z)(this.components.connectionManager.getConnections());try{for(n.s();!(e=n.n()).done;){var r=e.value;t.add(r.remotePeer)}}catch(i){n.e(i)}finally{n.f()}return Array.from(t)}},{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",this.components.connectionManager.openConnection(t,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"dialProtocol",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>2&&void 0!==o[2]?o[2]:{},null!=n){e.next=3;break}throw new ar.s("no protocols were provided to open a stream",PA.ERR_INVALID_PROTOCOLS_FOR_STREAM);case 3:if(0!==(n=Array.isArray(n)?n:[n]).length){e.next=6;break}throw new ar.s("no protocols were provided to open a stream",PA.ERR_INVALID_PROTOCOLS_FOR_STREAM);case 6:return e.next=8,this.dial(t,r);case 8:return i=e.sent,e.abrupt("return",i.newStream(n,r));case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getMultiaddrs",value:function(){return this.components.addressManager.getAddresses()}},{key:"getProtocols",value:function(){return this.components.registrar.getProtocols()}},{key:"hangUp",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return US(t)&&(t=(0,Ps.jE)(null!==(n=t.getPeerId())&&void 0!==n?n:"")),e.next=3,this.components.connectionManager.closeConnections(t);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getPublicKey",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.length>1&&void 0!==a[1]?a[1]:{},BT("getPublicKey %p",t),null==t.publicKey){e.next=4;break}return e.abrupt("return",t.publicKey);case 4:return e.next=6,this.peerStore.get(t);case 6:if(null==(r=e.sent).id.publicKey){e.next=9;break}return e.abrupt("return",r.id.publicKey);case 9:return i=aS([Dm("/pk/"),t.multihash.digest]),e.next=12,this.contentRouting.get(i,n);case 12:return Zs(o=e.sent),e.next=16,this.peerStore.patch(t,{publicKey:o});case 16:return e.abrupt("return",o);case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"handle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Array.isArray(t)||(t=[t]),e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.components.registrar.handle(t,n,r);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"unhandle",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Array.isArray(t)||(t=[t]),e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.components.registrar.unhandle(t);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.components.registrar.register(t,n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"unregister",value:function(e){this.components.registrar.unregister(e)}}]),n}(Ch);function UT(e){var t=e.detail;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs,protocols:t.protocols}).catch((function(e){BT.error(e)})):BT.error(new Error(PA.ERR_DISCOVERED_SELF))}function zT(e){return HT.apply(this,arguments)}function HT(){return(HT=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.peerId){e.next=14;break}if(null==(n=t.datastore)){e.next=14;break}return e.prev=3,r=new qk({datastore:n},(0,mk.Z)(qk.generateOptions(),t.keychain)),e.next=7,r.exportPeerId("self");case 7:t.peerId=e.sent,e.next=14;break;case 10:if(e.prev=10,e.t0=e.catch(3),"ERR_NOT_FOUND"===e.t0.code){e.next=14;break}throw e.t0;case 14:if(null!=t.peerId){e.next=18;break}return e.next=17,rE();case 17:t.peerId=e.sent;case 18:return e.abrupt("return",new jT(HA(t)));case 19:case"end":return e.stop()}}),e,null,[[3,10]])})))).apply(this,arguments)}function VT(e){return GT.apply(this,arguments)}function GT(){return(GT=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zT(t);case 2:if(n=e.sent,!1===t.start){e.next=6;break}return e.next=6,n.start();case 6:return e.abrupt("return",n);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var KT=function(){function e(t){if((0,K.Z)(this,e),!(t>0)||0!==(t-1&t))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}return(0,W.Z)(e,[{key:"push",value:function(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}},{key:"shift",value:function(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}},{key:"isEmpty",value:function(){return void 0===this.buffer[this.btm]}}]),e}(),WT=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.hwm=null!==(t=n.splitLimit)&&void 0!==t?t:16,this.head=new KT(this.hwm),this.tail=this.head,this.size=0}return(0,W.Z)(e,[{key:"calculateSize",value:function(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}},{key:"push",value:function(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){var t=this.head;this.head=t.next=new KT(2*this.head.buffer.length),this.head.push(e)}}},{key:"shift",value:function(){var e,t=this.tail.shift();if(void 0===t&&null!=this.tail.next){var n=this.tail.next;this.tail.next=null,this.tail=n,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}},{key:"isEmpty",value:function(){return this.head.isEmpty()}}]),e}();function qT(){return YT((function(e){var t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function YT(e,t){var n,r,i,o,a,c,l=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,f=new WT,h=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(f.isEmpty()){t.next=2;break}return t.abrupt("return",e(f));case 2:if(!c){t.next=4;break}return t.abrupt("return",{done:!0});case 4:return t.next=6,new Promise((function(t,n){a=function(r){a=null,f.push(r);try{t(e(f))}catch(i){n(i)}return o}}));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e){return null!=a?a(e):(f.push(e),o)},d=function(e){var n;if(c)return o;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:e})},v=function(e){return c?o:(c=!0,null!=e?function(e){return f=new WT,null!=a?a({error:e}):(f.push({error:e}),o)}(e):p({done:!0}))};if(r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(r,"next",h),(0,ot.Z)(r,"return",(function(){return f=new WT,v(),{done:!0}})),(0,ot.Z)(r,"throw",(function(e){return v(e),{done:!0}})),(0,ot.Z)(r,"push",d),(0,ot.Z)(r,"end",v),Xt("get",r,"readableLength",(function(){return f.size})),o=r,null==l)return o;var y=o;return i={},(0,ot.Z)(i,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(i,"next",(function(){return y.next()})),(0,ot.Z)(i,"throw",(function(e){return y.throw(e),null!=l&&(l(e),l=void 0),{done:!0}})),(0,ot.Z)(i,"return",(function(){return y.return(),null!=l&&(l(),l=void 0),{done:!0}})),(0,ot.Z)(i,"push",d),(0,ot.Z)(i,"end",(function(e){return y.end(e),null!=l&&(l(e),l=void 0),o})),Xt("get",i,"readableLength",(function(){return y.readableLength})),o=i}var QT=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=[],i=0,o=t;i<o.length;i++){var a=o[i];null==a[Symbol.asyncIterator]&&r.push(a)}return r.length===t.length?(0,s.Z)().mark((function e(){var t,n,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(r),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=8;break}return i=n.value,e.delegateYield(i,"t0",6);case 6:e.next=3;break;case 8:e.next=13;break;case 10:e.prev=10,e.t1=e.catch(1),t.e(e.t1);case 13:return e.prev=13,t.f(),e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[1,10,13,16]])}))():(0,g.Z)((0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=qT({objectMode:!0}),Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,i=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(r=!(u=e.sent).done)){e.next=12;break}c=u.value,n.push(c);case 9:r=!1,e.next=4;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(2),i=!0,o=e.t0;case 18:if(e.prev=18,e.prev=19,!r||null==a.return){e.next=23;break}return e.next=23,a.return();case 23:if(e.prev=23,!i){e.next=26;break}throw o;case 26:return e.finish(23);case 27:return e.finish(18);case 28:case"end":return e.stop()}}),e,null,[[2,14,18,28],[19,,23,27]])})));return function(t){return e.apply(this,arguments)}}()));case 3:n.end(),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),n.end(e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))),e.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",3);case 3:case"end":return e.stop()}}),e)})))()};function XT(e){if(null==e)throw new Error("Empty pipeline");if(tC(e)){var t=e;e=function(){return t.source}}else if(eC(e)||JT(e)){var n=e;e=function(){return n}}for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];var a=[e].concat(i);if(a.length>1&&tC(a[a.length-1])&&(a[a.length-1]=a[a.length-1].sink),a.length>2)for(var s=1;s<a.length-1;s++)tC(a[s])&&(a[s]=nC(a[s]));return $T.apply(void 0,(0,ye.Z)(a))}var $T=function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},JT=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator])},eC=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.iterator])},tC=function(e){return null!=e&&(null!=e.sink&&null!=e.source)},nC=function(e){return function(t){var n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){var r,i=qT({objectMode:!0});n.then((function(){i.end()}),(function(e){i.end(e)}));var o=e.source;if(JT(o))r=function(){var e=(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(o),m.Z),"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();else{if(!eC(o))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(o,"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)}))}return QT(i,r())}return e.source}},rC=function(){function e(t,n,r){(0,K.Z)(this,e),this.gossip=t,this.msgs=new Map,this.history=[],this.notValidatedCount=0,this.msgIdToStrFn=r;for(var i=0;i<n;i++)this.history[i]=[]}return(0,W.Z)(e,[{key:"size",get:function(){return this.msgs.size}},{key:"put",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.msgIdStr;return!this.msgs.has(r)&&(this.msgs.set(r,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push((0,Nt.Z)((0,Nt.Z)({},e),{},{topic:t.topic})),n||this.notValidatedCount++,!0)}},{key:"observeDuplicate",value:function(e,t){var n=this.msgs.get(e);n&&!n.validated&&n.originatingPeers.add(t)}},{key:"get",value:function(e){var t;return null===(t=this.msgs.get(this.msgIdToStrFn(e)))||void 0===t?void 0:t.message}},{key:"getWithIWantCount",value:function(e,t){var n,r=this.msgs.get(e);if(!r)return null;var i=(null!==(n=r.iwantCounts.get(t))&&void 0!==n?n:0)+1;return r.iwantCounts.set(t,i),{msg:r.message,count:i}}},{key:"getGossipIDs",value:function(e){for(var t=this,n=new Map,r=0;r<this.gossip;r++)this.history[r].forEach((function(r){var i=t.msgs.get(r.msgIdStr);if(i&&i.validated&&e.has(r.topic)){var o=n.get(r.topic);o||(o=[],n.set(r.topic,o)),o.push(r.msgId)}}));return n}},{key:"validate",value:function(e){var t=this.msgs.get(e);if(!t)return null;t.validated||this.notValidatedCount--;var n=t.message,r=t.originatingPeers;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:r}}},{key:"shift",value:function(){var e=this;this.history[this.history.length-1].forEach((function(t){var n=e.msgs.get(t.msgIdStr);n&&(e.msgs.delete(t.msgIdStr),n.validated||e.notValidatedCount--)})),this.history.pop(),this.history.unshift([])}},{key:"remove",value:function(e){var t=this.msgs.get(e);return t?(this.msgs.delete(e),t):null}}]),e}(),iC=(n.p+"static/media/rpc.3ba5ca7bdb004060d5e2.cjs").RPC,oC="/floodsub/1.0.0",aC="/meshsub/1.0.0",sC="/meshsub/1.1.0",uC=5e3;function cC(e){if(e.length<=1)return e;for(var t=0;t<e.length;t++){var n=Math.floor(Math.random()*Math.floor(e.length)),r=e[t];e[t]=e[n],e[n]=r}return e}function lC(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function fC(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?lC(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function hC(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var pC=hC("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),dC=hC("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=fC((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),vC=(0,Nt.Z)({utf8:pC,"utf-8":pC,hex:cr.gh.base16,latin1:dC,ascii:dC,binary:dC},cr.gh);function yC(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=vC[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}function gC(e){return yC(e,"base64")}var mC,bC,wC,kC,EC,xC,_C="StrictSign",SC="StrictNoSign";function AC(e){switch(e){case mC.Ignore:return kC.Ignore;case mC.Reject:return kC.Reject}}function ZC(e,t){return TC.apply(this,arguments)}function TC(){return(TC=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t,e.next=e.t0===_C?3:e.t0===SC?13:14;break;case 3:if(n){e.next=5;break}throw Error("Must provide PeerId");case 5:if(null!=n.privateKey){e.next=7;break}throw Error("Cannot sign message, no private key present");case 7:if(null!=n.publicKey){e.next=9;break}throw Error("Cannot sign message, no public key present");case 9:return e.next=11,Cs(n.privateKey);case 11:return r=e.sent,e.abrupt("return",{type:wC.Signing,author:n,key:n.publicKey,privateKey:r});case 13:return e.abrupt("return",{type:wC.Anonymous});case 14:throw new Error('Unknown signature policy "'.concat(t,'"'));case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(e){e.Accept="accept",e.Ignore="ignore",e.Reject="reject"}(mC||(mC={})),function(e){e.StrictSign="StrictSign",e.StrictNoSign="StrictNoSign"}(bC||(bC={})),function(e){e[e.Signing=0]="Signing",e[e.Anonymous=1]="Anonymous"}(wC||(wC={})),function(e){e.Error="error",e.Ignore="ignore",e.Reject="reject",e.Blacklisted="blacklisted"}(kC||(kC={})),function(e){e.InvalidSignature="invalid_signature",e.InvalidSeqno="invalid_seqno",e.InvalidPeerId="invalid_peerid",e.SignaturePresent="signature_present",e.SeqnoPresent="seqno_present",e.FromPresent="from_present",e.TransformFailed="transform_failed"}(EC||(EC={})),function(e){e.duplicate="duplicate",e.invalid="invalid",e.valid="valid"}(xC||(xC={}));var CC="ERR_INVALID_PEER_SCORE_PARAMS",IC={topics:{},topicScoreCap:10,appSpecificScore:function(){return 0},appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:36e5},DC={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function OC(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,Nt.Z)((0,Nt.Z)((0,Nt.Z)({},IC),e),{},{topics:e.topics?Object.entries(e.topics).reduce((function(e,t){var n=(0,k.Z)(t,2),r=n[0],i=n[1];return e[r]=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,Nt.Z)((0,Nt.Z)({},DC),e)}(i),e}),{}):{}})}function RC(e){if(e.topicWeight<0)throw new ar.s("invalid topic weight; must be >= 0",CC);if(0===e.timeInMeshQuantum)throw new ar.s("invalid TimeInMeshQuantum; must be non zero",CC);if(e.timeInMeshWeight<0)throw new ar.s("invalid TimeInMeshWeight; must be positive (or 0 to disable)",CC);if(0!==e.timeInMeshWeight&&e.timeInMeshQuantum<=0)throw new ar.s("invalid TimeInMeshQuantum; must be positive",CC);if(0!==e.timeInMeshWeight&&e.timeInMeshCap<=0)throw new ar.s("invalid TimeInMeshCap; must be positive",CC);if(e.firstMessageDeliveriesWeight<0)throw new ar.s("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",CC);if(0!==e.firstMessageDeliveriesWeight&&(e.firstMessageDeliveriesDecay<=0||e.firstMessageDeliveriesDecay>=1))throw new ar.s("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",CC);if(0!==e.firstMessageDeliveriesWeight&&e.firstMessageDeliveriesCap<=0)throw new ar.s("invalid FirstMessageDeliveriesCap; must be positive",CC);if(e.meshMessageDeliveriesWeight>0)throw new ar.s("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",CC);if(0!==e.meshMessageDeliveriesWeight&&(e.meshMessageDeliveriesDecay<=0||e.meshMessageDeliveriesDecay>=1))throw new ar.s("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",CC);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesCap<=0)throw new ar.s("invalid MeshMessageDeliveriesCap; must be positive",CC);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesThreshold<=0)throw new ar.s("invalid MeshMessageDeliveriesThreshold; must be positive",CC);if(e.meshMessageDeliveriesWindow<0)throw new ar.s("invalid MeshMessageDeliveriesWindow; must be non-negative",CC);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesActivation<1e3)throw new ar.s("invalid MeshMessageDeliveriesActivation; must be at least 1s",CC);if(e.meshFailurePenaltyWeight>0)throw new ar.s("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",CC);if(0!==e.meshFailurePenaltyWeight&&(e.meshFailurePenaltyDecay<=0||e.meshFailurePenaltyDecay>=1))throw new ar.s("invalid MeshFailurePenaltyDecay; must be between 0 and 1",CC);if(e.invalidMessageDeliveriesWeight>0)throw new ar.s("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",CC);if(e.invalidMessageDeliveriesDecay<=0||e.invalidMessageDeliveriesDecay>=1)throw new ar.s("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",CC)}var PC={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function LC(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,Nt.Z)((0,Nt.Z)({},PC),e)}function NC(e,t,n,r){var i=0;Object.entries(t.topics).forEach((function(e){var t=(0,k.Z)(e,2),r=t[0],o=t[1],a=n.topics[r];if(void 0!==a){var s=0;if(o.inMesh){var u=o.meshTime/a.timeInMeshQuantum;u>a.timeInMeshCap&&(u=a.timeInMeshCap),s+=u*a.timeInMeshWeight}var c=o.firstMessageDeliveries;if(c>a.firstMessageDeliveriesCap&&(c=a.firstMessageDeliveriesCap),s+=c*a.firstMessageDeliveriesWeight,o.meshMessageDeliveriesActive&&o.meshMessageDeliveries<a.meshMessageDeliveriesThreshold){var l=a.meshMessageDeliveriesThreshold-o.meshMessageDeliveries;s+=l*l*a.meshMessageDeliveriesWeight}s+=o.meshFailurePenalty*a.meshFailurePenaltyWeight,s+=o.invalidMessageDeliveries*o.invalidMessageDeliveries*a.invalidMessageDeliveriesWeight,i+=s*a.topicWeight}})),n.topicScoreCap>0&&i>n.topicScoreCap&&(i=n.topicScoreCap);var o=n.appSpecificScore(e);if(i+=o*n.appSpecificWeight,t.knownIPs.forEach((function(e){if(!n.IPColocationFactorWhitelist.has(e)){var t=r.get(e),o=t?t.size:0;if(o>n.IPColocationFactorThreshold){var a=o-n.IPColocationFactorThreshold;i+=a*a*n.IPColocationFactorWeight}}})),t.behaviourPenalty>n.behaviourPenaltyThreshold){var a=t.behaviourPenalty-n.behaviourPenaltyThreshold;i+=a*a*n.behaviourPenaltyWeight}return i}var BC,MC=n(68718),FC=n.n(MC);!function(e){e[e.unknown=0]="unknown",e[e.valid=1]="valid",e[e.invalid=2]="invalid",e[e.ignored=3]="ignored"}(BC||(BC={}));var jC=function(){function e(){(0,K.Z)(this,e),this.records=new Map,this.queue=new(FC())}return(0,W.Z)(e,[{key:"ensureRecord",value:function(e){var t=this.records.get(e);if(t)return t;t={status:BC.unknown,firstSeen:Date.now(),validated:0,peers:new Set},this.records.set(e,t);var n={msgId:e,expire:Date.now()+12e4};return this.queue.push(n),t}},{key:"gc",value:function(){for(var e=Date.now(),t=this.queue.peekFront();t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}},{key:"clear",value:function(){this.records.clear(),this.queue.clear()}}]),e}();function UC(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){return!0},r=new Set;if(t<=0)return r;var i,o=(0,Ae.Z)(e);try{for(o.s();!(i=o.n()).done;){var a=i.value;if(r.size>=t)break;n(a)&&(r.add(a),e.delete(a))}}catch(s){o.e(s)}finally{o.f()}return r}function zC(e,t){return UC(e,t,(function(){return!0}))}var HC,VC,GC,KC,WC,qC,YC=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this)).getDefault=e,r}return(0,W.Z)(n,[{key:"getOrDefault",value:function(e){var t=(0,Ah.Z)((0,Zh.Z)(n.prototype),"get",this).call(this,e);return void 0===t&&(t=this.getDefault(),this.set(e,t)),t}}]),n}((0,Ze.Z)(Map)),QC=(0,ru.kg)("libp2p:gossipsub:score"),XC=function(){function e(t,n,r){var i;(0,K.Z)(this,e),this.params=t,this.metrics=n,this.peerStats=new Map,this.peerIPs=new YC((function(){return new Set})),this.scoreCache=new Map,this.deliveryRecords=new jC,function(e){for(var t=0,n=Object.entries(e.topics);t<n.length;t++){var r=(0,k.Z)(n[t],2),i=r[0],o=r[1];try{RC(o)}catch(a){throw new ar.s("invalid score parameters for topic ".concat(i,": ").concat(a.message),CC)}}if(e.topicScoreCap<0)throw new ar.s("invalid topic score cap; must be positive (or 0 for no cap)",CC);if(null===e.appSpecificScore||void 0===e.appSpecificScore)throw new ar.s("missing application specific score function",CC);if(e.IPColocationFactorWeight>0)throw new ar.s("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",CC);if(0!==e.IPColocationFactorWeight&&e.IPColocationFactorThreshold<1)throw new ar.s("invalid IPColocationFactorThreshold; must be at least 1",CC);if(e.behaviourPenaltyWeight>0)throw new ar.s("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",CC);if(0!==e.behaviourPenaltyWeight&&(e.behaviourPenaltyDecay<=0||e.behaviourPenaltyDecay>=1))throw new ar.s("invalid BehaviourPenaltyDecay; must be between 0 and 1",CC);if(e.decayInterval<1e3)throw new ar.s("invalid DecayInterval; must be at least 1s",CC);if(e.decayToZero<=0||e.decayToZero>=1)throw new ar.s("invalid DecayToZero; must be between 0 and 1",CC)}(t),this.scoreCacheValidityMs=r.scoreCacheValidityMs,this.computeScore=null!==(i=r.computeScore)&&void 0!==i?i:NC}return(0,W.Z)(e,[{key:"size",get:function(){return this.peerStats.size}},{key:"start",value:function(){var e=this;this._backgroundInterval?QC("Peer score already running"):(this._backgroundInterval=setInterval((function(){return e.background()}),this.params.decayInterval),QC("started"))}},{key:"stop",value:function(){this._backgroundInterval?(clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),QC("stopped")):QC("Peer score already stopped")}},{key:"background",value:function(){this.refreshScores(),this.deliveryRecords.gc()}},{key:"dumpPeerScoreStats",value:function(){return Object.fromEntries(Array.from(this.peerStats.entries()).map((function(e){var t=(0,k.Z)(e,2);return[t[0],t[1]]})))}},{key:"refreshScores",value:function(){var e=this,t=Date.now(),n=this.params.decayToZero;this.peerStats.forEach((function(r,i){r.connected?(Object.entries(r.topics).forEach((function(r){var i=(0,k.Z)(r,2),o=i[0],a=i[1],s=e.params.topics[o];void 0!==s&&(a.firstMessageDeliveries*=s.firstMessageDeliveriesDecay,a.firstMessageDeliveries<n&&(a.firstMessageDeliveries=0),a.meshMessageDeliveries*=s.meshMessageDeliveriesDecay,a.meshMessageDeliveries<n&&(a.meshMessageDeliveries=0),a.meshFailurePenalty*=s.meshFailurePenaltyDecay,a.meshFailurePenalty<n&&(a.meshFailurePenalty=0),a.invalidMessageDeliveries*=s.invalidMessageDeliveriesDecay,a.invalidMessageDeliveries<n&&(a.invalidMessageDeliveries=0),a.inMesh&&(a.meshTime=t-a.graftTime,a.meshTime>s.meshMessageDeliveriesActivation&&(a.meshMessageDeliveriesActive=!0)))})),r.behaviourPenalty*=e.params.behaviourPenaltyDecay,r.behaviourPenalty<n&&(r.behaviourPenalty=0)):t>r.expire&&(e.removeIPsForPeer(i,r.knownIPs),e.peerStats.delete(i),e.scoreCache.delete(i))}))}},{key:"score",value:function(e){var t,n;null===(t=this.metrics)||void 0===t||t.scoreFnCalls.inc();var r=this.peerStats.get(e);if(!r)return 0;var i=Date.now(),o=this.scoreCache.get(e);if(o&&o.cacheUntil>i)return o.score;null===(n=this.metrics)||void 0===n||n.scoreFnRuns.inc();var a,s=this.computeScore(e,r,this.params,this.peerIPs),u=i+this.scoreCacheValidityMs;o?(null===(a=this.metrics)||void 0===a||a.scoreCachedDelta.observe(Math.abs(s-o.score)),o.score=s,o.cacheUntil=u):this.scoreCache.set(e,{score:s,cacheUntil:u});return s}},{key:"addPenalty",value:function(e,t,n){var r,i=this.peerStats.get(e);i&&(i.behaviourPenalty+=t,null===(r=this.metrics)||void 0===r||r.onScorePenalty(n))}},{key:"addPeer",value:function(e){var t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}},{key:"addIP",value:function(e,t){var n=this.peerStats.get(e);n&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}},{key:"removeIP",value:function(e,t){var n=this.peerStats.get(e);n&&n.knownIPs.delete(t);var r=this.peerIPs.get(t);r&&(r.delete(e),0===r.size&&this.peerIPs.delete(t))}},{key:"removePeer",value:function(e){var t=this,n=this.peerStats.get(e);if(n){if(this.score(e)>0)return this.removeIPsForPeer(e,n.knownIPs),void this.peerStats.delete(e);Object.entries(n.topics).forEach((function(e){var n=(0,k.Z)(e,2),r=n[0],i=n[1];i.firstMessageDeliveries=0;var o=t.params.topics[r].meshMessageDeliveriesThreshold;if(i.inMesh&&i.meshMessageDeliveriesActive&&i.meshMessageDeliveries<o){var a=o-i.meshMessageDeliveries;i.meshFailurePenalty+=a*a}i.inMesh=!1,i.meshMessageDeliveriesActive=!1})),n.connected=!1,n.expire=Date.now()+this.params.retainScore}}},{key:"graft",value:function(e,t){var n=this.peerStats.get(e);if(n){var r=this.getPtopicStats(n,t);r&&(r.inMesh=!0,r.graftTime=Date.now(),r.meshTime=0,r.meshMessageDeliveriesActive=!1)}}},{key:"prune",value:function(e,t){var n=this.peerStats.get(e);if(n){var r=this.getPtopicStats(n,t);if(r){var i=this.params.topics[t].meshMessageDeliveriesThreshold;if(r.meshMessageDeliveriesActive&&r.meshMessageDeliveries<i){var o=i-r.meshMessageDeliveries;r.meshFailurePenalty+=o*o}r.meshMessageDeliveriesActive=!1,r.inMesh=!1}}}},{key:"validateMessage",value:function(e){this.deliveryRecords.ensureRecord(e)}},{key:"deliverMessage",value:function(e,t,n){var r=this;this.markFirstMessageDelivery(e,n);var i=this.deliveryRecords.ensureRecord(t),o=Date.now();i.status===BC.unknown?(i.status=BC.valid,i.validated=o,i.peers.forEach((function(t){t!==e.toString()&&r.markDuplicateMessageDelivery(t,n)}))):QC("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,o-i.firstSeen,BC[i.status])}},{key:"rejectInvalidMessage",value:function(e,t){this.markInvalidMessageDelivery(e,t)}},{key:"rejectMessage",value:function(e,t,n,r){var i=this;switch(r){case kC.Error:return void this.markInvalidMessageDelivery(e,n);case kC.Blacklisted:return}var o=this.deliveryRecords.ensureRecord(t);if(o.status===BC.unknown){if(r===kC.Ignore)return o.status=BC.ignored,void o.peers.clear();o.status=BC.invalid,this.markInvalidMessageDelivery(e,n),o.peers.forEach((function(e){i.markInvalidMessageDelivery(e,n)})),o.peers.clear()}else QC("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-o.firstSeen,BC[o.status])}},{key:"duplicateMessage",value:function(e,t,n){var r=this.deliveryRecords.ensureRecord(t);if(!r.peers.has(e))switch(r.status){case BC.unknown:r.peers.add(e);break;case BC.valid:r.peers.add(e),this.markDuplicateMessageDelivery(e,n,r.validated);break;case BC.invalid:this.markInvalidMessageDelivery(e,n);case BC.ignored:}}},{key:"markInvalidMessageDelivery",value:function(e,t){var n=this.peerStats.get(e);if(n){var r=this.getPtopicStats(n,t);r&&(r.invalidMessageDeliveries+=1)}}},{key:"markFirstMessageDelivery",value:function(e,t){var n=this.peerStats.get(e);if(n){var r=this.getPtopicStats(n,t);if(r){var i=this.params.topics[t].firstMessageDeliveriesCap;r.firstMessageDeliveries=Math.min(i,r.firstMessageDeliveries+1),r.inMesh&&(i=this.params.topics[t].meshMessageDeliveriesCap,r.meshMessageDeliveries=Math.min(i,r.meshMessageDeliveries+1))}}}},{key:"markDuplicateMessageDelivery",value:function(e,t,n){var r=this.peerStats.get(e);if(r){var i=void 0!==n?Date.now():0,o=this.getPtopicStats(r,t);if(o&&o.inMesh){var a=this.params.topics[t];if(void 0!==n){var s,u=i-n,c=u>a.meshMessageDeliveriesWindow;if(null===(s=this.metrics)||void 0===s||s.onDuplicateMsgDelivery(t,u,c),c)return}var l=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(l,o.meshMessageDeliveries+1)}}}},{key:"removeIPsForPeer",value:function(e,t){var n,r=(0,Ae.Z)(t);try{for(r.s();!(n=r.n()).done;){var i=n.value,o=this.peerIPs.get(i);o&&(o.delete(e),0===o.size&&this.peerIPs.delete(i))}}catch(a){r.e(a)}finally{r.f()}}},{key:"getPtopicStats",value:function(e,t){var n=e.topics[t];return void 0!==n?n:void 0!==this.params.topics[t]?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}]),e}(),$C=function(){function e(t,n,r){(0,K.Z)(this,e),this.gossipsubIWantFollowupMs=t,this.msgIdToStrFn=n,this.metrics=r,this.promises=new Map,this.requestMsByMsg=new Map,this.requestMsByMsgExpire=10*t}return(0,W.Z)(e,[{key:"size",get:function(){return this.promises.size}},{key:"requestMsByMsgSize",get:function(){return this.requestMsByMsg.size}},{key:"addPromise",value:function(e,t){var n=t[Math.floor(Math.random()*t.length)],r=this.msgIdToStrFn(n),i=this.promises.get(r);i||(i=new Map,this.promises.set(r,i));var o=Date.now();i.has(e)||(i.set(e,o+this.gossipsubIWantFollowupMs),this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(r)||this.requestMsByMsg.set(r,o)))}},{key:"getBrokenPromises",value:function(){var e,t=this,n=Date.now(),r=new Map,i=0;return this.promises.forEach((function(e,o){e.forEach((function(t,o){var a;t<n&&(r.set(o,(null!==(a=r.get(o))&&void 0!==a?a:0)+1),e.delete(o),i++)})),e.size||t.promises.delete(o)})),null===(e=this.metrics)||void 0===e||e.iwantPromiseBroken.inc(i),r}},{key:"deliverMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.trackMessage(e);var n=this.promises.get(e);n&&(this.promises.delete(e),this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}},{key:"rejectMessage",value:function(e,t){this.trackMessage(e),t!==kC.Error&&this.promises.delete(e)}},{key:"clear",value:function(){this.promises.clear()}},{key:"prune",value:function(){var e,t,n=Date.now()-this.requestMsByMsgExpire,r=0,i=(0,Ae.Z)(this.requestMsByMsg.entries());try{for(i.s();!(t=i.n()).done;){var o=(0,k.Z)(t.value,2),a=o[0];if(!(o[1]<n))break;this.requestMsByMsg.delete(a),r++}}catch(s){i.e(s)}finally{i.f()}null===(e=this.metrics)||void 0===e||e.iwantMessagePruned.inc(r)}},{key:"trackMessage",value:function(e){if(this.metrics){var t=this.requestMsByMsg.get(e);void 0!==t&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}]),e}(),JC=function(){function e(t){(0,K.Z)(this,e),this.entries=new Map,this.validityMs=t.validityMs}return(0,W.Z)(e,[{key:"size",get:function(){return this.entries.size}},{key:"put",value:function(e,t){return!!this.entries.has(e)||(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}},{key:"prune",value:function(){var e,t=Date.now(),n=(0,Ae.Z)(this.entries.entries());try{for(n.s();!(e=n.n()).done;){var r=(0,k.Z)(e.value,2),i=r[0];if(!(r[1].validUntilMs<t))break;this.entries.delete(i)}}catch(o){n.e(o)}finally{n.f()}}},{key:"has",value:function(e){return this.entries.has(e)}},{key:"get",value:function(e){var t=this.entries.get(e);return t&&t.validUntilMs>=Date.now()?t.value:void 0}},{key:"clear",value:function(){this.entries.clear()}}]),e}();function eI(e,t){null==t&&(t=e.reduce((function(e,t){return e+t.length}),0));var n,r=fC(t),i=0,o=(0,Ae.Z)(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;r.set(a,i),i+=a.length}}catch(s){o.e(s)}finally{o.f()}return lC(r)}function tI(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}!function(e){e.forward="forward",e.publish="publish"}(HC||(HC={})),function(e){e.Fanout="fanout",e.Random="random",e.Subscribed="subscribed",e.Outbound="outbound",e.NotEnough="not_enough",e.Opportunistic="opportunistic"}(VC||(VC={})),function(e){e.Dc="disconnected",e.BadScore="bad_score",e.Prune="prune",e.Unsub="unsubscribed",e.Excess="excess"}(GC||(GC={})),function(e){e.GraftBackoff="graft_backoff",e.BrokenPromise="broken_promise",e.MessageDeficit="message_deficit",e.IPColocation="IP_colocation"}(KC||(KC={})),function(e){e.LowScore="low_score",e.MaxIhave="max_ihave",e.MaxIasked="max_iasked"}(WC||(WC={})),function(e){e.graylist="graylist",e.publish="publish",e.gossip="gossip",e.mesh="mesh"}(qC||(qC={}));var nI=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=vC[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):lC(globalThis.Buffer.from(e,"utf-8"))}("libp2p-pubsub:");function rI(e,t,n,r){return iI.apply(this,arguments)}function iI(){return iI=(0,u.Z)((0,s.Z)().mark((function e(t,n,r,i){var o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.type,e.next=e.t0===wC.Signing?3:e.t0===wC.Anonymous?11:12;break;case 3:return o={from:t.author.toBytes(),data:i,seqno:ja(8),topic:n,signature:void 0,key:void 0},a=eI([nI,iC.Message.encode(o).finish()]),e.next=7,t.privateKey.sign(a);case 7:return o.signature=e.sent,o.key=t.key,u={type:"signed",from:t.author,data:r,sequenceNumber:BigInt("0x".concat(yC(o.seqno,"base16"))),topic:n,signature:o.signature,key:o.key},e.abrupt("return",{raw:o,msg:u});case 11:return e.abrupt("return",{raw:{from:void 0,data:i,seqno:void 0,topic:n,signature:void 0,key:void 0},msg:{type:"unsigned",data:r,topic:n}});case 12:case"end":return e.stop()}}),e)}))),iI.apply(this,arguments)}function oI(e,t){return aI.apply(this,arguments)}function aI(){return aI=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t,e.next=e.t0===SC?3:e.t0===_C?10:41;break;case 3:if(null==n.signature){e.next=5;break}return e.abrupt("return",{valid:!1,error:EC.SignaturePresent});case 5:if(null==n.seqno){e.next=7;break}return e.abrupt("return",{valid:!1,error:EC.SeqnoPresent});case 7:if(null==n.key){e.next=9;break}return e.abrupt("return",{valid:!1,error:EC.FromPresent});case 9:return e.abrupt("return",{valid:!0,message:{type:"unsigned",topic:n.topic,data:null!==(r=n.data)&&void 0!==r?r:new Uint8Array(0)}});case 10:if(null!=n.seqno){e.next=12;break}return e.abrupt("return",{valid:!1,error:EC.InvalidSeqno});case 12:if(8===n.seqno.length){e.next=14;break}return e.abrupt("return",{valid:!1,error:EC.InvalidSeqno});case 14:if(null!=n.signature){e.next=16;break}return e.abrupt("return",{valid:!1,error:EC.InvalidSignature});case 16:if(null!=n.from){e.next=18;break}return e.abrupt("return",{valid:!1,error:EC.InvalidPeerId});case 18:e.prev=18,a=(0,Ps.cv)(n.from),e.next=25;break;case 22:return e.prev=22,e.t1=e.catch(18),e.abrupt("return",{valid:!1,error:EC.InvalidPeerId});case 25:if(!n.key){e.next=31;break}if(u=Zs(n.key),void 0===a.publicKey||tI(u.bytes,a.publicKey)){e.next=29;break}return e.abrupt("return",{valid:!1,error:EC.InvalidPeerId});case 29:e.next=34;break;case 31:if(null!=a.publicKey){e.next=33;break}return e.abrupt("return",{valid:!1,error:EC.InvalidPeerId});case 33:u=Zs(a.publicKey);case 34:return c={from:n.from,data:n.data,seqno:n.seqno,topic:n.topic,signature:void 0,key:void 0},l=eI([nI,iC.Message.encode(c).finish()]),e.next=38,u.verify(l,n.signature);case 38:if(e.sent){e.next=40;break}return e.abrupt("return",{valid:!1,error:EC.InvalidSignature});case 40:return e.abrupt("return",{valid:!0,message:{type:"signed",from:a,data:null!==(i=n.data)&&void 0!==i?i:new Uint8Array(0),sequenceNumber:BigInt("0x".concat(yC(n.seqno,"base16"))),topic:n.topic,signature:n.signature,key:null!==(o=n.key)&&void 0!==o?o:Ts(u)}});case 41:case"end":return e.stop()}}),e,null,[[18,22]])}))),aI.apply(this,arguments)}function sI(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function uI(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var cI=uI("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),lI=uI("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?sI(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),fI=(0,Nt.Z)({utf8:cI,"utf-8":cI,hex:cr.gh.base16,latin1:lI,ascii:lI,binary:lI},cr.gh);var hI=function(e,t){var n=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=fI[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):sI(globalThis.Buffer.from(e,"utf-8"))}(t.toString(16).padStart(16,"0"),"base16"),r=new Uint8Array(e.length+n.length);return r.set(e,0),r.set(n,e.length),r};function pI(e){if("signed"!==e.type)throw new Error("expected signed message type");if(null==e.sequenceNumber)throw Error("missing seqno field");return hI(e.from.toBytes(),e.sequenceNumber)}function dI(e){return vI.apply(this,arguments)}function vI(){return(vI=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h.sha256.encode(t.data);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function yI(e,t,n,r,i){var o=0,a=new Map;if(Object.entries(t.topics).forEach((function(e){var t,r=(0,k.Z)(e,2),s=r[0],u=r[1],c=null!==(t=i.get(s))&&void 0!==t?t:"unknown",l=n.topics[s];if(void 0!==l){var f=a.get(c);f||(f={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},a.set(c,f));var h=0,p=0,d=0,v=0,y=0;if(u.inMesh)h+=Math.max(u.meshTime/l.timeInMeshQuantum,l.timeInMeshCap)*l.timeInMeshWeight;var g=u.firstMessageDeliveries;if(g>l.firstMessageDeliveriesCap&&(g=l.firstMessageDeliveriesCap),p+=g*l.firstMessageDeliveriesWeight,u.meshMessageDeliveriesActive&&u.meshMessageDeliveries<l.meshMessageDeliveriesThreshold){var m=l.meshMessageDeliveriesThreshold-u.meshMessageDeliveries;d+=m*m*l.meshMessageDeliveriesWeight}v+=u.meshFailurePenalty*l.meshFailurePenaltyWeight,y+=u.invalidMessageDeliveries*u.invalidMessageDeliveries*l.invalidMessageDeliveriesWeight,o+=(h+p+d+v+y)*l.topicWeight,f.p1w+=h,f.p2w+=p,f.p3w+=d,f.p3bw+=v,f.p4w+=y}})),n.topicScoreCap>0&&o>n.topicScoreCap){o=n.topicScoreCap;var s,u=n.topicScoreCap/o,c=(0,Ae.Z)(a.values());try{for(c.s();!(s=c.n()).done;){var l=s.value;l.p1w*=u,l.p2w*=u,l.p3w*=u,l.p3bw*=u,l.p4w*=u}}catch(d){c.e(d)}finally{c.f()}}var f=0,h=0,p=0;return f+=n.appSpecificScore(e)*n.appSpecificWeight,t.knownIPs.forEach((function(e){if(!n.IPColocationFactorWhitelist.has(e)){var t=r.get(e),i=t?t.size:0;if(i>n.IPColocationFactorThreshold){var o=i-n.IPColocationFactorThreshold;h+=o*o*n.IPColocationFactorWeight}}})),p+=t.behaviourPenalty*t.behaviourPenalty*n.behaviourPenaltyWeight,{byTopic:a,p5w:f,p6w:h,p7w:p,score:o+=f+h+p}}function gI(e){return null!=e[Symbol.asyncIterator]}var mI=function e(t){var n=Ct.encodingLength(t),r=fC(n);return Ct.encode(t,r),e.bytes=n,r};function bI(e,t){var n,r,i=(0,s.Z)().mark(a),o=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:mI;function a(e){var t;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!((t=o(e.byteLength))instanceof Uint8Array)){n.next=6;break}return n.next=4,t;case 4:n.next=7;break;case 6:return n.delegateYield(t,"t0",7);case 7:if(!(e instanceof Uint8Array)){n.next=12;break}return n.next=10,e;case 10:n.next=13;break;case 12:return n.delegateYield(e,"t1",13);case 13:case"end":return n.stop()}}),i)}return gI(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=12;break}return c=u.value,t.delegateYield((0,at.Z)((0,y.Z)(a(c)),m.Z),"t0",9);case 9:n=!1,t.next=4;break;case 12:t.next=18;break;case 14:t.prev=14,t.t1=t.catch(2),r=!0,i=t.t1;case 18:if(t.prev=18,t.prev=19,!n||null==o.return){t.next=23;break}return t.next=23,(0,m.Z)(o.return());case 23:if(t.prev=23,!r){t.next=26;break}throw i;case 26:return t.finish(23);case 27:return t.finish(18);case 28:case"end":return t.stop()}}),t,null,[[2,14,18,28],[19,,23,27]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=8;break}return i=r.value,t.delegateYield(a(i),"t0",6);case 6:t.next=3;break;case 8:t.next=13;break;case 10:t.prev=10,t.t1=t.catch(1),n.e(t.t1);case 13:return t.prev=13,n.f(),t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[1,10,13,16]])}))()}mI.bytes=0,bI.single=function(e,t){var n,r,i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:mI;return new vt(i(e.byteLength),e)};var wI;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(wI||(wI={}));var kI=function e(t){var n=Ct.decode(t);return e.bytes=Ct.encodingLength(n),n};function EI(e,t){var n,r,i,o=(0,s.Z)().mark(p),a=new vt,u=wI.LENGTH,c=-1,l=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:kI,f=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,h=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function p(){var e,n;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!(a.byteLength>0)){r.next=32;break}if(u!==wI.LENGTH){r.next=21;break}if(r.prev=2,!((c=l(a))<0)){r.next=6;break}throw Mt()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");case 6:if(!(c>h)){r.next=8;break}throw Mt()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");case 8:e=l.bytes,a.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(c),u=wI.DATA,r.next=21;break;case 14:if(r.prev=14,r.t0=r.catch(2),!(r.t0 instanceof RangeError)){r.next=20;break}if(!(a.byteLength>f)){r.next=19;break}throw Mt()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");case 19:return r.abrupt("break",32);case 20:throw r.t0;case 21:if(u!==wI.DATA){r.next=30;break}if(!(a.byteLength<c)){r.next=24;break}return r.abrupt("break",32);case 24:return n=a.sublist(0,c),a.consume(c),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(n),r.next=29,n;case 29:u=wI.LENGTH;case 30:r.next=0;break;case 32:case"end":return r.stop()}}),o,null,[[2,14]])}return gI(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=13;break}return c=u.value,a.append(c),t.delegateYield((0,at.Z)((0,y.Z)(p()),m.Z),"t0",10);case 10:n=!1,t.next=4;break;case 13:t.next=19;break;case 15:t.prev=15,t.t1=t.catch(2),r=!0,i=t.t1;case 19:if(t.prev=19,t.prev=20,!n||null==o.return){t.next=24;break}return t.next=24,(0,m.Z)(o.return());case 24:if(t.prev=24,!r){t.next=27;break}throw i;case 27:return t.finish(24);case 28:return t.finish(19);case 29:if(!(a.byteLength>0)){t.next=31;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 31:case"end":return t.stop()}}),t,null,[[2,15,19,29],[20,,24,28]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=9;break}return i=r.value,a.append(i),t.delegateYield(p(),"t0",7);case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t1=t.catch(1),n.e(t.t1);case 14:return t.prev=14,n.f(),t.finish(14);case 17:if(!(a.byteLength>0)){t.next=19;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 19:case"end":return t.stop()}}),t,null,[[1,11,14,17]])}))()}kI.bytes=0,EI.fromReader=function(e,t){var n=1;return EI((0,g.Z)((0,s.Z)().mark((function t(){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=1,t.next=4,(0,m.Z)(e.next(n));case 4:if(r=t.sent,i=r.done,o=r.value,!0!==i){t.next=9;break}return t.abrupt("return");case 9:if(null==o){t.next=12;break}return t.next=12,o;case 12:t.next=19;break;case 14:if(t.prev=14,t.t0=t.catch(1),"ERR_UNDER_READ"!==t.t0.code){t.next=18;break}return t.abrupt("return",{done:!0,value:null});case 18:throw t.t0;case 19:return t.prev=19,n=1,t.finish(19);case 22:t.next=0;break;case 24:case"end":return t.stop()}}),t,null,[[1,14,19,22]])})))(),(0,Nt.Z)((0,Nt.Z)({},null!==t&&void 0!==t?t:{}),{},{onLength:function(e){n=e}}))};var xI=function(){function e(t,n,r){var i;(0,K.Z)(this,e),this.rawStream=t,this.pushable=qT({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=null!==(i=r.maxBufferSize)&&void 0!==i?i:1/0,XT(du(this.pushable,this.closeController.signal,{returnOnAbort:!0}),(function(e){return bI(e)}),this.rawStream).catch(n)}return(0,W.Z)(e,[{key:"protocol",get:function(){return this.rawStream.stat.protocol}},{key:"push",value:function(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error("OutboundStream buffer full, size > ".concat(this.maxBufferSize));this.pushable.push(e)}},{key:"close",value:function(){this.closeController.abort(),this.pushable.return(),this.rawStream.close()}}]),e}(),_I=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),this.rawStream=t,this.closeController=new AbortController,this.source=du(XT(this.rawStream,(function(e){return EI(e,n)})),this.closeController.signal,{returnOnAbort:!0})}return(0,W.Z)(e,[{key:"close",value:function(){this.closeController.abort(),this.rawStream.close()}}]),e}(),SI=n(80886),AI=n.n(SI),ZI={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function TI(e,t){t=(0,Nt.Z)({},t);for(var n=AI().Reader.create(e),r=e.length,i=void 0===r?n.len:n.pos+r,o={};n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.subscriptions&&o.subscriptions.length||(o.subscriptions=[]),o.subscriptions.length<t.maxSubscriptions?o.subscriptions.push(CI(n,n.uint32())):n.skipType(7&a);break;case 2:o.messages&&o.messages.length||(o.messages=[]),o.messages.length<t.maxMessages?o.messages.push(II(n,n.uint32())):n.skipType(7&a);break;case 3:o.control=DI(n,n.uint32(),t);break;default:n.skipType(7&a)}}return o}function CI(e,t){for(var n=void 0===t?e.len:e.pos+t,r={};e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:r.subscribe=e.bool();break;case 2:r.topic=e.string();break;default:e.skipType(7&i)}}return r}function II(e,t){for(var n=void 0===t?e.len:e.pos+t,r={};e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:r.from=e.bytes();break;case 2:r.data=e.bytes();break;case 3:r.seqno=e.bytes();break;case 4:r.topic=e.string();break;case 5:r.signature=e.bytes();break;case 6:r.key=e.bytes();break;default:e.skipType(7&i)}}if(!r.topic)throw Error("missing required 'topic'");return r}function DI(e,t,n){for(var r=void 0===t?e.len:e.pos+t,i={};e.pos<r;){var o=e.uint32();switch(o>>>3){case 1:i.ihave&&i.ihave.length||(i.ihave=[]),i.ihave.length<n.maxControlMessages?i.ihave.push(OI(e,e.uint32(),n)):e.skipType(7&o);break;case 2:i.iwant&&i.iwant.length||(i.iwant=[]),i.iwant.length<n.maxControlMessages?i.iwant.push(RI(e,e.uint32(),n)):e.skipType(7&o);break;case 3:i.graft&&i.graft.length||(i.graft=[]),i.graft.length<n.maxControlMessages?i.graft.push(PI(e,e.uint32())):e.skipType(7&o);break;case 4:i.prune&&i.prune.length||(i.prune=[]),i.prune.length<n.maxControlMessages?i.prune.push(LI(e,e.uint32(),n)):e.skipType(7&o);break;default:e.skipType(7&o)}}return i}function OI(e,t,n){for(var r=void 0===t?e.len:e.pos+t,i={};e.pos<r;){var o=e.uint32();switch(o>>>3){case 1:i.topicID=e.string();break;case 2:i.messageIDs&&i.messageIDs.length||(i.messageIDs=[]),n.maxIhaveMessageIDs-- >0?i.messageIDs.push(e.bytes()):e.skipType(7&o);break;default:e.skipType(7&o)}}return i}function RI(e,t,n){for(var r=void 0===t?e.len:e.pos+t,i={};e.pos<r;){var o=e.uint32();if(o>>>3===1)i.messageIDs&&i.messageIDs.length||(i.messageIDs=[]),n.maxIwantMessageIDs-- >0?i.messageIDs.push(e.bytes()):e.skipType(7&o);else e.skipType(7&o)}return i}function PI(e,t){for(var n=void 0===t?e.len:e.pos+t,r={};e.pos<n;){var i=e.uint32();if(i>>>3===1)r.topicID=e.string();else e.skipType(7&i)}return r}function LI(e,t,n){for(var r=void 0===t?e.len:e.pos+t,i={};e.pos<r;){var o=e.uint32();switch(o>>>3){case 1:i.topicID=e.string();break;case 2:i.peers&&i.peers.length||(i.peers=[]),n.maxPeerInfos-- >0?i.peers.push(NI(e,e.uint32())):e.skipType(7&o);break;case 3:i.backoff=e.uint64();break;default:e.skipType(7&o)}}return i}function NI(e,t){for(var n=void 0===t?e.len:e.pos+t,r={};e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:r.peerID=e.bytes();break;case 2:r.signedPeerRecord=e.bytes();break;default:e.skipType(7&i)}}return r}var BI=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;n=~~n,r=null!==(t=r)&&void 0!==t?t:e.length-n;var i=new DataView(e.buffer);if(4===r){for(var o=[],a=0;a<r;a++)o.push(e[n+a]);return o.join(".")}if(16===r){for(var s=[],u=0;u<r;u+=2)s.push(i.getUint16(n+u).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},MI=-1,FI={},jI={};function UI(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}function zI(e){if("number"===typeof e){if(null!=jI[e])return jI[e];throw new Error("no protocol with code: ".concat(e))}if("string"===typeof e){if(null!=FI[e])return FI[e];throw new Error("no protocol with name: ".concat(e))}throw new Error("invalid protocol id type: ".concat(typeof e))}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,MI,"ip6zone"],[43,8,"ipcidr"],[53,MI,"dns",!0],[54,MI,"dns4",!0],[55,MI,"dns6",!0],[56,MI,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,MI,"unix",!1,!0],[421,MI,"ipfs"],[421,MI,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,MI,"garlic64"],[448,0,"tls"],[449,MI,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,MI,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,MI,"memory"]].forEach((function(e){var t=UI.apply(void 0,(0,ye.Z)(e));jI[t.code]=t,FI[t.name]=t}));zI("ip4"),zI("ip6"),zI("ipcidr");function HI(e,t){switch(zI(e).code){case 4:case 41:return function(e){var t=BI(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!xl.h6(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return WI(t);case 6:case 273:case 33:case 132:return KI(t).toString();case 421:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return yC(n,"base58btc")}(t);case 444:case 445:return qI(t);case 466:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+yC(n,"base64url")}(t);default:return yC(t,"base16")}}var VI,GI=Object.values(cr.gh).map((function(e){return e.decoder}));!function(){var e=GI[0].or(GI[1]);GI.slice(2).forEach((function(t){return e=e.or(t)}))}();function KI(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function WI(e){var t=A().decode(e);if((e=e.slice(A().decode.bytes)).length!==t)throw new Error("inconsistent lengths");return yC(e)}function qI(e){var t=e.slice(0,e.length-2),n=e.slice(e.length-2),r=yC(t,"base32"),i=KI(n);return"".concat(r,":").concat(i)}!function(e){e[e.ip4=4]="ip4",e[e.ip6=41]="ip6"}(VI||(VI={}));var YI;!function(e){e[e.started=0]="started",e[e.stopped=1]="stopped"}(YI||(YI={}));var QI,XI,$I=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r,i,o,a,s,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,n),(s=t.call(this)).multicodecs=[sC,aC],s.peers=new Set,s.streamsInbound=new Map,s.streamsOutbound=new Map,s.outboundInflightQueue=qT({objectMode:!0}),s.direct=new Set,s.floodsubPeers=new Set,s.acceptFromWhitelist=new Map,s.topics=new Map,s.subscriptions=new Set,s.mesh=new Map,s.fanout=new Map,s.fanoutLastpub=new Map,s.gossip=new Map,s.control=new Map,s.peerhave=new Map,s.iasked=new Map,s.backoff=new Map,s.outbound=new Map,s.topicValidators=new Map,s.heartbeatTicks=0,s.directPeerInitial=null,s.status={code:YI.stopped},s.heartbeatTimer=null,s.runHeartbeat=function(){var e,t=null===(e=s.metrics)||void 0===e?void 0:e.heartbeatDuration.startTimer();s.heartbeat().catch((function(e){s.log("Error running heartbeat",e)})).finally((function(){if(null!=t&&t(),s.status.code===YI.started){clearTimeout(s.status.heartbeatTimeout);var e,n=s.opts.heartbeatInterval-(Date.now()-s.status.hearbeatStartMs)%s.opts.heartbeatInterval;if(n<.25*s.opts.heartbeatInterval)n+=s.opts.heartbeatInterval,null===(e=s.metrics)||void 0===e||e.heartbeatSkipped.inc();s.status.heartbeatTimeout=setTimeout(s.runHeartbeat,n)}}))};var c=(0,Nt.Z)((0,Nt.Z)({fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300},u),{},{scoreParams:OC(u.scoreParams),scoreThresholds:LC(u.scoreThresholds)});if(s.components=e,s.decodeRpcLimits=null!==(r=c.decodeRpcLimits)&&void 0!==r?r:ZI,s.globalSignaturePolicy=null!==(i=c.globalSignaturePolicy)&&void 0!==i?i:_C,c.fallbackToFloodsub&&s.multicodecs.push(oC),s.log=(0,ru.kg)(null!==(o=c.debugName)&&void 0!==o?o:"libp2p:gossipsub"),s.opts=c,s.direct=new Set(c.directPeers.map((function(e){return e.id.toString()}))),s.seenCache=new JC({validityMs:c.seenTTL}),s.publishedMessageIds=new JC({validityMs:c.seenTTL}),u.msgIdFn)s.msgIdFn=u.msgIdFn;else switch(s.globalSignaturePolicy){case _C:s.msgIdFn=pI;break;case SC:s.msgIdFn=dI}if(u.fastMsgIdFn&&(s.fastMsgIdFn=u.fastMsgIdFn,s.fastMsgIdCache=new JC({validityMs:c.seenTTL})),s.msgIdToStrFn=null!==(a=u.msgIdToStrFn)&&void 0!==a?a:gC,s.mcache=u.messageCache||new rC(c.mcacheGossip,c.mcacheLength,s.msgIdToStrFn),u.dataTransform&&(s.dataTransform=u.dataTransform),u.metricsRegister){if(!u.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");var l=Math.max.apply(Math,(0,ye.Z)(Object.values(c.scoreParams.topics).map((function(e){return e.meshMessageDeliveriesWindow}))).concat([1e3])),f=function(e,t,n){return{protocolsEnabled:e.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:e.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:e.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:e.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEvents:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_total",help:"Number of times we include peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),meshPeerChurnEvents:e.gauge({name:"gossipsub_peer_churn_events_total",help:"Number of times we remove peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),peersPerProtocol:e.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:e.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:e.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),asyncValidationResult:e.gauge({name:"gossipsub_async_validation_result_total",help:"Message validation result for each topic",labelNames:["topic","acceptance"]}),asyncValidationMcacheHit:e.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),peerReadStreamError:e.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:e.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:e.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:e.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:e.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:e.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:e.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:e.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:e.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:e.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:e.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:e.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:e.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:e.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:e.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:e.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:e.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:e.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:e.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:e.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:e.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:e.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:e.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeers:e.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),msgPublishPeersByGroup:e.gauge({name:"gossipsub_msg_publish_peers_by_group",help:"Total count of peers (by group) that we publish a msg to",labelNames:["topic","peerGroup"]}),msgPublishBytes:e.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgForwardCount:e.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:e.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:e.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:e.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),msgReceivedStatus:e.gauge({name:"gossipsub_msg_received_status_total",help:"Tracks distribution of recv msgs by duplicate, invalid, valid",labelNames:["topic","status"]}),msgReceivedInvalid:e.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["topic","error"]}),duplicateMsgDeliveryDelay:e.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*n.maxMeshMessageDeliveriesWindowSec,.5*n.maxMeshMessageDeliveriesWindowSec,1*n.maxMeshMessageDeliveriesWindowSec,2*n.maxMeshMessageDeliveriesWindowSec,4*n.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:e.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:e.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:e.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:e.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:e.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:e.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:e.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores",labelNames:["topic","p"]}),scoreWeights:e.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:e.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:e.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:e.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*n.behaviourPenaltyThreshold,.5*n.behaviourPenaltyThreshold,1*n.behaviourPenaltyThreshold,2*n.behaviourPenaltyThreshold,4*n.behaviourPenaltyThreshold]}),ihaveRcvIgnored:e.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:e.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:e.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:e.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:e.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:e.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:e.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:e.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:e.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:e.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:e.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:e.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*n.gossipPromiseExpireSec,1*n.gossipPromiseExpireSec,2*n.gossipPromiseExpireSec,4*n.gossipPromiseExpireSec]}),iwantPromiseUntracked:e.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),cacheSize:e.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:e.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:e.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:e.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:e.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:t,toTopic:function(e){var t;return null!==(t=this.topicStrToLabel.get(e))&&void 0!==t?t:e},onJoin:function(e){this.topicSubscriptionStatus.set({topicStr:e},1),this.meshPeerCounts.set({topicStr:e},0)},onLeave:function(e){this.topicSubscriptionStatus.set({topicStr:e},0),this.meshPeerCounts.set({topicStr:e},0)},onAddToMesh:function(e,t,n){var r=this.toTopic(e);this.meshPeerInclusionEvents.inc({topic:r,reason:t},n)},onRemoveFromMesh:function(e,t,n){var r=this.toTopic(e);this.meshPeerChurnEvents.inc({topic:r,reason:t},n)},onReportValidationMcacheHit:function(e){this.asyncValidationMcacheHit.inc({hit:e?"hit":"miss"})},onReportValidation:function(e,t){var n=this.toTopic(e);this.asyncValidationResult.inc({topic:n,acceptance:t})},onScorePenalty:function(e){this.scoringPenalties.inc({penalty:e},1)},onIhaveRcv:function(e,t,n){var r=this.toTopic(e);this.ihaveRcvMsgids.inc({topic:r},t),this.ihaveRcvNotSeenMsgids.inc({topic:r},n)},onIwantRcv:function(e,t){var n,r=(0,Ae.Z)(e);try{for(r.s();!(n=r.n()).done;){var i=(0,k.Z)(n.value,2),o=i[0],a=i[1],s=this.toTopic(o);this.iwantRcvMsgids.inc({topic:s},a)}}catch(u){r.e(u)}finally{r.f()}this.iwantRcvDonthaveMsgids.inc(t)},onForwardMsg:function(e,t){var n=this.toTopic(e);this.msgForwardCount.inc({topic:n},1),this.msgForwardPeers.inc({topic:n},t)},onPublishMsg:function(e,t,n,r){var i=this.toTopic(e);this.msgPublishCount.inc({topic:i},1),this.msgPublishBytes.inc({topic:i},n*r),this.msgPublishPeers.inc({topic:i},n),this.msgPublishPeersByGroup.inc({topic:i,peerGroup:"direct"},t.direct),this.msgPublishPeersByGroup.inc({topic:i,peerGroup:"floodsub"},t.floodsub),this.msgPublishPeersByGroup.inc({topic:i,peerGroup:"mesh"},t.mesh),this.msgPublishPeersByGroup.inc({topic:i,peerGroup:"fanout"},t.fanout)},onMsgRecvPreValidation:function(e){var t=this.toTopic(e);this.msgReceivedPreValidation.inc({topic:t},1)},onMsgRecvError:function(e){var t=this.toTopic(e);this.msgReceivedError.inc({topic:t},1)},onMsgRecvResult:function(e,t){var n=this.toTopic(e);this.msgReceivedStatus.inc({topic:n,status:t})},onMsgRecvInvalid:function(e,t){var n=this.toTopic(e),r=t.reason===kC.Error?t.error:t.reason;this.msgReceivedInvalid.inc({topic:n,error:r},1)},onDuplicateMsgDelivery:function(e,t,n){if(this.duplicateMsgDeliveryDelay.observe(t/1e3),n){var r=this.toTopic(e);this.duplicateMsgLateDelivery.inc({topic:r},1)}},onPublishDuplicateMsg:function(e){var t=this.toTopic(e);this.duplicateMsgIgnored.inc({topic:t},1)},onPeerReadStreamError:function(){this.peerReadStreamError.inc(1)},onRpcRecvError:function(){this.rpcRecvError.inc(1)},onRpcDataError:function(){this.rpcDataError.inc(1)},onRpcRecv:function(e,t){this.rpcRecvBytes.inc(t),this.rpcRecvCount.inc(1),e.subscriptions&&this.rpcRecvSubscription.inc(e.subscriptions.length),e.messages&&this.rpcRecvMessage.inc(e.messages.length),e.control&&(this.rpcRecvControl.inc(1),e.control.ihave&&this.rpcRecvIHave.inc(e.control.ihave.length),e.control.iwant&&this.rpcRecvIWant.inc(e.control.iwant.length),e.control.graft&&this.rpcRecvGraft.inc(e.control.graft.length),e.control.prune&&this.rpcRecvPrune.inc(e.control.prune.length))},onRpcSent:function(e,t){if(this.rpcSentBytes.inc(t),this.rpcSentCount.inc(1),e.subscriptions&&this.rpcSentSubscription.inc(e.subscriptions.length),e.messages&&this.rpcSentMessage.inc(e.messages.length),e.control){var n,r,i,o,a,s,u,c,l=null!==(n=null===(r=e.control.ihave)||void 0===r?void 0:r.length)&&void 0!==n?n:0,f=null!==(i=null===(o=e.control.iwant)||void 0===o?void 0:o.length)&&void 0!==i?i:0,h=null!==(a=null===(s=e.control.graft)||void 0===s?void 0:s.length)&&void 0!==a?a:0,p=null!==(u=null===(c=e.control.prune)||void 0===c?void 0:c.length)&&void 0!==u?u:0;l>0&&this.rpcSentIHave.inc(l),f>0&&this.rpcSentIWant.inc(f),h>0&&this.rpcSentGraft.inc(h),p>0&&this.rpcSentPrune.inc(p),(l>0||f>0||h>0||p>0)&&this.rpcSentControl.inc(1)}},registerScores:function(e,t){var n,r=0,i=0,o=0,a=0,s=(0,Ae.Z)(e);try{for(s.s();!(n=s.n()).done;){var u=n.value;u>=t.graylistThreshold&&r++,u>=t.publishThreshold&&i++,u>=t.gossipThreshold&&o++,u>=0&&a++}}catch(c){s.e(c)}finally{s.f()}this.peersByScoreThreshold.set({threshold:qC.graylist},r),this.peersByScoreThreshold.set({threshold:qC.publish},i),this.peersByScoreThreshold.set({threshold:qC.gossip},o),this.peersByScoreThreshold.set({threshold:qC.mesh},a),this.score.set(e)},registerScoreWeights:function(e){var t,n=(0,Ae.Z)(e.byTopic);try{for(n.s();!(t=n.n()).done;){var r=(0,k.Z)(t.value,2),i=r[0],o=r[1];this.scoreWeights.set({topic:i,p:"p1"},o.p1w),this.scoreWeights.set({topic:i,p:"p2"},o.p2w),this.scoreWeights.set({topic:i,p:"p3"},o.p3w),this.scoreWeights.set({topic:i,p:"p3b"},o.p3bw),this.scoreWeights.set({topic:i,p:"p4"},o.p4w)}}catch(a){n.e(a)}finally{n.f()}this.scoreWeights.set({p:"p5"},e.p5w),this.scoreWeights.set({p:"p6"},e.p6w),this.scoreWeights.set({p:"p7"},e.p7w)},registerScorePerMesh:function(e,t){var n=this,r=new Map;e.forEach((function(e,t){var i,o=null!==(i=n.topicStrToLabel.get(t))&&void 0!==i?i:"unknown",a=r.get(o);a||(a=new Set,r.set(o,a)),e.forEach((function(e){var t;return null===(t=a)||void 0===t?void 0:t.add(e)}))}));var i,o=(0,Ae.Z)(r);try{var a=function(){var e=(0,k.Z)(i.value,2),r=e[0],o=e[1],a=[];o.forEach((function(e){var n;a.push(null!==(n=t.get(e))&&void 0!==n?n:0)})),n.scorePerMesh.set({topic:r},a)};for(o.s();!(i=o.n()).done;)a()}catch(s){o.e(s)}finally{o.f()}}}}(u.metricsRegister,u.metricsTopicStrToLabel,{gossipPromiseExpireSec:s.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:c.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:l/1e3});f.mcacheSize.addCollect((function(){return s.onScrapeMetrics(f)}));var h,p=(0,Ae.Z)(s.multicodecs);try{for(p.s();!(h=p.n()).done;){var d=h.value;f.protocolsEnabled.set({protocol:d},1)}}catch(v){p.e(v)}finally{p.f()}s.metrics=f}else s.metrics=null;return s.gossipTracer=new $C(s.opts.gossipsubIWantFollowupMs,s.msgIdToStrFn,s.metrics),s.score=new XC(s.opts.scoreParams,s.metrics,{scoreCacheValidityMs:c.heartbeatInterval}),s.maxInboundStreams=u.maxInboundStreams,s.maxOutboundStreams=u.maxOutboundStreams,s.allowedTopics=c.allowedTopics?new Set(c.allowedTopics):null,s}return(0,W.Z)(n,[{key:"getPeers",value:function(){return(0,ye.Z)(this.peers.keys()).map((function(e){return(0,Ps.jE)(e)}))}},{key:"isStarted",value:function(){return this.status.code===YI.started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isStarted()){e.next=2;break}return e.abrupt("return");case 2:return this.log("starting"),e.next=5,ZC(this.globalSignaturePolicy,this.components.peerId);case 5:return this.publishConfig=e.sent,this.outboundInflightQueue=qT({objectMode:!0}),XT(this.outboundInflightQueue,function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!1,r=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(n=!(u=e.sent).done)){e.next=13;break}return c=u.value,l=c.peerId,f=c.connection,e.next=10,o.createOutboundStream(l,f);case 10:n=!1,e.next=4;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(2),r=!0,i=e.t0;case 19:if(e.prev=19,e.prev=20,!n||null==a.return){e.next=24;break}return e.next=24,a.return();case 24:if(e.prev=24,!r){e.next=27;break}throw i;case 27:return e.finish(24);case 28:return e.finish(19);case 29:case"end":return e.stop()}}),e,null,[[2,15,19,29],[20,,24,28]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){return o.log.error("outbound inflight queue error",e)})),e.next=10,Promise.all(this.opts.directPeers.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.components.peerStore.merge(t.id,{multiaddrs:t.addrs});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 10:return t=this.components.registrar,e.next=13,Promise.all(this.multicodecs.map((function(e){return t.handle(e,o.onIncomingStream.bind(o),{maxInboundStreams:o.maxInboundStreams,maxOutboundStreams:o.maxOutboundStreams})})));case 13:return n=Bb({onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)}),e.next=16,Promise.all(this.multicodecs.map((function(e){return t.register(e,n)})));case 16:r=e.sent,i=setTimeout(this.runHeartbeat,100),this.status={code:YI.started,registrarTopologyIds:r,heartbeatTimeout:i,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout((function(){Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(Array.from(o.direct).map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.connect(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e)})))).catch((function(e){o.log(e)}))}),1e3),this.log("started");case 22:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("stopping"),this.status.code===YI.started){e.next=3;break}return e.abrupt("return");case 3:t=this.status.registrarTopologyIds,this.status={code:YI.stopped},n=this.components.registrar,t.forEach((function(e){return n.unregister(e)})),this.outboundInflightQueue.end(),r=(0,Ae.Z)(this.streamsOutbound.values());try{for(r.s();!(i=r.n()).done;)i.value.close()}catch(s){r.e(s)}finally{r.f()}this.streamsOutbound.clear(),o=(0,Ae.Z)(this.streamsInbound.values());try{for(o.s();!(a=o.n()).done;)a.value.close()}catch(s){o.e(s)}finally{o.f()}this.streamsInbound.clear(),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache&&this.fastMsgIdCache.clear(),this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped");case 32:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"dumpPeerScoreStats",value:function(){return this.score.dumpPeerScoreStats()}},{key:"onIncomingStream",value:function(e){var t=e.stream,n=e.connection;if(this.isStarted()){var r=n.remotePeer;this.addPeer(r,n.stat.direction,n.remoteAddr),this.createInboundStream(r,t),this.outboundInflightQueue.push({peerId:r,connection:n})}}},{key:"onPeerConnected",value:function(e,t){var n;null===(n=this.metrics)||void 0===n||n.newConnectionCount.inc({status:t.stat.status}),this.isStarted()&&"OPEN"===t.stat.status&&(this.addPeer(e,t.stat.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}},{key:"onPeerDisconnected",value:function(e){this.log("connection ended %p",e),this.removePeer(e)}},{key:"createOutboundStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isStarted()){e.next=2;break}return e.abrupt("return");case 2:if(r=t.toString(),this.peers.has(r)){e.next=5;break}return e.abrupt("return");case 5:if(!this.streamsOutbound.has(r)){e.next=7;break}return e.abrupt("return");case 7:return e.prev=7,e.t0=xI,e.next=11,n.newStream(this.multicodecs);case 11:e.t1=e.sent,e.t2=function(e){return u.log.error("outbound pipe error",e)},e.t3={maxBufferSize:this.opts.maxOutboundBufferSize},o=new e.t0(e.t1,e.t2,e.t3),this.log("create outbound stream %p",t),this.streamsOutbound.set(r,o),(a=o.protocol)===oC&&this.floodsubPeers.add(r),null===(i=this.metrics)||void 0===i||i.peersPerProtocol.inc({protocol:a},1),this.subscriptions.size>0&&(this.log("send subscriptions to",r),this.sendSubscriptions(r,Array.from(this.subscriptions),!0)),e.next=26;break;case 23:e.prev=23,e.t4=e.catch(7),this.log.error("createOutboundStream error",e.t4);case 26:case"end":return e.stop()}}),e,this,[[7,23]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"createInboundStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isStarted()){e.next=2;break}return e.abrupt("return");case 2:if(r=t.toString(),this.peers.has(r)){e.next=5;break}return e.abrupt("return");case 5:void 0!==(i=this.streamsInbound.get(r))&&(this.log("replacing existing inbound steam %s",r),i.close()),this.log("create inbound stream %s",r),o=new _I(n,{maxDataLength:this.opts.maxInboundDataLength}),this.streamsInbound.set(r,o),this.pipePeerReadStream(t,o.source).catch((function(e){return a.log(e)}));case 11:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"addPeer",value:function(e,t,n){var r=e.toString();if(!this.peers.has(r)){this.log("new peer %p",e),this.peers.add(r),this.score.addPeer(r);var i=function(e){var t,n=(0,Ae.Z)(e.tuples());try{for(n.s();!(t=n.n()).done;){var r=t.value;switch(r[0]){case VI.ip4:case VI.ip6:return HI(r[0],r[1])}}}catch(i){n.e(i)}finally{n.f()}return null}(n);null!==i?this.score.addIP(r,i):this.log("Added peer has no IP in current address %s %s",r,n.toString()),this.outbound.has(r)||this.outbound.set(r,"outbound"===t)}}},{key:"removePeer",value:function(e){var t=e.toString();if(this.peers.has(t)){this.log("delete peer %p",e),this.peers.delete(t);var n,r=this.streamsOutbound.get(t),i=this.streamsInbound.get(t);if(r)null===(n=this.metrics)||void 0===n||n.peersPerProtocol.inc({protocol:r.protocol},-1);null===r||void 0===r||r.close(),null===i||void 0===i||i.close(),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);var o,a=(0,Ae.Z)(this.topics.values());try{for(a.s();!(o=a.n()).done;){o.value.delete(t)}}catch(d){a.e(d)}finally{a.f()}var s,u=(0,Ae.Z)(this.mesh);try{for(u.s();!(s=u.n()).done;){var c,l=(0,k.Z)(s.value,2),f=l[0];if(!0===l[1].delete(t))null===(c=this.metrics)||void 0===c||c.onRemoveFromMesh(f,GC.Dc,1)}}catch(d){u.e(d)}finally{u.f()}var h,p=(0,Ae.Z)(this.fanout.values());try{for(p.s();!(h=p.n()).done;){h.value.delete(t)}}catch(d){p.e(d)}finally{p.f()}this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}}},{key:"started",get:function(){return this.status.code===YI.started}},{key:"getMeshPeers",value:function(e){var t=this.mesh.get(e);return t?Array.from(t):[]}},{key:"getSubscribers",value:function(e){var t=this.topics.get(e);return(t?Array.from(t):[]).map((function(e){return(0,Ps.jE)(e)}))}},{key:"getTopics",value:function(){return Array.from(this.subscriptions)}},{key:"pipePeerReadStream",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,XT(n,function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){var r,o,a,u,c,l,f,h,p,d,v;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,o=!1,e.prev=2,u=(0,y.Z)(n);case 4:return e.next=6,u.next();case 6:if(!(r=!(c=e.sent).done)){e.next=34;break}if(l=c.value,e.prev=8,h=l.subarray(),p=TI(h,i.decodeRpcLimits),null===(f=i.metrics)||void 0===f||f.onRpcRecv(p,h.length),!i.opts.awaitRpcHandler){e.next=24;break}return e.prev=13,e.next=16,i.handleReceivedRpc(t,p);case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(13),null===(d=i.metrics)||void 0===d||d.onRpcRecvError(),i.log(e.t0);case 22:e.next=25;break;case 24:i.handleReceivedRpc(t,p).catch((function(e){var t;null===(t=i.metrics)||void 0===t||t.onRpcRecvError(),i.log(e)}));case 25:e.next=31;break;case 27:e.prev=27,e.t1=e.catch(8),null===(v=i.metrics)||void 0===v||v.onRpcDataError(),i.log(e.t1);case 31:r=!1,e.next=4;break;case 34:e.next=40;break;case 36:e.prev=36,e.t2=e.catch(2),o=!0,a=e.t2;case 40:if(e.prev=40,e.prev=41,!r||null==u.return){e.next=45;break}return e.next=45,u.return();case 45:if(e.prev=45,!o){e.next=48;break}throw a;case 48:return e.finish(45);case 49:return e.finish(40);case 50:case"end":return e.stop()}}),e,null,[[2,36,40,50],[8,27],[13,18],[41,,45,49]])})));return function(t){return e.apply(this,arguments)}}());case 3:e.next=9;break;case 5:e.prev=5,e.t0=e.catch(0),null===(r=this.metrics)||void 0===r||r.onPeerReadStreamError(),this.handlePeerReadStreamError(e.t0,t);case 9:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"handlePeerReadStreamError",value:function(e,t){this.log.error(e),this.onPeerDisconnected(t)}},{key:"handleReceivedRpc",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.acceptFrom(t.toString())){e.next=4;break}return this.log("received message from unacceptable peer %p",t),null===(r=this.metrics)||void 0===r||r.rpcRecvNotAccepted.inc(),e.abrupt("return");case 4:if(i=n.subscriptions?n.subscriptions.length:0,o=n.messages?n.messages.length:0,a=0,u=0,c=0,l=0,n.control&&(n.control.ihave&&(a=n.control.ihave.length),n.control.iwant&&(u=n.control.iwant.length),n.control.graft&&(c=n.control.graft.length),n.control.prune&&(l=n.control.prune.length)),this.log("rpc.from ".concat(t.toString()," subscriptions ").concat(i," messages ").concat(o," ihave ").concat(a," iwant ").concat(u," graft ").concat(c," prune ").concat(l)),n.subscriptions&&n.subscriptions.length>0&&(f=[],n.subscriptions.forEach((function(e){var n=e.topic,r=!0===e.subscribe;if(null!=n){if(v.allowedTopics&&!v.allowedTopics.has(n))return;v.handleReceivedSubscription(t,n,r),f.push({topic:n,subscribe:r})}})),this.dispatchEvent(new Dh("subscription-change",{detail:{peerId:t,subscriptions:f}}))),!n.messages){e.next=33;break}h=(0,Ae.Z)(n.messages),e.prev=15,d=(0,s.Z)().mark((function e(){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=p.value,!v.allowedTopics||v.allowedTopics.has(n.topic)){e.next=3;break}return e.abrupt("return","continue");case 3:if(r=v.handleReceivedMessage(t,n).catch((function(e){var t;null===(t=v.metrics)||void 0===t||t.onMsgRecvError(n.topic),v.log(e)})),!v.opts.awaitRpcMessageHandler){e.next=7;break}return e.next=7,r;case 7:case"end":return e.stop()}}),e)})),h.s();case 18:if((p=h.n()).done){e.next=25;break}return e.delegateYield(d(),"t0",20);case 20:if("continue"!==e.t0){e.next=23;break}return e.abrupt("continue",23);case 23:e.next=18;break;case 25:e.next=30;break;case 27:e.prev=27,e.t1=e.catch(15),h.e(e.t1);case 30:return e.prev=30,h.f(),e.finish(30);case 33:if(!n.control){e.next=36;break}return e.next=36,this.handleControlMessage(t.toString(),n.control);case 36:case"end":return e.stop()}}),e,this,[[15,27,30,33]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"handleReceivedSubscription",value:function(e,t,n){this.log("subscription update from %p topic %s",e,t);var r=this.topics.get(t);null==r&&(r=new Set,this.topics.set(t,r)),n?r.add(e.toString()):r.delete(e.toString())}},{key:"handleReceivedMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r){var i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null===(i=this.metrics)||void 0===i||i.onMsgRecvPreValidation(r.topic),e.next=3,this.validateReceivedMessage(t,r);case 3:u=e.sent,null===(o=this.metrics)||void 0===o||o.onMsgRecvResult(r.topic,u.code),e.t0=u.code,e.next=e.t0===xC.duplicate?8:e.t0===xC.invalid?12:e.t0===xC.valid?15:20;break;case 8:return this.score.duplicateMessage(t.toString(),u.msgIdStr,r.topic),this.gossipTracer.deliverMessage(u.msgIdStr,!0),this.mcache.observeDuplicate(u.msgIdStr,t.toString()),e.abrupt("return");case 12:return u.msgIdStr?(c=u.msgIdStr,this.score.rejectMessage(t.toString(),c,r.topic,u.reason),this.gossipTracer.rejectMessage(c,u.reason)):this.score.rejectInvalidMessage(t.toString(),r.topic),null===(a=this.metrics)||void 0===a||a.onMsgRecvInvalid(r.topic,u),e.abrupt("return");case 15:this.score.validateMessage(u.messageId.msgIdStr),this.gossipTracer.deliverMessage(u.messageId.msgIdStr),this.mcache.put(u.messageId,r,!this.opts.asyncValidation),this.subscriptions.has(r.topic)&&(this.components.peerId.equals(t)&&!this.opts.emitSelf||((0,Ah.Z)((0,Zh.Z)(n.prototype),"dispatchEvent",this).call(this,new Dh("gossipsub:message",{detail:{propagationSource:t,msgId:u.messageId.msgIdStr,msg:u.msg}})),(0,Ah.Z)((0,Zh.Z)(n.prototype),"dispatchEvent",this).call(this,new Dh("message",{detail:u.msg})))),this.opts.asyncValidation||this.forwardMessage(u.messageId.msgIdStr,r,t.toString());case 20:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"validateReceivedMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v,y;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=null===(r=this.fastMsgIdFn)||void 0===r?void 0:r.call(this,n),!(a=void 0!==o?null===(i=this.fastMsgIdCache)||void 0===i?void 0:i.get(o):void 0)){e.next=4;break}return e.abrupt("return",{code:xC.duplicate,msgIdStr:a});case 4:return e.next=6,oI(this.globalSignaturePolicy,n);case 6:if((u=e.sent).valid){e.next=9;break}return e.abrupt("return",{code:xC.invalid,reason:kC.Error,error:u.error});case 9:c=u.message,e.prev=10,this.dataTransform&&(c.data=this.dataTransform.inboundTransform(n.topic,c.data)),e.next=18;break;case 14:return e.prev=14,e.t0=e.catch(10),this.log("Invalid message, transform failed",e.t0),e.abrupt("return",{code:xC.invalid,reason:kC.Error,error:EC.TransformFailed});case 18:return e.next=20,this.msgIdFn(c);case 20:if(l=e.sent,f=this.msgIdToStrFn(l),h={msgId:l,msgIdStr:f},void 0!==o&&this.fastMsgIdCache&&this.fastMsgIdCache.put(o,f)&&(null===(p=this.metrics)||void 0===p||p.fastMsgIdCacheCollision.inc()),!this.seenCache.has(f)){e.next=28;break}return e.abrupt("return",{code:xC.duplicate,msgIdStr:f});case 28:this.seenCache.put(f);case 29:if(null==(d=this.topicValidators.get(n.topic))){e.next=44;break}return e.prev=31,e.next=34,d(t,c);case 34:v=e.sent,e.next=42;break;case 37:e.prev=37,e.t1=e.catch(31),"ERR_TOPIC_VALIDATOR_IGNORE"===(y=e.t1.code)&&(v=mC.Ignore),v="ERR_TOPIC_VALIDATOR_REJECT"===y?mC.Reject:mC.Ignore;case 42:if(v===mC.Accept){e.next=44;break}return e.abrupt("return",{code:xC.invalid,reason:AC(v),msgIdStr:f});case 44:return e.abrupt("return",{code:xC.valid,messageId:h,msg:c});case 45:case"end":return e.stop()}}),e,this,[[10,14],[31,37]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getScore",value:function(e){return this.score.score(e)}},{key:"sendSubscriptions",value:function(e,t,n){this.sendRpc(e,{subscriptions:t.map((function(e){return{topic:e,subscribe:n}}))})}},{key:"handleControlMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==n){e.next=2;break}return e.abrupt("return");case 2:if(i=n.ihave?this.handleIHave(t,n.ihave):[],o=n.iwant?this.handleIWant(t,n.iwant):[],!n.graft){e.next=10;break}return e.next=7,this.handleGraft(t,n.graft);case 7:e.t0=e.sent,e.next=11;break;case 10:e.t0=[];case 11:if(a=e.t0,e.t1=n.prune,!e.t1){e.next=16;break}return e.next=16,this.handlePrune(t,n.prune);case 16:if(i.length||o.length||a.length){e.next=18;break}return e.abrupt("return");case 18:u=this.sendRpc(t,{messages:o,control:{iwant:i,prune:a}}),(c=null===(r=i[0])||void 0===r?void 0:r.messageIDs)&&(u?this.gossipTracer.addPromise(t,c):null===(l=this.metrics)||void 0===l||l.iwantPromiseUntracked.inc(1));case 21:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"acceptFrom",value:function(e){if(this.direct.has(e))return!0;var t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n&&n.messagesAccepted<128&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;var r=this.score.score(e);return r>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),r>=this.opts.scoreThresholds.graylistThreshold}},{key:"handleIHave",value:function(e,t){var n,r,i=this;if(!t.length)return[];var o,a=this.score.score(e);if(a<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,a),null===(o=this.metrics)||void 0===o||o.ihaveRcvIgnored.inc({reason:WC.LowScore}),[];var s,u=(null!==(n=this.peerhave.get(e))&&void 0!==n?n:0)+1;if(this.peerhave.set(e,u),u>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,u),null===(s=this.metrics)||void 0===s||s.ihaveRcvIgnored.inc({reason:WC.MaxIhave}),[];var c,l=null!==(r=this.iasked.get(e))&&void 0!==r?r:0;if(l>=uC)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,l),null===(c=this.metrics)||void 0===c||c.ihaveRcvIgnored.inc({reason:WC.MaxIasked}),[];var f=new Map;if(t.forEach((function(e){var t,n=e.topicID,r=e.messageIDs;if(n&&r&&i.mesh.has(n)){var o=0;r.forEach((function(e){var t=i.msgIdToStrFn(e);i.seenCache.has(t)||(f.set(t,e),o++)})),null===(t=i.metrics)||void 0===t||t.onIhaveRcv(n,r.length,o)}})),!f.size)return[];var h=f.size;h+l>uC&&(h=uC-l),this.log("IHAVE: Asking for %d out of %d messages from %s",h,f.size,e);var p=Array.from(f.values());return cC(p),p=p.slice(0,h),this.iasked.set(e,l+h),[{messageIDs:p}]}},{key:"handleIWant",value:function(e,t){var n,r=this;if(!t.length)return[];var i=this.score.score(e);if(i<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,i),[];var o=new Map,a=new Map,s=0;return t.forEach((function(t){var n=t.messageIDs;n&&n.forEach((function(t){var n,i=r.msgIdToStrFn(t),u=r.mcache.getWithIWantCount(i,e);null!=u?(a.set(u.msg.topic,1+(null!==(n=a.get(u.msg.topic))&&void 0!==n?n:0)),u.count>3?r.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,t):o.set(i,u.msg)):s++}))})),null===(n=this.metrics)||void 0===n||n.onIwantRcv(a,s),o.size?(this.log("IWANT: Sending %d messages to %s",o.size,e),Array.from(o.values())):(this.log("IWANT: Could not provide any wanted messages to %s",e),[])}},{key:"handleGraft",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=[],i=this.score.score(t),o=Date.now(),a=this.opts.doPX,n.forEach((function(e){var n,s,c=e.topicID;if(c){var l=u.mesh.get(c);if(l){if(!l.has(t)){if(u.direct.has(t))return u.log("GRAFT: ignoring request from direct peer %s",t),r.push(c),void(a=!1);var f=null===(n=u.backoff.get(c))||void 0===n?void 0:n.get(t);if("number"===typeof f&&o<f){u.log("GRAFT: ignoring backed off peer %s",t),u.score.addPenalty(t,1,KC.GraftBackoff),a=!1;var h=f+u.opts.graftFloodThreshold-u.opts.pruneBackoff;return o<h&&u.score.addPenalty(t,1,KC.GraftBackoff),u.addBackoff(t,c),void r.push(c)}if(i<0)return u.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",t,i,c),r.push(c),a=!1,void u.addBackoff(t,c);if(l.size>=u.opts.Dhi&&!u.outbound.get(t))return r.push(c),void u.addBackoff(t,c);u.log("GRAFT: Add mesh link from %s in %s",t,c),u.score.graft(t,c),l.add(t),null===(s=u.metrics)||void 0===s||s.onAddToMesh(c,VC.Subscribed,1)}}else a=!1}})),r.length){e.next=7;break}return e.abrupt("return",[]);case 7:return e.next=9,Promise.all(r.map((function(e){return u.makePrune(t,e,a)})));case 9:return e.abrupt("return",e.sent);case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"handlePrune",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.score.score(t),i=(0,Ae.Z)(n),e.prev=2,i.s();case 4:if((o=i.n()).done){e.next=23;break}if(a=o.value,u=a.topicID,c=a.backoff,l=a.peers,null!=u){e.next=8;break}return e.abrupt("continue",21);case 8:if(f=this.mesh.get(u)){e.next=11;break}return e.abrupt("return");case 11:if(this.log("PRUNE: Remove mesh link to %s in %s",t,u),this.score.prune(t,u),f.has(t)&&(f.delete(t),null===(h=this.metrics)||void 0===h||h.onRemoveFromMesh(u,GC.Unsub,1)),"number"===typeof c&&c>0?this.doAddBackoff(t,u,1e3*c):this.addBackoff(t,u),!l||!l.length){e.next=21;break}if(!(r<this.opts.scoreThresholds.acceptPXThreshold)){e.next=19;break}return this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",t,r,u),e.abrupt("continue",21);case 19:return e.next=21,this.pxConnect(l);case 21:e.next=4;break;case 23:e.next=28;break;case 25:e.prev=25,e.t0=e.catch(2),i.e(e.t0);case 28:return e.prev=28,i.f(),e.finish(28);case 31:case"end":return e.stop()}}),e,this,[[2,25,28,31]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"addBackoff",value:function(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}},{key:"doAddBackoff",value:function(e,t,n){var r,i=this.backoff.get(t);i||(i=new Map,this.backoff.set(t,i));var o=Date.now()+n;(null!==(r=i.get(e))&&void 0!==r?r:0)<o&&i.set(e,o)}},{key:"applyIwantPenalties",value:function(){var e=this;this.gossipTracer.getBrokenPromises().forEach((function(t,n){e.log("peer %s didn't follow up in %d IWANT requests; adding penalty",n,t),e.score.addPenalty(n,t,KC.BrokenPromise)}))}},{key:"clearBackoff",value:function(){var e=this;if(this.heartbeatTicks%15===0){var t=Date.now();this.backoff.forEach((function(n,r){n.forEach((function(e,r){e<t&&n.delete(r)})),0===n.size&&e.backoff.delete(r)}))}}},{key:"directConnect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],this.direct.forEach((function(e){n.streamsOutbound.has(e)||t.push(e)})),e.next=4,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.connect(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"pxConnect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.length>this.opts.prunePeers&&(cC(t),t=t.slice(0,this.opts.prunePeers)),n=[],e.next=4,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.peerID){e.next=2;break}return e.abrupt("return");case 2:if(i=(0,Ps.cv)(t.peerID),o=i.toString(),!r.peers.has(o)){e.next=6;break}return e.abrupt("return");case 6:if(t.signedPeerRecord){e.next=9;break}return n.push(o),e.abrupt("return");case 9:return e.prev=9,e.next=12,r.components.peerStore.consumePeerRecord(t.signedPeerRecord,i);case 12:if(e.sent){e.next=15;break}return r.log("bogus peer record obtained through px: could not add peer record to address book"),e.abrupt("return");case 15:n.push(o),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(9),r.log("bogus peer record obtained through px: invalid signature or not a peer record");case 21:case"end":return e.stop()}}),e,null,[[9,18]])})));return function(t){return e.apply(this,arguments)}}()));case 4:if(n.length){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,Promise.all(n.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.connect(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"connect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Initiating connection with %s",t),n=(0,Ps.jE)(t),e.next=4,this.components.connectionManager.openConnection(n);case 4:r=e.sent,i=(0,Ae.Z)(this.multicodecs);try{for(i.s();!(o=i.n()).done;){a=o.value,u=(0,Ae.Z)(this.components.registrar.getTopologies(a));try{for(u.s();!(c=u.n()).done;)c.value.onConnect(n,r)}catch(s){u.e(s)}finally{u.f()}}}catch(s){i.e(s)}finally{i.f()}case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"subscribe",value:function(e){if(this.status.code!==YI.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);var t,n=(0,Ae.Z)(this.peers.keys());try{for(n.s();!(t=n.n()).done;){var r=t.value;this.sendSubscriptions(r,[e],!0)}}catch(i){n.e(i)}finally{n.f()}}this.join(e)}},{key:"unsubscribe",value:function(e){if(this.status.code!==YI.started)throw new Error("Pubsub is not started");var t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t){var n,r=(0,Ae.Z)(this.peers.keys());try{for(r.s();!(n=r.n()).done;){var i=n.value;this.sendSubscriptions(i,[e],!1)}}catch(o){r.e(o)}finally{r.f()}}this.leave(e)}},{key:"join",value:function(e){var t,n=this;if(this.status.code!==YI.started)throw new Error("Gossipsub has not started");if(!this.mesh.has(e)){this.log("JOIN %s",e),null===(t=this.metrics)||void 0===t||t.onJoin(e);var r,i=new Set,o=this.fanout.get(e);if(o)this.fanout.delete(e),this.fanoutLastpub.delete(e),o.forEach((function(e){!n.direct.has(e)&&n.score.score(e)>=0&&i.add(e)})),null===(r=this.metrics)||void 0===r||r.onAddToMesh(e,VC.Fanout,i.size);if(i.size<this.opts.D){var a,s=i.size;this.getRandomGossipPeers(e,this.opts.D,(function(e){return!i.has(e)&&!n.direct.has(e)&&n.score.score(e)>=0})).forEach((function(e){i.add(e)})),null===(a=this.metrics)||void 0===a||a.onAddToMesh(e,VC.Random,i.size-s)}this.mesh.set(e,i),i.forEach((function(t){n.log("JOIN: Add mesh link to %s in %s",t,e),n.sendGraft(t,e)}))}}},{key:"leave",value:function(e){var t,n=this;if(this.status.code!==YI.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),null===(t=this.metrics)||void 0===t||t.onLeave(e);var r=this.mesh.get(e);r&&(Promise.all(Array.from(r).map(function(){var t=(0,u.Z)((0,s.Z)().mark((function t(r){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n.log("LEAVE: Remove mesh link to %s in %s",r,e),t.next=3,n.sendPrune(r,e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())).catch((function(e){n.log("Error sending prunes to mesh peers",e)})),this.mesh.delete(e))}},{key:"selectPeersToForward",value:function(e,t,n){var r=this,i=new Set,o=this.topics.get(e);o&&(this.direct.forEach((function(e){!o.has(e)||t===e||null!==n&&void 0!==n&&n.has(e)||i.add(e)})),this.floodsubPeers.forEach((function(e){o.has(e)&&t!==e&&(null===n||void 0===n||!n.has(e))&&r.score.score(e)>=r.opts.scoreThresholds.publishThreshold&&i.add(e)})));var a=this.mesh.get(e);return a&&a.size>0&&a.forEach((function(e){t===e||null!==n&&void 0!==n&&n.has(e)||i.add(e)})),i}},{key:"selectPeersToPublish",value:function(e){var t=this,n=new Set,r={direct:0,floodsub:0,mesh:0,fanout:0},i=this.topics.get(e);if(i)if(this.opts.floodPublish)i.forEach((function(e){t.direct.has(e)?(n.add(e),r.direct++):t.score.score(e)>=t.opts.scoreThresholds.publishThreshold&&(n.add(e),r.floodsub++)}));else{this.direct.forEach((function(e){i.has(e)&&(n.add(e),r.direct++)})),this.floodsubPeers.forEach((function(e){i.has(e)&&t.score.score(e)>=t.opts.scoreThresholds.publishThreshold&&(n.add(e),r.floodsub++)}));var o=this.mesh.get(e);if(o&&o.size>0)o.forEach((function(e){n.add(e),r.mesh++}));else{var a=this.fanout.get(e);if(a&&a.size>0)a.forEach((function(e){n.add(e),r.fanout++}));else{var s=this.getRandomGossipPeers(e,this.opts.D,(function(e){return t.score.score(e)>=t.opts.scoreThresholds.publishThreshold}));s.size>0&&(this.fanout.set(e,s),s.forEach((function(e){n.add(e),r.fanout++})))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:n,tosendCount:r}}},{key:"forwardMessage",value:function(e,t,n,r){var i,o=this;n&&this.score.deliverMessage(n,e,t.topic);var a=this.selectPeersToForward(t.topic,n,r);a.forEach((function(e){o.sendRpc(e,{messages:[t]})})),null===(i=this.metrics)||void 0===i||i.onForwardMsg(t.topic,a.size)}},{key:"publish",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,r,i){var o,a,u,c,l,f,h,p,d,v,y,g,m,b,w,k,E,x,_;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c=this.dataTransform?this.dataTransform.outboundTransform(t,r):r,null!=this.publishConfig){e.next=3;break}throw Error("PublishError.Uninitialized");case 3:return e.next=5,rI(this.publishConfig,t,r,c);case 5:return l=e.sent,f=l.raw,h=l.msg,e.next=10,this.msgIdFn(h);case 10:if(p=e.sent,d=this.msgIdToStrFn(p),v=null!==(o=null===i||void 0===i?void 0:i.ignoreDuplicatePublishError)&&void 0!==o?o:this.opts.ignoreDuplicatePublishError,!this.seenCache.has(d)){e.next=18;break}if(!v){e.next=17;break}return null===(y=this.metrics)||void 0===y||y.onPublishDuplicateMsg(t),e.abrupt("return",{recipients:[]});case 17:throw Error("PublishError.Duplicate");case 18:if(g=this.selectPeersToPublish(t),m=g.tosend,b=g.tosendCount,w=!0===this.opts.emitSelf&&this.subscriptions.has(t),k=null!==(a=null===i||void 0===i?void 0:i.allowPublishToZeroPeers)&&void 0!==a?a:this.opts.allowPublishToZeroPeers,0!==m.size||k||w){e.next=23;break}throw Error("PublishError.InsufficientPeers");case 23:this.seenCache.put(d),this.mcache.put({msgId:p,msgIdStr:d},f,!0),this.publishedMessageIds.put(d),E=(0,Ae.Z)(m);try{for(E.s();!(x=E.n()).done;)_=x.value,this.sendRpc(_,{messages:[f]})||m.delete(_)}catch(s){E.e(s)}finally{E.f()}return null===(u=this.metrics)||void 0===u||u.onPublishMsg(t,b,m.size,null!=f.data?f.data.length:0),w&&(m.add(this.components.peerId.toString()),(0,Ah.Z)((0,Zh.Z)(n.prototype),"dispatchEvent",this).call(this,new Dh("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:d,msg:h}})),(0,Ah.Z)((0,Zh.Z)(n.prototype),"dispatchEvent",this).call(this,new Dh("message",{detail:h}))),e.abrupt("return",{recipients:Array.from(m.values()).map((function(e){return(0,Ps.jE)(e)}))});case 31:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"reportMessageValidationResult",value:function(e,t,n){if(n===mC.Accept){var r,i=this.mcache.validate(e);if(null===(r=this.metrics)||void 0===r||r.onReportValidationMcacheHit(null!==i),null!=i){var o,a=i.message,s=i.originatingPeers;this.score.deliverMessage(t.toString(),e,a.topic),this.forwardMessage(e,i.message,t.toString(),s),null===(o=this.metrics)||void 0===o||o.onReportValidation(a.topic,n)}}else{var u,c=this.mcache.remove(e);if(null===(u=this.metrics)||void 0===u||u.onReportValidationMcacheHit(null!==c),c){var l,f=AC(n),h=c.message,p=c.originatingPeers;this.score.rejectMessage(t.toString(),e,h.topic,f);var d,v=(0,Ae.Z)(p);try{for(v.s();!(d=v.n()).done;){var y=d.value;this.score.rejectMessage(y,e,h.topic,f)}}catch(g){v.e(g)}finally{v.f()}null===(l=this.metrics)||void 0===l||l.onReportValidation(h.topic,n)}}}},{key:"sendGraft",value:function(e,t){var n=[{topicID:t}];this.sendRpc(e,{control:{graft:n}})}},{key:"sendPrune",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.makePrune(t,n,this.opts.doPX);case 2:e.t0=e.sent,r=[e.t0],this.sendRpc(t,{control:{prune:r}});case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"sendRpc",value:function(e,t){var n,r=this.streamsOutbound.get(e);if(!r)return this.log("Cannot send RPC to ".concat(e," as there is no open stream to it available")),!1;var i=this.control.get(e);i&&(this.piggybackControl(e,t,i),this.control.delete(e));var o=this.gossip.get(e);o&&(this.piggybackGossip(e,t,o),this.gossip.delete(e));var a=iC.encode(t).finish();try{r.push(a)}catch(s){return this.log.error("Cannot send rpc to ".concat(e),s),i&&this.control.set(e,i),o&&this.gossip.set(e,o),!1}return null===(n=this.metrics)||void 0===n||n.onRpcSent(t,a.length),!0}},{key:"piggybackControl",value:function(e,t,n){if(n.graft){t.control||(t.control={}),t.control.graft||(t.control.graft=[]);var r,i=(0,Ae.Z)(n.graft);try{for(i.s();!(r=i.n()).done;){var o,a=r.value;a.topicID&&null!==(o=this.mesh.get(a.topicID))&&void 0!==o&&o.has(e)&&t.control.graft.push(a)}}catch(f){i.e(f)}finally{i.f()}}if(n.prune){t.control||(t.control={}),t.control.prune||(t.control.prune=[]);var s,u=(0,Ae.Z)(n.prune);try{for(u.s();!(s=u.n()).done;){var c,l=s.value;!l.topicID||null!==(c=this.mesh.get(l.topicID))&&void 0!==c&&c.has(e)||t.control.prune.push(l)}}catch(f){u.e(f)}finally{u.f()}}}},{key:"piggybackGossip",value:function(e,t,n){t.control||(t.control={}),t.control.ihave=n}},{key:"sendGraftPrune",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a,c,l,f,h,p=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=this.opts.doPX,o=(0,Ae.Z)(t),e.prev=2,c=(0,s.Z)().mark((function e(){var t,o,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,k.Z)(a.value,2),o=t[0],c=t[1],l=c.map((function(e){return{topicID:e}})),f=[],!(h=n.get(o))){e.next=9;break}return e.next=7,Promise.all(h.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.makePrune(o,t,i&&!(null!==(n=r.get(o))&&void 0!==n&&n));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 7:f=e.sent,n.delete(o);case 9:p.sendRpc(o,{control:{graft:l,prune:f}});case 10:case"end":return e.stop()}}),e)})),o.s();case 5:if((a=o.n()).done){e.next=9;break}return e.delegateYield(c(),"t0",7);case 7:e.next=5;break;case 9:e.next=14;break;case 11:e.prev=11,e.t1=e.catch(2),o.e(e.t1);case 14:return e.prev=14,o.f(),e.finish(14);case 17:l=(0,Ae.Z)(n),e.prev=18,h=(0,s.Z)().mark((function e(){var t,n,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,k.Z)(f.value,2),n=t[0],o=t[1],e.next=3,Promise.all(o.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.makePrune(n,t,i&&!(null!==(o=r.get(n))&&void 0!==o&&o));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:a=e.sent,p.sendRpc(n,{control:{prune:a}});case 5:case"end":return e.stop()}}),e)})),l.s();case 21:if((f=l.n()).done){e.next=25;break}return e.delegateYield(h(),"t2",23);case 23:e.next=21;break;case 25:e.next=30;break;case 27:e.prev=27,e.t3=e.catch(18),l.e(e.t3);case 30:return e.prev=30,l.f(),e.finish(30);case 33:case"end":return e.stop()}}),e,this,[[2,11,14,17],[18,27,30,33]])})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"emitGossip",value:function(e){var t,n=this.mcache.getGossipIDs(new Set(e.keys())),r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i,o=(0,k.Z)(t.value,2),a=o[0],s=o[1];this.doEmitGossip(a,s,null!==(i=n.get(a))&&void 0!==i?i:[])}}catch(u){r.e(u)}finally{r.f()}}},{key:"doEmitGossip",value:function(e,t,n){var r=this;if(n.length&&(cC(n),n.length>uC&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),t.size)){var i=this.opts.Dlazy,o=.25*t.size,a=t;o>i&&(i=o),i>a.size?i=a.size:a=cC(Array.from(a)).slice(0,i),a.forEach((function(t){var i=n;n.length>uC&&(i=cC(i.slice()).slice(0,uC)),r.pushGossip(t,{topicID:e,messageIDs:i})}))}}},{key:"flush",value:function(){var e,t=(0,Ae.Z)(this.gossip.entries());try{for(t.s();!(e=t.n()).done;){var n=(0,k.Z)(e.value,2),r=n[0],i=n[1];this.gossip.delete(r),this.sendRpc(r,{control:{ihave:i}})}}catch(l){t.e(l)}finally{t.f()}var o,a=(0,Ae.Z)(this.control.entries());try{for(a.s();!(o=a.n()).done;){var s=(0,k.Z)(o.value,2),u=s[0],c=s[1];this.control.delete(u),this.sendRpc(u,{control:{graft:c.graft,prune:c.prune}})}}catch(l){a.e(l)}finally{a.f()}}},{key:"pushGossip",value:function(e,t){this.log("Add gossip to %s",e);var n=this.gossip.get(e)||[];this.gossip.set(e,n.concat(t))}},{key:"makePrune",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a,c=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.score.prune(t,n),this.streamsOutbound.get(t).protocol!==aC){e.next=3;break}return e.abrupt("return",{topicID:n,peers:[]});case 3:if(i=this.opts.pruneBackoff/1e3,r){e.next=6;break}return e.abrupt("return",{topicID:n,peers:[],backoff:i});case 6:return o=this.getRandomGossipPeers(n,this.opts.prunePeers,(function(e){return e!==t&&c.score.score(e)>=0})),e.next=9,Promise.all(Array.from(o).map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,Ps.jE)(t),e.prev=1,e.next=4,c.components.peerStore.get(r);case 4:i=e.sent,e.next=11;break;case 7:if(e.prev=7,e.t0=e.catch(1),"ERR_NOT_FOUND"===e.t0.code){e.next=11;break}throw e.t0;case 11:return e.abrupt("return",{peerID:r.toBytes(),signedPeerRecord:null===(n=i)||void 0===n?void 0:n.peerRecordEnvelope});case 12:case"end":return e.stop()}}),e,null,[[1,7]])})));return function(t){return e.apply(this,arguments)}}()));case 9:return a=e.sent,e.abrupt("return",{topicID:n,peers:a,backoff:i});case 11:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"heartbeat",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,c,l,f,h,p,d,v,y,g,m=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.opts,i=r.D,o=r.Dlo,a=r.Dhi,u=r.Dscore,c=r.Dout,l=r.fanoutTTL,this.heartbeatTicks++,f=new Map,h=function(e){var t=f.get(e);return void 0===t&&(t=m.score.score(e),f.set(e,t)),t},p=new Map,d=new Map,v=new Map,this.clearBackoff(),this.peerhave.clear(),null===(t=this.metrics)||void 0===t||t.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks!==0){e.next=15;break}return e.next=15,this.directConnect();case 15:return null===(n=this.fastMsgIdCache)||void 0===n||n.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune(),y=new Map,this.mesh.forEach((function(e,t){var n=m.topics.get(t),r=new Set,s=new Set;if(y.set(t,s),n){var l,f=cC(Array.from(n)),g=m.backoff.get(t),b=(0,Ae.Z)(f);try{for(b.s();!(l=b.n()).done;){var w=l.value,k=m.streamsOutbound.get(w);if(k&&m.multicodecs.includes(k.protocol)&&!e.has(w)&&!m.direct.has(w)){var E=h(w);g&&g.has(w)||!(E>=0)||r.add(w),E>=m.opts.scoreThresholds.gossipThreshold&&s.add(w)}}}catch(U){b.e(U)}finally{b.f()}}var x=function(n,r){var i;m.log("HEARTBEAT: Remove mesh link to %s in %s",n,t),m.addBackoff(n,t),e.delete(n),h(n)>=m.opts.scoreThresholds.gossipThreshold&&s.add(n),null===(i=m.metrics)||void 0===i||i.onRemoveFromMesh(t,r,1);var o=d.get(n);o?o.push(t):d.set(n,[t])},_=function(n,r){var i;m.log("HEARTBEAT: Add mesh link to %s in %s",n,t),m.score.graft(n,t),e.add(n),s.delete(n),null===(i=m.metrics)||void 0===i||i.onAddToMesh(t,r,1);var o=p.get(n);o?o.push(t):p.set(n,[t])};(e.forEach((function(e){var n=h(e);n<0&&(m.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",e,n,t),x(e,GC.BadScore),v.set(e,!0))})),e.size<o)&&zC(r,i-e.size).forEach((function(e){_(e,VC.NotEnough)}));if(e.size>a){var S=Array.from(e);S.sort((function(e,t){return h(t)-h(e)})),S=S.slice(0,u).concat(cC(S.slice(u)));var A=0;if(S.slice(0,i).forEach((function(e){m.outbound.get(e)&&A++})),A<c){var Z=function(e){for(var t=S[e],n=e;n>0;n--)S[n]=S[n-1];S[0]=t};if(A>0)for(var T=A,C=1;C<i&&T>0;C++)m.outbound.get(S[C])&&(Z(C),T--);for(var I=i-A,D=i;D<S.length&&I>0;D++)m.outbound.get(S[D])&&(Z(D),I--)}S.slice(i).forEach((function(e){x(e,GC.Excess)}))}if(e.size>=o){var O=0;if(e.forEach((function(e){m.outbound.get(e)&&O++})),O<c){var R=UC(r,c-O,(function(e){return!0===m.outbound.get(e)}));R.forEach((function(e){_(e,VC.Outbound)}))}}if(m.heartbeatTicks%m.opts.opportunisticGraftTicks===0&&e.size>1){var P=Array.from(e).sort((function(e,t){return h(e)-h(t)})),L=Math.floor(e.size/2),N=h(P[L]);if(N<m.opts.scoreThresholds.opportunisticGraftThreshold){var B,M=UC(r,m.opts.opportunisticGraftPeers,(function(e){return h(e)>N})),F=(0,Ae.Z)(M);try{for(F.s();!(B=F.n()).done;){var j=B.value;m.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",j,t),_(j,VC.Opportunistic)}}catch(U){F.e(U)}finally{F.f()}}}})),g=Date.now(),this.fanoutLastpub.forEach((function(e,t){e+l<g&&(m.fanout.delete(t),m.fanoutLastpub.delete(t))})),this.fanout.forEach((function(e,t){var n=m.topics.get(t);e.forEach((function(t){(!n.has(t)||h(t)<m.opts.scoreThresholds.publishThreshold)&&e.delete(t)}));var r=m.topics.get(t),o=[],a=new Set;if(y.set(t,a),r){var s,u=cC(Array.from(r)),c=(0,Ae.Z)(u);try{for(c.s();!(s=c.n()).done;){var l=s.value,f=m.streamsOutbound.get(l);if(f&&m.multicodecs.includes(f.protocol)&&!e.has(l)&&!m.direct.has(l)){var p=h(l);p>=m.opts.scoreThresholds.publishThreshold&&o.push(l),p>=m.opts.scoreThresholds.gossipThreshold&&a.add(l)}}}catch(v){c.e(v)}finally{c.f()}}if(e.size<i){var d=i-e.size;o.slice(0,d).forEach((function(t){e.add(t),null===a||void 0===a||a.delete(t)}))}})),this.emitGossip(y),e.next=27,this.sendGraftPrune(p,d,v);case 27:this.flush(),this.mcache.shift(),this.dispatchEvent(new Dh("gossipsub:heartbeat"));case 30:case"end":return e.st