gth>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=js[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}function tu(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}!function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes){var r,i=(0,Ae.Z)(e.webtransportCerthashes);try{for(i.s();!(r=i.n()).done;){var o=r.value;t.uint32(10),t.bytes(o)}}catch(a){i.e(a)}finally{i.f()}}!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={webtransportCerthashes:[]},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();if(i>>>3===1)n.webtransportCerthashes.push(e.bytes());else e.skipType(7&i)}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(Ns||(Ns={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n,r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(!1!==i.lengthDelimited&&t.fork(),!0===i.writeDefaults||null!=e.identityKey&&e.identityKey.byteLength>0)&&(t.uint32(10),t.bytes(null!==(n=e.identityKey)&&void 0!==n?n:new Uint8Array(0)));(!0===i.writeDefaults||null!=e.identitySig&&e.identitySig.byteLength>0)&&(t.uint32(18),t.bytes(null!==(r=e.identitySig)&&void 0!==r?r:new Uint8Array(0)));null!=e.extensions&&(t.uint32(34),Ns.codec().encode(e.extensions,t,{writeDefaults:!1})),!1!==i.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.identityKey=e.bytes();break;case 2:n.identitySig=e.bytes();break;case 4:n.extensions=Ns.codec().decode(e,e.uint32());break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(Bs||(Bs={}));var nu,ru=n(95563),iu=(0,ru.kg)("libp2p:noise");function ou(e){e?(nu("LOCAL_PUBLIC_EPHEMERAL_KEY ".concat(eu(e.publicKey,"hex"))),nu("LOCAL_PRIVATE_EPHEMERAL_KEY ".concat(eu(e.privateKey,"hex")))):nu("Missing local ephemeral keys.")}function au(e){nu("REMOTE_EPHEMERAL_PUBLIC_KEY ".concat(eu(e,"hex")))}nu=mn?iu:Object.assign((function(){}),{enabled:!1,trace:function(){},error:function(){}});var su=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,K.Z)(this,e),(0,ot.Z)(this,"n",void 0),(0,ot.Z)(this,"bytes",void 0),(0,ot.Z)(this,"view",void 0),this.n=t,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,t,!0)}return(0,W.Z)(e,[{key:"increment",value:function(){this.n++,this.view.setUint32(4,this.n,!0)}},{key:"getBytes",value:function(){return this.bytes}},{key:"getUint64",value:function(){return this.n}},{key:"assertValue",value:function(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}]),e}(),uu=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"crypto",void 0),this.crypto=t}return(0,W.Z)(e,[{key:"encryptWithAd",value:function(e,t,n){var r=this.encrypt(e.k,e.n,t,n);return e.n.increment(),r}},{key:"decryptWithAd",value:function(e,t,n,r){var i=this.decrypt(e.k,e.n,t,n,r),o=i.plaintext,a=i.valid;return a&&e.n.increment(),{plaintext:o,valid:a}}},{key:"hasKey",value:function(e){return!this.isEmptyKey(e.k)}},{key:"createEmptyKey",value:function(){return new Uint8Array(32)}},{key:"isEmptyKey",value:function(e){return tu(this.createEmptyKey(),e)}},{key:"encrypt",value:function(e,t,n,r){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(r,t.getBytes(),n,e)}},{key:"encryptAndHash",value:function(e,t){var n;return n=this.hasKey(e.cs)?this.encryptWithAd(e.cs,e.h,t):t,this.mixHash(e,n),n}},{key:"decrypt",value:function(e,t,n,r,i){t.assertValue();var o=this.crypto.chaCha20Poly1305Decrypt(r,t.getBytes(),n,e,i);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}},{key:"decryptAndHash",value:function(e,t){var n,r=!0;if(this.hasKey(e.cs)){var i=this.decryptWithAd(e.cs,e.h,t);n=i.plaintext,r=i.valid}else n=t;return this.mixHash(e,t),{plaintext:n,valid:r}}},{key:"dh",value:function(e,t){try{var n=this.crypto.generateX25519SharedKey(e,t);return 32===n.length?n:n.subarray(0,32)}catch(i){var r=i;return iu.error(r),new Uint8Array(32)}}},{key:"mixHash",value:function(e,t){e.h=this.getHash(e.h,t)}},{key:"getHash",value:function(e,t){return this.crypto.hashSHA256(Gn([e,t],e.length+t.length))}},{key:"mixKey",value:function(e,t){var n=this.crypto.getHKDF(e.ck,t),r=(0,k.Z)(n,2),i=r[0],o=r[1];e.cs=this.initializeKey(o),e.ck=i}},{key:"initializeKey",value:function(e){return{k:e,n:new su}}},{key:"initializeSymmetric",value:function(e){var t=Us(e,"utf-8"),n=this.hashProtocolName(t),r=n,i=this.createEmptyKey();return{cs:this.initializeKey(i),ck:r,h:n}}},{key:"hashProtocolName",value:function(e){if(e.length<=32){var t=new Uint8Array(32);return t.set(e),t}return this.getHash(e,new Uint8Array(0))}},{key:"split",value:function(e){var t=this.crypto.getHKDF(e.ck,new Uint8Array(0)),n=(0,k.Z)(t,2),r=n[0],i=n[1];return{cs1:this.initializeKey(r),cs2:this.initializeKey(i)}}},{key:"writeMessageRegular",value:function(e,t){var n=this.encryptWithAd(e,new Uint8Array(0),t);return{ne:this.createEmptyKey(),ns:new Uint8Array(0),ciphertext:n}}},{key:"readMessageRegular",value:function(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}}]),e}(),cu=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){return(0,K.Z)(this,n),t.apply(this,arguments)}return(0,W.Z)(n,[{key:"initializeInitiator",value:function(e,t,n,r){var i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");return this.mixHash(i,e),{ss:i,s:t,rs:n,psk:r,re:new Uint8Array(32)}}},{key:"initializeResponder",value:function(e,t,n,r){var i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");return this.mixHash(i,e),{ss:i,s:t,rs:n,psk:r,re:new Uint8Array(32)}}},{key:"writeMessageA",value:function(e,t,n){var r=new Uint8Array(0);e.e=void 0!==n?n:this.crypto.generateX25519KeyPair();var i=e.e.publicKey;return this.mixHash(e.ss,i),{ne:i,ns:r,ciphertext:this.encryptAndHash(e.ss,t)}}},{key:"writeMessageB",value:function(e,t){e.e=this.crypto.generateX25519KeyPair();var n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));var r=e.s.publicKey,i=this.encryptAndHash(e.ss,r);return this.mixKey(e.ss,this.dh(e.s.privateKey,e.re)),{ne:n,ns:i,ciphertext:this.encryptAndHash(e.ss,t)}}},{key:"writeMessageC",value:function(e,t){var n=e.s.publicKey,r=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));var i=this.encryptAndHash(e.ss,t),o={ne:this.createEmptyKey(),ns:r,ciphertext:i},a=this.split(e.ss),s=a.cs1,u=a.cs2;return{h:e.ss.h,messageBuffer:o,cs1:s,cs2:u}}},{key:"readMessageA",value:function(e,t){return Js(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}},{key:"readMessageB",value:function(e,t){if(Js(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));var n=this.decryptAndHash(e.ss,t.ns),r=n.plaintext,i=n.valid;i&&Js(r)&&(e.rs=r),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));var o=this.decryptAndHash(e.ss,t.ciphertext),a=o.plaintext,s=o.valid;return{plaintext:a,valid:i&&s}}},{key:"readMessageC",value:function(e,t){var n=this.decryptAndHash(e.ss,t.ns),r=n.plaintext,i=n.valid;if(i&&Js(r)&&(e.rs=r),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));var o=this.decryptAndHash(e.ss,t.ciphertext),a=o.plaintext,s=o.valid,u=this.split(e.ss),c=u.cs1,l=u.cs2;return{h:e.ss.h,plaintext:a,valid:i&&s,cs1:c,cs2:l}}},{key:"initSession",value:function(e,t,n){var r=this.createEmptyKey(),i=new Uint8Array(32);return{hs:e?this.initializeInitiator(t,n,i,r):this.initializeResponder(t,n,i,r),i:e,mc:0}}},{key:"sendMessage",value:function(e,t,n){var r;if(0===e.mc)r=this.writeMessageA(e.hs,t,n);else if(1===e.mc)r=this.writeMessageB(e.hs,t);else if(2===e.mc){var i=this.writeMessageC(e.hs,t),o=i.h,a=i.messageBuffer,s=i.cs1,u=i.cs2;r=a,e.h=o,e.cs1=s,e.cs2=u}else{if(!(e.mc>2))throw new Error("Session invalid.");if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");r=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");r=this.writeMessageRegular(e.cs2,t)}}return e.mc++,r}},{key:"recvMessage",value:function(e,t){var n=new Uint8Array(0),r=!1;if(0===e.mc){var i=this.readMessageA(e.hs,t);n=i.plaintext,r=i.valid}else if(1===e.mc){var o=this.readMessageB(e.hs,t);n=o.plaintext,r=o.valid}else if(2===e.mc){var a=this.readMessageC(e.hs,t),s=a.h,u=a.plaintext,c=a.valid,l=a.cs1,f=a.cs2;n=u,r=c,e.h=s,e.cs1=l,e.cs2=f}return e.mc++,{plaintext:n,valid:r}}}]),n}(uu),lu=function(){function e(t,n,r,i,o,a,s,u){(0,K.Z)(this,e),(0,ot.Z)(this,"isInitiator",void 0),(0,ot.Z)(this,"session",void 0),(0,ot.Z)(this,"remotePeer",void 0),(0,ot.Z)(this,"remoteExtensions",{webtransportCerthashes:[]}),(0,ot.Z)(this,"payload",void 0),(0,ot.Z)(this,"connection",void 0),(0,ot.Z)(this,"xx",void 0),(0,ot.Z)(this,"staticKeypair",void 0),(0,ot.Z)(this,"prologue",void 0),this.isInitiator=t,this.payload=n,this.prologue=r,this.staticKeypair=o,this.connection=a,s&&(this.remotePeer=s),this.xx=null!==u&&void 0!==u?u:new cu(i),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}return(0,W.Z)(e,[{key:"propose",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.session.hs.s,nu("LOCAL_STATIC_PUBLIC_KEY ".concat(eu(i.publicKey,"hex"))),nu("LOCAL_STATIC_PRIVATE_KEY ".concat(eu(i.privateKey,"hex"))),!this.isInitiator){e.next=9;break}iu.trace("Stage 0 - Initiator starting to send first message."),t=this.xx.sendMessage(this.session,new Uint8Array(0)),this.connection.writeLP(qn(t)),iu.trace("Stage 0 - Initiator finished sending first message."),ou(this.session.hs.e),e.next=20;break;case 9:return iu.trace("Stage 0 - Responder waiting to receive first message..."),e.t0=Xn,e.next=13,this.connection.readLP();case 13:if(e.t1=e.sent.subarray(),n=(0,e.t0)(e.t1),r=this.xx.recvMessage(this.session,n),r.valid){e.next=18;break}throw new ir("xx handshake stage 0 validation fail");case 18:iu.trace("Stage 0 - Responder received first message."),au(this.session.hs.re);case 20:case"end":return e.stop()}var i}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"exchange",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isInitiator){e.next=34;break}return iu.trace("Stage 1 - Initiator waiting to receive first message from responder..."),e.t0=$n,e.next=5,this.connection.readLP();case 5:if(e.t1=e.sent.subarray(),t=(0,e.t0)(e.t1),n=this.xx.recvMessage(this.session,t),r=n.plaintext,n.valid){e.next=10;break}throw new ir("xx handshake stage 1 validation fail");case 10:if(iu.trace("Stage 1 - Initiator received the message."),au(this.session.hs.re),s=this.session.hs.rs,nu("REMOTE_STATIC_PUBLIC_KEY ".concat(eu(s,"hex"))),iu.trace("Initiator going to check remote's signature..."),e.prev=14,i=Ys(r),e.t2=this.remotePeer,e.t2){e.next=21;break}return e.next=20,Ws(i);case 20:e.t2=e.sent;case 21:return this.remotePeer=e.t2,e.next=24,Xs(this.session.hs.rs,i,this.remotePeer);case 24:this.setRemoteNoiseExtension(i.extensions),e.next=31;break;case 27:throw e.prev=27,e.t3=e.catch(14),o=e.t3,new rr("Error occurred while verifying signed payload: ".concat(o.message));case 31:iu.trace("All good with the signature!"),e.next=39;break;case 34:iu.trace("Stage 1 - Responder sending out first message with signed payload and static key."),a=this.xx.sendMessage(this.session,this.payload),this.connection.writeLP(Yn(a)),iu.trace("Stage 1 - Responder sent the second handshake message with signed payload."),ou(this.session.hs.e);case 39:case"end":return e.stop()}var s}),e,this,[[14,27]])})));return function(){return e.apply(this,arguments)}}()},{key:"finish",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isInitiator){e.next=7;break}iu.trace("Stage 2 - Initiator sending third handshake message."),t=this.xx.sendMessage(this.session,this.payload),this.connection.writeLP(Qn(t)),iu.trace("Stage 2 - Initiator sent message with signed payload."),e.next=34;break;case 7:return iu.trace("Stage 2 - Responder waiting for third handshake message..."),e.t0=Jn,e.next=11,this.connection.readLP();case 11:if(e.t1=e.sent.subarray(),n=(0,e.t0)(e.t1),r=this.xx.recvMessage(this.session,n),i=r.plaintext,r.valid){e.next=16;break}throw new ir("xx handshake stage 2 validation fail");case 16:if(iu.trace("Stage 2 - Responder received the message, finished handshake."),e.prev=17,o=Ys(i),e.t2=this.remotePeer,e.t2){e.next=24;break}return e.next=23,Ws(o);case 23:e.t2=e.sent;case 24:return this.remotePeer=e.t2,e.next=27,Xs(this.session.hs.rs,o,this.remotePeer);case 27:this.setRemoteNoiseExtension(o.extensions),e.next=34;break;case 30:throw e.prev=30,e.t3=e.catch(17),a=e.t3,new rr("Error occurred while verifying signed payload: ".concat(a.message));case 34:(s=this.session).cs1&&s.cs2?(nu("CIPHER_STATE_1 ".concat(s.cs1.n.getUint64()," ").concat(eu(s.cs1.k,"hex"))),nu("CIPHER_STATE_2 ".concat(s.cs2.n.getUint64()," ").concat(eu(s.cs2.k,"hex")))):nu("Missing cipher state.");case 35:case"end":return e.stop()}var s}),e,this,[[17,30]])})));return function(){return e.apply(this,arguments)}}()},{key:"encrypt",value:function(e,t){var n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}},{key:"decrypt",value:function(e,t,n){var r=this.getCS(t,!1);return this.xx.decryptWithAd(r,new Uint8Array(0),e,n)}},{key:"getRemoteStaticKey",value:function(){return this.session.hs.rs}},{key:"getCS",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e.cs1||!e.cs2)throw new ir("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}},{key:"setRemoteNoiseExtension",value:function(e){e&&(this.remoteExtensions=e)}}]),e}();var fu=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"protocol","/noise"),(0,ot.Z)(this,"crypto",void 0),(0,ot.Z)(this,"prologue",void 0),(0,ot.Z)(this,"staticKeys",void 0),(0,ot.Z)(this,"extensions",void 0),(0,ot.Z)(this,"metrics",void 0);var n=t.staticNoiseKey,r=t.extensions,i=t.crypto,o=t.prologueBytes,a=t.metrics;this.crypto=null!==i&&void 0!==i?i:Vn,this.extensions=r,this.metrics=a?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(a):void 0,this.staticKeys=n?this.crypto.generateX25519KeyPairFromSeed(n):this.crypto.generateX25519KeyPair(),this.prologue=null!==o&&void 0!==o?o:new Uint8Array(0)}return(0,W.Z)(e,[{key:"secureOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=nn(n,{lengthEncoder:Kn,lengthDecoder:Wn,maxDataLength:gn}),e.next=3,this.performHandshake({connection:i,isInitiator:!0,localPeer:t,remotePeer:r});case 3:return o=e.sent,e.next=6,this.createSecureConnection(i,o);case 6:return a=e.sent,e.abrupt("return",{conn:a,remoteExtensions:o.remoteExtensions,remotePeer:o.remotePeer});case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"secureInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=nn(n,{lengthEncoder:Kn,lengthDecoder:Wn,maxDataLength:gn}),e.next=3,this.performHandshake({connection:i,isInitiator:!1,localPeer:t,remotePeer:r});case 3:return o=e.sent,e.next=6,this.createSecureConnection(i,o);case 6:return a=e.sent,e.abrupt("return",{conn:a,remotePeer:o.remotePeer,remoteExtensions:o.remoteExtensions});case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"performHandshake",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zs(t.localPeer,this.staticKeys.publicKey,this.extensions);case 2:return n=e.sent,e.abrupt("return",this.performXXHandshake(t,n));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"performXXHandshake",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.isInitiator,i=t.remotePeer,o=t.connection,a=new lu(r,n,this.prologue,this.crypto,this.staticKeys,o,i),e.prev=2,e.next=5,a.propose();case 5:return e.next=7,a.exchange();case 7:return e.next=9,a.finish();case 9:null===(u=this.metrics)||void 0===u||u.xxHandshakeSuccesses.increment(),e.next=18;break;case 12:if(e.prev=12,e.t0=e.catch(2),null===(c=this.metrics)||void 0===c||c.xxHandshakeErrors.increment(),!(e.t0 instanceof Error)){e.next=18;break}throw e.t0.message="Error occurred during XX handshake: ".concat(e.t0.message),e.t0;case 18:return e.abrupt("return",a);case 19:case"end":return e.stop()}}),e,this,[[2,12]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"createSecureConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Ht(),i=(0,k.Z)(r,2),o=i[0],a=i[1],u=t.unwrap(),e.next=4,cn(o,er(n,this.metrics),u,(function(e){return jt(e,{lengthDecoder:Wn})}),tr(n,this.metrics),o);case 4:return e.abrupt("return",a);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}();function hu(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(){return new fu(e)}}var pu=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;return(0,K.Z)(this,n),(i=t.call(this,null!==e&&void 0!==e?e:"The operation was aborted")).type="aborted",i.code=null!==r&&void 0!==r?r:"ABORT_ERR",i}return(0,W.Z)(n)}((0,Ze.Z)(Error));function du(e,t,n){var r=null!==n&&void 0!==n?n:{},i=function(e){if(null!=e){if("function"===typeof e[Symbol.iterator])return e[Symbol.iterator]();if("function"===typeof e[Symbol.asyncIterator])return e[Symbol.asyncIterator]();if("function"===typeof e.next)return e}throw new Error("argument is not an iterator or iterable")}(e);function o(){return(o=(0,g.Z)((0,s.Z)().mark((function n(){var o,a,u,c,l,f,h,p;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:a=function(){null!=o&&o()},t.addEventListener("abort",a);case 2:if(u=void 0,n.prev=4,!t.aborted){n.next=8;break}throw c=r.abortMessage,l=r.abortCode,new pu(c,l);case 8:return f=new Promise((function(e,t){o=function(){var e=r.abortMessage,n=r.abortCode;t(new pu(e,n))}})),n.next=11,(0,m.Z)(Promise.race([f,i.next()]));case 11:u=n.sent,o=null,n.next=24;break;case 15:if(n.prev=15,n.t0=n.catch(4),t.removeEventListener("abort",a),(h="aborted"===n.t0.type&&t.aborted)&&null!=r.onAbort&&r.onAbort(e),"function"===typeof i.return)try{(p=i.return())instanceof Promise&&p.catch((function(e){null!=r.onReturnError&&r.onReturnError(e)}))}catch(s){null!=r.onReturnError&&r.onReturnError(s)}if(!h||!0!==r.returnOnAbort){n.next=23;break}return n.abrupt("return");case 23:throw n.t0;case 24:if(!0!==u.done){n.next=26;break}return n.abrupt("break",30);case 26:return n.next=28,u.value;case 28:n.next=2;break;case 30:t.removeEventListener("abort",a);case 31:case"end":return n.stop()}}),n,null,[[4,15]])})))).apply(this,arguments)}return function(){return o.apply(this,arguments)}()}function vu(e,t,n){return function(r){return e(du(r,t,n))}}function yu(e,t,n){return{sink:vu(e.sink,t,(0,Nt.Z)((0,Nt.Z)({},n),{},{onAbort:void 0})),source:du(e.source,t,n)}}function gu(e){var t=new globalThis.AbortController;function n(){t.abort();var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;null!=(null===o||void 0===o?void 0:o.removeEventListener)&&o.removeEventListener("abort",n)}}catch(a){i.e(a)}finally{i.f()}}var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;if(!0===(null===o||void 0===o?void 0:o.aborted)){n();break}null!=(null===o||void 0===o?void 0:o.addEventListener)&&o.addEventListener("abort",n)}}catch(s){i.e(s)}finally{i.f()}var a=t.signal;return a.clear=function(){var t,r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;null!=(null===i||void 0===i?void 0:i.removeEventListener)&&i.removeEventListener("abort",n)}}catch(s){r.e(s)}finally{r.f()}},a}var mu=function(){function e(t){if((0,K.Z)(this,e),!(t>0)||0!==(t-1&t))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}return(0,W.Z)(e,[{key:"push",value:function(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}},{key:"shift",value:function(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}},{key:"isEmpty",value:function(){return void 0===this.buffer[this.btm]}}]),e}(),bu=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.hwm=null!==(t=n.splitLimit)&&void 0!==t?t:16,this.head=new mu(this.hwm),this.tail=this.head,this.size=0}return(0,W.Z)(e,[{key:"calculateSize",value:function(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}},{key:"push",value:function(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){var t=this.head;this.head=t.next=new mu(2*this.head.buffer.length),this.head.push(e)}}},{key:"shift",value:function(){var e,t=this.tail.shift();if(void 0===t&&null!=this.tail.next){var n=this.tail.next;this.tail.next=null,this.tail=n,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}},{key:"isEmpty",value:function(){return this.head.isEmpty()}}]),e}();function wu(){return ku((function(e){var t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function ku(e,t){var n,r,i,o,a,c,l=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,f=new bu,h=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(f.isEmpty()){t.next=2;break}return t.abrupt("return",e(f));case 2:if(!c){t.next=4;break}return t.abrupt("return",{done:!0});case 4:return t.next=6,new Promise((function(t,n){a=function(r){a=null,f.push(r);try{t(e(f))}catch(i){n(i)}return o}}));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e){return null!=a?a(e):(f.push(e),o)},d=function(e){var n;if(c)return o;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:e})},v=function(e){return c?o:(c=!0,null!=e?function(e){return f=new bu,null!=a?a({error:e}):(f.push({error:e}),o)}(e):p({done:!0}))};if(r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(r,"next",h),(0,ot.Z)(r,"return",(function(){return f=new bu,v(),{done:!0}})),(0,ot.Z)(r,"throw",(function(e){return v(e),{done:!0}})),(0,ot.Z)(r,"push",d),(0,ot.Z)(r,"end",v),Xt("get",r,"readableLength",(function(){return f.size})),o=r,null==l)return o;var y=o;return i={},(0,ot.Z)(i,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(i,"next",(function(){return y.next()})),(0,ot.Z)(i,"throw",(function(e){return y.throw(e),null!=l&&(l(e),l=void 0),{done:!0}})),(0,ot.Z)(i,"return",(function(){return y.return(),null!=l&&(l(),l=void 0),{done:!0}})),(0,ot.Z)(i,"push",d),(0,ot.Z)(i,"end",(function(e){return y.end(e),null!=l&&(l(e),l=void 0),o})),Xt("get",i,"readableLength",(function(){return y.readableLength})),o=i}var Eu=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=[],i=0,o=t;i<o.length;i++){var a=o[i];null==a[Symbol.asyncIterator]&&r.push(a)}return r.length===t.length?(0,s.Z)().mark((function e(){var t,n,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(r),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=8;break}return i=n.value,e.delegateYield(i,"t0",6);case 6:e.next=3;break;case 8:e.next=13;break;case 10:e.prev=10,e.t1=e.catch(1),t.e(e.t1);case 13:return e.prev=13,t.f(),e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[1,10,13,16]])}))():(0,g.Z)((0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=wu({objectMode:!0}),Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,i=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(r=!(u=e.sent).done)){e.next=12;break}c=u.value,n.push(c);case 9:r=!1,e.next=4;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(2),i=!0,o=e.t0;case 18:if(e.prev=18,e.prev=19,!r||null==a.return){e.next=23;break}return e.next=23,a.return();case 23:if(e.prev=23,!i){e.next=26;break}throw o;case 26:return e.finish(23);case 27:return e.finish(18);case 28:case"end":return e.stop()}}),e,null,[[2,14,18,28],[19,,23,27]])})));return function(t){return e.apply(this,arguments)}}()));case 3:n.end(),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),n.end(e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))),e.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",3);case 3:case"end":return e.stop()}}),e)})))()};function xu(e){if(null==e)throw new Error("Empty pipeline");if(Cu(e)){var t=e;e=function(){return t.source}}else if(Tu(e)||Zu(e)){var n=e;e=function(){return n}}for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];var a=[e].concat(i);if(a.length>1&&Cu(a[a.length-1])&&(a[a.length-1]=a[a.length-1].sink),a.length>2)for(var s=1;s<a.length-1;s++)Cu(a[s])&&(a[s]=Iu(a[s]));return Au.apply(void 0,(0,ye.Z)(a))}var _u,Su,Au=function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},Zu=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator])},Tu=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.iterator])},Cu=function(e){return null!=e&&(null!=e.sink&&null!=e.source)},Iu=function(e){return function(t){var n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){var r,i=wu({objectMode:!0});n.then((function(){i.end()}),(function(e){i.end(e)}));var o=e.source;if(Zu(o))r=function(){var e=(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(o),m.Z),"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();else{if(!Tu(o))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(o,"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)}))}return Eu(i,r())}return e.source}},Du="ERR_INVALID_FRAME",Ou="ERR_UNREQUESTED_PING",Ru="ERR_NOT_MATCHING_PING",Pu="ERR_STREAM_ALREADY_EXISTS",Lu="ERR_DECODE_INVALID_VERSION",Nu="ERR_BOTH_CLIENTS",Bu="ERR_RECV_WINDOW_EXCEEDED",Mu=new Set([Du,Ou,Ru,Pu,Lu,Nu,Bu]),Fu="ERR_INVALID_CONFIG",ju="ERR_MUXER_LOCAL_CLOSED",Uu="ERR_MUXER_REMOTE_CLOSED",zu="ERR_STREAM_ABORT",Hu=262144,Vu={log:(0,ru.kg)("libp2p:yamux"),enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Hu,maxStreamWindowSize:16777216,maxMessageSize:65536};!function(e){e[e.Data=0]="Data",e[e.WindowUpdate=1]="WindowUpdate",e[e.Ping=2]="Ping",e[e.GoAway=3]="GoAway"}(_u||(_u={})),function(e){e[e.SYN=1]="SYN",e[e.ACK=2]="ACK",e[e.FIN=4]="FIN",e[e.RST=8]="RST"}(Su||(Su={}));var Gu,Ku=Object.values(Su).filter((function(e){return"string"!==typeof e}));!function(e){e[e.NormalTermination=0]="NormalTermination",e[e.ProtocolError=1]="ProtocolError",e[e.InternalError=2]="InternalError"}(Gu||(Gu={}));function Wu(e){var t=Ku.filter((function(t){return(e.flag&t)===t})).map((function(e){return Su[e]})).join("|");return"streamID=".concat(e.streamID," type=").concat(_u[e.type]," flag=").concat(t," length=").concat(e.length)}var qu=Math.pow(2,24);var Yu,Qu,Xu=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"source",void 0),(0,ot.Z)(this,"buffer",void 0),(0,ot.Z)(this,"frameInProgress",void 0),this.source=function(e){if(void 0!==e[Symbol.iterator]){var t=e[Symbol.iterator]();return t.return=void 0,(0,ot.Z)({},Symbol.iterator,(function(){return t}))}if(void 0!==e[Symbol.asyncIterator]){var n=e[Symbol.asyncIterator]();return n.return=void 0,(0,ot.Z)({},Symbol.asyncIterator,(function(){return n}))}throw new Error("a source must be either an iterable or an async iterable")}(t),this.buffer=new vt,this.frameInProgress=!1}return(0,W.Z)(e,[{key:"emitFrames",value:function(){var e=this;return(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e.source);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(a=t.sent).done)){t.next=27;break}u=a.value,e.buffer.append(u);case 9:if(void 0!==(c=e.readHeader())){t.next=13;break}return t.abrupt("break",24);case 13:if(l=c.type,f=c.length,l!==_u.Data){t.next=20;break}return e.frameInProgress=!0,t.next=18,{header:c,readData:e.readBytes.bind(e,f)};case 18:t.next=22;break;case 20:return t.next=22,{header:c};case 22:t.next=9;break;case 24:n=!1,t.next=4;break;case 27:t.next=33;break;case 29:t.prev=29,t.t0=t.catch(2),r=!0,i=t.t0;case 33:if(t.prev=33,t.prev=34,!n||null==o.return){t.next=38;break}return t.next=38,(0,m.Z)(o.return());case 38:if(t.prev=38,!r){t.next=41;break}throw i;case 41:return t.finish(38);case 42:return t.finish(33);case 43:case"end":return t.stop()}}),t,null,[[2,29,33,43],[34,,38,42]])})))()}},{key:"readHeader",value:function(){if(this.frameInProgress)throw new ar.s("decoding frame already in progress","ERR_DECODE_IN_PROGRESS");if(!(this.buffer.length<12)){var e=function(e){if(0!==e[0])throw new ar.s("Invalid frame version",Lu);return{type:e[1],flag:(e[2]<<8)+e[3],streamID:e[4]*qu+(e[5]<<16)+(e[6]<<8)+e[7],length:e[8]*qu+(e[9]<<16)+(e[10]<<8)+e[11]}}(this.buffer.subarray(0,12));return this.buffer.consume(12),e}}},{key:"readBytes",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.buffer.length<t)){e.next=31;break}n=!1,r=!1,e.prev=3,o=(0,y.Z)(this.source);case 5:return e.next=7,o.next();case 7:if(!(n=!(a=e.sent).done)){e.next=15;break}if(u=a.value,this.buffer.append(u),!(this.buffer.length>=t)){e.next=12;break}return e.abrupt("break",15);case 12:n=!1,e.next=5;break;case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(3),r=!0,i=e.t0;case 21:if(e.prev=21,e.prev=22,!n||null==o.return){e.next=26;break}return e.next=26,o.return();case 26:if(e.prev=26,!r){e.next=29;break}throw i;case 29:return e.finish(26);case 30:return e.finish(21);case 31:return c=this.buffer.sublist(0,t),this.buffer.consume(t),this.frameInProgress=!1,e.abrupt("return",c);case 35:case"end":return e.stop()}}),e,this,[[3,17,21,31],[22,,26,30]])})));return function(t){return e.apply(this,arguments)}}()}]),e}();function $u(e){var t=new Uint8Array(12);return t[1]=e.type,t[2]=e.flag>>>8,t[3]=e.flag,t[4]=e.streamID>>>24,t[5]=e.streamID>>>16,t[6]=e.streamID>>>8,t[7]=e.streamID,t[8]=e.length>>>24,t[9]=e.length>>>16,t[10]=e.length>>>8,t[11]=e.length,t}!function(e){e[e.Init=0]="Init",e[e.SYNSent=1]="SYNSent",e[e.SYNReceived=2]="SYNReceived",e[e.Established=3]="Established",e[e.Finished=4]="Finished"}(Yu||(Yu={})),function(e){e[e.Open=0]="Open",e[e.Closed=1]="Closed",e[e.Reset=2]="Reset"}(Qu||(Qu={}));var Ju=function(){function e(t){var n=this;(0,K.Z)(this,e),(0,ot.Z)(this,"id",void 0),(0,ot.Z)(this,"name",void 0),(0,ot.Z)(this,"stat",void 0),(0,ot.Z)(this,"metadata",void 0),(0,ot.Z)(this,"state",void 0),(0,ot.Z)(this,"readState",void 0),(0,ot.Z)(this,"writeState",void 0),(0,ot.Z)(this,"sourceInput",void 0),(0,ot.Z)(this,"source",void 0),(0,ot.Z)(this,"sink",void 0),(0,ot.Z)(this,"config",void 0),(0,ot.Z)(this,"log",void 0),(0,ot.Z)(this,"_id",void 0),(0,ot.Z)(this,"sendWindowCapacity",void 0),(0,ot.Z)(this,"sendWindowCapacityUpdate",void 0),(0,ot.Z)(this,"recvWindow",void 0),(0,ot.Z)(this,"recvWindowCapacity",void 0),(0,ot.Z)(this,"epochStart",void 0),(0,ot.Z)(this,"getRTT",void 0),(0,ot.Z)(this,"abortController",void 0),(0,ot.Z)(this,"sendFrame",void 0),(0,ot.Z)(this,"onStreamEnd",void 0),this.config=t.config,this.log=t.log,this._id=t.id,this.id=String(t.id),this.name=t.name,this.stat={direction:t.direction,timeline:{open:Date.now()}},this.metadata={},this.state=t.state,this.readState=Qu.Open,this.writeState=Qu.Open,this.sendWindowCapacity=Hu,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=t.getRTT,this.abortController=new AbortController,this.sendFrame=t.sendFrame,this.onStreamEnd=t.onStreamEnd,this.sourceInput=wu({onEnd:function(e){var t,r;null!=e?null===(t=n.log)||void 0===t||t.error("stream source ended id=%s",n._id,e):null===(r=n.log)||void 0===r||r.trace("stream source ended id=%s",n._id);n.closeRead()}}),this.source=this.createSource(),this.sink=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.writeState===Qu.Open){e.next=2;break}throw new Error("stream closed for writing");case 2:t=du(t,n.abortController.signal,{returnOnAbort:!0}),e.prev=3,r=!1,i=!1,e.prev=6,a=(0,y.Z)(t);case 8:return e.next=10,a.next();case 10:if(!(r=!(u=e.sent).done)){e.next=25;break}c=u.value;case 12:if(0===c.length){e.next=22;break}if(0!==n.sendWindowCapacity){e.next=16;break}return e.next=16,n.waitForSendWindowCapacity();case 16:l=Math.min(n.sendWindowCapacity,n.config.maxMessageSize-12,c.length),n.sendData(c.subarray(0,l)),n.sendWindowCapacity-=l,c=c.subarray(l),e.next=12;break;case 22:r=!1,e.next=8;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(6),i=!0,o=e.t0;case 31:if(e.prev=31,e.prev=32,!r||null==a.return){e.next=36;break}return e.next=36,a.return();case 36:if(e.prev=36,!i){e.next=39;break}throw o;case 39:return e.finish(36);case 40:return e.finish(31);case 41:e.next=46;break;case 43:e.prev=43,e.t1=e.catch(3),null===(f=n.log)||void 0===f||f.error("stream sink error id=%s",n._id,e.t1);case 46:return e.prev=46,null===(h=n.log)||void 0===h||h.trace("stream sink ended id=%s",n._id),n.closeWrite(),e.finish(46);case 50:case"end":return e.stop()}}),e,null,[[3,43,46,50],[6,27,31,41],[32,,36,40]])})));return function(t){return e.apply(this,arguments)}}()}return(0,W.Z)(e,[{key:"createSource",value:function(){var e=this;return(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.prev=0,n=!1,r=!1,t.prev=3,o=(0,y.Z)(e.sourceInput);case 5:return t.next=7,(0,m.Z)(o.next());case 7:if(!(n=!(a=t.sent).done)){t.next=15;break}return u=a.value,e.sendWindowUpdate(),t.next=12,u;case 12:n=!1,t.next=5;break;case 15:t.next=21;break;case 17:t.prev=17,t.t0=t.catch(3),r=!0,i=t.t0;case 21:if(t.prev=21,t.prev=22,!n||null==o.return){t.next=26;break}return t.next=26,(0,m.Z)(o.return());case 26:if(t.prev=26,!r){t.next=29;break}throw i;case 29:return t.finish(26);case 30:return t.finish(21);case 31:t.next=39;break;case 33:if(t.prev=33,t.t1=t.catch(0),t.t1.code===zu){t.next=39;break}throw null===(c=e.log)||void 0===c||c.error("stream source error id=%s",e._id,t.t1),t.t1;case 39:case"end":return t.stop()}}),t,null,[[0,33],[3,17,21,31],[22,,26,30]])})))()}},{key:"close",value:function(){var e;null===(e=this.log)||void 0===e||e.trace("stream close id=%s",this._id),this.closeRead(),this.closeWrite()}},{key:"closeRead",value:function(){var e;this.state!==Yu.Finished&&this.readState===Qu.Open&&(null===(e=this.log)||void 0===e||e.trace("stream close read id=%s",this._id),this.readState=Qu.Closed,this.sourceInput.end(),this.writeState!==Qu.Open&&this.finish())}},{key:"closeWrite",value:function(){var e;this.state!==Yu.Finished&&this.writeState===Qu.Open&&(null===(e=this.log)||void 0===e||e.trace("stream close write id=%s",this._id),this.writeState=Qu.Closed,this.sendClose(),this.abortController.abort(),this.readState!==Qu.Open&&this.finish())}},{key:"abort",value:function(e){var t,n,r;switch(this.state){case Yu.Finished:return;case Yu.Init:break;case Yu.SYNSent:case Yu.SYNReceived:case Yu.Established:this.sendReset();break;default:throw new Error("unreachable")}null!=e?null===(n=this.log)||void 0===n||n.error("stream abort id=%s error=%s",this._id,e):null===(r=this.log)||void 0===r||r.trace("stream abort id=%s",this._id);this.onReset(new ar.s(null!==(t=String(e))&&void 0!==t?t:"stream aborted",zu))}},{key:"reset",value:function(){var e;this.state!==Yu.Finished&&(null===(e=this.log)||void 0===e||e.trace("stream reset id=%s",this._id),this.onReset(new ar.s("stream reset","ERR_STREAM_RESET")))}},{key:"onReset",value:function(e){this.writeState===Qu.Open&&(this.writeState=Qu.Reset),this.readState===Qu.Open&&(this.readState=Qu.Reset),this.state=Yu.Finished,this.sourceInput.end(e),this.abortController.abort(),this.finish()}},{key:"waitForSendWindowCapacity",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.abortController.signal.aborted){e.next=2;break}throw new ar.s("stream aborted",zu);case 2:if(!(this.sendWindowCapacity>0)){e.next=4;break}return e.abrupt("return");case 4:return n=function(){t(new ar.s("stream aborted",zu))},this.abortController.signal.addEventListener("abort",n),e.next=8,new Promise((function(e,i){r.sendWindowCapacityUpdate=function(){r.abortController.signal.removeEventListener("abort",n),e(void 0)},t=i}));case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"handleWindowUpdate",value:function(e){var t;null===(t=this.log)||void 0===t||t.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);var n,r=this.sendWindowCapacity;(this.sendWindowCapacity+=e.length,0===r&&e.length>0)&&(null===(n=this.sendWindowCapacityUpdate)||void 0===n||n.call(this))}},{key:"handleData",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(r=this.log)||void 0===r||r.trace("stream received data id=%s",this._id),this.processFlags(t.flag),!(this.recvWindowCapacity<t.length)){e.next=4;break}throw new ar.s("receive window exceeded",Bu,{available:this.recvWindowCapacity,recv:t.length});case 4:return e.next=6,n();case 6:i=e.sent,this.recvWindowCapacity-=t.length,this.sourceInput.push(i);case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"processFlags",value:function(e){(e&Su.ACK)===Su.ACK&&this.state===Yu.SYNSent&&(this.state=Yu.Established),(e&Su.FIN)===Su.FIN&&this.closeRead(),(e&Su.RST)===Su.RST&&this.reset()}},{key:"finish",value:function(){var e;null===(e=this.log)||void 0===e||e.trace("stream finished id=%s",this._id),this.state=Yu.Finished,this.stat.timeline.close=Date.now(),this.onStreamEnd()}},{key:"getSendFlags",value:function(){switch(this.state){case Yu.Init:return this.state=Yu.SYNSent,Su.SYN;case Yu.SYNReceived:return this.state=Yu.Established,Su.ACK;default:return 0}}},{key:"sendWindowUpdate",value:function(){var e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(0===e&&n>0&&t-this.epochStart<4*n&&(this.recvWindow=Math.min(2*this.recvWindow,this.config.maxStreamWindowSize)),!(this.recvWindowCapacity>=this.recvWindow&&0===e)){var r=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:_u.WindowUpdate,flag:e,streamID:this._id,length:r})}}},{key:"sendData",value:function(e){var t=this.getSendFlags();this.sendFrame({type:_u.Data,flag:t,streamID:this._id,length:e.length},e)}},{key:"sendClose",value:function(){var e=this.getSendFlags()|Su.FIN;this.sendFrame({type:_u.WindowUpdate,flag:e,streamID:this._id,length:0})}},{key:"sendReset",value:function(){this.sendFrame({type:_u.WindowUpdate,flag:Su.RST,streamID:this._id,length:0})}}]),e}(),ec="/yamux/1.0.0",tc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"protocol",ec),(0,ot.Z)(this,"_init",void 0),this._init=t}return(0,W.Z)(e,[{key:"createStreamMuxer",value:function(e){return new nc((0,Nt.Z)((0,Nt.Z)({},this._init),e))}}]),e}(),nc=function(){function e(t){var n,r=this;(0,K.Z)(this,e),(0,ot.Z)(this,"protocol",ec),(0,ot.Z)(this,"source",void 0),(0,ot.Z)(this,"sink",void 0),(0,ot.Z)(this,"_init",void 0),(0,ot.Z)(this,"config",void 0),(0,ot.Z)(this,"log",void 0),(0,ot.Z)(this,"closeController",void 0),(0,ot.Z)(this,"nextStreamID",void 0),(0,ot.Z)(this,"_streams",void 0),(0,ot.Z)(this,"nextPingID",void 0),(0,ot.Z)(this,"activePing",void 0),(0,ot.Z)(this,"rtt",void 0),(0,ot.Z)(this,"client",void 0),(0,ot.Z)(this,"localGoAway",void 0),(0,ot.Z)(this,"remoteGoAway",void 0),(0,ot.Z)(this,"numInboundStreams",void 0),(0,ot.Z)(this,"numOutboundStreams",void 0),(0,ot.Z)(this,"onIncomingStream",void 0),(0,ot.Z)(this,"onStreamEnd",void 0),this._init=t,this.client="outbound"===t.direction,this.config=(0,Nt.Z)((0,Nt.Z)({},Vu),t),this.log=this.config.log,function(e){if(e.keepAliveInterval<=0)throw new ar.s("keep-alive interval must be positive",Fu);if(e.maxInboundStreams<0)throw new ar.s("max inbound streams must be larger or equal 0",Fu);if(e.maxOutboundStreams<0)throw new ar.s("max outbound streams must be larger or equal 0",Fu);if(e.initialStreamWindowSize<Hu)throw new ar.s("InitialStreamWindowSize must be larger or equal 256 kB",Fu);if(e.maxStreamWindowSize<e.initialStreamWindowSize)throw new ar.s("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Fu);if(e.maxStreamWindowSize>Math.pow(2,32)-1)throw new ar.s("MaxStreamWindowSize must be less than equal MAX_UINT32",Fu);if(e.maxMessageSize<1024)throw new ar.s("MaxMessageSize must be greater than a kilobyte",Fu)}(this.config),this.closeController=new AbortController,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=wu({onEnd:function(e){var t;null===(t=r.log)||void 0===t||t.trace("muxer source ended"),r.close(e)}}),this.sink=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,i,o,a,c,l,f,h,p;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null!=r._init.signal&&(o=gu([r.closeController.signal,r._init.signal])),t=du(t,null!==(n=o)&&void 0!==n?n:r.closeController.signal,{returnOnAbort:!0}),e.prev=2,l=new Xu(t),e.next=6,xu(l.emitFrames.bind(l),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!1,i=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(n=!(u=e.sent).done)){e.next=13;break}return c=u.value,l=c.header,f=c.readData,e.next=10,r.handleFrame(l,f);case 10:n=!1,e.next=4;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(2),i=!0,o=e.t0;case 19:if(e.prev=19,e.prev=20,!n||null==a.return){e.next=24;break}return e.next=24,a.return();case 24:if(e.prev=24,!i){e.next=27;break}throw o;case 27:return e.finish(24);case 28:return e.finish(19);case 29:case"end":return e.stop()}}),e,null,[[2,15,19,29],[20,,24,28]])})));return function(t){return e.apply(this,arguments)}}());case 6:a=Gu.NormalTermination,e.next=14;break;case 9:e.prev=9,e.t0=e.catch(2),f=e.t0.code,Mu.has(f)?(null===(h=r.log)||void 0===h||h.error("protocol error in sink",e.t0),a=Gu.ProtocolError):(null===(p=r.log)||void 0===p||p.error("internal error in sink",e.t0),a=Gu.InternalError),c=e.t0;case 14:return e.prev=14,null!=o&&o.clear(),e.finish(14);case 17:null===(i=r.log)||void 0===i||i.trace("muxer sink ended"),r.close(c,a);case 19:case"end":return e.stop()}}),e,null,[[2,9,14,17]])})));return function(t){return e.apply(this,arguments)}}(),this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=0,null===(n=this.log)||void 0===n||n.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch((function(e){var t;return null===(t=r.log)||void 0===t?void 0:t.error("keepalive error: %s",e)}))}return(0,W.Z)(e,[{key:"streams",get:function(){return Array.from(this._streams.values())}},{key:"newStream",value:function(e){var t;if(void 0!==this.remoteGoAway)throw new ar.s("muxer closed remotely",Uu);if(void 0!==this.localGoAway)throw new ar.s("muxer closed locally",ju);var n=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new ar.s("max outbound streams exceeded","ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED");null===(t=this.log)||void 0===t||t.trace("new outgoing stream id=%s",n);var r=this._newStream(n,e,Yu.Init,"outbound");return this._streams.set(n,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}},{key:"ping",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.remoteGoAway){e.next=2;break}throw new ar.s("muxer closed remotely",Uu);case 2:if(void 0===this.localGoAway){e.next=4;break}throw new ar.s("muxer closed locally",ju);case 4:if(void 0!==this.activePing){e.next=19;break}return t=function(){},this.activePing={id:this.nextPingID++,promise:new Promise((function(e,n){var r=function(){n(new ar.s("muxer closed locally",ju))};i.closeController.signal.addEventListener("abort",r,{once:!0}),t=function(){i.closeController.signal.removeEventListener("abort",r),e()}})),resolve:t},n=Date.now(),this.sendPing(this.activePing.id),e.prev=9,e.next=12,this.activePing.promise;case 12:return e.prev=12,delete this.activePing,e.finish(12);case 15:r=Date.now(),this.rtt=r-n,e.next=21;break;case 19:return e.next=21,this.activePing.promise;case 21:return e.abrupt("return",this.rtt);case 22:case"end":return e.stop()}}),e,this,[[9,,12,15]])})));return function(){return e.apply(this,arguments)}}()},{key:"getRTT",value:function(){return this.rtt}},{key:"close",value:function(e,t){var n;if(!this.closeController.signal.aborted){var r,i;if(t=null!==(n=t)&&void 0!==n?n:void 0===e?Gu.InternalError:Gu.NormalTermination,null!=e)null===(r=this.log)||void 0===r||r.error("muxer close reason=%s error=%s",Gu[t],e);else null===(i=this.log)||void 0===i||i.trace("muxer close reason=%s",Gu[t]);if(void 0===e){var o,a=(0,Ae.Z)(this._streams.values());try{for(a.s();!(o=a.n()).done;){o.value.close()}}catch(e){a.e(e)}finally{a.f()}}else{var s,u=(0,Ae.Z)(this._streams.values());try{for(u.s();!(s=u.n()).done;){s.value.abort(e)}}catch(e){u.e(e)}finally{u.f()}}this.sendGoAway(t),this._closeMuxer()}}},{key:"isClosed",value:function(){return this.closeController.signal.aborted}},{key:"_closeMuxer",value:function(){this.closeController.abort(),this.source.end()}},{key:"_newStream",value:function(e,t,n,r){var i=this;if(null!=this._streams.get(e))throw new ar.s("Stream already exists",Pu,{id:e});var o=new Ju({id:e,name:t,state:n,direction:r,sendFrame:this.sendFrame.bind(this),onStreamEnd:function(){var t;i.closeStream(e),null===(t=i.onStreamEnd)||void 0===t||t.call(i,o)},log:this.log,config:this.config,getRTT:this.getRTT.bind(this)});return o}},{key:"closeStream",value:function(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}},{key:"keepAliveLoop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=new Promise((function(e,t){o.closeController.signal.addEventListener("abort",t,{once:!0})})),null===(t=this.log)||void 0===t||t.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval),r=(0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.race([n,new Promise((function(e){t=setTimeout(e,o.config.keepAliveInterval)}))]);case 3:o.ping().catch((function(e){var t;return null===(t=o.log)||void 0===t?void 0:t.error("ping error: %s",e)})),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(0),clearInterval(t),e.abrupt("return",{v:void 0});case 10:case"end":return e.stop()}}),e,null,[[0,6]])}));case 3:return e.delegateYield(r(),"t0",5);case 5:if("object"!==typeof(i=e.t0)){e.next=8;break}return e.abrupt("return",i.v);case 8:e.next=3;break;case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"handleFrame",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.streamID,o=t.type,a=t.length,null===(r=this.log)||void 0===r||r.trace("received frame %s",Wu(t)),0!==i){e.next=13;break}e.t0=o,e.next=e.t0===_u.Ping?6:e.t0===_u.GoAway?8:10;break;case 6:return this.handlePing(t),e.abrupt("return");case 8:return this.handleGoAway(a),e.abrupt("return");case 10:case 19:throw new ar.s("Invalid frame type",Du,{header:t});case 11:e.next=20;break;case 13:e.t1=t.type,e.next=e.t1===_u.Data||e.t1===_u.WindowUpdate?16:19;break;case 16:return e.next=18,this.handleStreamMessage(t,n);case 18:return e.abrupt("return");case 20:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"handlePing",value:function(e){if(e.flag===Su.SYN){var t;null===(t=this.log)||void 0===t||t.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Su.ACK)}else{if(e.flag!==Su.ACK)throw new ar.s("Invalid frame flag",Du,{header:e});var n;null===(n=this.log)||void 0===n||n.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length)}}},{key:"handlePingResponse",value:function(e){if(void 0===this.activePing)throw new ar.s("ping not requested",Ou);if(this.activePing.id!==e)throw new ar.s("ping doesn't match our id",Ru);this.activePing.resolve()}},{key:"handleGoAway",value:function(e){var t,n;null===(t=this.log)||void 0===t||t.trace("received GoAway reason=%s",null!==(n=Gu[e])&&void 0!==n?n:"unknown"),this.remoteGoAway=e;var r,i=(0,Ae.Z)(this._streams.values());try{for(i.s();!(r=i.n()).done;){r.value.reset()}}catch(o){i.e(o)}finally{i.f()}this._closeMuxer()}},{key:"handleStreamMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.streamID,i=t.flag,o=t.type,(i&Su.SYN)===Su.SYN&&this.incomingStream(r),void 0!==(a=this._streams.get(r))){e.next=14;break}if(o!==_u.Data){e.next=12;break}if(null===(u=this.log)||void 0===u||u.call(this,"discarding data for stream id=%s",r),void 0!==n){e.next=8;break}throw new Error("unreachable");case 8:return e.next=10,n();case 10:e.next=13;break;case 12:null===(c=this.log)||void 0===c||c.call(this,"frame for missing stream id=%s",r);case 13:return e.abrupt("return");case 14:e.t0=o,e.next=e.t0===_u.WindowUpdate?17:e.t0===_u.Data?19:24;break;case 17:return a.handleWindowUpdate(t),e.abrupt("return");case 19:if(void 0!==n){e.next=21;break}throw new Error("unreachable");case 21:return e.next=23,a.handleData(t,n);case 23:return e.abrupt("return");case 24:throw new Error("unreachable");case 25:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"incomingStream",value:function(e){var t,n;if(this.client!==(e%2===0))throw new ar.s("both endpoints are clients",Nu);if(!this._streams.has(e))if(null===(t=this.log)||void 0===t||t.trace("new incoming stream id=%s",e),void 0===this.localGoAway){var r;if(this.numInboundStreams>=this.config.maxInboundStreams)return null===(r=this.log)||void 0===r||r.call(this,"maxIncomingStreams exceeded, forcing stream reset"),void this.sendFrame({type:_u.WindowUpdate,flag:Su.RST,streamID:e,length:0});var i=this._newStream(e,void 0,Yu.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,i),null===(n=this.onIncomingStream)||void 0===n||n.call(this,i)}else this.sendFrame({type:_u.WindowUpdate,flag:Su.RST,streamID:e,length:0})}},{key:"sendFrame",value:function(e,t){var n;if(null===(n=this.log)||void 0===n||n.trace("sending frame %s",Wu(e)),e.type===_u.Data){if(void 0===t)throw new ar.s("invalid frame",Du);this.source.push($u(e)),this.source.push(t)}else this.source.push($u(e))}},{key:"sendPing",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Su.SYN;r===Su.SYN?null===(t=this.log)||void 0===t||t.trace("sending ping request pingId=%s",e):null===(n=this.log)||void 0===n||n.trace("sending ping response pingId=%s",e);this.sendFrame({type:_u.Ping,flag:r,streamID:0,length:e})}},{key:"sendGoAway",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Gu.NormalTermination;null===(e=this.log)||void 0===e||e.call(this,"sending GoAway reason=%s",Gu[t]),this.localGoAway=t,this.sendFrame({type:_u.GoAway,flag:0,streamID:0,length:t})}}]),e}();function rc(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(){return new tc(e)}}function ic(e){var t=new globalThis.AbortController;function n(){t.abort();var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;null!=(null===o||void 0===o?void 0:o.removeEventListener)&&o.removeEventListener("abort",n)}}catch(a){i.e(a)}finally{i.f()}}var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;if(!0===(null===o||void 0===o?void 0:o.aborted)){n();break}null!=(null===o||void 0===o?void 0:o.addEventListener)&&o.addEventListener("abort",n)}}catch(s){i.e(s)}finally{i.f()}var a=t.signal;return a.clear=function(){var t,r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;null!=(null===i||void 0===i?void 0:i.removeEventListener)&&i.removeEventListener("abort",n)}}catch(s){r.e(s)}finally{r.f()}},a}var oc,ac,sc=function(e){if(null!=e[Symbol.asyncIterator])return(0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,o.next();case 6:if(!(n=!(a=t.sent).done)){t.next=11;break}a.value;case 8:n=!1,t.next=4;break;case 11:t.next=17;break;case 13:t.prev=13,t.t0=t.catch(2),r=!0,i=t.t0;case 17:if(t.prev=17,t.prev=18,!n||null==o.return){t.next=22;break}return t.next=22,o.return();case 22:if(t.prev=22,!r){t.next=25;break}throw i;case 25:return t.finish(22);case 26:return t.finish(17);case 27:case"end":return t.stop()}}),t,null,[[2,13,17,27],[18,,22,26]])})))();var t,n=(0,Ae.Z)(e);try{for(n.s();!(t=n.n()).done;)t.value}catch(r){n.e(r)}finally{n.f()}},uc=n(84374),cc=(0,ru.kg)("libp2p:delegated-content-routing"),lc=3e4;!function(e){e[e.SENDING_QUERY=0]="SENDING_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADDING_PEER=6]="ADDING_PEER",e[e.DIALING_PEER=7]="DIALING_PEER"}(oc||(oc={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(ac||(ac={}));var fc=function(){function e(t){if((0,K.Z)(this,e),(0,ot.Z)(this,"client",void 0),(0,ot.Z)(this,"httpQueue",void 0),(0,ot.Z)(this,"httpQueueRefs",void 0),(0,ot.Z)(this,"started",void 0),(0,ot.Z)(this,"abortController",void 0),null==t)throw new Error("missing ipfs http client");this.client=t,this.started=!1,this.abortController=new AbortController,this.httpQueue=new uc.Z({concurrency:4}),this.httpQueueRefs=new uc.Z({concurrency:2});var n=t.getEndpointConfig(),r=n.protocol,i=n.host,o=n.port;cc("enabled DelegatedContentRouting via ".concat(r,"://").concat(i,":").concat(o))}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){this.started=!0}},{key:"stop",value:function(){this.httpQueue.clear(),this.httpQueueRefs.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}},{key:"findProviders",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,c,l,f,h,p,d,v;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return cc("findProviders starts: %c",e),n.timeout=null!==(i=n.timeout)&&void 0!==i?i:lc,o=ic([t.abortController.signal,n.signal]),a=Ut(),c=Ut(),t.httpQueue.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a.resolve(),e.abrupt("return",c.promise);case 2:case"end":return e.stop()}}),e)})))),r.prev=6,r.next=9,(0,m.Z)(a.promise);case 9:l=!1,f=!1,r.prev=11,p=(0,y.Z)(t.client.dht.findProvs(e,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:o})));case 13:return r.next=15,(0,m.Z)(p.next());case 15:if(!(l=!(d=r.sent).done)){r.next=22;break}if("PROVIDER"!==(v=d.value).name){r.next=19;break}return r.delegateYield((0,at.Z)((0,y.Z)(v.providers.map((function(e){return{id:e.id,protocols:[],multiaddrs:e.multiaddrs}}))),m.Z),"t0",19);case 19:l=!1,r.next=13;break;case 22:r.next=28;break;case 24:r.prev=24,r.t1=r.catch(11),f=!0,h=r.t1;case 28:if(r.prev=28,r.prev=29,!l||null==p.return){r.next=33;break}return r.next=33,(0,m.Z)(p.return());case 33:if(r.prev=33,!f){r.next=36;break}throw h;case 36:return r.finish(33);case 37:return r.finish(28);case 38:r.next=44;break;case 40:throw r.prev=40,r.t2=r.catch(6),cc.error("findProviders errored:",r.t2),r.t2;case 44:return r.prev=44,o.clear(),c.resolve(),cc("findProviders finished: %c",e),r.finish(44);case 49:case"end":return r.stop()}}),r,null,[[6,40,44,49],[11,24,28,38],[29,,33,37]])})))()}},{key:"provide",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=c.length>1&&void 0!==c[1]?c[1]:{},cc("provide starts: %c",t),r.timeout=null!==(n=r.timeout)&&void 0!==n?n:lc,i=ic([this.abortController.signal,r.signal]),o=Ut(),a=Ut(),this.httpQueue.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o.resolve(),e.abrupt("return",a.promise);case 2:case"end":return e.stop()}}),e)})))),e.prev=7,e.next=10,o.promise;case 10:return e.next=12,this.client.block.stat(t,(0,Nt.Z)((0,Nt.Z)({},r),{},{signal:i}));case 12:return e.next=14,sc(this.client.dht.provide(t,(0,Nt.Z)((0,Nt.Z)({},r),{},{signal:i})));case 14:e.next=20;break;case 16:throw e.prev=16,e.t0=e.catch(7),cc.error("provide errored:",e.t0),e.t0;case 20:return e.prev=20,i.clear(),a.resolve(),cc("provide finished: %c",t),e.finish(20);case 25:case"end":return e.stop()}}),e,this,[[7,16,20,25]])})));return function(t){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,c,l=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=l.length>2&&void 0!==l[2]?l[2]:{},cc("put value start: %b",t),i.timeout=null!==(r=i.timeout)&&void 0!==r?r:lc,o=ic([this.abortController.signal,i.signal]),a=Ut(),c=Ut(),this.httpQueue.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a.resolve(),e.abrupt("return",c.promise);case 2:case"end":return e.stop()}}),e)})))),e.prev=7,e.next=10,a.promise;case 10:return e.next=12,sc(this.client.dht.put(t,n,(0,Nt.Z)((0,Nt.Z)({},i),{},{signal:o})));case 12:e.next=18;break;case 14:throw e.prev=14,e.t0=e.catch(7),cc.error("put errored:",e.t0),e.t0;case 18:return e.prev=18,o.clear(),c.resolve(),cc("put finished: %b",t),e.finish(18);case 23:case"end":return e.stop()}}),e,this,[[7,14,18,23]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c,l,f,h,p,d,v=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=v.length>1&&void 0!==v[1]?v[1]:{},cc("get value start: %b",t),r.timeout=null!==(n=r.timeout)&&void 0!==n?n:lc,i=ic([this.abortController.signal,r.signal]),o=Ut(),a=Ut(),this.httpQueue.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o.resolve(),e.abrupt("return",a.promise);case 2:case"end":return e.stop()}}),e)})))),e.prev=7,e.next=10,o.promise;case 10:c=!1,l=!1,e.prev=12,h=(0,y.Z)(this.client.dht.get(t,(0,Nt.Z)((0,Nt.Z)({},r),{},{signal:i})));case 14:return e.next=16,h.next();case 16:if(!(c=!(p=e.sent).done)){e.next=24;break}if("VALUE"!==(d=p.value).name){e.next=21;break}return cc("get value finished: %b",t),e.abrupt("return",d.value);case 21:c=!1,e.next=14;break;case 24:e.next=30;break;case 26:e.prev=26,e.t0=e.catch(12),l=!0,f=e.t0;case 30:if(e.prev=30,e.prev=31,!c||null==h.return){e.next=35;break}return e.next=35,h.return();case 35:if(e.prev=35,!l){e.next=38;break}throw f;case 38:return e.finish(35);case 39:return e.finish(30);case 40:throw Mt()(new Error("Not found"),"ERR_NOT_FOUND");case 43:throw e.prev=43,e.t1=e.catch(7),cc.error("put errored:",e.t1),e.t1;case 47:return e.prev=47,i.clear(),a.resolve(),cc("put finished: %b",t),e.finish(47);case 52:case"end":return e.stop()}}),e,this,[[7,43,47,52],[12,26,30,40],[31,,35,39]])})));return function(t){return e.apply(this,arguments)}}()}]),e}();function hc(e){return function(){return new fc(e)}}function pc(e){var t=new globalThis.AbortController;function n(){t.abort();var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;null!=(null===o||void 0===o?void 0:o.removeEventListener)&&o.removeEventListener("abort",n)}}catch(a){i.e(a)}finally{i.f()}}var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;if(!0===(null===o||void 0===o?void 0:o.aborted)){n();break}null!=(null===o||void 0===o?void 0:o.addEventListener)&&o.addEventListener("abort",n)}}catch(s){i.e(s)}finally{i.f()}var a=t.signal;return a.clear=function(){var t,r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;null!=(null===i||void 0===i?void 0:i.removeEventListener)&&i.removeEventListener("abort",n)}}catch(s){r.e(s)}finally{r.f()}},a}var dc,vc,yc=(0,ru.kg)("libp2p:delegated-peer-routing");!function(e){e[e.SENDING_QUERY=0]="SENDING_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADDING_PEER=6]="ADDING_PEER",e[e.DIALING_PEER=7]="DIALING_PEER"}(dc||(dc={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(vc||(vc={}));var gc=function(){function e(t){if((0,K.Z)(this,e),(0,ot.Z)(this,"client",void 0),(0,ot.Z)(this,"httpQueue",void 0),(0,ot.Z)(this,"started",void 0),(0,ot.Z)(this,"abortController",void 0),null==t)throw new Error("missing ipfs http client");this.client=t,this.started=!1,this.abortController=new AbortController,this.httpQueue=new uc.Z({concurrency:4});var n=t.getEndpointConfig(),r=n.protocol,i=n.host,o=n.port;yc("enabled DelegatedPeerRouting via ".concat(r,"://").concat(i,":").concat(o))}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"start",value:function(){this.started=!0}},{key:"stop",value:function(){this.httpQueue.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}},{key:"findPeer",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c,l,f,h,p,d,v,g=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=g.length>1&&void 0!==g[1]?g[1]:{},yc("findPeer starts: %p",t),r.timeout=null!==(n=r.timeout)&&void 0!==n?n:3e4,i=pc([this.abortController.signal,r.signal]),o=Ut(),a=Ut(),this.httpQueue.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o.resolve(),e.abrupt("return",a.promise);case 2:case"end":return e.stop()}}),e)})))),e.prev=7,e.next=10,o.promise;case 10:c=!1,l=!1,e.prev=12,h=(0,y.Z)(this.client.dht.findPeer(t,(0,Nt.Z)((0,Nt.Z)({},r),{},{signal:i})));case 14:return e.next=16,h.next();case 16:if(!(c=!(p=e.sent).done)){e.next=24;break}if(!("FINAL_PEER"===(d=p.value).name&&d.peer.multiaddrs.length>0)){e.next=21;break}return v={id:d.peer.id,multiaddrs:d.peer.multiaddrs,protocols:[]},e.abrupt("return",v);case 21:c=!1,e.next=14;break;case 24:e.next=30;break;case 26:e.prev=26,e.t0=e.catch(12),l=!0,f=e.t0;case 30:if(e.prev=30,e.prev=31,!c||null==h.return){e.next=35;break}return e.next=35,h.return();case 35:if(e.prev=35,!l){e.next=38;break}throw f;case 38:return e.finish(35);case 39:return e.finish(30);case 40:throw new ar.s("Not found","ERR_NOT_FOUND");case 43:throw e.prev=43,e.t1=e.catch(7),yc.error("findPeer errored: %o",e.t1),e.t1;case 47:return e.prev=47,i.clear(),a.resolve(),yc("findPeer finished: %p",t),e.finish(47);case 52:case"end":return e.stop()}}),e,this,[[7,43,47,52],[12,26,30,40],[31,,35,39]])})));return function(t){return e.apply(this,arguments)}}()},{key:"getClosestPeers",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,l,f,h,p,d,v,g,b,w;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=c.CID.asCID(e),o=null!=a?a:(0,Ps.cv)(e),yc("getClosestPeers starts: %s",o),n.timeout=null!==(i=n.timeout)&&void 0!==i?i:3e4,l=pc([t.abortController.signal,n.signal]),f=Ut(),h=Ut(),t.httpQueue.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return f.resolve(),e.abrupt("return",h.promise);case 2:case"end":return e.stop()}}),e)})))),r.prev=8,r.next=11,(0,m.Z)(f.promise);case 11:p=!1,d=!1,r.prev=13,g=(0,y.Z)(t.client.dht.query(o,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:l})));case 15:return r.next=17,(0,m.Z)(g.next());case 17:if(!(p=!(b=r.sent).done)){r.next=24;break}if("PEER_RESPONSE"!==(w=b.value).name){r.next=21;break}return r.delegateYield((0,at.Z)((0,y.Z)(w.closer.map((function(e){return{id:e.id,multiaddrs:e.multiaddrs,protocols:[]}}))),m.Z),"t0",21);case 21:p=!1,r.next=15;break;case 24:r.next=30;break;case 26:r.prev=26,r.t1=r.catch(13),d=!0,v=r.t1;case 30:if(r.prev=30,r.prev=31,!p||null==g.return){r.next=35;break}return r.next=35,(0,m.Z)(g.return());case 35:if(r.prev=35,!d){r.next=38;break}throw v;case 38:return r.finish(35);case 39:return r.finish(30);case 40:r.next=46;break;case 42:throw r.prev=42,r.t2=r.catch(8),yc.error("getClosestPeers errored:",r.t2),r.t2;case 46:return r.prev=46,l.clear(),h.resolve(),yc("getClosestPeers finished: %b",e),r.finish(46);case 51:case"end":return r.stop()}}),r,null,[[8,42,46,51],[13,26,30,40],[31,,35,39]])})))()}}]),e}();function mc(e){return function(){return new gc(e)}}function bc(e){var t=new globalThis.AbortController;function n(){t.abort();var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;null!=(null===o||void 0===o?void 0:o.removeEventListener)&&o.removeEventListener("abort",n)}}catch(a){i.e(a)}finally{i.f()}}var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;if(!0===(null===o||void 0===o?void 0:o.aborted)){n();break}null!=(null===o||void 0===o?void 0:o.addEventListener)&&o.addEventListener("abort",n)}}catch(s){i.e(s)}finally{i.f()}var a=t.signal;return a.clear=function(){var t,r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;null!=(null===i||void 0===i?void 0:i.removeEventListener)&&i.removeEventListener("abort",n)}}catch(s){r.e(s)}finally{r.f()}},a}var wc=function(){function e(t){if((0,K.Z)(this,e),!(t>0)||0!==(t-1&t))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}return(0,W.Z)(e,[{key:"push",value:function(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}},{key:"shift",value:function(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}},{key:"isEmpty",value:function(){return void 0===this.buffer[this.btm]}}]),e}(),kc=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.hwm=null!==(t=n.splitLimit)&&void 0!==t?t:16,this.head=new wc(this.hwm),this.tail=this.head,this.size=0}return(0,W.Z)(e,[{key:"calculateSize",value:function(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}},{key:"push",value:function(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){var t=this.head;this.head=t.next=new wc(2*this.head.buffer.length),this.head.push(e)}}},{key:"shift",value:function(){var e,t=this.tail.shift();if(void 0===t&&null!=this.tail.next){var n=this.tail.next;this.tail.next=null,this.tail=n,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}},{key:"isEmpty",value:function(){return this.head.isEmpty()}}]),e}();function Ec(e,t){var n,r,i,o,a,c,l=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,f=new kc,h=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(f.isEmpty()){t.next=2;break}return t.abrupt("return",e(f));case 2:if(!c){t.next=4;break}return t.abrupt("return",{done:!0});case 4:return t.next=6,new Promise((function(t,n){a=function(r){a=null,f.push(r);try{t(e(f))}catch(i){n(i)}return o}}));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e){return null!=a?a(e):(f.push(e),o)},d=function(e){var n;if(c)return o;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:e})},v=function(e){return c?o:(c=!0,null!=e?function(e){return f=new kc,null!=a?a({error:e}):(f.push({error:e}),o)}(e):p({done:!0}))};if(r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(r,"next",h),(0,ot.Z)(r,"return",(function(){return f=new kc,v(),{done:!0}})),(0,ot.Z)(r,"throw",(function(e){return v(e),{done:!0}})),(0,ot.Z)(r,"push",d),(0,ot.Z)(r,"end",v),Xt("get",r,"readableLength",(function(){return f.size})),o=r,null==l)return o;var y=o;return i={},(0,ot.Z)(i,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(i,"next",(function(){return y.next()})),(0,ot.Z)(i,"throw",(function(e){return y.throw(e),null!=l&&(l(e),l=void 0),{done:!0}})),(0,ot.Z)(i,"return",(function(){return y.return(),null!=l&&(l(),l=void 0),{done:!0}})),(0,ot.Z)(i,"push",d),(0,ot.Z)(i,"end",(function(e){return y.end(e),null!=l&&(l(e),l=void 0),o})),Xt("get",i,"readableLength",(function(){return y.readableLength})),o=i}var xc=n(57896);function _c(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function Sc(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var Ac,Zc=Sc("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),Tc=Sc("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?_c(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),Cc=(0,Nt.Z)({utf8:Zc,"utf-8":Zc,hex:cr.gh.base16,latin1:Tc,ascii:Tc,binary:Tc},cr.gh);function Ic(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=Cc[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):_c(globalThis.Buffer.from(e,"utf-8"))}function Dc(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=Cc[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}!function(e){e[e.NEW_STREAM=0]="NEW_STREAM",e[e.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",e[e.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",e[e.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",e[e.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",e[e.RESET_RECEIVER=5]="RESET_RECEIVER",e[e.RESET_INITIATOR=6]="RESET_INITIATOR"}(Ac||(Ac={}));var Oc=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),Rc=Object.freeze({NEW_STREAM:Ac.NEW_STREAM,MESSAGE:Ac.MESSAGE_INITIATOR,CLOSE:Ac.CLOSE_INITIATOR,RESET:Ac.RESET_INITIATOR}),Pc=Object.freeze({MESSAGE:Ac.MESSAGE_RECEIVER,CLOSE:Ac.CLOSE_RECEIVER,RESET:Ac.RESET_RECEIVER}),Lc=1<<20,Nc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Lc,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4194304;(0,K.Z)(this,e),(0,ot.Z)(this,"_buffer",void 0),(0,ot.Z)(this,"_headerInfo",void 0),(0,ot.Z)(this,"_maxMessageSize",void 0),(0,ot.Z)(this,"_maxUnprocessedMessageQueueSize",void 0),this._buffer=new vt,this._headerInfo=null,this._maxMessageSize=t,this._maxUnprocessedMessageQueueSize=n}return(0,W.Z)(e,[{key:"write",value:function(e){if(null==e||0===e.length)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});for(var t=[];0!==this._buffer.length;){if(null==this._headerInfo)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(u){if("ERR_MSG_TOO_BIG"===u.code)throw u;break}var n=this._headerInfo,r=n.id,i=n.type,o=n.length,a=n.offset;if(this._buffer.length-a<o)break;var s={id:r,type:i};i!==Ac.NEW_STREAM&&i!==Ac.MESSAGE_INITIATOR&&i!==Ac.MESSAGE_RECEIVER||(s.data=this._buffer.sublist(a,a+o)),t.push(s),this._buffer.consume(a+o),this._headerInfo=null}return t}},{key:"_decodeHeader",value:function(e){var t=Fc(e),n=t.value,r=t.offset,i=Fc(e,r),o=i.value,a=i.offset,s=7&n;if(null==Oc[s])throw new Error("Invalid type received: ".concat(s));if(o>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:n>>3,type:s,offset:r+a,length:o}}}]),e}(),Bc=128,Mc=127;function Fc(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=0,i=0,o=n,a=e.length;do{if(o>=a||i>49)throw n=0,new RangeError("Could not decode varint");t=e.get(o++),r+=i<28?(t&Mc)<<i:(t&Mc)*Math.pow(2,i),i+=7}while(t>=Bc);return{value:r,offset:n=o-n}}var jc=1048576,Uc=function(e,t){t.append(e)};var zc=function(e,t){return null!=e[Symbol.asyncIterator]?(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,c,l,f,h,p,d;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=new vt,c=!1,l=Ut(),f=Number(null!==(r=null===t||void 0===t?void 0:t.size)&&void 0!==r?r:jc),(isNaN(f)||0===f||f<0)&&(f=jc),f===Math.round(f)){n.next=7;break}throw new Error("Batch size must be an integer");case 7:h=null!==(i=null===t||void 0===t?void 0:t.yieldAfter)&&void 0!==i?i:0,p=null!==(o=null===t||void 0===t?void 0:t.serialize)&&void 0!==o?o:Uc,Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,d,v;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.prev=0,r=!1,i=!1,t.prev=3,u=(0,y.Z)(e);case 5:return t.next=7,u.next();case 7:if(!(r=!(d=t.sent).done)){t.next=18;break}if(v=d.value,p(v,a),!(a.byteLength>=f)){t.next=14;break}return clearTimeout(n),l.resolve(),t.abrupt("continue",15);case 14:n=setTimeout((function(){l.resolve()}),h);case 15:r=!1,t.next=5;break;case 18:t.next=24;break;case 20:t.prev=20,t.t0=t.catch(3),i=!0,o=t.t0;case 24:if(t.prev=24,t.prev=25,!r||null==u.return){t.next=29;break}return t.next=29,u.return();case 29:if(t.prev=29,!i){t.next=32;break}throw o;case 32:return t.finish(29);case 33:return t.finish(24);case 34:clearTimeout(n),l.resolve(),t.next=41;break;case 38:t.prev=38,t.t1=t.catch(0),l.reject(t.t1);case 41:return t.prev=41,c=!0,t.finish(41);case 44:case"end":return t.stop()}}),t,null,[[0,38,41,44],[3,20,24,34],[25,,29,33]])}))));case 10:if(c){n.next=21;break}return n.next=13,(0,m.Z)(l.promise);case 13:if(l=Ut(),!(a.byteLength>0)){n.next=19;break}return d=a,a=new vt,n.next=19,d.subarray();case 19:n.next=10;break;case 21:case"end":return n.stop()}}),n)})))():(0,s.Z)().mark((function n(){var r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(o=new vt,a=Number(null!==(r=null===t||void 0===t?void 0:t.size)&&void 0!==r?r:jc),(isNaN(a)||0===a||a<0)&&(a=jc),a===Math.round(a)){n.next=5;break}throw new Error("Batch size must be an integer");case 5:u=null!==(i=null===t||void 0===t?void 0:t.serialize)&&void 0!==i?i:Uc,c=(0,Ae.Z)(e),n.prev=7,c.s();case 9:if((l=c.n()).done){n.next=18;break}if(f=l.value,u(f,o),!(o.byteLength>=a)){n.next=16;break}return n.next=15,o.subarray(0,a);case 15:o.consume(a);case 16:n.next=9;break;case 18:n.next=23;break;case 20:n.prev=20,n.t0=n.catch(7),c.e(n.t0);case 23:return n.prev=23,c.f(),n.finish(23);case 26:if(!(o.byteLength>0)){n.next=29;break}return n.next=29,o.subarray();case 29:case"end":return n.stop()}}),n,null,[[7,20,23,26]])}))()};function Hc(e){return new Uint8Array(e)}var Vc=10240,Gc=new(function(){function e(){(0,K.Z)(this,e),(0,ot.Z)(this,"_pool",void 0),(0,ot.Z)(this,"_poolOffset",void 0),this._pool=Hc(Vc),this._poolOffset=0}return(0,W.Z)(e,[{key:"write",value:function(e,t){var n,r,i=this._pool,o=this._poolOffset;A().encode(e.id<<3|e.type,i,o),o+=null!==(n=A().encode.bytes)&&void 0!==n?n:0,e.type!==Ac.NEW_STREAM&&e.type!==Ac.MESSAGE_INITIATOR&&e.type!==Ac.MESSAGE_RECEIVER||null==e.data?A().encode(0,i,o):A().encode(e.data.length,i,o),o+=null!==(r=A().encode.bytes)&&void 0!==r?r:0;var a=i.subarray(this._poolOffset,o);Vc-o<100?(this._pool=Hc(Vc),this._poolOffset=0):this._poolOffset=o,t.append(a),e.type!==Ac.NEW_STREAM&&e.type!==Ac.MESSAGE_INITIATOR&&e.type!==Ac.MESSAGE_RECEIVER||null==e.data||t.append(e.data)}}]),e}());function Kc(){return Kc=(0,g.Z)((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(0,s.Z)().mark((function n(){var r,i,o,a,u,c,l,f,h,p;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(null!=t&&0!==t){n.next=34;break}r=!1,i=!1,n.prev=3,a=(0,y.Z)(e);case 5:return n.next=7,(0,m.Z)(a.next());case 7:if(!(r=!(u=n.sent).done)){n.next=17;break}c=u.value,l=new vt,f=(0,Ae.Z)(c);try{for(f.s();!(h=f.n()).done;)p=h.value,Gc.write(p,l)}catch(s){f.e(s)}finally{f.f()}return n.next=14,l.subarray();case 14:r=!1,n.next=5;break;case 17:n.next=23;break;case 19:n.prev=19,n.t0=n.catch(3),i=!0,o=n.t0;case 23:if(n.prev=23,n.prev=24,!r||null==a.return){n.next=28;break}return n.next=28,(0,m.Z)(a.return());case 28:if(n.prev=28,!i){n.next=31;break}throw o;case 31:return n.finish(28);case 32:return n.finish(23);case 33:return n.abrupt("return");case 34:return n.delegateYield((0,at.Z)((0,y.Z)(zc(e,{size:t,serialize:function(e,t){var n,r=(0,Ae.Z)(e);try{for(r.s();!(n=r.n()).done;){var i=n.value;Gc.write(i,t)}}catch(s){r.e(s)}finally{r.f()}}})),m.Z),"t1",35);case 35:case"end":return n.stop()}}),n,null,[[3,19,23,33],[24,,28,32]])}))()})),Kc.apply(this,arguments)}function Wc(e){var t=new globalThis.AbortController;function n(){t.abort();var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;null!=(null===o||void 0===o?void 0:o.removeEventListener)&&o.removeEventListener("abort",n)}}catch(a){i.e(a)}finally{i.f()}}var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;if(!0===(null===o||void 0===o?void 0:o.aborted)){n();break}null!=(null===o||void 0===o?void 0:o.addEventListener)&&o.addEventListener("abort",n)}}catch(s){i.e(s)}finally{i.f()}var a=t.signal;return a.clear=function(){var t,r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;null!=(null===i||void 0===i?void 0:i.removeEventListener)&&i.removeEventListener("abort",n)}}catch(s){r.e(s)}finally{r.f()}},a}var qc=function(){function e(t){if((0,K.Z)(this,e),!(t>0)||0!==(t-1&t))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}return(0,W.Z)(e,[{key:"push",value:function(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}},{key:"shift",value:function(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}},{key:"isEmpty",value:function(){return void 0===this.buffer[this.btm]}}]),e}(),Yc=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.hwm=null!==(t=n.splitLimit)&&void 0!==t?t:16,this.head=new qc(this.hwm),this.tail=this.head,this.size=0}return(0,W.Z)(e,[{key:"calculateSize",value:function(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}},{key:"push",value:function(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){var t=this.head;this.head=t.next=new qc(2*this.head.buffer.length),this.head.push(e)}}},{key:"shift",value:function(){var e,t=this.tail.shift();if(void 0===t&&null!=this.tail.next){var n=this.tail.next;this.tail.next=null,this.tail=n,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}},{key:"isEmpty",value:function(){return this.head.isEmpty()}}]),e}();function Qc(e,t){var n,r,i,o,a,c,l=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,f=new Yc,h=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(f.isEmpty()){t.next=2;break}return t.abrupt("return",e(f));case 2:if(!c){t.next=4;break}return t.abrupt("return",{done:!0});case 4:return t.next=6,new Promise((function(t,n){a=function(r){a=null,f.push(r);try{t(e(f))}catch(i){n(i)}return o}}));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e){return null!=a?a(e):(f.push(e),o)},d=function(e){var n;if(c)return o;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:e})},v=function(e){return c?o:(c=!0,null!=e?function(e){return f=new Yc,null!=a?a({error:e}):(f.push({error:e}),o)}(e):p({done:!0}))};if(r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(r,"next",h),(0,ot.Z)(r,"return",(function(){return f=new Yc,v(),{done:!0}})),(0,ot.Z)(r,"throw",(function(e){return v(e),{done:!0}})),(0,ot.Z)(r,"push",d),(0,ot.Z)(r,"end",v),Xt("get",r,"readableLength",(function(){return f.size})),o=r,null==l)return o;var y=o;return i={},(0,ot.Z)(i,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(i,"next",(function(){return y.next()})),(0,ot.Z)(i,"throw",(function(e){return y.throw(e),null!=l&&(l(e),l=void 0),{done:!0}})),(0,ot.Z)(i,"return",(function(){return y.return(),null!=l&&(l(),l=void 0),{done:!0}})),(0,ot.Z)(i,"push",d),(0,ot.Z)(i,"end",(function(e){return y.end(e),null!=l&&(l(e),l=void 0),o})),Xt("get",i,"readableLength",(function(){return y.readableLength})),o=i}var Xc=(0,ru.kg)("libp2p:stream"),$c="ERR_STREAM_RESET";function Jc(e){return null!=e&&"function"===typeof e.then}var el=function(){function e(t){var n,r=this;(0,K.Z)(this,e),(0,ot.Z)(this,"id",void 0),(0,ot.Z)(this,"stat",void 0),(0,ot.Z)(this,"metadata",void 0),(0,ot.Z)(this,"source",void 0),(0,ot.Z)(this,"abortController",void 0),(0,ot.Z)(this,"resetController",void 0),(0,ot.Z)(this,"closeController",void 0),(0,ot.Z)(this,"sourceEnded",void 0),(0,ot.Z)(this,"sinkEnded",void 0),(0,ot.Z)(this,"sinkSunk",void 0),(0,ot.Z)(this,"endErr",void 0),(0,ot.Z)(this,"streamSource",void 0),(0,ot.Z)(this,"onEnd",void 0),(0,ot.Z)(this,"maxDataSize",void 0),this.abortController=new AbortController,this.resetController=new AbortController,this.closeController=new AbortController,this.sourceEnded=!1,this.sinkEnded=!1,this.sinkSunk=!1,this.id=t.id,this.metadata=null!==(n=t.metadata)&&void 0!==n?n:{},this.stat={direction:t.direction,timeline:{open:Date.now()}},this.maxDataSize=t.maxDataSize,this.onEnd=t.onEnd,this.source=this.streamSource=function(){return Qc((function(e){var t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}({onEnd:function(){if(null!==r.stat.timeline.reset){var e=r.sendCloseRead();Jc(e)&&e.catch((function(e){Xc.error("error while sending close read",e)}))}r.onSourceEnd()}}),this.sink=this.sink.bind(this)}return(0,W.Z)(e,[{key:"onSourceEnd",value:function(e){this.sourceEnded||(this.stat.timeline.closeRead=Date.now(),this.sourceEnded=!0,Xc.trace("%s stream %s source end - err: %o",this.stat.direction,this.id,e),null!=e&&null==this.endErr&&(this.endErr=e),this.sinkEnded&&(this.stat.timeline.close=Date.now(),null!=this.onEnd&&this.onEnd(this.endErr)))}},{key:"onSinkEnd",value:function(e){this.sinkEnded||(this.stat.timeline.closeWrite=Date.now(),this.sinkEnded=!0,Xc.trace("%s stream %s sink end - err: %o",this.stat.direction,this.id,e),null!=e&&null==this.endErr&&(this.endErr=e),this.sourceEnded&&(this.stat.timeline.close=Date.now(),null!=this.onEnd&&this.onEnd(this.endErr)))}},{key:"close",value:function(){Xc.trace("%s stream %s close",this.stat.direction,this.id),this.closeRead(),this.closeWrite()}},{key:"closeRead",value:function(){Xc.trace("%s stream %s closeRead",this.stat.direction,this.id),this.sourceEnded||this.streamSource.end()}},{key:"closeWrite",value:function(){if(Xc.trace("%s stream %s closeWrite",this.stat.direction,this.id),!this.sinkEnded){this.closeController.abort();try{var e=this.sendCloseWrite();Jc(e)&&e.catch((function(e){Xc.error("error while sending close write",e)}))}catch(t){Xc.trace("%s stream %s error sending close",this.stat.direction,this.id,t)}this.onSinkEnd()}}},{key:"abort",value:function(e){Xc.trace("%s stream %s abort",this.stat.direction,this.id,e),this.streamSource.end(e),this.abortController.abort(),this.onSinkEnd(e)}},{key:"reset",value:function(){var e=new ar.s("stream reset",$c);this.resetController.abort(),this.streamSource.end(e),this.onSinkEnd(e)}},{key:"sink",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p,d;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.sinkSunk){e.next=2;break}throw new ar.s("sink already called on stream","ERR_DOUBLE_SINK");case 2:if(this.sinkSunk=!0,!this.sinkEnded){e.next=5;break}throw new ar.s("stream closed for writing","ERR_SINK_ENDED");case 5:if(n=Wc([this.abortController.signal,this.resetController.signal,this.closeController.signal]),e.prev=6,t=du(t,n),"outbound"!==this.stat.direction){e.next=13;break}if(!Jc(r=this.sendNewStream())){e.next=13;break}return e.next=13,r;case 13:i=!1,o=!1,e.prev=15,u=(0,y.Z)(t);case 17:return e.next=19,u.next();case 19:if(!(i=!(c=e.sent).done)){e.next=39;break}l=c.value;case 21:if(!(l.length>0)){e.next=36;break}if(!(l.length<=this.maxDataSize)){e.next=28;break}if(!Jc(f=this.sendData(l instanceof Uint8Array?new vt(l):l))){e.next=27;break}return e.next=27,f;case 27:return e.abrupt("break",36);case 28:if(l=l instanceof Uint8Array?new vt(l):l,!Jc(h=this.sendData(l.sublist(0,this.maxDataSize)))){e.next=33;break}return e.next=33,h;case 33:l.consume(this.maxDataSize),e.next=21;break;case 36:i=!1,e.next=17;break;case 39:e.next=45;break;case 41:e.prev=41,e.t0=e.catch(15),o=!0,a=e.t0;case 45:if(e.prev=45,e.prev=46,!i||null==u.return){e.next=50;break}return e.next=50,u.return();case 50:if(e.prev=50,!o){e.next=53;break}throw a;case 53:return e.finish(50);case 54:return e.finish(45);case 55:e.next=83;break;case 57:if(e.prev=57,e.t1=e.catch(6),"aborted"!==e.t1.type||"The operation was aborted"!==e.t1.message){e.next=64;break}if(!this.closeController.signal.aborted){e.next=62;break}return e.abrupt("return");case 62:this.resetController.signal.aborted&&(e.t1.message="stream reset",e.t1.code=$c),this.abortController.signal.aborted&&(e.t1.message="stream aborted",e.t1.code="ERR_STREAM_ABORT");case 64:if(e.t1.code!==$c){e.next=68;break}Xc.trace("%s stream %s reset",this.stat.direction,this.id),e.next=80;break;case 68:if(Xc.trace("%s stream %s error",this.stat.direction,this.id,e.t1),e.prev=69,!Jc(p=this.sendReset())){e.next=74;break}return e.next=74,p;case 74:this.stat.timeline.reset=Date.now(),e.next=80;break;case 77:e.prev=77,e.t2=e.catch(69),Xc.trace("%s stream %s error sending reset",this.stat.direction,this.id,e.t2);case 80:throw this.streamSource.end(e.t1),this.onSinkEnd(e.t1),e.t1;case 83:return e.prev=83,n.clear(),e.finish(83);case 86:if(e.prev=86,!Jc(d=this.sendCloseWrite())){e.next=91;break}return e.next=91,d;case 91:e.next=96;break;case 93:e.prev=93,e.t3=e.catch(86),Xc.trace("%s stream %s error sending close",this.stat.direction,this.id,e.t3);case 96:this.onSinkEnd();case 97:case"end":return e.stop()}}),e,this,[[6,57,83,86],[15,41,45,55],[46,,50,54],[69,77],[86,93]])})));return function(t){return e.apply(this,arguments)}}()},{key:"sourcePush",value:function(e){this.streamSource.push(e)}},{key:"sourceReadableLength",value:function(){return this.streamSource.readableLength}}]),e}(),tl=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),r=t.call(this,e),(0,ot.Z)((0,nr.Z)(r),"name",void 0),(0,ot.Z)((0,nr.Z)(r),"streamId",void 0),(0,ot.Z)((0,nr.Z)(r),"send",void 0),(0,ot.Z)((0,nr.Z)(r),"types",void 0),r.types="outbound"===e.direction?Rc:Pc,r.send=e.send,r.name=e.name,r.streamId=e.streamId,r}return(0,W.Z)(n,[{key:"sendNewStream",value:function(){this.send({id:this.streamId,type:Rc.NEW_STREAM,data:new vt(Ic(this.name))})}},{key:"sendData",value:function(e){this.send({id:this.streamId,type:this.types.MESSAGE,data:e})}},{key:"sendReset",value:function(){this.send({id:this.streamId,type:this.types.RESET})}},{key:"sendCloseWrite",value:function(){this.send({id:this.streamId,type:this.types.CLOSE})}},{key:"sendCloseRead",value:function(){}}]),n}(el);var nl=(0,ru.kg)("libp2p:mplex");function rl(e){var t=(0,Nt.Z)((0,Nt.Z)({},e),{},{type:"".concat(Oc[e.type]," (").concat(e.type,")")});return e.type===Ac.NEW_STREAM&&(t.data=Dc(e.data instanceof Uint8Array?e.data:e.data.subarray())),e.type!==Ac.MESSAGE_INITIATOR&&e.type!==Ac.MESSAGE_RECEIVER||(t.data=Dc(e.data instanceof Uint8Array?e.data:e.data.subarray(),"base16")),t}var il=function(){function e(t){var n,r;(0,K.Z)(this,e),(0,ot.Z)(this,"protocol","/mplex/6.7.0"),(0,ot.Z)(this,"sink",void 0),(0,ot.Z)(this,"source",void 0),(0,ot.Z)(this,"_streamId",void 0),(0,ot.Z)(this,"_streams",void 0),(0,ot.Z)(this,"_init",void 0),(0,ot.Z)(this,"_source",void 0),(0,ot.Z)(this,"closeController",void 0),(0,ot.Z)(this,"rateLimiter",void 0),t=null!==(n=t)&&void 0!==n?n:{},this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.sink=this._createSink();var i=this._createSource();this._source=i,this.source=i,this.closeController=new AbortController,this.rateLimiter=new xc.RateLimiterMemory({points:null!==(r=t.disconnectThreshold)&&void 0!==r?r:5,duration:1})}return(0,W.Z)(e,[{key:"streams",get:function(){var e,t=[],n=(0,Ae.Z)(this._streams.initiators.values());try{for(n.s();!(e=n.n()).done;){var r=e.value;t.push(r)}}catch(s){n.e(s)}finally{n.f()}var i,o=(0,Ae.Z)(this._streams.receivers.values());try{for(o.s();!(i=o.n()).done;){var a=i.value;t.push(a)}}catch(s){o.e(s)}finally{o.f()}return t}},{key:"newStream",value:function(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");var t=this._streamId++;e=null==e?t.toString():e.toString();var n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}},{key:"close",value:function(e){this.closeController.signal.aborted||(null!=e?this.streams.forEach((function(t){t.abort(e)})):this.streams.forEach((function(e){e.close()})),this.closeController.abort())}},{key:"_newReceiverStream",value:function(e){var t=e.id,n=e.name,r=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:r})}},{key:"_newStream",value:function(e){var t,n=this,r=e.id,i=e.name,o=e.type,a=e.registry;if(nl("new %s stream %s",o,r),"initiator"===o&&this._streams.initiators.size===(null!==(t=this._init.maxOutboundStreams)&&void 0!==t?t:1024))throw new ar.s("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(a.has(r))throw new Error("".concat(o," stream ").concat(r," already exists!"));var s=function(e){var t=e.id,n=e.name,r=e.send,i=e.onEnd,o=e.type,a=void 0===o?"initiator":o,s=e.maxMsgSize,u=void 0===s?Lc:s;return new tl({id:"initiator"===a?"i".concat(t):"r".concat(t),streamId:t,name:"".concat(null==n?t:n),direction:"initiator"===a?"outbound":"inbound",maxDataSize:u,onEnd:i,send:r})}({id:r,name:i,send:function(e){nl.enabled&&nl.trace("%s stream %s send",o,r,rl(e)),n._source.push(e)},type:o,onEnd:function(){nl("%s stream with id %s and protocol %s ended",o,r,s.stat.protocol),a.delete(r),null!=n._init.onStreamEnd&&n._init.onStreamEnd(s)},maxMsgSize:this._init.maxMsgSize});return a.set(r,s),s}},{key:"_createSink",value:function(){var e=this,t=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){var r,i,o,a,u,c,l,f,h,p,d;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=bc([e.closeController.signal,e._init.signal]),t.prev=1,n=du(n,r),i=new Nc(e._init.maxMsgSize,e._init.maxUnprocessedMessageQueueSize),o=!1,a=!1,t.prev=6,c=(0,y.Z)(n);case 8:return t.next=10,c.next();case 10:if(!(o=!(l=t.sent).done)){t.next=32;break}f=l.value,h=(0,Ae.Z)(i.write(f)),t.prev=13,h.s();case 15:if((p=h.n()).done){t.next=21;break}return d=p.value,t.next=19,e._handleIncoming(d);case 19:t.next=15;break;case 21:t.next=26;break;case 23:t.prev=23,t.t0=t.catch(13),h.e(t.t0);case 26:return t.prev=26,h.f(),t.finish(26);case 29:o=!1,t.next=8;break;case 32:t.next=38;break;case 34:t.prev=34,t.t1=t.catch(6),a=!0,u=t.t1;case 38:if(t.prev=38,t.prev=39,!o||null==c.return){t.next=43;break}return t.next=43,c.return();case 43:if(t.prev=43,!a){t.next=46;break}throw u;case 46:return t.finish(43);case 47:return t.finish(38);case 48:e._source.end(),t.next=55;break;case 51:t.prev=51,t.t2=t.catch(1),nl("error in sink",t.t2),e._source.end(t.t2);case 55:return t.prev=55,r.clear(),t.finish(55);case 58:case"end":return t.stop()}}),t,null,[[1,51,55,58],[6,34,38,48],[13,23,26,29],[39,,43,47]])})));return function(e){return t.apply(this,arguments)}}();return t}},{key:"_createSource",value:function(){var e=this,t=function(){return Ec((function(e){for(var t,n=[];!e.isEmpty()&&null!=(t=e.shift());){if(null!=t.error)throw t.error;!1===t.done&&n.push(t.value)}return null==t?{done:!0}:{done:!0===t.done,value:n}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}({objectMode:!0,onEnd:function(t){e.close(t)}});return Object.assign(function(e){return Kc.apply(this,arguments)}(t,this._init.minSendBytes),{push:t.push,end:t.end,return:t.return})}},{key:"_handleIncoming",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.id,i=t.type,nl.enabled&&nl.trace("incoming message",rl(t)),t.type!==Ac.NEW_STREAM){e.next=20;break}if(this._streams.receivers.size!==(null!==(o=this._init.maxInboundStreams)&&void 0!==o?o:1024)){e.next=17;break}return nl("too many inbound streams open"),this._source.push({id:r,type:Ac.RESET_RECEIVER}),e.prev=6,e.next=9,this.rateLimiter.consume("new-stream",1);case 9:e.next=16;break;case 11:return e.prev=11,e.t0=e.catch(6),nl("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this._source.end(new Error("Too many open streams")),e.abrupt("return");case 16:return e.abrupt("return");case 17:return a=this._newReceiverStream({id:r,name:Dc(t.data instanceof Uint8Array?t.data:t.data.subarray())}),null!=this._init.onIncomingStream&&this._init.onIncomingStream(a),e.abrupt("return");case 20:if(u=1===(1&i)?this._streams.initiators:this._streams.receivers,null!=(c=u.get(r))){e.next=25;break}return nl("missing stream %s for message type %s",r,Oc[i]),e.abrupt("return");case 25:l=null!==(n=this._init.maxStreamBufferSize)&&void 0!==n?n:4194304,e.t1=i,e.next=e.t1===Ac.MESSAGE_INITIATOR||e.t1===Ac.MESSAGE_RECEIVER?29:e.t1===Ac.CLOSE_INITIATOR||e.t1===Ac.CLOSE_RECEIVER?36:e.t1===Ac.RESET_INITIATOR||e.t1===Ac.RESET_RECEIVER?38:40;break;case 29:if(!(c.sourceReadableLength()>l)){e.next=34;break}return this._source.push({id:t.id,type:i===Ac.MESSAGE_INITIATOR?Ac.RESET_RECEIVER:Ac.RESET_INITIATOR}),f=new ar.s("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL"),c.abort(f),e.abrupt("return");case 34:return c.sourcePush(t.data),e.abrupt("break",41);case 36:return c.closeRead(),e.abrupt("break",41);case 38:return c.reset(),e.abrupt("break",41);case 40:nl("unknown message type %s",i);case 41:case"end":return e.stop()}}),e,this,[[6,11]])})));return function(t){return e.apply(this,arguments)}}()}]),e}(),ol=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"protocol","/mplex/6.7.0"),(0,ot.Z)(this,"_init",void 0),this._init=t}return(0,W.Z)(e,[{key:"createStreamMuxer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new il((0,Nt.Z)((0,Nt.Z)({},e),this._init))}}]),e}();function al(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(){return new ol(e)}}var sl,ul=Symbol.for("@libp2p/transport");!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(sl||(sl={}));var cl=n(44743),ll=n(89973),fl=n(58271);function hl(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}function pl(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function dl(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?pl(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function vl(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var yl=vl("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),gl=vl("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=dl((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),ml=(0,Nt.Z)({utf8:yl,"utf-8":yl,hex:cr.gh.base16,latin1:gl,ascii:gl,binary:gl},cr.gh);function bl(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=ml[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}function wl(e,t){null==t&&(t=e.reduce((function(e,t){return e+t.length}),0));var n,r=dl(t),i=0,o=(0,Ae.Z)(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;r.set(a,i),i+=a.length}}catch(s){o.e(s)}finally{o.f()}return pl(r)}n(25258);var kl=n(77034);function El(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=ml[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):pl(globalThis.Buffer.from(e,"utf-8"))}var xl=n(54636),_l=xl.C,Sl=xl.aY,Al=function e(t){var n=0;if(t=t.toString().trim(),_l(t)){var r=new Uint8Array(n+4);return t.split(/\./g).forEach((function(e){r[n++]=255&parseInt(e,10)})),r}if(Sl(t)){var i,o=t.split(":",8);for(i=0;i<o.length;i++){var a=void 0;_l(o[i])&&(a=e(o[i]),o[i]=bl(a.slice(0,2),"base16")),null!=a&&++i<8&&o.splice(i,0,bl(a.slice(2,4),"base16"))}if(""===o[0])for(;o.length<8;)o.unshift("0");else if(""===o[o.length-1])for(;o.length<8;)o.push("0");else if(o.length<8){for(i=0;i<o.length&&""!==o[i];i++);var s=[i,1];for(i=9-o.length;i>0;i--)s.push("0");o.splice.apply(o,s)}var u=new Uint8Array(n+16);for(i=0;i<o.length;i++){var c=parseInt(o[i],16);u[n++]=c>>8&255,u[n++]=255&c}return u}throw new Error("invalid ip address")},Zl=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;n=~~n,r=null!==(t=r)&&void 0!==t?t:e.length-n;var i=new DataView(e.buffer);if(4===r){for(var o=[],a=0;a<r;a++)o.push(e[n+a]);return o.join(".")}if(16===r){for(var s=[],u=0;u<r;u+=2)s.push(i.getUint16(n+u).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Tl=-1,Cl={},Il={};function Dl(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}function Ol(e){if("number"===typeof e){if(null!=Il[e])return Il[e];throw new Error("no protocol with code: ".concat(e))}if("string"===typeof e){if(null!=Cl[e])return Cl[e];throw new Error("no protocol with name: ".concat(e))}throw new Error("invalid protocol id type: ".concat(typeof e))}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Tl,"ip6zone"],[43,8,"ipcidr"],[53,Tl,"dns",!0],[54,Tl,"dns4",!0],[55,Tl,"dns6",!0],[56,Tl,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Tl,"unix",!1,!0],[421,Tl,"ipfs"],[421,Tl,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Tl,"garlic64"],[448,0,"tls"],[449,Tl,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Tl,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Tl,"memory"]].forEach((function(e){var t=Dl.apply(void 0,(0,ye.Z)(e));Il[t.code]=t,Cl[t.name]=t}));Ol("ip4"),Ol("ip6"),Ol("ipcidr");function Rl(e,t){switch(Ol(e).code){case 4:case 41:return function(e){var t=Zl(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!xl.h6(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Ul(t);case 6:case 273:case 33:case 132:return Fl(t).toString();case 421:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return bl(n,"base58btc")}(t);case 444:case 445:return zl(t);case 466:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+bl(n,"base64url")}(t);default:return bl(t,"base16")}}function Pl(e,t){switch(Ol(e).code){case 4:case 41:return Bl(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return jl(t);case 6:case 273:case 33:case 132:return Ml(parseInt(t,10));case 421:return function(e){var t;t="Q"===e[0]||"1"===e[0]?b.decode(gr.base58btc.decode("z".concat(e))).bytes:c.CID.parse(e).multihash.bytes;var n=Uint8Array.from(A().encode(t.length));return wl([n,t],n.length+t.length)}(t);case 444:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(16!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion address."));var n=kl.base32.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=Ml(r);return wl([n,i],n.length+i.length)}(t);case 445:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(56!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion3 address."));var n=kl.base32.decode("b".concat(t[0])),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=Ml(r);return wl([n,i],n.length+i.length)}(t);case 466:return function(e){var t=Nl.decode(e),n=Uint8Array.from(A().encode(t.length));return wl([n,t],n.length+t.length)}(t);default:return El(t,"base16")}}var Ll=Object.values(cr.gh).map((function(e){return e.decoder})),Nl=function(){var e=Ll[0].or(Ll[1]);return Ll.slice(2).forEach((function(t){return e=e.or(t)})),e}();function Bl(e){if(!xl.h6(e))throw new Error("invalid ip address");return Al(e)}function Ml(e){var t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function Fl(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function jl(e){var t=El(e),n=Uint8Array.from(A().encode(t.length));return wl([n,t],n.length+t.length)}function Ul(e){var t=A().decode(e);if((e=e.slice(A().decode.bytes)).length!==t)throw new Error("inconsistent lengths");return bl(e)}function zl(e){var t=e.slice(0,e.length-2),n=e.slice(e.length-2),r=bl(t,"base32"),i=Fl(n);return"".concat(r,":").concat(i)}function Hl(e){return e.map((function(e){var t=Jl(e);return null!=e[1]?[t.code,Rl(t.code,e[1])]:[t.code]}))}function Vl(e){return Yl(wl(e.map((function(e){var t=Jl(e),n=Uint8Array.from(A().encode(t.code));return e.length>1&&null!=e[1]&&(n=wl([n,e[1]])),n}))))}function Gl(e,t){return e.size>0?e.size/8:0===e.size?0:A().decode(t)+(null!==(n=A().decode.bytes)&&void 0!==n?n:0);var n}function Kl(e){for(var t=[],n=0;n<e.length;){var r,i=A().decode(e,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0,a=Gl(Ol(i),e.slice(n+o));if(0!==a){var s=e.slice(n+o,n+o+a);if((n+=a+o)>e.length)throw $l("Invalid address Uint8Array: "+bl(e,"base16"));t.push([i,s])}else t.push([i]),n+=o}return t}function Wl(e){return function(e){var t=[];return e.map((function(e){var n=Jl(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),Xl(t.join("/"))}(Hl(Kl(e)))}function ql(e){var t=function(e){var t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(var r=0;r<n.length;r++){var i=n[r],o=Ol(i);if(0!==o.size){if(++r>=n.length)throw $l("invalid address: "+e);if(!0===o.path){t.push([i,Xl(n.slice(r).join("/"))]);break}t.push([i,n[r]])}else t.push([i])}return t}(e=Xl(e));return Vl(t.map((function(e){Array.isArray(e)||(e=[e]);var t=Jl(e);return e.length>1?[t.code,Pl(t.code,e[1])]:[t.code]})))}function Yl(e){var t=Ql(e);if(null!=t)throw t;return Uint8Array.from(e)}function Ql(e){try{Kl(e)}catch(t){return t}}function Xl(e){return"/"+e.trim().split("/").filter((function(e){return e})).join("/")}function $l(e){return new Error("Error parsing address: "+e)}function Jl(e){return Ol(e[0])}var ef=Symbol.for("nodejs.util.inspect.custom"),tf=[Ol("dns").code,Ol("dns4").code,Ol("dns6").code,Ol("dnsaddr").code],nf=new Map,rf=Symbol.for("@multiformats/js-multiaddr/multiaddr");function of(e){return Boolean(null===e||void 0===e?void 0:e[rf])}var af,sf=new WeakMap,uf=new WeakMap,cf=new WeakMap,lf=new WeakMap,ff=function(){function e(t){if((0,K.Z)(this,e),(0,ot.Z)(this,"bytes",void 0),(0,cl.Z)(this,sf,{writable:!0,value:void 0}),(0,cl.Z)(this,uf,{writable:!0,value:void 0}),(0,cl.Z)(this,cf,{writable:!0,value:void 0}),(0,cl.Z)(this,lf,{writable:!0,value:void 0}),(0,ot.Z)(this,rf,!0),null==t&&(t=""),t instanceof Uint8Array)this.bytes=Yl(t);else if("string"===typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error('multiaddr "'.concat(t,'" must start with a "/"'));this.bytes=ql(t)}else{if(!of(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=Yl(t.bytes)}}return(0,W.Z)(e,[{key:"toString",value:function(){return null==(0,fl.Z)(this,sf)&&(0,ll.Z)(this,sf,Wl(this.bytes)),(0,fl.Z)(this,sf)}},{key:"toJSON",value:function(){return this.toString()}},{key:"toOptions",value:function(){var e,t,n,r,i,o="",a=Ol("tcp"),s=Ol("udp"),u=Ol("ip4"),c=Ol("ip6"),l=Ol("dns6"),f=Ol("ip6zone"),h=(0,Ae.Z)(this.stringTuples());try{for(h.s();!(i=h.n()).done;){var p=(0,k.Z)(i.value,2),d=p[0],v=p[1];d===f.code&&(o="%".concat(null!==v&&void 0!==v?v:"")),tf.includes(d)&&(t=a.name,r=443,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===l.code?6:4),d!==a.code&&d!==s.code||(t=Ol(d).name,r=parseInt(null!==v&&void 0!==v?v:"")),d!==u.code&&d!==c.code||(t=Ol(d).name,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===c.code?6:4)}}catch(y){h.e(y)}finally{h.f()}if(null==e||null==t||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:r}}},{key:"protos",value:function(){return this.protoCodes().map((function(e){return Object.assign({},Ol(e))}))}},{key:"protoCodes",value:function(){for(var e=[],t=this.bytes,n=0;n<t.length;){var r,i=A().decode(t,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0;n+=Gl(Ol(i),t.slice(n+o))+o,e.push(i)}return e}},{key:"protoNames",value:function(){return this.protos().map((function(e){return e.name}))}},{key:"tuples",value:function(){return null==(0,fl.Z)(this,uf)&&(0,ll.Z)(this,uf,Kl(this.bytes)),(0,fl.Z)(this,uf)}},{key:"stringTuples",value:function(){return null==(0,fl.Z)(this,cf)&&(0,ll.Z)(this,cf,Hl(this.tuples())),(0,fl.Z)(this,cf)}},{key:"encapsulate",value:function(t){return t=new e(t),new e(this.toString()+t.toString())}},{key:"decapsulate",value:function(t){var n=t.toString(),r=this.toString(),i=r.lastIndexOf(n);if(i<0)throw new Error("Address ".concat(this.toString()," does not contain subaddress: ").concat(t.toString()));return new e(r.slice(0,i))}},{key:"decapsulateCode",value:function(t){for(var n=this.tuples(),r=n.length-1;r>=0;r--)if(n[r][0]===t)return new e(Vl(n.slice(0,r)));return this}},{key:"getPeerId",value:function(){try{var e=this.stringTuples().filter((function(e){return e[0]===Cl.ipfs.code})),t=e.pop();if(null!=(null===t||void 0===t?void 0:t[1])){var n=t[1];return"Q"===n[0]||"1"===n[0]?bl(gr.base58btc.decode("z".concat(n)),"base58btc"):bl(c.CID.parse(n).multihash.bytes,"base58btc")}return null}catch(r){return null}}},{key:"getPath",value:function(){if(void 0===(0,fl.Z)(this,lf))try{(0,ll.Z)(this,lf,this.stringTuples().filter((function(e){return!0===Ol(e[0]).path}))[0][1]),null==(0,fl.Z)(this,lf)&&(0,ll.Z)(this,lf,null)}catch(e){(0,ll.Z)(this,lf,null)}return(0,fl.Z)(this,lf)}},{key:"equals",value:function(e){return hl(this.bytes,e.bytes)}},{key:"resolve",value:function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=(r=this.protos().find((function(e){return e.resolvable})))){t.next=3;break}return t.abrupt("return",[this]);case 3:if(null!=(i=nf.get(r.name))){t.next=6;break}throw new ar.s("no available resolver for ".concat(r.name),"ERR_NO_AVAILABLE_RESOLVER");case 6:return t.next=8,i(this,n);case 8:return o=t.sent,t.abrupt("return",o.map((function(t){return new e(t)})));case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"nodeAddress",value:function(){var e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error('multiaddr must have a valid format - no protocol with name: "'.concat(e.transport,'". Must have a valid transport protocol: "{tcp, udp}"'));return{family:e.family,address:e.host,port:e.port}}},{key:"isThinWaistAddress",value:function(e){var t=(null!==e&&void 0!==e?e:this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}},{key:ef,value:function(){return"Multiaddr(".concat(Wl(this.bytes),")")}}]),e}();function hf(e){return new ff(e)}!function(e){e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",e.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",e.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"}(af||(af={}));var pf=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;return(0,K.Z)(this,n),(i=t.call(this,"WebRTC transport error: ".concat(e),null!==r&&void 0!==r?r:"")).name="WebRTCTransportError",i}return(0,W.Z)(n)}(ar.s);var df=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;return(0,K.Z)(this,n),(i=t.call(this,"[stream: ".concat(e,"] data channel error: ").concat(r),af.ERR_DATA_CHANNEL)).name="WebRTC/DataChannelError",i}return(0,W.Z)(n)}(pf);function vf(e,t){return new df(e,t)}var yf=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this,"There was a problem with the Multiaddr which was passed in: ".concat(e),af.ERR_INVALID_MULTIADDR)).name="WebRTC/InappropriateMultiaddrError",r}return(0,W.Z)(n)}(pf);function gf(e){return new yf(e)}var mf=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this,"There was a problem with a provided argument: ".concat(e),af.ERR_INVALID_PARAMETERS)).name="WebRTC/InvalidArgumentError",r}return(0,W.Z)(n)}(pf);function bf(e){return new mf(e)}var wf=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;return(0,K.Z)(this,n),(i=t.call(this,'Invalid fingerprint "'.concat(e,'" within ').concat(r),af.ERR_INVALID_FINGERPRINT)).name="WebRTC/InvalidFingerprintError",i}return(0,W.Z)(n)}(pf);function kf(e,t){return new wf(e,t)}var Ef=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this,"A method (".concat(e,") was called though it has been intentionally left unimplemented."),af.ERR_NOT_IMPLEMENTED)).name="WebRTC/UnimplementedError",r}return(0,W.Z)(n)}(pf);var xf=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this,"unsupported hash algorithm: ".concat(e),af.ERR_HASH_NOT_SUPPORTED)).name="WebRTC/UnsupportedHashAlgorithmError",r}return(0,W.Z)(n)}(pf);var _f=n(1426),Sf=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},Af=function(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"},Zf=function(e){this.version=e,this.type="node",this.name="node",this.os=_f.platform},Tf=function(e,t,n,r){this.name=e,this.version=t,this.os=n,this.bot=r,this.type="bot-device"},Cf=function(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null},If=function(){this.type="react-native",this.name="react-native",this.version=null,this.os=null},Df=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,Of=3,Rf=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],Pf=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function Lf(e){return""!==e&&Rf.reduce((function(t,n){var r=n[0],i=n[1];if(t)return t;var o=i.exec(e);return!!o&&[r,o]}),!1)}function Nf(e){var t=Lf(e);if(!t)return null;var n=t[0],r=t[1];if("searchbot"===n)return new Cf;var i=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);i?i.length<Of&&(i=Sf(Sf([],i,!0),function(e){for(var t=[],n=0;n<e;n++)t.push("0");return t}(Of-i.length),!0)):i=[];var o=i.join("."),a=function(e){for(var t=0,n=Pf.length;t<n;t++){var r=Pf[t],i=r[0];if(r[1].exec(e))return i}return null}(e),s=Df.exec(e);return s&&s[1]?new Tf(n,o,a,s[1]):new Af(n,o,a)}var Bf,Mf=Bf?Nf(Bf):"undefined"===typeof document&&"undefined"!==typeof navigator&&"ReactNative"===navigator.product?new If:"undefined"!==typeof navigator?Nf(navigator.userAgent):function(){var e="undefined"!==typeof _f&&_f.version;return e?new Zf(_f.version.slice(1)):null}(),Ff=null!=Mf&&"firefox"===Mf.name,jf=function(){var e=(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Uf=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),zf=(0,ru.kg)("libp2p:webrtc:connection"),Hf=function(){function e(t){var n=this;(0,K.Z)(this,e),(0,ot.Z)(this,"peerConnection",void 0),(0,ot.Z)(this,"remoteAddr",void 0),(0,ot.Z)(this,"timeline",void 0),(0,ot.Z)(this,"metrics",void 0),(0,ot.Z)(this,"source",jf()),(0,ot.Z)(this,"sink",Uf),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection,this.peerConnection.onconnectionstatechange=function(){"closed"!==n.peerConnection.connectionState&&"disconnected"!==n.peerConnection.connectionState&&"failed"!==n.peerConnection.connectionState||(n.timeline.close=Date.now())}}return(0,W.Z)(e,[{key:"close",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0!==t&&zf.error("error closing connection",t),zf.trace("closing connection"),this.timeline.close=Date.now(),this.peerConnection.close(),null===(n=this.metrics)||void 0===n||n.increment({close:!0});case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();function Vf(e){return null!=e[Symbol.asyncIterator]}var Gf=function e(t){var n=Ct.encodingLength(t),r=dl(n);return Ct.encode(t,r),e.bytes=n,r};function Kf(e,t){var n,r,i=(0,s.Z)().mark(a),o=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:Gf;function a(e){var t;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!((t=o(e.byteLength))instanceof Uint8Array)){n.next=6;break}return n.next=4,t;case 4:n.next=7;break;case 6:return n.delegateYield(t,"t0",7);case 7:if(!(e instanceof Uint8Array)){n.next=12;break}return n.next=10,e;case 10:n.next=13;break;case 12:return n.delegateYield(e,"t1",13);case 13:case"end":return n.stop()}}),i)}return Vf(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=12;break}return c=u.value,t.delegateYield((0,at.Z)((0,y.Z)(a(c)),m.Z),"t0",9);case 9:n=!1,t.next=4;break;case 12:t.next=18;break;case 14:t.prev=14,t.t1=t.catch(2),r=!0,i=t.t1;case 18:if(t.prev=18,t.prev=19,!n||null==o.return){t.next=23;break}return t.next=23,(0,m.Z)(o.return());case 23:if(t.prev=23,!r){t.next=26;break}throw i;case 26:return t.finish(23);case 27:return t.finish(18);case 28:case"end":return t.stop()}}),t,null,[[2,14,18,28],[19,,23,27]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=8;break}return i=r.value,t.delegateYield(a(i),"t0",6);case 6:t.next=3;break;case 8:t.next=13;break;case 10:t.prev=10,t.t1=t.catch(1),n.e(t.t1);case 13:return t.prev=13,n.f(),t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[1,10,13,16]])}))()}Gf.bytes=0,Kf.single=function(e,t){var n,r,i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:Gf;return new vt(i(e.byteLength),e)};var Wf;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(Wf||(Wf={}));var qf=function e(t){var n=Ct.decode(t);return e.bytes=Ct.encodingLength(n),n};function Yf(e,t){var n,r,i,o=(0,s.Z)().mark(p),a=new vt,u=Wf.LENGTH,c=-1,l=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:qf,f=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,h=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function p(){var e,n;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!(a.byteLength>0)){r.next=32;break}if(u!==Wf.LENGTH){r.next=21;break}if(r.prev=2,!((c=l(a))<0)){r.next=6;break}throw Mt()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");case 6:if(!(c>h)){r.next=8;break}throw Mt()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");case 8:e=l.bytes,a.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(c),u=Wf.DATA,r.next=21;break;case 14:if(r.prev=14,r.t0=r.catch(2),!(r.t0 instanceof RangeError)){r.next=20;break}if(!(a.byteLength>f)){r.next=19;break}throw Mt()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");case 19:return r.abrupt("break",32);case 20:throw r.t0;case 21:if(u!==Wf.DATA){r.next=30;break}if(!(a.byteLength<c)){r.next=24;break}return r.abrupt("break",32);case 24:return n=a.sublist(0,c),a.consume(c),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(n),r.next=29,n;case 29:u=Wf.LENGTH;case 30:r.next=0;break;case 32:case"end":return r.stop()}}),o,null,[[2,14]])}return Vf(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=13;break}return c=u.value,a.append(c),t.delegateYield((0,at.Z)((0,y.Z)(p()),m.Z),"t0",10);case 10:n=!1,t.next=4;break;case 13:t.next=19;break;case 15:t.prev=15,t.t1=t.catch(2),r=!0,i=t.t1;case 19:if(t.prev=19,t.prev=20,!n||null==o.return){t.next=24;break}return t.next=24,(0,m.Z)(o.return());case 24:if(t.prev=24,!r){t.next=27;break}throw i;case 27:return t.finish(24);case 28:return t.finish(19);case 29:if(!(a.byteLength>0)){t.next=31;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 31:case"end":return t.stop()}}),t,null,[[2,15,19,29],[20,,24,28]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=9;break}return i=r.value,a.append(i),t.delegateYield(p(),"t0",7);case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t1=t.catch(1),n.e(t.t1);case 14:return t.prev=14,n.f(),t.finish(14);case 17:if(!(a.byteLength>0)){t.next=19;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 19:case"end":return t.stop()}}),t,null,[[1,11,14,17]])}))()}qf.bytes=0,Yf.fromReader=function(e,t){var n=1;return Yf((0,g.Z)((0,s.Z)().mark((function t(){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=1,t.next=4,(0,m.Z)(e.next(n));case 4:if(r=t.sent,i=r.done,o=r.value,!0!==i){t.next=9;break}return t.abrupt("return");case 9:if(null==o){t.next=12;break}return t.next=12,o;case 12:t.next=19;break;case 14:if(t.prev=14,t.t0=t.catch(1),"ERR_UNDER_READ"!==t.t0.code){t.next=18;break}return t.abrupt("return",{done:!0,value:null});case 18:throw t.t0;case 19:return t.prev=19,n=1,t.finish(19);case 22:t.next=0;break;case 24:case"end":return t.stop()}}),t,null,[[1,14,19,22]])})))(),(0,Nt.Z)((0,Nt.Z)({},null!==t&&void 0!==t?t:{}),{},{onLength:function(e){n=e}}))};var Qf=function(){function e(t){if((0,K.Z)(this,e),!(t>0)||0!==(t-1&t))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}return(0,W.Z)(e,[{key:"push",value:function(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}},{key:"shift",value:function(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}},{key:"isEmpty",value:function(){return void 0===this.buffer[this.btm]}}]),e}(),Xf=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.hwm=null!==(t=n.splitLimit)&&void 0!==t?t:16,this.head=new Qf(this.hwm),this.tail=this.head,this.size=0}return(0,W.Z)(e,[{key:"calculateSize",value:function(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}},{key:"push",value:function(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){var t=this.head;this.head=t.next=new Qf(2*this.head.buffer.length),this.head.push(e)}}},{key:"shift",value:function(){var e,t=this.tail.shift();if(void 0===t&&null!=this.tail.next){var n=this.tail.next;this.tail.next=null,this.tail=n,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}},{key:"isEmpty",value:function(){return this.head.isEmpty()}}]),e}();function $f(){return Jf((function(e){var t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function Jf(e,t){var n,r,i,o,a,c,l=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,f=new Xf,h=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(f.isEmpty()){t.next=2;break}return t.abrupt("return",e(f));case 2:if(!c){t.next=4;break}return t.abrupt("return",{done:!0});case 4:return t.next=6,new Promise((function(t,n){a=function(r){a=null,f.push(r);try{t(e(f))}catch(i){n(i)}return o}}));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e){return null!=a?a(e):(f.push(e),o)},d=function(e){var n;if(c)return o;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:e})},v=function(e){return c?o:(c=!0,null!=e?function(e){return f=new Xf,null!=a?a({error:e}):(f.push({error:e}),o)}(e):p({done:!0}))};if(r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(r,"next",h),(0,ot.Z)(r,"return",(function(){return f=new Xf,v(),{done:!0}})),(0,ot.Z)(r,"throw",(function(e){return v(e),{done:!0}})),(0,ot.Z)(r,"push",d),(0,ot.Z)(r,"end",v),Xt("get",r,"readableLength",(function(){return f.size})),o=r,null==l)return o;var y=o;return i={},(0,ot.Z)(i,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(i,"next",(function(){return y.next()})),(0,ot.Z)(i,"throw",(function(e){return y.throw(e),null!=l&&(l(e),l=void 0),{done:!0}})),(0,ot.Z)(i,"return",(function(){return y.return(),null!=l&&(l(),l=void 0),{done:!0}})),(0,ot.Z)(i,"push",d),(0,ot.Z)(i,"end",(function(e){return y.end(e),null!=l&&(l(e),l=void 0),o})),Xt("get",i,"readableLength",(function(){return y.readableLength})),o=i}var eh=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this,e)).name="TimeoutError",r}return(0,W.Z)(n)}((0,Ze.Z)(Error)),th=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this)).name="AbortError",r.message=e,r}return(0,W.Z)(n)}((0,Ze.Z)(Error)),nh=function(e){return void 0===globalThis.DOMException?new th(e):new DOMException(e)},rh=function(e){var t=void 0===e.reason?nh("This operation was aborted."):e.reason;return t instanceof Error?t:nh(t)};var ih,oh=function(e){var t=e.on||e.addListener||e.addEventListener,n=e.off||e.removeListener||e.removeEventListener;if(!t||!n)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(e),removeListener:n.bind(e)}};function ah(e,t,n){var r,i=new Promise((function(i,o){if(!((n=(0,Nt.Z)({rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1},n)).count>=0)||n.count!==Number.POSITIVE_INFINITY&&!Number.isInteger(n.count))throw new TypeError("The `count` option should be at least 0 or more");var a=[t].flat(),s=[],u=oh(e),c=u.addListener,l=u.removeListener,f=function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];var a=n.multiArgs?t:t[0];n.filter&&!n.filter(a)||(s.push(a),n.count===s.length&&(r(),i(s)))},h=function(e){r(),o(e)};r=function(){var e,t=(0,Ae.Z)(a);try{for(t.s();!(e=t.n()).done;){var r=e.value;l(r,f)}}catch(u){t.e(u)}finally{t.f()}var i,o=(0,Ae.Z)(n.rejectionEvents);try{for(o.s();!(i=o.n()).done;){var s=i.value;l(s,h)}}catch(u){o.e(u)}finally{o.f()}};var p,d=(0,Ae.Z)(a);try{for(d.s();!(p=d.n()).done;){c(p.value,f)}}catch(g){d.e(g)}finally{d.f()}var v,y=(0,Ae.Z)(n.rejectionEvents);try{for(y.s();!(v=y.n()).done;){c(v.value,h)}}catch(g){y.e(g)}finally{y.f()}n.resolveImmediately&&i(s)}));if(i.cancel=r,"number"===typeof n.timeout){var o=function(e,t,n,r){var i,o=new Promise((function(o,a){if("number"!==typeof t||1!==Math.sign(t))throw new TypeError("Expected `milliseconds` to be a positive number, got `".concat(t,"`"));if(t!==Number.POSITIVE_INFINITY){if((r=(0,Nt.Z)({customTimers:{setTimeout:setTimeout,clearTimeout:clearTimeout}},r)).signal){var c=r.signal;c.aborted&&a(rh(c)),c.addEventListener("abort",(function(){a(rh(c))}))}i=r.customTimers.setTimeout.call(void 0,(function(){if("function"!==typeof n){var r="string"===typeof n?n:"Promise timed out after ".concat(t," milliseconds"),i=n instanceof Error?n:new eh(r);"function"===typeof e.cancel&&e.cancel(),a(i)}else try{o(n())}catch(s){a(s)}}),t),(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.t0=o,t.next=4,e;case 4:t.t1=t.sent,(0,t.t0)(t.t1),t.next=11;break;case 8:t.prev=8,t.t2=t.catch(0),a(t.t2);case 11:return t.prev=11,r.customTimers.clearTimeout.call(void 0,i),t.finish(11);case 14:case"end":return t.stop()}}),t,null,[[0,8,11,14]])})))()}else o(e)}));return o.clear=function(){clearTimeout(i),i=void 0},o}(i,n.timeout);return o.cancel=r,o}return i}function sh(e,t,n){"function"===typeof n&&(n={filter:n});var r=ah(e,t,n=(0,Nt.Z)((0,Nt.Z)({},n),{},{count:1,resolveImmediately:!1})),i=r.then((function(e){return e[0]}));return i.cancel=r.cancel,i}!function(e){var t,n;!function(e){e.FIN="FIN",e.STOP_SENDING="STOP_SENDING",e.RESET="RESET"}(e.Flag||(e.Flag={})),function(e){e[e.FIN=0]="FIN",e[e.STOP_SENDING=1]="STOP_SENDING",e[e.RESET=2]="RESET"}(t||(t={})),function(e){e.codec=function(){return co(t)}}(e.Flag||(e.Flag={})),e.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.flag&&(n.uint32(8),e.Flag.codec().encode(t.flag,n)),null!=t.message&&(n.uint32(18),n.bytes(t.message)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.flag=e.Flag.codec().decode(t);break;case 2:r.message=t.bytes();break;default:t.skipType(7&o)}}return r}))),n},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(ih||(ih={}));var uh=(0,ru.kg)("libp2p:webrtc:stream"),ch=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r,i,o,a,c,l,f;switch((0,K.Z)(this,n),f=t.call(this,e),(0,ot.Z)((0,nr.Z)(f),"channel",void 0),(0,ot.Z)((0,nr.Z)(f),"dataChannelOptions",void 0),(0,ot.Z)((0,nr.Z)(f),"incomingData",void 0),(0,ot.Z)((0,nr.Z)(f),"messageQueue",void 0),f.channel=e.channel,f.channel.binaryType="arraybuffer",f.incomingData=$f(),f.messageQueue=new vt,f.dataChannelOptions={bufferedAmountLowEventTimeout:null!==(r=null===(i=e.dataChannelOptions)||void 0===i?void 0:i.bufferedAmountLowEventTimeout)&&void 0!==r?r:3e4,maxBufferedAmount:null!==(o=null===(a=e.dataChannelOptions)||void 0===a?void 0:a.maxBufferedAmount)&&void 0!==o?o:16777216,maxMessageSize:null!==(c=null===(l=e.dataChannelOptions)||void 0===l?void 0:l.maxMessageSize)&&void 0!==c?c:16384},f.channel.readyState){case"open":case"connecting":break;case"closed":case"closing":void 0!==f.stat.timeline.close&&0!==f.stat.timeline.close||(f.stat.timeline.close=Date.now());break;default:throw uh.error("unknown datachannel state %s",f.channel.readyState),new ar.s("Unknown datachannel state","ERR_INVALID_STATE")}f.channel.onopen=function(e){f.stat.timeline.open=(new Date).getTime(),null!=f.messageQueue&&(f._sendMessage(f.messageQueue).catch((function(e){f.abort(e)})),f.messageQueue=void 0)},f.channel.onclose=function(e){f.close()},f.channel.onerror=function(e){var t=e.error;f.abort(t)};var h=(0,nr.Z)(f);return f.channel.onmessage=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(n=t.data)&&0!==n.byteLength){e.next=3;break}return e.abrupt("return");case 3:f.incomingData.push(new Uint8Array(n,0,n.byteLength));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!1,n=!1,e.prev=2,i=(0,y.Z)(Yf(f.incomingData));case 4:return e.next=6,i.next();case 6:if(!(t=!(o=e.sent).done)){e.next=13;break}a=o.value,null!=(u=h.processIncomingProtobuf(a.subarray()))&&h.sourcePush(new vt(u));case 10:t=!1,e.next=4;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(2),n=!0,r=e.t0;case 19:if(e.prev=19,e.prev=20,!t||null==i.return){e.next=24;break}return e.next=24,i.return();case 24:if(e.prev=24,!n){e.next=27;break}throw r;case 27:return e.finish(24);case 28:return e.finish(19);case 29:case"end":return e.stop()}}),e,null,[[2,15,19,29],[20,,24,28]])})))).catch((function(e){uh.error("error processing incoming data channel messages",e)})),f}return(0,W.Z)(n,[{key:"sendNewStream",value:function(){}},{key:"_sendMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((!(o.length>1&&void 0!==o[1])||o[1])&&this.channel.bufferedAmount>this.dataChannelOptions.maxBufferedAmount)){e.next=13;break}return e.prev=2,e.next=5,sh(this.channel,"bufferedamountlow",{timeout:this.dataChannelOptions.bufferedAmountLowEventTimeout});case 5:e.next=13;break;case 7:if(e.prev=7,e.t0=e.catch(2),!(e.t0 instanceof eh)){e.next=12;break}throw this.abort(e.t0),new Error("Timed out waiting for DataChannel buffer to clear");case 12:throw e.t0;case 13:if("closed"!==this.channel.readyState&&"closing"!==this.channel.readyState){e.next=15;break}throw new ar.s("Invalid datachannel state - closed or closing","ERR_INVALID_STATE");case 15:if("open"!==this.channel.readyState){e.next=20;break}n=(0,Ae.Z)(t);try{for(n.s();!(r=n.n()).done;)i=r.value,this.channel.send(i)}catch(a){n.e(a)}finally{n.f()}e.next=27;break;case 20:if("connecting"!==this.channel.readyState){e.next=25;break}null==this.messageQueue&&(this.messageQueue=new vt),this.messageQueue.append(t),e.next=27;break;case 25:throw uh.error("unknown datachannel state %s",this.channel.readyState),new ar.s("Unknown datachannel state","ERR_INVALID_STATE");case 27:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(t){return e.apply(this,arguments)}}()},{key:"sendData",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=ih.encode({message:t.subarray()}),r=Kf.single(n),e.next=4,this._sendMessage(r);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"sendReset",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._sendFlag(ih.Flag.RESET);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"sendCloseWrite",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._sendFlag(ih.Flag.FIN);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"sendCloseRead",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._sendFlag(ih.Flag.STOP_SENDING);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"processIncomingProtobuf",value:function(e){var t=ih.decode(e);return void 0!==t.flag&&(t.flag===ih.Flag.FIN&&(this.incomingData.end(),this.closeRead()),t.flag===ih.Flag.RESET&&this.reset(),t.flag===ih.Flag.STOP_SENDING&&this.closeWrite()),t.message}},{key:"_sendFlag",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return uh.trace("Sending flag: %s",t.toString()),n=ih.encode({flag:t}),r=Kf.single(n),e.next=5,this._sendMessage(r,!1);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),n}(el);function lh(e){var t,n=e.channel,r=e.direction,i=e.onEnd,o=e.dataChannelOptions;return new ch({id:"inbound"===r?"i".concat(n.id):"r".concat(n.id),direction:r,maxDataSize:(null!==(t=null===o||void 0===o?void 0:o.maxMessageSize)&&void 0!==t?t:16384)-3,dataChannelOptions:o,onEnd:i,channel:n})}var fh,hh="/webrtc",ph=function(){function e(t){var n,r=this;(0,K.Z)(this,e),(0,ot.Z)(this,"protocol",void 0),(0,ot.Z)(this,"peerConnection",void 0),(0,ot.Z)(this,"streamBuffer",[]),(0,ot.Z)(this,"metrics",void 0),(0,ot.Z)(this,"dataChannelOptions",void 0),this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=null!==(n=t.protocol)&&void 0!==n?n:hh,this.dataChannelOptions=t.dataChannelOptions,this.peerConnection.ondatachannel=function(e){var n=lh({channel:e.channel,direction:"inbound",dataChannelOptions:t.dataChannelOptions,onEnd:function(){r.streamBuffer=r.streamBuffer.filter((function(e){return e.id!==n.id}))}});r.streamBuffer.push(n)}}return(0,W.Z)(e,[{key:"createStreamMuxer",value:function(e){return new dh((0,Nt.Z)((0,Nt.Z)({},e),{},{peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.streamBuffer,protocol:this.protocol}))}}]),e}(),dh=function(){function e(t){var n,r=this;(0,K.Z)(this,e),(0,ot.Z)(this,"init",void 0),(0,ot.Z)(this,"streams",void 0),(0,ot.Z)(this,"protocol",void 0),(0,ot.Z)(this,"peerConnection",void 0),(0,ot.Z)(this,"dataChannelOptions",void 0),(0,ot.Z)(this,"metrics",void 0),(0,ot.Z)(this,"close",(function(){})),(0,ot.Z)(this,"source",jf()),(0,ot.Z)(this,"sink",Uf),this.init=t,this.streams=t.streams,this.peerConnection=t.peerConnection,this.protocol=null!==(n=t.protocol)&&void 0!==n?n:hh,this.metrics=t.metrics,this.peerConnection.ondatachannel=function(e){var n,i=lh({channel:e.channel,direction:"inbound",dataChannelOptions:r.dataChannelOptions,onEnd:function(){var e,n;r.streams=r.streams.filter((function(e){return e.id!==i.id})),null===(e=r.metrics)||void 0===e||e.increment({stream_end:!0}),null===t||void 0===t||null===(n=t.onStreamEnd)||void 0===n||n.call(t,i)}});(r.streams.push(i),null!=(null===t||void 0===t?void 0:t.onIncomingStream))&&(null===(n=r.metrics)||void 0===n||n.increment({incoming_stream:!0}),t.onIncomingStream(i))};var i=null===t||void 0===t?void 0:t.onIncomingStream;null!=i&&this.streams.forEach((function(e){i(e)}))}return(0,W.Z)(e,[{key:"newStream",value:function(){var e,t=this,n=lh({channel:this.peerConnection.createDataChannel(""),direction:"outbound",dataChannelOptions:this.dataChannelOptions,onEnd:function(){var e,r,i;t.streams=t.streams.filter((function(e){return e.id!==n.id})),null===(e=t.metrics)||void 0===e||e.increment({stream_end:!0}),null===(r=t.init)||void 0===r||null===(i=r.onStreamEnd)||void 0===i||i.call(r,n)}});return this.streams.push(n),null===(e=this.metrics)||void 0===e||e.increment({outgoing_stream:!0}),n}}]),e}();!function(e){var t,n;!function(e){e.SDP_OFFER="SDP_OFFER",e.SDP_ANSWER="SDP_ANSWER",e.ICE_CANDIDATE="ICE_CANDIDATE"}(e.Type||(e.Type={})),function(e){e[e.SDP_OFFER=0]="SDP_OFFER",e[e.SDP_ANSWER=1]="SDP_ANSWER",e[e.ICE_CANDIDATE=2]="ICE_CANDIDATE"}(t||(t={})),function(e){e.codec=function(){return co(t)}}(e.Type||(e.Type={})),e.codec=function(){return null==n&&(n=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.data&&(n.uint32(18),n.string(t.data)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.data=t.string();break;default:t.skipType(7&o)}}return r}))),n},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(fh||(fh={}));var vh=(0,ru.kg)("libp2p:webrtc:peer:util"),yh=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,Promise.race([t.promise,r.read()]);case 3:if(!((i=e.sent)instanceof Object)){e.next=23;break}if((o=i).type===fh.Type.ICE_CANDIDATE){e.next=8;break}throw new Error("expected only ice candidates");case 8:if(null!=o.data&&""!==o.data){e.next=11;break}return vh.trace("end-of-candidates received"),e.abrupt("break",26);case 11:return vh.trace("received new ICE candidate: %s",o.data),e.prev=12,e.next=15,n.addIceCandidate(new RTCIceCandidate(JSON.parse(o.data)));case 15:e.next=21;break;case 17:throw e.prev=17,e.t0=e.catch(12),vh.error("bad candidate received: ",e.t0),new Error("bad candidate received");case 21:e.next=24;break;case 23:return e.abrupt("break",26);case 24:e.next=0;break;case 26:return e.next=28,t.promise;case 28:case"end":return e.stop()}}),e,null,[[12,17]])})));return function(t,n,r){return e.apply(this,arguments)}}();function gh(e,t){e[Ff?"oniceconnectionstatechange":"onconnectionstatechange"]=function(n){switch(vh.trace("receiver peerConnectionState state: ",e.connectionState),Ff?e.iceConnectionState:e.connectionState){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new Error("RTCPeerConnection was closed"))}}}var mh=3e4,bh=(0,ru.kg)("libp2p:webrtc:peer");function wh(e){return kh.apply(this,arguments)}function kh(){return(kh=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p,d,v,y,g,m;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.rtcConfiguration,o=t.dataChannelOptions,a=t.stream,u=AbortSignal.timeout(mh),c=nn(yu(a,u)).pb(fh),l=new RTCPeerConnection(i),f=new ph({peerConnection:l,dataChannelOptions:o}),h=Ut(),p=Ut(),u.onabort=function(){h.reject()},l.onicecandidate=function(e){var t=e.candidate;p.promise.then((function(){c.write({type:fh.Type.ICE_CANDIDATE,data:null!=t?JSON.stringify(t.toJSON()):""})}),(function(e){bh.error("cannot set candidate since sending answer failed",e)}))},gh(l,h),e.next=12,c.read();case 12:if((d=e.sent).type===fh.Type.SDP_OFFER){e.next=15;break}throw new Error("expected message type SDP_OFFER, received: ".concat(null!==(v=d.type)&&void 0!==v?v:"undefined"," "));case 15:return y=new RTCSessionDescription({type:"offer",sdp:d.data}),e.next=18,l.setRemoteDescription(y).catch((function(e){throw bh.error("could not execute setRemoteDescription",e),new Error("Failed to set remoteDescription")}));case 18:return e.next=20,l.createAnswer().catch((function(e){throw bh.error("could not execute createAnswer",e),p.reject(e),new Error("Failed to create answer")}));case 20:return g=e.sent,c.write({type:fh.Type.SDP_ANSWER,data:g.sdp}),e.next=24,l.setLocalDescription(g).catch((function(e){throw bh.error("could not execute setLocalDescription",e),p.reject(e),new Error("Failed to set localDescription")}));case 24:return p.resolve(),e.next=27,yh(h,l,c);case 27:return m=_h(null!==(n=null===(r=l.currentRemoteDescription)||void 0===r?void 0:r.sdp)&&void 0!==n?n:""),e.abrupt("return",{pc:l,muxerFactory:f,remoteAddress:m});case 29:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Eh(e){return xh.apply(this,arguments)}function xh(){return(xh=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c,l,f,h,p,d,v,y,g;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.rtcConfiguration,o=t.dataChannelOptions,a=t.signal,u=t.stream,c=nn(yu(u,a)).pb(fh),l=new RTCPeerConnection(i),f=new ph({peerConnection:l,dataChannelOptions:o}),h=Ut(),gh(l,h),a.onabort=h.reject,p=l.createDataChannel("init"),l.onicecandidate=function(e){var t=e.candidate;c.write({type:fh.Type.ICE_CANDIDATE,data:null!=t?JSON.stringify(t.toJSON()):""})},e.next=11,l.createOffer();case 11:return d=e.sent,c.write({type:fh.Type.SDP_OFFER,data:d.sdp}),e.next=15,l.setLocalDescription(d).catch((function(e){throw bh.error("could not execute setLocalDescription",e),new Error("Failed to set localDescription")}));case 15:return e.next=17,c.read();case 17:if((v=e.sent).type===fh.Type.SDP_ANSWER){e.next=20;break}throw new Error("remote should send an SDP answer");case 20:return y=new RTCSessionDescription({type:"answer",sdp:v.data}),e.next=23,l.setRemoteDescription(y).catch((function(e){throw bh.error("could not execute setRemoteDescription",e),new Error("Failed to set remoteDescription")}));case 23:return e.next=25,yh(h,l,c);case 25:return p.close(),g=_h(null!==(n=null===(r=l.currentRemoteDescription)||void 0===r?void 0:r.sdp)&&void 0!==n?n:""),e.abrupt("return",{pc:l,muxerFactory:f,remoteAddress:g});case 28:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _h(e){var t=e.split("\r\n").filter((function(e){return e.startsWith("a=candidate")})).pop(),n=null===t||void 0===t?void 0:t.split(" ");return null==t||null==n||n.length<5?(bh("could not parse remote address from",t),"/webrtc"):"/dnsaddr/".concat(n[4],"/").concat(n[2].toLowerCase(),"/").concat(n[3],"/webrtc")}var Sh,Ah=n(66213),Zh=n(77608),Th=new WeakMap,Ch=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){var e;(0,K.Z)(this,n);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return e=t.call.apply(t,[this].concat(i)),(0,cl.Z)((0,nr.Z)(e),Th,{writable:!0,value:new Map}),e}return(0,W.Z)(n,[{key:"listenerCount",value:function(e){var t=(0,fl.Z)(this,Th).get(e);return null==t?0:t.length}},{key:"addEventListener",value:function(e,t,r){var i;(0,Ah.Z)((0,Zh.Z)(n.prototype),"addEventListener",this).call(this,e,t,r);var o=(0,fl.Z)(this,Th).get(e);null==o&&(o=[],(0,fl.Z)(this,Th).set(e,o)),o.push({callback:t,once:null!==(i=!0!==r&&!1!==r&&(null===r||void 0===r?void 0:r.once))&&void 0!==i&&i})}},{key:"removeEventListener",value:function(e,t,r){(0,Ah.Z)((0,Zh.Z)(n.prototype),"removeEventListener",this).call(this,e.toString(),null!==t&&void 0!==t?t:null,r);var i=(0,fl.Z)(this,Th).get(e);null!=i&&(i=i.filter((function(e){return e.callback!==t})),(0,fl.Z)(this,Th).set(e,i))}},{key:"dispatchEvent",value:function(e){var t=(0,Ah.Z)((0,Zh.Z)(n.prototype),"dispatchEvent",this).call(this,e),r=(0,fl.Z)(this,Th).get(e.type);return null==r||(r=r.filter((function(e){return!e.once})),(0,fl.Z)(this,Th).set(e.type,r)),t}},{key:"safeDispatchEvent",value:function(e,t){return this.dispatchEvent(new Dh(e,t))}}]),n}((0,Ze.Z)(EventTarget)),Ih=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;return(0,K.Z)(this,n),i=t.call(this,e,r),(0,ot.Z)((0,nr.Z)(i),"detail",void 0),i.detail=null===r||void 0===r?void 0:r.detail,i}return(0,W.Z)(n)}((0,Ze.Z)(Event)),Dh=null!==(Sh=globalThis.CustomEvent)&&void 0!==Sh?Sh:Ih;function Oh(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function Rh(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?Oh(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function Ph(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var Lh=Ph("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),Nh=Ph("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=Rh((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),Bh=(0,Nt.Z)({utf8:Lh,"utf-8":Lh,hex:cr.gh.base16,latin1:Nh,ascii:Nh,binary:Nh},cr.gh);function Mh(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=Bh[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}function Fh(e,t){null==t&&(t=e.reduce((function(e,t){return e+t.length}),0));var n,r=Rh(t),i=0,o=(0,Ae.Z)(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;r.set(a,i),i+=a.length}}catch(s){o.e(s)}finally{o.f()}return Oh(r)}function jh(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=Bh[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):Oh(globalThis.Buffer.from(e,"utf-8"))}var Uh=xl.C,zh=xl.aY,Hh=function e(t){var n=0;if(t=t.toString().trim(),Uh(t)){var r=new Uint8Array(n+4);return t.split(/\./g).forEach((function(e){r[n++]=255&parseInt(e,10)})),r}if(zh(t)){var i,o=t.split(":",8);for(i=0;i<o.length;i++){var a=void 0;Uh(o[i])&&(a=e(o[i]),o[i]=Mh(a.slice(0,2),"base16")),null!=a&&++i<8&&o.splice(i,0,Mh(a.slice(2,4),"base16"))}if(""===o[0])for(;o.length<8;)o.unshift("0");else if(""===o[o.length-1])for(;o.length<8;)o.push("0");else if(o.length<8){for(i=0;i<o.length&&""!==o[i];i++);var s=[i,1];for(i=9-o.length;i>0;i--)s.push("0");o.splice.apply(o,s)}var u=new Uint8Array(n+16);for(i=0;i<o.length;i++){var c=parseInt(o[i],16);u[n++]=c>>8&255,u[n++]=255&c}return u}throw new Error("invalid ip address")},Vh=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;n=~~n,r=null!==(t=r)&&void 0!==t?t:e.length-n;var i=new DataView(e.buffer);if(4===r){for(var o=[],a=0;a<r;a++)o.push(e[n+a]);return o.join(".")}if(16===r){for(var s=[],u=0;u<r;u+=2)s.push(i.getUint16(n+u).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Gh=-1,Kh={},Wh={};function qh(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}function Yh(e){if("number"===typeof e){if(null!=Wh[e])return Wh[e];throw new Error("no protocol with code: ".concat(e))}if("string"===typeof e){if(null!=Kh[e])return Kh[e];throw new Error("no protocol with name: ".concat(e))}throw new Error("invalid protocol id type: ".concat(typeof e))}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Gh,"ip6zone"],[43,8,"ipcidr"],[53,Gh,"dns",!0],[54,Gh,"dns4",!0],[55,Gh,"dns6",!0],[56,Gh,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Gh,"unix",!1,!0],[421,Gh,"ipfs"],[421,Gh,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Gh,"garlic64"],[448,0,"tls"],[449,Gh,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Gh,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Gh,"memory"]].forEach((function(e){var t=qh.apply(void 0,(0,ye.Z)(e));Wh[t.code]=t,Kh[t.name]=t}));Yh("ip4"),Yh("ip6"),Yh("ipcidr");function Qh(e,t){switch(Yh(e).code){case 4:case 41:return function(e){var t=Vh(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!xl.h6(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ip(t);case 6:case 273:case 33:case 132:return np(t).toString();case 421:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return Mh(n,"base58btc")}(t);case 444:case 445:return op(t);case 466:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+Mh(n,"base64url")}(t);default:return Mh(t,"base16")}}function Xh(e,t){switch(Yh(e).code){case 4:case 41:return ep(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return rp(t);case 6:case 273:case 33:case 132:return tp(parseInt(t,10));case 421:return function(e){var t;t="Q"===e[0]||"1"===e[0]?b.decode(gr.base58btc.decode("z".concat(e))).bytes:c.CID.parse(e).multihash.bytes;var n=Uint8Array.from(A().encode(t.length));return Fh([n,t],n.length+t.length)}(t);case 444:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(16!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion address."));var n=kl.base32.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=tp(r);return Fh([n,i],n.length+i.length)}(t);case 445:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(56!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion3 address."));var n=kl.base32.decode("b".concat(t[0])),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=tp(r);return Fh([n,i],n.length+i.length)}(t);case 466:return function(e){var t=Jh.decode(e),n=Uint8Array.from(A().encode(t.length));return Fh([n,t],n.length+t.length)}(t);default:return jh(t,"base16")}}var $h=Object.values(cr.gh).map((function(e){return e.decoder})),Jh=function(){var e=$h[0].or($h[1]);return $h.slice(2).forEach((function(t){return e=e.or(t)})),e}();function ep(e){if(!xl.h6(e))throw new Error("invalid ip address");return Hh(e)}function tp(e){var t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function np(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function rp(e){var t=jh(e),n=Uint8Array.from(A().encode(t.length));return Fh([n,t],n.length+t.length)}function ip(e){var t=A().decode(e);if((e=e.slice(A().decode.bytes)).length!==t)throw new Error("inconsistent lengths");return Mh(e)}function op(e){var t=e.slice(0,e.length-2),n=e.slice(e.length-2),r=Mh(t,"base32"),i=np(n);return"".concat(r,":").concat(i)}function ap(e){return e.map((function(e){var t=yp(e);return null!=e[1]?[t.code,Qh(t.code,e[1])]:[t.code]}))}function sp(e){return hp(Fh(e.map((function(e){var t=yp(e),n=Uint8Array.from(A().encode(t.code));return e.length>1&&null!=e[1]&&(n=Fh([n,e[1]])),n}))))}function up(e,t){return e.size>0?e.size/8:0===e.size?0:A().decode(t)+(null!==(n=A().decode.bytes)&&void 0!==n?n:0);var n}function cp(e){for(var t=[],n=0;n<e.length;){var r,i=A().decode(e,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0,a=up(Yh(i),e.slice(n+o));if(0!==a){var s=e.slice(n+o,n+o+a);if((n+=a+o)>e.length)throw vp("Invalid address Uint8Array: "+Mh(e,"base16"));t.push([i,s])}else t.push([i]),n+=o}return t}function lp(e){return function(e){var t=[];return e.map((function(e){var n=yp(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),dp(t.join("/"))}(ap(cp(e)))}function fp(e){var t=function(e){var t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(var r=0;r<n.length;r++){var i=n[r],o=Yh(i);if(0!==o.size){if(++r>=n.length)throw vp("invalid address: "+e);if(!0===o.path){t.push([i,dp(n.slice(r).join("/"))]);break}t.push([i,n[r]])}else t.push([i])}return t}(e=dp(e));return sp(t.map((function(e){Array.isArray(e)||(e=[e]);var t=yp(e);return e.length>1?[t.code,Xh(t.code,e[1])]:[t.code]})))}function hp(e){var t=pp(e);if(null!=t)throw t;return Uint8Array.from(e)}function pp(e){try{cp(e)}catch(t){return t}}function dp(e){return"/"+e.trim().split("/").filter((function(e){return e})).join("/")}function vp(e){return new Error("Error parsing address: "+e)}function yp(e){return Yh(e[0])}var gp=Symbol.for("nodejs.util.inspect.custom"),mp=[Yh("dns").code,Yh("dns4").code,Yh("dns6").code,Yh("dnsaddr").code],bp=new Map,wp=Symbol.for("@multiformats/js-multiaddr/multiaddr");function kp(e){return Boolean(null===e||void 0===e?void 0:e[wp])}var Ep=new WeakMap,xp=new WeakMap,_p=new WeakMap,Sp=new WeakMap,Ap=function(){function e(t){if((0,K.Z)(this,e),(0,ot.Z)(this,"bytes",void 0),(0,cl.Z)(this,Ep,{writable:!0,value:void 0}),(0,cl.Z)(this,xp,{writable:!0,value:void 0}),(0,cl.Z)(this,_p,{writable:!0,value:void 0}),(0,cl.Z)(this,Sp,{writable:!0,value:void 0}),(0,ot.Z)(this,wp,!0),null==t&&(t=""),t instanceof Uint8Array)this.bytes=hp(t);else if("string"===typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error('multiaddr "'.concat(t,'" must start with a "/"'));this.bytes=fp(t)}else{if(!kp(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=hp(t.bytes)}}return(0,W.Z)(e,[{key:"toString",value:function(){return null==(0,fl.Z)(this,Ep)&&(0,ll.Z)(this,Ep,lp(this.bytes)),(0,fl.Z)(this,Ep)}},{key:"toJSON",value:function(){return this.toString()}},{key:"toOptions",value:function(){var e,t,n,r,i,o="",a=Yh("tcp"),s=Yh("udp"),u=Yh("ip4"),c=Yh("ip6"),l=Yh("dns6"),f=Yh("ip6zone"),h=(0,Ae.Z)(this.stringTuples());try{for(h.s();!(i=h.n()).done;){var p=(0,k.Z)(i.value,2),d=p[0],v=p[1];d===f.code&&(o="%".concat(null!==v&&void 0!==v?v:"")),mp.includes(d)&&(t=a.name,r=443,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===l.code?6:4),d!==a.code&&d!==s.code||(t=Yh(d).name,r=parseInt(null!==v&&void 0!==v?v:"")),d!==u.code&&d!==c.code||(t=Yh(d).name,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===c.code?6:4)}}catch(y){h.e(y)}finally{h.f()}if(null==e||null==t||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:r}}},{key:"protos",value:function(){return this.protoCodes().map((function(e){return Object.assign({},Yh(e))}))}},{key:"protoCodes",value:function(){for(var e=[],t=this.bytes,n=0;n<t.length;){var r,i=A().decode(t,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0;n+=up(Yh(i),t.slice(n+o))+o,e.push(i)}return e}},{key:"protoNames",value:function(){return this.protos().map((function(e){return e.name}))}},{key:"tuples",value:function(){return null==(0,fl.Z)(this,xp)&&(0,ll.Z)(this,xp,cp(this.bytes)),(0,fl.Z)(this,xp)}},{key:"stringTuples",value:function(){return null==(0,fl.Z)(this,_p)&&(0,ll.Z)(this,_p,ap(this.tuples())),(0,fl.Z)(this,_p)}},{key:"encapsulate",value:function(t){return t=new e(t),new e(this.toString()+t.toString())}},{key:"decapsulate",value:function(t){var n=t.toString(),r=this.toString(),i=r.lastIndexOf(n);if(i<0)throw new Error("Address ".concat(this.toString()," does not contain subaddress: ").concat(t.toString()));return new e(r.slice(0,i))}},{key:"decapsulateCode",value:function(t){for(var n=this.tuples(),r=n.length-1;r>=0;r--)if(n[r][0]===t)return new e(sp(n.slice(0,r)));return this}},{key:"getPeerId",value:function(){try{var e=this.stringTuples().filter((function(e){return e[0]===Kh.ipfs.code})),t=e.pop();if(null!=(null===t||void 0===t?void 0:t[1])){var n=t[1];return"Q"===n[0]||"1"===n[0]?Mh(gr.base58btc.decode("z".concat(n)),"base58btc"):Mh(c.CID.parse(n).multihash.bytes,"base58btc")}return null}catch(r){return null}}},{key:"getPath",value:function(){if(void 0===(0,fl.Z)(this,Sp))try{(0,ll.Z)(this,Sp,this.stringTuples().filter((function(e){return!0===Yh(e[0]).path}))[0][1]),null==(0,fl.Z)(this,Sp)&&(0,ll.Z)(this,Sp,null)}catch(e){(0,ll.Z)(this,Sp,null)}return(0,fl.Z)(this,Sp)}},{key:"equals",value:function(e){return function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}(this.bytes,e.bytes)}},{key:"resolve",value:function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=(r=this.protos().find((function(e){return e.resolvable})))){t.next=3;break}return t.abrupt("return",[this]);case 3:if(null!=(i=bp.get(r.name))){t.next=6;break}throw new ar.s("no available resolver for ".concat(r.name),"ERR_NO_AVAILABLE_RESOLVER");case 6:return t.next=8,i(this,n);case 8:return o=t.sent,t.abrupt("return",o.map((function(t){return new e(t)})));case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"nodeAddress",value:function(){var e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error('multiaddr must have a valid format - no protocol with name: "'.concat(e.transport,'". Must have a valid transport protocol: "{tcp, udp}"'));return{family:e.family,address:e.host,port:e.port}}},{key:"isThinWaistAddress",value:function(e){var t=(null!==e&&void 0!==e?e:this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}},{key:gp,value:function(){return"Multiaddr(".concat(lp(this.bytes),")")}}]),e}();function Zp(e){return new Ap(e)}var Tp=id("dns4"),Cp=id("dns6"),Ip=id("dnsaddr"),Dp=rd(id("dns"),Ip,Tp,Cp),Op=rd(id("ip4"),id("ip6")),Rp=rd(nd(Op,id("tcp")),nd(Dp,id("tcp"))),Pp=nd(Op,id("udp")),Lp=nd(Pp,id("utp")),Np=nd(Pp,id("quic")),Bp=nd(Pp,id("quic-v1")),Mp=rd(nd(Rp,id("ws")),nd(Dp,id("ws"))),Fp=rd(nd(Mp,id("p2p")),Mp),jp=rd(nd(Rp,id("wss")),nd(Dp,id("wss")),nd(Rp,id("tls"),id("ws")),nd(Dp,id("tls"),id("ws"))),Up=rd(nd(jp,id("p2p")),jp),zp=rd(nd(Rp,id("http")),nd(Op,id("http")),nd(Dp,id("http"))),Hp=rd(nd(Rp,id("https")),nd(Op,id("https")),nd(Dp,id("https"))),Vp=nd(Pp,id("webrtc-direct"),id("certhash")),Gp=rd(nd(Vp,id("p2p")),Vp),Kp=nd(Bp,id("webtransport"),id("certhash"),id("certhash")),Wp=rd(nd(Kp,id("p2p")),Kp),qp=rd(nd(Fp,id("p2p-webrtc-star"),id("p2p")),nd(Up,id("p2p-webrtc-star"),id("p2p")),nd(Fp,id("p2p-webrtc-star")),nd(Up,id("p2p-webrtc-star"))),Yp=(rd(nd(Fp,id("p2p-websocket-star"),id("p2p")),nd(Up,id("p2p-websocket-star"),id("p2p")),nd(Fp,id("p2p-websocket-star")),nd(Up,id("p2p-websocket-star"))),rd(nd(zp,id("p2p-webrtc-direct"),id("p2p")),nd(Hp,id("p2p-webrtc-direct"),id("p2p")),nd(zp,id("p2p-webrtc-direct")),nd(Hp,id("p2p-webrtc-direct")))),Qp=rd(Mp,jp,zp,Hp,qp,Yp,Rp,Lp,Np,Dp,Gp,Wp),Xp=(rd(nd(Qp,id("p2p-stardust"),id("p2p")),nd(Qp,id("p2p-stardust"))),rd(nd(Qp,id("p2p")),qp,Yp,Gp,Wp,id("p2p"))),$p=rd(nd(Xp,id("p2p-circuit"),Xp),nd(Xp,id("p2p-circuit")),nd(id("p2p-circuit"),Xp),nd(Qp,id("p2p-circuit")),nd(id("p2p-circuit"),Qp),id("p2p-circuit")),Jp=function e(){return rd(nd($p,e),$p)}(),ed=rd(nd(Jp,Xp,Jp),nd(Xp,Jp),nd(Jp,Xp),Jp,Xp);rd(nd(Jp,id("webrtc"),id("p2p")),nd(Jp,id("webrtc")),nd(Qp,id("webrtc"),id("p2p")),nd(Qp,id("webrtc")),id("webrtc"));function td(e){return function(t){var n;try{n=Zp(t)}catch(i){return!1}var r=e(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function nd(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];function r(e){if(e.length<t.length)return null;var n=e;return t.some((function(t){return n="function"===typeof t?t().partialMatch(e):t.partialMatch(e),Array.isArray(n)&&(e=n),null===n})),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:td(r),partialMatch:r}}function rd(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];function r(e){var n=null;return t.some((function(t){var r="function"===typeof t?t().partialMatch(e):t.partialMatch(e);return null!=r&&(n=r,!0)})),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:td(r),partialMatch:r}}function id(e){var t=e;return{toString:function(){return t},matches:function(e){var n;try{n=Zp(e)}catch(i){return!1}var r=n.protoNames();return 1===r.length&&r[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}var od,ad=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),r=t.call(this),(0,ot.Z)((0,nr.Z)(r),"peerId",void 0),(0,ot.Z)((0,nr.Z)(r),"transportManager",void 0),r.peerId=e.peerId,r.transportManager=e.transportManager,r}return(0,W.Z)(n,[{key:"listen",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.safeDispatchEvent("listening",{});case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getAddrs",value:function(){var e=this;return this.transportManager.getListeners().filter((function(t){return t!==e})).map((function(t){return t.getAddrs().filter((function(e){return Jp.matches(e)})).map((function(t){return t.encapsulate("/webrtc/p2p/".concat(e.peerId))}))})).flat()}},{key:"close",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.safeDispatchEvent("close",{});case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),n}(Ch),sd=(0,ru.kg)("libp2p:webrtc:peer"),ud="/webrtc-signaling/0.0.1",cd=Ol("webrtc").code;od=Symbol.toStringTag;var ld=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"init",void 0),(0,ot.Z)(this,"_started",!1),(0,ot.Z)(this,od,"@libp2p/webrtc"),(0,ot.Z)(this,ul,!0),this.components=t,this.init=n}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this._started}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.components.registrar.handle(ud,(function(e){t._onProtocol(e).catch((function(t){sd.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)}))}));case 2:this._started=!0;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.components.registrar.unhandle(ud);case 2:this._started=!1;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"createListener",value:function(e){return new ad(this.components)}},{key:"filter",value:function(e){return e.filter((function(e){return e.protoCodes().includes(cd)}))}},{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return sd.trace("dialing address: ",t),r=fd(t),i=r.baseAddr,o=r.peerId,null==n.signal&&(a=new AbortController,n.signal=a.signal),e.next=5,this.components.transportManager.dial(i,n);case 5:return u=e.sent,e.next=8,u.newStream([ud],n);case 8:return c=e.sent,e.prev=9,e.next=12,Eh({stream:c,rtcConfiguration:this.init.rtcConfiguration,dataChannelOptions:this.init.dataChannel,signal:n.signal});case 12:return l=e.sent,f=l.pc,h=l.muxerFactory,p=l.remoteAddress,e.next=18,n.upgrader.upgradeOutbound(new Hf({peerConnection:f,timeline:{open:Date.now()},remoteAddr:hf(p).encapsulate("/p2p/".concat(o.toString()))}),{skipProtection:!0,skipEncryption:!0,muxerFactory:h});case 18:return d=e.sent,c.close(),e.abrupt("return",d);case 23:throw e.prev=23,e.t0=e.catch(9),c.reset(),e.t0;case 27:case"end":return e.stop()}}),e,this,[[9,23]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_onProtocol",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.connection,r=t.stream,e.prev=1,e.next=4,wh({rtcConfiguration:this.init.rtcConfiguration,connection:n,stream:r,dataChannelOptions:this.init.dataChannel});case 4:return i=e.sent,o=i.pc,a=i.muxerFactory,u=i.remoteAddress,e.next=10,this.components.upgrader.upgradeInbound(new Hf({peerConnection:o,timeline:{open:(new Date).getTime()},remoteAddr:hf(u).encapsulate("/p2p/".concat(n.remotePeer.toString()))}),{skipEncryption:!0,skipProtection:!0,muxerFactory:a});case 10:e.next=16;break;case 12:throw e.prev=12,e.t0=e.catch(1),r.reset(),e.t0;case 16:case"end":return e.stop()}}),e,this,[[1,12]])})));return function(t){return e.apply(this,arguments)}}()}]),e}();function fd(e){var t=e.toString().split("/webrtc/");if(2!==t.length)throw new ar.s("webrtc protocol was not present in multiaddr",af.ERR_INVALID_MULTIADDR);if(!t[0].includes("/p2p-circuit"))throw new ar.s("p2p-circuit protocol was not present in multiaddr",af.ERR_INVALID_MULTIADDR);var n=hf(t[0]),r=hf("/"+t[1]).getPeerId();if(null==r)throw new ar.s("destination peer id was missing",af.ERR_INVALID_MULTIADDR);var i=n.protos().pop();if(void 0===i)throw new ar.s("invalid multiaddr",af.ERR_INVALID_MULTIADDR);return"p2p"!==i.name&&(n=n.encapsulate("/p2p/".concat(r))),{baseAddr:n,peerId:(0,Ps.jE)(r)}}function hd(){var e=Ut(),t=!1;return{sink:function(){var n=(0,u.Z)((0,s.Z)().mark((function n(r){return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!t){n.next=2;break}throw new Error("already piped");case 2:t=!0,e.resolve(r);case 4:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),source:(0,g.Z)((0,s.Z)().mark((function t(){var n;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,m.Z)(e.promise);case 2:return n=t.sent,t.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",4);case 4:case"end":return t.stop()}}),t)})))()}}function pd(){var e=hd(),t=hd();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}var dd=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=[],i=0,o=t;i<o.length;i++){var a=o[i];null==a[Symbol.asyncIterator]&&r.push(a)}return r.length===t.length?(0,s.Z)().mark((function e(){var t,n,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(r),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=8;break}return i=n.value,e.delegateYield(i,"t0",6);case 6:e.next=3;break;case 8:e.next=13;break;case 10:e.prev=10,e.t1=e.catch(1),t.e(e.t1);case 13:return e.prev=13,t.f(),e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[1,10,13,16]])}))():(0,g.Z)((0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=$f({objectMode:!0}),Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,i=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(r=!(u=e.sent).done)){e.next=12;break}c=u.value,n.push(c);case 9:r=!1,e.next=4;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(2),i=!0,o=e.t0;case 18:if(e.prev=18,e.prev=19,!r||null==a.return){e.next=23;break}return e.next=23,a.return();case 23:if(e.prev=23,!i){e.next=26;break}throw o;case 26:return e.finish(23);case 27:return e.finish(18);case 28:case"end":return e.stop()}}),e,null,[[2,14,18,28],[19,,23,27]])})));return function(t){return e.apply(this,arguments)}}()));case 3:n.end(),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),n.end(e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))),e.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",3);case 3:case"end":return e.stop()}}),e)})))()};function vd(e){if(null==e)throw new Error("Empty pipeline");if(kd(e)){var t=e;e=function(){return t.source}}else if(wd(e)||bd(e)){var n=e;e=function(){return n}}for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];var a=[e].concat(i);if(a.length>1&&kd(a[a.length-1])&&(a[a.length-1]=a[a.length-1].sink),a.length>2)for(var s=1;s<a.length-1;s++)kd(a[s])&&(a[s]=Ed(a[s]));return md.apply(void 0,(0,ye.Z)(a))}var yd,gd,md=function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},bd=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator])},wd=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.iterator])},kd=function(e){return null!=e&&(null!=e.sink&&null!=e.source)},Ed=function(e){return function(t){var n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){var r,i=$f({objectMode:!0});n.then((function(){i.end()}),(function(e){i.end(e)}));var o=e.source;if(bd(o))r=function(){var e=(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(o),m.Z),"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();else{if(!wd(o))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(o,"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)}))}return dd(i,r())}return e.source}},xd=65535,_d=Boolean(null===(yd=globalThis.process)||void 0===yd||null===(gd=yd.env)||void 0===gd?void 0:gd.DUMP_SESSION_KEYS),Sd={hashSHA256:function(e){return Un(e)},getHKDF:function(e,t){var n=Rn(Un,t,e,void 0,96);return[n.subarray(0,32),n.subarray(32,64),n.subarray(64,96)]},generateX25519KeyPair:function(){var e=Hn.Au();return{publicKey:e.publicKey,privateKey:e.secretKey}},generateX25519KeyPairFromSeed:function(e){var t=Hn._w(e);return{publicKey:t.publicKey,privateKey:t.secretKey}},generateX25519SharedKey:function(e,t){return Hn.gi(e,t)},chaCha20Poly1305Encrypt:function(e,t,n,r){return new zn.OK(r).seal(t,e,n)},chaCha20Poly1305Decrypt:function(e,t,n,r,i){return new zn.OK(r).open(t,e,n,i)}},Ad=function(e){var t,n=(t=2,globalThis.Buffer?globalThis.Buffer.allocUnsafe(t):new Uint8Array(t));return new DataView(n.buffer,n.byteOffset,n.byteLength).setUint16(0,e,!1),n};Ad.bytes=2;var Zd,Td,Cd=function(e){if(e.length<2)throw RangeError("Could not decode int16BE");return e instanceof Uint8Array?new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1):e.getUint16(0)};function Id(e){return wl([e.ne,e.ciphertext],e.ne.length+e.ciphertext.length)}function Dd(e){return wl([e.ne,e.ns,e.ciphertext],e.ne.length+e.ns.length+e.ciphertext.length)}function Od(e){return wl([e.ns,e.ciphertext],e.ns.length+e.ciphertext.length)}function Rd(e){if(e.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:e.subarray(0,32),ciphertext:e.subarray(32,e.length),ns:new Uint8Array(0)}}function Pd(e){if(e.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:e.subarray(0,32),ns:e.subarray(32,80),ciphertext:e.subarray(80,e.length)}}function Ld(e){if(e.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:e.subarray(0,48),ciphertext:e.subarray(48,e.length)}}function Nd(e,t){return function(){var n=(0,g.Z)((0,s.Z)().mark((function n(r){var i,o,a,u,c,l,f,h,p;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:i=!1,o=!1,n.prev=2,u=(0,y.Z)(r);case 4:return n.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=n.sent).done)){n.next=24;break}l=c.value,f=0;case 9:if(!(f<l.length)){n.next=21;break}return(h=f+65519)>l.length&&(h=l.length),p=e.encrypt(l.subarray(f,h),e.session),null===t||void 0===t||t.encryptedPackets.increment(),n.next=16,Ad(p.byteLength);case 16:return n.next=18,p;case 18:f+=65519,n.next=9;break;case 21:i=!1,n.next=4;break;case 24:n.next=30;break;case 26:n.prev=26,n.t0=n.catch(2),o=!0,a=n.t0;case 30:if(n.prev=30,n.prev=31,!i||null==u.return){n.next=35;break}return n.next=35,(0,m.Z)(u.return());case 35:if(n.prev=35,!o){n.next=38;break}throw a;case 38:return n.finish(35);case 39:return n.finish(30);case 40:case"end":return n.stop()}}),n,null,[[2,26,30,40],[31,,35,39]])})));return function(e){return n.apply(this,arguments)}}()}function Bd(e,t){return function(){var n=(0,g.Z)((0,s.Z)().mark((function n(r){var i,o,a,u,c,l,f,h,p,d,v,g;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:i=!1,o=!1,n.prev=2,u=(0,y.Z)(r);case 4:return n.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=n.sent).done)){n.next=29;break}l=c.value,f=0;case 9:if(!(f<l.length)){n.next=26;break}if((h=f+xd)>l.length&&(h=l.length),!(h-zn.pg<f)){n.next=14;break}throw new Error("Invalid chunk");case 14:if(p=l.subarray(f,h),d=l.subarray(f,h-zn.pg),v=e.decrypt(p,e.session,d),g=v.plaintext,v.valid){n.next=20;break}throw null===t||void 0===t||t.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");case 20:return null===t||void 0===t||t.decryptedPackets.increment(),n.next=23,g;case 23:f+=xd,n.next=9;break;case 26:i=!1,n.next=4;break;case 29:n.next=35;break;case 31:n.prev=31,n.t0=n.catch(2),o=!0,a=n.t0;case 35:if(n.prev=35,n.prev=36,!i||null==u.return){n.next=40;break}return n.next=40,(0,m.Z)(u.return());case 40:if(n.prev=40,!o){n.next=43;break}throw a;case 43:return n.finish(40);case 44:return n.finish(35);case 45:case"end":return n.stop()}}),n,null,[[2,31,35,45],[36,,40,44]])})));return function(e){return n.apply(this,arguments)}}()}function Md(e,t,n){return Fd.apply(this,arguments)}function Fd(){return(Fd=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ud(t,Kd(n));case 2:if(i=e.sent,null!=t.publicKey){e.next=5;break}throw new Error("PublicKey was missing from local PeerId");case 5:return e.abrupt("return",jd(t.publicKey,i,r));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function jd(e,t,n){return Td.encode({identityKey:e,identitySig:t,extensions:null!==n&&void 0!==n?n:{webtransportCerthashes:[]}}).subarray()}function Ud(e,t){return zd.apply(this,arguments)}function zd(){return(zd=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.privateKey){e.next=2;break}throw new Error("PrivateKey was missing from PeerId");case 2:return e.next=4,Cs(t.privateKey);case 4:return r=e.sent,e.abrupt("return",r.sign(n));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Hd(e){return Vd.apply(this,arguments)}function Vd(){return(Vd=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,Ps.y5)(t.identityKey));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Gd(e){return Td.decode(e)}function Kd(e){var t=El("noise-libp2p-static-key:");return wl([t,e],t.length+e.length)}function Wd(e,t,n){return qd.apply(this,arguments)}function qd(){return(qd=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,Ps.y5)(n.identityKey);case 2:if((i=e.sent).equals(r)){e.next=5;break}throw new Error("Payload identity key ".concat(i.toString()," does not match expected remote peer ").concat(r.toString()));case 5:if(o=Kd(t),null!=i.publicKey){e.next=8;break}throw new Error("PublicKey was missing from PeerId");case 8:if(null!=n.identitySig){e.next=10;break}throw new Error("Signature was missing from message");case 10:return a=Zs(i.publicKey),e.next=13,a.verify(o,n.identitySig);case 13:if(e.sent){e.next=16;break}throw new Error("Static key doesn't match to peer that signed payload!");case 16:return e.abrupt("return",i);case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Yd(e){return e instanceof Uint8Array&&32===e.length}Cd.bytes=2,function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes){var r,i=(0,Ae.Z)(e.webtransportCerthashes);try{for(i.s();!(r=i.n()).done;){var o=r.value;t.uint32(10),t.bytes(o)}}catch(a){i.e(a)}finally{i.f()}}!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={webtransportCerthashes:[]},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();if(i>>>3===1)n.webtransportCerthashes.push(e.bytes());else e.skipType(7&i)}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(Zd||(Zd={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n,r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(!1!==i.lengthDelimited&&t.fork(),!0===i.writeDefaults||null!=e.identityKey&&e.identityKey.byteLength>0)&&(t.uint32(10),t.bytes(null!==(n=e.identityKey)&&void 0!==n?n:new Uint8Array(0)));(!0===i.writeDefaults||null!=e.identitySig&&e.identitySig.byteLength>0)&&(t.uint32(18),t.bytes(null!==(r=e.identitySig)&&void 0!==r?r:new Uint8Array(0)));null!=e.extensions&&(t.uint32(34),Zd.codec().encode(e.extensions,t,{writeDefaults:!1})),!1!==i.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.identityKey=e.bytes();break;case 2:n.identitySig=e.bytes();break;case 4:n.extensions=Zd.codec().decode(e,e.uint32());break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(Td||(Td={}));var Qd,Xd=(0,ru.kg)("libp2p:noise");function $d(e){e?(Qd("LOCAL_PUBLIC_EPHEMERAL_KEY ".concat(bl(e.publicKey,"hex"))),Qd("LOCAL_PRIVATE_EPHEMERAL_KEY ".concat(bl(e.privateKey,"hex")))):Qd("Missing local ephemeral keys.")}function Jd(e){Qd("REMOTE_EPHEMERAL_PUBLIC_KEY ".concat(bl(e,"hex")))}Qd=_d?Xd:Object.assign((function(){}),{enabled:!1,trace:function(){},error:function(){}});var ev=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,K.Z)(this,e),(0,ot.Z)(this,"n",void 0),(0,ot.Z)(this,"bytes",void 0),(0,ot.Z)(this,"view",void 0),this.n=t,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,t,!0)}return(0,W.Z)(e,[{key:"increment",value:function(){this.n++,this.view.setUint32(4,this.n,!0)}},{key:"getBytes",value:function(){return this.bytes}},{key:"getUint64",value:function(){return this.n}},{key:"assertValue",value:function(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}]),e}(),tv=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"crypto",void 0),this.crypto=t}return(0,W.Z)(e,[{key:"encryptWithAd",value:function(e,t,n){var r=this.encrypt(e.k,e.n,t,n);return e.n.increment(),r}},{key:"decryptWithAd",value:function(e,t,n,r){var i=this.decrypt(e.k,e.n,t,n,r),o=i.plaintext,a=i.valid;return a&&e.n.increment(),{plaintext:o,valid:a}}},{key:"hasKey",value:function(e){return!this.isEmptyKey(e.k)}},{key:"createEmptyKey",value:function(){return new Uint8Array(32)}},{key:"isEmptyKey",value:function(e){return hl(this.createEmptyKey(),e)}},{key:"encrypt",value:function(e,t,n,r){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(r,t.getBytes(),n,e)}},{key:"encryptAndHash",value:function(e,t){var n;return n=this.hasKey(e.cs)?this.encryptWithAd(e.cs,e.h,t):t,this.mixHash(e,n),n}},{key:"decrypt",value:function(e,t,n,r,i){t.assertValue();var o=this.crypto.chaCha20Poly1305Decrypt(r,t.getBytes(),n,e,i);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}},{key:"decryptAndHash",value:function(e,t){var n,r=!0;if(this.hasKey(e.cs)){var i=this.decryptWithAd(e.cs,e.h,t);n=i.plaintext,r=i.valid}else n=t;return this.mixHash(e,t),{plaintext:n,valid:r}}},{key:"dh",value:function(e,t){try{var n=this.crypto.generateX25519SharedKey(e,t);return 32===n.length?n:n.subarray(0,32)}catch(i){var r=i;return Xd.error(r),new Uint8Array(32)}}},{key:"mixHash",value:function(e,t){e.h=this.getHash(e.h,t)}},{key:"getHash",value:function(e,t){return this.crypto.hashSHA256(wl([e,t],e.length+t.length))}},{key:"mixKey",value:function(e,t){var n=this.crypto.getHKDF(e.ck,t),r=(0,k.Z)(n,2),i=r[0],o=r[1];e.cs=this.initializeKey(o),e.ck=i}},{key:"initializeKey",value:function(e){return{k:e,n:new ev}}},{key:"initializeSymmetric",value:function(e){var t=El(e,"utf-8"),n=this.hashProtocolName(t),r=n,i=this.createEmptyKey();return{cs:this.initializeKey(i),ck:r,h:n}}},{key:"hashProtocolName",value:function(e){if(e.length<=32){var t=new Uint8Array(32);return t.set(e),t}return this.getHash(e,new Uint8Array(0))}},{key:"split",value:function(e){var t=this.crypto.getHKDF(e.ck,new Uint8Array(0)),n=(0,k.Z)(t,2),r=n[0],i=n[1];return{cs1:this.initializeKey(r),cs2:this.initializeKey(i)}}},{key:"writeMessageRegular",value:function(e,t){var n=this.encryptWithAd(e,new Uint8Array(0),t);return{ne:this.createEmptyKey(),ns:new Uint8Array(0),ciphertext:n}}},{key:"readMessageRegular",value:function(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}}]),e}(),nv=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){return(0,K.Z)(this,n),t.apply(this,arguments)}return(0,W.Z)(n,[{key:"initializeInitiator",value:function(e,t,n,r){var i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");return this.mixHash(i,e),{ss:i,s:t,rs:n,psk:r,re:new Uint8Array(32)}}},{key:"initializeResponder",value:function(e,t,n,r){var i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");return this.mixHash(i,e),{ss:i,s:t,rs:n,psk:r,re:new Uint8Array(32)}}},{key:"writeMessageA",value:function(e,t,n){var r=new Uint8Array(0);e.e=void 0!==n?n:this.crypto.generateX25519KeyPair();var i=e.e.publicKey;return this.mixHash(e.ss,i),{ne:i,ns:r,ciphertext:this.encryptAndHash(e.ss,t)}}},{key:"writeMessageB",value:function(e,t){e.e=this.crypto.generateX25519KeyPair();var n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));var r=e.s.publicKey,i=this.encryptAndHash(e.ss,r);return this.mixKey(e.ss,this.dh(e.s.privateKey,e.re)),{ne:n,ns:i,ciphertext:this.encryptAndHash(e.ss,t)}}},{key:"writeMessageC",value:function(e,t){var n=e.s.publicKey,r=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));var i=this.encryptAndHash(e.ss,t),o={ne:this.createEmptyKey(),ns:r,ciphertext:i},a=this.split(e.ss),s=a.cs1,u=a.cs2;return{h:e.ss.h,messageBuffer:o,cs1:s,cs2:u}}},{key:"readMessageA",value:function(e,t){return Yd(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}},{key:"readMessageB",value:function(e,t){if(Yd(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));var n=this.decryptAndHash(e.ss,t.ns),r=n.plaintext,i=n.valid;i&&Yd(r)&&(e.rs=r),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));var o=this.decryptAndHash(e.ss,t.ciphertext),a=o.plaintext,s=o.valid;return{plaintext:a,valid:i&&s}}},{key:"readMessageC",value:function(e,t){var n=this.decryptAndHash(e.ss,t.ns),r=n.plaintext,i=n.valid;if(i&&Yd(r)&&(e.rs=r),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));var o=this.decryptAndHash(e.ss,t.ciphertext),a=o.plaintext,s=o.valid,u=this.split(e.ss),c=u.cs1,l=u.cs2;return{h:e.ss.h,plaintext:a,valid:i&&s,cs1:c,cs2:l}}},{key:"initSession",value:function(e,t,n){var r=this.createEmptyKey(),i=new Uint8Array(32);return{hs:e?this.initializeInitiator(t,n,i,r):this.initializeResponder(t,n,i,r),i:e,mc:0}}},{key:"sendMessage",value:function(e,t,n){var r;if(0===e.mc)r=this.writeMessageA(e.hs,t,n);else if(1===e.mc)r=this.writeMessageB(e.hs,t);else if(2===e.mc){var i=this.writeMessageC(e.hs,t),o=i.h,a=i.messageBuffer,s=i.cs1,u=i.cs2;r=a,e.h=o,e.cs1=s,e.cs2=u}else{if(!(e.mc>2))throw new Error("Session invalid.");if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");r=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");r=this.writeMessageRegular(e.cs2,t)}}return e.mc++,r}},{key:"recvMessage",value:function(e,t){var n=new Uint8Array(0),r=!1;if(0===e.mc){var i=this.readMessageA(e.hs,t);n=i.plaintext,r=i.valid}else if(1===e.mc){var o=this.readMessageB(e.hs,t);n=o.plaintext,r=o.valid}else if(2===e.mc){var a=this.readMessageC(e.hs,t),s=a.h,u=a.plaintext,c=a.valid,l=a.cs1,f=a.cs2;n=u,r=c,e.h=s,e.cs1=l,e.cs2=f}return e.mc++,{plaintext:n,valid:r}}}]),n}(tv),rv=function(){function e(t,n,r,i,o,a,s,u){(0,K.Z)(this,e),(0,ot.Z)(this,"isInitiator",void 0),(0,ot.Z)(this,"session",void 0),(0,ot.Z)(this,"remotePeer",void 0),(0,ot.Z)(this,"remoteExtensions",{webtransportCerthashes:[]}),(0,ot.Z)(this,"payload",void 0),(0,ot.Z)(this,"connection",void 0),(0,ot.Z)(this,"xx",void 0),(0,ot.Z)(this,"staticKeypair",void 0),(0,ot.Z)(this,"prologue",void 0),this.isInitiator=t,this.payload=n,this.prologue=r,this.staticKeypair=o,this.connection=a,s&&(this.remotePeer=s),this.xx=null!==u&&void 0!==u?u:new nv(i),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}return(0,W.Z)(e,[{key:"propose",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.session.hs.s,Qd("LOCAL_STATIC_PUBLIC_KEY ".concat(bl(i.publicKey,"hex"))),Qd("LOCAL_STATIC_PRIVATE_KEY ".concat(bl(i.privateKey,"hex"))),!this.isInitiator){e.next=9;break}Xd.trace("Stage 0 - Initiator starting to send first message."),t=this.xx.sendMessage(this.session,new Uint8Array(0)),this.connection.writeLP(Id(t)),Xd.trace("Stage 0 - Initiator finished sending first message."),$d(this.session.hs.e),e.next=20;break;case 9:return Xd.trace("Stage 0 - Responder waiting to receive first message..."),e.t0=Rd,e.next=13,this.connection.readLP();case 13:if(e.t1=e.sent.subarray(),n=(0,e.t0)(e.t1),r=this.xx.recvMessage(this.session,n),r.valid){e.next=18;break}throw new ir("xx handshake stage 0 validation fail");case 18:Xd.trace("Stage 0 - Responder received first message."),Jd(this.session.hs.re);case 20:case"end":return e.stop()}var i}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"exchange",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isInitiator){e.next=34;break}return Xd.trace("Stage 1 - Initiator waiting to receive first message from responder..."),e.t0=Pd,e.next=5,this.connection.readLP();case 5:if(e.t1=e.sent.subarray(),t=(0,e.t0)(e.t1),n=this.xx.recvMessage(this.session,t),r=n.plaintext,n.valid){e.next=10;break}throw new ir("xx handshake stage 1 validation fail");case 10:if(Xd.trace("Stage 1 - Initiator received the message."),Jd(this.session.hs.re),s=this.session.hs.rs,Qd("REMOTE_STATIC_PUBLIC_KEY ".concat(bl(s,"hex"))),Xd.trace("Initiator going to check remote's signature..."),e.prev=14,i=Gd(r),e.t2=this.remotePeer,e.t2){e.next=21;break}return e.next=20,Hd(i);case 20:e.t2=e.sent;case 21:return this.remotePeer=e.t2,e.next=24,Wd(this.session.hs.rs,i,this.remotePeer);case 24:this.setRemoteNoiseExtension(i.extensions),e.next=31;break;case 27:throw e.prev=27,e.t3=e.catch(14),o=e.t3,new rr("Error occurred while verifying signed payload: ".concat(o.message));case 31:Xd.trace("All good with the signature!"),e.next=39;break;case 34:Xd.trace("Stage 1 - Responder sending out first message with signed payload and static key."),a=this.xx.sendMessage(this.session,this.payload),this.connection.writeLP(Dd(a)),Xd.trace("Stage 1 - Responder sent the second handshake message with signed payload."),$d(this.session.hs.e);case 39:case"end":return e.stop()}var s}),e,this,[[14,27]])})));return function(){return e.apply(this,arguments)}}()},{key:"finish",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isInitiator){e.next=7;break}Xd.trace("Stage 2 - Initiator sending third handshake message."),t=this.xx.sendMessage(this.session,this.payload),this.connection.writeLP(Od(t)),Xd.trace("Stage 2 - Initiator sent message with signed payload."),e.next=34;break;case 7:return Xd.trace("Stage 2 - Responder waiting for third handshake message..."),e.t0=Ld,e.next=11,this.connection.readLP();case 11:if(e.t1=e.sent.subarray(),n=(0,e.t0)(e.t1),r=this.xx.recvMessage(this.session,n),i=r.plaintext,r.valid){e.next=16;break}throw new ir("xx handshake stage 2 validation fail");case 16:if(Xd.trace("Stage 2 - Responder received the message, finished handshake."),e.prev=17,o=Gd(i),e.t2=this.remotePeer,e.t2){e.next=24;break}return e.next=23,Hd(o);case 23:e.t2=e.sent;case 24:return this.remotePeer=e.t2,e.next=27,Wd(this.session.hs.rs,o,this.remotePeer);case 27:this.setRemoteNoiseExtension(o.extensions),e.next=34;break;case 30:throw e.prev=30,e.t3=e.catch(17),a=e.t3,new rr("Error occurred while verifying signed payload: ".concat(a.message));case 34:(s=this.session).cs1&&s.cs2?(Qd("CIPHER_STATE_1 ".concat(s.cs1.n.getUint64()," ").concat(bl(s.cs1.k,"hex"))),Qd("CIPHER_STATE_2 ".concat(s.cs2.n.getUint64()," ").concat(bl(s.cs2.k,"hex")))):Qd("Missing cipher state.");case 35:case"end":return e.stop()}var s}),e,this,[[17,30]])})));return function(){return e.apply(this,arguments)}}()},{key:"encrypt",value:function(e,t){var n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}},{key:"decrypt",value:function(e,t,n){var r=this.getCS(t,!1);return this.xx.decryptWithAd(r,new Uint8Array(0),e,n)}},{key:"getRemoteStaticKey",value:function(){return this.session.hs.rs}},{key:"getCS",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e.cs1||!e.cs2)throw new ir("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}},{key:"setRemoteNoiseExtension",value:function(e){e&&(this.remoteExtensions=e)}}]),e}();var iv=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"protocol","/noise"),(0,ot.Z)(this,"crypto",void 0),(0,ot.Z)(this,"prologue",void 0),(0,ot.Z)(this,"staticKeys",void 0),(0,ot.Z)(this,"extensions",void 0),(0,ot.Z)(this,"metrics",void 0);var n=t.staticNoiseKey,r=t.extensions,i=t.crypto,o=t.prologueBytes,a=t.metrics;this.crypto=null!==i&&void 0!==i?i:Sd,this.extensions=r,this.metrics=a?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(a):void 0,this.staticKeys=n?this.crypto.generateX25519KeyPairFromSeed(n):this.crypto.generateX25519KeyPair(),this.prologue=null!==o&&void 0!==o?o:new Uint8Array(0)}return(0,W.Z)(e,[{key:"secureOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=nn(n,{lengthEncoder:Ad,lengthDecoder:Cd,maxDataLength:xd}),e.next=3,this.performHandshake({connection:i,isInitiator:!0,localPeer:t,remotePeer:r});case 3:return o=e.sent,e.next=6,this.createSecureConnection(i,o);case 6:return a=e.sent,e.abrupt("return",{conn:a,remoteExtensions:o.remoteExtensions,remotePeer:o.remotePeer});case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"secureInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=nn(n,{lengthEncoder:Ad,lengthDecoder:Cd,maxDataLength:xd}),e.next=3,this.performHandshake({connection:i,isInitiator:!1,localPeer:t,remotePeer:r});case 3:return o=e.sent,e.next=6,this.createSecureConnection(i,o);case 6:return a=e.sent,e.abrupt("return",{conn:a,remotePeer:o.remotePeer,remoteExtensions:o.remoteExtensions});case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"performHandshake",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Md(t.localPeer,this.staticKeys.publicKey,this.extensions);case 2:return n=e.sent,e.abrupt("return",this.performXXHandshake(t,n));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"performXXHandshake",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.isInitiator,i=t.remotePeer,o=t.connection,a=new rv(r,n,this.prologue,this.crypto,this.staticKeys,o,i),e.prev=2,e.next=5,a.propose();case 5:return e.next=7,a.exchange();case 7:return e.next=9,a.finish();case 9:null===(u=this.metrics)||void 0===u||u.xxHandshakeSuccesses.increment(),e.next=18;break;case 12:if(e.prev=12,e.t0=e.catch(2),null===(c=this.metrics)||void 0===c||c.xxHandshakeErrors.increment(),!(e.t0 instanceof Error)){e.next=18;break}throw e.t0.message="Error occurred during XX handshake: ".concat(e.t0.message),e.t0;case 18:return e.abrupt("return",a);case 19:case"end":return e.stop()}}),e,this,[[2,12]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"createSecureConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=pd(),i=(0,k.Z)(r,2),o=i[0],a=i[1],u=t.unwrap(),e.next=4,vd(o,Nd(n,this.metrics),u,(function(e){return Yf(e,{lengthDecoder:Cd})}),Bd(n,this.metrics),o);case 4:return e.abrupt("return",a);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}();function ov(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(){return new iv(e)}}var av=n(53765),sv=n(90484),uv=n(14665);function cv(){cv=function(e,t){return new n(e,void 0,t)};var e=RegExp.prototype,t=new WeakMap;function n(e,r,i){var o=new RegExp(e,r);return t.set(o,i||t.get(e)),(0,uv.Z)(o,n.prototype)}function r(e,n){var r=t.get(n);return Object.keys(r).reduce((function(t,n){var i=r[n];if("number"==typeof i)t[n]=e[i];else{for(var o=0;void 0===e[i[o]]&&o+1<i.length;)o++;t[n]=e[i[o]]}return t}),Object.create(null))}return(0,X.Z)(n,RegExp),n.prototype.exec=function(t){var n=e.exec.call(this,t);if(n){n.groups=r(n,this);var i=n.indices;i&&(i.groups=r(i,this))}return n},n.prototype[Symbol.replace]=function(n,i){if("string"==typeof i){var o=t.get(this);return e[Symbol.replace].call(this,n,i.replace(/\$<([^>]+)>/g,(function(e,t){var n=o[t];return"$"+(Array.isArray(n)?n.join("$"):n)})))}if("function"==typeof i){var a=this;return e[Symbol.replace].call(this,n,(function(){var e=arguments;return"object"!=(0,sv.Z)(e[e.length-1])&&(e=[].slice.call(e)).push(r(e,a)),i.apply(this,e)}))}return e[Symbol.replace].call(this,n,i)},cv.apply(this,arguments)}var lv=(0,ru.kg)("libp2p:webrtc:sdp"),fv=Object.values(cr.gh).map((function(e){return e.decoder})).reduce((function(e,t){return e.or(t)}));function hv(e){var t,n=null===(t=e.getConfiguration().certificates)||void 0===t?void 0:t.at(0);if(null==n||null==n.getFingerprints){lv.trace("fetching fingerprint from local SDP");var r=e.localDescription;if(null==r)return;return function(e){var t,n=e.match(pv);return null===n||void 0===n||null===(t=n.groups)||void 0===t?void 0:t.fingerprint}(r.sdp)}if(lv.trace("fetching fingerprint from local certificate"),0!==n.getFingerprints().length){var i=n.getFingerprints()[0].value;if(null==i)throw kf("","no fingerprint on local certificate");return i}}var pv=cv(/^a=fingerprint:(?:\w+\x2D[0-9]+)\s((:?[0-9a-fA-F]{2})+)$/m,{fingerprint:1});function dv(e){var t=e.stringTuples().filter((function(e){return e[0]===_v})).map((function(e){return e[1]}))[0];if(void 0===t||""===t)throw gf("Couldn't find a certhash component of multiaddr: ".concat(e.toString()));return t}function vv(e){var t=fv.decode(e);return av.decode(t)}function yv(e){switch(e){case"sha1":return"sha-1";case"sha2-256":return"sha-256";case"sha2-512":return"sha-512";default:throw new xf(e)}}function gv(e,t){var n=e.toOptions(),r=n.host,i=n.port,o=function(e){var t,n=(0,Ae.Z)(e.protoNames());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.startsWith("ip"))return r.toUpperCase()}}catch(i){n.e(i)}finally{n.f()}return lv("Warning: multiaddr does not appear to contain IP4 or IP6, defaulting to IP6",e),"IP6"}(e),a=function(e){var t=vv(dv(e)),n=yv(t.name),r=t.digest.reduce((function(e,t){return e+t.toString(16).padStart(2,"0")}),""),i=r.match(/.{1,2}/g);if(null==i)throw kf(r,e.toString());return["".concat(n.toUpperCase()," ").concat(i.join(":").toUpperCase()),r]}(e),s=(0,k.Z)(a,1)[0];return"v=0\no=- 0 0 IN ".concat(o," ").concat(r,"\ns=-\nc=IN ").concat(o," ").concat(r,"\nt=0 0\na=ice-lite\nm=application ").concat(i," UDP/DTLS/SCTP webrtc-datachannel\na=mid:0\na=setup:passive\na=ice-ufrag:").concat(t,"\na=ice-pwd:").concat(t,"\na=fingerprint:").concat(s,"\na=sctp-port:5000\na=max-message-size:100000\na=candidate:1467250027 1 UDP 1467250027 ").concat(r," ").concat(i," typ host\r\n")}function mv(e,t){return{type:"answer",sdp:gv(e,t)}}function bv(e,t){if(void 0===e.sdp)throw bf("Can't munge a missing SDP");return e.sdp=e.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,"\na=ice-ufrag:"+t+"\n").replace(/\na=ice-pwd:[^\n]*\n/,"\na=ice-pwd:"+t+"\n"),e}var wv,kv=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),Ev=(0,ru.kg)("libp2p:webrtc:transport"),xv=Ol("webrtc-direct").code,_v=Ol("certhash").code;wv=Symbol.toStringTag;var Sv=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"metrics",void 0),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"init",void 0),(0,ot.Z)(this,wv,"@libp2p/webrtc-direct"),(0,ot.Z)(this,ul,!0),this.components=t,this.init=n,null!=t.metrics&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dial events by type"})})}return(0,W.Z)(e,[{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._connect(t,n);case 2:return r=e.sent,Ev("dialing address - ".concat(t.toString())),e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"createListener",value:function(e){throw new Ef("WebRTCTransport.createListener")}},{key:"filter",value:function(e){return e.filter(Av)}},{key:"_connect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v,b,w,k,E,x,_,S,A,Z,T,C,I,D=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=new AbortController,u=a.signal,null!==(c=t.getPeerId())){e.next=5;break}throw gf("we need to have the remote's PeerId");case 5:return l=Ps.jE(c),f=vv(dv(t)),e.next=9,RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:yv(f.name)});case 9:return h=e.sent,p=new RTCPeerConnection({certificates:[h]}),d=new Promise((function(e,t){var n=p.createDataChannel("",{negotiated:!0,id:0}),r=setTimeout((function(){var e,r="Data channel was never opened: state: ".concat(n.readyState);Ev.error(r),null===(e=D.metrics)||void 0===e||e.dialerEvents.increment({open_error:!0}),t(vf("data",r))}),1e4);n.onopen=function(t){clearTimeout(r),e(n)},n.onerror=function(e){var n,i,o;clearTimeout(r);var a=null!==(n=null===(i=e.target)||void 0===i?void 0:i.toString())&&void 0!==n?n:"not specified",s="Error opening a data channel for handshaking: ".concat(a);Ev.error(s),null===(o=D.metrics)||void 0===o||o.dialerEvents.increment({unknown_error:!0}),t(vf("data",s))}})),v="libp2p+webrtc+v1/"+(O=32,(0,ye.Z)(Array(O)).map((function(){return kv.at(Math.floor(Math.random()*kv.length))})).join("")),e.next=15,p.createOffer();case 15:return b=e.sent,w=bv(b,v),e.next=19,p.setLocalDescription(w);case 19:return k=mv(t,v),e.next=22,p.setRemoteDescription(k);case 22:return e.next=24,d;case 24:return E=e.sent,x=this.components.peerId,_=this.generateNoisePrologue(p,f.code,t),S=ov({prologueBytes:_})(),A=lh({channel:E,direction:"inbound",dataChannelOptions:this.init.dataChannel}),Z=(0,Nt.Z)((0,Nt.Z)({},A),{},{sink:A.sink.bind(A),source:(0,g.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!1,n=!1,e.prev=2,i=(0,y.Z)(A.source);case 4:return e.next=6,(0,m.Z)(i.next());case 6:if(!(t=!(o=e.sent).done)){e.next=28;break}a=o.value,u=(0,Ae.Z)(a),e.prev=9,u.s();case 11:if((c=u.n()).done){e.next=17;break}return l=c.value,e.next=15,l;case 15:e.next=11;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(9),u.e(e.t0);case 22:return e.prev=22,u.f(),e.finish(22);case 25:t=!1,e.next=4;break;case 28:e.next=34;break;case 30:e.prev=30,e.t1=e.catch(2),n=!0,r=e.t1;case 34:if(e.prev=34,e.prev=35,!t||null==i.return){e.next=39;break}return e.next=39,(0,m.Z)(i.return());case 39:if(e.prev=39,!n){e.next=42;break}throw r;case 42:return e.finish(39);case 43:return e.finish(34);case 44:case"end":return e.stop()}}),e,null,[[2,30,34,44],[9,19,22,25],[35,,39,43]])})))()}),T=new Hf({peerConnection:p,remoteAddr:t,timeline:{open:Date.now()},metrics:null===(r=this.metrics)||void 0===r?void 0:r.dialerEvents}),C=Ff?"iceconnectionstatechange":"connectionstatechange",p.addEventListener(C,(function(){switch(p.connectionState){case"failed":case"disconnected":case"closed":T.close().catch((function(e){Ev.error("error closing connection",e)})).finally((function(){a.abort()}))}}),{signal:u}),null===(i=this.metrics)||void 0===i||i.dialerEvents.increment({peer_connection:!0}),I=new ph({peerConnection:p,metrics:null===(o=this.metrics)||void 0===o?void 0:o.dialerEvents,dataChannelOptions:this.init.dataChannel}),e.next=37,S.secureInbound(x,Z,l);case 37:return e.abrupt("return",n.upgrader.upgradeOutbound(T,{skipProtection:!0,skipEncryption:!0,muxerFactory:I}));case 38:case"end":return e.stop()}var O}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"generateNoisePrologue",value:function(e,t,n){var r;if(0===(null===(r=e.getConfiguration().certificates)||void 0===r?void 0:r.length))throw bf("no local certificate");var i=hv(e);if(null==i)throw bf("no local fingerprint found");var o=El(i.trim().toLowerCase().replaceAll(":",""),"hex"),a=av.encode(o,t),s=fv.decode(dv(n));return wl([El("libp2p-webrtc-noise:"),a,s])}}]),e}();function Av(e){var t=e.protoCodes();return t.includes(xv)&&t.includes(_v)&&null!=e.getPeerId()&&!t.includes(Ol("p2p-circuit").code)}function Zv(e){return function(t){return new Sv(t,e)}}function Tv(e){return function(t){return new ld(t,e)}}var Cv=n(19978),Iv=WebSocket,Dv=n(3634);function Ov(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function Rv(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var Pv=Rv("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),Lv=Rv("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?Ov(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),Nv=(0,Nt.Z)({utf8:Pv,"utf-8":Pv,hex:cr.gh.base16,latin1:Lv,ascii:Lv,binary:Lv},cr.gh);function Bv(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=Nv[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):Ov(globalThis.Buffer.from(e,"utf-8"))}function Mv(e){var t;return e instanceof ArrayBuffer||"ArrayBuffer"===(null===e||void 0===e||null===(t=e.constructor)||void 0===t?void 0:t.name)&&"number"===typeof(null===e||void 0===e?void 0:e.byteLength)}var Fv=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.readyState>=2)){e.next=2;break}throw new Error("socket closed");case 2:if(1!==t.readyState){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,new Promise((function(e,n){function r(){t.removeEventListener("open",i),t.removeEventListener("error",o)}function i(){r(),e()}function o(e){var i;r(),n(null!==(i=e.error)&&void 0!==i?i:new Error("connect ECONNREFUSED ".concat(t.url)))}t.addEventListener("open",i),t.addEventListener("error",o)}));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),jv=function(e,t){var n;(t=null!==(n=t)&&void 0!==n?n:{}).closeOnEnd=!1!==t.closeOnEnd;var r=function(){var n=(0,u.Z)((0,s.Z)().mark((function n(r){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:i=!1,o=!1,n.prev=2,u=(0,y.Z)(r);case 4:return n.next=6,u.next();case 6:if(!(i=!(c=n.sent).done)){n.next=22;break}return l=c.value,n.prev=8,n.next=11,Fv(e);case 11:n.next=18;break;case 13:if(n.prev=13,n.t0=n.catch(8),"socket closed"!==n.t0.message){n.next=17;break}return n.abrupt("break",22);case 17:throw n.t0;case 18:e.send(l);case 19:i=!1,n.next=4;break;case 22:n.next=28;break;case 24:n.prev=24,n.t1=n.catch(2),o=!0,a=n.t1;case 28:if(n.prev=28,n.prev=29,!i||null==u.return){n.next=33;break}return n.next=33,u.return();case 33:if(n.prev=33,!o){n.next=36;break}throw a;case 36:return n.finish(33);case 37:return n.finish(28);case 38:if(!(null!=t.closeOnEnd&&e.readyState<=1)){n.next=41;break}return n.next=41,new Promise((function(t,n){e.addEventListener("close",(function(e){if(e.wasClean||1006===e.code)t();else{var r=Object.assign(new Error("ws error"),{event:e});n(r)}})),setTimeout((function(){e.close()}))}));case 41:case"end":return n.stop()}}),n,null,[[2,24,28,38],[8,13],[29,,33,37]])})));return function(e){return n.apply(this,arguments)}}();return r},Uv=function(e,t){var n;t=null!==(n=t)&&void 0!==n?n:{};var r=function(e){e.binaryType="arraybuffer";var t,n=function(){var n=(0,u.Z)((0,s.Z)().mark((function n(){return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,new Promise((function(n,r){if(i)n();else if(null==t){var o=function(t){e.removeEventListener("open",a),e.removeEventListener("error",s),t()},a=function(){o(n)},s=function(t){o((function(){var n;r(null!==(n=t.error)&&void 0!==n?n:new Error("connect ECONNREFUSED ".concat(e.url)))}))};e.addEventListener("open",a),e.addEventListener("error",s)}else r(t)}));case 2:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}(),r=(0,g.Z)((0,s.Z)().mark((function t(){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=new Dv.zN((function(t){var n=t.push,r=t.stop,i=t.fail,o=function(e){var t=null;"string"===typeof e.data&&(t=Bv(e.data)),Mv(e.data)&&(t=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(t=e.data),null!=t&&n(t)},a=function(e){var t;i(null!==(t=e.error)&&void 0!==t?t:new Error("Socket error"))};return e.addEventListener("message",o),e.addEventListener("error",a),e.addEventListener("close",r),function(){e.removeEventListener("message",o),e.removeEventListener("error",a),e.removeEventListener("close",r)}}),{highWaterMark:1/0}),t.next=3,(0,m.Z)(n());case 3:i=!1,o=!1,t.prev=5,u=(0,y.Z)(r);case 7:return t.next=9,(0,m.Z)(u.next());case 9:if(!(i=!(c=t.sent).done)){t.next=16;break}return l=c.value,t.next=13,Mv(l)?new Uint8Array(l):l;case 13:i=!1,t.next=7;break;case 16:t.next=22;break;case 18:t.prev=18,t.t0=t.catch(5),o=!0,a=t.t0;case 22:if(t.prev=22,t.prev=23,!i||null==u.return){t.next=27;break}return t.next=27,(0,m.Z)(u.return());case 27:if(t.prev=27,!o){t.next=30;break}throw a;case 30:return t.finish(27);case 31:return t.finish(22);case 32:case"end":return t.stop()}}),t,null,[[5,18,22,32],[23,,27,31]])})))(),i=1===e.readyState;return e.addEventListener("open",(function(){i=!0,t=null})),e.addEventListener("close",(function(){i=!1,t=null})),e.addEventListener("error",(function(n){var r;i||(t=null!==(r=n.error)&&void 0!==r?r:new Error("connect ECONNREFUSED ".concat(e.url)))})),Object.assign(r,{connected:n})}(e),i=t.remoteAddress,o=t.remotePort;if(null!=e.url)try{var a=new URL(e.url);i=a.hostname,o=parseInt(a.port,10)}catch(l){}if(null==i||null==o)throw new Error("Remote connection did not have address and/or port");var c={sink:jv(e,t),source:r,connected:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.connected();case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),close:function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.readyState!==e.CONNECTING&&e.readyState!==e.OPEN){t.next=3;break}return t.next=3,new Promise((function(t){e.addEventListener("close",(function(){t()})),e.close()}));case 3:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),destroy:function(){null!=e.terminate?e.terminate():e.close()},remoteAddress:i,remotePort:o,socket:e};return c},zv=n(16791),Hv={http:"ws",https:"wss"};function Vv(e,t){var n;t=null!==(n=t)&&void 0!==n?n:{};var r=function(e,t){return(0,zv.relative)(e,t,Hv,"ws")}(e,("undefined"===typeof window?"":window.location).toString()),i=new Iv(r,t.websocket);return Uv(i,t)}var Gv=n(82193),Kv=n.n(Gv),Wv="object"===typeof window&&"object"===typeof document&&9===document.nodeType,qv=Kv()(),Yv=Wv&&!qv,Qv=qv&&!Wv,Xv=qv&&Wv,$v="undefined"!==typeof globalThis.process&&"undefined"!==typeof globalThis.process.release&&"node"===globalThis.process.release.name&&!qv,Jv="function"===typeof importScripts&&"undefined"!==typeof self&&"undefined"!==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,ey=("undefined"!==typeof globalThis.process&&"undefined"!==typeof globalThis.process.env&&globalThis.process.env.NODE_ENV,"undefined"!==typeof navigator&&"ReactNative"===navigator.product);function ty(e){return e.filter((function(e){if(e.protoCodes().includes(290))return!1;var t=e.decapsulateCode(421);return Fp.matches(t)||Up.matches(t)}))}var ny=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this,e)).name="TimeoutError",r}return(0,W.Z)(n)}((0,Ze.Z)(Error)),ry=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),(r=t.call(this)).name="AbortError",r.message=e,r}return(0,W.Z)(n)}((0,Ze.Z)(Error)),iy=function(e){return void 0===globalThis.DOMException?new ry(e):new DOMException(e)},oy=function(e){var t=void 0===e.reason?iy("This operation was aborted."):e.reason;return t instanceof Error?t:iy(t)};function ay(e,t){var n,r=t.milliseconds,i=t.fallback,o=t.message,a=t.customTimers,c=void 0===a?{setTimeout:setTimeout,clearTimeout:clearTimeout}:a,l=new Promise((function(a,l){if("number"!==typeof r||1!==Math.sign(r))throw new TypeError("Expected `milliseconds` to be a positive number, got `".concat(r,"`"));if(r!==Number.POSITIVE_INFINITY){if(t.signal){var f=t.signal;f.aborted&&l(oy(f)),f.addEventListener("abort",(function(){l(oy(f))}))}var h=new ny;n=c.setTimeout.call(void 0,(function(){if(i)try{a(i())}catch(t){l(t)}else"function"===typeof e.cancel&&e.cancel(),!1===o?a():o instanceof Error?l(o):(h.message=null!==o&&void 0!==o?o:"Promise timed out after ".concat(r," milliseconds"),l(h))}),r),(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.t0=a,t.next=4,e;case 4:t.t1=t.sent,(0,t.t0)(t.t1),t.next=11;break;case 8:t.prev=8,t.t2=t.catch(0),l(t.t2);case 11:return t.prev=11,c.clearTimeout.call(void 0,n),t.finish(11);case 14:case"end":return t.stop()}}),t,null,[[0,8,11,14]])})))()}else a(e)}));return l.clear=function(){c.clearTimeout.call(void 0,n),n=void 0},l}var sy,uy=(0,ru.kg)("libp2p:websockets:socket");function cy(e,t,n){var r,i={sink:function(t){return(0,u.Z)((0,s.Z)().mark((function r(){var i;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return null!=(null===(i=n)||void 0===i?void 0:i.signal)&&(t=du(t,n.signal)),r.prev=1,r.next=4,e.sink(t);case 4:r.next=9;break;case 6:r.prev=6,r.t0=r.catch(1),"aborted"!==r.t0.type&&uy.error(r.t0);case 9:case"end":return r.stop()}}),r,null,[[1,6]])})))()},source:null!=(n=null!==(r=n)&&void 0!==r?r:{}).signal?du(e.source,n.signal):e.source,remoteAddr:t,timeline:{open:Date.now()},close:function(){return(0,u.Z)((0,s.Z)().mark((function t(){var n,r,o,a;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=Date.now(),t.prev=1,t.next=4,ay(e.close(),{milliseconds:2e3});case 4:t.next=11;break;case 6:t.prev=6,t.t0=t.catch(1),r=i.remoteAddr.toOptions(),o=r.host,a=r.port,uy("timeout closing stream to %s:%s after %dms, destroying it manually",o,a,Date.now()-n),e.destroy();case 11:return t.prev=11,i.timeline.close=Date.now(),t.finish(11);case 14:case"end":return t.stop()}}),t,null,[[1,6,11,14]])})))()}};return e.socket.addEventListener("close",(function(){null==i.timeline.close&&(i.timeline.close=Date.now())}),{once:!0}),i}var ly=(0,ru.kg)("libp2p:websockets");sy=Symbol.toStringTag;var fy=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"init",void 0),(0,ot.Z)(this,sy,"@libp2p/websockets"),(0,ot.Z)(this,ul,!0),this.init=t}return(0,W.Z)(e,[{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return ly("dialing %s",t),n=null!==(r=n)&&void 0!==r?r:{},e.next=4,this._connect(t,n);case 4:return i=e.sent,o=cy(i,t),ly("new outbound connection %s",o.remoteAddr),e.next=9,n.upgrader.upgradeOutbound(o);case 9:return a=e.sent,ly("outbound connection %s upgraded",o.remoteAddr),e.abrupt("return",a);case 12:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_connect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!0!==(null===n||void 0===n||null===(r=n.signal)||void 0===r?void 0:r.aborted)){e.next=2;break}throw new ar._;case 2:if(i=t.toOptions(),ly("dialing %s:%s",i.host,i.port),o=Ut(),a=function(e){ly.error("connection error:",e),o.reject(e)},null!=(u=Vv((0,Cv.k)(t),this.init)).socket.on?u.socket.on("error",a):u.socket.onerror=a,null!=n.signal){e.next=13;break}return e.next=11,Promise.race([u.connected(),o.promise]);case 11:case 20:return ly("connected %s",t),e.abrupt("return",u);case 13:return l=new Promise((function(e,t){var r,i;c=function(){t(new ar._),u.close().catch((function(e){ly.error("error closing raw socket",e)}))},!0!==(null===n||void 0===n||null===(r=n.signal)||void 0===r?void 0:r.aborted)?null===n||void 0===n||null===(i=n.signal)||void 0===i||i.addEventListener("abort",c):c()})),e.prev=14,e.next=17,Promise.race([l,o.promise,u.connected()]);case 17:return e.prev=17,null!=c&&(null===n||void 0===n||null===(f=n.signal)||void 0===f||f.removeEventListener("abort",c)),e.finish(17);case 22:case"end":return e.stop()}}),e,this,[[14,,17,20]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"createListener",value:function(e){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}((0,Nt.Z)((0,Nt.Z)({},this.init),e))}},{key:"filter",value:function(e){var t,n;return e=Array.isArray(e)?e:[e],null!=(null===(t=this.init)||void 0===t?void 0:t.filter)?null===(n=this.init)||void 0===n?void 0:n.filter(e):Yv||Jv?function(e){return e.filter((function(e){if(e.protoCodes().includes(290))return!1;var t=e.decapsulateCode(421);return Up.matches(t)}))}(e):ty(e)}}]),e}();function hy(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(){return new fy(e)}}function py(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function dy(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?py(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function vy(e){return null!=e[Symbol.asyncIterator]}var yy=function e(t){var n=Ct.encodingLength(t),r=dy(n);return Ct.encode(t,r),e.bytes=n,r};function gy(e,t){var n,r,i=(0,s.Z)().mark(a),o=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:yy;function a(e){var t;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!((t=o(e.byteLength))instanceof Uint8Array)){n.next=6;break}return n.next=4,t;case 4:n.next=7;break;case 6:return n.delegateYield(t,"t0",7);case 7:if(!(e instanceof Uint8Array)){n.next=12;break}return n.next=10,e;case 10:n.next=13;break;case 12:return n.delegateYield(e,"t1",13);case 13:case"end":return n.stop()}}),i)}return vy(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=12;break}return c=u.value,t.delegateYield((0,at.Z)((0,y.Z)(a(c)),m.Z),"t0",9);case 9:n=!1,t.next=4;break;case 12:t.next=18;break;case 14:t.prev=14,t.t1=t.catch(2),r=!0,i=t.t1;case 18:if(t.prev=18,t.prev=19,!n||null==o.return){t.next=23;break}return t.next=23,(0,m.Z)(o.return());case 23:if(t.prev=23,!r){t.next=26;break}throw i;case 26:return t.finish(23);case 27:return t.finish(18);case 28:case"end":return t.stop()}}),t,null,[[2,14,18,28],[19,,23,27]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=8;break}return i=r.value,t.delegateYield(a(i),"t0",6);case 6:t.next=3;break;case 8:t.next=13;break;case 10:t.prev=10,t.t1=t.catch(1),n.e(t.t1);case 13:return t.prev=13,n.f(),t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[1,10,13,16]])}))()}yy.bytes=0,gy.single=function(e,t){var n,r,i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:yy;return new vt(i(e.byteLength),e)};var my;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(my||(my={}));var by=function e(t){var n=Ct.decode(t);return e.bytes=Ct.encodingLength(n),n};function wy(e,t){var n,r,i,o=(0,s.Z)().mark(p),a=new vt,u=my.LENGTH,c=-1,l=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:by,f=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,h=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function p(){var e,n;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!(a.byteLength>0)){r.next=32;break}if(u!==my.LENGTH){r.next=21;break}if(r.prev=2,!((c=l(a))<0)){r.next=6;break}throw Mt()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");case 6:if(!(c>h)){r.next=8;break}throw Mt()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");case 8:e=l.bytes,a.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(c),u=my.DATA,r.next=21;break;case 14:if(r.prev=14,r.t0=r.catch(2),!(r.t0 instanceof RangeError)){r.next=20;break}if(!(a.byteLength>f)){r.next=19;break}throw Mt()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");case 19:return r.abrupt("break",32);case 20:throw r.t0;case 21:if(u!==my.DATA){r.next=30;break}if(!(a.byteLength<c)){r.next=24;break}return r.abrupt("break",32);case 24:return n=a.sublist(0,c),a.consume(c),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(n),r.next=29,n;case 29:u=my.LENGTH;case 30:r.next=0;break;case 32:case"end":return r.stop()}}),o,null,[[2,14]])}return vy(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=13;break}return c=u.value,a.append(c),t.delegateYield((0,at.Z)((0,y.Z)(p()),m.Z),"t0",10);case 10:n=!1,t.next=4;break;case 13:t.next=19;break;case 15:t.prev=15,t.t1=t.catch(2),r=!0,i=t.t1;case 19:if(t.prev=19,t.prev=20,!n||null==o.return){t.next=24;break}return t.next=24,(0,m.Z)(o.return());case 24:if(t.prev=24,!r){t.next=27;break}throw i;case 27:return t.finish(24);case 28:return t.finish(19);case 29:if(!(a.byteLength>0)){t.next=31;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 31:case"end":return t.stop()}}),t,null,[[2,15,19,29],[20,,24,28]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=9;break}return i=r.value,a.append(i),t.delegateYield(p(),"t0",7);case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t1=t.catch(1),n.e(t.t1);case 14:return t.prev=14,n.f(),t.finish(14);case 17:if(!(a.byteLength>0)){t.next=19;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 19:case"end":return t.stop()}}),t,null,[[1,11,14,17]])}))()}by.bytes=0,wy.fromReader=function(e,t){var n=1;return wy((0,g.Z)((0,s.Z)().mark((function t(){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=1,t.next=4,(0,m.Z)(e.next(n));case 4:if(r=t.sent,i=r.done,o=r.value,!0!==i){t.next=9;break}return t.abrupt("return");case 9:if(null==o){t.next=12;break}return t.next=12,o;case 12:t.next=19;break;case 14:if(t.prev=14,t.t0=t.catch(1),"ERR_UNDER_READ"!==t.t0.code){t.next=18;break}return t.abrupt("return",{done:!0,value:null});case 18:throw t.t0;case 19:return t.prev=19,n=1,t.finish(19);case 22:t.next=0;break;case 24:case"end":return t.stop()}}),t,null,[[1,14,19,22]])})))(),(0,Nt.Z)((0,Nt.Z)({},null!==t&&void 0!==t?t:{}),{},{onLength:function(e){n=e}}))};var ky=function(){function e(t){if((0,K.Z)(this,e),!(t>0)||0!==(t-1&t))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}return(0,W.Z)(e,[{key:"push",value:function(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}},{key:"shift",value:function(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}},{key:"isEmpty",value:function(){return void 0===this.buffer[this.btm]}}]),e}(),Ey=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.hwm=null!==(t=n.splitLimit)&&void 0!==t?t:16,this.head=new ky(this.hwm),this.tail=this.head,this.size=0}return(0,W.Z)(e,[{key:"calculateSize",value:function(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}},{key:"push",value:function(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){var t=this.head;this.head=t.next=new ky(2*this.head.buffer.length),this.head.push(e)}}},{key:"shift",value:function(){var e,t=this.tail.shift();if(void 0===t&&null!=this.tail.next){var n=this.tail.next;this.tail.next=null,this.tail=n,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}},{key:"isEmpty",value:function(){return this.head.isEmpty()}}]),e}();function xy(){return _y((function(e){var t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function _y(e,t){var n,r,i,o,a,c,l=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,f=new Ey,h=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(f.isEmpty()){t.next=2;break}return t.abrupt("return",e(f));case 2:if(!c){t.next=4;break}return t.abrupt("return",{done:!0});case 4:return t.next=6,new Promise((function(t,n){a=function(r){a=null,f.push(r);try{t(e(f))}catch(i){n(i)}return o}}));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e){return null!=a?a(e):(f.push(e),o)},d=function(e){var n;if(c)return o;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:e})},v=function(e){return c?o:(c=!0,null!=e?function(e){return f=new Ey,null!=a?a({error:e}):(f.push({error:e}),o)}(e):p({done:!0}))};if(r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(r,"next",h),(0,ot.Z)(r,"return",(function(){return f=new Ey,v(),{done:!0}})),(0,ot.Z)(r,"throw",(function(e){return v(e),{done:!0}})),(0,ot.Z)(r,"push",d),(0,ot.Z)(r,"end",v),Xt("get",r,"readableLength",(function(){return f.size})),o=r,null==l)return o;var y=o;return i={},(0,ot.Z)(i,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(i,"next",(function(){return y.next()})),(0,ot.Z)(i,"throw",(function(e){return y.throw(e),null!=l&&(l(e),l=void 0),{done:!0}})),(0,ot.Z)(i,"return",(function(){return y.return(),null!=l&&(l(),l=void 0),{done:!0}})),(0,ot.Z)(i,"push",d),(0,ot.Z)(i,"end",(function(e){return y.end(e),null!=l&&(l(e),l=void 0),o})),Xt("get",i,"readableLength",(function(){return y.readableLength})),o=i}var Sy=function(e){return Ct.decode(e)};function Ay(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=xy();e.sink(n).catch((function(e){n.end(e)})),e.sink=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,i=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(r=!(u=e.sent).done)){e.next=12;break}c=u.value,n.push(c);case 9:r=!1,e.next=4;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(2),i=!0,o=e.t0;case 18:if(e.prev=18,e.prev=19,!r||null==a.return){e.next=23;break}return e.next=23,a.return();case 23:if(e.prev=23,!i){e.next=26;break}throw o;case 26:return e.finish(23);case 27:return e.finish(18);case 28:case"end":return e.stop()}}),e,null,[[2,14,18,28],[19,,23,27]])})));return function(t){return e.apply(this,arguments)}}();var r=e.source;null!=e.source[Symbol.iterator]?r=e.source[Symbol.iterator]():null!=e.source[Symbol.asyncIterator]&&(r=e.source[Symbol.asyncIterator]());var i=new vt,o={read:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=9;break}return e.next=3,r.next();case 3:if(n=e.sent,o=n.done,a=n.value,!0!==o){e.next=8;break}return e.abrupt("return",new vt);case 8:return e.abrupt("return",a);case 9:if(!(i.byteLength<t)){e.next=20;break}return e.next=12,r.next();case 12:if(u=e.sent,c=u.value,!0!==u.done){e.next=17;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 17:i.append(c),e.next=9;break;case 20:return l=i.sublist(0,t),i.consume(t),e.abrupt("return",l);case 23:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),readLP:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var n,r,i,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=-1,i=new vt,a=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:Sy;case 3:return e.t0=i,e.next=7,o.read(1);case 7:e.t1=e.sent,e.t0.append.call(e.t0,e.t1),e.prev=9,r=a(i),e.next=18;break;case 13:if(e.prev=13,e.t2=e.catch(9),!(e.t2 instanceof RangeError)){e.next=17;break}return e.abrupt("continue",3);case 17:throw e.t2;case 18:if(!(r>-1)){e.next=20;break}return e.abrupt("break",24);case 20:if(!(null!=(null===t||void 0===t?void 0:t.maxLengthLength)&&i.byteLength>t.maxLengthLength)){e.next=22;break}throw Mt()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");case 22:e.next=3;break;case 24:if(!(null!=(null===t||void 0===t?void 0:t.maxDataLength)&&r>t.maxDataLength)){e.next=26;break}throw Mt()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");case 26:return e.next=28,o.read(r);case 28:return e.abrupt("return",e.sent);case 29:case"end":return e.stop()}}),e,null,[[9,13]])})));return function(){return e.apply(this,arguments)}}(),readPB:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.readLP();case 2:if(null!=(n=e.sent)){e.next=5;break}throw new Error("Value is null");case 5:return r=n instanceof Uint8Array?n:n.subarray(),e.abrupt("return",t.decode(r));case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),write:function(e){e instanceof Uint8Array?n.push(e):n.push(e.subarray())},writeLP:function(e){o.write(gy.single(e,t))},writePB:function(e,t){o.writeLP(t.encode(e))},pb:function(e){return{read:function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o.readPB(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),write:function(t){o.writePB(t,e)},unwrap:function(){return o}}},unwrap:function(){var t=e.source;return e.source=(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(i),m.Z),"t0",1);case 1:return e.delegateYield((0,at.Z)((0,y.Z)(t),m.Z),"t1",2);case 2:case"end":return e.stop()}}),e)})))(),e}};return o}function Zy(){var e=Ut(),t=!1;return{sink:function(){var n=(0,u.Z)((0,s.Z)().mark((function n(r){return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!t){n.next=2;break}throw new Error("already piped");case 2:t=!0,e.resolve(r);case 4:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),source:(0,g.Z)((0,s.Z)().mark((function t(){var n;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,m.Z)(e.promise);case 2:return n=t.sent,t.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",4);case 4:case"end":return t.stop()}}),t)})))()}}function Ty(){var e=Zy(),t=Zy();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}function Cy(){return Cy=(0,g.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=o.length,n=new Array(t),r=0;r<t;r++)n[r]=o[r];return i=xy({objectMode:!0}),Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(n.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!1,r=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(n=!(u=e.sent).done)){e.next=12;break}c=u.value,i.push(c);case 9:n=!1,e.next=4;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(2),r=!0,o=e.t0;case 18:if(e.prev=18,e.prev=19,!n||null==a.return){e.next=23;break}return e.next=23,a.return();case 23:if(e.prev=23,!r){e.next=26;break}throw o;case 26:return e.finish(23);case 27:return e.finish(18);case 28:case"end":return e.stop()}}),e,null,[[2,14,18,28],[19,,23,27]])})));return function(t){return e.apply(this,arguments)}}()));case 3:i.end(),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),i.end(e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))),e.delegateYield((0,at.Z)((0,y.Z)(i),m.Z),"t0",4);case 4:case"end":return e.stop()}}),e)}))),Cy.apply(this,arguments)}Sy.bytes=0;var Iy=function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},Dy=function(e){return null!=e&&("function"===typeof e[Symbol.asyncIterator]||"function"===typeof e[Symbol.iterator]||"function"===typeof e.next)},Oy=function(e){return null!=e&&"function"===typeof e.sink&&Dy(e.source)},Ry=function(e){return function(t){var n=e.sink(t);if(null!=n.then){var r=xy({objectMode:!0});n.then((function(){r.end()}),(function(e){r.end(e)}));var i=function(){var t=(0,g.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.delegateYield((0,at.Z)((0,y.Z)(e.source),m.Z),"t0",1);case 1:r.end();case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return function(){return Cy.apply(this,arguments)}(r,i())}return e.source}};function Py(e){if(Oy(e)){var t=e;e=function(){return t.source}}else if(Dy(e)){var n=e;e=function(){return n}}for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];var a=[e].concat(i);if(a.length>1&&Oy(a[a.length-1])&&(a[a.length-1]=a[a.length-1].sink),a.length>2)for(var s=1;s<a.length-1;s++)Oy(a[s])&&(a[s]=Ry(a[s]));return Iy.apply(void 0,(0,ye.Z)(a))}var Ly=function e(t){var n=Ct.encodingLength(t),r=function(e){var t;return null!=(null===globalThis||void 0===globalThis||null===(t=globalThis.Buffer)||void 0===t?void 0:t.allocUnsafe)?globalThis.Buffer.allocUnsafe(e):new Uint8Array(e)}(n);return Ct.encode(t,r),e.bytes=n,r};Ly.bytes=0;var Ny;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(Ny||(Ny={}));var By,My,Fy=function e(t){var n=Ct.decode(t);return e.bytes=Ct.encodingLength(n),n};function jy(e){var t=function(){var t=(0,g.Z)((0,s.Z)().mark((function t(n){var r,i,o,a,u,c,l,f,h,p,d,v,g,b,w,k,E;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=new vt,u=Ny.LENGTH,c=-1,l=null!==(r=null===e||void 0===e?void 0:e.lengthDecoder)&&void 0!==r?r:Fy,f=null!==(i=null===e||void 0===e?void 0:e.maxLengthLength)&&void 0!==i?i:8,h=null!==(o=null===e||void 0===e?void 0:e.maxDataLength)&&void 0!==o?o:4194304,p=!1,d=!1,t.prev=8,g=(0,y.Z)(n);case 10:return t.next=12,(0,m.Z)(g.next());case 12:if(!(p=!(b=t.sent).done)){t.next=50;break}w=b.value,a.append(w);case 15:if(!(a.byteLength>0)){t.next=47;break}if(u!==Ny.LENGTH){t.next=36;break}if(t.prev=17,!((c=l(a))<0)){t.next=21;break}throw Mt()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");case 21:if(!(c>h)){t.next=23;break}throw Mt()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");case 23:k=l.bytes,a.consume(k),null!=(null===e||void 0===e?void 0:e.onLength)&&e.onLength(c),u=Ny.DATA,t.next=36;break;case 29:if(t.prev=29,t.t0=t.catch(17),!(t.t0 instanceof RangeError)){t.next=35;break}if(!(a.byteLength>f)){t.next=34;break}throw Mt()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");case 34:return t.abrupt("break",47);case 35:throw t.t0;case 36:if(u!==Ny.DATA){t.next=45;break}if(!(a.byteLength<c)){t.next=39;break}return t.abrupt("break",47);case 39:return E=a.sublist(0,c),a.consume(c),null!=(null===e||void 0===e?void 0:e.onData)&&e.onData(E),t.next=44,E;case 44:u=Ny.LENGTH;case 45:t.next=15;break;case 47:p=!1,t.next=10;break;case 50:t.next=56;break;case 52:t.prev=52,t.t1=t.catch(8),d=!0,v=t.t1;case 56:if(t.prev=56,t.prev=57,!p||null==g.return){t.next=61;break}return t.next=61,(0,m.Z)(g.return());case 61:if(t.prev=61,!d){t.next=64;break}throw v;case 64:return t.finish(61);case 65:return t.finish(56);case 66:if(!(a.byteLength>0)){t.next=68;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 68:case"end":return t.stop()}}),t,null,[[8,52,56,66],[17,29],[57,,61,65]])})));return function(e){return t.apply(this,arguments)}}();return t}Fy.bytes=0,jy.fromReader=function(e,t){var n=1,r=(0,g.Z)((0,s.Z)().mark((function t(){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=1,t.next=4,(0,m.Z)(e.next(n));case 4:if(r=t.sent,i=r.done,o=r.value,!0!==i){t.next=9;break}return t.abrupt("return");case 9:if(null==o){t.next=12;break}return t.next=12,o;case 12:t.next=19;break;case 14:if(t.prev=14,t.t0=t.catch(1),"ERR_UNDER_READ"!==t.t0.code){t.next=18;break}return t.abrupt("return",{done:!0,value:null});case 18:throw t.t0;case 19:return t.prev=19,n=1,t.finish(19);case 22:t.next=0;break;case 24:case"end":return t.stop()}}),t,null,[[1,14,19,22]])})))();return jy((0,Nt.Z)((0,Nt.Z)({},null!==t&&void 0!==t?t:{}),{},{onLength:function(e){n=e}}))(r)};var Uy=65535,zy=Boolean(null===(By=globalThis.process)||void 0===By||null===(My=By.env)||void 0===My?void 0:My.DUMP_SESSION_KEYS),Hy=n(52497),Vy=n(24888),Gy={hashSHA256:function(e){return(0,Vy.vp)(e)},getHKDF:function(e,t){var n=new Hy.t(Vy.mE,t,e).expand(96);return[n.subarray(0,32),n.subarray(32,64),n.subarray(64,96)]},generateX25519KeyPair:function(){var e=Hn.Au();return{publicKey:e.publicKey,privateKey:e.secretKey}},generateX25519KeyPairFromSeed:function(e){var t=Hn._w(e);return{publicKey:t.publicKey,privateKey:t.secretKey}},generateX25519SharedKey:function(e,t){return Hn.gi(e,t)},chaCha20Poly1305Encrypt:function(e,t,n,r){return new zn.OK(r).seal(t,e,n)},chaCha20Poly1305Decrypt:function(e,t,n,r,i){return new zn.OK(r).open(t,e,n,i)}};function Ky(e,t){null==t&&(t=e.reduce((function(e,t){return e+t.length}),0));var n,r=dy(t),i=0,o=(0,Ae.Z)(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;r.set(a,i),i+=a.length}}catch(s){o.e(s)}finally{o.f()}return py(r)}var Wy=function(e){var t,n=(t=2,globalThis.Buffer?globalThis.Buffer.allocUnsafe(t):new Uint8Array(t));return new DataView(n.buffer,n.byteOffset,n.byteLength).setUint16(0,e,!1),n};Wy.bytes=2;var qy=function(e){if(e.length<2)throw RangeError("Could not decode int16BE");return e instanceof Uint8Array?new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1):e.getUint16(0)};function Yy(e){return Ky([e.ne,e.ciphertext],e.ne.length+e.ciphertext.length)}function Qy(e){return Ky([e.ne,e.ns,e.ciphertext],e.ne.length+e.ns.length+e.ciphertext.length)}function Xy(e){return Ky([e.ns,e.ciphertext],e.ns.length+e.ciphertext.length)}function $y(e){if(e.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:e.subarray(0,32),ciphertext:e.subarray(32,e.length),ns:new Uint8Array(0)}}function Jy(e){if(e.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:e.subarray(0,32),ns:e.subarray(32,80),ciphertext:e.subarray(80,e.length)}}function eg(e){if(e.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:e.subarray(0,48),ciphertext:e.subarray(48,e.length)}}function tg(e,t){return function(){var n=(0,g.Z)((0,s.Z)().mark((function n(r){var i,o,a,u,c,l,f,h,p;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:i=!1,o=!1,n.prev=2,u=(0,y.Z)(r);case 4:return n.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=n.sent).done)){n.next=24;break}l=c.value,f=0;case 9:if(!(f<l.length)){n.next=21;break}return(h=f+65519)>l.length&&(h=l.length),p=e.encrypt(l.subarray(f,h),e.session),null===t||void 0===t||t.encryptedPackets.increment(),n.next=16,Wy(p.byteLength);case 16:return n.next=18,p;case 18:f+=65519,n.next=9;break;case 21:i=!1,n.next=4;break;case 24:n.next=30;break;case 26:n.prev=26,n.t0=n.catch(2),o=!0,a=n.t0;case 30:if(n.prev=30,n.prev=31,!i||null==u.return){n.next=35;break}return n.next=35,(0,m.Z)(u.return());case 35:if(n.prev=35,!o){n.next=38;break}throw a;case 38:return n.finish(35);case 39:return n.finish(30);case 40:case"end":return n.stop()}}),n,null,[[2,26,30,40],[31,,35,39]])})));return function(e){return n.apply(this,arguments)}}()}function ng(e,t){return function(){var n=(0,g.Z)((0,s.Z)().mark((function n(r){var i,o,a,u,c,l,f,h,p,d,v,g;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:i=!1,o=!1,n.prev=2,u=(0,y.Z)(r);case 4:return n.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=n.sent).done)){n.next=29;break}l=c.value,f=0;case 9:if(!(f<l.length)){n.next=26;break}if((h=f+Uy)>l.length&&(h=l.length),!(h-zn.pg<f)){n.next=14;break}throw new Error("Invalid chunk");case 14:if(p=l.subarray(f,h),d=l.subarray(f,h-zn.pg),v=e.decrypt(p,e.session,d),g=v.plaintext,v.valid){n.next=20;break}throw null===t||void 0===t||t.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");case 20:return null===t||void 0===t||t.decryptedPackets.increment(),n.next=23,g;case 23:f+=Uy,n.next=9;break;case 26:i=!1,n.next=4;break;case 29:n.next=35;break;case 31:n.prev=31,n.t0=n.catch(2),o=!0,a=n.t0;case 35:if(n.prev=35,n.prev=36,!i||null==u.return){n.next=40;break}return n.next=40,(0,m.Z)(u.return());case 40:if(n.prev=40,!o){n.next=43;break}throw a;case 43:return n.finish(40);case 44:return n.finish(35);case 45:case"end":return n.stop()}}),n,null,[[2,31,35,45],[36,,40,44]])})));return function(e){return n.apply(this,arguments)}}()}qy.bytes=2;var rg=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer";return(0,K.Z)(this,n),(e=t.call(this,r)).code=n.code,e}return(0,W.Z)(n,null,[{key:"code",get:function(){return"ERR_UNEXPECTED_PEER"}}]),n}((0,Ze.Z)(Error)),ig=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange";return(0,K.Z)(this,n),(e=t.call(this,r)).code=n.code,e}return(0,W.Z)(n,null,[{key:"code",get:function(){return"ERR_INVALID_CRYPTO_EXCHANGE"}}]),n}((0,Ze.Z)(Error));function og(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var ag,sg,ug=og("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),cg=og("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=dy((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),lg=(0,Nt.Z)({utf8:ug,"utf-8":ug,hex:cr.gh.base16,latin1:cg,ascii:cg,binary:cg},cr.gh);function fg(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=lg[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):py(globalThis.Buffer.from(e,"utf-8"))}function hg(e,t,n){return pg.apply(this,arguments)}function pg(){return(pg=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,vg(t,wg(n));case 2:if(i=e.sent,null!=t.publicKey){e.next=5;break}throw new Error("PublicKey was missing from local PeerId");case 5:return e.abrupt("return",dg(t.publicKey,i,r));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function dg(e,t,n){return sg.encode({identityKey:e,identitySig:t,extensions:null!==n&&void 0!==n?n:{webtransportCerthashes:[]}}).subarray()}function vg(e,t){return yg.apply(this,arguments)}function yg(){return(yg=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.privateKey){e.next=2;break}throw new Error("PrivateKey was missing from PeerId");case 2:return e.next=4,Cs(t.privateKey);case 4:return r=e.sent,e.next=7,r.sign(n);case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function gg(e){return mg.apply(this,arguments)}function mg(){return(mg=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,Ps.y5)(t.identityKey);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function bg(e){return sg.decode(e)}function wg(e){var t=fg("noise-libp2p-static-key:");return Ky([t,e],t.length+e.length)}function kg(e,t,n){return Eg.apply(this,arguments)}function Eg(){return(Eg=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,Ps.y5)(n.identityKey);case 2:if((i=e.sent).equals(r)){e.next=5;break}throw new Error("Payload identity key ".concat(i.toString()," does not match expected remote peer ").concat(r.toString()));case 5:if(o=wg(t),null!=i.publicKey){e.next=8;break}throw new Error("PublicKey was missing from PeerId");case 8:if(null!=n.identitySig){e.next=10;break}throw new Error("Signature was missing from message");case 10:return a=Zs(i.publicKey),e.next=13,a.verify(o,n.identitySig);case 13:if(e.sent){e.next=16;break}throw new Error("Static key doesn't match to peer that signed payload!");case 16:return e.abrupt("return",i);case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function xg(e){return e instanceof Uint8Array&&32===e.length}function _g(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=lg[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}!function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes){var r,i=(0,Ae.Z)(e.webtransportCerthashes);try{for(i.s();!(r=i.n()).done;){var o=r.value;t.uint32(10),t.bytes(o)}}catch(a){i.e(a)}finally{i.f()}}!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={webtransportCerthashes:[]},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();if(i>>>3===1)n.webtransportCerthashes.push(e.bytes());else e.skipType(7&i)}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(ag||(ag={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n,r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(!1!==i.lengthDelimited&&t.fork(),!0===i.writeDefaults||null!=e.identityKey&&e.identityKey.byteLength>0)&&(t.uint32(10),t.bytes(null!==(n=e.identityKey)&&void 0!==n?n:new Uint8Array(0)));(!0===i.writeDefaults||null!=e.identitySig&&e.identitySig.byteLength>0)&&(t.uint32(18),t.bytes(null!==(r=e.identitySig)&&void 0!==r?r:new Uint8Array(0)));null!=e.extensions&&(t.uint32(34),ag.codec().encode(e.extensions,t,{writeDefaults:!1})),!1!==i.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.identityKey=e.bytes();break;case 2:n.identitySig=e.bytes();break;case 4:n.extensions=ag.codec().decode(e,e.uint32());break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(sg||(sg={}));var Sg,Ag=(0,ru.kg)("libp2p:noise");function Zg(e){e?(Sg("LOCAL_PUBLIC_EPHEMERAL_KEY ".concat(_g(e.publicKey,"hex"))),Sg("LOCAL_PRIVATE_EPHEMERAL_KEY ".concat(_g(e.privateKey,"hex")))):Sg("Missing local ephemeral keys.")}function Tg(e){Sg("REMOTE_EPHEMERAL_PUBLIC_KEY ".concat(_g(e,"hex")))}Sg=zy?Ag:Object.assign((function(){}),{enabled:!1,trace:function(){},error:function(){}});var Cg=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,K.Z)(this,e),this.n=t,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,t,!0)}return(0,W.Z)(e,[{key:"increment",value:function(){this.n++,this.view.setUint32(4,this.n,!0)}},{key:"getBytes",value:function(){return this.bytes}},{key:"getUint64",value:function(){return this.n}},{key:"assertValue",value:function(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}]),e}(),Ig=function(){function e(t){(0,K.Z)(this,e),this.crypto=t}return(0,W.Z)(e,[{key:"encryptWithAd",value:function(e,t,n){var r=this.encrypt(e.k,e.n,t,n);return e.n.increment(),r}},{key:"decryptWithAd",value:function(e,t,n,r){var i=this.decrypt(e.k,e.n,t,n,r),o=i.plaintext,a=i.valid;return a&&e.n.increment(),{plaintext:o,valid:a}}},{key:"hasKey",value:function(e){return!this.isEmptyKey(e.k)}},{key:"createEmptyKey",value:function(){return new Uint8Array(32)}},{key:"isEmptyKey",value:function(e){return function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}(this.createEmptyKey(),e)}},{key:"encrypt",value:function(e,t,n,r){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(r,t.getBytes(),n,e)}},{key:"encryptAndHash",value:function(e,t){var n;return n=this.hasKey(e.cs)?this.encryptWithAd(e.cs,e.h,t):t,this.mixHash(e,n),n}},{key:"decrypt",value:function(e,t,n,r,i){t.assertValue();var o=this.crypto.chaCha20Poly1305Decrypt(r,t.getBytes(),n,e,i);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}},{key:"decryptAndHash",value:function(e,t){var n,r=!0;if(this.hasKey(e.cs)){var i=this.decryptWithAd(e.cs,e.h,t);n=i.plaintext,r=i.valid}else n=t;return this.mixHash(e,t),{plaintext:n,valid:r}}},{key:"dh",value:function(e,t){try{var n=this.crypto.generateX25519SharedKey(e,t);return 32===n.length?n:n.subarray(0,32)}catch(i){var r=i;return Ag.error(r),new Uint8Array(32)}}},{key:"mixHash",value:function(e,t){e.h=this.getHash(e.h,t)}},{key:"getHash",value:function(e,t){return this.crypto.hashSHA256(Ky([e,t],e.length+t.length))}},{key:"mixKey",value:function(e,t){var n=this.crypto.getHKDF(e.ck,t),r=(0,k.Z)(n,2),i=r[0],o=r[1];e.cs=this.initializeKey(o),e.ck=i}},{key:"initializeKey",value:function(e){return{k:e,n:new Cg}}},{key:"initializeSymmetric",value:function(e){var t=fg(e,"utf-8"),n=this.hashProtocolName(t),r=n,i=this.createEmptyKey();return{cs:this.initializeKey(i),ck:r,h:n}}},{key:"hashProtocolName",value:function(e){if(e.length<=32){var t=new Uint8Array(32);return t.set(e),t}return this.getHash(e,new Uint8Array(0))}},{key:"split",value:function(e){var t=this.crypto.getHKDF(e.ck,new Uint8Array(0)),n=(0,k.Z)(t,2),r=n[0],i=n[1];return{cs1:this.initializeKey(r),cs2:this.initializeKey(i)}}},{key:"writeMessageRegular",value:function(e,t){var n=this.encryptWithAd(e,new Uint8Array(0),t);return{ne:this.createEmptyKey(),ns:new Uint8Array(0),ciphertext:n}}},{key:"readMessageRegular",value:function(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}}]),e}(),Dg=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){return(0,K.Z)(this,n),t.apply(this,arguments)}return(0,W.Z)(n,[{key:"initializeInitiator",value:function(e,t,n,r){var i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");return this.mixHash(i,e),{ss:i,s:t,rs:n,psk:r,re:new Uint8Array(32)}}},{key:"initializeResponder",value:function(e,t,n,r){var i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");return this.mixHash(i,e),{ss:i,s:t,rs:n,psk:r,re:new Uint8Array(32)}}},{key:"writeMessageA",value:function(e,t,n){var r=new Uint8Array(0);e.e=void 0!==n?n:this.crypto.generateX25519KeyPair();var i=e.e.publicKey;return this.mixHash(e.ss,i),{ne:i,ns:r,ciphertext:this.encryptAndHash(e.ss,t)}}},{key:"writeMessageB",value:function(e,t){e.e=this.crypto.generateX25519KeyPair();var n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));var r=e.s.publicKey,i=this.encryptAndHash(e.ss,r);return this.mixKey(e.ss,this.dh(e.s.privateKey,e.re)),{ne:n,ns:i,ciphertext:this.encryptAndHash(e.ss,t)}}},{key:"writeMessageC",value:function(e,t){var n=e.s.publicKey,r=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));var i=this.encryptAndHash(e.ss,t),o={ne:this.createEmptyKey(),ns:r,ciphertext:i},a=this.split(e.ss),s=a.cs1,u=a.cs2;return{h:e.ss.h,messageBuffer:o,cs1:s,cs2:u}}},{key:"readMessageA",value:function(e,t){return xg(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}},{key:"readMessageB",value:function(e,t){if(xg(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));var n=this.decryptAndHash(e.ss,t.ns),r=n.plaintext,i=n.valid;i&&xg(r)&&(e.rs=r),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));var o=this.decryptAndHash(e.ss,t.ciphertext),a=o.plaintext,s=o.valid;return{plaintext:a,valid:i&&s}}},{key:"readMessageC",value:function(e,t){var n=this.decryptAndHash(e.ss,t.ns),r=n.plaintext,i=n.valid;if(i&&xg(r)&&(e.rs=r),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));var o=this.decryptAndHash(e.ss,t.ciphertext),a=o.plaintext,s=o.valid,u=this.split(e.ss),c=u.cs1,l=u.cs2;return{h:e.ss.h,plaintext:a,valid:i&&s,cs1:c,cs2:l}}},{key:"initSession",value:function(e,t,n){var r=this.createEmptyKey(),i=new Uint8Array(32);return{hs:e?this.initializeInitiator(t,n,i,r):this.initializeResponder(t,n,i,r),i:e,mc:0}}},{key:"sendMessage",value:function(e,t,n){var r;if(0===e.mc)r=this.writeMessageA(e.hs,t,n);else if(1===e.mc)r=this.writeMessageB(e.hs,t);else if(2===e.mc){var i=this.writeMessageC(e.hs,t),o=i.h,a=i.messageBuffer,s=i.cs1,u=i.cs2;r=a,e.h=o,e.cs1=s,e.cs2=u}else{if(!(e.mc>2))thr