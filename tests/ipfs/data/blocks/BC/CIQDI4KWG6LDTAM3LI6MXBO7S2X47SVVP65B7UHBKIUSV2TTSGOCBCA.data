ow new Error("Session invalid.");if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");r=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");r=this.writeMessageRegular(e.cs2,t)}}return e.mc++,r}},{key:"recvMessage",value:function(e,t){var n=new Uint8Array(0),r=!1;if(0===e.mc){var i=this.readMessageA(e.hs,t);n=i.plaintext,r=i.valid}else if(1===e.mc){var o=this.readMessageB(e.hs,t);n=o.plaintext,r=o.valid}else if(2===e.mc){var a=this.readMessageC(e.hs,t),s=a.h,u=a.plaintext,c=a.valid,l=a.cs1,f=a.cs2;n=u,r=c,e.h=s,e.cs1=l,e.cs2=f}return e.mc++,{plaintext:n,valid:r}}}]),n}(Ig),Og=function(){function e(t,n,r,i,o,a,s,u){(0,K.Z)(this,e),this.remoteExtensions={webtransportCerthashes:[]},this.isInitiator=t,this.payload=n,this.prologue=r,this.staticKeypair=o,this.connection=a,s&&(this.remotePeer=s),this.xx=null!==u&&void 0!==u?u:new Dg(i),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}return(0,W.Z)(e,[{key:"propose",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.session.hs.s,Sg("LOCAL_STATIC_PUBLIC_KEY ".concat(_g(i.publicKey,"hex"))),Sg("LOCAL_STATIC_PRIVATE_KEY ".concat(_g(i.privateKey,"hex"))),!this.isInitiator){e.next=9;break}Ag.trace("Stage 0 - Initiator starting to send first message."),t=this.xx.sendMessage(this.session,new Uint8Array(0)),this.connection.writeLP(Yy(t)),Ag.trace("Stage 0 - Initiator finished sending first message."),Zg(this.session.hs.e),e.next=20;break;case 9:return Ag.trace("Stage 0 - Responder waiting to receive first message..."),e.t0=$y,e.next=13,this.connection.readLP();case 13:if(e.t1=e.sent.subarray(),n=(0,e.t0)(e.t1),r=this.xx.recvMessage(this.session,n),r.valid){e.next=18;break}throw new ig("xx handshake stage 0 validation fail");case 18:Ag.trace("Stage 0 - Responder received first message."),Tg(this.session.hs.re);case 20:case"end":return e.stop()}var i}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"exchange",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isInitiator){e.next=34;break}return Ag.trace("Stage 1 - Initiator waiting to receive first message from responder..."),e.t0=Jy,e.next=5,this.connection.readLP();case 5:if(e.t1=e.sent.subarray(),t=(0,e.t0)(e.t1),n=this.xx.recvMessage(this.session,t),r=n.plaintext,n.valid){e.next=10;break}throw new ig("xx handshake stage 1 validation fail");case 10:if(Ag.trace("Stage 1 - Initiator received the message."),Tg(this.session.hs.re),s=this.session.hs.rs,Sg("REMOTE_STATIC_PUBLIC_KEY ".concat(_g(s,"hex"))),Ag.trace("Initiator going to check remote's signature..."),e.prev=14,i=bg(r),e.t2=this.remotePeer,e.t2){e.next=21;break}return e.next=20,gg(i);case 20:e.t2=e.sent;case 21:return this.remotePeer=e.t2,e.next=24,kg(this.session.hs.rs,i,this.remotePeer);case 24:this.setRemoteNoiseExtension(i.extensions),e.next=31;break;case 27:throw e.prev=27,e.t3=e.catch(14),o=e.t3,new rg("Error occurred while verifying signed payload: ".concat(o.message));case 31:Ag.trace("All good with the signature!"),e.next=39;break;case 34:Ag.trace("Stage 1 - Responder sending out first message with signed payload and static key."),a=this.xx.sendMessage(this.session,this.payload),this.connection.writeLP(Qy(a)),Ag.trace("Stage 1 - Responder sent the second handshake message with signed payload."),Zg(this.session.hs.e);case 39:case"end":return e.stop()}var s}),e,this,[[14,27]])})));return function(){return e.apply(this,arguments)}}()},{key:"finish",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isInitiator){e.next=7;break}Ag.trace("Stage 2 - Initiator sending third handshake message."),t=this.xx.sendMessage(this.session,this.payload),this.connection.writeLP(Xy(t)),Ag.trace("Stage 2 - Initiator sent message with signed payload."),e.next=34;break;case 7:return Ag.trace("Stage 2 - Responder waiting for third handshake message..."),e.t0=eg,e.next=11,this.connection.readLP();case 11:if(e.t1=e.sent.subarray(),n=(0,e.t0)(e.t1),r=this.xx.recvMessage(this.session,n),i=r.plaintext,r.valid){e.next=16;break}throw new ig("xx handshake stage 2 validation fail");case 16:if(Ag.trace("Stage 2 - Responder received the message, finished handshake."),e.prev=17,o=bg(i),e.t2=this.remotePeer,e.t2){e.next=24;break}return e.next=23,gg(o);case 23:e.t2=e.sent;case 24:return this.remotePeer=e.t2,e.next=27,kg(this.session.hs.rs,o,this.remotePeer);case 27:this.setRemoteNoiseExtension(o.extensions),e.next=34;break;case 30:throw e.prev=30,e.t3=e.catch(17),a=e.t3,new rg("Error occurred while verifying signed payload: ".concat(a.message));case 34:(s=this.session).cs1&&s.cs2?(Sg("CIPHER_STATE_1 ".concat(s.cs1.n.getUint64()," ").concat(_g(s.cs1.k,"hex"))),Sg("CIPHER_STATE_2 ".concat(s.cs2.n.getUint64()," ").concat(_g(s.cs2.k,"hex")))):Sg("Missing cipher state.");case 35:case"end":return e.stop()}var s}),e,this,[[17,30]])})));return function(){return e.apply(this,arguments)}}()},{key:"encrypt",value:function(e,t){var n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}},{key:"decrypt",value:function(e,t,n){var r=this.getCS(t,!1);return this.xx.decryptWithAd(r,new Uint8Array(0),e,n)}},{key:"getRemoteStaticKey",value:function(){return this.session.hs.rs}},{key:"getCS",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e.cs1||!e.cs2)throw new ig("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}},{key:"setRemoteNoiseExtension",value:function(e){e&&(this.remoteExtensions=e)}}]),e}();var Rg=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.protocol="/noise";var n=t.staticNoiseKey,r=t.extensions,i=t.crypto,o=t.prologueBytes,a=t.metrics;this.crypto=null!==i&&void 0!==i?i:Gy,this.extensions=r,this.metrics=a?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(a):void 0,this.staticKeys=n?this.crypto.generateX25519KeyPairFromSeed(n):this.crypto.generateX25519KeyPair(),this.prologue=null!==o&&void 0!==o?o:new Uint8Array(0)}return(0,W.Z)(e,[{key:"secureOutbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=Ay(n,{lengthEncoder:Wy,lengthDecoder:qy,maxDataLength:Uy}),e.next=3,this.performHandshake({connection:i,isInitiator:!0,localPeer:t,remotePeer:r});case 3:return o=e.sent,e.next=6,this.createSecureConnection(i,o);case 6:return a=e.sent,e.abrupt("return",{conn:a,remoteExtensions:o.remoteExtensions,remotePeer:o.remotePeer});case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"secureInbound",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=Ay(n,{lengthEncoder:Wy,lengthDecoder:qy,maxDataLength:Uy}),e.next=3,this.performHandshake({connection:i,isInitiator:!1,localPeer:t,remotePeer:r});case 3:return o=e.sent,e.next=6,this.createSecureConnection(i,o);case 6:return a=e.sent,e.abrupt("return",{conn:a,remotePeer:o.remotePeer,remoteExtensions:o.remoteExtensions});case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"performHandshake",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,hg(t.localPeer,this.staticKeys.publicKey,this.extensions);case 2:return n=e.sent,e.next=5,this.performXXHandshake(t,n);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"performXXHandshake",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.isInitiator,i=t.remotePeer,o=t.connection,a=new Og(r,n,this.prologue,this.crypto,this.staticKeys,o,i),e.prev=2,e.next=5,a.propose();case 5:return e.next=7,a.exchange();case 7:return e.next=9,a.finish();case 9:null===(u=this.metrics)||void 0===u||u.xxHandshakeSuccesses.increment(),e.next=18;break;case 12:if(e.prev=12,e.t0=e.catch(2),null===(c=this.metrics)||void 0===c||c.xxHandshakeErrors.increment(),!(e.t0 instanceof Error)){e.next=18;break}throw e.t0.message="Error occurred during XX handshake: ".concat(e.t0.message),e.t0;case 18:return e.abrupt("return",a);case 19:case"end":return e.stop()}}),e,this,[[2,12]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"createSecureConnection",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Ty(),i=(0,k.Z)(r,2),o=i[0],a=i[1],u=t.unwrap(),e.next=4,Py(o,tg(n,this.metrics),u,jy({lengthDecoder:qy}),ng(n,this.metrics),o);case 4:return e.abrupt("return",a);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}();function Pg(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(){return new Rg(e)}}var Lg=-1,Ng={},Bg={};function Mg(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}function Fg(e){if("number"===typeof e){if(null!=Bg[e])return Bg[e];throw new Error("no protocol with code: ".concat(e))}if("string"===typeof e){if(null!=Ng[e])return Ng[e];throw new Error("no protocol with name: ".concat(e))}throw new Error("invalid protocol id type: ".concat(typeof e))}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Lg,"ip6zone"],[43,8,"ipcidr"],[53,Lg,"dns",!0],[54,Lg,"dns4",!0],[55,Lg,"dns6",!0],[56,Lg,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Lg,"unix",!1,!0],[421,Lg,"ipfs"],[421,Lg,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Lg,"garlic64"],[448,0,"tls"],[449,Lg,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Lg,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Lg,"memory"]].forEach((function(e){var t=Mg.apply(void 0,(0,ye.Z)(e));Bg[t.code]=t,Ng[t.name]=t}));Fg("ip4"),Fg("ip6"),Fg("ipcidr");var jg=Object.values(cr.gh).map((function(e){return e.decoder}));!function(){var e=jg[0].or(jg[1]);jg.slice(2).forEach((function(t){return e=e.or(t)}))}();Symbol.for("nodejs.util.inspect.custom"),Fg("dns").code,Fg("dns4").code,Fg("dns6").code,Fg("dnsaddr").code,new Map,Symbol.for("@multiformats/js-multiaddr/multiaddr");var Ug;var zg=(0,ru.kg)("libp2p:webtransport"),Hg=Object.values(cr.gh).map((function(e){return e.decoder})).reduce((function(e,t){return e.or(t)}));function Vg(){return{source:(0,ot.Z)({},Symbol.asyncIterator,(function(){return{next:function(){return(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(){})));case 1:case"end":return e.stop()}}),e)})))()}}})),sink:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(){})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}}function Gg(e,t,n,r,i){return Kg.apply(this,arguments)}function Kg(){return Kg=(0,u.Z)((0,s.Z)().mark((function e(t,n,r,i,o){var a,c,l,f,h,p,d;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l=function(){var e=i.findIndex((function(e){return e===d}));-1!==e&&(i.splice(e,1),d.stat.timeline.close=Date.now(),null===o||void 0===o||o(d))},a=t.writable.getWriter(),c=t.readable.getReader(),e.next=5,a.ready;case 5:return f=!1,h=!1,(0,u.Z)((0,s.Z)().mark((function e(){var t,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.closed.catch((function(e){return e}));case 2:null!=(t=e.sent)&&((r=t.message).includes("aborted by the remote server")||r.includes("STOP_SENDING")||zg.error("WebTransport writer closed unexpectedly: streamId=".concat(n," err=").concat(t.message))),(f=!0)&&h&&l();case 6:case"end":return e.stop()}}),e)})))().catch((function(){zg.error("WebTransport failed to cleanup closed stream")})),(0,u.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.closed.catch((function(e){return e}));case 2:null!=(t=e.sent)&&zg.error("WebTransport reader closed unexpectedly: streamId=".concat(n," err=").concat(t.message)),h=!0,f&&h&&l();case 6:case"end":return e.stop()}}),e)})))().catch((function(){zg.error("WebTransport failed to cleanup closed stream")})),p=!1,d={id:n,abort:function(e){f||(a.abort(),f=!0),d.closeRead(),h=!0,l()},close:function(){d.closeRead(),d.closeWrite(),l()},closeRead:function(){h||(c.cancel().catch((function(e){!0===e.toString().includes("RESET_STREAM")&&(f=!0)})),h=!0),f&&l()},closeWrite:function(){f||(f=!0,a.close().catch((function(e){!0===e.toString().includes("RESET_STREAM")&&(h=!0)}))),h&&l()},reset:function(){d.close()},stat:{direction:r,timeline:{open:Date.now()}},metadata:{},source:(0,g.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,(0,m.Z)(c.read());case 3:if(!0!==(t=e.sent).done){e.next=8;break}return h=!0,f&&l(),e.abrupt("return");case 8:return e.next=10,new vt(t.value);case 10:e.next=0;break;case 12:case"end":return e.stop()}}),e)})))(),sink:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!p){e.next=2;break}throw new Error("sink already called on stream");case 2:p=!0,e.prev=3,n=!1,r=!1,e.prev=6,o=(0,y.Z)(t);case 8:return e.next=10,o.next();case 10:if(!(n=!(u=e.sent).done)){e.next=37;break}if(!((c=u.value)instanceof Uint8Array)){e.next=17;break}return e.next=15,a.write(c);case 15:e.next=34;break;case 17:l=(0,Ae.Z)(c),e.prev=18,l.s();case 20:if((f=l.n()).done){e.next=26;break}return h=f.value,e.next=24,a.write(h);case 24:e.next=20;break;case 26:e.next=31;break;case 28:e.prev=28,e.t0=e.catch(18),l.e(e.t0);case 31:return e.prev=31,l.f(),e.finish(31);case 34:n=!1,e.next=8;break;case 37:e.next=43;break;case 39:e.prev=39,e.t1=e.catch(6),r=!0,i=e.t1;case 43:if(e.prev=43,e.prev=44,!n||null==o.return){e.next=48;break}return e.next=48,o.return();case 48:if(e.prev=48,!r){e.next=51;break}throw i;case 51:return e.finish(48);case 52:return e.finish(43);case 53:return e.prev=53,d.closeWrite(),e.finish(53);case 56:case"end":return e.stop()}}),e,null,[[3,,53,56],[6,39,43,53],[18,28,31,34],[44,,48,52]])})));return function(t){return e.apply(this,arguments)}}()},e.abrupt("return",d);case 12:case"end":return e.stop()}}),e)}))),Kg.apply(this,arguments)}function Wg(e){var t=e.stringTuples().reduce((function(e,t){var n,r,i,o,a,s,u,c=(0,k.Z)(t,2),l=c[0],f=c[1];switch(l){case Fg("ip6").code:case Fg("dns6").code:!0===(null===(n=f)||void 0===n?void 0:n.includes(":"))&&(f="[".concat(f,"]"));case Fg("ip4").code:case Fg("dns4").code:if(e.seenHost||e.seenPort)throw new Error("Invalid multiaddr, saw host and already saw the host or port");return(0,Nt.Z)((0,Nt.Z)({},e),{},{url:"".concat(e.url).concat(null!==(r=f)&&void 0!==r?r:""),seenHost:!0});case Fg("quic").code:case Fg("quic-v1").code:case Fg("webtransport").code:if(!e.seenHost||!e.seenPort)throw new Error("Invalid multiaddr, Didn't see host and port, but saw quic/webtransport");return e;case Fg("udp").code:if(e.seenPort)throw new Error("Invalid multiaddr, saw port but already saw the port");return(0,Nt.Z)((0,Nt.Z)({},e),{},{url:"".concat(e.url,":").concat(null!==(i=f)&&void 0!==i?i:""),seenPort:!0});case Fg("certhash").code:if(!e.seenHost||!e.seenPort)throw new Error("Invalid multiaddr, saw the certhash before seeing the host and port");return(0,Nt.Z)((0,Nt.Z)({},e),{},{certhashes:e.certhashes.concat([(u=null!==(o=f)&&void 0!==o?o:"",cr.uR.decode(Hg.decode(u)))])});case Fg("p2p").code:return(0,Nt.Z)((0,Nt.Z)({},e),{},{remotePeer:(0,Ps.jE)(null!==(a=f)&&void 0!==a?a:"")});default:throw new Error("unexpected component in multiaddr: ".concat(l," ").concat(Fg(l).name," ").concat(null!==(s=f)&&void 0!==s?s:""," "))}}),{url:"https://",seenHost:!1,seenPort:!1,certhashes:[]});return{url:t.url,certhashes:t.certhashes,remotePeer:t.remotePeer}}function qg(e,t){return t.filter((function(t){return Boolean(e.find((function(e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(e[n]!==t[n])return!1;return!0})))})).length===t.length}Ug=Symbol.toStringTag;var Yg=function(){function e(t){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"components",void 0),(0,ot.Z)(this,"config",void 0),(0,ot.Z)(this,Ug,"@libp2p/webtransport"),(0,ot.Z)(this,ul,!0),this.components=t,this.config={maxInboundStreams:null!==(n=r.maxInboundStreams)&&void 0!==n?n:1e3}}return(0,W.Z)(e,[{key:"dial",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,c,l,f,h,p,d;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(zg("dialing %s",t),void 0!==(i=this.components.peerId)){e.next=4;break}throw new Error("Need a local peerid");case 4:if(n=null!==(r=n)&&void 0!==r?r:{},o=Wg(t),a=o.url,c=o.certhashes,l=o.remotePeer,0!==c.length){e.next=8;break}throw new Error("Expected multiaddr to contain certhashes");case 8:return f=new WebTransport("".concat(a,"/.well-known/libp2p-webtransport?type=noise"),{serverCertificateHashes:c.map((function(e){return{algorithm:"sha-256",value:e.digest}}))}),f.closed.catch((function(e){zg.error("WebTransport transport closed due to:",e)})),e.next=12,f.ready;case 12:if(null!=l){e.next=14;break}throw new Error("Need a target peerid");case 14:return e.next=16,this.authenticateWebTransport(f,i,l,c);case 16:if(e.sent){e.next=18;break}throw new Error("Failed to authenticate webtransport");case 18:h=(0,Nt.Z)({close:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null!=t&&zg("Closing webtransport with err:",t),f.close();case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),remoteAddr:t,timeline:{open:Date.now()}},Vg()),f.closed.catch((function(e){zg.error("WebTransport connection closed:",e),h.timeline.close=Date.now()})),e.prev=20,null===(p=n)||void 0===p||null===(d=p.signal)||void 0===d||d.throwIfAborted(),e.next=28;break;case 24:throw e.prev=24,e.t0=e.catch(20),f.close(),e.t0;case 28:return e.abrupt("return",n.upgrader.upgradeOutbound(h,{skipEncryption:!0,muxerFactory:this.webtransportMuxer(f),skipProtection:!0}));case 29:case"end":return e.stop()}}),e,this,[[20,24]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"authenticateWebTransport",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r,i){var o,a,c,l,f,h,p,d;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.createBidirectionalStream();case 2:return a=e.sent,c=a.writable.getWriter(),l=a.readable.getReader(),e.next=7,c.ready;case 7:return f={source:(0,g.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,(0,m.Z)(l.read());case 3:if(null==(t=e.sent).value){e.next=7;break}return e.next=7,t.value;case 7:if(!0!==t.done){e.next=9;break}return e.abrupt("break",11);case 9:e.next=0;break;case 11:case"end":return e.stop()}}),e)})))(),sink:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!1,r=!1,e.prev=2,o=(0,y.Z)(t);case 4:return e.next=6,o.next();case 6:if(!(n=!(a=e.sent).done)){e.next=13;break}return u=a.value,e.next=10,c.write(u);case 10:n=!1,e.next=4;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(2),r=!0,i=e.t0;case 19:if(e.prev=19,e.prev=20,!n||null==o.return){e.next=24;break}return e.next=24,o.return();case 24:if(e.prev=24,!r){e.next=27;break}throw i;case 27:return e.finish(24);case 28:return e.finish(19);case 29:case"end":return e.stop()}}),e,null,[[2,15,19,29],[20,,24,28]])})));return function(t){return e.apply(this,arguments)}}()},h=Pg()(),e.next=11,h.secureOutbound(n,f,r);case 11:if(p=e.sent,d=p.remoteExtensions,c.close().catch((function(e){zg.error("Failed to close authentication stream writer: ".concat(e.message))})),l.cancel().catch((function(e){zg.error("Failed to close authentication stream reader: ".concat(e.message))})),qg(null!==(o=null===d||void 0===d?void 0:d.webtransportCerthashes)&&void 0!==o?o:[],i.map((function(e){return e.bytes})))){e.next=17;break}throw new Error("Our certhashes are not a subset of the remote's reported certhashes");case 17:return e.abrupt("return",!0);case 18:case"end":return e.stop()}}),e)})));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"webtransportMuxer",value:function(e){var t=0,n=this.config;return{protocol:"webtransport",createStreamMuxer:function(r){"function"===typeof r&&(r={onIncomingStream:r});var i=[];(0,u.Z)((0,s.Z)().mark((function o(){var a,u,c,l,f,h,p,d,v;return(0,s.Z)().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:a=e.incomingBidirectionalStreams.getReader();case 1:return o.next=4,a.read();case 4:if(u=o.sent,c=u.done,l=u.value,!0!==c){o.next=9;break}return o.abrupt("break",21);case 9:if(!(i.length>=n.maxInboundStreams)){o.next=14;break}l.writable.close().catch((function(e){zg.error("Failed to close inbound stream that crossed our maxInboundStream limit: ".concat(e.message))})),l.readable.cancel().catch((function(e){zg.error("Failed to close inbound stream that crossed our maxInboundStream limit: ".concat(e.message))})),o.next=19;break;case 14:return o.next=16,Gg(l,String(t++),"inbound",i,null===(f=r)||void 0===f?void 0:f.onStreamEnd);case 16:v=o.sent,i.push(v),null===(h=r)||void 0===h||null===(p=(d=h).onIncomingStream)||void 0===p||p.call(d,v);case 19:o.next=1;break;case 21:case"end":return o.stop()}}),o)})))().catch((function(){zg.error("WebTransport failed to receive incoming stream")}));var o=(0,Nt.Z)({protocol:"webtransport",streams:i,newStream:function(){var n=(0,u.Z)((0,s.Z)().mark((function n(o){var a,u,c,l,f;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.createBidirectionalStream();case 2:return l=n.sent,n.next=5,Gg(l,String(t++),null!==(a=null===(u=r)||void 0===u?void 0:u.direction)&&void 0!==a?a:"outbound",i,null===(c=r)||void 0===c?void 0:c.onStreamEnd);case 5:return f=n.sent,i.push(f),n.abrupt("return",f);case 8:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),close:function(t){null!=t&&zg("Closing webtransport muxer with err:",t),e.close()}},Vg());try{var a,c;null===(a=r)||void 0===a||null===(c=a.signal)||void 0===c||c.throwIfAborted()}catch(l){throw e.close(),l}return o}}}},{key:"createListener",value:function(e){throw new Error("Webtransport servers are not supported in Node or the browser")}},{key:"filter",value:function(e){return e.filter((function(e){return e.protoNames().includes("webtransport")}))}}]),e}();function Qg(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t){return new Yg(t,e)}}function Xg(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Open failed"),Mt()(e,"ERR_OPEN_FAILED")}function $g(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Close failed"),Mt()(e,"ERR_CLOSE_FAILED")}function Jg(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Put failed"),Mt()(e,"ERR_PUT_FAILED")}function em(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Get failed"),Mt()(e,"ERR_GET_FAILED")}function tm(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Delete failed"),Mt()(e,"ERR_DELETE_FAILED")}function nm(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Has failed"),Mt()(e,"ERR_HAS_FAILED")}function rm(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Not Found"),Mt()(e,"ERR_NOT_FOUND")}function im(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Aborted"),Mt()(e,"ERR_ABORTED")}var om=function(){function e(){(0,K.Z)(this,e)}return(0,W.Z)(e,[{key:"has",value:function(e,t){return Promise.reject(new Error(".has is not implemented"))}},{key:"put",value:function(e,t,n){return Promise.reject(new Error(".put is not implemented"))}},{key:"putMany",value:function(e,t){var n=this;return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=15;break}return l=c.value,f=l.cid,h=l.block,r.next=10,(0,m.Z)(n.put(f,h,t));case 10:return r.next=12,f;case 12:i=!1,r.next=4;break;case 15:r.next=21;break;case 17:r.prev=17,r.t0=r.catch(2),o=!0,a=r.t0;case 21:if(r.prev=21,r.prev=22,!i||null==u.return){r.next=26;break}return r.next=26,(0,m.Z)(u.return());case 26:if(r.prev=26,!o){r.next=29;break}throw a;case 29:return r.finish(26);case 30:return r.finish(21);case 31:case"end":return r.stop()}}),r,null,[[2,17,21,31],[22,,26,30]])})))()}},{key:"get",value:function(e,t){return Promise.reject(new Error(".get is not implemented"))}},{key:"getMany",value:function(e,t){var n=this;return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=17;break}return l=c.value,r.t0=l,r.next=11,(0,m.Z)(n.get(l,t));case 11:return r.t1=r.sent,r.next=14,{cid:r.t0,block:r.t1};case 14:i=!1,r.next=4;break;case 17:r.next=23;break;case 19:r.prev=19,r.t2=r.catch(2),o=!0,a=r.t2;case 23:if(r.prev=23,r.prev=24,!i||null==u.return){r.next=28;break}return r.next=28,(0,m.Z)(u.return());case 28:if(r.prev=28,!o){r.next=31;break}throw a;case 31:return r.finish(28);case 32:return r.finish(23);case 33:case"end":return r.stop()}}),r,null,[[2,19,23,33],[24,,28,32]])})))()}},{key:"delete",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.reject(new Error(".delete is not implemented"));case 2:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"deleteMany",value:function(e,t){var n=this;return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=15;break}return l=c.value,r.next=10,(0,m.Z)(n.delete(l,t));case 10:return r.next=12,l;case 12:i=!1,r.next=4;break;case 15:r.next=21;break;case 17:r.prev=17,r.t0=r.catch(2),o=!0,a=r.t0;case 21:if(r.prev=21,r.prev=22,!i||null==u.return){r.next=26;break}return r.next=26,(0,m.Z)(u.return());case 26:if(r.prev=26,!o){r.next=29;break}throw a;case 29:return r.finish(26);case 30:return r.finish(21);case 31:case"end":return r.stop()}}),r,null,[[2,17,21,31],[22,,26,30]])})))()}},{key:"getAll",value:function(e){return(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error(".getAll is not implemented");case 1:case"end":return e.stop()}}),e)})))()}}]),e}(),am=n(42094),sm=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){var e;return(0,K.Z)(this,n),e=t.call(this),(0,ot.Z)((0,nr.Z)(e),"data",void 0),e.data=new Map,e}return(0,W.Z)(n,[{key:"put",value:function(e,t){return this.data.set(kl.base32.encode(e.multihash.bytes),t),e}},{key:"get",value:function(e){var t=this.data.get(kl.base32.encode(e.multihash.bytes));if(null==t)throw rm();return t}},{key:"has",value:function(e){return this.data.has(kl.base32.encode(e.multihash.bytes))}},{key:"delete",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.data.delete(kl.base32.encode(t.multihash.bytes));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getAll",value:function(){var e=this;return(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e.data.entries()),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=9;break}return i=(0,k.Z)(r.value,2),o=i[0],a=i[1],t.next=7,{cid:c.CID.createV1(am.code,b.decode(kl.base32.decode(o))),block:a};case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t0=t.catch(1),n.e(t.t0);case 14:return t.prev=14,n.f(),t.finish(14);case 17:case"end":return t.stop()}}),t,null,[[1,11,14,17]])})))()}}]),n}(om);(0,Nt.Z)({},a);var um,cm="/",lm=(new TextEncoder).encode(cm),fm=lm[0];um=Symbol.toStringTag;var hm=function(){function e(t,n){if((0,K.Z)(this,e),(0,ot.Z)(this,"_buf",void 0),"string"===typeof t)this._buf=Us(t);else{if(!(t instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=t}if(null==n&&(n=!0),n&&this.clean(),0===this._buf.byteLength||this._buf[0]!==fm)throw new Error("Invalid key")}return(0,W.Z)(e,[{key:"toString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8";return eu(this._buf,e)}},{key:"uint8Array",value:function(){return this._buf}},{key:um,get:function(){return"Key(".concat(this.toString(),")")}},{key:"clean",value:function(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=lm),this._buf[0]!==fm){var e=new Uint8Array(this._buf.byteLength+1);e.fill(fm,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===fm;)this._buf=this._buf.subarray(0,-1)}},{key:"less",value:function(e){for(var t=this.list(),n=e.list(),r=0;r<t.length;r++){if(n.length<r+1)return!1;var i=t[r],o=n[r];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}},{key:"reverse",value:function(){return e.withNamespaces(this.list().slice().reverse())}},{key:"namespaces",value:function(){return this.list()}},{key:"baseNamespace",value:function(){var e=this.namespaces();return e[e.length-1]}},{key:"list",value:function(){return this.toString().split(cm).slice(1)}},{key:"type",value:function(){return function(e){var t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}},{key:"name",value:function(){return function(e){var t=e.split(":");return t[t.length-1]}(this.baseNamespace())}},{key:"instance",value:function(t){return new e(this.toString()+":"+t)}},{key:"path",value:function(){var t=this.parent().toString();return t.endsWith(cm)||(t+=cm),new e(t+=this.type())}},{key:"parent",value:function(){var t=this.list();return 1===t.length?new e(cm):new e(t.slice(0,-1).join(cm))}},{key:"child",value:function(t){return this.toString()===cm?t:t.toString()===cm?this:new e(this.toString()+t.toString(),!1)}},{key:"isAncestorOf",value:function(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}},{key:"isDecendantOf",value:function(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}},{key:"isTopLevel",value:function(){return 1===this.list().length}},{key:"concat",value:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.withNamespaces([].concat((0,ye.Z)(this.namespaces()),(0,ye.Z)(function(e){var t;return(t=[]).concat.apply(t,(0,ye.Z)(e))}(n.map((function(e){return e.namespaces()}))))))}}],[{key:"withNamespaces",value:function(t){return new e(t.join(cm))}},{key:"random",value:function(){return new e(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;return crypto.getRandomValues(new Uint8Array(e)).reduce((function(e,t){return e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")}),"")}().replace(/-/g,""))}},{key:"asKey",value:function(t){return t instanceof Uint8Array||"string"===typeof t?new e(t):"function"===typeof t.uint8Array?new e(t.uint8Array()):null}}]),e}();var pm="SHARDING";var dm=function(e){if(null!=e[Symbol.asyncIterator])return(0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,o.next();case 6:if(!(n=!(a=t.sent).done)){t.next=11;break}a.value;case 8:n=!1,t.next=4;break;case 11:t.next=17;break;case 13:t.prev=13,t.t0=t.catch(2),r=!0,i=t.t0;case 17:if(t.prev=17,t.prev=18,!n||null==o.return){t.next=22;break}return t.next=22,o.return();case 22:if(t.prev=22,!r){t.next=25;break}throw i;case 25:return t.finish(22);case 26:return t.finish(17);case 27:case"end":return t.stop()}}),t,null,[[2,13,17,27],[18,,22,26]])})))();var t,n=(0,Ae.Z)(e);try{for(n.s();!(t=n.n()).done;)t.value}catch(r){n.e(r)}finally{n.f()}};var vm=function(e){var t=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],n=(0,k.Z)(t,2),r=n[0],i=n[1],o=[];return(0,ot.Z)({peek:function(){return r.next()},push:function(e){o.push(e)},next:function(){return o.length>0?{done:!1,value:o.shift()}:r.next()}},i,(function(){return this}))};var ym=function(e,t){if(null!=e[Symbol.asyncIterator])return(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=!1,i=!1,n.prev=2,a=(0,y.Z)(e);case 4:return n.next=6,(0,m.Z)(a.next());case 6:if(!(r=!(u=n.sent).done)){n.next=16;break}return c=u.value,n.next=10,(0,m.Z)(t(c));case 10:if(!n.sent){n.next=13;break}return n.next=13,c;case 13:r=!1,n.next=4;break;case 16:n.next=22;break;case 18:n.prev=18,n.t0=n.catch(2),i=!0,o=n.t0;case 22:if(n.prev=22,n.prev=23,!r||null==a.return){n.next=27;break}return n.next=27,(0,m.Z)(a.return());case 27:if(n.prev=27,!i){n.next=30;break}throw o;case 30:return n.finish(27);case 31:return n.finish(22);case 32:case"end":return n.stop()}}),n,null,[[2,18,22,32],[23,,27,31]])})))();var n=vm(e),r=n.next(),i=r.value;if(!0===r.done)return(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))();var o=t(i);if("function"===typeof o.then)return(0,g.Z)((0,s.Z)().mark((function e(){var r,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.Z)(o);case 2:if(!e.sent){e.next=5;break}return e.next=5,i;case 5:r=!1,a=!1,e.prev=7,c=(0,y.Z)(n);case 9:return e.next=11,(0,m.Z)(c.next());case 11:if(!(r=!(l=e.sent).done)){e.next=21;break}return f=l.value,e.next=15,(0,m.Z)(t(f));case 15:if(!e.sent){e.next=18;break}return e.next=18,f;case 18:r=!1,e.next=9;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(7),a=!0,u=e.t0;case 27:if(e.prev=27,e.prev=28,!r||null==c.return){e.next=32;break}return e.next=32,(0,m.Z)(c.return());case 32:if(e.prev=32,!a){e.next=35;break}throw u;case 35:return e.finish(32);case 36:return e.finish(27);case 37:case"end":return e.stop()}}),e,null,[[7,23,27,37],[28,,32,36]])})))();var a=t;return(0,s.Z)().mark((function e(){var t,r,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!0!==o){e.next=3;break}return e.next=3,i;case 3:t=(0,Ae.Z)(n),e.prev=4,t.s();case 6:if((r=t.n()).done){e.next=13;break}if(u=r.value,!a(u)){e.next=11;break}return e.next=11,u;case 11:e.next=6;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(4),t.e(e.t0);case 18:return e.prev=18,t.f(),e.finish(18);case 21:case"end":return e.stop()}}),e,null,[[4,15,18,21]])}))()};var gm=function(e){if(null!=e[Symbol.asyncIterator])return(0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=[],r=!1,i=!1,t.prev=3,a=(0,y.Z)(e);case 5:return t.next=7,a.next();case 7:if(!(r=!(u=t.sent).done)){t.next=13;break}c=u.value,n.push(c);case 10:r=!1,t.next=5;break;case 13:t.next=19;break;case 15:t.prev=15,t.t0=t.catch(3),i=!0,o=t.t0;case 19:if(t.prev=19,t.prev=20,!r||null==a.return){t.next=24;break}return t.next=24,a.return();case 24:if(t.prev=24,!i){t.next=27;break}throw o;case 27:return t.finish(24);case 28:return t.finish(19);case 29:return t.abrupt("return",n);case 30:case"end":return t.stop()}}),t,null,[[3,15,19,29],[20,,24,28]])})))();var t,n=[],r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;n.push(i)}}catch(o){r.e(o)}finally{r.f()}return n};var mm=function(e,t){return null!=e[Symbol.asyncIterator]?(0,g.Z)((0,s.Z)().mark((function n(){var r;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,(0,m.Z)(gm(e));case 2:return r=n.sent,n.delegateYield((0,at.Z)((0,y.Z)(r.sort(t)),m.Z),"t0",4);case 4:case"end":return n.stop()}}),n)})))():(0,s.Z)().mark((function n(){var r;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=gm(e),n.delegateYield(r.sort(t),"t0",2);case 2:case"end":return n.stop()}}),n)}))()};var bm=function(e,t){return null!=e[Symbol.asyncIterator]?(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=0,!(t<1)){n.next=3;break}return n.abrupt("return");case 3:i=!1,o=!1,n.prev=5,u=(0,y.Z)(e);case 7:return n.next=9,(0,m.Z)(u.next());case 9:if(!(i=!(c=n.sent).done)){n.next=19;break}return l=c.value,n.next=13,l;case 13:if(++r!==t){n.next=16;break}return n.abrupt("return");case 16:i=!1,n.next=7;break;case 19:n.next=25;break;case 21:n.prev=21,n.t0=n.catch(5),o=!0,a=n.t0;case 25:if(n.prev=25,n.prev=26,!i||null==u.return){n.next=30;break}return n.next=30,(0,m.Z)(u.return());case 30:if(n.prev=30,!o){n.next=33;break}throw a;case 33:return n.finish(30);case 34:return n.finish(25);case 35:case"end":return n.stop()}}),n,null,[[5,21,25,35],[26,,30,34]])})))():(0,s.Z)().mark((function n(){var r,i,o,a;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=0,!(t<1)){n.next=3;break}return n.abrupt("return");case 3:i=(0,Ae.Z)(e),n.prev=4,i.s();case 6:if((o=i.n()).done){n.next=15;break}return a=o.value,n.next=10,a;case 10:if(++r!==t){n.next=13;break}return n.abrupt("return");case 13:n.next=6;break;case 15:n.next=20;break;case 17:n.prev=17,n.t0=n.catch(4),i.e(n.t0);case 20:return n.prev=20,i.f(),n.finish(20);case 23:case"end":return n.stop()}}),n,null,[[4,17,20,23]])}))()},wm=function(){function e(){(0,K.Z)(this,e)}return(0,W.Z)(e,[{key:"put",value:function(e,t,n){return Promise.reject(new Error(".put is not implemented"))}},{key:"get",value:function(e,t){return Promise.reject(new Error(".get is not implemented"))}},{key:"has",value:function(e,t){return Promise.reject(new Error(".has is not implemented"))}},{key:"delete",value:function(e,t){return Promise.reject(new Error(".delete is not implemented"))}},{key:"putMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=15;break}return l=c.value,f=l.key,h=l.value,r.next=10,(0,m.Z)(t.put(f,h,n));case 10:return r.next=12,f;case 12:i=!1,r.next=4;break;case 15:r.next=21;break;case 17:r.prev=17,r.t0=r.catch(2),o=!0,a=r.t0;case 21:if(r.prev=21,r.prev=22,!i||null==u.return){r.next=26;break}return r.next=26,(0,m.Z)(u.return());case 26:if(r.prev=26,!o){r.next=29;break}throw a;case 29:return r.finish(26);case 30:return r.finish(21);case 31:case"end":return r.stop()}}),r,null,[[2,17,21,31],[22,,26,30]])})))()}},{key:"getMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=17;break}return l=c.value,r.t0=l,r.next=11,(0,m.Z)(t.get(l,n));case 11:return r.t1=r.sent,r.next=14,{key:r.t0,value:r.t1};case 14:i=!1,r.next=4;break;case 17:r.next=23;break;case 19:r.prev=19,r.t2=r.catch(2),o=!0,a=r.t2;case 23:if(r.prev=23,r.prev=24,!i||null==u.return){r.next=28;break}return r.next=28,(0,m.Z)(u.return());case 28:if(r.prev=28,!o){r.next=31;break}throw a;case 31:return r.finish(28);case 32:return r.finish(23);case 33:case"end":return r.stop()}}),r,null,[[2,19,23,33],[24,,28,32]])})))()}},{key:"deleteMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=15;break}return l=c.value,r.next=10,(0,m.Z)(t.delete(l,n));case 10:return r.next=12,l;case 12:i=!1,r.next=4;break;case 15:r.next=21;break;case 17:r.prev=17,r.t0=r.catch(2),o=!0,a=r.t0;case 21:if(r.prev=21,r.prev=22,!i||null==u.return){r.next=26;break}return r.next=26,(0,m.Z)(u.return());case 26:if(r.prev=26,!o){r.next=29;break}throw a;case 29:return r.finish(26);case 30:return r.finish(21);case 31:case"end":return r.stop()}}),r,null,[[2,17,21,31],[22,,26,30]])})))()}},{key:"batch",value:function(){var e=this,t=[],n=[];return{put:function(e,n){t.push({key:e,value:n})},delete:function(e){n.push(e)},commit:function(){var r=(0,u.Z)((0,s.Z)().mark((function r(i){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,dm(e.putMany(t,i));case 2:return t=[],r.next=5,dm(e.deleteMany(n,i));case 5:n=[];case 6:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}()}}},{key:"_all",value:function(e,t){return(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("._all is not implemented");case 1:case"end":return e.stop()}}),e)})))()}},{key:"_allKeys",value:function(e,t){return(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("._allKeys is not implemented");case 1:case"end":return e.stop()}}),e)})))()}},{key:"query",value:function(e,t){var n=this._all(e,t);if(null!=e.prefix){var r=e.prefix;n=ym(n,(function(e){return e.key.toString().startsWith(r)}))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((function(e,t){return ym(e,t)}),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((function(e,t){return mm(e,t)}),n)),null!=e.offset){var i=0,o=e.offset;n=ym(n,(function(){return i++>=o}))}return null!=e.limit&&(n=bm(n,e.limit)),n}},{key:"queryKeys",value:function(e,t){var n=this._allKeys(e,t);if(null!=e.prefix){var r=e.prefix;n=ym(n,(function(e){return e.toString().startsWith(r)}))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((function(e,t){return ym(e,t)}),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((function(e,t){return mm(e,t)}),n)),null!=e.offset){var i=e.offset,o=0;n=ym(n,(function(){return o++>=i}))}return null!=e.limit&&(n=bm(n,e.limit)),n}}]),e}(),km=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){var e;return(0,K.Z)(this,n),e=t.call(this),(0,ot.Z)((0,nr.Z)(e),"data",void 0),e.data=new Map,e}return(0,W.Z)(n,[{key:"put",value:function(e,t){return this.data.set(e.toString(),t),e}},{key:"get",value:function(e){var t=this.data.get(e.toString());if(null==t)throw function(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Not Found"),Mt()(e,"ERR_NOT_FOUND")}();return t}},{key:"has",value:function(e){return this.data.has(e.toString())}},{key:"delete",value:function(e){this.data.delete(e.toString())}},{key:"_all",value:(0,s.Z)().mark((function e(){var t,n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(this.data.entries()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=(0,k.Z)(n.value,2),i=r[0],o=r[1],e.next=7,{key:new hm(i),value:o};case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:"_allKeys",value:(0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(this.data.keys()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,new hm(r);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))}]),n}(wm);var Em=function(e,t){if(null!=e[Symbol.asyncIterator])return(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=!1,i=!1,n.prev=2,a=(0,y.Z)(e);case 4:return n.next=6,(0,m.Z)(a.next());case 6:if(!(r=!(u=n.sent).done)){n.next=13;break}return c=u.value,n.next=10,t(c);case 10:r=!1,n.next=4;break;case 13:n.next=19;break;case 15:n.prev=15,n.t0=n.catch(2),i=!0,o=n.t0;case 19:if(n.prev=19,n.prev=20,!r||null==a.return){n.next=24;break}return n.next=24,(0,m.Z)(a.return());case 24:if(n.prev=24,!i){n.next=27;break}throw o;case 27:return n.finish(24);case 28:return n.finish(19);case 29:case"end":return n.stop()}}),n,null,[[2,15,19,29],[20,,24,28]])})))();var n=vm(e),r=n.next(),i=r.value;if(!0===r.done)return(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))();var o=t(i);if("function"===typeof o.then)return(0,g.Z)((0,s.Z)().mark((function e(){var r,i,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.Z)(o);case 2:return e.next=4,e.sent;case 4:r=!1,i=!1,e.prev=6,u=(0,y.Z)(n);case 8:return e.next=10,(0,m.Z)(u.next());case 10:if(!(r=!(c=e.sent).done)){e.next=17;break}return l=c.value,e.next=14,t(l);case 14:r=!1,e.next=8;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(6),i=!0,a=e.t0;case 23:if(e.prev=23,e.prev=24,!r||null==u.return){e.next=28;break}return e.next=28,(0,m.Z)(u.return());case 28:if(e.prev=28,!i){e.next=31;break}throw a;case 31:return e.finish(28);case 32:return e.finish(23);case 33:case"end":return e.stop()}}),e,null,[[6,19,23,33],[24,,28,32]])})))();var a=t;return(0,s.Z)().mark((function e(){var t,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o;case 2:t=(0,Ae.Z)(n),e.prev=3,t.s();case 5:if((r=t.n()).done){e.next=11;break}return i=r.value,e.next=9,a(i);case 9:e.next=5;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(3),t.e(e.t0);case 16:return e.prev=16,t.f(),e.finish(16);case 19:case"end":return e.stop()}}),e,null,[[3,13,16,19]])}))()};new hm(pm),(0,ru.kg)("datastore:core:tiered");var xm=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;return crypto.getRandomValues(new Uint8Array(e)).reduce((function(e,t){return e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_"}),"")};function _m(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function Sm(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?_m(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function Am(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var Zm,Tm=Am("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),Cm=Am("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=Sm((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),Im=(0,Nt.Z)({utf8:Tm,"utf-8":Tm,hex:cr.gh.base16,latin1:Cm,ascii:Cm,binary:Cm},cr.gh);function Dm(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=Im[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):_m(globalThis.Buffer.from(e,"utf-8"))}function Om(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=Im[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}var Rm="/",Pm=(new TextEncoder).encode(Rm),Lm=Pm[0];Zm=Symbol.toStringTag;var Nm=function(){function e(t,n){if((0,K.Z)(this,e),(0,ot.Z)(this,"_buf",void 0),"string"===typeof t)this._buf=Dm(t);else{if(!(t instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=t}if(null==n&&(n=!0),n&&this.clean(),0===this._buf.byteLength||this._buf[0]!==Lm)throw new Error("Invalid key")}return(0,W.Z)(e,[{key:"toString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8";return Om(this._buf,e)}},{key:"uint8Array",value:function(){return this._buf}},{key:Zm,get:function(){return"Key(".concat(this.toString(),")")}},{key:"clean",value:function(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=Pm),this._buf[0]!==Lm){var e=new Uint8Array(this._buf.byteLength+1);e.fill(Lm,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Lm;)this._buf=this._buf.subarray(0,-1)}},{key:"less",value:function(e){for(var t=this.list(),n=e.list(),r=0;r<t.length;r++){if(n.length<r+1)return!1;var i=t[r],o=n[r];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}},{key:"reverse",value:function(){return e.withNamespaces(this.list().slice().reverse())}},{key:"namespaces",value:function(){return this.list()}},{key:"baseNamespace",value:function(){var e=this.namespaces();return e[e.length-1]}},{key:"list",value:function(){return this.toString().split(Rm).slice(1)}},{key:"type",value:function(){return function(e){var t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}},{key:"name",value:function(){return function(e){var t=e.split(":");return t[t.length-1]}(this.baseNamespace())}},{key:"instance",value:function(t){return new e(this.toString()+":"+t)}},{key:"path",value:function(){var t=this.parent().toString();return t.endsWith(Rm)||(t+=Rm),new e(t+=this.type())}},{key:"parent",value:function(){var t=this.list();return 1===t.length?new e(Rm):new e(t.slice(0,-1).join(Rm))}},{key:"child",value:function(t){return this.toString()===Rm?t:t.toString()===Rm?this:new e(this.toString()+t.toString(),!1)}},{key:"isAncestorOf",value:function(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}},{key:"isDecendantOf",value:function(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}},{key:"isTopLevel",value:function(){return 1===this.list().length}},{key:"concat",value:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.withNamespaces([].concat((0,ye.Z)(this.namespaces()),(0,ye.Z)(function(e){var t;return(t=[]).concat.apply(t,(0,ye.Z)(e))}(n.map((function(e){return e.namespaces()}))))))}}],[{key:"withNamespaces",value:function(t){return new e(t.join(Rm))}},{key:"random",value:function(){return new e(xm().replace(/-/g,""))}},{key:"asKey",value:function(t){return t instanceof Uint8Array||"string"===typeof t?new e(t):"function"===typeof t.uint8Array?new e(t.uint8Array()):null}}]),e}();var Bm="SHARDING";var Mm=function(e){if(null!=e[Symbol.asyncIterator])return(0,u.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,o.next();case 6:if(!(n=!(a=t.sent).done)){t.next=11;break}a.value;case 8:n=!1,t.next=4;break;case 11:t.next=17;break;case 13:t.prev=13,t.t0=t.catch(2),r=!0,i=t.t0;case 17:if(t.prev=17,t.prev=18,!n||null==o.return){t.next=22;break}return t.next=22,o.return();case 22:if(t.prev=22,!r){t.next=25;break}throw i;case 25:return t.finish(22);case 26:return t.finish(17);case 27:case"end":return t.stop()}}),t,null,[[2,13,17,27],[18,,22,26]])})))();var t,n=(0,Ae.Z)(e);try{for(n.s();!(t=n.n()).done;)t.value}catch(r){n.e(r)}finally{n.f()}};var Fm=function(e){var t=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],n=(0,k.Z)(t,2),r=n[0],i=n[1],o=[];return(0,ot.Z)({peek:function(){return r.next()},push:function(e){o.push(e)},next:function(){return o.length>0?{done:!1,value:o.shift()}:r.next()}},i,(function(){return this}))};var jm=function(e,t){if(null!=e[Symbol.asyncIterator])return(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=!1,i=!1,n.prev=2,a=(0,y.Z)(e);case 4:return n.next=6,(0,m.Z)(a.next());case 6:if(!(r=!(u=n.sent).done)){n.next=16;break}return c=u.value,n.next=10,(0,m.Z)(t(c));case 10:if(!n.sent){n.next=13;break}return n.next=13,c;case 13:r=!1,n.next=4;break;case 16:n.next=22;break;case 18:n.prev=18,n.t0=n.catch(2),i=!0,o=n.t0;case 22:if(n.prev=22,n.prev=23,!r||null==a.return){n.next=27;break}return n.next=27,(0,m.Z)(a.return());case 27:if(n.prev=27,!i){n.next=30;break}throw o;case 30:return n.finish(27);case 31:return n.finish(22);case 32:case"end":return n.stop()}}),n,null,[[2,18,22,32],[23,,27,31]])})))();var n=Fm(e),r=n.next(),i=r.value;if(!0===r.done)return(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))();var o=t(i);if("function"===typeof o.then)return(0,g.Z)((0,s.Z)().mark((function e(){var r,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.Z)(o);case 2:if(!e.sent){e.next=5;break}return e.next=5,i;case 5:r=!1,a=!1,e.prev=7,c=(0,y.Z)(n);case 9:return e.next=11,(0,m.Z)(c.next());case 11:if(!(r=!(l=e.sent).done)){e.next=21;break}return f=l.value,e.next=15,(0,m.Z)(t(f));case 15:if(!e.sent){e.next=18;break}return e.next=18,f;case 18:r=!1,e.next=9;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(7),a=!0,u=e.t0;case 27:if(e.prev=27,e.prev=28,!r||null==c.return){e.next=32;break}return e.next=32,(0,m.Z)(c.return());case 32:if(e.prev=32,!a){e.next=35;break}throw u;case 35:return e.finish(32);case 36:return e.finish(27);case 37:case"end":return e.stop()}}),e,null,[[7,23,27,37],[28,,32,36]])})))();var a=t;return(0,s.Z)().mark((function e(){var t,r,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!0!==o){e.next=3;break}return e.next=3,i;case 3:t=(0,Ae.Z)(n),e.prev=4,t.s();case 6:if((r=t.n()).done){e.next=13;break}if(u=r.value,!a(u)){e.next=11;break}return e.next=11,u;case 11:e.next=6;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(4),t.e(e.t0);case 18:return e.prev=18,t.f(),e.finish(18);case 21:case"end":return e.stop()}}),e,null,[[4,15,18,21]])}))()};var Um=function(e,t){return null!=e[Symbol.asyncIterator]?(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=0,!(t<1)){n.next=3;break}return n.abrupt("return");case 3:i=!1,o=!1,n.prev=5,u=(0,y.Z)(e);case 7:return n.next=9,(0,m.Z)(u.next());case 9:if(!(i=!(c=n.sent).done)){n.next=19;break}return l=c.value,n.next=13,l;case 13:if(++r!==t){n.next=16;break}return n.abrupt("return");case 16:i=!1,n.next=7;break;case 19:n.next=25;break;case 21:n.prev=21,n.t0=n.catch(5),o=!0,a=n.t0;case 25:if(n.prev=25,n.prev=26,!i||null==u.return){n.next=30;break}return n.next=30,(0,m.Z)(u.return());case 30:if(n.prev=30,!o){n.next=33;break}throw a;case 33:return n.finish(30);case 34:return n.finish(25);case 35:case"end":return n.stop()}}),n,null,[[5,21,25,35],[26,,30,34]])})))():(0,s.Z)().mark((function n(){var r,i,o,a;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=0,!(t<1)){n.next=3;break}return n.abrupt("return");case 3:i=(0,Ae.Z)(e),n.prev=4,i.s();case 6:if((o=i.n()).done){n.next=15;break}return a=o.value,n.next=10,a;case 10:if(++r!==t){n.next=13;break}return n.abrupt("return");case 13:n.next=6;break;case 15:n.next=20;break;case 17:n.prev=17,n.t0=n.catch(4),i.e(n.t0);case 20:return n.prev=20,i.f(),n.finish(20);case 23:case"end":return n.stop()}}),n,null,[[4,17,20,23]])}))()},zm=function(){function e(){(0,K.Z)(this,e)}return(0,W.Z)(e,[{key:"put",value:function(e,t,n){return Promise.reject(new Error(".put is not implemented"))}},{key:"get",value:function(e,t){return Promise.reject(new Error(".get is not implemented"))}},{key:"has",value:function(e,t){return Promise.reject(new Error(".has is not implemented"))}},{key:"delete",value:function(e,t){return Promise.reject(new Error(".delete is not implemented"))}},{key:"putMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=15;break}return l=c.value,f=l.key,h=l.value,r.next=10,(0,m.Z)(t.put(f,h,n));case 10:return r.next=12,f;case 12:i=!1,r.next=4;break;case 15:r.next=21;break;case 17:r.prev=17,r.t0=r.catch(2),o=!0,a=r.t0;case 21:if(r.prev=21,r.prev=22,!i||null==u.return){r.next=26;break}return r.next=26,(0,m.Z)(u.return());case 26:if(r.prev=26,!o){r.next=29;break}throw a;case 29:return r.finish(26);case 30:return r.finish(21);case 31:case"end":return r.stop()}}),r,null,[[2,17,21,31],[22,,26,30]])})))()}},{key:"getMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=17;break}return l=c.value,r.t0=l,r.next=11,(0,m.Z)(t.get(l,n));case 11:return r.t1=r.sent,r.next=14,{key:r.t0,value:r.t1};case 14:i=!1,r.next=4;break;case 17:r.next=23;break;case 19:r.prev=19,r.t2=r.catch(2),o=!0,a=r.t2;case 23:if(r.prev=23,r.prev=24,!i||null==u.return){r.next=28;break}return r.next=28,(0,m.Z)(u.return());case 28:if(r.prev=28,!o){r.next=31;break}throw a;case 31:return r.finish(28);case 32:return r.finish(23);case 33:case"end":return r.stop()}}),r,null,[[2,19,23,33],[24,,28,32]])})))()}},{key:"deleteMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a,u,c,l;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=!1,o=!1,r.prev=2,u=(0,y.Z)(e);case 4:return r.next=6,(0,m.Z)(u.next());case 6:if(!(i=!(c=r.sent).done)){r.next=15;break}return l=c.value,r.next=10,(0,m.Z)(t.delete(l,n));case 10:return r.next=12,l;case 12:i=!1,r.next=4;break;case 15:r.next=21;break;case 17:r.prev=17,r.t0=r.catch(2),o=!0,a=r.t0;case 21:if(r.prev=21,r.prev=22,!i||null==u.return){r.next=26;break}return r.next=26,(0,m.Z)(u.return());case 26:if(r.prev=26,!o){r.next=29;break}throw a;case 29:return r.finish(26);case 30:return r.finish(21);case 31:case"end":return r.stop()}}),r,null,[[2,17,21,31],[22,,26,30]])})))()}},{key:"batch",value:function(){var e=this,t=[],n=[];return{put:function(e,n){t.push({key:e,value:n})},delete:function(e){n.push(e)},commit:function(){var r=(0,u.Z)((0,s.Z)().mark((function r(i){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,Mm(e.putMany(t,i));case 2:return t=[],r.next=5,Mm(e.deleteMany(n,i));case 5:n=[];case 6:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}()}}},{key:"_all",value:function(e,t){return(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("._all is not implemented");case 1:case"end":return e.stop()}}),e)})))()}},{key:"_allKeys",value:function(e,t){return(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("._allKeys is not implemented");case 1:case"end":return e.stop()}}),e)})))()}},{key:"query",value:function(e,t){var n=this._all(e,t);if(null!=e.prefix){var r=e.prefix;n=jm(n,(function(e){return e.key.toString().startsWith(r)}))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((function(e,t){return jm(e,t)}),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((function(e,t){return mm(e,t)}),n)),null!=e.offset){var i=0,o=e.offset;n=jm(n,(function(){return i++>=o}))}return null!=e.limit&&(n=Um(n,e.limit)),n}},{key:"queryKeys",value:function(e,t){var n=this._allKeys(e,t);if(null!=e.prefix){var r=e.prefix;n=jm(n,(function(e){return e.toString().startsWith(r)}))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((function(e,t){return jm(e,t)}),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((function(e,t){return mm(e,t)}),n)),null!=e.offset){var i=e.offset,o=0;n=jm(n,(function(){return o++>=i}))}return null!=e.limit&&(n=Um(n,e.limit)),n}}]),e}(),Hm=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(){var e;return(0,K.Z)(this,n),e=t.call(this),(0,ot.Z)((0,nr.Z)(e),"data",void 0),e.data=new Map,e}return(0,W.Z)(n,[{key:"put",value:function(e,t){return this.data.set(e.toString(),t),e}},{key:"get",value:function(e){var t=this.data.get(e.toString());if(null==t)throw function(e){var t;return e=null!==(t=e)&&void 0!==t?t:new Error("Not Found"),Mt()(e,"ERR_NOT_FOUND")}();return t}},{key:"has",value:function(e){return this.data.has(e.toString())}},{key:"delete",value:function(e){this.data.delete(e.toString())}},{key:"_all",value:(0,s.Z)().mark((function e(){var t,n,r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(this.data.entries()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=(0,k.Z)(n.value,2),i=r[0],o=r[1],e.next=7,{key:new Nm(i),value:o};case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:"_allKeys",value:(0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(this.data.keys()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,new Nm(r);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))}]),n}(zm);var Vm=function(e,t){if(null!=e[Symbol.asyncIterator])return(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=!1,i=!1,n.prev=2,a=(0,y.Z)(e);case 4:return n.next=6,(0,m.Z)(a.next());case 6:if(!(r=!(u=n.sent).done)){n.next=13;break}return c=u.value,n.next=10,t(c);case 10:r=!1,n.next=4;break;case 13:n.next=19;break;case 15:n.prev=15,n.t0=n.catch(2),i=!0,o=n.t0;case 19:if(n.prev=19,n.prev=20,!r||null==a.return){n.next=24;break}return n.next=24,(0,m.Z)(a.return());case 24:if(n.prev=24,!i){n.next=27;break}throw o;case 27:return n.finish(24);case 28:return n.finish(19);case 29:case"end":return n.stop()}}),n,null,[[2,15,19,29],[20,,24,28]])})))();var n=Fm(e),r=n.next(),i=r.value;if(!0===r.done)return(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))();var o=t(i);if("function"===typeof o.then)return(0,g.Z)((0,s.Z)().mark((function e(){var r,i,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.Z)(o);case 2:return e.next=4,e.sent;case 4:r=!1,i=!1,e.prev=6,u=(0,y.Z)(n);case 8:return e.next=10,(0,m.Z)(u.next());case 10:if(!(r=!(c=e.sent).done)){e.next=17;break}return l=c.value,e.next=14,t(l);case 14:r=!1,e.next=8;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(6),i=!0,a=e.t0;case 23:if(e.prev=23,e.prev=24,!r||null==u.return){e.next=28;break}return e.next=28,(0,m.Z)(u.return());case 28:if(e.prev=28,!i){e.next=31;break}throw a;case 31:return e.finish(28);case 32:return e.finish(23);case 33:case"end":return e.stop()}}),e,null,[[6,19,23,33],[24,,28,32]])})))();var a=t;return(0,s.Z)().mark((function e(){var t,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o;case 2:t=(0,Ae.Z)(n),e.prev=3,t.s();case 5:if((r=t.n()).done){e.next=11;break}return i=r.value,e.next=9,a(i);case 9:e.next=5;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(3),t.e(e.t0);case 16:return e.prev=16,t.f(),e.finish(16);case 19:case"end":return e.stop()}}),e,null,[[3,13,16,19]])}))()},Gm=function(){function e(t){if((0,K.Z)(this,e),!(t>0)||0!==(t-1&t))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}return(0,W.Z)(e,[{key:"push",value:function(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}},{key:"shift",value:function(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}},{key:"isEmpty",value:function(){return void 0===this.buffer[this.btm]}}]),e}(),Km=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,K.Z)(this,e),this.hwm=null!==(t=n.splitLimit)&&void 0!==t?t:16,this.head=new Gm(this.hwm),this.tail=this.head,this.size=0}return(0,W.Z)(e,[{key:"calculateSize",value:function(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}},{key:"push",value:function(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){var t=this.head;this.head=t.next=new Gm(2*this.head.buffer.length),this.head.push(e)}}},{key:"shift",value:function(){var e,t=this.tail.shift();if(void 0===t&&null!=this.tail.next){var n=this.tail.next;this.tail.next=null,this.tail=n,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}},{key:"isEmpty",value:function(){return this.head.isEmpty()}}]),e}();function Wm(){return qm((function(e){var t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function qm(e,t){var n,r,i,o,a,c,l=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,f=new Km,h=function(){var t=(0,u.Z)((0,s.Z)().mark((function t(){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(f.isEmpty()){t.next=2;break}return t.abrupt("return",e(f));case 2:if(!c){t.next=4;break}return t.abrupt("return",{done:!0});case 4:return t.next=6,new Promise((function(t,n){a=function(r){a=null,f.push(r);try{t(e(f))}catch(i){n(i)}return o}}));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e){return null!=a?a(e):(f.push(e),o)},d=function(e){var n;if(c)return o;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:e})},v=function(e){return c?o:(c=!0,null!=e?function(e){return f=new Km,null!=a?a({error:e}):(f.push({error:e}),o)}(e):p({done:!0}))};if(r={},(0,ot.Z)(r,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(r,"next",h),(0,ot.Z)(r,"return",(function(){return f=new Km,v(),{done:!0}})),(0,ot.Z)(r,"throw",(function(e){return v(e),{done:!0}})),(0,ot.Z)(r,"push",d),(0,ot.Z)(r,"end",v),Xt("get",r,"readableLength",(function(){return f.size})),o=r,null==l)return o;var y=o;return i={},(0,ot.Z)(i,Symbol.asyncIterator,(function(){return this})),(0,ot.Z)(i,"next",(function(){return y.next()})),(0,ot.Z)(i,"throw",(function(e){return y.throw(e),null!=l&&(l(e),l=void 0),{done:!0}})),(0,ot.Z)(i,"return",(function(){return y.return(),null!=l&&(l(),l=void 0),{done:!0}})),(0,ot.Z)(i,"push",d),(0,ot.Z)(i,"end",(function(e){return y.end(e),null!=l&&(l(e),l=void 0),o})),Xt("get",i,"readableLength",(function(){return y.readableLength})),o=i}var Ym=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=[],i=0,o=t;i<o.length;i++){var a=o[i];null==a[Symbol.asyncIterator]&&r.push(a)}return r.length===t.length?(0,s.Z)().mark((function e(){var t,n,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(r),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=8;break}return i=n.value,e.delegateYield(i,"t0",6);case 6:e.next=3;break;case 8:e.next=13;break;case 10:e.prev=10,e.t1=e.catch(1),t.e(e.t1);case 13:return e.prev=13,t.f(),e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[1,10,13,16]])}))():(0,g.Z)((0,s.Z)().mark((function e(){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Wm({objectMode:!0}),Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,i=!1,e.prev=2,a=(0,y.Z)(t);case 4:return e.next=6,a.next();case 6:if(!(r=!(u=e.sent).done)){e.next=12;break}c=u.value,n.push(c);case 9:r=!1,e.next=4;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(2),i=!0,o=e.t0;case 18:if(e.prev=18,e.prev=19,!r||null==a.return){e.next=23;break}return e.next=23,a.return();case 23:if(e.prev=23,!i){e.next=26;break}throw o;case 26:return e.finish(23);case 27:return e.finish(18);case 28:case"end":return e.stop()}}),e,null,[[2,14,18,28],[19,,23,27]])})));return function(t){return e.apply(this,arguments)}}()));case 3:n.end(),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),n.end(e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))),e.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",3);case 3:case"end":return e.stop()}}),e)})))()};function Qm(e){if(null==e)throw new Error("Empty pipeline");if(eb(e)){var t=e;e=function(){return t.source}}else if(Jm(e)||$m(e)){var n=e;e=function(){return n}}for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];var a=[e].concat(i);if(a.length>1&&eb(a[a.length-1])&&(a[a.length-1]=a[a.length-1].sink),a.length>2)for(var s=1;s<a.length-1;s++)eb(a[s])&&(a[s]=tb(a[s]));return Xm.apply(void 0,(0,ye.Z)(a))}var Xm=function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},$m=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator])},Jm=function(e){return null!=(null===e||void 0===e?void 0:e[Symbol.iterator])},eb=function(e){return null!=e&&(null!=e.sink&&null!=e.source)},tb=function(e){return function(t){var n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){var r,i=Wm({objectMode:!0});n.then((function(){i.end()}),(function(e){i.end(e)}));var o=e.source;if($m(o))r=function(){var e=(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield((0,at.Z)((0,y.Z)(o),m.Z),"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();else{if(!Jm(o))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(o,"t0",1);case 1:i.end();case 2:case"end":return e.stop()}}),e)}))}return Ym(i,r())}return e.source}};new Nm(Bm),(0,ru.kg)("datastore:core:tiered");function nb(e){var t=new globalThis.AbortController;function n(){t.abort();var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;null!=(null===o||void 0===o?void 0:o.removeEventListener)&&o.removeEventListener("abort",n)}}catch(a){i.e(a)}finally{i.f()}}var r,i=(0,Ae.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;if(!0===(null===o||void 0===o?void 0:o.aborted)){n();break}null!=(null===o||void 0===o?void 0:o.addEventListener)&&o.addEventListener("abort",n)}}catch(s){i.e(s)}finally{i.f()}var a=t.signal;return a.clear=function(){var t,r=(0,Ae.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;null!=(null===i||void 0===i?void 0:i.removeEventListener)&&i.removeEventListener("abort",n)}}catch(s){r.e(s)}finally{r.f()}},a}var rb=function(e){var t=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],n=(0,k.Z)(t,2),r=n[0],i=n[1],o=[];return(0,ot.Z)({peek:function(){return r.next()},push:function(e){o.push(e)},next:function(){return o.length>0?{done:!1,value:o.shift()}:r.next()}},i,(function(){return this}))};var ib=function(e,t){if(null!=e[Symbol.asyncIterator])return(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=!1,i=!1,n.prev=2,a=(0,y.Z)(e);case 4:return n.next=6,(0,m.Z)(a.next());case 6:if(!(r=!(u=n.sent).done)){n.next=15;break}return c=u.value,n.next=10,(0,m.Z)(t(c));case 10:return n.next=12,c;case 12:r=!1,n.next=4;break;case 15:n.next=21;break;case 17:n.prev=17,n.t0=n.catch(2),i=!0,o=n.t0;case 21:if(n.prev=21,n.prev=22,!r||null==a.return){n.next=26;break}return n.next=26,(0,m.Z)(a.return());case 26:if(n.prev=26,!i){n.next=29;break}throw o;case 29:return n.finish(26);case 30:return n.finish(21);case 31:case"end":return n.stop()}}),n,null,[[2,17,21,31],[22,,26,30]])})))();var n=rb(e),r=n.next(),i=r.value;if(!0===r.done)return(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))();var o=t(i);if("function"===typeof(null===o||void 0===o?void 0:o.then))return(0,g.Z)((0,s.Z)().mark((function e(){var r,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i;case 2:r=!1,o=!1,e.prev=4,u=(0,y.Z)(n);case 6:return e.next=8,(0,m.Z)(u.next());case 8:if(!(r=!(c=e.sent).done)){e.next=17;break}return l=c.value,e.next=12,(0,m.Z)(t(l));case 12:return e.next=14,l;case 14:r=!1,e.next=6;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(4),o=!0,a=e.t0;case 23:if(e.prev=23,e.prev=24,!r||null==u.return){e.next=28;break}return e.next=28,(0,m.Z)(u.return());case 28:if(e.prev=28,!o){e.next=31;break}throw a;case 31:return e.finish(28);case 32:return e.finish(23);case 33:case"end":return e.stop()}}),e,null,[[4,19,23,33],[24,,28,32]])})))();var a=t;return(0,s.Z)().mark((function e(){var t,r,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i;case 2:t=(0,Ae.Z)(n),e.prev=3,t.s();case 5:if((r=t.n()).done){e.next=12;break}return o=r.value,a(o),e.next=10,o;case 10:e.next=5;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(3),t.e(e.t0);case 17:return e.prev=17,t.f(),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[3,14,17,20]])}))()},ob=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;(0,K.Z)(this,n),r=t.call(this);var i=e.name,o=e.metrics;return r.metric=o.registerMetric(i),r.updateComponentMetric(),r}return(0,W.Z)(n,[{key:"set",value:function(e,t){return(0,Ah.Z)((0,Zh.Z)(n.prototype),"set",this).call(this,e,t),this.updateComponentMetric(),this}},{key:"delete",value:function(e){var t=(0,Ah.Z)((0,Zh.Z)(n.prototype),"delete",this).call(this,e);return this.updateComponentMetric(),t}},{key:"clear",value:function(){(0,Ah.Z)((0,Zh.Z)(n.prototype),"clear",this).call(this),this.updateComponentMetric()}},{key:"updateComponentMetric",value:function(){this.metric.update(this.size)}}]),n}((0,Ze.Z)(Map));function ab(e){var t=e.name,n=e.metrics;return null!=n?new ob({name:t,metrics:n}):new Map}var sb,ub=n(29806),cb=n.n(ub);function lb(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}sb=Symbol.toStringTag;var fb,hb=function(){function e(t,n,r){(0,K.Z)(this,e),(0,ot.Z)(this,"_refCounter",void 0),(0,ot.Z)(this,"cid",void 0),(0,ot.Z)(this,"priority",void 0),(0,ot.Z)(this,"wantType",void 0),this._refCounter=1,this.cid=t,this.priority=null!==n&&void 0!==n?n:1,this.wantType=r}return(0,W.Z)(e,[{key:"inc",value:function(){this._refCounter+=1}},{key:"dec",value:function(){this._refCounter=Math.max(0,this._refCounter-1)}},{key:"hasRefs",value:function(){return this._refCounter>0}},{key:sb,get:function(){var e=this.cid.toString(gr.base58btc);return"WantlistEntry <key: ".concat(e,", priority: ").concat(this.priority,", refs: ").concat(this._refCounter,">")}},{key:"equals",value:function(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}}]),e}();fb=Symbol.toStringTag;var pb=function(){function e(t,n,r,i,o){(0,K.Z)(this,e),(0,ot.Z)(this,"entry",void 0),(0,ot.Z)(this,"cancel",void 0),(0,ot.Z)(this,"sendDontHave",void 0),this.entry=new hb(t,n,r),this.cancel=Boolean(i),this.sendDontHave=Boolean(o)}return(0,W.Z)(e,[{key:"cid",get:function(){return this.entry.cid},set:function(e){this.entry.cid=e}},{key:"priority",get:function(){return this.entry.priority},set:function(e){this.entry.priority=e}},{key:"wantType",get:function(){return this.entry.wantType},set:function(e){this.entry.wantType=e}},{key:fb,get:function(){var e=this.cid.toString(gr.base58btc);return"BitswapMessageEntry ".concat(e," <cancel: ").concat(this.cancel,", priority: ").concat(this.priority,">")}},{key:"equals",value:function(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}}]),e}(),db=function(e,t){var n=["bitswap"];return null!=t&&n.push(t),null!=e&&n.push("".concat(e.toString().slice(0,8))),(0,ru.kg)(n.join(":"))},vb=function(e,t){if(e.size!==t.size)return!1;var n,r=(0,Ae.Z)(e);try{for(r.s();!(n=r.n()).done;){var i=(0,k.Z)(n.value,2),o=i[0],a=i[1],s=t.get(o);if(void 0===s)return!1;if(a instanceof Uint8Array&&s instanceof Uint8Array&&!lb(a,s))return!1;if(a instanceof pb&&s instanceof pb&&!a.equals(s))return!1}}catch(u){r.e(u)}finally{r.f()}return!0};var yb,gb,mb=function(e){var t,n=new Uint8Array(e.reduce((function(e,t){return e+A().encodingLength(t)}),0)),r=0,i=(0,Ae.Z)(e);try{for(i.s();!(t=i.n()).done;){var o=t.value;n=S.encode(o,n,r),r+=A().encodingLength(o)}}catch(a){i.e(a)}finally{i.f()}return n};!function(e){var t,n,r;!function(t){var n,r,i;!function(e){e.Block="Block",e.Have="Have"}(t.WantType||(t.WantType={})),function(e){e[e.Block=0]="Block",e[e.Have=1]="Have"}(r||(r={})),function(e){e.codec=function(){return co(r)}}(n=t.WantType||(t.WantType={})),function(t){var i;t.codec=function(){return null==i&&(i=lo((function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==i.lengthDelimited&&n.fork(),null!=t.block&&t.block.byteLength>0&&(n.uint32(10),n.bytes(t.block)),null!=t.priority&&0!==t.priority&&(n.uint32(16),n.int32(t.priority)),null!=t.cancel&&!1!==t.cancel&&(n.uint32(24),n.bool(t.cancel)),null!=t.wantType&&0!==r[t.wantType]&&(n.uint32(32),e.Wantlist.WantType.codec().encode(t.wantType,n)),null!=t.sendDontHave&&!1!==t.sendDontHave&&(n.uint32(40),n.bool(t.sendDontHave)),!1!==i.lengthDelimited&&n.ldelim()}),(function(t,r){for(var i={block:new Uint8Array(0),priority:0,cancel:!1,wantType:n.Block,sendDontHave:!1},o=null==r?t.len:t.pos+r;t.pos<o;){var a=t.uint32();switch(a>>>3){case 1:i.block=t.bytes();break;case 2:i.priority=t.int32();break;case 3:i.cancel=t.bool();break;case 4:i.wantType=e.Wantlist.WantType.codec().decode(t);break;case 5:i.sendDontHave=t.bool();break;default:t.skipType(7&a)}}return i}))),i},t.encode=function(e){return so(e,t.codec())},t.decode=function(e){return ao(e,t.codec())}}(t.Entry||(t.Entry={})),t.codec=function(){return null==i&&(i=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==r.lengthDelimited&&n.fork(),null!=t.entries){var i,o=(0,Ae.Z)(t.entries);try{for(o.s();!(i=o.n()).done;){var a=i.value;n.uint32(10),e.Wantlist.Entry.codec().encode(a,n)}}catch(s){o.e(s)}finally{o.f()}}null!=t.full&&!1!==t.full&&(n.uint32(16),n.bool(t.full)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={entries:[],full:!1},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.entries.push(e.Wantlist.Entry.codec().decode(t,t.uint32()));break;case 2:r.full=t.bool();break;default:t.skipType(7&o)}}return r}))),i},t.encode=function(e){return so(e,t.codec())},t.decode=function(e){return ao(e,t.codec())}}(e.Wantlist||(e.Wantlist={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.prefix&&e.prefix.byteLength>0&&(t.uint32(10),t.bytes(e.prefix)),null!=e.data&&e.data.byteLength>0&&(t.uint32(18),t.bytes(e.data)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={prefix:new Uint8Array(0),data:new Uint8Array(0)},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.prefix=e.bytes();break;case 2:n.data=e.bytes();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(e.Block||(e.Block={})),function(e){e.Have="Have",e.DontHave="DontHave"}(e.BlockPresenceType||(e.BlockPresenceType={})),function(e){e[e.Have=0]="Have",e[e.DontHave=1]="DontHave"}(n||(n={})),function(e){e.codec=function(){return co(n)}}(t=e.BlockPresenceType||(e.BlockPresenceType={})),function(r){var i;r.codec=function(){return null==i&&(i=lo((function(t,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==i.lengthDelimited&&r.fork(),null!=t.cid&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),null!=t.type&&0!==n[t.type]&&(r.uint32(16),e.BlockPresenceType.codec().encode(t.type,r)),!1!==i.lengthDelimited&&r.ldelim()}),(function(n,r){for(var i={cid:new Uint8Array(0),type:t.Have},o=null==r?n.len:n.pos+r;n.pos<o;){var a=n.uint32();switch(a>>>3){case 1:i.cid=n.bytes();break;case 2:i.type=e.BlockPresenceType.codec().decode(n);break;default:n.skipType(7&a)}}return i}))),i},r.encode=function(e){return so(e,r.codec())},r.decode=function(e){return ao(e,r.codec())}}(e.BlockPresence||(e.BlockPresence={})),e.codec=function(){return null==r&&(r=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==r.lengthDelimited&&n.fork(),null!=t.wantlist&&(n.uint32(10),e.Wantlist.codec().encode(t.wantlist,n)),null!=t.blocks){var i,o=(0,Ae.Z)(t.blocks);try{for(o.s();!(i=o.n()).done;){var a=i.value;n.uint32(18),n.bytes(a)}}catch(p){o.e(p)}finally{o.f()}}if(null!=t.payload){var s,u=(0,Ae.Z)(t.payload);try{for(u.s();!(s=u.n()).done;){var c=s.value;n.uint32(26),e.Block.codec().encode(c,n)}}catch(p){u.e(p)}finally{u.f()}}if(null!=t.blockPresences){var l,f=(0,Ae.Z)(t.blockPresences);try{for(f.s();!(l=f.n()).done;){var h=l.value;n.uint32(34),e.BlockPresence.codec().encode(h,n)}}catch(p){f.e(p)}finally{f.f()}}null!=t.pendingBytes&&0!==t.pendingBytes&&(n.uint32(40),n.int32(t.pendingBytes)),!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={blocks:[],payload:[],blockPresences:[],pendingBytes:0},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.wantlist=e.Wantlist.codec().decode(t,t.uint32());break;case 2:r.blocks.push(t.bytes());break;case 3:r.payload.push(e.Block.codec().decode(t,t.uint32()));break;case 4:r.blockPresences.push(e.BlockPresence.codec().decode(t,t.uint32()));break;case 5:r.pendingBytes=t.int32();break;default:t.skipType(7&o)}}return r}))),r},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(yb||(yb={})),gb=Symbol.toStringTag;var bb=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"full",void 0),(0,ot.Z)(this,"wantlist",void 0),(0,ot.Z)(this,"blocks",void 0),(0,ot.Z)(this,"blockPresences",void 0),(0,ot.Z)(this,"pendingBytes",void 0),this.full=t,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}return(0,W.Z)(e,[{key:"empty",get:function(){return 0===this.blocks.size&&0===this.wantlist.size&&0===this.blockPresences.size}},{key:"addEntry",value:function(t,n,r,i,o){null==r&&(r=e.WantType.Block);var a=t.toString(gr.base58btc),s=this.wantlist.get(a);null!=s?(s.wantType===r&&(s.priority=n),!0===i&&(s.cancel=Boolean(i)),!0===o&&(s.sendDontHave=Boolean(o)),r===e.WantType.Block&&s.wantType===e.WantType.Have&&(s.wantType=r)):this.wantlist.set(a,new pb(t,n,r,i,o))}},{key:"addBlock",value:function(e,t){var n=e.toString(gr.base58btc);this.blocks.set(n,t)}},{key:"addHave",value:function(t){var n=t.toString(gr.base58btc);this.blockPresences.has(n)||this.blockPresences.set(n,e.BlockPresenceType.Have)}},{key:"addDontHave",value:function(t){var n=t.toString(gr.base58btc);this.blockPresences.has(n)||this.blockPresences.set(n,e.BlockPresenceType.DontHave)}},{key:"cancel",value:function(t){var n=t.toString(gr.base58btc);this.wantlist.delete(n),this.addEntry(t,0,e.WantType.Block,!0,!1)}},{key:"setPendingBytes",value:function(e){this.pendingBytes=e}},{key:"serializeToBitswap100",value:function(){return yb.encode({wantlist:{entries:Array.from(this.wantlist.values()).map((function(e){return{block:e.cid.bytes,priority:Number(e.priority),cancel:Boolean(e.cancel),wantType:yb.Wantlist.WantType.Block,sendDontHave:!1}})),full:Boolean(this.full)},blocks:Array.from(this.blocks.values())})}},{key:"serializeToBitswap110",value:function(){var e,t={wantlist:{entries:Array.from(this.wantlist.values()).map((function(e){return{block:e.cid.bytes,priority:Number(e.priority),wantType:e.wantType,cancel:Boolean(e.cancel),sendDontHave:Boolean(e.sendDontHave)}})),full:Boolean(this.full)},blockPresences:[],payload:[],pendingBytes:this.pendingBytes,blocks:[]},n=(0,Ae.Z)(this.blocks.entries());try{for(n.s();!(e=n.n()).done;){var r=(0,k.Z)(e.value,2),i=r[0],o=r[1],a=c.CID.parse(i),s=a.version,u=a.code,l=a.multihash.code,f=a.multihash.digest.length,h=mb([s,u,l,f]);t.payload.push({prefix:h,data:o})}}catch(m){n.e(m)}finally{n.f()}var p,d=(0,Ae.Z)(this.blockPresences);try{for(d.s();!(p=d.n()).done;){var v=(0,k.Z)(p.value,2),y=v[0],g=v[1];t.blockPresences.push({cid:c.CID.parse(y).bytes,type:g})}}catch(m){d.e(m)}finally{d.f()}return this.pendingBytes>0&&(t.pendingBytes=this.pendingBytes),yb.encode(t)}},{key:"equals",value:function(e){return!!(this.full===e.full&&this.pendingBytes===e.pendingBytes&&vb(this.wantlist,e.wantlist)&&vb(this.blocks,e.blocks)&&vb(this.blockPresences,e.blockPresences))}},{key:gb,get:function(){var e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return"BitswapMessage <full: ".concat(this.full,", list: ").concat(e,", blocks: ").concat(t,">")}}]),e}();(0,ot.Z)(bb,"Entry",pb),(0,ot.Z)(bb,"WantType",{Block:yb.Wantlist.WantType.Block,Have:yb.Wantlist.WantType.Have}),(0,ot.Z)(bb,"BlockPresenceType",{Have:yb.BlockPresenceType.Have,DontHave:yb.BlockPresenceType.DontHave}),(0,ot.Z)(bb,"deserialize",function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=yb.decode(t),a=!0===(null===(r=o.wantlist)||void 0===r?void 0:r.full),l=new bb(a),null===(i=o.wantlist)||void 0===i||i.entries.forEach((function(e){var t;if(null!=e.block){var n=c.CID.decode(e.block);l.addEntry(n,null!==(t=e.priority)&&void 0!==t?t:0,e.wantType,Boolean(e.cancel),Boolean(e.sendDontHave))}})),o.blockPresences.forEach((function(e){if(null!=e.cid){var t=c.CID.decode(e.cid);e.type===bb.BlockPresenceType.Have?l.addHave(t):l.addDontHave(t)}})),!(o.blocks.length>0)){e.next=9;break}return e.next=8,Promise.all(o.blocks.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h.sha256.digest(t);case 2:n=e.sent,r=c.CID.createV0(n),l.addBlock(r,t);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:case 14:return e.abrupt("return",l);case 9:if(!(o.payload.length>0)){e.next=14;break}return e.next=12,Promise.all(o.payload.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var r,i,o,a,u,f,p;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.prefix&&null!=t.data){e.next=2;break}return e.abrupt("return");case 2:if(r=cb()(t.prefix),i=r[0],o=r[1],(a=r[2])!==h.sha256.code){e.next=10;break}e.t0=h.sha256,e.next=13;break;case 10:return e.next=12,null===n||void 0===n?void 0:n.getHasher(a);case 12:e.t0=e.sent;case 13:if(null!=(u=e.t0)){e.next=16;break}throw new ar.s("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");case 16:return e.next=18,u.digest(t.data);case 18:f=e.sent,p=c.CID.create(i,o,f),l.addBlock(p,t.data);case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 12:return l.setPendingBytes(o.pendingBytes),e.abrupt("return",l);case 15:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),(0,ot.Z)(bb,"blockPresenceSize",(function(e){return e.bytes.length+1}));var wb=yb.Wantlist.WantType.Block,kb=yb.Wantlist.WantType.Have,Eb=function(){function e(t,n){(0,K.Z)(this,e),(0,ot.Z)(this,"set",void 0),(0,ot.Z)(this,"_stats",void 0),this.set=null!=n?ab({name:"ipfs_bitswap_wantlist",metrics:n.metrics}):new Map,this._stats=t}return(0,W.Z)(e,[{key:"length",get:function(){return this.set.size}},{key:"add",value:function(e,t,n){var r=e.toString(gr.base58btc),i=this.set.get(r);null!=i?(i.inc(),i.priority=t,i.wantType===kb&&n===wb&&(i.wantType=n)):(this.set.set(r,new hb(e,t,n)),null!=this._stats&&this._stats.push(void 0,"wantListSize",1))}},{key:"remove",value:function(e){var t=e.toString(gr.base58btc),n=this.set.get(t);null!=n&&(n.dec(),n.hasRefs()||(this.set.delete(t),null!=this._stats&&this._stats.push(void 0,"wantListSize",-1)))}},{key:"removeForce",value:function(e){this.set.has(e)&&this.set.delete(e)}},{key:"forEach",value:function(e){this.set.forEach(e)}},{key:"entries",value:function(){return this.set.entries()}},{key:"sortedEntries",value:function(){return new Map((e=function(e){return e[1].key},t=Array.from(this.set.entries()),Array.prototype.slice.call(t,0).sort((function(t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}))));var e,t}},{key:"contains",value:function(e){var t=e.toString(gr.base58btc);return this.set.has(t)}},{key:"get",value:function(e){var t=e.toString(gr.base58btc);return this.set.get(t)}}]),e}();(0,ot.Z)(Eb,"Entry",hb);var xb,_b=function(){function e(t){(0,K.Z)(this,e),(0,ot.Z)(this,"partner",void 0),(0,ot.Z)(this,"wantlist",void 0),(0,ot.Z)(this,"exchangeCount",void 0),(0,ot.Z)(this,"accounting",void 0),(0,ot.Z)(this,"lastExchange",void 0),this.partner=t,this.wantlist=new Eb,this.exchangeCount=0,this.accounting={bytesSent:0,bytesRecv:0}}return(0,W.Z)(e,[{key:"sentBytes",value:function(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesSent+=e}},{key:"receivedBytes",value:function(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesRecv+=e}},{key:"wants",value:function(e,t,n){this.wantlist.add(e,t,n)}},{key:"cancelWant",value:function(e){this.wantlist.remove(e)}},{key:"wantlistContains",value:function(e){return this.wantlist.get(e)}},{key:"debtRatio",value:function(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}}]),e}();xb=Symbol.iterator;var Sb=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;(0,K.Z)(this,n),i=t.call(this),(0,ot.Z)((0,nr.Z)(i),"_cmp",void 0),(0,ot.Z)((0,nr.Z)(i),"_keys",void 0),i._cmp=null!==r&&void 0!==r?r:i._defaultSort,i._keys=[];var o,a=(0,Ae.Z)(null!==e&&void 0!==e?e:[]);try{for(a.s();!(o=a.n()).done;){var s=(0,k.Z)(o.value,2),u=s[0],c=s[1];i.set(u,c)}}catch(l){a.e(l)}finally{a.f()}return i}return(0,W.Z)(n,[{key:"update",value:function(e){if(!(e<0||e>=this._keys.length)){var t=this._keys[e];this._keys.splice(e,1);var n=this._find(t);this._keys.splice(n,0,t)}}},{key:"set",value:function(e,t){if(this.has(e)){var r=this.indexOf(e);this._keys.splice(r,1)}(0,Ah.Z)((0,Zh.Z)(n.prototype),"set",this).call(this,e,t);var i=this._find(e);return this._keys.splice(i,0,e),this}},{key:"clear",value:function(){(0,Ah.Z)((0,Zh.Z)(n.prototype),"clear",this).call(this),this._keys=[]}},{key:"delete",value:function(e){if(!this.has(e))return!1;var t=this.indexOf(e);return this._keys.splice(t,1),(0,Ah.Z)((0,Zh.Z)(n.prototype),"delete",this).call(this,e)}},{key:"indexOf",value:function(e){if(!this.has(e))return-1;var t=this._find(e);if(this._keys[t]===e)return t;for(var n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}},{key:"_find",value:function(e){for(var t=0,n=this._keys.length;t<n;){var r=t+n>>>1,i=this._kCmp(this._keys[r],e);if(i<0)t=r+1;else{if(!(i>0))return r;n=r}}return t}},{key:"keys",value:(0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(this._keys),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,r;case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:return e.abrupt("return",void 0);case 18:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:"values",value:(0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(this._keys),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,this.get(r);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:return e.abrupt("return",void 0);case 18:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:"entries",value:(0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,Ae.Z)(this._keys),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,[r,this.get(r)];case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:return e.abrupt("return",void 0);case 18:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:xb,value:(0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.entries(),"t0",1);case 1:case"end":return e.stop()}}),e,this)}))},{key:"forEach",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this;if(null!=e){var n,r=(0,Ae.Z)(this._keys);try{for(r.s();!(n=r.n()).done;){var i=n.value,o=this.get(i);if(null==o)throw new Error("Value cannot be undefined");e.apply(t,[[i,o]])}}catch(a){r.e(a)}finally{r.f()}}}},{key:"_defaultSort",value:function(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}},{key:"_kCmp",value:function(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}}]),n}((0,Ze.Z)(Map)),Ab={hasNewInfo:function(){return!1},merge:function(){}},Zb=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ab;(0,K.Z)(this,e),(0,ot.Z)(this,"_taskMerger",void 0),(0,ot.Z)(this,"_byPeer",void 0),this._taskMerger=t,this._byPeer=new Sb([],Tb.compare)}return(0,W.Z)(e,[{key:"pushTasks",value:function(e,t){var n=this._byPeer.get(e.toString());null==n&&(n=new Tb(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}},{key:"popTasks",value:function(e){var t=this._head();if(void 0===t)return{tasks:[],pendingSize:0};var n=t.popTasks(e),r=n.tasks,i=n.pendingSize;if(0===r.length)return{tasks:r,pendingSize:i};var o=t.peerId;return t.isIdle()?this._byPeer.delete(o.toString()):this._byPeer.update(0),{peerId:o,tasks:r,pendingSize:i}}},{key:"_head",value:function(){if(0!==this._byPeer.size){var e,t=(0,Ae.Z)(this._byPeer);try{for(t.s();!(e=t.n()).done;){return(0,k.Z)(e.value,2)[1]}}catch(n){t.e(n)}finally{t.f()}}}},{key:"remove",value:function(e,t){var n=this._byPeer.get(t.toString());null===n||void 0===n||n.remove(e)}},{key:"tasksDone",value:function(e,t){var n=this._byPeer.get(e.toString());if(null!=n){var r,i=this._byPeer.indexOf(e.toString()),o=(0,Ae.Z)(t);try{for(o.s();!(r=o.n()).done;){var a=r.value;n.taskDone(a)}}catch(s){o.e(s)}finally{o.f()}this._byPeer.update(i)}}}]),e}(),Tb=function(){function e(t,n){(0,K.Z)(this,e),(0,ot.Z)(this,"peerId",void 0),(0,ot.Z)(this,"_taskMerger",void 0),(0,ot.Z)(this,"_activeTotalSize",void 0),(0,ot.Z)(this,"_pending",void 0),(0,ot.Z)(this,"_active",void 0),this.peerId=t,this._taskMerger=n,this._activeTotalSize=0,this._pending=new Cb,this._active=new Set}return(0,W.Z)(e,[{key:"pushTasks",value:function(e){var t,n=(0,Ae.Z)(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;this._pushTask(r)}}catch(i){n.e(i)}finally{n.f()}}},{key:"_pushTask",value:function(e){if(this._taskHasMoreInfoThanActiveTasks(e)){var t=this._pending.get(e.topic);if(null!=t)return e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),void this._taskMerger.merge(e,t);this._pending.add(e)}}},{key:"_taskHasMoreInfoThanActiveTasks",value:function(e){var t,n=[],r=(0,Ae.Z)(this._active);try{for(r.s();!(t=r.n()).done;){var i=t.value;i.topic===e.topic&&n.push(i)}}catch(o){r.e(o)}finally{r.f()}return 0===n.length||this._taskMerger.hasNewInfo(e,n)}},{key:"popTasks",value:function(e){for(var t=0,n=[],r=this._pending.tasks(),i=0;i<r.length&&t<e;i++){var o=r[i];n.push(o),t+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:n,pendingSize:this._pending.totalSize}}},{key:"taskDone",value:function(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}},{key:"remove",value:function(e){this._pending.delete(e)}},{key:"isIdle",value:function(){return 0===this._pending.length&&0===this._active.size}}],[{key:"compare",value:function(e,t){return 0===e[1]._pending.length?1:0===t[1]._pending.length?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}}]),e}(),Cb=function(){function e(){(0,K.Z)(this,e),(0,ot.Z)(this,"_tasks",void 0),this._tasks=new Sb([],this._compare)}return(0,W.Z)(e,[{key:"length",get:function(){return this._tasks.size}},{key:"totalSize",get:function(){return(0,ye.Z)(this._tasks.values()).reduce((function(e,t){return e+t.task.size}),0)}},{key:"get",value:function(e){var t,n;return null===(t=this._tasks)||void 0===t||null===(n=t.get(e))||void 0===n?void 0:n.task}},{key:"add",value:function(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}},{key:"delete",value:function(e){this._tasks.delete(e)}},{key:"tasks",value:function(){return(0,ye.Z)(this._tasks.values()).map((function(e){return e.task}))}},{key:"updatePriority",value:function(e,t){var n=this._tasks.get(e);if(null!=n){var r=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(r)}}},{key:"_compare",value:function(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}}]),e}(),Ib={hasNewInfo:function(e,t){var n,r=!1,i=!1,o=(0,Ae.Z)(t);try{for(o.s();!(n=o.n()).done;){var a=n.value;a.data.haveBlock&&(r=!0),a.data.isWantBlock&&(i=!0)}}catch(s){o.e(s)}finally{o.f()}return!(i||!e.data.isWantBlock)||!(r||!e.data.haveBlock)},merge:function(e,t){var n=e.data,r=t.data;!r.haveBlock&&n.haveBlock&&(r.haveBlock=n.haveBlock,r.blockSize=n.blockSize),!r.isWantBlock&&n.isWantBlock&&(r.isWantBlock=!0,r.haveBlock&&!n.haveBlock||(r.haveBlock=n.haveBlock,t.size=e.size)),r.isWantBlock&&r.haveBlock&&(t.size=r.blockSize)}},Db=bb.WantType,Ob=function(){function e(t,n,r,i,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"_log",void 0),(0,ot.Z)(this,"blockstore",void 0),(0,ot.Z)(this,"network",void 0),(0,ot.Z)(this,"_stats",void 0),(0,ot.Z)(this,"_opts",void 0),(0,ot.Z)(this,"ledgerMap",void 0),(0,ot.Z)(this,"_running",void 0),(0,ot.Z)(this,"_requestQueue",void 0),this._log=db(t,"engine"),this.blockstore=n,this.network=r,this._stats=i,this._opts=this._processOpts(a),this.ledgerMap=ab({name:"ipfs_bitswap_ledger_map",metrics:o.metrics}),this._running=!1,this._requestQueue=new Zb(Ib)}return(0,W.Z)(e,[{key:"_processOpts",value:function(e){return(0,Nt.Z)({maxSizeReplaceHasWithBlock:1024,targetMessageSize:16384},e)}},{key:"_scheduleProcessTasks",value:function(){var e=this;setTimeout((function(){e._processTasks().catch((function(t){e._log.error("error processing stats",t)}))}))}},{key:"_processTasks",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,l,f,h,p,d,v,y,g,m,b,w,E,x,_,S,A,Z;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._running){e.next=2;break}return e.abrupt("return");case 2:if(t=this._requestQueue.popTasks(this._opts.targetMessageSize),n=t.peerId,r=t.tasks,i=t.pendingSize,0!==r.length){e.next=5;break}return e.abrupt("return");case 5:(o=new bb(!1)).setPendingBytes(i),a=[],u=new Map,l=(0,Ae.Z)(r);try{for(l.s();!(f=l.n()).done;)h=f.value,p=c.CID.parse(h.topic),h.data.haveBlock?h.data.isWantBlock?(a.push(p),u.set(h.topic,h.data)):o.addHave(p):o.addDontHave(p)}catch(s){l.e(s)}finally{l.f()}return e.next=13,this._getBlocks(a);case 13:d=e.sent,v=(0,Ae.Z)(u);try{for(v.s();!(y=v.n()).done;)g=(0,k.Z)(y.value,2),m=g[0],b=g[1],w=c.CID.parse(m),null!=(E=d.get(m))?o.addBlock(w,E):b.sendDontHave&&o.addDontHave(w)}catch(s){v.e(s)}finally{v.f()}if(!o.empty){e.next=20;break}return null!=n&&this._requestQueue.tasksDone(n,r),this._scheduleProcessTasks(),e.abrupt("return");case 20:if(e.prev=20,e.t0=null!=n,!e.t0){e.next=25;break}return e.next=25,this.network.sendMessage(n,o);case 25:x=(0,Ae.Z)(d.entries());try{for(x.s();!(_=x.n()).done;)S=(0,k.Z)(_.value,2),A=S[0],Z=S[1],null!=n&&this.messageSent(n,c.CID.parse(A),Z)}catch(s){x.e(s)}finally{x.f()}e.next=32;break;case 29:e.prev=29,e.t1=e.catch(20),this._log.error(e.t1);case 32:null!=n&&this._requestQueue.tasksDone(n,r),this._scheduleProcessTasks();case 34:case"end":return e.stop()}}),e,this,[[20,29]])})));return function(){return e.apply(this,arguments)}}()},{key:"wantlistForPeer",value:function(e){var t=e.toString(),n=this.ledgerMap.get(t);return null!=n?n.wantlist.sortedEntries():new Map}},{key:"ledgerForPeer",value:function(e){var t=e.toString(),n=this.ledgerMap.get(t);if(null!=n)return{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}}},{key:"peers",value:function(){return Array.from(this.ledgerMap.values()).map((function(e){return e.partner}))}},{key:"receivedBlocks",value:function(e){if(0!==e.length){var t,n=(0,Ae.Z)(this.ledgerMap.values());try{for(n.s();!(t=n.n()).done;){var r,i=t.value,o=(0,Ae.Z)(e);try{for(o.s();!(r=o.n()).done;){var a=r.value,s=a.cid,u=a.block,c=i.wantlistContains(s);if(null!=c){var l=u.length,f=this._sendAsBlock(c.wantType,l),h=l;f||(h=bb.blockPresenceSize(c.cid)),this._requestQueue.pushTasks(i.partner,[{topic:c.cid.toString(gr.base58btc),priority:c.priority,size:h,data:{blockSize:l,isWantBlock:f,haveBlock:!0,sendDontHave:!1}}])}}}catch(p){o.e(p)}finally{o.f()}}}catch(p){n.e(p)}finally{n.f()}this._scheduleProcessTasks()}}},{key:"messageReceived",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._findOrCreate(t),!n.empty){e.next=3;break}return e.abrupt("return");case 3:if(n.full&&(r.wantlist=new Eb),this._updateBlockAccounting(n.blocks,r),0!==n.wantlist.size){e.next=8;break}return this._scheduleProcessTasks(),e.abrupt("return");case 8:return i=[],o=[],n.wantlist.forEach((function(e){e.cancel?(r.cancelWant(e.cid),i.push(e.cid)):(r.wants(e.cid,e.priority,e.wantType),o.push(e))})),this._cancelWants(t,i),e.next=14,this._addWants(t,o);case 14:this._scheduleProcessTasks();case 15:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_cancelWants",value:function(e,t){var n,r=(0,Ae.Z)(t);try{for(r.s();!(n=r.n()).done;){var i=n.value;this._requestQueue.remove(i.toString(gr.base58btc),e)}}catch(o){r.e(o)}finally{r.f()}}},{key:"_addWants",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getBlockSizes(n.map((function(e){return e.cid})));case 2:r=e.sent,i=[],o=(0,Ae.Z)(n);try{for(o.s();!(a=o.n()).done;)u=a.value,c=u.cid.toString(gr.base58btc),null==(l=r.get(c))?u.sendDontHave&&i.push({topic:c,priority:u.priority,size:bb.blockPresenceSize(u.cid),data:{isWantBlock:u.wantType===Db.Block,blockSize:0,haveBlock:!1,sendDontHave:u.sendDontHave}}):(f=this._sendAsBlock(u.wantType,l),h=l,f||(h=bb.blockPresenceSize(u.cid)),i.push({topic:c,priority:u.priority,size:h,data:{isWantBlock:f,blockSize:l,haveBlock:!0,sendDontHave:u.sendDontHave}})),this._requestQueue.pushTasks(t,i)}catch(s){o.e(s)}finally{o.f()}case 6:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_sendAsBlock",value:function(e,t){return e===Db.Block||t<=this._opts.maxSizeReplaceHasWithBlock}},{key:"_getBlockSizes",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getBlocks(t);case 2:return n=e.sent,e.abrupt("return",new Map((0,ye.Z)(n).map((function(e){var t=(0,k.Z)(e,2);return[t[0],t[1].length]}))));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getBlocks",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Map,e.next=3,Promise.all(t.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.blockstore.get(t);case 3:i=e.sent,n.set(t.toString(gr.base58btc),i),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),"ERR_NOT_FOUND"!==e.t0.code&&r._log.error("failed to query blockstore for %s: %s",t,e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t){return e.apply(this,arguments)}}()));case 3:return e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateBlockAccounting",value:function(e,t){var n,r=(0,Ae.Z)(e.values());try{for(r.s();!(n=r.n()).done;){var i=n.value;this._log("got block (%s bytes)",i.length),t.receivedBytes(i.length)}}catch(o){r.e(o)}finally{r.f()}}},{key:"messageSent",value:function(e,t,n){var r=this._findOrCreate(e);r.sentBytes(n.length),r.wantlist.remove(t)}},{key:"numBytesSentTo",value:function(e){return this._findOrCreate(e).accounting.bytesSent}},{key:"numBytesReceivedFrom",value:function(e){return this._findOrCreate(e).accounting.bytesRecv}},{key:"peerDisconnected",value:function(e){this.ledgerMap.delete(e.toString())}},{key:"_findOrCreate",value:function(e){var t=e.toString(),n=this.ledgerMap.get(t);if(null!=n)return n;var r=new _b(e);return this.ledgerMap.set(t,r),null!=this._stats&&this._stats.push(t,"peerCount",1),r}},{key:"start",value:function(){this._running=!0}},{key:"stop",value:function(){this._running=!1}}]),e}(),Rb=Symbol.for("@libp2p/topology");function Pb(e){return null!=e&&Boolean(e[Rb])}var Lb=function(){},Nb=function(e){function t(e){var n,r,i,o;(0,K.Z)(this,t),this.min=null!==(n=e.min)&&void 0!==n?n:0,this.max=null!==(r=e.max)&&void 0!==r?r:1/0,this.peers=new Set,this.onConnect=null!==(i=e.onConnect)&&void 0!==i?i:Lb,this.onDisconnect=null!==(o=e.onDisconnect)&&void 0!==o?o:Lb}return(0,W.Z)(t,[{key:e,get:function(){return Rb.toString()}},{key:Rb,get:function(){return!0}},{key:"setRegistrar",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.registrar=t;case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"disconnect",value:function(e){this.onDisconnect(e)}}]),t}(Symbol.toStringTag);function Bb(e){return new Nb(e)}function Mb(e){return null!=e[Symbol.asyncIterator]}var Fb=function e(t){var n=Ct.encodingLength(t),r=Sm(n);return Ct.encode(t,r),e.bytes=n,r};function jb(e,t){var n,r,i=(0,s.Z)().mark(a),o=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:Fb;function a(e){var t;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!((t=o(e.byteLength))instanceof Uint8Array)){n.next=6;break}return n.next=4,t;case 4:n.next=7;break;case 6:return n.delegateYield(t,"t0",7);case 7:if(!(e instanceof Uint8Array)){n.next=12;break}return n.next=10,e;case 10:n.next=13;break;case 12:return n.delegateYield(e,"t1",13);case 13:case"end":return n.stop()}}),i)}return Mb(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=12;break}return c=u.value,t.delegateYield((0,at.Z)((0,y.Z)(a(c)),m.Z),"t0",9);case 9:n=!1,t.next=4;break;case 12:t.next=18;break;case 14:t.prev=14,t.t1=t.catch(2),r=!0,i=t.t1;case 18:if(t.prev=18,t.prev=19,!n||null==o.return){t.next=23;break}return t.next=23,(0,m.Z)(o.return());case 23:if(t.prev=23,!r){t.next=26;break}throw i;case 26:return t.finish(23);case 27:return t.finish(18);case 28:case"end":return t.stop()}}),t,null,[[2,14,18,28],[19,,23,27]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=8;break}return i=r.value,t.delegateYield(a(i),"t0",6);case 6:t.next=3;break;case 8:t.next=13;break;case 10:t.prev=10,t.t1=t.catch(1),n.e(t.t1);case 13:return t.prev=13,n.f(),t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[1,10,13,16]])}))()}Fb.bytes=0,jb.single=function(e,t){var n,r,i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:Fb;return new vt(i(e.byteLength),e)};var Ub;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(Ub||(Ub={}));var zb=function e(t){var n=Ct.decode(t);return e.bytes=Ct.encodingLength(n),n};function Hb(e,t){var n,r,i,o=(0,s.Z)().mark(p),a=new vt,u=Ub.LENGTH,c=-1,l=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:zb,f=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,h=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function p(){var e,n;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!(a.byteLength>0)){r.next=32;break}if(u!==Ub.LENGTH){r.next=21;break}if(r.prev=2,!((c=l(a))<0)){r.next=6;break}throw Mt()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");case 6:if(!(c>h)){r.next=8;break}throw Mt()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");case 8:e=l.bytes,a.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(c),u=Ub.DATA,r.next=21;break;case 14:if(r.prev=14,r.t0=r.catch(2),!(r.t0 instanceof RangeError)){r.next=20;break}if(!(a.byteLength>f)){r.next=19;break}throw Mt()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");case 19:return r.abrupt("break",32);case 20:throw r.t0;case 21:if(u!==Ub.DATA){r.next=30;break}if(!(a.byteLength<c)){r.next=24;break}return r.abrupt("break",32);case 24:return n=a.sublist(0,c),a.consume(c),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(n),r.next=29,n;case 29:u=Ub.LENGTH;case 30:r.next=0;break;case 32:case"end":return r.stop()}}),o,null,[[2,14]])}return Mb(e)?(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(u=t.sent).done)){t.next=13;break}return c=u.value,a.append(c),t.delegateYield((0,at.Z)((0,y.Z)(p()),m.Z),"t0",10);case 10:n=!1,t.next=4;break;case 13:t.next=19;break;case 15:t.prev=15,t.t1=t.catch(2),r=!0,i=t.t1;case 19:if(t.prev=19,t.prev=20,!n||null==o.return){t.next=24;break}return t.next=24,(0,m.Z)(o.return());case 24:if(t.prev=24,!r){t.next=27;break}throw i;case 27:return t.finish(24);case 28:return t.finish(19);case 29:if(!(a.byteLength>0)){t.next=31;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 31:case"end":return t.stop()}}),t,null,[[2,15,19,29],[20,,24,28]])})))():(0,s.Z)().mark((function t(){var n,r,i;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=(0,Ae.Z)(e),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=9;break}return i=r.value,a.append(i),t.delegateYield(p(),"t0",7);case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t1=t.catch(1),n.e(t.t1);case 14:return t.prev=14,n.f(),t.finish(14);case 17:if(!(a.byteLength>0)){t.next=19;break}throw Mt()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");case 19:case"end":return t.stop()}}),t,null,[[1,11,14,17]])}))()}zb.bytes=0,Hb.fromReader=function(e,t){var n=1;return Hb((0,g.Z)((0,s.Z)().mark((function t(){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=1,t.next=4,(0,m.Z)(e.next(n));case 4:if(r=t.sent,i=r.done,o=r.value,!0!==i){t.next=9;break}return t.abrupt("return");case 9:if(null==o){t.next=12;break}return t.next=12,o;case 12:t.next=19;break;case 14:if(t.prev=14,t.t0=t.catch(1),"ERR_UNDER_READ"!==t.t0.code){t.next=18;break}return t.abrupt("return",{done:!0,value:null});case 18:throw t.t0;case 19:return t.prev=19,n=1,t.finish(19);case 22:t.next=0;break;case 24:case"end":return t.stop()}}),t,null,[[1,14,19,22]])})))(),(0,Nt.Z)((0,Nt.Z)({},null!==t&&void 0!==t?t:{}),{},{onLength:function(e){n=e}}))};var Vb=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;return(0,K.Z)(this,n),(i=t.call(this,e)).detail=r,i}return(0,W.Z)(n)}((0,Ze.Z)(Event)),Gb=n(68363),Kb=Math.pow(2,31)-1,Wb="/ipfs/bitswap/1.0.0",qb="/ipfs/bitswap/1.1.0",Yb="/ipfs/bitswap/1.2.0",Qb=function(){function e(t,n,r){var i,o,a,c,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"_log",void 0),(0,ot.Z)(this,"_libp2p",void 0),(0,ot.Z)(this,"_bitswap",void 0),(0,ot.Z)(this,"_protocols",void 0),(0,ot.Z)(this,"_stats",void 0),(0,ot.Z)(this,"_running",void 0),(0,ot.Z)(this,"_hashLoader",void 0),(0,ot.Z)(this,"_maxInboundStreams",void 0),(0,ot.Z)(this,"_maxOutboundStreams",void 0),(0,ot.Z)(this,"_incomingStreamTimeout",void 0),(0,ot.Z)(this,"_registrarIds",void 0),this._log=db(t.peerId,"network"),this._libp2p=t,this._bitswap=n,this._protocols=[Wb],!0!==l.b100Only&&(this._protocols.unshift(qb),this._protocols.unshift(Yb)),this._stats=r,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=null!==(i=l.hashLoader)&&void 0!==i?i:{getHasher:function(){return(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not implemented");case 1:case"end":return e.stop()}}),e)})))()}},this._maxInboundStreams=null!==(o=l.maxInboundStreams)&&void 0!==o?o:1024,this._maxOutboundStreams=null!==(a=l.maxOutboundStreams)&&void 0!==a?a:1024,this._incomingStreamTimeout=null!==(c=l.incomingStreamTimeout)&&void 0!==c?c:3e4}return(0,W.Z)(e,[{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._running=!0,e.next=3,this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});case 3:t=Bb({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect}),this._registrarIds=[],n=(0,Ae.Z)(this._protocols),e.prev=6,n.s();case 8:if((r=n.n()).done){e.next=17;break}return i=r.value,e.t0=this._registrarIds,e.next=13,this._libp2p.register(i,t);case 13:e.t1=e.sent,e.t0.push.call(e.t0,e.t1);case 15:e.next=8;break;case 17:e.next=22;break;case 19:e.prev=19,e.t2=e.catch(6),n.e(e.t2);case 22:return e.prev=22,n.f(),e.finish(22);case 25:this._libp2p.getConnections().forEach((function(e){o._onPeerConnect(e.remotePeer)}));case 26:case"end":return e.stop()}}),e,this,[[6,19,22,25]])})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._running=!1,e.next=3,this._libp2p.unhandle(this._protocols);case 3:if(null!=this._registrarIds){t=(0,Ae.Z)(this._registrarIds);try{for(t.s();!(n=t.n()).done;)r=n.value,this._libp2p.unregister(r)}catch(i){t.e(i)}finally{t.f()}this._registrarIds=[]}case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onConnection",value:function(e){var t=this;if(this._running){var n=e.stream,r=e.connection,i=new Gb.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t._log("incoming new bitswap %s connection from %p",n.stat.protocol,r.remotePeer),e.next=3,Qm(du(n.source,i.signal),(function(e){return Hb(e)}),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){var o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=!1,a=!1,e.prev=2,c=(0,y.Z)(n);case 4:return e.next=6,c.next();case 6:if(!(o=!(l=e.sent).done)){e.next=24;break}return f=l.value,e.prev=8,e.next=11,bb.deserialize(f.subarray(),t._hashLoader);case 11:return h=e.sent,e.next=14,t._bitswap._receiveMessage(r.remotePeer,h);case 14:e.next=20;break;case 16:return e.prev=16,e.t0=e.catch(8),t._bitswap._receiveError(e.t0),e.abrupt("break",24);case 20:i.reset();case 21:o=!1,e.next=4;break;case 24:e.next=30;break;case 26:e.prev=26,e.t1=e.catch(2),a=!0,u=e.t1;case 30:if(e.prev=30,e.prev=31,!o||null==c.return){e.next=35;break}return e.next=35,c.return();case 35:if(e.prev=35,!a){e.next=38;break}throw u;case 38:return e.finish(35);case 39:return e.finish(30);case 40:case"end":return e.stop()}}),e,null,[[2,26,30,40],[8,16],[31,,35,39]])})));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e)})))).catch((function(e){t._log(e),n.abort(e)})).finally((function(){i.clear(),n.close()}))}}},{key:"_onPeerConnect",value:function(e){this._bitswap._onPeerConnected(e)}},{key:"_onPeerDisconnect",value:function(e){this._bitswap._onPeerDisconnected(e)}},{key:"findProviders",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return null===(t=n.onProgress)||void 0===t||t.call(n,new Vb("bitswap:network:find-providers",e)),this._libp2p.contentRouting.findProviders(e,n)}},{key:"findAndConnect",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mm(Um(Vm(this.findProviders(t,n),function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.connectTo(t.id,n).catch((function(e){r._log.error(e)})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),3)).catch((function(e){r._log.error(e)}));case 2:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"provide",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null===(n=(r=i.length>1&&void 0!==i[1]?i[1]:{}).onProgress)||void 0===n||n.call(r,new Vb("bitswap:network:provide",t)),e.next=4,this._libp2p.contentRouting.provide(t,r);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"sendMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=a.length>2&&void 0!==a[2]?a[2]:{},this._running){e.next=3;break}throw new Error("network isn't running");case 3:return o=t.toString(),this._log("sendMessage to %s",o,n),null===(r=i.onProgress)||void 0===r||r.call(i,new Vb("bitswap:network:send-wantlist",t)),e.next=8,this._writeMessage(t,n,i);case 8:this._updateSentStats(t,n.blocks);case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"connectTo",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=i.length>1&&void 0!==i[1]?i[1]:{},this._running){e.next=3;break}throw new Error("network isn't running");case 3:return null===(n=r.onProgress)||void 0===n||n.call(r,new Vb("bitswap:network:dial",t)),e.abrupt("return",this._libp2p.dial(t,r));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateSentStats",value:function(e,t){var n=e.toString();if(null!=this._stats){var r,i=(0,Ae.Z)(t.values());try{for(i.s();!(r=i.n()).done;){var o=r.value;this._stats.push(n,"dataSent",o.length)}}catch(a){i.e(a)}finally{i.f()}this._stats.push(n,"blocksSent",t.size)}}},{key:"_writeMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=u.length>2&&void 0!==u[2]?u[2]:{},e.next=3,this._libp2p.dialProtocol(t,[Yb,qb,Wb]);case 3:i=e.sent,e.prev=4,e.t0=i.stat.protocol,e.next=e.t0===Wb?8:e.t0===qb||e.t0===Yb?10:12;break;case 8:return o=n.serializeToBitswap100(),e.abrupt("break",13);case 10:return o=n.serializeToBitswap110(),e.abrupt("break",13);case 12:throw new Error("Unknown protocol: ".concat(i.stat.protocol));case 13:return e.next=15,Qm([o],(function(e){return jb(e)}),i);case 15:e.next=21;break;case 17:e.prev=17,e.t1=e.catch(4),null===(a=r.onProgress)||void 0===a||a.call(r,new Vb("bitswap:network:send-wantlist:error",{peer:t,error:e.t1})),this._log(e.t1);case 21:return e.prev=21,i.close(),e.finish(21);case 24:case"end":return e.stop()}}),e,this,[[4,17,21,24]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),Xb=n(47465),$b=function(e){return"unwant:".concat(Om(e.multihash.bytes,"base64"))},Jb=function(e){return"block:".concat(Om(e.multihash.bytes,"base64"))},ew=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r;return(0,K.Z)(this,n),r=t.call(this),(0,ot.Z)((0,nr.Z)(r),"_log",void 0),r.setMaxListeners(1e3),r._log=db(e,"notif"),r}return(0,W.Z)(n,[{key:"hasBlock",value:function(e,t){var n=Jb(e);this._log(n),this.emit(n,t)}},{key:"wantBlock",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o=this,a=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.length>1&&void 0!==a[1]?a[1]:{},null!=t){e.next=3;break}throw new Error("Not a valid cid");case 3:return r=Jb(t),i=$b(t),this._log("wantBlock:".concat(t)),e.abrupt("return",new Promise((function(e,a){var s,u=function(){var e;o.removeListener(r,c),null===(e=n.onProgress)||void 0===e||e.call(n,new Vb("bitswap:want-block:unwant",t)),a(new Error("Block for ".concat(t," unwanted")))},c=function(r){var a;o.removeListener(i,u),null===(a=n.onProgress)||void 0===a||a.call(n,new Vb("bitswap:want-block:block",t)),e(r)};o.once(i,u),o.once(r,c),null===(s=n.signal)||void 0===s||s.addEventListener("abort",(function(){o.removeListener(r,c),o.removeListener(i,u),a(new Error("Want for ".concat(t," aborted")))}))})));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"unwantBlock",value:function(e){var t=$b(e);this._log(t),this.emit(t)}}]),n}(Xb.EventEmitter),tw=n(56755),nw=n.n(tw),rw=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;return(0,K.Z)(this,n),i=t.call(this),(0,ot.Z)((0,nr.Z)(i),"_options",void 0),(0,ot.Z)((0,nr.Z)(i),"_queue",void 0),(0,ot.Z)((0,nr.Z)(i),"_stats",void 0),(0,ot.Z)((0,nr.Z)(i),"_frequencyLastTime",void 0),(0,ot.Z)((0,nr.Z)(i),"_frequencyAccumulators",void 0),(0,ot.Z)((0,nr.Z)(i),"_movingAverages",void 0),(0,ot.Z)((0,nr.Z)(i),"_enabled",void 0),(0,ot.Z)((0,nr.Z)(i),"_timeout",void 0),i._options=r,i._queue=[],i._stats={},i._frequencyLastTime=Date.now(),i._frequencyAccumulators={},i._movingAverages={},i._update=i._update.bind((0,nr.Z)(i)),e.forEach((function(e){i._stats[e]=BigInt(0),i._movingAverages[e]={},i._options.movingAverageIntervals.forEach((function(t){(i._movingAverages[e][t]=nw()(t)).push(i._frequencyLastTime,0)}))})),i._enabled=i._options.enabled,i}return(0,W.Z)(n,[{key:"enable",value:function(){this._enabled=!0}},{key:"disable",value:function(){this._enabled=!1}},{key:"stop",value:function(){null!=this._timeout&&clearTimeout(this._timeout)}},{key:"snapshot",get:function(){return Object.assign({},this._stats)}},{key:"movingAverages",get:function(){return Object.assign({},this._movingAverages)}},{key:"push",value:function(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}},{key:"_resetComputeTimeout",value:function(){null!=this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}},{key:"_nextTimeout",value:function(){var e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}},{key:"_update",value:function(){if(this._timeout=void 0,this._queue.length>0){for(var e;this._queue.length>0;){var t=e=this._queue.shift();null!=t&&this._applyOp(t)}null!=e&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}},{key:"_updateFrequency",value:function(e){var t=this,n=e-this._frequencyLastTime;n>0&&Object.keys(this._stats).forEach((function(r){t._updateFrequencyFor(r,n,e)})),this._frequencyLastTime=e}},{key:"_updateFrequencyFor",value:function(e,t,n){var r,i=null!==(r=this._frequencyAccumulators[e])&&void 0!==r?r:0;this._frequencyAccumulators[e]=0;var o=i/t*1e3,a=this._movingAverages[e];null==a&&(a=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach((function(e){var t=a[e];null==t&&(t=a[e]=nw()(e)),t.push(n,o)}))}},{key:"_applyOp",value:function(e){var t=e[0],n=e[1];if("number"!==typeof n)throw new Error("invalid increment number: ".concat(n));Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),null==this._frequencyAccumulators[t]&&(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}}]),n}(Xb.EventEmitter),iw={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[6e4,3e5,9e5]},ow=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:iw;(0,K.Z)(this,n),r=t.call(this),(0,ot.Z)((0,nr.Z)(r),"_initialCounters",void 0),(0,ot.Z)((0,nr.Z)(r),"_options",void 0),(0,ot.Z)((0,nr.Z)(r),"_enabled",void 0),(0,ot.Z)((0,nr.Z)(r),"_global",void 0),(0,ot.Z)((0,nr.Z)(r),"_peers",void 0);var a=Object.assign({},iw,o);if("number"!==typeof a.computeThrottleTimeout)throw new Error("need computeThrottleTimeout");if("number"!==typeof a.computeThrottleMaxQueueSize)throw new Error("need computeThrottleMaxQueueSize");return r._initialCounters=i,r._options=a,r._enabled=r._options.enabled,r._global=new rw(i,a),r._global.on("update",(function(e){return r.emit("update",e)})),r._peers=ab({name:"ipfs_bitswap_stats_peers",metrics:e.metrics}),r}return(0,W.Z)(n,[{key:"enable",value:function(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}},{key:"disable",value:function(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}},{key:"stop",value:function(){this._enabled=!1,this._global.stop();var e,t=(0,Ae.Z)(this._peers);try{for(t.s();!(e=t.n()).done;){e.value[1].stop()}}catch(n){t.e(n)}finally{t.f()}}},{key:"snapshot",get:function(){return this._global.snapshot}},{key:"movingAverages",get:function(){return this._global.movingAverages}},{key:"forPeer",value:function(e){var t=e.toString();return this._peers.get(t)}},{key:"push",value:function(e,t,n){if(this._enabled&&(this._global.push(t,n),null!=e)){var r=this._peers.get(e);null==r&&(r=new rw(this._initialCounters,this._options),this._peers.set(e,r)),r.push(t,n)}}},{key:"disconnected",value:function(e){var t=e.toString(),n=this._peers.get(t);null!=n&&(n.stop(),this._peers.delete(t))}}]),n}(Xb.EventEmitter),aw=function(e,t,n){var r=null,i=null,o=function(){r&&(clearTimeout(r),i=null,r=null)},a=function(){if(!t)return e.apply(this,arguments);var a=this,s=arguments,u=n&&!r;return o(),i=function(){e.apply(a,s)},r=setTimeout((function(){if(r=null,!u){var e=i;return i=null,e()}}),t),u?i():void 0};return a.cancel=o,a.flush=function(){var e=i;o(),e&&e()},a};var sw=function(){function e(t,n,r){(0,K.Z)(this,e),(0,ot.Z)(this,"peerId",void 0),(0,ot.Z)(this,"refcnt",void 0),(0,ot.Z)(this,"network",void 0),(0,ot.Z)(this,"_entries",void 0),(0,ot.Z)(this,"_log",void 0),this.peerId=n,this.network=r,this.refcnt=1,this._entries=[],this._log=db(t,"msgqueue"),this.sendEntries=aw(this.sendEntries.bind(this),1)}return(0,W.Z)(e,[{key:"addMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.empty||this.send(e,t)}},{key:"addEntries",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._entries=this._entries.concat(e),this.sendEntries(t)}},{key:"sendEntries",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(0!==this._entries.length){var t=new bb(!1);this._entries.forEach((function(e){!0===e.cancel?t.cancel(e.cid):t.addEntry(e.cid,e.priority)})),this._entries=[],this.addMessage(t,e)}}},{key:"send",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=this,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},e.prev=1,e.next=4,this.network.connectTo(this.peerId,n);case 4:e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(1),this._log.error("cant connect to peer %p: %s",this.peerId,e.t0.message),e.abrupt("return");case 10:this._log("sending message to peer %p",this.peerId),this.network.sendMessage(this.peerId,t,n).catch((function(e){r._log.error("send error",e)}));case 12:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(t){return e.apply(this,arguments)}}()}]),e}(),uw=function(){function e(t,n,r,i){(0,K.Z)(this,e),(0,ot.Z)(this,"peers",void 0),(0,ot.Z)(this,"wantlist",void 0),(0,ot.Z)(this,"network",void 0),(0,ot.Z)(this,"_peerId",void 0),(0,ot.Z)(this,"_log",void 0),this.peers=ab({name:"ipfs_bitswap_want_manager_peers",metrics:i.metrics}),this.wantlist=new Eb(r,i),this.network=n,this._peerId=t,this._log=db(t,"want")}return(0,W.Z)(e,[{key:"_addEntries",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=e.map((function(e,n){return new bb.Entry(e,Kb-n,bb.WantType.Block,t)}));o.forEach((function(e){e.cancel?!0===n?r.wantlist.removeForce(e.cid.toString(gr.base58btc)):r.wantlist.remove(e.cid):(r._log("adding to wantlist"),r.wantlist.add(e.cid,e.priority))}));var a,s=(0,Ae.Z)(this.peers.values());try{for(s.s();!(a=s.n()).done;){a.value.addEntries(o,i)}}catch(u){s.e(u)}finally{s.f()}}},{key:"_startPeerHandler",value:function(e){var t=this.peers.get(e.toString());if(null==t){t=new sw(this._peerId,e,this.network);var n,r=new bb(!0),i=(0,Ae.Z)(this.wantlist.entries());try{for(i.s();!(n=i.n()).done;){var o=n.value;r.addEntry(o[1].cid,o[1].priority)}}catch(a){i.e(a)}finally{i.f()}return t.addMessage(r),this.peers.set(e.toString(),t),t}t.refcnt++}},{key:"_stopPeerHandler",value:function(e){var t=this.peers.get(e.toString());null!=t&&(t.refcnt--,t.refcnt>0||this.peers.delete(e.toString()))}},{key:"wantBlocks",value:function(e){var t,n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._addEntries(e,!1,!1,r),null===(t=r.signal)||void 0===t||t.addEventListener("abort",(function(){n.cancelWants(e)}))}},{key:"unwantBlocks",value:function(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}},{key:"cancelWants",value:function(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}},{key:"connectedPeers",value:function(){return Array.from(this.peers.keys())}},{key:"connected",value:function(e){this._startPeerHandler(e)}},{key:"disconnected",value:function(e){this._stopPeerHandler(e)}},{key:"start",value:function(){}},{key:"stop",value:function(){var e=this;this.peers.forEach((function(t){e.disconnected(t.peerId)}))}}]),e}(),cw={maxInboundStreams:1024,maxOutboundStreams:1024,incomingStreamTimeout:3e4,hashLoader:{getHasher:function(){return(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not implemented");case 1:case"end":return e.stop()}}),e)})))()}},statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},lw=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"],fw=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"_libp2p",void 0),(0,ot.Z)(this,"_log",void 0),(0,ot.Z)(this,"stats",void 0),(0,ot.Z)(this,"network",void 0),(0,ot.Z)(this,"blockstore",void 0),(0,ot.Z)(this,"engine",void 0),(0,ot.Z)(this,"wm",void 0),(0,ot.Z)(this,"notifications",void 0),(0,ot.Z)(this,"started",void 0),this._libp2p=t,this._log=db(this.peerId),r=Object.assign({},cw,r),this.stats=new ow(t,lw,{enabled:r.statsEnabled,computeThrottleTimeout:r.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:r.statsComputeThrottleMaxQueueSize}),this.network=new Qb(t,this,this.stats,{hashLoader:r.hashLoader,maxInboundStreams:r.maxInboundStreams,maxOutboundStreams:r.maxOutboundStreams,incomingStreamTimeout:r.incomingStreamTimeout}),this.blockstore=n,this.engine=new Ob(this.peerId,n,this.network,this.stats,t),this.wm=new uw(this.peerId,this.network,this.stats,t),this.notifications=new ew(this.peerId),this.started=!1}return(0,W.Z)(e,[{key:"isStarted",value:function(){return this.started}},{key:"peerId",get:function(){return this._libp2p.peerId}},{key:"_receiveMessage",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,l,f,h,p=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.engine.messageReceived(t,n);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),this._log("failed to receive message",n);case 8:if(0!==n.blocks.size){e.next=10;break}return e.abrupt("return");case 10:r=[],i=(0,Ae.Z)(n.blocks.entries());try{for(i.s();!(o=i.n()).done;)a=(0,k.Z)(o.value,2),l=a[0],f=a[1],h=c.CID.parse(l),r.push({wasWanted:this.wm.wantlist.contains(h),cid:h,data:f})}catch(d){i.e(d)}finally{i.f()}return this.wm.cancelWants(r.filter((function(e){return e.wasWanted})).map((function(e){return e.cid}))),e.next=16,Promise.all(r.map(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){var r,i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.cid,i=n.wasWanted,o=n.data,e.next=3,p._handleReceivedBlock(t,r,o,i);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 16:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_handleReceivedBlock",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r,i){var o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._log("received block"),e.next=3,this.blockstore.has(n);case 3:if(o=e.sent,this._updateReceiveCounters(t.toString(),n,r,o),i){e.next=7;break}return e.abrupt("return");case 7:return e.next=9,this.put(n,r);case 9:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"_updateReceiveCounters",value:function(e,t,n,r){this.stats.push(e,"blocksReceived",1),this.stats.push(e,"dataReceived",n.length),r&&(this.stats.push(e,"dupBlksReceived",1),this.stats.push(e,"dupDataReceived",n.length))}},{key:"_receiveError",value:function(e){this._log.error("ReceiveError",e)}},{key:"_onPeerConnected",value:function(e){this.wm.connected(e)}},{key:"_onPeerDisconnected",value:function(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this.stats.disconnected(e)}},{key:"enableStats",value:function(){this.stats.enable()}},{key:"disableStats",value:function(){this.stats.disable()}},{key:"wantlistForPeer",value:function(e,t){return this.engine.wantlistForPeer(e)}},{key:"ledgerForPeer",value:function(e){return this.engine.ledgerForPeer(e)}},{key:"want",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c,l,f=this,h=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=h.length>1&&void 0!==h[1]?h[1]:{},r=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return f.wm.wantBlocks([t],n),e.abrupt("return",f.notifications.wantBlock(t,n));case 2:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),i=!1,o=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,f.blockstore.get(t,n);case 3:return o=e.sent,e.abrupt("return",o);case 7:if(e.prev=7,e.t0=e.catch(0),"ERR_NOT_FOUND"===e.t0.code){e.next=11;break}throw e.t0;case 11:return i||(i=!0,f.network.findAndConnect(t,n).catch((function(e){f._log.error(e)}))),e.next=14,r(t,n);case 14:return e.abrupt("return",e.sent);case 15:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),a=new AbortController,c=nb([a.signal,n.signal]),e.prev=6,e.next=9,Promise.race([this.notifications.wantBlock(t,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:c})),o(t,(0,Nt.Z)((0,Nt.Z)({},n),{},{signal:c}))]);case 9:return l=e.sent,e.abrupt("return",l);case 11:return e.prev=11,a.abort(),c.clear(),e.finish(11);case 15:case"end":return e.stop()}}),e,this,[[6,,11,15]])})));return function(t){return e.apply(this,arguments)}}()},{key:"unwant",value:function(e){var t=this,n=Array.isArray(e)?e:[e];this.wm.unwantBlocks(n),n.forEach((function(e){t.notifications.unwantBlock(e)}))}},{key:"cancelWants",value:function(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}},{key:"put",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.blockstore.put(t,n);case 2:this.notify(t,n);case 3:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"putMany",value:function(e,t){var n=this;return(0,g.Z)((0,s.Z)().mark((function r(){return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield((0,at.Z)((0,y.Z)(n.blockstore.putMany(ib(e,(function(e){var t=e.cid,r=e.block;n.notify(t,r)})),t)),m.Z),"t0",1);case 1:case"end":return r.stop()}}),r)})))()}},{key:"notify",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,block:t}]),this.network.provide(e,r).catch((function(e){n._log.error("Failed to provide: %s",e.message)}))}},{key:"getWantlist",value:function(){return this.wm.wantlist.entries()}},{key:"peers",get:function(){return this.engine.peers()}},{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.wm.start(),e.next=3,this.network.start();case 3:this.engine.start(),this.started=!0;case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.stats.stop(),this.wm.stop(),e.next=4,this.network.stop();case 4:this.engine.stop(),this.started=!1;case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),hw=n(97723);function pw(e,t){(0,hw.Z)(e,t),t.add(e)}function dw(e,t,n){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return n}var vw=n(85495),yw=new TextDecoder;function gw(e,t){for(var n=0,r=0;;r+=7){if(r>=64)throw new Error("protobuf: varint overflow");if(t>=e.length)throw new Error("protobuf: unexpected end of data");var i=e[t++];if(n+=r<28?(127&i)<<r:(127&i)*Math.pow(2,r),i<128)break}return[n,t]}function mw(e,t){var n,r=gw(e,t),i=(0,k.Z)(r,2);n=i[0];var o=(t=i[1])+n;if(n<0||o<0)throw new Error("protobuf: invalid length");if(o>e.length)throw new Error("protobuf: unexpected end of data");return[e.subarray(t,o),o]}function bw(e,t){var n,r=gw(e,t),i=(0,k.Z)(r,2);return[7&(n=i[0]),n>>3,t=i[1]]}function ww(e){for(var t={},n=e.length,r=0;r<n;){var i,o,a=bw(e,r),s=(0,k.Z)(a,3);if(i=s[0],o=s[1],r=s[2],1===o){if(t.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(2!==i)throw new Error("protobuf: (PBLink) wrong wireType (".concat(i,") for Hash"));if(void 0!==t.Name)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");var u=mw(e,r),c=(0,k.Z)(u,2);t.Hash=c[0],r=c[1]}else if(2===o){if(void 0!==t.Name)throw new Error("protobuf: (PBLink) duplicate Name section");if(2!==i)throw new Error("protobuf: (PBLink) wrong wireType (".concat(i,") for Name"));if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");var l,f=mw(e,r),h=(0,k.Z)(f,2);l=h[0],r=h[1],t.Name=yw.decode(l)}else{if(3!==o)throw new Error("protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ".concat(o));if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(0!==i)throw new Error("protobuf: (PBLink) wrong wireType (".concat(i,") for Tsize"));var p=gw(e,r),d=(0,k.Z)(p,2);t.Tsize=d[0],r=d[1]}}if(r>n)throw new Error("protobuf: (PBLink) unexpected end of data");return t}new TextEncoder,Math.pow(2,32),Math.pow(2,31);new TextEncoder;function kw(e){var t=function(e){for(var t,n,r=e.length,i=0,o=!1;i<r;){var a,s,u=bw(e,i),c=(0,k.Z)(u,3);if(a=c[0],s=c[1],i=c[2],2!==a)throw new Error("protobuf: (PBNode) invalid wireType, expected 2, got ".concat(a));if(1===s){if(n)throw new Error("protobuf: (PBNode) duplicate Data section");var l=mw(e,i),f=(0,k.Z)(l,2);n=f[0],i=f[1],t&&(o=!0)}else{if(2!==s)throw new Error("protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ".concat(s));if(o)throw new Error("protobuf: (PBNode) duplicate Links section");t||(t=[]);var h,p=mw(e,i),d=(0,k.Z)(p,2);h=d[0],i=d[1],t.push(ww(h))}}if(i>r)throw new Error("protobuf: (PBNode) unexpected end of data");var v={};return n&&(v.Data=n),v.Links=t||[],v}(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map((function(e){var t={};try{t.Hash=c.CID.decode(e.Hash)}catch(n){}if(!t.Hash)throw new Error("Invalid Hash field found in link, expected CID");return void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t}))),n}var Ew=n(71475),xw={codec:112,walk:function(e){return(0,g.Z)((0,s.Z)().mark((function t(){var n;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=kw(e),t.delegateYield((0,at.Z)((0,y.Z)(n.Links.map((function(e){return e.Hash}))),m.Z),"t0",2);case 2:case"end":return t.stop()}}),t)})))()}},_w={codec:am.code,walk:function(){return(0,g.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))()}},Sw={codec:113,walk:function(e){return(0,g.Z)((0,s.Z)().mark((function t(){var n,r;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=[],(r=[])[42]=function(e){if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");var t=f.CID.decode(e.subarray(1));return n.push(t),t},se.decode(e,{tags:r}),t.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",5);case 5:case"end":return t.stop()}}),t)})))()}},Aw=function(e){(0,X.Z)(n,e);var t=(0,$.Z)(n);function n(e,r){var i;return(0,K.Z)(this,n),i=t.call(this,e,r),(0,ot.Z)((0,nr.Z)(i),"tokenBuffer",void 0),i.tokenBuffer=[],i}return(0,W.Z)(n,[{key:"done",value:function(){return 0===this.tokenBuffer.length&&(0,Ah.Z)((0,Zh.Z)(n.prototype),"done",this).call(this)}},{key:"_next",value:function(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():(0,Ah.Z)((0,Zh.Z)(n.prototype),"next",this).call(this)}},{key:"next",value:function(){var e=this._next();if(e.type===se.Type.map){var t=this._next();if(t.type===se.Type.string&&"/"===t.value){var n=this._next();if(n.type===se.Type.string){if(this._next().type!==se.Type.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new se.Token(se.Type.tag,42,0)}if(n.type===se.Type.map){var r=this._next();if(r.type===se.Type.string&&"bytes"===r.value){var i=this._next();if(i.type===se.Type.string){for(var o=0;o<2;o++){if(this._next().type!==se.Type.break)throw new Error("Invalid encoded Bytes form")}var a=Li.base64.decode("m".concat(i.value));return new se.Token(se.Type.bytes,a,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(r)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}]),n}(Ew.d2),Zw={codec:297,walk:function(e){return(0,g.Z)((0,s.Z)().mark((function t(){var n,r;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=[],(r=[])[42]=function(e){var t=f.CID.parse(e);return n.push(t),t},Ew.Jx(e,{tags:r,tokenizer:new Aw(e,{tags:r,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),t.delegateYield((0,at.Z)((0,y.Z)(n),m.Z),"t0",5);case 5:case"end":return t.stop()}}),t)})))()}},Tw=[_w,xw,Sw,Zw],Cw="/pin/",Iw="/pinned-block/",Dw=vw.base36;function Ow(e){return 0===e.version&&(e=e.toV1()),new Nm("".concat(Cw).concat(e.toString(Dw)))}var Rw=new WeakSet,Pw=new WeakSet,Lw=function(){function e(t,n,r){var i=this;(0,K.Z)(this,e),pw(this,Pw),pw(this,Rw),(0,ot.Z)(this,"datastore",void 0),(0,ot.Z)(this,"blockstore",void 0),(0,ot.Z)(this,"dagWalkers",void 0),this.datastore=t,this.blockstore=n,this.dagWalkers={},[].concat(Tw,(0,ye.Z)(r)).forEach((function(e){i.dagWalkers[e.codec]=e}))}return(0,W.Z)(e,[{key:"add",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c,l,f,h=this,p=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=p.length>1&&void 0!==p[1]?p[1]:{},o=Ow(t),e.next=4,this.datastore.has(o);case 4:if(!e.sent){e.next=6;break}throw new Error("Already pinned");case 6:if(!((a=Math.round(null!==(n=i.depth)&&void 0!==n?n:1/0))<0)){e.next=9;break}throw new Error("Depth must be greater than or equal to 0");case 9:return(c=new uc.Z({concurrency:1})).add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,dw(h,Rw,Nw).call(h,t,c,(function(e){null==e.pinnedBy.find((function(e){return lb(e,t.bytes)}))&&(e.pinCount++,e.pinnedBy.push(t.bytes))}),(0,Nt.Z)((0,Nt.Z)({},i),{},{depth:a}));case 2:case"end":return e.stop()}}),e)})))),l=Ut(),c.on("error",(function(e){c.clear(),l.reject(e)})),e.next=15,Promise.race([c.onIdle(),l.promise]);case 15:return f={depth:a,metadata:null!==(r=i.metadata)&&void 0!==r?r:{}},e.next=18,this.datastore.put(o,se.encode(f),i);case 18:return e.abrupt("return",(0,Nt.Z)({cid:t},f));case 19:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"rm",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,c=this,l=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=l.length>1&&void 0!==l[1]?l[1]:{},r=Ow(t),e.next=4,this.datastore.get(r,n);case 4:return i=e.sent,o=se.decode(i),e.next=8,this.datastore.delete(r,n);case 8:return(a=new uc.Z({concurrency:1})).add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,dw(c,Rw,Nw).call(c,t,a,(function(e){e.pinCount--,e.pinnedBy=e.pinnedBy.filter((function(e){return lb(e,t.bytes)}))}),(0,Nt.Z)((0,Nt.Z)({},n),{},{depth:o.depth}));case 2:case"end":return e.stop()}}),e)})))),e.next=12,a.onIdle();case 12:return e.abrupt("return",(0,Nt.Z)({cid:t},o));case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"ls",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,g.Z)((0,s.Z)().mark((function n(){var r,i,o,a,u,l,f,h,p,d;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=!1,i=!1,n.prev=2,a=(0,y.Z)(e.datastore.query({prefix:Cw+(null!=t.cid?"".concat(t.cid.toString(vw.base36)):"")},t));case 4:return n.next=6,(0,m.Z)(a.next());case 6:if(!(r=!(u=n.sent).done)){n.next=15;break}return l=u.value,f=l.key,h=l.value,p=c.CID.parse(f.toString().substring(5),vw.base36),d=se.decode(h),n.next=12,(0,Nt.Z)({cid:p},d);case 12:r=!1,n.next=4;break;case 15:n.next=21;break;case 17:n.prev=17,n.t0=n.catch(2),i=!0,o=n.t0;case 21:if(n.prev=21,n.prev=22,!r||null==a.return){n.next=26;break}return n.next=26,(0,m.Z)(a.return());case 26:if(n.prev=26,!i){n.next=29;break}throw o;case 29:return n.finish(26);case 30:return n.finish(21);case 31:case"end":return n.stop()}}),n,null,[[2,17,21,31],[22,,26,30]])})))()}},{key:"isPinned",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},r=new Nm("".concat(Iw).concat(Dw.encode(t.multihash.bytes))),e.abrupt("return",this.datastore.has(r,n));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();function Nw(e,t,n,r){return Bw.apply(this,arguments)}function Bw(){return(Bw=(0,u.Z)((0,s.Z)().mark((function e(t,n,r,i){var o,a,c,l,f,h,p,d,v=this;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(-1!==i.depth){e.next=2;break}return e.abrupt("return");case 2:if(null!=(o=this.dagWalkers[t.code])){e.next=5;break}throw new Error("No dag walker found for cid codec ".concat(t.code));case 5:return e.next=7,this.blockstore.get(t,i);case 7:return a=e.sent,e.next=10,dw(this,Pw,Mw).call(this,t,r,i);case 10:c=!1,l=!1,e.prev=12,h=(0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=d.value,n.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,dw(v,Rw,Nw).call(v,t,n,r,(0,Nt.Z)((0,Nt.Z)({},i),{},{depth:i.depth-1}));case 2:case"end":return e.stop()}}),e)}))));case 2:case"end":return e.stop()}}),e)})),p=(0,y.Z)(o.walk(a));case 15:return e.next=17,p.next();case 17:if(!(c=!(d=e.sent).done)){e.next=22;break}return e.delegateYield(h(),"t0",19);case 19:c=!1,e.next=15;break;case 22:e.next=28;break;case 24:e.prev=24,e.t1=e.catch(12),l=!0,f=e.t1;case 28:if(e.prev=28,e.prev=29,!c||null==p.return){e.next=33;break}return e.next=33,p.return();case 33:if(e.prev=33,!l){e.next=36;break}throw f;case 36:return e.finish(33);case 37:return e.finish(28);case 38:case"end":return e.stop()}}),e,this,[[12,24,28,38],[29,,33,37]])})))).apply(this,arguments)}function Mw(e,t,n){return Fw.apply(this,arguments)}function Fw(){return(Fw=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=new Nm("".concat(Iw).concat(Dw.encode(t.multihash.bytes))),a={pinCount:0,pinnedBy:[]},e.prev=2,e.t0=se,e.next=6,this.datastore.get(o,r);case 6:e.t1=e.sent,a=e.t0.decode.call(e.t0,e.t1),e.next=14;break;case 10:if(e.prev=10,e.t2=e.catch(2),"ERR_NOT_FOUND"===e.t2.code){e.next=14;break}throw e.t2;case 14:if(n(a),0!==a.pinCount){e.next=22;break}return e.next=18,this.datastore.has(o);case 18:if(!e.sent){e.next=22;break}return e.next=21,this.datastore.delete(o);case 21:return e.abrupt("return");case 22:return e.next=24,this.datastore.put(o,se.encode(a),r);case 24:null===(i=r.onProgress)||void 0===i||i.call(r,new Vb("helia:pin:add",{detail:t}));case 25:case"end":return e.stop()}}),e,this,[[2,10]])})))).apply(this,arguments)}var jw="lock:worker:request-read",Uw="lock:worker:release-read",zw="lock:master:grant-read",Hw="lock:worker:request-write",Vw="lock:worker:release-write",Gw="lock:master:grant-write",Kw={},Ww=function e(t){t.addEventListener("message",(function(n){e.dispatchEvent("message",t,n)})),null!=t.port&&t.port.addEventListener("message",(function(n){e.dispatchEvent("message",t,n)}))};Ww.addEventListener=function(e,t){null==Kw[e]&&(Kw[e]=[]),Kw[e].push(t)},Ww.removeEventListener=function(e,t){null!=Kw[e]&&(Kw[e]=Kw[e].filter((function(e){return e===t})))},Ww.dispatchEvent=function(e,t,n){null!=Kw[e]&&Kw[e].forEach((function(e){return e(t,n)}))};var qw,Yw=Ww,Qw=function(e,t,n,r,i){return function(o,a){if(a.data.type===n){var c={type:a.data.type,name:a.data.name,identifier:a.data.identifier};e.dispatchEvent(new MessageEvent(t,{data:{name:c.name,handler:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o.postMessage({type:i,name:c.name,identifier:c.identifier}),e.next=3,new Promise((function(e){o.addEventListener("message",(function t(n){if(null!=n&&null!=n.data){var i=n.data.type,a=(n.data.name,n.data.identifier);i===r&&a===c.identifier&&(o.removeEventListener("message",t),e())}}))}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}}))}}},Xw=function(e,t,n,r){return(0,u.Z)((0,s.Z)().mark((function i(){var o;return(0,s.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return o=xm(),globalThis.postMessage({type:t,identifier:o,name:e}),i.next=4,new Promise((function(t){globalThis.addEventListener("message",(function i(a){if(null!=a&&null!=a.data){var s=a.data.type,u=a.data.identifier;s===n&&u===o&&(globalThis.removeEventListener("message",i),t((function(){globalThis.postMessage({type:r,identifier:o,name:e})})))}}))}));case 4:return i.abrupt("return",i.sent);case 5:case"end":return i.stop()}}),i)})))},$w={singleProcess:!1},Jw={};function ek(e,t){return tk.apply(this,arguments)}function tk(){return(tk=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new Promise((function(e){r=e})),t.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ay((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){r((function(){e()}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))(),{milliseconds:n.timeout});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))),e.next=4,i;case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var nk={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function rk(e){var t=Object.assign({},nk,e);return null==qw&&(qw=function(e){if(e=Object.assign({},$w,e),Boolean(globalThis.document)||e.singleProcess){var t=new EventTarget;return Yw.addEventListener("message",Qw(t,"requestReadLock",jw,Uw,zw)),Yw.addEventListener("message",Qw(t,"requestWriteLock",Hw,Vw,Gw)),t}return{isWorker:!0,readLock:function(e){return Xw(e,jw,zw,Uw)},writeLock:function(e){return Xw(e,Hw,Gw,Vw)}}}(t),!0!==qw.isWorker&&(qw.addEventListener("requestReadLock",(function(e){null!=Jw[e.data.name]&&Jw[e.data.name].readLock().then(function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.data.handler().finally((function(){return n()}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())})),qw.addEventListener("requestWriteLock",function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=Jw[t.data.name]){e.next=2;break}return e.abrupt("return");case 2:Jw[t.data.name].writeLock().then(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.data.handler().finally((function(){return n()}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()))),null==Jw[t.name]&&(Jw[t.name]=function(e,t){if(!0===qw.isWorker)return{readLock:qw.readLock(e,t),writeLock:qw.writeLock(e,t)};var n,r=new uc.Z({concurrency:1});return{readLock:function(){return(0,u.Z)((0,s.Z)().mark((function e(){var i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==n){e.next=4;break}return e.next=3,ek(n,t);case 3:case 10:return e.abrupt("return",e.sent);case 4:return n=new uc.Z({concurrency:t.concurrency,autoStart:!1}),i=n,o=ek(n,t),r.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i.start(),e.next=3,i.onIdle().then((function(){n===i&&(n=null)}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})))),e.next=10,o;case 11:case"end":return e.stop()}}),e)})))()},writeLock:function(){return(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,e.next=3,ek(r,t);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})))()}}}(t.name,t)),Jw[t.name]}var ik=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"lock",void 0),(0,ot.Z)(this,"child",void 0),(0,ot.Z)(this,"pins",void 0),this.child=t,this.pins=n,this.lock=rk({singleProcess:r.holdGcLock})}return(0,W.Z)(e,[{key:"unwrap",value:function(){return this.child}},{key:"put",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=o.length>2&&void 0!==o[2]?o[2]:{},e.next=3,this.lock.readLock();case 3:return i=e.sent,e.prev=4,e.next=7,this.child.put(t,n,r);case 7:return e.abrupt("return",e.sent);case 8:return e.prev=8,i(),e.finish(8);case 11:case"end":return e.stop()}}),e,this,[[4,,8,11]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"putMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,(0,m.Z)(t.lock.readLock());case 2:return i=r.sent,r.prev=3,r.delegateYield((0,at.Z)((0,y.Z)(t.child.putMany(e,n)),m.Z),"t0",5);case 5:return r.prev=5,i(),r.finish(5);case 8:case"end":return r.stop()}}),r,null,[[3,,5,8]])})))()}},{key:"get",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},e.next=3,this.lock.readLock();case 3:return r=e.sent,e.prev=4,e.next=7,this.child.get(t,n);case 7:return e.abrupt("return",e.sent);case 8:return e.prev=8,r(),e.finish(8);case 11:case"end":return e.stop()}}),e,this,[[4,,8,11]])})));return function(t){return e.apply(this,arguments)}}()},{key:"getMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,(0,m.Z)(t.lock.readLock());case 2:return i=r.sent,r.prev=3,r.delegateYield((0,at.Z)((0,y.Z)(t.child.getMany(e,n)),m.Z),"t0",5);case 5:return r.prev=5,i(),r.finish(5);case 8:case"end":return r.stop()}}),r,null,[[3,,5,8]])})))()}},{key:"delete",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},e.next=3,this.lock.writeLock();case 3:return r=e.sent,e.prev=4,e.next=7,this.pins.isPinned(t);case 7:if(!e.sent){e.next=9;break}throw new Error("CID was pinned");case 9:return e.next=11,this.child.delete(t,n);case 11:return e.prev=11,r(),e.finish(11);case 14:case"end":return e.stop()}}),e,this,[[4,,11,14]])})));return function(t){return e.apply(this,arguments)}}()},{key:"deleteMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,(0,m.Z)(t.lock.writeLock());case 2:return i=r.sent,r.prev=3,o=t,r.delegateYield((0,at.Z)((0,y.Z)(t.child.deleteMany((0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,a,u,c;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,a=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(a.next());case 6:if(!(n=!(u=t.sent).done)){t.next=17;break}return c=u.value,t.next=10,(0,m.Z)(o.pins.isPinned(c));case 10:if(!t.sent){t.next=12;break}throw new Error("CID was pinned");case 12:return t.next=14,c;case 14:n=!1,t.next=4;break;case 17:t.next=23;break;case 19:t.prev=19,t.t0=t.catch(2),r=!0,i=t.t0;case 23:if(t.prev=23,t.prev=24,!n||null==a.return){t.next=28;break}return t.next=28,(0,m.Z)(a.return());case 28:if(t.prev=28,!r){t.next=31;break}throw i;case 31:return t.finish(28);case 32:return t.finish(23);case 33:case"end":return t.stop()}}),t,null,[[2,19,23,33],[24,,28,32]])})))(),n)),m.Z),"t0",6);case 6:return r.prev=6,i(),r.finish(6);case 9:case"end":return r.stop()}}),r,null,[[3,,6,9]])})))()}},{key:"has",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},e.next=3,this.lock.readLock();case 3:return r=e.sent,e.prev=4,e.next=7,this.child.has(t,n);case 7:return e.abrupt("return",e.sent);case 8:return e.prev=8,r(),e.finish(8);case 11:case"end":return e.stop()}}),e,this,[[4,,8,11]])})));return function(t){return e.apply(this,arguments)}}()},{key:"getAll",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,g.Z)((0,s.Z)().mark((function n(){var r;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,(0,m.Z)(e.lock.readLock());case 2:return r=n.sent,n.prev=3,n.delegateYield((0,at.Z)((0,y.Z)(e.child.getAll(t)),m.Z),"t0",5);case 5:return n.prev=5,r(),n.finish(5);case 8:case"end":return n.stop()}}),n,null,[[3,,5,8]])})))()}}]),e}(),ok=new Nm("/version"),ak=1;function sk(e){return uk.apply(this,arguments)}function uk(){return(uk=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.has(ok);case 2:if(e.sent){e.next=6;break}return e.next=5,t.put(ok,Dm("".concat(ak)));case 5:return e.abrupt("return");case 6:return e.next=8,t.get(ok);case 8:if(n=e.sent,r=Om(n),parseInt(r,10)===ak){e.next=13;break}throw new Error("Unknown datastore version, a datastore migration may be required");case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var ck=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),(0,ot.Z)(this,"child",void 0),(0,ot.Z)(this,"bitswap",void 0),this.child=t,this.bitswap=n.bitswap}return(0,W.Z)(e,[{key:"unwrap",value:function(){return this.child}},{key:"put",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=c.length>2&&void 0!==c[2]?c[2]:{},e.next=3,this.child.has(t);case 3:if(!e.sent){e.next=6;break}return null===(a=o.onProgress)||void 0===a||a.call(o,new Vb("blocks:put:duplicate",t)),e.abrupt("return",t);case 6:return!0===(null===(r=this.bitswap)||void 0===r?void 0:r.isStarted())&&(null===(u=o.onProgress)||void 0===u||u.call(o,new Vb("blocks:put:bitswap:notify",t)),this.bitswap.notify(t,n,o)),null===(i=o.onProgress)||void 0===i||i.call(o,new Vb("blocks:put:blockstore:put",t)),e.abrupt("return",this.child.put(t,n,o));case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"putMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i,o,a;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=jm(e,function(){var e=(0,u.Z)((0,s.Z)().mark((function e(r){var i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r.cid,e.next=3,t.child.has(i);case 3:return(o=e.sent)&&(null===(a=n.onProgress)||void 0===a||a.call(n,new Vb("blocks:put-many:duplicate",i))),e.abrupt("return",!o);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),a=ib(o,(function(e){var r,i,o=e.cid,a=e.block;null===(r=n.onProgress)||void 0===r||r.call(n,new Vb("blocks:put-many:bitswap:notify",o)),null===(i=t.bitswap)||void 0===i||i.notify(o,a,n)})),null===(i=n.onProgress)||void 0===i||i.call(n,new Vb("blocks:put-many:blockstore:put-many")),r.delegateYield((0,at.Z)((0,y.Z)(t.child.putMany(a,n)),m.Z),"t0",4);case 4:case"end":return r.stop()}}),r)})))()}},{key:"get",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=c.length>1&&void 0!==c[1]?c[1]:{},e.t0=!0!==i.offline&&null!=(null===(n=this.bitswap)||void 0===n?void 0:n.isStarted()),!e.t0){e.next=6;break}return e.next=5,this.child.has(t);case 5:e.t0=!e.sent;case 6:if(!e.t0){e.next=15;break}return null===(o=i.onProgress)||void 0===o||o.call(i,new Vb("blocks:get:bitswap:get",t)),e.next=10,this.bitswap.want(t,i);case 10:return u=e.sent,null===(a=i.onProgress)||void 0===a||a.call(i,new Vb("blocks:get:blockstore:put",t)),e.next=14,this.child.put(t,u,i);case 14:return e.abrupt("return",u);case 15:return null===(r=i.onProgress)||void 0===r||r.call(i,new Vb("blocks:get:blockstore:get",t)),e.abrupt("return",this.child.get(t,i));case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return null===(i=n.onProgress)||void 0===i||i.call(n,new Vb("blocks:get-many:blockstore:get-many")),r.delegateYield((0,at.Z)((0,y.Z)(t.child.getMany(ib(e,function(){var e=(0,u.Z)((0,s.Z)().mark((function e(r){var i,o,a,u;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=!0!==n.offline&&!0===(null===(i=t.bitswap)||void 0===i?void 0:i.isStarted()),!e.t0){e.next=5;break}return e.next=4,t.child.has(r);case 4:e.t0=!e.sent;case 5:if(!e.t0){e.next=13;break}return null===(o=n.onProgress)||void 0===o||o.call(n,new Vb("blocks:get-many:bitswap:get",r)),e.next=9,t.bitswap.want(r,n);case 9:return u=e.sent,null===(a=n.onProgress)||void 0===a||a.call(n,new Vb("blocks:get-many:blockstore:put",r)),e.next=13,t.child.put(r,u,n);case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()))),m.Z),"t0",2);case 2:case"end":return r.stop()}}),r)})))()}},{key:"delete",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null===(n=(r=i.length>1&&void 0!==i[1]?i[1]:{}).onProgress)||void 0===n||n.call(r,new Vb("blocks:delete:blockstore:delete",t)),e.next=4,this.child.delete(t,r);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"deleteMany",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,g.Z)((0,s.Z)().mark((function r(){var i;return(0,s.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return null===(i=n.onProgress)||void 0===i||i.call(n,new Vb("blocks:delete-many:blockstore:delete-many")),r.delegateYield((0,at.Z)((0,y.Z)(t.child.deleteMany((0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e);case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(a=t.sent).done)){t.next=13;break}return u=a.value,t.next=10,u;case 10:n=!1,t.next=4;break;case 13:t.next=19;break;case 15:t.prev=15,t.t0=t.catch(2),r=!0,i=t.t0;case 19:if(t.prev=19,t.prev=20,!n||null==o.return){t.next=24;break}return t.next=24,(0,m.Z)(o.return());case 24:if(t.prev=24,!r){t.next=27;break}throw i;case 27:return t.finish(24);case 28:return t.finish(19);case 29:case"end":return t.stop()}}),t,null,[[2,15,19,29],[20,,24,28]])})))(),n)),m.Z),"t0",2);case 2:case"end":return r.stop()}}),r)})))()}},{key:"has",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",this.child.has(t,n));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getAll",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,g.Z)((0,s.Z)().mark((function n(){var r;return(0,s.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return null===(r=t.onProgress)||void 0===r||r.call(t,new Vb("blocks:get-all:blockstore:get-many")),n.delegateYield((0,at.Z)((0,y.Z)(e.child.getAll(t)),m.Z),"t0",2);case 2:case"end":return n.stop()}}),n)})))()}}]),e}(),lk=(0,ru.kg)("helia"),fk=new WeakMap,hk=function(){function e(t){var n,r;(0,K.Z)(this,e),(0,ot.Z)(this,"libp2p",void 0),(0,ot.Z)(this,"blockstore",void 0),(0,ot.Z)(this,"datastore",void 0),(0,ot.Z)(this,"pins",void 0),(0,cl.Z)(this,fk,{writable:!0,value:void 0});var i=[h.sha256,h.sha512,mr.identity].concat((0,ye.Z)(null!==(n=t.hashers)&&void 0!==n?n:[]));(0,ll.Z)(this,fk,function(e,t){return new fw(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:{})}(t.libp2p,t.blockstore,{hashLoader:{getHasher:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(n=i.find((function(e){return e.code===t||e.name===t})))){e.next=3;break}return e.abrupt("return",n);case 3:throw new Error('Could not load hasher for code/name "'.concat(t,'"'));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}}));var o=new ck(t.blockstore,{bitswap:(0,fl.Z)(this,fk)});this.pins=new Lw(t.datastore,o,null!==(r=t.dagWalkers)&&void 0!==r?r:[]),this.libp2p=t.libp2p,this.blockstore=new ik(o,this.pins,{holdGcLock:t.holdGcLock}),this.datastore=t.datastore}return(0,W.Z)(e,[{key:"start",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,sk(this.datastore);case 2:return e.next=4,null===(t=(0,fl.Z)(this,fk))||void 0===t?void 0:t.start();case 4:return e.next=6,this.libp2p.start();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.libp2p.stop();case 2:return e.next=4,null===(t=(0,fl.Z)(this,fk))||void 0===t?void 0:t.stop();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"gc",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=o.length>0&&void 0!==o[0]?o[0]:{},e.next=3,this.blockstore.lock.writeLock();case 3:return n=e.sent,e.prev=4,r=this,i=this.blockstore.unwrap(),lk("gc start"),e.next=10,Mm(i.deleteMany((0,g.Z)((0,s.Z)().mark((function e(){var n,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!1,o=!1,e.prev=2,u=(0,y.Z)(i.getAll());case 4:return e.next=6,(0,m.Z)(u.next());case 6:if(!(n=!(c=e.sent).done)){e.next=25;break}return l=c.value.cid,e.prev=8,e.next=11,(0,m.Z)(r.pins.isPinned(l,t));case 11:if(!e.sent){e.next=13;break}return e.abrupt("continue",22);case 13:return e.next=15,l;case 15:null===(f=t.onProgress)||void 0===f||f.call(t,new Vb("helia:gc:deleted",l)),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(8),lk.error("Error during gc",e.t0),null===(h=t.onProgress)||void 0===h||h.call(t,new Vb("helia:gc:error",e.t0));case 22:n=!1,e.next=4;break;case 25:e.next=31;break;case 27:e.prev=27,e.t1=e.catch(2),o=!0,a=e.t1;case 31:if(e.prev=31,e.prev=32,!n||null==u.return){e.next=36;break}return e.next=36,(0,m.Z)(u.return());case 36:if(e.prev=36,!o){e.next=39;break}throw a;case 39:return e.finish(36);case 40:return e.finish(31);case 41:case"end":return e.stop()}}),e,null,[[2,27,31,41],[8,18],[32,,36,40]])})))()));case 10:return e.prev=10,n(),e.finish(10);case 13:lk("gc finished");case 14:case"end":return e.stop()}}),e,this,[[4,,10,13]])})));return function(){return e.apply(this,arguments)}}()}]),e}(),pk=Symbol.for("@libp2p/content-routing"),dk=Symbol.for("@libp2p/peer-discovery"),vk=Symbol.for("@libp2p/peer-routing"),yk=n(6327),gk=n.n(yk),mk=n(94804);function bk(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function wk(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var kk,Ek=wk("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),xk=wk("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?bk(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),_k=(0,Nt.Z)({utf8:Ek,"utf-8":Ek,hex:cr.gh.base16,latin1:xk,ascii:xk,binary:xk},cr.gh);function Sk(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=_k[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):bk(globalThis.Buffer.from(e,"utf-8"))}function Ak(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=_k[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}var Zk="/",Tk=(new TextEncoder).encode(Zk),Ck=Tk[0];kk=Symbol.toStringTag;var Ik,Dk=function(){function e(t,n){if((0,K.Z)(this,e),(0,ot.Z)(this,"_buf",void 0),"string"===typeof t)this._buf=Sk(t);else{if(!(t instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=t}if(null==n&&(n=!0),n&&this.clean(),0===this._buf.byteLength||this._buf[0]!==Ck)throw new Error("Invalid key")}return(0,W.Z)(e,[{key:"toString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8";return Ak(this._buf,e)}},{key:"uint8Array",value:function(){return this._buf}},{key:kk,get:function(){return"Key(".concat(this.toString(),")")}},{key:"clean",value:function(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=Tk),this._buf[0]!==Ck){var e=new Uint8Array(this._buf.byteLength+1);e.fill(Ck,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Ck;)this._buf=this._buf.subarray(0,-1)}},{key:"less",value:function(e){for(var t=this.list(),n=e.list(),r=0;r<t.length;r++){if(n.length<r+1)return!1;var i=t[r],o=n[r];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}},{key:"reverse",value:function(){return e.withNamespaces(this.list().slice().reverse())}},{key:"namespaces",value:function(){return this.list()}},{key:"baseNamespace",value:function(){var e=this.namespaces();return e[e.length-1]}},{key:"list",value:function(){return this.toString().split(Zk).slice(1)}},{key:"type",value:function(){return function(e){var t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}},{key:"name",value:function(){return function(e){var t=e.split(":");return t[t.length-1]}(this.baseNamespace())}},{key:"instance",value:function(t){return new e(this.toString()+":"+t)}},{key:"path",value:function(){var t=this.parent().toString();return t.endsWith(Zk)||(t+=Zk),new e(t+=this.type())}},{key:"parent",value:function(){var t=this.list();return 1===t.length?new e(Zk):new e(t.slice(0,-1).join(Zk))}},{key:"child",value:function(t){return this.toString()===Zk?t:t.toString()===Zk?this:new e(this.toString()+t.toString(),!1)}},{key:"isAncestorOf",value:function(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}},{key:"isDecendantOf",value:function(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}},{key:"isTopLevel",value:function(){return 1===this.list().length}},{key:"concat",value:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.withNamespaces([].concat((0,ye.Z)(this.namespaces()),(0,ye.Z)(function(e){var t;return(t=[]).concat.apply(t,(0,ye.Z)(e))}(n.map((function(e){return e.namespaces()}))))))}}],[{key:"withNamespaces",value:function(t){return new e(t.join(Zk))}},{key:"random",value:function(){return new e(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;return crypto.getRandomValues(new Uint8Array(e)).reduce((function(e,t){return e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")}),"")}().replace(/-/g,""))}},{key:"asKey",value:function(t){return t instanceof Uint8Array||"string"===typeof t?new e(t):"function"===typeof t.uint8Array?new e(t.uint8Array()):null}}]),e}();!function(e){e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"}(Ik||(Ik={}));n(18605);var Ok=n(16019),Rk=n.n(Ok),Pk={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function Lk(e,t,n,r,i){if("sha1"!==i&&"sha2-256"!==i&&"sha2-512"!==i){var o=Object.keys(Pk).join(" / ");throw new ar.s("Hash '".concat(i,"' is unknown or not supported. Must be ").concat(o),"ERR_UNSUPPORTED_HASH_TYPE")}var a=Pk[i],s=Rk()(e,t,n,r,a);return xo().encode64(s,null)}var Nk=(0,ru.kg)("libp2p:keychain"),Bk="/info/",Mk=new WeakMap,Fk=14,jk=16,Uk=1e3,zk={dek:{keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Hk(e){return null!=e&&("string"===typeof e&&(e===gk()(e.trim())&&e.length>0))}function Vk(){return Gk.apply(this,arguments)}function Gk(){return(Gk=(0,u.Z)((0,s.Z)().mark((function e(){var t;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return 200,1e3,t=800*Math.random()+200,e.next=5,new Promise((function(e){return setTimeout(e,t)}));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Kk(e){return new Dk("/pkcs8/"+e)}function Wk(e){return new Dk(Bk+e)}var qk=function(){function e(t,n){var r,i,o,a,s,u,c,l,f,h;if((0,K.Z)(this,e),this.components=t,this.init=(0,mk.Z)(zk,n),null!=this.init.pass&&(null===(r=this.init.pass)||void 0===r?void 0:r.length)<20)throw new Error("pass must be least 20 characters");if(null!=(null===(i=this.init.dek)||void 0===i?void 0:i.keyLength)&&this.init.dek.keyLength<Fk)throw new Error("dek.keyLength must be least ".concat(Fk," bytes"));if(null!=(null===(o=this.init.dek)||void 0===o||null===(a=o.salt)||void 0===a?void 0:a.length)&&this.init.dek.salt.length<jk)throw new Error("dek.saltLength must be least ".concat(jk," bytes"));if(null!=(null===(s=this.init.dek)||void 0===s?void 0:s.iterationCount)&&this.init.dek.iterationCount<Uk)throw new Error("dek.iterationCount must be least ".concat(Uk));var p=null!=this.init.pass&&null!=(null===(u=this.init.dek)||void 0===u?void 0:u.salt)?Lk(this.init.pass,null===(c=this.init.dek)||void 0===c?void 0:c.salt,null===(l=this.init.dek)||void 0===l?void 0:l.iterationCount,null===(f=this.init.dek)||void 0===f?void 0:f.keyLength,null===(h=this.init.dek)||void 0===h?void 0:h.hash):"";Mk.set(this,{dek:p})}return(0,W.Z)(e,[{key:"createKey",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p=arguments;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=p.length>2&&void 0!==p[2]?p[2]:2048,Hk(t)&&"self"!==t){e.next=5;break}return e.next=4,Vk();case 4:throw new ar.s("Invalid key name",Ik.ERR_INVALID_KEY_NAME);case 5:if("string"===typeof n){e.next=9;break}return e.next=8,Vk();case 8:throw new ar.s("Invalid key type",Ik.ERR_INVALID_KEY_TYPE);case 9:return i=Kk(t),e.next=12,this.components.datastore.has(i);case 12:if(!e.sent){e.next=17;break}return e.next=16,Vk();case 16:throw new ar.s("Key name already exists",Ik.ERR_KEY_ALREADY_EXISTS);case 17:e.t0=n.toLowerCase(),e.next="rsa"===e.t0?20:25;break;case 20:if(Number.isSafeInteger(r)&&!(r<2048)){e.next=24;break}return e.next=23,Vk();case 23:throw new ar.s("Invalid RSA key size",Ik.ERR_INVALID_KEY_SIZE);case 24:case 25:return e.abrupt("break",26);case 26:return e.prev=26,e.next=29,Ss(n,r);case 29:return a=e.sent,e.next=32,a.id();case 32:if(u=e.sent,null!=(c=Mk.get(this))){e.next=36;break}throw new ar.s("dek missing",Ik.ERR_INVALID_PARAMETERS);case 36:return l=c.dek,e.next=39,a.export(l);case 39:return f=e.sent,o={name:t,id:u},(h=this.components.datastore.batch()).put(i,Sk(f)),h.put(Wk(t),Sk(JSON.stringify(o))),e.next=46,h.commit();case 46:e.next=53;break;case 48:return e.prev=48,e.t1=e.catch(26),e.next=52,Vk();case 52:throw e.t1;case 53:return e.abrupt("return",o);case 54:case"end":return e.stop()}}),e,this,[[26,48]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"listKeys",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n,r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t={prefix:Bk},n=[],r=!1,i=!1,e.prev=4,a=(0,y.Z)(this.components.datastore.query(t));case 6:return e.next=8,a.next();case 8:if(!(r=!(u=e.sent).done)){e.next=14;break}c=u.value,n.push(JSON.parse(Ak(c.value)));case 11:r=!1,e.next=6;break;case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(4),i=!0,o=e.t0;case 20:if(e.prev=20,e.prev=21,!r||null==a.return){e.next=25;break}return e.next=25,a.return();case 25:if(e.prev=25,!i){e.next=28;break}throw o;case 28:return e.finish(25);case 29:return e.finish(20);case 30:return e.abrupt("return",n);case 31:case"end":return e.stop()}}),e,this,[[4,16,20,30],[21,,25,29]])})));return function(){return e.apply(this,arguments)}}()},{key:"findKeyById",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.listKeys();case 3:if(n=e.sent,null!=(r=n.find((function(e){return e.id===t})))){e.next=7;break}throw new ar.s("Key with id '".concat(t,"' does not exist."),Ik.ERR_KEY_NOT_FOUND);case 7:return e.abrupt("return",r);case 10:return e.prev=10,e.t0=e.catch(0),e.next=14,Vk();case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"findKeyByName",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Hk(t)){e.next=4;break}return e.next=3,Vk();case 3:throw new ar.s("Invalid key name '".concat(t,"'"),Ik.ERR_INVALID_KEY_NAME);case 4:return n=Wk(t),e.prev=5,e.next=8,this.components.datastore.get(n);case 8:return r=e.sent,e.abrupt("return",JSON.parse(Ak(r)));case 12:return e.prev=12,e.t0=e.catch(5),e.next=16,Vk();case 16:throw Nk.error(e.t0),new ar.s("Key '".concat(t,"' does not exist."),Ik.ERR_KEY_NOT_FOUND);case 18:case"end":return e.stop()}}),e,this,[[5,12]])})));return function(t){return e.apply(this,arguments)}}()},{key:"removeKey",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Hk(t)&&"self"!==t){e.next=4;break}return e.next=3,Vk();case 3:throw new ar.s("Invalid key name '".concat(t,"'"),Ik.ERR_INVALID_KEY_NAME);case 4:return n=Kk(t),e.next=7,this.findKeyByName(t);case 7:return r=e.sent,(i=this.components.datastore.batch()).delete(n),i.delete(Wk(t)),e.next=13,i.commit();case 13:return e.abrupt("return",r);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"renameKey",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Hk(t)&&"self"!==t){e.next=4;break}return e.next=3,Vk();case 3:throw new ar.s("Invalid old key name '".concat(t,"'"),Ik.ERR_OLD_KEY_NAME_INVALID);case 4:if(Hk(n)&&"self"!==n){e.next=8;break}return e.next=7,Vk();case 7:throw new ar.s("Invalid new key name '".concat(n,"'"),Ik.ERR_NEW_KEY_NAME_INVALID);case 8:return r=Kk(t),i=Kk(n),o=Wk(t),a=Wk(n),e.next=14,this.components.datastore.has(i);case 14:if(!e.sent){e.next=19;break}return e.next=18,Vk();case 18:throw new ar.s("Key '".concat(n,"' already exists"),Ik.ERR_KEY_ALREADY_EXISTS);case 19:return e.prev=19,e.next=22,this.components.datastore.get(r);case 22:return u=e.sent,e.next=25,this.components.datastore.get(o);case 25:return c=e.sent,(l=JSON.parse(Ak(c))).name=n,(f=this.components.datastore.batch()).put(i,u),f.put(a,Sk(JSON.stringify(l))),f.delete(r),f.delete(o),e.next=35,f.commit();case 35:return e.abrupt("return",l);case 38:return e.prev=38,e.t0=e.catch(19),e.next=42,Vk();case 42:throw e.t0;case 43:case"end":return e.stop()}}),e,this,[[19,38]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"exportKey",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Hk(t)){e.next=4;break}return e.next=3,Vk();case 3:throw new ar.s("Invalid key name '".concat(t,"'"),Ik.ERR_INVALID_KEY_NAME);case 4:if(null!=n){e.next=8;break}return e.next=7,Vk();case 7:throw new ar.s("Password is required",Ik.ERR_PASSWORD_REQUIRED);case 8:return r=Kk(t),e.prev=9,e.next=12,this.components.datastore.get(r);case 12:if(i=e.sent,o=Ak(i),null!=(a=Mk.get(this))){e.next=17;break}throw new ar.s("dek missing",Ik.ERR_INVALID_PARAMETERS);case 17:return u=a.dek,e.next=20,Os(o,u);case 20:return c=e.sent,e.next=23,c.export(n);case 23:return e.abrupt("return",e.sent);case 26:return e.prev=26,e.t0=e.catch(9),e.next=30,Vk();case 30:throw e.t0;case 31:case"end":return e.stop()}}),e,this,[[9,26]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"exportPeerId",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="temporary-password",e.next=3,this.exportKey(t,n);case 3:return r=e.sent,e.next=6,Os(r,n);case 6:return i=e.sent,e.next=9,(0,Ps.y5)(i.public.bytes,i.bytes);case 9:return e.abrupt("return",e.sent);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"importKey",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a,u,c,l,f;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Hk(t)&&"self"!==t){e.next=4;break}return e.next=3,Vk();case 3:throw new ar.s("Invalid key name '".concat(t,"'"),Ik.ERR_INVALID_KEY_NAME);case 4:if(null!=n){e.next=8;break}return e.next=7,Vk();case 7:throw new ar.s("PEM encoded key is required",Ik.ERR_PEM_REQUIRED);case 8:return i=Kk(t),e.next=11,this.components.datastore.has(i);case 11:if(!e.sent){e.next=16;break}return e.next=15,Vk();case 15:throw new ar.s("Key '".concat(t,"' already exists"),Ik.ERR_KEY_ALREADY_EXISTS);case 16:return e.prev=16,e.next=19,Os(n,r);case 19:o=e.sent,e.next=27;break;case 22:return e.prev=22,e.t0=e.catch(16),e.next=26,Vk();case 26:throw new ar.s("Cannot read the key, most likely the password is wrong",Ik.ERR_CANNOT_READ_KEY);case 27:return e.prev=27,e.next=30,o.id();case 30:if(a=e.sent,null!=(u=Mk.get(this))){e.next=34;break}throw new ar.s("dek missing",Ik.ERR_INVALID_PARAMETERS);case 34:return c=u.dek,e.next=37,o.export(c);case 37:n=e.sent,e.next=45;break;case 40:return e.prev=40,e.t1=e.catch(27),e.next=44,Vk();case 44:throw e.t1;case 45:return l={name:t,id:a},(f=this.components.datastore.batch()).put(i,Sk(n)),f.put(Wk(t),Sk(JSON.stringify(l))),e.next=51,f.commit();case 51:return e.abrupt("return",l);case 52:case"end":return e.stop()}}),e,this,[[16,22],[27,40]])})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"importPeer",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,Hk(t)){e.next=3;break}throw new ar.s("Invalid key name '".concat(t,"'"),Ik.ERR_INVALID_KEY_NAME);case 3:if(null!=n){e.next=5;break}throw new ar.s("PeerId is required",Ik.ERR_MISSING_PRIVATE_KEY);case 5:if(null!=n.privateKey){e.next=7;break}throw new ar.s("PeerId.privKey is required",Ik.ERR_MISSING_PRIVATE_KEY);case 7:return e.next=9,Cs(n.privateKey);case 9:return r=e.sent,i=Kk(t),e.next=13,this.components.datastore.has(i);case 13:if(!e.sent){e.next=18;break}return e.next=17,Vk();case 17:throw new ar.s("Key '".concat(t,"' already exists"),Ik.ERR_KEY_ALREADY_EXISTS);case 18:if(null!=(o=Mk.get(this))){e.next=21;break}throw new ar.s("dek missing",Ik.ERR_INVALID_PARAMETERS);case 21:return a=o.dek,e.next=24,r.export(a);case 24:return u=e.sent,c={name:t,id:n.toString()},(l=this.components.datastore.batch()).put(i,Sk(u)),l.put(Wk(t),Sk(JSON.stringify(c))),e.next=31,l.commit();case 31:return e.abrupt("return",c);case 34:return e.prev=34,e.t0=e.catch(0),e.next=38,Vk();case 38:throw e.t0;case 39:case"end":return e.stop()}}),e,this,[[0,34]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getPrivateKey",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Hk(t)){e.next=4;break}return e.next=3,Vk();case 3:throw new ar.s("Invalid key name '".concat(t,"'"),Ik.ERR_INVALID_KEY_NAME);case 4:return e.prev=4,n=Kk(t),e.next=8,this.components.datastore.get(n);case 8:return r=e.sent,e.abrupt("return",Ak(r));case 12:return e.prev=12,e.t0=e.catch(4),e.next=16,Vk();case 16:throw Nk.error(e.t0),new ar.s("Key '".concat(t,"' does not exist."),Ik.ERR_KEY_NOT_FOUND);case 18:case"end":return e.stop()}}),e,this,[[4,12]])})));return function(t){return e.apply(this,arguments)}}()},{key:"rotateKeychainPass",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h,p,d,v,y,g,m,b,w,k;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"===typeof t){e.next=4;break}return e.next=3,Vk();case 3:throw new ar.s("Invalid old pass type '".concat(typeof t,"'"),Ik.ERR_INVALID_OLD_PASS_TYPE);case 4:if("string"===typeof n){e.next=8;break}return e.next=7,Vk();case 7:throw new ar.s("Invalid new pass type '".concat(typeof n,"'"),Ik.ERR_INVALID_NEW_PASS_TYPE);case 8:if(!(n.length<20)){e.next=12;break}return e.next=11,Vk();case 11:throw new ar.s("Invalid pass length ".concat(n.length),Ik.ERR_INVALID_PASS_LENGTH);case 12:if(Nk("recreating keychain"),null!=(u=Mk.get(this))){e.next=16;break}throw new ar.s("dek missing",Ik.ERR_INVALID_PARAMETERS);case 16:return c=u.dek,this.init.pass=n,l=null!=n&&null!=(null===(r=this.init.dek)||void 0===r?void 0:r.salt)?Lk(n,this.init.dek.salt,null===(i=this.init.dek)||void 0===i?void 0:i.iterationCount,null===(o=this.init.dek)||void 0===o?void 0:o.keyLength,null===(a=this.init.dek)||void 0===a?void 0:a.hash):"",Mk.set(this,{dek:l}),e.next=22,this.listKeys();case 22:f=e.sent,h=(0,Ae.Z)(f),e.prev=24,h.s();case 26:if((p=h.n()).done){e.next=47;break}return d=p.value,e.next=30,this.components.datastore.get(Kk(d.name));case 30:return v=e.sent,y=Ak(v),e.next=34,Os(y,c);case 34:return g=e.sent,m=l.toString(),e.next=38,g.export(m);case 38:return b=e.sent,w=this.components.datastore.batch(),k={name:d.name,id:d.id},w.put(Kk(d.name),Sk(b)),w.put(Wk(d.name),Sk(JSON.stringify(k))),e.next=45,w.commit();case 45:e.next=26;break;case 47:e.next=52;break;case 49:e.prev=49,e.t0=e.catch(24),h.e(e.t0);case 52:return e.prev=52,h.f(),e.finish(52);case 55:Nk("keychain reconstructed");case 56:case"end":return e.stop()}}),e,this,[[24,49,52,55]])})));return function(t,n){return e.apply(this,arguments)}}()}],[{key:"generateOptions",value:function(){var e=Object.assign({},zk),t=3*Math.ceil(jk/3);return e.dek.salt=Ak(ja(t),"base64"),e}},{key:"options",get:function(){return zk}}]),e}();function Yk(e,t){var n,r=(n={},(0,ot.Z)(n,Symbol.iterator,(function(){return r})),(0,ot.Z)(n,"next",(function(){var n=e.next(),r=n.value;return!0===n.done||null==r?{done:!0,value:void 0}:{done:!1,value:t(r)}})),n);return r}var Qk=function(e){function t(e){if((0,K.Z)(this,t),this.map=new Map,null!=e){var n,r=(0,Ae.Z)(e.entries());try{for(r.s();!(n=r.n()).done;){var i=(0,k.Z)(n.value,2),o=i[0],a=i[1];this.map.set(o.toString(),a)}}catch(s){r.e(s)}finally{r.f()}}}return(0,W.Z)(t,[{key:e,value:function(){return this.entries()}},{key:"clear",value:function(){this.map.clear()}},{key:"delete",value:function(e){this.map.delete(e.toString())}},{key:"entries",value:function(){return Yk(this.map.entries(),(function(e){return[(0,Ps.jE)(e[0]),e[1]]}))}},{key:"forEach",value:function(e){var t=this;this.map.forEach((function(n,r){e(n,(0,Ps.jE)(r),t)}))}},{key:"get",value:function(e){return this.map.get(e.toString())}},{key:"has",value:function(e){return this.map.has(e.toString())}},{key:"set",value:function(e,t){this.map.set(e.toString(),t)}},{key:"keys",value:function(){return Yk(this.map.keys(),(function(e){return(0,Ps.jE)(e)}))}},{key:"values",value:function(){return this.map.values()}},{key:"size",get:function(){return this.map.size}}]),t}(Symbol.iterator),Xk=function(e){function t(e){if((0,K.Z)(this,t),this.set=new Set,null!=e){var n,r=(0,Ae.Z)(e);try{for(r.s();!(n=r.n()).done;){var i=n.value;this.set.add(i.toString())}}catch(o){r.e(o)}finally{r.f()}}}return(0,W.Z)(t,[{key:"size",get:function(){return this.set.size}},{key:e,value:function(){return this.values()}},{key:"add",value:function(e){this.set.add(e.toString())}},{key:"clear",value:function(){this.set.clear()}},{key:"delete",value:function(e){this.set.delete(e.toString())}},{key:"entries",value:function(){return Yk(this.set.entries(),(function(e){var t=(0,Ps.jE)(e[0]);return[t,t]}))}},{key:"forEach",value:function(e){var t=this;this.set.forEach((function(n){var r=(0,Ps.jE)(n);e(r,r,t)}))}},{key:"has",value:function(e){return this.set.has(e.toString())}},{key:"values",value:function(){return Yk(this.set.values(),(function(e){return(0,Ps.jE)(e)}))}},{key:"intersection",value:function(e){var n,r=new t,i=(0,Ae.Z)(e);try{for(i.s();!(n=i.n()).done;){var o=n.value;this.has(o)&&r.add(o)}}catch(a){i.e(a)}finally{i.f()}return r}},{key:"difference",value:function(e){var n,r=new t,i=(0,Ae.Z)(this);try{for(i.s();!(n=i.n()).done;){var o=n.value;e.has(o)||r.add(o)}}catch(a){i.e(a)}finally{i.f()}return r}},{key:"union",value:function(e){var n,r=new t,i=(0,Ae.Z)(e);try{for(i.s();!(n=i.n()).done;){var o=n.value;r.add(o)}}catch(c){i.e(c)}finally{i.f()}var a,s=(0,Ae.Z)(this);try{for(s.s();!(a=s.n()).done;){var u=a.value;r.add(u)}}catch(c){s.e(c)}finally{s.f()}return r}}]),t}(Symbol.iterator);Symbol.iterator;function $k(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?(t=globalThis.Buffer.allocUnsafe(n),null!=globalThis.Buffer?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t):new Uint8Array(n)}function Jk(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var eE,tE=Jk("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),nE=Jk("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=$k((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}));(0,Nt.Z)({utf8:tE,"utf-8":tE,hex:cr.gh.base16,latin1:nE,ascii:nE,binary:nE},cr.gh);!function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.id&&(t.uint32(10),t.bytes(e.id)),null!=e.pubKey&&(t.uint32(18),t.bytes(e.pubKey)),null!=e.privKey&&(t.uint32(26),t.bytes(e.privKey)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.id=e.bytes();break;case 2:n.pubKey=e.bytes();break;case 3:n.privKey=e.bytes();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(eE||(eE={}));var rE=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){var t,n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ss("Ed25519");case 2:return t=e.sent,e.next=5,aE(t);case 5:if("Ed25519"!==(n=e.sent).type){e.next=8;break}return e.abrupt("return",n);case 8:throw new Error('Generated unexpected PeerId type "'.concat(n.type,'"'));case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();function iE(e){return oE.apply(this,arguments)}function oE(){return(oE=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,Ps.y5)(Ts(t));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function aE(e){return sE.apply(this,arguments)}function sE(){return(sE=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,Ps.y5)(Ts(t.public),Ds(t));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function uE(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function cE(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?uE(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function lE(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}var fE=lE("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),hE=lE("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=cE((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),pE=(0,Nt.Z)({utf8:fE,"utf-8":fE,hex:cr.gh.base16,latin1:hE,ascii:hE,binary:hE},cr.gh);function dE(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=pE[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):uE(globalThis.Buffer.from(e,"utf-8"))}function vE(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}var yE,gE="ERR_SIGNATURE_NOT_VALID";!function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.publicKey=e.bytes();break;case 2:n.payloadType=e.bytes();break;case 3:n.payload=e.bytes();break;case 5:n.signature=e.bytes();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(yE||(yE={}));var mE=function(){function e(t){(0,K.Z)(this,e);var n=t.peerId,r=t.payloadType,i=t.payload,o=t.signature;this.peerId=n,this.payloadType=r,this.payload=i,this.signature=o}return(0,W.Z)(e,[{key:"marshal",value:function(){if(null==this.peerId.publicKey)throw new Error("Missing public key");return null==this.marshaled&&(this.marshaled=yE.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}},{key:"equals",value:function(e){return vE(this.marshal(),e.marshal())}},{key:"validate",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=bE(t,this.payloadType,this.payload),null!=this.peerId.publicKey){e.next=3;break}throw new Error("Missing public key");case 3:return r=Zs(this.peerId.publicKey),e.next=6,r.verify(n.subarray(),this.signature);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();mE.createFromProtobuf=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=yE.decode(t),e.next=3,(0,Ps.y5)(n.publicKey);case 3:return r=e.sent,e.abrupt("return",new mE({peerId:r,payloadType:n.payloadType,payload:n.payload,signature:n.signature}));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),mE.seal=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=n.privateKey){e.next=2;break}throw new Error("Missing private key");case 2:return r=t.domain,i=t.codec,o=t.marshal(),a=bE(r,i,o),e.next=8,Cs(n.privateKey);case 8:return u=e.sent,e.next=11,u.sign(a.subarray());case 11:return c=e.sent,e.abrupt("return",new mE({peerId:n,payloadType:i,payload:o,signature:c}));case 13:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),mE.openAndCertify=function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mE.createFromProtobuf(t);case 2:return r=e.sent,e.next=5,r.validate(n);case 5:if(e.sent){e.next=8;break}throw new ar.s("envelope signature is not valid for the given domain",gE);case 8:return e.abrupt("return",r);case 9:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}();var bE=function(e,t,n){var r=dE(e),i=Ct.encode(r.byteLength),o=Ct.encode(t.length),a=Ct.encode(n.length);return new vt(i,r,o,t,a,n)};function wE(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=pE[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}function kE(e,t){null==t&&(t=e.reduce((function(e,t){return e+t.length}),0));var n,r=cE(t),i=0,o=(0,Ae.Z)(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;r.set(a,i),i+=a.length}}catch(s){o.e(s)}finally{o.f()}return uE(r)}var EE=xl.C,xE=xl.aY,_E=function e(t){var n=0;if(t=t.toString().trim(),EE(t)){var r=new Uint8Array(n+4);return t.split(/\./g).forEach((function(e){r[n++]=255&parseInt(e,10)})),r}if(xE(t)){var i,o=t.split(":",8);for(i=0;i<o.length;i++){var a=void 0;EE(o[i])&&(a=e(o[i]),o[i]=wE(a.slice(0,2),"base16")),null!=a&&++i<8&&o.splice(i,0,wE(a.slice(2,4),"base16"))}if(""===o[0])for(;o.length<8;)o.unshift("0");else if(""===o[o.length-1])for(;o.length<8;)o.push("0");else if(o.length<8){for(i=0;i<o.length&&""!==o[i];i++);var s=[i,1];for(i=9-o.length;i>0;i--)s.push("0");o.splice.apply(o,s)}var u=new Uint8Array(n+16);for(i=0;i<o.length;i++){var c=parseInt(o[i],16);u[n++]=c>>8&255,u[n++]=255&c}return u}throw new Error("invalid ip address")},SE=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;n=~~n,r=null!==(t=r)&&void 0!==t?t:e.length-n;var i=new DataView(e.buffer);if(4===r){for(var o=[],a=0;a<r;a++)o.push(e[n+a]);return o.join(".")}if(16===r){for(var s=[],u=0;u<r;u+=2)s.push(i.getUint16(n+u).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},AE=-1,ZE={},TE={};function CE(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}function IE(e){if("number"===typeof e){if(null!=TE[e])return TE[e];throw new Error("no protocol with code: ".concat(e))}if("string"===typeof e){if(null!=ZE[e])return ZE[e];throw new Error("no protocol with name: ".concat(e))}throw new Error("invalid protocol id type: ".concat(typeof e))}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,AE,"ip6zone"],[43,8,"ipcidr"],[53,AE,"dns",!0],[54,AE,"dns4",!0],[55,AE,"dns6",!0],[56,AE,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,AE,"unix",!1,!0],[421,AE,"ipfs"],[421,AE,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,AE,"garlic64"],[448,0,"tls"],[449,AE,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,AE,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,AE,"memory"]].forEach((function(e){var t=CE.apply(void 0,(0,ye.Z)(e));TE[t.code]=t,ZE[t.name]=t}));IE("ip4"),IE("ip6"),IE("ipcidr");function DE(e,t){switch(IE(e).code){case 4:case 41:return function(e){var t=SE(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!xl.h6(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return FE(t);case 6:case 273:case 33:case 132:return BE(t).toString();case 421:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return wE(n,"base58btc")}(t);case 444:case 445:return jE(t);case 466:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+wE(n,"base64url")}(t);default:return wE(t,"base16")}}function OE(e,t){switch(IE(e).code){case 4:case 41:return LE(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ME(t);case 6:case 273:case 33:case 132:return NE(parseInt(t,10));case 421:return function(e){var t;t="Q"===e[0]||"1"===e[0]?b.decode(gr.base58btc.decode("z".concat(e))).bytes:c.CID.parse(e).multihash.bytes;var n=Uint8Array.from(A().encode(t.length));return kE([n,t],n.length+t.length)}(t);case 444:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(16!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion address."));var n=kl.base32.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=NE(r);return kE([n,i],n.length+i.length)}(t);case 445:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(56!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion3 address."));var n=kl.base32.decode("b".concat(t[0])),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=NE(r);return kE([n,i],n.length+i.length)}(t);case 466:return function(e){var t=PE.decode(e),n=Uint8Array.from(A().encode(t.length));return kE([n,t],n.length+t.length)}(t);default:return dE(t,"base16")}}var RE=Object.values(cr.gh).map((function(e){return e.decoder})),PE=function(){var e=RE[0].or(RE[1]);return RE.slice(2).forEach((function(t){return e=e.or(t)})),e}();function LE(e){if(!xl.h6(e))throw new Error("invalid ip address");return _E(e)}function NE(e){var t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function BE(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function ME(e){var t=dE(e),n=Uint8Array.from(A().encode(t.length));return kE([n,t],n.length+t.length)}function FE(e){var t=A().decode(e);if((e=e.slice(A().decode.bytes)).length!==t)throw new Error("inconsistent lengths");return wE(e)}function jE(e){var t=e.slice(0,e.length-2),n=e.slice(e.length-2),r=wE(t,"base32"),i=BE(n);return"".concat(r,":").concat(i)}function UE(e){return e.map((function(e){var t=XE(e);return null!=e[1]?[t.code,DE(t.code,e[1])]:[t.code]}))}function zE(e){return WE(kE(e.map((function(e){var t=XE(e),n=Uint8Array.from(A().encode(t.code));return e.length>1&&null!=e[1]&&(n=kE([n,e[1]])),n}))))}function HE(e,t){return e.size>0?e.size/8:0===e.size?0:A().decode(t)+(null!==(n=A().decode.bytes)&&void 0!==n?n:0);var n}function VE(e){for(var t=[],n=0;n<e.length;){var r,i=A().decode(e,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0,a=HE(IE(i),e.slice(n+o));if(0!==a){var s=e.slice(n+o,n+o+a);if((n+=a+o)>e.length)throw QE("Invalid address Uint8Array: "+wE(e,"base16"));t.push([i,s])}else t.push([i]),n+=o}return t}function GE(e){return function(e){var t=[];return e.map((function(e){var n=XE(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),YE(t.join("/"))}(UE(VE(e)))}function KE(e){var t=function(e){var t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(var r=0;r<n.length;r++){var i=n[r],o=IE(i);if(0!==o.size){if(++r>=n.length)throw QE("invalid address: "+e);if(!0===o.path){t.push([i,YE(n.slice(r).join("/"))]);break}t.push([i,n[r]])}else t.push([i])}return t}(e=YE(e));return zE(t.map((function(e){Array.isArray(e)||(e=[e]);var t=XE(e);return e.length>1?[t.code,OE(t.code,e[1])]:[t.code]})))}function WE(e){var t=qE(e);if(null!=t)throw t;return Uint8Array.from(e)}function qE(e){try{VE(e)}catch(t){return t}}function YE(e){return"/"+e.trim().split("/").filter((function(e){return e})).join("/")}function QE(e){return new Error("Error parsing address: "+e)}function XE(e){return IE(e[0])}var $E=Symbol.for("nodejs.util.inspect.custom"),JE=[IE("dns").code,IE("dns4").code,IE("dns6").code,IE("dnsaddr").code],ex=new Map,tx=Symbol.for("@multiformats/js-multiaddr/multiaddr");function nx(e){return Boolean(null===e||void 0===e?void 0:e[tx])}var rx,ix=new WeakMap,ox=new WeakMap,ax=new WeakMap,sx=new WeakMap,ux=function(){function e(t){if((0,K.Z)(this,e),(0,ot.Z)(this,"bytes",void 0),(0,cl.Z)(this,ix,{writable:!0,value:void 0}),(0,cl.Z)(this,ox,{writable:!0,value:void 0}),(0,cl.Z)(this,ax,{writable:!0,value:void 0}),(0,cl.Z)(this,sx,{writable:!0,value:void 0}),(0,ot.Z)(this,tx,!0),null==t&&(t=""),t instanceof Uint8Array)this.bytes=WE(t);else if("string"===typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error('multiaddr "'.concat(t,'" must start with a "/"'));this.bytes=KE(t)}else{if(!nx(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=WE(t.bytes)}}return(0,W.Z)(e,[{key:"toString",value:function(){return null==(0,fl.Z)(this,ix)&&(0,ll.Z)(this,ix,GE(this.bytes)),(0,fl.Z)(this,ix)}},{key:"toJSON",value:function(){return this.toString()}},{key:"toOptions",value:function(){var e,t,n,r,i,o="",a=IE("tcp"),s=IE("udp"),u=IE("ip4"),c=IE("ip6"),l=IE("dns6"),f=IE("ip6zone"),h=(0,Ae.Z)(this.stringTuples());try{for(h.s();!(i=h.n()).done;){var p=(0,k.Z)(i.value,2),d=p[0],v=p[1];d===f.code&&(o="%".concat(null!==v&&void 0!==v?v:"")),JE.includes(d)&&(t=a.name,r=443,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===l.code?6:4),d!==a.code&&d!==s.code||(t=IE(d).name,r=parseInt(null!==v&&void 0!==v?v:"")),d!==u.code&&d!==c.code||(t=IE(d).name,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===c.code?6:4)}}catch(y){h.e(y)}finally{h.f()}if(null==e||null==t||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:r}}},{key:"protos",value:function(){return this.protoCodes().map((function(e){return Object.assign({},IE(e))}))}},{key:"protoCodes",value:function(){for(var e=[],t=this.bytes,n=0;n<t.length;){var r,i=A().decode(t,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0;n+=HE(IE(i),t.slice(n+o))+o,e.push(i)}return e}},{key:"protoNames",value:function(){return this.protos().map((function(e){return e.name}))}},{key:"tuples",value:function(){return null==(0,fl.Z)(this,ox)&&(0,ll.Z)(this,ox,VE(this.bytes)),(0,fl.Z)(this,ox)}},{key:"stringTuples",value:function(){return null==(0,fl.Z)(this,ax)&&(0,ll.Z)(this,ax,UE(this.tuples())),(0,fl.Z)(this,ax)}},{key:"encapsulate",value:function(t){return t=new e(t),new e(this.toString()+t.toString())}},{key:"decapsulate",value:function(t){var n=t.toString(),r=this.toString(),i=r.lastIndexOf(n);if(i<0)throw new Error("Address ".concat(this.toString()," does not contain subaddress: ").concat(t.toString()));return new e(r.slice(0,i))}},{key:"decapsulateCode",value:function(t){for(var n=this.tuples(),r=n.length-1;r>=0;r--)if(n[r][0]===t)return new e(zE(n.slice(0,r)));return this}},{key:"getPeerId",value:function(){try{var e=this.stringTuples().filter((function(e){return e[0]===ZE.ipfs.code})),t=e.pop();if(null!=(null===t||void 0===t?void 0:t[1])){var n=t[1];return"Q"===n[0]||"1"===n[0]?wE(gr.base58btc.decode("z".concat(n)),"base58btc"):wE(c.CID.parse(n).multihash.bytes,"base58btc")}return null}catch(r){return null}}},{key:"getPath",value:function(){if(void 0===(0,fl.Z)(this,sx))try{(0,ll.Z)(this,sx,this.stringTuples().filter((function(e){return!0===IE(e[0]).path}))[0][1]),null==(0,fl.Z)(this,sx)&&(0,ll.Z)(this,sx,null)}catch(e){(0,ll.Z)(this,sx,null)}return(0,fl.Z)(this,sx)}},{key:"equals",value:function(e){return vE(this.bytes,e.bytes)}},{key:"resolve",value:function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=(r=this.protos().find((function(e){return e.resolvable})))){t.next=3;break}return t.abrupt("return",[this]);case 3:if(null!=(i=ex.get(r.name))){t.next=6;break}throw new ar.s("no available resolver for ".concat(r.name),"ERR_NO_AVAILABLE_RESOLVER");case 6:return t.next=8,i(this,n);case 8:return o=t.sent,t.abrupt("return",o.map((function(t){return new e(t)})));case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"nodeAddress",value:function(){var e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error('multiaddr must have a valid format - no protocol with name: "'.concat(e.transport,'". Must have a valid transport protocol: "{tcp, udp}"'));return{family:e.family,address:e.host,port:e.port}}},{key:"isThinWaistAddress",value:function(e){var t=(null!==e&&void 0!==e?e:this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}},{key:$E,value:function(){return"Multiaddr(".concat(GE(this.bytes),")")}}]),e}();!function(e){var t;!function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();if(i>>>3===1)n.multiaddr=e.bytes();else e.skipType(7&i)}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(e.AddressInfo||(e.AddressInfo={})),e.codec=function(){return null==t&&(t=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==r.lengthDelimited&&n.fork(),null!=t.peerId&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),null!=t.seq&&0n!==t.seq&&(n.uint32(16),n.uint64(t.seq)),null!=t.addresses){var i,o=(0,Ae.Z)(t.addresses);try{for(o.s();!(i=o.n()).done;){var a=i.value;n.uint32(26),e.AddressInfo.codec().encode(a,n)}}catch(s){o.e(s)}finally{o.f()}}!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.peerId=t.bytes();break;case 2:r.seq=t.uint64();break;case 3:r.addresses.push(e.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(7&o)}}return r}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(rx||(rx={}));var cx=Uint8Array.from([3,1]),lx=function(){function e(t){(0,K.Z)(this,e),this.domain=e.DOMAIN,this.codec=e.CODEC;var n=t.peerId,r=t.multiaddrs,i=t.seqNumber;this.peerId=n,this.multiaddrs=null!==r&&void 0!==r?r:[],this.seqNumber=null!==i&&void 0!==i?i:BigInt(Date.now())}return(0,W.Z)(e,[{key:"marshal",value:function(){return null==this.marshaled&&(this.marshaled=rx.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map((function(e){return{multiaddr:e.bytes}}))})),this.marshaled}},{key:"equals",value:function(t){return t instanceof e&&(!!this.peerId.equals(t.peerId)&&(this.seqNumber===t.seqNumber&&!!function(e,t){var n=function(e,t){return e.toString().localeCompare(t.toString())};return e.length===t.length&&(t.sort(n),e.sort(n).every((function(e,n){return t[n].equals(e)})))}(this.multiaddrs,t.multiaddrs)))}}]),e}();lx.createFromProtobuf=function(e){var t,n=rx.decode(e),r=(0,Ps.cv)(n.peerId),i=(null!==(t=n.addresses)&&void 0!==t?t:[]).map((function(e){return t=e.multiaddr,new ux(t);var t})),o=n.seq;return new lx({peerId:r,multiaddrs:i,seqNumber:o})},lx.DOMAIN="libp2p-peer-record",lx.CODEC=cx;var fx=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;return crypto.getRandomValues(new Uint8Array(e)).reduce((function(e,t){return e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_"}),"")},hx="lock:worker:request-read",px="lock:worker:release-read",dx="lock:master:grant-read",vx="lock:worker:request-write",yx="lock:worker:release-write",gx="lock:master:grant-write",mx={},bx=function e(t){t.addEventListener("message",(function(n){e.dispatchEvent("message",t,n)})),null!=t.port&&t.port.addEventListener("message",(function(n){e.dispatchEvent("message",t,n)}))};bx.addEventListener=function(e,t){null==mx[e]&&(mx[e]=[]),mx[e].push(t)},bx.removeEventListener=function(e,t){null!=mx[e]&&(mx[e]=mx[e].filter((function(e){return e===t})))},bx.dispatchEvent=function(e,t,n){null!=mx[e]&&mx[e].forEach((function(e){return e(t,n)}))};var wx,kx=bx,Ex=function(e,t,n,r,i){return function(o,a){if(a.data.type===n){var c={type:a.data.type,name:a.data.name,identifier:a.data.identifier};e.dispatchEvent(new MessageEvent(t,{data:{name:c.name,handler:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o.postMessage({type:i,name:c.name,identifier:c.identifier}),e.next=3,new Promise((function(e){o.addEventListener("message",(function t(n){if(null!=n&&null!=n.data){var i=n.data.type,a=(n.data.name,n.data.identifier);i===r&&a===c.identifier&&(o.removeEventListener("message",t),e())}}))}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}}))}}},xx=function(e,t,n,r){return(0,u.Z)((0,s.Z)().mark((function i(){var o;return(0,s.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return o=fx(),globalThis.postMessage({type:t,identifier:o,name:e}),i.next=4,new Promise((function(t){globalThis.addEventListener("message",(function i(a){if(null!=a&&null!=a.data){var s=a.data.type,u=a.data.identifier;s===n&&u===o&&(globalThis.removeEventListener("message",i),t((function(){globalThis.postMessage({type:r,identifier:o,name:e})})))}}))}));case 4:return i.abrupt("return",i.sent);case 5:case"end":return i.stop()}}),i)})))},_x={singleProcess:!1},Sx={};function Ax(e,t){return Zx.apply(this,arguments)}function Zx(){return(Zx=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new Promise((function(e){r=e})),t.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ay((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){r((function(){e()}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))(),{milliseconds:n.timeout});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))),e.next=4,i;case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Tx={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function Cx(e){var t=Object.assign({},Tx,e);return null==wx&&(wx=function(e){if(e=Object.assign({},_x,e),Boolean(globalThis.document)||e.singleProcess){var t=new EventTarget;return kx.addEventListener("message",Ex(t,"requestReadLock",hx,px,dx)),kx.addEventListener("message",Ex(t,"requestWriteLock",vx,yx,gx)),t}return{isWorker:!0,readLock:function(e){return xx(e,hx,dx,px)},writeLock:function(e){return xx(e,vx,gx,yx)}}}(t),!0!==wx.isWorker&&(wx.addEventListener("requestReadLock",(function(e){null!=Sx[e.data.name]&&Sx[e.data.name].readLock().then(function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.data.handler().finally((function(){return n()}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())})),wx.addEventListener("requestWriteLock",function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=Sx[t.data.name]){e.next=2;break}return e.abrupt("return");case 2:Sx[t.data.name].writeLock().then(function(){var e=(0,u.Z)((0,s.Z)().mark((function e(n){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.data.handler().finally((function(){return n()}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()))),null==Sx[t.name]&&(Sx[t.name]=function(e,t){if(!0===wx.isWorker)return{readLock:wx.readLock(e,t),writeLock:wx.writeLock(e,t)};var n,r=new uc.Z({concurrency:1});return{readLock:function(){return(0,u.Z)((0,s.Z)().mark((function e(){var i,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==n){e.next=4;break}return e.next=3,Ax(n,t);case 3:case 10:return e.abrupt("return",e.sent);case 4:return n=new uc.Z({concurrency:t.concurrency,autoStart:!1}),i=n,o=Ax(n,t),r.add((0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i.start(),e.next=3,i.onIdle().then((function(){n===i&&(n=null)}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})))),e.next=10,o;case 11:case"end":return e.stop()}}),e)})))()},writeLock:function(){return(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,e.next=3,Ax(r,t);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})))()}}}(t.name,t)),Sx[t.name]}function Ix(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}var Dx,Ox,Rx,Px={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};function Lx(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function Nx(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!=(null===(e=globalThis.Buffer)||void 0===e?void 0:e.allocUnsafe)?Lx(globalThis.Buffer.allocUnsafe(t)):new Uint8Array(t)}function Bx(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}!function(e){var t;!function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={key:"",value:new Uint8Array(0)},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.key=e.string();break;case 2:n.value=e.bytes();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(e.Peer$metadataEntry||(e.Peer$metadataEntry={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&(t.uint32(18),Rx.codec().encode(e.value,t)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={key:""},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.key=e.string();break;case 2:n.value=Rx.codec().decode(e,e.uint32());break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(e.Peer$tagsEntry||(e.Peer$tagsEntry={})),e.codec=function(){return null==t&&(t=lo((function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==r.lengthDelimited&&n.fork(),null!=t.addresses){var i,o=(0,Ae.Z)(t.addresses);try{for(o.s();!(i=o.n()).done;){var a=i.value;n.uint32(10),Ox.codec().encode(a,n)}}catch(w){o.e(w)}finally{o.f()}}if(null!=t.protocols){var s,u=(0,Ae.Z)(t.protocols);try{for(u.s();!(s=u.n()).done;){var c=s.value;n.uint32(18),n.string(c)}}catch(w){u.e(w)}finally{u.f()}}if(null!=t.publicKey&&(n.uint32(34),n.bytes(t.publicKey)),null!=t.peerRecordEnvelope&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),null!=t.metadata&&0!==t.metadata.size){var l,f=(0,Ae.Z)(t.metadata.entries());try{for(f.s();!(l=f.n()).done;){var h=(0,k.Z)(l.value,2),p=h[0],d=h[1];n.uint32(50),e.Peer$metadataEntry.codec().encode({key:p,value:d},n)}}catch(w){f.e(w)}finally{f.f()}}if(null!=t.tags&&0!==t.tags.size){var v,y=(0,Ae.Z)(t.tags.entries());try{for(y.s();!(v=y.n()).done;){var g=(0,k.Z)(v.value,2),m=g[0],b=g[1];n.uint32(58),e.Peer$tagsEntry.codec().encode({key:m,value:b},n)}}catch(w){y.e(w)}finally{y.f()}}!1!==r.lengthDelimited&&n.ldelim()}),(function(t,n){for(var r={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=null==n?t.len:t.pos+n;t.pos<i;){var o=t.uint32();switch(o>>>3){case 1:r.addresses.push(Ox.codec().decode(t,t.uint32()));break;case 2:r.protocols.push(t.string());break;case 4:r.publicKey=t.bytes();break;case 5:r.peerRecordEnvelope=t.bytes();break;case 6:var a=e.Peer$metadataEntry.codec().decode(t,t.uint32());r.metadata.set(a.key,a.value);break;case 7:var s=e.Peer$tagsEntry.codec().decode(t,t.uint32());r.tags.set(s.key,s.value);break;default:t.skipType(7&o)}}return r}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(Dx||(Dx={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.multiaddr=e.bytes();break;case 2:n.isCertified=e.bool();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(Ox||(Ox={})),function(e){var t;e.codec=function(){return null==t&&(t=lo((function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.value&&0!==e.value&&(t.uint32(8),t.uint32(e.value)),null!=e.expiry&&(t.uint32(16),t.uint64(e.expiry)),!1!==n.lengthDelimited&&t.ldelim()}),(function(e,t){for(var n={value:0},r=null==t?e.len:e.pos+t;e.pos<r;){var i=e.uint32();switch(i>>>3){case 1:n.value=e.uint32();break;case 2:n.expiry=e.uint64();break;default:e.skipType(7&i)}}return n}))),t},e.encode=function(t){return so(t,e.codec())},e.decode=function(t){return ao(t,e.codec())}}(Rx||(Rx={}));var Mx=Bx("utf8","u",(function(e){return"u"+new TextDecoder("utf8").decode(e)}),(function(e){return(new TextEncoder).encode(e.substring(1))})),Fx=Bx("ascii","a",(function(e){for(var t="a",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(function(e){for(var t=Nx((e=e.substring(1)).length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),jx=(0,Nt.Z)({utf8:Mx,"utf-8":Mx,hex:cr.gh.base16,latin1:Fx,ascii:Fx,binary:Fx},cr.gh);function Ux(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=jx[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}function zx(e,t){null==t&&(t=e.reduce((function(e,t){return e+t.length}),0));var n,r=Nx(t),i=0,o=(0,Ae.Z)(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;r.set(a,i),i+=a.length}}catch(s){o.e(s)}finally{o.f()}return Lx(r)}function Hx(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=jx[t];if(null==n)throw new Error('Unsupported encoding "'.concat(t,'"'));return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?n.decoder.decode("".concat(n.prefix).concat(e)):Lx(globalThis.Buffer.from(e,"utf-8"))}var Vx=xl.C,Gx=xl.aY,Kx=function e(t){var n=0;if(t=t.toString().trim(),Vx(t)){var r=new Uint8Array(n+4);return t.split(/\./g).forEach((function(e){r[n++]=255&parseInt(e,10)})),r}if(Gx(t)){var i,o=t.split(":",8);for(i=0;i<o.length;i++){var a=void 0;Vx(o[i])&&(a=e(o[i]),o[i]=Ux(a.slice(0,2),"base16")),null!=a&&++i<8&&o.splice(i,0,Ux(a.slice(2,4),"base16"))}if(""===o[0])for(;o.length<8;)o.unshift("0");else if(""===o[o.length-1])for(;o.length<8;)o.push("0");else if(o.length<8){for(i=0;i<o.length&&""!==o[i];i++);var s=[i,1];for(i=9-o.length;i>0;i--)s.push("0");o.splice.apply(o,s)}var u=new Uint8Array(n+16);for(i=0;i<o.length;i++){var c=parseInt(o[i],16);u[n++]=c>>8&255,u[n++]=255&c}return u}throw new Error("invalid ip address")},Wx=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;n=~~n,r=null!==(t=r)&&void 0!==t?t:e.length-n;var i=new DataView(e.buffer);if(4===r){for(var o=[],a=0;a<r;a++)o.push(e[n+a]);return o.join(".")}if(16===r){for(var s=[],u=0;u<r;u+=2)s.push(i.getUint16(n+u).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},qx=-1,Yx={},Qx={};function Xx(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}function $x(e){if("number"===typeof e){if(null!=Qx[e])return Qx[e];throw new Error("no protocol with code: ".concat(e))}if("string"===typeof e){if(null!=Yx[e])return Yx[e];throw new Error("no protocol with name: ".concat(e))}throw new Error("invalid protocol id type: ".concat(typeof e))}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,qx,"ip6zone"],[43,8,"ipcidr"],[53,qx,"dns",!0],[54,qx,"dns4",!0],[55,qx,"dns6",!0],[56,qx,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,qx,"unix",!1,!0],[421,qx,"ipfs"],[421,qx,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,qx,"garlic64"],[448,0,"tls"],[449,qx,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,qx,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,qx,"memory"]].forEach((function(e){var t=Xx.apply(void 0,(0,ye.Z)(e));Qx[t.code]=t,Yx[t.name]=t}));$x("ip4"),$x("ip6"),$x("ipcidr");function Jx(e,t){switch($x(e).code){case 4:case 41:return function(e){var t=Wx(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!xl.h6(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return s_(t);case 6:case 273:case 33:case 132:return o_(t).toString();case 421:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return Ux(n,"base58btc")}(t);case 444:case 445:return u_(t);case 466:return function(e){var t=A().decode(e),n=e.slice(A().decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+Ux(n,"base64url")}(t);default:return Ux(t,"base16")}}function e_(e,t){switch($x(e).code){case 4:case 41:return r_(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return a_(t);case 6:case 273:case 33:case 132:return i_(parseInt(t,10));case 421:return function(e){var t;t="Q"===e[0]||"1"===e[0]?b.decode(gr.base58btc.decode("z".concat(e))).bytes:c.CID.parse(e).multihash.bytes;var n=Uint8Array.from(A().encode(t.length));return zx([n,t],n.length+t.length)}(t);case 444:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(16!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion address."));var n=kl.base32.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=i_(r);return zx([n,i],n.length+i.length)}(t);case 445:return function(e){var t=e.split(":");if(2!==t.length)throw new Error("failed to parse onion addr: [\"'".concat(t.join('", "'),"'\"]' does not contain a port number"));if(56!==t[0].length)throw new Error("failed to parse onion addr: ".concat(t[0]," not a Tor onion3 address."));var n=kl.base32.decode("b".concat(t[0])),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");var i=i_(r);return zx([n,i],n.length+i.length)}(t);case 466:return function(e){var t=n_.decode(e),n=Uint8Array.from(A().encode(t.length));return zx([n,t],n.length+t.length)}(t);default:return Hx(t,"base16")}}var t_=Object.values(cr.gh).map((function(e){return e.decoder})),n_=function(){var e=t_[0].or(t_[1]);return t_.slice(2).forEach((function(t){return e=e.or(t)})),e}();function r_(e){if(!xl.h6(e))throw new Error("invalid ip address");return Kx(e)}function i_(e){var t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function o_(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function a_(e){var t=Hx(e),n=Uint8Array.from(A().encode(t.length));return zx([n,t],n.length+t.length)}function s_(e){var t=A().decode(e);if((e=e.slice(A().decode.bytes)).length!==t)throw new Error("inconsistent lengths");return Ux(e)}function u_(e){var t=e.slice(0,e.length-2),n=e.slice(e.length-2),r=Ux(t,"base32"),i=o_(n);return"".concat(r,":").concat(i)}function c_(e){return e.map((function(e){var t=b_(e);return null!=e[1]?[t.code,Jx(t.code,e[1])]:[t.code]}))}function l_(e){return v_(zx(e.map((function(e){var t=b_(e),n=Uint8Array.from(A().encode(t.code));return e.length>1&&null!=e[1]&&(n=zx([n,e[1]])),n}))))}function f_(e,t){return e.size>0?e.size/8:0===e.size?0:A().decode(t)+(null!==(n=A().decode.bytes)&&void 0!==n?n:0);var n}function h_(e){for(var t=[],n=0;n<e.length;){var r,i=A().decode(e,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0,a=f_($x(i),e.slice(n+o));if(0!==a){var s=e.slice(n+o,n+o+a);if((n+=a+o)>e.length)throw m_("Invalid address Uint8Array: "+Ux(e,"base16"));t.push([i,s])}else t.push([i]),n+=o}return t}function p_(e){return function(e){var t=[];return e.map((function(e){var n=b_(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),g_(t.join("/"))}(c_(h_(e)))}function d_(e){var t=function(e){var t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(var r=0;r<n.length;r++){var i=n[r],o=$x(i);if(0!==o.size){if(++r>=n.length)throw m_("invalid address: "+e);if(!0===o.path){t.push([i,g_(n.slice(r).join("/"))]);break}t.push([i,n[r]])}else t.push([i])}return t}(e=g_(e));return l_(t.map((function(e){Array.isArray(e)||(e=[e]);var t=b_(e);return e.length>1?[t.code,e_(t.code,e[1])]:[t.code]})))}function v_(e){var t=y_(e);if(null!=t)throw t;return Uint8Array.from(e)}function y_(e){try{h_(e)}catch(t){return t}}function g_(e){return"/"+e.trim().split("/").filter((function(e){return e})).join("/")}function m_(e){return new Error("Error parsing address: "+e)}function b_(e){return $x(e[0])}var w_=Symbol.for("nodejs.util.inspect.custom"),k_=[$x("dns").code,$x("dns4").code,$x("dns6").code,$x("dnsaddr").code],E_=new Map,x_=Symbol.for("@multiformats/js-multiaddr/multiaddr");function __(e){return Boolean(null===e||void 0===e?void 0:e[x_])}var S_=new WeakMap,A_=new WeakMap,Z_=new WeakMap,T_=new WeakMap,C_=function(){function e(t){if((0,K.Z)(this,e),(0,ot.Z)(this,"bytes",void 0),(0,cl.Z)(this,S_,{writable:!0,value:void 0}),(0,cl.Z)(this,A_,{writable:!0,value:void 0}),(0,cl.Z)(this,Z_,{writable:!0,value:void 0}),(0,cl.Z)(this,T_,{writable:!0,value:void 0}),(0,ot.Z)(this,x_,!0),null==t&&(t=""),t instanceof Uint8Array)this.bytes=v_(t);else if("string"===typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error('multiaddr "'.concat(t,'" must start with a "/"'));this.bytes=d_(t)}else{if(!__(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=v_(t.bytes)}}return(0,W.Z)(e,[{key:"toString",value:function(){return null==(0,fl.Z)(this,S_)&&(0,ll.Z)(this,S_,p_(this.bytes)),(0,fl.Z)(this,S_)}},{key:"toJSON",value:function(){return this.toString()}},{key:"toOptions",value:function(){var e,t,n,r,i,o="",a=$x("tcp"),s=$x("udp"),u=$x("ip4"),c=$x("ip6"),l=$x("dns6"),f=$x("ip6zone"),h=(0,Ae.Z)(this.stringTuples());try{for(h.s();!(i=h.n()).done;){var p=(0,k.Z)(i.value,2),d=p[0],v=p[1];d===f.code&&(o="%".concat(null!==v&&void 0!==v?v:"")),k_.includes(d)&&(t=a.name,r=443,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===l.code?6:4),d!==a.code&&d!==s.code||(t=$x(d).name,r=parseInt(null!==v&&void 0!==v?v:"")),d!==u.code&&d!==c.code||(t=$x(d).name,n="".concat(null!==v&&void 0!==v?v:"").concat(o),e=d===c.code?6:4)}}catch(y){h.e(y)}finally{h.f()}if(null==e||null==t||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:r}}},{key:"protos",value:function(){return this.protoCodes().map((function(e){return Object.assign({},$x(e))}))}},{key:"protoCodes",value:function(){for(var e=[],t=this.bytes,n=0;n<t.length;){var r,i=A().decode(t,n),o=null!==(r=A().decode.bytes)&&void 0!==r?r:0;n+=f_($x(i),t.slice(n+o))+o,e.push(i)}return e}},{key:"protoNames",value:function(){return this.protos().map((function(e){return e.name}))}},{key:"tuples",value:function(){return null==(0,fl.Z)(this,A_)&&(0,ll.Z)(this,A_,h_(this.bytes)),(0,fl.Z)(this,A_)}},{key:"stringTuples",value:function(){return null==(0,fl.Z)(this,Z_)&&(0,ll.Z)(this,Z_,c_(this.tuples())),(0,fl.Z)(this,Z_)}},{key:"encapsulate",value:function(t){return t=new e(t),new e(this.toString()+t.toString())}},{key:"decapsulate",value:function(t){var n=t.toString(),r=this.toString(),i=r.lastIndexOf(n);if(i<0)throw new Error("Address ".concat(this.toString()," does not contain subaddress: ").concat(t.toString()));return new e(r.slice(0,i))}},{key:"decapsulateCode",value:function(t){for(var n=this.tuples(),r=n.length-1;r>=0;r--)if(n[r][0]===t)return new e(l_(n.slice(0,r)));return this}},{key:"getPeerId",value:function(){try{var e=this.stringTuples().filter((function(e){return e[0]===Yx.ipfs.code})),t=e.pop();if(null!=(null===t||void 0===t?void 0:t[1])){var n=t[1];return"Q"===n[0]||"1"===n[0]?Ux(gr.base58btc.decode("z".concat(n)),"base58btc"):Ux(c.CID.parse(n).multihash.bytes,"base58btc")}return null}catch(r){return null}}},{key:"getPath",value:function(){if(void 0===(0,fl.Z)(this,T_))try{(0,ll.Z)(this,T_,this.stringTuples().filter((function(e){return!0===$x(e[0]).path}))[0][1]),null==(0,fl.Z)(this,T_)&&(0,ll.Z)(this,T_,null)}catch(e){(0,ll.Z)(this,T_,null)}return(0,fl.Z)(this,T_)}},{key:"equals",value:function(e){return Ix(this.bytes,e.bytes)}},{key:"resolve",value:function(){var t=(0,u.Z)((0,s.Z)().mark((function t(n){var r,i,o;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=(r=this.protos().find((function(e){return e.resolvable})))){t.next=3;break}return t.abrupt("return",[this]);case 3:if(null!=(i=E_.get(r.name))){t.next=6;break}throw new ar.s("no available resolver for ".concat(r.name),"ERR_NO_AVAILABLE_RESOLVER");case 6:return t.next=8,i(this,n);case 8:return o=t.sent,t.abrupt("return",o.map((function(t){return new e(t)})));case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"nodeAddress",value:function(){var e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error('multiaddr must have a valid format - no protocol with name: "'.concat(e.transport,'". Must have a valid transport protocol: "{tcp, udp}"'));return{family:e.family,address:e.host,port:e.port}}},{key:"isThinWaistAddress",value:function(e){var t=(null!==e&&void 0!==e?e:this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}},{key:w_,value:function(){return"Multiaddr(".concat(p_(this.bytes),")")}}]),e}();function I_(e){return new C_(e)}function D_(e,t){return O_.apply(this,arguments)}function O_(){return(O_=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(i=Dx.decode(n)).publicKey||null!=t.publicKey){e.next=5;break}return e.next=4,iE(Zs(i.publicKey));case 4:t=e.sent;case 5:o=new Map,a=BigInt(Date.now()),u=(0,Ae.Z)(i.tags.entries()),e.prev=8,u.s();case 10:if((c=u.n()).done){e.next=17;break}if(l=(0,k.Z)(c.value,2),f=l[0],!(null!=(h=l[1]).expiry&&h.expiry<a)){e.next=14;break}return e.abrupt("continue",15);case 14:o.set(f,h);case 15:e.next=10;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(8),u.e(e.t0);case 22:return e.prev=22,u.f(),e.finish(22);case 25:return e.abrupt("return",(0,Nt.Z)((0,Nt.Z)({},i),{},{id:t,addresses:i.addresses.map((function(e){var t=e.multiaddr,n=e.isCertified;return{multiaddr:I_(t),isCertified:null!==n&&void 0!==n&&n}})),metadata:i.metadata,peerRecordEnvelope:null!==(r=i.peerRecordEnvelope)&&void 0!==r?r:void 0,tags:o}));case 26:case"end":return e.stop()}}),e,null,[[8,19,22,25]])})))).apply(this,arguments)}var R_,P_=n(56334),L_="/",N_=(new TextEncoder).encode(L_),B_=N_[0];R_=Symbol.toStringTag;var M_=function(){function e(t,n){if((0,K.Z)(this,e),(0,ot.Z)(this,"_buf",void 0),"string"===typeof t)this._buf=Hx(t);else{if(!(t instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=t}if(null==n&&(n=!0),n&&this.clean(),0===this._buf.byteLength||this._buf[0]!==B_)throw new Error("Invalid key")}return(0,W.Z)(e,[{key:"toString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8";return Ux(this._buf,e)}},{key:"uint8Array",value:function(){return this._buf}},{key:R_,get:function(){return"Key(".concat(this.toString(),")")}},{key:"clean",value:function(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=N_),this._buf[0]!==B_){var e=new Uint8Array(this._buf.byteLength+1);e.fill(B_,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===B_;)this._buf=this._buf.subarray(0,-1)}},{key:"less",value:function(e){for(var t=this.list(),n=e.list(),r=0;r<t.length;r++){if(n.length<r+1)return!1;var i=t[r],o=n[r];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}},{key:"reverse",value:function(){return e.withNamespaces(this.list().slice().reverse())}},{key:"namespaces",value:function(){return this.list()}},{key:"baseNamespace",value:function(){var e=this.namespaces();return e[e.length-1]}},{key:"list",value:function(){return this.toString().split(L_).slice(1)}},{key:"type",value:function(){return function(e){var t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}},{key:"name",value:function(){return function(e){var t=e.split(":");return t[t.length-1]}(this.baseNamespace())}},{key:"instance",value:function(t){return new e(this.toString()+":"+t)}},{key:"path",value:function(){var t=this.parent().toString();return t.endsWith(L_)||(t+=L_),new e(t+=this.type())}},{key:"parent",value:function(){var t=this.list();return 1===t.length?new e(L_):new e(t.slice(0,-1).join(L_))}},{key:"child",value:function(t){return this.toString()===L_?t:t.toString()===L_?this:new e(this.toString()+t.toString(),!1)}},{key:"isAncestorOf",value:function(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}},{key:"isDecendantOf",value:function(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}},{key:"isTopLevel",value:function(){return 1===this.list().length}},{key:"concat",value:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.withNamespaces([].concat((0,ye.Z)(this.namespaces()),(0,ye.Z)(function(e){var t;return(t=[]).concat.apply(t,(0,ye.Z)(e))}(n.map((function(e){return e.namespaces()}))))))}}],[{key:"withNamespaces",value:function(t){return new e(t.join(L_))}},{key:"random",value:function(){return new e(fx().replace(/-/g,""))}},{key:"asKey",value:function(t){return t instanceof Uint8Array||"string"===typeof t?new e(t):"function"===typeof t.uint8Array?new e(t.uint8Array()):null}}]),e}();var F_="/peers/";function j_(e){if(!(0,P_.I)(e)||null==e.type)throw new ar.s("Invalid PeerId",Px.ERR_INVALID_PARAMETERS);var t=e.toCID().toString();return new M_("".concat(F_).concat(t))}function U_(e,t,n){return z_.apply(this,arguments)}function z_(){return(z_=(0,u.Z)((0,s.Z)().mark((function e(t,n,r){var i,o,a,u,c,l,f,h;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=new Map,o=(0,Ae.Z)(r),e.prev=2,o.s();case 4:if((a=o.n()).done){e.next=21;break}if(null!=(c=a.value)){e.next=8;break}return e.abrupt("continue",19);case 8:if(c.multiaddr instanceof Uint8Array&&(c.multiaddr=I_(c.multiaddr)),__(c.multiaddr)){e.next=11;break}throw new ar.s("Multiaddr was invalid",Px.ERR_INVALID_PARAMETERS);case 11:return e.next=13,n(t,c.multiaddr);case 13:if(e.sent){e.next=15;break}return e.abrupt("continue",19);case 15:l=null!==(u=c.isCertified)&&void 0!==u&&u,f=c.multiaddr.toString(),null!=(h=i.get(f))?c.isCertified=h.isCertified||l:i.set(f,{multiaddr:c.multiaddr,isCertified:l});case 19:e.next=4;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(2),o.e(e.t0);case 26:return e.prev=26,o.f(),e.finish(26);case 29:return e.abrupt("return",(0,ye.Z)(i.values()).sort((function(e,t){return e.multiaddr.toString().localeCompare(t.multiaddr.toString())})).map((function(e){return{isCertified:e.isCertified,multiaddr:e.multiaddr.bytes}})));case 30:case"end":return e.stop()}}),e,null,[[2,23,26,29]])})))).apply(this,arguments)}function H_(e,t,n,r){return V_.apply(this,arguments)}function V_(){return V_=(0,u.Z)((0,s.Z)().mark((function e(t,n,r,i){var o,a,c,l,f,h,p,d,v,y,g,m,b,w,E,x,_,S,A,Z,T,C,I,D,O,R,P,L,N,B,M,F,j;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=n){e.next=2;break}throw new ar.s("Invalid PeerData",Px.ERR_INVALID_PARAMETERS);case 2:if(null==n.publicKey||null==t.publicKey||Ix(n.publicKey,t.publicKey)){e.next=4;break}throw new ar.s("publicKey bytes do not match peer id publicKey bytes",Px.ERR_INVALID_PARAMETERS);case 4:if(null==(d=i.existingPeer)||t.equals(d.id)){e.next=7;break}throw new ar.s("peer id did not match existing peer id",Px.ERR_INVALID_PARAMETERS);case 7:if(v=null!==(o=null===d||void 0===d?void 0:d.addresses)&&void 0!==o?o:[],y=new Set(null!==(a=null===d||void 0===d?void 0:d.protocols)&&void 0!==a?a:[]),g=null!==(c=null===d||void 0===d?void 0:d.metadata)&&void 0!==c?c:new Map,m=null!==(l=null===d||void 0===d?void 0:d.tags)&&void 0!==l?l:new Map,b=null===d||void 0===d?void 0:d.peerRecordEnvelope,"patch"===r&&(null==n.multiaddrs&&null==n.addresses||(v=[],null!=n.multiaddrs&&(w=v).push.apply(w,(0,ye.Z)(n.multiaddrs.map((function(e){return{isCertified:!1,multiaddr:e}})))),null!=n.addresses&&(E=v).push.apply(E,(0,ye.Z)(n.addresses))),null!=n.protocols&&(y=new Set(n.protocols)),null!=n.metadata&&(x=n.metadata instanceof Map?(0,ye.Z)(n.metadata.entries()):Object.entries(n.metadata),g=G_(x,{validate:K_})),null!=n.tags&&(_=n.tags instanceof Map?(0,ye.Z)(n.tags.entries()):Object.entries(n.tags),m=G_(_,{validate:W_,map:q_})),null!=n.peerRecordEnvelope&&(b=n.peerRecordEnvelope)),"merge"===r){if(null!=n.multiaddrs&&(S=v).push.apply(S,(0,ye.Z)(n.multiaddrs.map((function(e){return{isCertified:!1,multiaddr:e}})))),null!=n.addresses&&(A=v).push.apply(A,(0,ye.Z)(n.addresses)),null!=n.protocols&&(y=new Set([].concat((0,ye.Z)(y),(0,ye.Z)(n.protocols)))),null!=n.metadata){Z=n.metadata instanceof Map?(0,ye.Z)(n.metadata.entries()):Object.entries(n.metadata),T=(0,Ae.Z)(Z);try{for(T.s();!(C=T.n()).done;)I=(0,k.Z)(C.value,2),D=I[0],null==(O=I[1])?g.delete(D):g.set(D,O)}catch(U){T.e(U)}finally{T.f()}g=G_((0,ye.Z)(g.entries()),{validate:K_})}if(null!=n.tags){R=n.tags instanceof Map?(0,ye.Z)(n.tags.entries()):Object.entries(n.tags),P=new Map(m),L=(0,Ae.Z)(R);try{for(L.s();!(N=L.n()).done;)B=(0,k.Z)(N.value,2),M=B[0],null==(F=B[1])?P.delete(M):P.set(M,F)}catch(U){L.e(U)}finally{L.f()}m=G_((0,ye.Z)(P.entries()),{validate:W_,map:q_})}null!=n.peerRecordEnvelope&&(b=n.peerRecordEnvelope)}return e.next=16,U_(t,null!==(f=i.addressFilter)&&void 0!==f?f:(0,u.Z)((0,s.Z)().mark((function e(){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!0);case 1:case"end":return e.stop()}}),e)}))),v);case 16:return e.t0=e.sent,e.t1=(0,ye.Z)(y.values()).sort((function(e,t){return e.localeCompare(t)})),e.t2=g,e.t3=m,e.t4=null!==(h=null!==(p=null===d||void 0===d?void 0:d.id.publicKey)&&void 0!==p?p:n.publicKey)&&void 0!==h?h:t.publicKey,e.t5=b,j={addresses:e.t0,protocols:e.t1,metadata:e.t2,tags:e.t3,publicKey:e.t4,peerRecordEnvelope:e.t5},"RSA"!==t.type&&delete j.publicKey,e.abrupt("return",j);case 25:case"end":return e.stop()}}),e)}))),V_.apply(this,arguments)}function G_(e,t){var n,r=new Map,i=(0,Ae.Z)(e);try{for(i.s();!(n=i.n()).done;){var o=(0,k.Z)(n.value,2),a=o[0],s=o[1];null!=s&&t.validate(a,s)}}catch(v){i.e(v)}finally{i.f()}var u,c=(0,Ae.Z)(e.sort((function(e,t){var n=(0,k.Z)(e,1)[0],r=(0,k.Z)(t,1)[0];return n.localeCompare(r)})));try{for(c.s();!(u=c.n()).done;){var l,f,h=(0,k.Z)(u.value,2),p=h[0],d=h[1];if(null!=d)r.set(p,null!==(l=null===(f=t.map)||void 0===f?void 0:f.call(t,p,d))&&void 0!==l?l:d)}}catch(v){c.e(v)}finally{c.f()}return r}function K_(e,t){if("string"!==typeof e)throw new ar.s("Metadata key must be a string",Px.ERR_INVALID_PARAMETERS);if(!(t instanceof Uint8Array))throw new ar.s("Metadata value must be a Uint8Array",Px.ERR_INVALID_PARAMETERS)}function W_(e,t){if("string"!==typeof e)throw new ar.s("Tag name must be a string",Px.ERR_INVALID_PARAMETERS);if(null!=t.value){if(parseInt("".concat(t.value),10)!==t.value)throw new ar.s("Tag value must be an integer",Px.ERR_INVALID_PARAMETERS);if(t.value<0||t.value>100)throw new ar.s("Tag value must be between 0-100",Px.ERR_INVALID_PARAMETERS)}if(null!=t.ttl){if(parseInt("".concat(t.ttl),10)!==t.ttl)throw new ar.s("Tag ttl must be an integer",Px.ERR_INVALID_PARAMETERS);if(t.ttl<0)throw new ar.s("Tag ttl must be between greater than 0",Px.ERR_INVALID_PARAMETERS)}}function q_(e,t){var n,r;return null!=t.expiry&&(r=t.expiry),null!=t.ttl&&(r=BigInt(Date.now()+Number(t.ttl))),{value:null!==(n=t.value)&&void 0!==n?n:0,expiry:r}}var Y_=new WeakSet,Q_=new WeakSet,X_=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),pw(this,Q_),pw(this,Y_),(0,ot.Z)(this,"peerId",void 0),(0,ot.Z)(this,"datastore",void 0),(0,ot.Z)(this,"lock",void 0),(0,ot.Z)(this,"addressFilter",void 0),this.peerId=t.peerId,this.datastore=t.datastore,this.addressFilter=n.addressFilter,this.lock=Cx({name:"peer-store",singleProcess:!0})}return(0,W.Z)(e,[{key:"has",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.datastore.has(j_(t)));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.peerId.equals(t)){e.next=2;break}throw new ar.s("Cannot delete self peer",Px.ERR_INVALID_PARAMETERS);case 2:return e.next=4,this.datastore.delete(j_(t));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"load",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.datastore.get(j_(t));case 2:return n=e.sent,e.abrupt("return",D_(t,n));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"save",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,dw(this,Y_,$_).call(this,t);case 2:return r=e.sent,i=r.existingBuf,o=r.existingPeer,e.next=7,H_(t,n,"patch",{addressFilter:this.addressFilter});case 7:return a=e.sent,e.abrupt("return",dw(this,Q_,eS).call(this,t,a,i,o));case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"patch",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,dw(this,Y_,$_).call(this,t);case 2:return r=e.sent,i=r.existingBuf,o=r.existingPeer,e.next=7,H_(t,n,"patch",{addressFilter:this.addressFilter,existingPeer:o});case 7:return a=e.sent,e.abrupt("return",dw(this,Q_,eS).call(this,t,a,i,o));case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"merge",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t,n){var r,i,o,a;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,dw(this,Y_,$_).call(this,t);case 2:return r=e.sent,i=r.existingBuf,o=r.existingPeer,e.next=7,H_(t,n,"merge",{addressFilter:this.addressFilter,existingPeer:o});case 7:return a=e.sent,e.abrupt("return",dw(this,Q_,eS).call(this,t,a,i,o));case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"all",value:function(){var e=this;return(0,g.Z)((0,s.Z)().mark((function t(){var n,r,i,o,a,u,c,l,f,h,p;return(0,s.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=!1,r=!1,t.prev=2,o=(0,y.Z)(e.datastore.query({prefix:F_}));case 4:return t.next=6,(0,m.Z)(o.next());case 6:if(!(n=!(a=t.sent).done)){t.next=18;break}if(u=a.value,c=u.key,l=u.value,f=c.toString().split("/")[2],h=kl.base32.decode(f),!(p=(0,Ps.cv)(h)).equals(e.peerId)){t.next=13;break}return t.abrupt("continue",15);case 13:return t.next=15,D_(p,l);case 15:n=!1,t.next=4;break;case 18:t.next=24;break;case 20:t.prev=20,t.t0=t.catch(2),r=!0,i=t.t0;case 24:if(t.prev=24,t.prev=25,!n||null==o.return){t.next=29;break}return t.next=29,(0,m.Z)(o.return());case 29:if(t.prev=29,!r){t.next=32;break}throw i;case 32:return t.finish(29);case 33:return t.finish(24);case 34:case"end":return t.stop()}}),t,null,[[2,20,24,34],[25,,29,33]])})))()}}]),e}();function $_(e){return J_.apply(this,arguments)}function J_(){return(J_=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.datastore.get(j_(t));case 3:return n=e.sent,e.next=6,D_(t,n);case 6:return r=e.sent,e.abrupt("return",{existingBuf:n,existingPeer:r});case 10:if(e.prev=10,e.t0=e.catch(0),"ERR_NOT_FOUND"===e.t0.code){e.next=14;break}throw e.t0;case 14:return e.abrupt("return",{});case 15:case"end":return e.stop()}}),e,this,[[0,10]])})))).apply(this,arguments)}function eS(e,t,n,r){return tS.apply(this,arguments)}function tS(){return(tS=(0,u.Z)((0,s.Z)().mark((function e(t,n,r,i){var o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=Dx.encode(n),null==r||!Ix(o,r)){e.next=7;break}return e.next=4,D_(t,o);case 4:return e.t0=e.sent,e.t1=i,e.abrupt("return",{peer:e.t0,previous:e.t1,updated:!1});case 7:return e.next=9,this.datastore.put(j_(t),o);case 9:return e.next=11,D_(t,o);case 11:return e.t2=e.sent,e.t3=i,e.abrupt("return",{peer:e.t2,previous:e.t3,updated:!0});case 14:case"end":return e.stop()}}),e,this)})))).apply(this,arguments)}var nS=(0,ru.kg)("libp2p:peer-store"),rS=new WeakSet,iS=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,K.Z)(this,e),pw(this,rS),(0,ot.Z)(this,"store",void 0),(0,ot.Z)(this,"events",void 0),(0,ot.Z)(this,"peerId",void 0),this.events=t.events,this.peerId=t.peerId,this.store=new X_(t,n)}return(0,W.Z)(e,[{key:"forEach",value:function(){var e=(0,u.Z)((0,s.Z)().mark((function e(t){var n,r,i,o,a,u,c;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return nS.trace("forEach await read lock"),e.next=3,this.store.lock.readLock();case 3:n=e.sent,nS.trace("forEach got read lock"),e.prev=5,r=!1,i=!1,e.prev=8,a=(0,y.Z)(this.store.all());case 10:return e.next=12,a.next();case 12:if(!(r=!(u=e.sent).done)){e.next=18;break}c=u.value,t(c);case 15:r=!1,e.next=10;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(8),i=!0,o=e.t0;case 24:if(e.prev=24,e.prev=25,!r||null==a.return){e.next=29;break}return e.next=29,a.return();case 29:if(e.prev=29,!i){e.next=32;break}throw o;case 32:return e.finish(29);case 33:return e.finish(24);case 34:return e.prev=34,nS.trace(